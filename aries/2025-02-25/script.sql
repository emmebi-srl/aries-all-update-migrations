CREATE TABLE `cliente_estratto_conto` (
	`id` INT NOT NULL,
	`id_cliente` INT NOT NULL,
	`id_email` INT NOT NULL,
	`data_ins` TIMESTAMP NOT NULL,
	`utente_ins` INT NOT NULL,
	PRIMARY KEY (`id`),
	CONSTRAINT `FK_cliente_estratto_conto_clienti` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON UPDATE NO ACTION ON DELETE NO ACTION,
	CONSTRAINT `FK_cliente_estratto_conto_email` FOREIGN KEY (`id_email`) REFERENCES `mail` (`Id`) ON UPDATE NO ACTION ON DELETE NO ACTION,
	CONSTRAINT `FK_cliente_estratto_conto_utente` FOREIGN KEY (`utente_ins`) REFERENCES `utente` (`Id_utente`) ON UPDATE NO ACTION ON DELETE NO ACTION
)
COLLATE='latin1_swedish_ci'
;

ALTER TABLE `cliente_estratto_conto`
	CHANGE COLUMN `id` `id` INT(11) NOT NULL AUTO_INCREMENT FIRST;


INSERT INTO cliente_estratto_conto  (id_cliente, id_email, data_ins, utente_ins)
SELECT id_documento, id, Data_ins, utente_ins 
FROM mail
WHERE mail.Tipo_documento = 'sollecito_fattura' AND id_documento IS NOT NULL;



UPDATE mail
SET tipo_documento = 'cliente_estratto_conto'
WHERE mail.Tipo_documento = 'sollecito_fattura' AND id_documento IS NOT NULL;


ALTER TABLE `fattura_pagamenti_comunicazione`
	ADD CONSTRAINT `FK_fattura_pagamenti_comunicazione_mail` FOREIGN KEY (`mail`) REFERENCES `mail` (`Id`) ON UPDATE CASCADE ON DELETE CASCADE;



ALTER TABLE `fattura_configurazione`
	ADD COLUMN `estratto_conto_testo_mail` TEXT NULL AFTER `email_sdi`;



UPDATE fattura_configurazione
SET estratto_conto_testo_mail = 0x47656E74696C6520636C69656E74652C0D0A0D0A696E20616C6C656761746F20696C20766F7374726F20657374726174746F20636F6E746F20616767696F726E61746F2E0D0A0D0A566920707265676869616D6F20646920766F6C6572636920636F6E6665726D617265206C652073656775656E746920696E666F726D617A696F6E693A0D0A0D0A2020202D20636865207475747465206C65206661747475726520736F6E6F2073746174652072696365767574652E0D0A2020202D206C61206461746120646920706167616D656E746F2064656C6C65206661747475726520696E206F67676574746F2E0D0A0D0A;



