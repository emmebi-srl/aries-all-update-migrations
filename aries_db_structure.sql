-- --------------------------------------------------------
-- Host:                         127.0.0.1
-- Versione server:              5.5.62 - MySQL Community Server (GPL)
-- S.O. server:                  Win64
-- HeidiSQL Versione:            12.10.0.7000
-- --------------------------------------------------------

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET NAMES utf8 */;
/*!50503 SET NAMES utf8mb4 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

-- Dump della struttura di tabella emmebi.abbonamento
CREATE TABLE IF NOT EXISTS `abbonamento` (
  `Id_abbonamento` int(11) NOT NULL AUTO_INCREMENT,
  `Anno` int(11) NOT NULL,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  `Prezzo_strada` decimal(11,2) DEFAULT NULL,
  `Diritto_chiamata` decimal(11,2) DEFAULT NULL,
  `Diritto_chiamata_gratis` int(11) NOT NULL,
  `Diritto_chiamata_straordinario` decimal(11,2) NOT NULL,
  `Diritto_chiamata_straordinario_inclusa` int(11) NOT NULL,
  `Sconto` decimal(11,2) DEFAULT NULL,
  `Listino` int(11) NOT NULL,
  `Ora_normale` decimal(11,2) NOT NULL,
  `Ore_incluse` int(11) NOT NULL,
  `Ora_straordinaria` decimal(11,2) DEFAULT NULL,
  `Ore_straordinarie_incluse` int(11) NOT NULL,
  `Reperibilità` decimal(11,2) NOT NULL,
  `Reperibilità_inclusa` int(11) NOT NULL,
  `Rimborso_spesa` decimal(11,2) NOT NULL,
  `Prima_ora` int(11) NOT NULL,
  `Teleassistenza` decimal(11,2) NOT NULL,
  `Teleassistenza_inclusa` int(11) NOT NULL,
  `Controlli_annuali` int(11) NOT NULL,
  `personale` tinyint(1) NOT NULL,
  `Durata` int(11) NOT NULL,
  `generale` tinyint(1) NOT NULL DEFAULT '0',
  `Data_registrazione` date DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `prezzo_prima_ora` decimal(11,2) NOT NULL DEFAULT '0.00',
  `check_prima_ora` tinyint(1) unsigned NOT NULL DEFAULT '0',
  `materiali_fatt` int(11) DEFAULT '1',
  PRIMARY KEY (`Id_abbonamento`),
  KEY `Listino` (`Listino`),
  KEY `Index_3_ut` (`id_utente`),
  CONSTRAINT `FK_abbonamento_1_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=317 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.abbonamento_lavoro
CREATE TABLE IF NOT EXISTS `abbonamento_lavoro` (
  `id_tipo_impianto` int(11) NOT NULL,
  `abbonamento` int(11) NOT NULL,
  `lavoro` int(11) NOT NULL,
  `Applicabile` varchar(15) NOT NULL,
  PRIMARY KEY (`id_tipo_impianto`,`abbonamento`,`lavoro`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.appoggio
CREATE TABLE IF NOT EXISTS `appoggio` (
  `nome` varchar(30) NOT NULL,
  `id_prev` int(11) NOT NULL,
  `id_lot` int(11) NOT NULL,
  `id_nome_lotto` int(11) NOT NULL,
  KEY `id_nome_lotto` (`id_nome_lotto`),
  CONSTRAINT `appoggio_ibfk_1` FOREIGN KEY (`id_nome_lotto`) REFERENCES `lotto_nome` (`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.aries_versione
CREATE TABLE IF NOT EXISTS `aries_versione` (
  `id_versione` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `data_aggiornamento` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `versione` varchar(100) NOT NULL,
  `percorso` text,
  PRIMARY KEY (`id_versione`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articoli_ddt
CREATE TABLE IF NOT EXISTS `articoli_ddt` (
  `id_articolo` varchar(11) DEFAULT NULL,
  `Costo` float(11,6) NOT NULL,
  `id_ddt` int(11) NOT NULL,
  `Desc_breve` text,
  `anno` int(11) NOT NULL,
  `codice_fornitore` varchar(40) DEFAULT NULL,
  `numero_tab` int(11) NOT NULL DEFAULT '0',
  `quantità` float(11,4) DEFAULT NULL,
  `Unità_misura` varchar(5) DEFAULT NULL,
  `Prezzo` float(11,6) NOT NULL,
  `Serial_number` varchar(150) DEFAULT NULL,
  `tipo` char(1) DEFAULT NULL,
  `idnota` int(11) DEFAULT NULL,
  `causale_scarico` int(11) DEFAULT NULL,
  `id_rif` int(11) DEFAULT NULL,
  `anno_rif` int(11) DEFAULT NULL,
  `sconto2` decimal(11,2) DEFAULT '0.00',
  `sconto` float(11,6) NOT NULL DEFAULT '0.000000',
  `economia` float(11,2) DEFAULT NULL,
  `id_commessa` int(11) DEFAULT NULL,
  `anno_commessa` int(11) DEFAULT NULL,
  `id_sottocommessa` int(11) DEFAULT NULL,
  `id_lotto_commessa` int(11) DEFAULT NULL,
  `id_tab_commessa` int(11) DEFAULT NULL,
  `sostituzione` bit(1) DEFAULT NULL,
  `codice_articolo_sostituzione` varchar(11) DEFAULT NULL,
  `id_tab_sostituzione` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_ddt`,`anno`,`numero_tab`),
  KEY `id_articolo` (`id_articolo`),
  KEY `id_ddt` (`id_ddt`),
  KEY `not` (`idnota`),
  KEY `causa` (`causale_scarico`),
  KEY `articoli_articoli_comm_sostuzione` (`id_commessa`,`anno_commessa`,`id_sottocommessa`,`id_lotto_commessa`,`id_tab_commessa`),
  CONSTRAINT `articoli_articoli_comm_sostuzione` FOREIGN KEY (`id_commessa`, `anno_commessa`, `id_sottocommessa`, `id_lotto_commessa`, `id_tab_commessa`) REFERENCES `commessa_articoli` (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`, `id_tab`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `articoli_ddt_ibfk_1` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `articoli_ddt_ibfk_2` FOREIGN KEY (`id_ddt`, `anno`) REFERENCES `ddt` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `causa` FOREIGN KEY (`causale_scarico`) REFERENCES `tipo_magazzino` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `not` FOREIGN KEY (`idnota`) REFERENCES `nota` (`id_nota`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articoli_ddt_ricevuti
CREATE TABLE IF NOT EXISTS `articoli_ddt_ricevuti` (
  `id_articolo` varchar(11) DEFAULT NULL,
  `sconto` decimal(11,2) NOT NULL,
  `id_ddt` int(11) NOT NULL,
  `Desc_breve` text,
  `anno` int(11) NOT NULL,
  `codice_fornitore` varchar(45) DEFAULT NULL,
  `numero_tab` int(11) NOT NULL DEFAULT '0',
  `quantità` decimal(11,4) DEFAULT NULL,
  `Unità_misura` varchar(5) DEFAULT NULL,
  `Prezzo` decimal(11,6) NOT NULL,
  `Serial_number` varchar(30) DEFAULT NULL,
  `tipo` char(1) DEFAULT NULL COMMENT '[vuoto] = Articolo, N = nota, ? = Riferimento DDT, + = Articolo DDT, F = Riferimento Ordine, O = Articolo Ordine',
  `idnota` int(11) DEFAULT NULL,
  `causale_scarico` int(11) DEFAULT NULL,
  `id_rif` int(11) DEFAULT NULL,
  `anno_rif` int(11) DEFAULT NULL,
  `anomalo` int(11) DEFAULT '0',
  `iva` int(10) DEFAULT NULL,
  `riparazione` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`id_ddt`,`anno`,`numero_tab`),
  KEY `id_articolo` (`id_articolo`),
  KEY `id_ddt` (`id_ddt`),
  KEY `not` (`idnota`),
  KEY `causa` (`causale_scarico`),
  CONSTRAINT `articoli_ddt_r_ibfk_2` FOREIGN KEY (`id_ddt`, `anno`) REFERENCES `ddt_ricevuti` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `articoli_r_ddt_ibfk_1` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `causa_r` FOREIGN KEY (`causale_scarico`) REFERENCES `tipo_magazzino` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `not_r` FOREIGN KEY (`idnota`) REFERENCES `nota` (`id_nota`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo
CREATE TABLE IF NOT EXISTS `articolo` (
  `Codice_articolo` varchar(11) NOT NULL,
  `Desc_brev` varchar(50) DEFAULT NULL,
  `Codice_fornitore` varchar(45) DEFAULT NULL,
  `Marca` varchar(5) DEFAULT NULL,
  `Peso` decimal(11,2) NOT NULL DEFAULT '0.00',
  `Altre_caratteristiche` varchar(30) DEFAULT NULL,
  `scadenza` int(11) DEFAULT '0',
  `Fornitore_Priv` int(11) DEFAULT NULL,
  `Tempo_installazione` int(11) NOT NULL DEFAULT '0',
  `Categoria` int(11) DEFAULT NULL,
  `Sottocategoria` int(11) DEFAULT NULL,
  `sottocategoria2` int(11) DEFAULT NULL,
  `Barcode` varchar(50) DEFAULT NULL,
  `quantita_minima` int(11) NOT NULL DEFAULT '0',
  `quantita_massima` int(11) NOT NULL DEFAULT '0',
  `Numero_confezione` int(11) NOT NULL DEFAULT '0',
  `unità_misura` varchar(5) DEFAULT NULL,
  `ult_vendita` float(11,4) DEFAULT NULL,
  `Garanzia` int(11) DEFAULT '0',
  `Minuti_manutenzione` int(11) DEFAULT NULL,
  `Stato_articolo` int(11) NOT NULL DEFAULT '1',
  `Data_modifica` date DEFAULT '2010-12-10',
  `Data_inserimento` date NOT NULL DEFAULT '2010-12-10',
  `umidità` int(11) DEFAULT '0',
  `min` int(11) DEFAULT '0',
  `max` int(11) DEFAULT '0',
  `l` int(11) DEFAULT '0',
  `h` int(11) DEFAULT '0',
  `p` int(11) DEFAULT '0',
  `modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `kw` int(11) NOT NULL DEFAULT '0',
  `litri` int(11) NOT NULL DEFAULT '0',
  `kwp` int(11) NOT NULL DEFAULT '0',
  `color` varchar(45) DEFAULT NULL,
  `moltiplicatore` float(11,2) NOT NULL DEFAULT '1.00',
  `is_kit` tinyint(1) NOT NULL DEFAULT '0',
  `scaffaliera_magazzino` varchar(50) DEFAULT NULL,
  `ripiano_magazzino` varchar(50) DEFAULT NULL,
  `descrizione_posizione_magazzino` varchar(255) DEFAULT NULL,
  `id_tipo_costo_produzione` int(11) DEFAULT NULL,
  PRIMARY KEY (`Codice_articolo`),
  KEY `Categoria` (`Categoria`,`Sottocategoria`),
  KEY `Sottocategoria` (`Sottocategoria`),
  KEY `Marca` (`Marca`),
  KEY `Fornitore_Priv` (`Fornitore_Priv`),
  KEY `unità_misura` (`unità_misura`),
  KEY `sottocategoria2` (`sottocategoria2`),
  KEY `Stato_articolo` (`Stato_articolo`),
  KEY `FK_articolo_tipo_costo_produzione` (`id_tipo_costo_produzione`),
  CONSTRAINT `articolo_ibfk_12` FOREIGN KEY (`Marca`) REFERENCES `marca` (`Id_marca`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `articolo_ibfk_13` FOREIGN KEY (`Fornitore_Priv`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `articolo_ibfk_15` FOREIGN KEY (`sottocategoria2`) REFERENCES `sottocategoria2` (`Id_livello2`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `articolo_ibfk_16` FOREIGN KEY (`unità_misura`) REFERENCES `unita_misura` (`sigla`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `articolo_ibfk_17` FOREIGN KEY (`Categoria`) REFERENCES `categoria_merciologica` (`Id_categoria`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `articolo_ibfk_18` FOREIGN KEY (`Sottocategoria`) REFERENCES `sottocategoria` (`id_sottocategoria`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_articolo_tipo_costo_produzione` FOREIGN KEY (`id_tipo_costo_produzione`) REFERENCES `tipo_costo_produzione` (`id_tipo`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_attrezzatura
CREATE TABLE IF NOT EXISTS `articolo_attrezzatura` (
  `id_articolo` varchar(13) NOT NULL,
  `id_attr` varchar(13) NOT NULL,
  `quantità` int(11) NOT NULL DEFAULT '0',
  `descrizione` text,
  PRIMARY KEY (`id_articolo`,`id_attr`) USING BTREE,
  KEY `aatrr` (`id_attr`),
  CONSTRAINT `aatrr` FOREIGN KEY (`id_attr`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `cod_Art_a` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_codice
CREATE TABLE IF NOT EXISTS `articolo_codice` (
  `id_articolo` varchar(13) NOT NULL,
  `codice` varchar(45) NOT NULL,
  `id_fornitore` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_articolo`,`codice`),
  UNIQUE KEY `art_for` (`id_fornitore`,`codice`,`id_articolo`),
  CONSTRAINT `articolo_codice_ibfk_1` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `articolo_fornitore` FOREIGN KEY (`id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_listino
CREATE TABLE IF NOT EXISTS `articolo_listino` (
  `Id_articolo` varchar(13) NOT NULL,
  `Id_listino` int(11) NOT NULL,
  `Prezzo` decimal(11,4) NOT NULL,
  `data_inizio` date NOT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id_articolo`,`Id_listino`),
  KEY `Id_listino` (`Id_listino`),
  CONSTRAINT `articolo_listino_ibfk_1` FOREIGN KEY (`Id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `articolo_listino_ibfk_2` FOREIGN KEY (`Id_listino`) REFERENCES `listino` (`Id_listino`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_listino_prezzo
CREATE TABLE IF NOT EXISTS `articolo_listino_prezzo` (
  `id_articolo` varchar(11) NOT NULL,
  `Id_listino` int(11) NOT NULL,
  `prezzo` decimal(11,4) NOT NULL,
  `Data_inizio` date NOT NULL,
  `Data_fine` date NOT NULL,
  KEY `id_articolo` (`id_articolo`,`Id_listino`),
  KEY `Id_listino` (`Id_listino`),
  CONSTRAINT `articolo_listino_prezzo_ibfk_1` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `articolo_listino_prezzo_ibfk_2` FOREIGN KEY (`Id_listino`) REFERENCES `listino` (`Id_listino`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_lotto
CREATE TABLE IF NOT EXISTS `articolo_lotto` (
  `Id_articolo` varchar(11) DEFAULT NULL,
  `Id_lotto` int(11) NOT NULL DEFAULT '0',
  `codice_fornitore` varchar(45) DEFAULT NULL,
  `quantità` decimal(10,2) DEFAULT NULL,
  `unità_misura` varchar(5) DEFAULT NULL,
  `Tempo_installazione` int(11) DEFAULT NULL,
  `Desc_brev` text,
  `id_tab` int(11) NOT NULL DEFAULT '0',
  `montato` bit(1) DEFAULT b'0',
  `tipo` varchar(5) NOT NULL,
  `prezzo` decimal(10,2) DEFAULT '0.00',
  `costo` decimal(10,2) DEFAULT '0.00',
  `prezzo_h` decimal(10,2) DEFAULT '0.00',
  `costo_h` decimal(10,2) DEFAULT '0.00',
  `idnota` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_lotto`,`id_tab`),
  KEY `unità_misura` (`unità_misura`),
  KEY `Id_articolo` (`Id_articolo`),
  CONSTRAINT `articolo_lotto_ibfk_1` FOREIGN KEY (`Id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `articolo_lotto_ibfk_2` FOREIGN KEY (`Id_lotto`) REFERENCES `lotto` (`Id_lotto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_normative
CREATE TABLE IF NOT EXISTS `articolo_normative` (
  `Id_Articolo` varchar(11) NOT NULL,
  `Normativa` int(11) NOT NULL,
  PRIMARY KEY (`Id_Articolo`,`Normativa`),
  KEY `Normativa` (`Normativa`),
  CONSTRAINT `articolo_normative_ibfk_1` FOREIGN KEY (`Id_Articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `articolo_normative_ibfk_2` FOREIGN KEY (`Normativa`) REFERENCES `normative` (`Id_normativa`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_nota
CREATE TABLE IF NOT EXISTS `articolo_nota` (
  `Id_Articolo` varchar(13) NOT NULL,
  `Descrizione` varchar(40) NOT NULL,
  `Nota` text NOT NULL,
  `data_ult_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id_Articolo`,`Descrizione`),
  KEY `Descrizione` (`Descrizione`),
  KEY `Id_Articolo` (`Id_Articolo`),
  CONSTRAINT `articolo_nota_ibfk_2` FOREIGN KEY (`Id_Articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_operazione
CREATE TABLE IF NOT EXISTS `articolo_operazione` (
  `id_articolo` varchar(13) NOT NULL,
  `id_operazione` int(11) NOT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_articolo`,`id_operazione`) USING BTREE,
  KEY `art_oper` (`id_operazione`),
  CONSTRAINT `art_oper` FOREIGN KEY (`id_operazione`) REFERENCES `operazioni_articoli` (`id_operazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_articolo_operazione_articolo` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_ordine
CREATE TABLE IF NOT EXISTS `articolo_ordine` (
  `id_articolo` varchar(13) NOT NULL,
  `data` date NOT NULL,
  `quantità` float(11,4) NOT NULL DEFAULT '0.0000',
  `ricevuti` float(11,4) NOT NULL DEFAULT '0.0000',
  KEY `id_articolo` (`id_articolo`),
  CONSTRAINT `articolo_ordine_ibfk_1` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_preventivo
CREATE TABLE IF NOT EXISTS `articolo_preventivo` (
  `Id_preventivo` int(11) NOT NULL DEFAULT '0',
  `anno` int(11) NOT NULL,
  `Id_revisione` int(11) NOT NULL DEFAULT '0',
  `Lotto` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL DEFAULT '0',
  `Id_articolo` varchar(11) DEFAULT NULL,
  `quantità` decimal(10,2) DEFAULT NULL,
  `codice_fornitore` varchar(45) DEFAULT NULL,
  `unità_misura` varchar(5) DEFAULT NULL,
  `foto` varchar(2) NOT NULL DEFAULT 'si',
  `prezzo` decimal(10,2) DEFAULT NULL,
  `costo` decimal(10,2) DEFAULT NULL,
  `Tempo_installazione` mediumint(9) DEFAULT NULL,
  `Prezzo_h` decimal(10,2) DEFAULT NULL,
  `costo_h` decimal(10,2) DEFAULT NULL,
  `Desc_brev` text,
  `Listino` int(11) DEFAULT NULL,
  `bloccato` bit(1) DEFAULT b'0',
  `montato` bit(1) DEFAULT b'0',
  `tipo` varchar(5) NOT NULL,
  `sconto` decimal(10,2) DEFAULT NULL,
  `iva` int(11) DEFAULT '21',
  `scontoriga` decimal(10,2) DEFAULT '0.00',
  `scontolav` decimal(10,2) DEFAULT '0.00',
  `checked` bit(1) DEFAULT NULL,
  `idnota` int(11) DEFAULT NULL,
  `Data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL DEFAULT '1',
  PRIMARY KEY (`Id_preventivo`,`Id_revisione`,`anno`,`Lotto`,`id_tab`) USING BTREE,
  KEY `sistema` (`Lotto`),
  KEY `Id_revisione` (`Id_revisione`),
  KEY `Id_articolo` (`Id_articolo`),
  KEY `Prezzo_h` (`Prezzo_h`),
  KEY `Listino` (`Listino`),
  KEY `anno` (`anno`),
  KEY `articolo_preventivo_ibfk_13` (`Id_preventivo`,`anno`),
  KEY `articolo_preventivo_ibfk_15` (`Id_revisione`,`Id_preventivo`,`anno`),
  KEY `inota` (`idnota`),
  CONSTRAINT `articolo_preventivo_ibfk_10` FOREIGN KEY (`Listino`) REFERENCES `listino` (`Id_listino`) ON UPDATE CASCADE,
  CONSTRAINT `articolo_preventivo_ibfk_12` FOREIGN KEY (`Id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `articolo_preventivo_ibfk_13` FOREIGN KEY (`Id_preventivo`, `anno`) REFERENCES `preventivo` (`Id_preventivo`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `articolo_preventivo_ibfk_15` FOREIGN KEY (`Id_revisione`, `Id_preventivo`, `anno`) REFERENCES `revisione_preventivo` (`Id_revisione`, `Id_preventivo`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `inota` FOREIGN KEY (`idnota`) REFERENCES `nota` (`id_nota`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lotto_art` FOREIGN KEY (`Id_preventivo`, `Id_revisione`, `anno`, `Lotto`) REFERENCES `preventivo_lotto` (`id_preventivo`, `id_revisione`, `anno`, `posizione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_ricambio
CREATE TABLE IF NOT EXISTS `articolo_ricambio` (
  `Id_articolo` varchar(13) NOT NULL,
  `Id_ricambio` varchar(13) NOT NULL,
  `quantità` int(11) DEFAULT NULL,
  `descrizione` text,
  PRIMARY KEY (`Id_articolo`,`Id_ricambio`),
  KEY `Id_ricambio` (`Id_ricambio`),
  CONSTRAINT `articolo_ricambio_ibfk_1` FOREIGN KEY (`Id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `articolo_ricambio_ibfk_2` FOREIGN KEY (`Id_ricambio`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_rumore
CREATE TABLE IF NOT EXISTS `articolo_rumore` (
  `id_articolo` varchar(11) NOT NULL,
  `min` double(11,2) NOT NULL,
  `max` double(11,2) NOT NULL,
  PRIMARY KEY (`id_articolo`),
  CONSTRAINT `FK_articolo_rumore_1_articolo` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.articolo_stato
CREATE TABLE IF NOT EXISTS `articolo_stato` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(30) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `colore` varchar(45) DEFAULT NULL,
  `bloccato` tinyint(1) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `nome` (`nome`),
  UNIQUE KEY `Index_3_colore` (`colore`)
) ENGINE=InnoDB AUTO_INCREMENT=12 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.aspetto
CREATE TABLE IF NOT EXISTS `aspetto` (
  `Id_aspetto` varchar(5) NOT NULL,
  `Nome` varchar(50) NOT NULL,
  PRIMARY KEY (`Id_aspetto`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.attrezzatura
CREATE TABLE IF NOT EXISTS `attrezzatura` (
  `id_attrezzatura` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `nota` text,
  PRIMARY KEY (`id_attrezzatura`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.automezzo
CREATE TABLE IF NOT EXISTS `automezzo` (
  `id_auto` int(11) NOT NULL AUTO_INCREMENT,
  `modello` varchar(45) NOT NULL,
  `marca` varchar(50) DEFAULT NULL,
  `targa` varchar(20) NOT NULL,
  `cilindrata` int(11) DEFAULT NULL,
  `cavalli` int(11) DEFAULT NULL,
  `carburante` varchar(45) DEFAULT NULL,
  `anno` int(11) NOT NULL,
  `id_magazzino` int(11) DEFAULT NULL,
  `stato` int(11) NOT NULL,
  PRIMARY KEY (`id_auto`),
  KEY `FK_automezzo_1_stato` (`stato`),
  CONSTRAINT `FK_automezzo_1_stato` FOREIGN KEY (`stato`) REFERENCES `stato_automezzo` (`id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.automezzo_assicurazione
CREATE TABLE IF NOT EXISTS `automezzo_assicurazione` (
  `id_assucurazione` int(11) NOT NULL AUTO_INCREMENT,
  `id_auto` int(11) NOT NULL,
  `id_agenzia` int(11) NOT NULL,
  `compagnia` varchar(200) DEFAULT NULL,
  `polizza` varchar(200) NOT NULL,
  `nota` text,
  `data` date NOT NULL,
  `vecchia` tinyint(3) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_assucurazione`),
  KEY `FK_automezzo_assicurazione_1_auto` (`id_auto`),
  KEY `FK_automezzo_assicurazione_2_agen` (`id_agenzia`),
  CONSTRAINT `FK_automezzo_assicurazione_1_auto` FOREIGN KEY (`id_auto`) REFERENCES `automezzo` (`id_auto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_automezzo_assicurazione_2_agen` FOREIGN KEY (`id_agenzia`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.automezzo_nota
CREATE TABLE IF NOT EXISTS `automezzo_nota` (
  `id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `id_auto` int(11) NOT NULL,
  `nota` text NOT NULL,
  `data` date NOT NULL,
  PRIMARY KEY (`id_nota`),
  KEY `FK_automezzo_note_1` (`id_auto`),
  CONSTRAINT `FK_automezzo_note_1` FOREIGN KEY (`id_auto`) REFERENCES `automezzo` (`id_auto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=17 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.azienda
CREATE TABLE IF NOT EXISTS `azienda` (
  `id_azienda` int(11) NOT NULL AUTO_INCREMENT,
  `titolare` int(11) DEFAULT NULL,
  `ragione_sociale` varchar(150) DEFAULT NULL,
  `settore` varchar(150) DEFAULT NULL,
  `indirizzo` varchar(90) DEFAULT NULL,
  `comune` varchar(90) DEFAULT NULL,
  `provincia` varchar(45) DEFAULT NULL,
  `telefono` varchar(13) DEFAULT NULL,
  `cellulare` varchar(13) NOT NULL,
  `partita_iva` varchar(18) DEFAULT NULL,
  `regImprese` tinyint(4) DEFAULT NULL,
  `alboProvinciale` tinyint(4) DEFAULT NULL,
  `ciaa` varchar(45) DEFAULT NULL,
  `ciaa_n` varchar(15) DEFAULT NULL,
  `albo_provincia` varchar(45) DEFAULT NULL,
  `albo_n` varchar(45) DEFAULT NULL,
  `numero` varchar(7) DEFAULT NULL,
  `sito_internet` varchar(45) DEFAULT NULL,
  `fax` varchar(13) DEFAULT NULL,
  `e_mail` varchar(45) DEFAULT NULL,
  `cod_fis` varchar(45) DEFAULT NULL,
  `numero_rea` varchar(45) DEFAULT NULL,
  `posizione_inps` varchar(45) DEFAULT NULL,
  `posizione_inail` varchar(45) DEFAULT NULL,
  `codice_ateco` varchar(45) DEFAULT NULL,
  `assicu_rct` varchar(45) DEFAULT NULL,
  `frazione` varchar(45) DEFAULT NULL,
  `capi_soc` varchar(45) DEFAULT NULL,
  `data` date NOT NULL,
  `abilitazione` varchar(145) DEFAULT NULL,
  `smtp` varchar(100) DEFAULT NULL,
  `porta` varchar(10) DEFAULT NULL,
  `mssl` tinyint(3) unsigned NOT NULL DEFAULT '0',
  `utente_mail` varchar(100) DEFAULT NULL,
  `password` varchar(45) DEFAULT NULL,
  `nome_mail` varchar(45) DEFAULT NULL,
  `id_filiale` bigint(11) DEFAULT NULL,
  `banca` varchar(100) DEFAULT NULL,
  `iban` varchar(45) DEFAULT NULL,
  `listino` tinyint(4) NOT NULL DEFAULT '0',
  `sconto` decimal(11,2) NOT NULL DEFAULT '0.00',
  `tipo_sconto` tinyint(4) NOT NULL DEFAULT '0',
  `stampa_ragione` tinyint(4) NOT NULL DEFAULT '1',
  `stampa_ri` int(11) NOT NULL DEFAULT '0',
  `giorni_promemoria` smallint(6) DEFAULT NULL,
  `cap2` varchar(10) DEFAULT NULL,
  `stampante_promemoria` varchar(75) DEFAULT NULL,
  `mail_amministrazione` varchar(45) DEFAULT '""',
  `intestazione_promemoria` varchar(100) DEFAULT '""',
  `host_caldav` varchar(45) DEFAULT '""',
  `nome_caldav` varchar(45) DEFAULT '""',
  `license` text,
  `abilita_convalida_rapporto` bit(1) DEFAULT b'0',
  `tele_fatt` varchar(200) DEFAULT NULL,
  `circolare_per_garanzia` varchar(200) DEFAULT NULL,
  `notifica_attesa` smallint(6) DEFAULT NULL,
  `passaggio_nonaccettato` smallint(6) DEFAULT NULL,
  `percorso_default_aggiornamento` varchar(200) DEFAULT NULL,
  `giorni_avviso_rapporto` int(10) unsigned DEFAULT '7',
  `regime_fiscale` varchar(10) DEFAULT NULL,
  `Data_fine` datetime DEFAULT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  `email_provider_caldav` int(11) DEFAULT '0' COMMENT 'NotAssigned = 0, Zimbra = 1, Outlook = 2',
  PRIMARY KEY (`id_azienda`),
  KEY `Index_2_tito` (`titolare`),
  KEY `FK_azieda_id_filiale` (`id_filiale`),
  CONSTRAINT `FK_azieda_id_filiale` FOREIGN KEY (`id_filiale`) REFERENCES `filiale` (`Id_filiale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_azienda_1_tito` FOREIGN KEY (`titolare`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=31 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.azienda_banca
CREATE TABLE IF NOT EXISTS `azienda_banca` (
  `id_banca` int(10) unsigned NOT NULL,
  `id_azienda` varchar(45) NOT NULL,
  `nome` varchar(45) NOT NULL,
  `iban` varchar(45) NOT NULL,
  PRIMARY KEY (`id_banca`,`id_azienda`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.azienda_funzione
CREATE TABLE IF NOT EXISTS `azienda_funzione` (
  `id_azienda` int(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  `funzione` int(11) NOT NULL,
  PRIMARY KEY (`id_azienda`,`id_operaio`,`funzione`),
  KEY `FK_azienda_funzione_2_ope` (`id_operaio`),
  KEY `FK_azienda_funzione_3_tfun` (`funzione`),
  CONSTRAINT `FK_azienda_funzione_1_azi` FOREIGN KEY (`id_azienda`) REFERENCES `azienda` (`id_azienda`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_azienda_funzione_2_ope` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_azienda_funzione_3_tfun` FOREIGN KEY (`funzione`) REFERENCES `tipo_funzione` (`id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.azienda_inizio
CREATE TABLE IF NOT EXISTS `azienda_inizio` (
  `Partita_iva` varchar(45) NOT NULL,
  `ragione_sociale` varchar(150) NOT NULL,
  `codice_fiscale` varchar(45) NOT NULL,
  `titolare` int(11) NOT NULL,
  PRIMARY KEY (`Partita_iva`),
  KEY `Index_2_tito` (`titolare`),
  CONSTRAINT `FK_azienda_inizio_1_tito` FOREIGN KEY (`titolare`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.azienda_registrazione
CREATE TABLE IF NOT EXISTS `azienda_registrazione` (
  `id_registrazione` int(10) NOT NULL AUTO_INCREMENT,
  `nome` varchar(145) NOT NULL,
  `mail` varchar(145) NOT NULL,
  `data` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `indirizzo` varchar(145) NOT NULL,
  `indirizzo2` varchar(145) NOT NULL,
  PRIMARY KEY (`id_registrazione`)
) ENGINE=InnoDB AUTO_INCREMENT=39 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.backup
CREATE TABLE IF NOT EXISTS `backup` (
  `id_profilo` int(10) NOT NULL AUTO_INCREMENT,
  `numero_bk` int(11) NOT NULL DEFAULT '1',
  `db` varchar(50) NOT NULL DEFAULT '1',
  `files` tinyint(4) NOT NULL DEFAULT '1',
  `path` varchar(200) NOT NULL,
  `nome` varchar(45) NOT NULL,
  `ins` int(11) NOT NULL DEFAULT '0',
  `struct` int(11) NOT NULL DEFAULT '0',
  `dropt` int(11) NOT NULL DEFAULT '0',
  `fore` int(11) NOT NULL DEFAULT '0',
  `trig` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_profilo`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.backup_date
CREATE TABLE IF NOT EXISTS `backup_date` (
  `mese` int(11) NOT NULL,
  `giorno` int(11) NOT NULL,
  PRIMARY KEY (`giorno`,`mese`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.backup_eseguiti
CREATE TABLE IF NOT EXISTS `backup_eseguiti` (
  `id_backup` int(11) NOT NULL AUTO_INCREMENT,
  `orario` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `profilo` int(11) DEFAULT NULL,
  `stato` int(11) DEFAULT NULL,
  `orario_fine` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
  `nome_file` varchar(245) DEFAULT NULL,
  `tipo_operazione` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_backup`),
  KEY `FK_backup_eseguiti_1` (`profilo`),
  KEY `FK_backup_eseguiti_2_tbkop` (`tipo_operazione`),
  CONSTRAINT `FK_backup_eseguiti_1` FOREIGN KEY (`profilo`) REFERENCES `backup` (`id_profilo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_backup_eseguiti_2_tbkop` FOREIGN KEY (`tipo_operazione`) REFERENCES `tipo_bkop` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=150 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.backup_giorni
CREATE TABLE IF NOT EXISTS `backup_giorni` (
  `id_profilo` int(11) NOT NULL AUTO_INCREMENT,
  `giorno` int(11) NOT NULL,
  `ora` time NOT NULL,
  PRIMARY KEY (`id_profilo`,`giorno`,`ora`) USING BTREE,
  CONSTRAINT `FK_backup_giorni_1` FOREIGN KEY (`id_profilo`) REFERENCES `backup` (`id_profilo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.back_up_tabelle
CREATE TABLE IF NOT EXISTS `back_up_tabelle` (
  `id_profilo` int(11) NOT NULL,
  `tabella` varchar(145) NOT NULL,
  PRIMARY KEY (`id_profilo`,`tabella`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.banca
CREATE TABLE IF NOT EXISTS `banca` (
  `Id_banca` bigint(20) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `abi` varchar(5) DEFAULT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`Id_banca`),
  KEY `abi` (`abi`)
) ENGINE=InnoDB AUTO_INCREMENT=3525 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.banca_appoggio
CREATE TABLE IF NOT EXISTS `banca_appoggio` (
  `Id_banca` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) DEFAULT NULL,
  `Cosa si presenta` varchar(200) DEFAULT NULL,
  `abi` varchar(20) DEFAULT NULL,
  `cab` varchar(20) DEFAULT NULL,
  `Provincia` varchar(3) DEFAULT NULL,
  `comune` int(11) DEFAULT NULL,
  `frazione` int(11) DEFAULT NULL,
  `indirizzo` varchar(50) DEFAULT NULL,
  `numero civico` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_banca`),
  UNIQUE KEY `abi` (`abi`,`cab`),
  KEY `Provincia` (`Provincia`,`comune`,`frazione`),
  KEY `frazione` (`frazione`),
  KEY `comune` (`comune`),
  CONSTRAINT `banca_appoggio_ibfk_2` FOREIGN KEY (`comune`) REFERENCES `comune` (`Id_comune`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `banca_appoggio_ibfk_3` FOREIGN KEY (`frazione`) REFERENCES `frazione` (`Id_frazione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.banned_list
CREATE TABLE IF NOT EXISTS `banned_list` (
  `serial` varchar(145) NOT NULL,
  PRIMARY KEY (`serial`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.campagna_aries
CREATE TABLE IF NOT EXISTS `campagna_aries` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uuid` char(36) NOT NULL,
  `nome` varchar(150) NOT NULL DEFAULT '',
  `descrizione` text NOT NULL,
  `oggetto_mail` text NOT NULL,
  `mail_template_path` text NOT NULL,
  `data_attivazione` datetime DEFAULT NULL,
  `data_disattivazione` datetime DEFAULT NULL,
  `attiva` bit(1) NOT NULL DEFAULT b'0',
  `id_tipo_campagna` int(11) NOT NULL DEFAULT '0',
  `data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `utente_ins` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_campagna_aries_uuid` (`uuid`),
  KEY `FK_campagna_aries_tipo_campagna` (`id_tipo_campagna`),
  CONSTRAINT `FK_campagna_aries_tipo_campagna` FOREIGN KEY (`id_tipo_campagna`) REFERENCES `tipo_campagna_aries` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.campagna_aries_mail
CREATE TABLE IF NOT EXISTS `campagna_aries_mail` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uuid` char(36) NOT NULL,
  `id_campagna_aries` int(11) NOT NULL,
  `id_cliente` int(11) NOT NULL,
  `id_impianto` int(11) DEFAULT NULL,
  `id_mail` int(11) DEFAULT NULL,
  `mail` varchar(100) NOT NULL,
  `data_invio` datetime NOT NULL,
  `processato` bit(1) NOT NULL DEFAULT b'0',
  `errore_processamento` mediumtext,
  `data_ins` datetime NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_mail_campagna_aries_uuid` (`uuid`),
  KEY `FK_campagna_aries_mail_campagna_aries` (`id_campagna_aries`),
  KEY `FK_campagna_aries_mail_clienti` (`id_cliente`),
  KEY `FK_campagna_aries_mail_impianto` (`id_impianto`),
  KEY `FK_campagna_aries_mail_mail` (`id_mail`),
  CONSTRAINT `FK_campagna_aries_mail_campagna_aries` FOREIGN KEY (`id_campagna_aries`) REFERENCES `campagna_aries` (`id`) ON UPDATE CASCADE,
  CONSTRAINT `FK_campagna_aries_mail_clienti` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON UPDATE CASCADE,
  CONSTRAINT `FK_campagna_aries_mail_impianto` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `FK_campagna_aries_mail_mail` FOREIGN KEY (`id_mail`) REFERENCES `mail` (`Id`) ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.campagna_aries_mail_dati
CREATE TABLE IF NOT EXISTS `campagna_aries_mail_dati` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uuid` char(36) NOT NULL,
  `id_campagna_aries_mail` int(11) NOT NULL,
  `id_campagna_aries_segnaposto` int(11) NOT NULL,
  `valore` mediumtext NOT NULL,
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `idx_mail_data_campagna_aries_uuid` (`uuid`),
  KEY `FK_campagna_aries_mail_dati_campagna_aries_mail` (`id_campagna_aries_mail`) USING BTREE,
  KEY `FK_campagna_aries_mail_dati_campagna_aries_segnaposto` (`id_campagna_aries_segnaposto`) USING BTREE,
  CONSTRAINT `FK_campagna_aries_mail_dati_campagna_aries_mail` FOREIGN KEY (`id_campagna_aries_mail`) REFERENCES `campagna_aries_mail` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_campagna_aries_mail_dati_campagna_aries_segnaposto` FOREIGN KEY (`id_campagna_aries_segnaposto`) REFERENCES `campagna_aries_segnaposto` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.campagna_aries_segnaposto
CREATE TABLE IF NOT EXISTS `campagna_aries_segnaposto` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uuid` char(36) NOT NULL,
  `id_tipo_campagna` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL DEFAULT '',
  `descrizione` text NOT NULL,
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `id_tipo_campagna_aries_nome` (`id_tipo_campagna`,`nome`) USING BTREE,
  UNIQUE KEY `idx_placeholder_campagna_aries_uuid` (`uuid`),
  CONSTRAINT `FK_campagna_aries_segnaposto_tipo_campagna` FOREIGN KEY (`id_tipo_campagna`) REFERENCES `tipo_campagna_aries` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cartella_default
CREATE TABLE IF NOT EXISTS `cartella_default` (
  `id_tipo` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  PRIMARY KEY (`id_tipo`,`nome`),
  CONSTRAINT `FK_cartella_default_1:car` FOREIGN KEY (`id_tipo`) REFERENCES `cartella_tipo` (`id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cartella_tipo
CREATE TABLE IF NOT EXISTS `cartella_tipo` (
  `id_tipo` int(11) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  PRIMARY KEY (`id_tipo`),
  CONSTRAINT `FK_cartella_tipo_1` FOREIGN KEY (`id_tipo`) REFERENCES `tipo_jump` (`id_jump`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.categoria_merciologica
CREATE TABLE IF NOT EXISTS `categoria_merciologica` (
  `Id_categoria` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Descrizione` text,
  `Movimenta_magazzino` bit(1) DEFAULT b'1',
  `Movimenta_impianto` bit(1) DEFAULT b'1',
  `Data_ins` datetime DEFAULT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) DEFAULT NULL,
  `Utente_mod` smallint(6) DEFAULT NULL,
  PRIMARY KEY (`Id_categoria`),
  UNIQUE KEY `nome_uni` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=149 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.causale_fattura
CREATE TABLE IF NOT EXISTS `causale_fattura` (
  `id_causale` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_causale`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.causale_lavoro
CREATE TABLE IF NOT EXISTS `causale_lavoro` (
  `Id_causale` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` longtext,
  `Tempo` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_causale`)
) ENGINE=InnoDB AUTO_INCREMENT=712 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.causale_magazzino
CREATE TABLE IF NOT EXISTS `causale_magazzino` (
  `Id_causale` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(35) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  `Operazione` int(11) NOT NULL,
  `tipo_magazzino` int(11) DEFAULT NULL,
  `reso` tinyint(4) NOT NULL DEFAULT '0',
  PRIMARY KEY (`Id_causale`),
  UNIQUE KEY `Nome` (`Nome`),
  UNIQUE KEY `uni` (`Operazione`,`tipo_magazzino`),
  KEY `Operazione` (`Operazione`),
  KEY `tip_maga` (`tipo_magazzino`),
  CONSTRAINT `causale_magazzino_ibfk_1` FOREIGN KEY (`Operazione`) REFERENCES `operazione` (`Id_operazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `tip_maga` FOREIGN KEY (`tipo_magazzino`) REFERENCES `tipo_magazzino` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=70 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.causale_ticket
CREATE TABLE IF NOT EXISTS `causale_ticket` (
  `Id_causale` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(40) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `Garanzia` int(11) NOT NULL,
  PRIMARY KEY (`Id_causale`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.causale_trasporto
CREATE TABLE IF NOT EXISTS `causale_trasporto` (
  `Id_causale` varchar(8) NOT NULL,
  `Causale` varchar(50) NOT NULL,
  `Scarico` char(1) DEFAULT NULL,
  `tipo` char(1) DEFAULT NULL,
  `Operazione` int(11) NOT NULL,
  `id_maga` int(11) DEFAULT '1',
  `id_maga_forn` tinyint(4) DEFAULT NULL,
  `chiuso` tinyint(4) DEFAULT '0',
  `garanzia` tinyint(4) NOT NULL DEFAULT '0',
  `maga_dip` int(11) DEFAULT NULL,
  `causa_sub` varchar(8) DEFAULT NULL,
  `descrizione` varchar(45) DEFAULT NULL,
  `id_maga_default` int(11) NOT NULL,
  PRIMARY KEY (`Id_causale`) USING BTREE,
  KEY `Operazione` (`Operazione`),
  KEY `FK_causale_trasporto_2` (`id_maga_default`),
  CONSTRAINT `causale_trasporto_ibfk_1` FOREIGN KEY (`Operazione`) REFERENCES `operazione` (`Id_operazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_causale_trasporto_2` FOREIGN KEY (`id_maga_default`) REFERENCES `tipo_magazzino` (`Id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.certificato_importato
CREATE TABLE IF NOT EXISTS `certificato_importato` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(150) NOT NULL,
  `nome_emittente` varchar(150) NOT NULL,
  `nome_rif` varchar(150) NOT NULL COMMENT 'Nome del certificato per identificarlo. Questo nome puo essere scelto all importazione',
  `email` varchar(150) NOT NULL,
  `data_inizio_validita` datetime NOT NULL,
  `data_fine_validita` datetime NOT NULL,
  `serial_number` varchar(150) NOT NULL,
  `pin` varchar(50) DEFAULT NULL,
  `smart_device` bit(1) NOT NULL,
  `attivo` bit(1) NOT NULL,
  `data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `utente_mod` int(11) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist
CREATE TABLE IF NOT EXISTS `checklist` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_mobile` int(11) NOT NULL,
  `data_esecuzione` date NOT NULL,
  `id_checklist_model` int(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  `id_cliente` int(11) DEFAULT NULL,
  `id_responsabile` int(11) DEFAULT NULL,
  `id_impianto` int(11) DEFAULT NULL,
  `ragione_sociale` varchar(150) NOT NULL,
  `indirizzo` varchar(150) NOT NULL,
  `citta` varchar(150) NOT NULL,
  `responsabile` varchar(150) DEFAULT NULL,
  `impianto_luogo_installazione` varchar(150) NOT NULL,
  `impianto_centrale` varchar(150) NOT NULL,
  `impianto_data_installazione` date DEFAULT NULL,
  `impianto_dipartimento` varchar(150) DEFAULT NULL,
  `timestamp_creazione` datetime NOT NULL,
  `numero_visita` tinyint(4) NOT NULL,
  `controllo_periodico` tinyint(4) DEFAULT NULL,
  `altro` text,
  `responsabile_lavoro` varchar(150) DEFAULT NULL,
  `appunti` mediumtext,
  `filename_firma_cliente` varchar(50) DEFAULT NULL,
  `filename_firma_tecnico` varchar(50) DEFAULT NULL,
  `inviata` bit(1) DEFAULT b'0',
  `visionata` bit(1) DEFAULT b'0',
  `stampata` bit(1) NOT NULL DEFAULT b'0',
  `utente_ins` int(11) NOT NULL,
  `utente_mod` int(11) DEFAULT NULL,
  `data_ins` datetime NOT NULL,
  `data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `fk_checklist_checklist_model` (`id_checklist_model`),
  KEY `fk_checklist_operaio` (`id_operaio`),
  CONSTRAINT `fk_checklist_checklist_model` FOREIGN KEY (`id_checklist_model`) REFERENCES `checklist_model` (`id_check`),
  CONSTRAINT `fk_checklist_operaio` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_model
CREATE TABLE IF NOT EXISTS `checklist_model` (
  `id_check` int(11) NOT NULL AUTO_INCREMENT,
  `Id_check_parent` int(11) DEFAULT NULL,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(300) NOT NULL,
  `note` varchar(200) NOT NULL,
  `tipo_impianto` smallint(6) DEFAULT NULL,
  `Stato` tinyint(4) DEFAULT '1' COMMENT '1 = attiva, 2 = modificata, 3 = storicizzata',
  `Data_ins` datetime DEFAULT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) DEFAULT NULL,
  `Utente_mod` smallint(6) DEFAULT NULL,
  PRIMARY KEY (`id_check`),
  KEY `nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_model_elemento
CREATE TABLE IF NOT EXISTS `checklist_model_elemento` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_paragrafo` int(11) NOT NULL,
  `Id_checklist` int(11) NOT NULL,
  `Posizione` smallint(6) NOT NULL,
  `tipo_elemento` tinyint(4) NOT NULL,
  `nome` varchar(45) NOT NULL,
  `descrizione` text NOT NULL,
  `indicazioni` varchar(500) NOT NULL,
  `Id_elemento` int(11) DEFAULT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`Id`),
  KEY `FK_checklist_model_elemento_tipo` (`tipo_elemento`),
  KEY `FK_cjecklist_model_elemento_elemento_generico` (`Id_elemento`),
  CONSTRAINT `FK_checklist_model_elemento_tipo` FOREIGN KEY (`tipo_elemento`) REFERENCES `tipo_checklist_elemento` (`Id`),
  CONSTRAINT `FK_cjecklist_model_elemento_elemento_generico` FOREIGN KEY (`Id_elemento`) REFERENCES `checklist_model_elemento_generico` (`id_elemento`)
) ENGINE=InnoDB AUTO_INCREMENT=2534 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_model_elemento_def_valore
CREATE TABLE IF NOT EXISTS `checklist_model_elemento_def_valore` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_elemento` int(11) NOT NULL,
  `Id_tipo_def_val` int(11) NOT NULL,
  `Label` varchar(100) NOT NULL,
  `Field` varchar(100) NOT NULL,
  `Value` mediumtext NOT NULL,
  `Data_mod` datetime NOT NULL,
  `Utente_mod` mediumint(9) NOT NULL,
  PRIMARY KEY (`Id`),
  KEY `fk_checklist_model_elemento_valore` (`Id_elemento`),
  KEY `fk_tipo_checklist_model_elemento_valore` (`Id_tipo_def_val`),
  CONSTRAINT `fk_checklist_model_elemento_valore` FOREIGN KEY (`Id_elemento`) REFERENCES `checklist_model_elemento` (`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_tipo_checklist_model_elemento_valore` FOREIGN KEY (`Id_tipo_def_val`) REFERENCES `tipo_checklist_model_elemento_def_valore` (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_model_elemento_generico
CREATE TABLE IF NOT EXISTS `checklist_model_elemento_generico` (
  `id_elemento` int(11) NOT NULL AUTO_INCREMENT,
  `tipo_elemento` int(11) NOT NULL DEFAULT '1',
  `nome` varchar(45) NOT NULL,
  `descrizione` text NOT NULL,
  `indicazioni` varchar(500) NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`id_elemento`),
  UNIQUE KEY `tipo_elemento_nome_indicazioni` (`tipo_elemento`,`nome`,`indicazioni`)
) ENGINE=InnoDB AUTO_INCREMENT=163 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_model_impianto
CREATE TABLE IF NOT EXISTS `checklist_model_impianto` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `id_checklist` int(11) NOT NULL,
  `id_impianto` int(11) NOT NULL,
  `Data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `id_impianto` (`id_impianto`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_model_paragrafo
CREATE TABLE IF NOT EXISTS `checklist_model_paragrafo` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `id_checklist` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  `descrizione` text NOT NULL,
  `ordine` smallint(6) NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=348 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_paragrafo
CREATE TABLE IF NOT EXISTS `checklist_paragrafo` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_checklist` int(11) NOT NULL,
  `id_checklist_model_paragrafo` int(11) NOT NULL,
  `nome` varchar(150) NOT NULL,
  `descrizione` text NOT NULL,
  `ordine` int(11) NOT NULL,
  `utente_mod` int(11) DEFAULT NULL,
  `data_mod` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `FK_checklist_paragrafo_checklist` (`id_checklist`),
  CONSTRAINT `FK_checklist_paragrafo_checklist` FOREIGN KEY (`id_checklist`) REFERENCES `checklist` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=78 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_paragrafo_riga
CREATE TABLE IF NOT EXISTS `checklist_paragrafo_riga` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_checklist` int(11) NOT NULL,
  `id_paragrafo` int(11) NOT NULL,
  `json_data` mediumtext NOT NULL,
  `tipo_riga` tinyint(4) NOT NULL,
  `id_checklist_model_elemento` int(11) NOT NULL,
  `id_checklist_model_paragrafo` int(11) NOT NULL,
  `id_checklist_model` int(11) NOT NULL,
  `ordine` int(11) NOT NULL,
  `nome` varchar(150) NOT NULL,
  `descrizione` text,
  `indicazioni_tecnico` text NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_checklist_paragrafo_riga_checklist` (`id_checklist`),
  KEY `fk_checklist_paragrafo_riga_checklist_paragrafo` (`id_paragrafo`),
  KEY `fk_checklist_paragrafo_riga_checklist_tipo_riga` (`tipo_riga`),
  CONSTRAINT `fk_checklist_paragrafo_riga_checklist` FOREIGN KEY (`id_checklist`) REFERENCES `checklist` (`id`),
  CONSTRAINT `fk_checklist_paragrafo_riga_checklist_paragrafo` FOREIGN KEY (`id_paragrafo`) REFERENCES `checklist_paragrafo` (`id`),
  CONSTRAINT `fk_checklist_paragrafo_riga_checklist_tipo_riga` FOREIGN KEY (`tipo_riga`) REFERENCES `tipo_checklist_elemento` (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=942 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_rapporto
CREATE TABLE IF NOT EXISTS `checklist_rapporto` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_checklist` int(11) NOT NULL,
  `id_rapporto` int(11) NOT NULL,
  `anno_rapporto` int(11) NOT NULL,
  PRIMARY KEY (`Id`),
  KEY `fk_checklist_rapporto_checklist` (`Id_checklist`),
  CONSTRAINT `fk_checklist_rapporto_checklist` FOREIGN KEY (`Id_checklist`) REFERENCES `checklist` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.checklist_tecnico
CREATE TABLE IF NOT EXISTS `checklist_tecnico` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_checklist` int(11) NOT NULL,
  `Id_tecnico` int(11) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_checklist_Id_tecnico` (`Id_checklist`,`Id_tecnico`),
  KEY `fk_checklist_tecnico_operaio` (`Id_tecnico`),
  CONSTRAINT `fk_checklist_tecnico_checklist` FOREIGN KEY (`Id_checklist`) REFERENCES `checklist` (`id`),
  CONSTRAINT `fk_checklist_tecnico_operaio` FOREIGN KEY (`Id_tecnico`) REFERENCES `operaio` (`Id_operaio`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cliente_estratto_conto
CREATE TABLE IF NOT EXISTS `cliente_estratto_conto` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_cliente` int(11) NOT NULL,
  `id_email` int(11) NOT NULL,
  `data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `utente_ins` int(11) NOT NULL,
  PRIMARY KEY (`id`) USING BTREE,
  KEY `FK_cliente_estratto_conto_clienti` (`id_cliente`),
  KEY `FK_cliente_estratto_conto_email` (`id_email`),
  KEY `FK_cliente_estratto_conto_utente` (`utente_ins`),
  CONSTRAINT `FK_cliente_estratto_conto_clienti` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `FK_cliente_estratto_conto_email` FOREIGN KEY (`id_email`) REFERENCES `mail` (`Id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `FK_cliente_estratto_conto_utente` FOREIGN KEY (`utente_ins`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=419 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cliente_lettera_intento
CREATE TABLE IF NOT EXISTS `cliente_lettera_intento` (
  `id_lettera` int(11) NOT NULL,
  `tipo_iva` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `data_lettera` date NOT NULL,
  `data_registrazione` date NOT NULL,
  `prot_registrazione` int(11) NOT NULL DEFAULT '0',
  `data_inizio` date DEFAULT NULL,
  `data_fine` date DEFAULT NULL,
  `data_revoca` date DEFAULT NULL,
  `id_cliente` int(11) NOT NULL,
  `checkNota` tinyint(4) DEFAULT '0',
  `nota` text,
  PRIMARY KEY (`id_lettera`,`anno`),
  KEY `FK_cliente_lettera_intento_1` (`id_cliente`),
  KEY `FK_cliente_lettera_intento_2` (`tipo_iva`),
  CONSTRAINT `FK_cliente_lettera_intento_1` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_cliente_lettera_intento_2` FOREIGN KEY (`tipo_iva`) REFERENCES `tipo_iva` (`Id_iva`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cliente_nota
CREATE TABLE IF NOT EXISTS `cliente_nota` (
  `Id_cliente` int(11) NOT NULL,
  `Id_nota` int(11) NOT NULL,
  `Descrizione` text NOT NULL,
  `data_ult_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id_cliente`,`Id_nota`),
  KEY `cliente_nota_ibfk_1` (`Id_nota`),
  CONSTRAINT `cliente` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `cliente_nota_ibfk_1` FOREIGN KEY (`Id_nota`) REFERENCES `clienti_note` (`Id_nota`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cliente_nota_temporanea
CREATE TABLE IF NOT EXISTS `cliente_nota_temporanea` (
  `id_cliente` int(11) NOT NULL,
  `id_nota` int(11) NOT NULL,
  PRIMARY KEY (`id_cliente`,`id_nota`) USING BTREE,
  CONSTRAINT `FK_cliente_nota_temporanea_1` FOREIGN KEY (`id_cliente`, `id_nota`) REFERENCES `cliente_nota` (`Id_cliente`, `Id_nota`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cliente_promemoria_configurazione
CREATE TABLE IF NOT EXISTS `cliente_promemoria_configurazione` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Tipo_intervallo` smallint(6) NOT NULL COMMENT '1 = Giorno del mese,  2 = Intervallo giorni',
  `Valore` int(11) NOT NULL,
  `Data_ultima_esecuzione` datetime NOT NULL,
  `Oggetto_email` varchar(150) DEFAULT NULL,
  `Corpo_email` text,
  `Testo_sms` text,
  `abilita_sms` bit(1) NOT NULL,
  `abilita_email` bit(1) NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_mod` int(11) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cliente_promemoria_configurazione_generale
CREATE TABLE IF NOT EXISTS `cliente_promemoria_configurazione_generale` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Email_host` varchar(50) NOT NULL,
  `Email_username` varchar(50) NOT NULL,
  `Email_password` varchar(50) NOT NULL,
  `Email_port` int(11) NOT NULL DEFAULT '0',
  `Email_ssl` bit(1) NOT NULL DEFAULT b'0',
  `Email_from` varchar(50) NOT NULL DEFAULT '0',
  `Sms_host` varchar(150) NOT NULL DEFAULT '0',
  `Sms_endpoint` varchar(150) NOT NULL DEFAULT '',
  `Sms_password` varchar(150) NOT NULL DEFAULT '',
  `Data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` int(11) NOT NULL,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cliente_promemoria_segnaposto
CREATE TABLE IF NOT EXISTS `cliente_promemoria_segnaposto` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_cliente_promemoria_configurazione` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL DEFAULT '',
  `descrizione` text NOT NULL,
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `id_cliente_promemoria_configurazione_nome` (`id_cliente_promemoria_configurazione`,`nome`) USING BTREE,
  CONSTRAINT `FK_cliente_promemoria_configurazione` FOREIGN KEY (`id_cliente_promemoria_configurazione`) REFERENCES `cliente_promemoria_configurazione` (`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=69 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.cliente_tag
CREATE TABLE IF NOT EXISTS `cliente_tag` (
  `id_cliente` int(11) NOT NULL,
  `id_tag` int(11) NOT NULL,
  `utente_ins` int(11) DEFAULT NULL,
  `data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_cliente`,`id_tag`),
  KEY `FK_cliente_tag_tag` (`id_tag`),
  KEY `FK_cliente_tag_cliente` (`id_cliente`),
  KEY `FK_cliente_tag_utente_ins` (`utente_ins`),
  CONSTRAINT `FK_cliente_tag_cliente` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_cliente_tag_tag` FOREIGN KEY (`id_tag`) REFERENCES `tag` (`id_tag`) ON UPDATE CASCADE,
  CONSTRAINT `FK_cliente_tag_utente_ins` FOREIGN KEY (`utente_ins`) REFERENCES `utente` (`Id_utente`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti
CREATE TABLE IF NOT EXISTS `clienti` (
  `Id_cliente` int(11) NOT NULL AUTO_INCREMENT,
  `Ragione_Sociale` varchar(70) NOT NULL,
  `Ragione_sociale2` varchar(50) DEFAULT NULL,
  `Partita_iva` varchar(12) DEFAULT NULL,
  `Codice_Fiscale` varchar(20) DEFAULT NULL,
  `Cortese_attenzione` varchar(50) DEFAULT NULL,
  `Data_inserimento` date DEFAULT NULL,
  `Stato_cliente` varchar(10) DEFAULT NULL,
  `Tipo_Cliente` int(11) DEFAULT NULL,
  `stato_economico` int(11) DEFAULT NULL,
  `condizione_pagamento` int(11) DEFAULT NULL,
  `Sito_internet` varchar(200) DEFAULT NULL,
  `password` varchar(20) DEFAULT NULL,
  `Utente_sito` varchar(60) DEFAULT NULL,
  `iva` int(11) DEFAULT '21',
  `modi` tinyint(1) unsigned NOT NULL DEFAULT '0',
  `rc` tinyint(1) unsigned NOT NULL DEFAULT '0',
  `posta` tinyint(1) unsigned NOT NULL DEFAULT '0',
  `ex` int(11) DEFAULT NULL,
  `tipo_rapporto` int(11) DEFAULT '1',
  `id_utente` int(11) DEFAULT NULL,
  `id_agente` int(11) DEFAULT NULL,
  `id_abbona` int(11) DEFAULT NULL,
  `id_attività` int(11) DEFAULT NULL,
  `pec` varchar(145) DEFAULT NULL,
  `codice_univoco` varchar(20) DEFAULT NULL,
  `e_codice_destinatario` varchar(7) DEFAULT NULL COMMENT 'Codice identificativo per l''invio delle fatture elettronica. 7 caratteri da richiedere al ente di trasmissione. Es: infocert',
  `Insolvente` bit(1) DEFAULT b'0',
  `data_ultima_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id_cliente`),
  KEY `Tipo_Cliente` (`Tipo_Cliente`),
  KEY `Stato_cliente` (`Stato_cliente`),
  KEY `stato_economico` (`stato_economico`),
  KEY `condizione_pagamento` (`condizione_pagamento`),
  KEY `iva` (`iva`),
  KEY `tipo_rap` (`tipo_rapporto`),
  KEY `FK_clienti_7_ut` (`id_utente`),
  KEY `FK_clienti_8` (`id_abbona`),
  CONSTRAINT `clienti_ibfk_24` FOREIGN KEY (`Stato_cliente`) REFERENCES `stato_clienti` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `clienti_ibfk_26` FOREIGN KEY (`stato_economico`) REFERENCES `stato_economico` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `clienti_ibfk_28` FOREIGN KEY (`condizione_pagamento`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `clienti_ibfk_29` FOREIGN KEY (`iva`) REFERENCES `tipo_iva` (`Id_iva`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_clienti_7_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_clienti_8` FOREIGN KEY (`id_abbona`) REFERENCES `abbonamento` (`Id_abbonamento`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `tipo_clie` FOREIGN KEY (`Tipo_Cliente`) REFERENCES `tipo_cliente` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `tipo_rappo` FOREIGN KEY (`tipo_rapporto`) REFERENCES `tipo_rapclie` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=7466 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti_banche
CREATE TABLE IF NOT EXISTS `clienti_banche` (
  `Id_cliente` int(11) NOT NULL,
  `Id_filiale` int(11) NOT NULL,
  `data_inizio` date NOT NULL,
  `data_fine` date DEFAULT NULL,
  `Iban` varchar(27) NOT NULL,
  PRIMARY KEY (`Id_cliente`,`Id_filiale`,`Iban`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti_destinazione_riferimento
CREATE TABLE IF NOT EXISTS `clienti_destinazione_riferimento` (
  `Id_cliente` int(11) NOT NULL,
  `Id_riferimento` int(11) NOT NULL,
  `Id_destinazione` int(11) NOT NULL,
  `attivo` tinyint(1) NOT NULL,
  PRIMARY KEY (`Id_cliente`,`Id_riferimento`,`Id_destinazione`),
  KEY `Id_riferimento` (`Id_riferimento`),
  KEY `Id_destinazione` (`Id_destinazione`),
  CONSTRAINT `clienti_destinazione_riferimento_ibfk_1` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `clienti_destinazione_riferimento_ibfk_2` FOREIGN KEY (`Id_riferimento`) REFERENCES `riferimento_clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `clienti_destinazione_riferimento_ibfk_3` FOREIGN KEY (`Id_destinazione`) REFERENCES `destinazione_cliente` (`Id_destinazione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti_evento
CREATE TABLE IF NOT EXISTS `clienti_evento` (
  `Id_cliente` int(11) NOT NULL,
  `Id_documento` int(11) NOT NULL,
  `Nota` varchar(200) NOT NULL,
  PRIMARY KEY (`Id_cliente`,`Id_documento`),
  KEY `Id_documento` (`Id_documento`),
  CONSTRAINT `clienti_evento_ibfk_1` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `clienti_evento_ibfk_2` FOREIGN KEY (`Id_documento`) REFERENCES `tipo_documento` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti_invio
CREATE TABLE IF NOT EXISTS `clienti_invio` (
  `id_cliente` int(11) NOT NULL,
  `mail` int(11) NOT NULL,
  `fax` int(11) NOT NULL,
  `telefono` int(11) NOT NULL,
  `lettera` int(11) NOT NULL,
  PRIMARY KEY (`id_cliente`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti_note
CREATE TABLE IF NOT EXISTS `clienti_note` (
  `Id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `Descrizione` varchar(30) NOT NULL,
  `Nota` mediumtext,
  PRIMARY KEY (`Id_nota`,`Descrizione`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=104 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti_progetto
CREATE TABLE IF NOT EXISTS `clienti_progetto` (
  `Id_cliente` int(11) NOT NULL,
  `Id_progetto` int(11) NOT NULL,
  `descrizione` int(11) DEFAULT NULL,
  `Stato` int(11) NOT NULL,
  `path` int(11) NOT NULL,
  PRIMARY KEY (`Id_cliente`,`Id_progetto`),
  CONSTRAINT `clienti_progetto_ibfk_1` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti_ragione_sociale
CREATE TABLE IF NOT EXISTS `clienti_ragione_sociale` (
  `Id_cliente` int(11) NOT NULL,
  `Ragione_sociale` varchar(50) NOT NULL,
  `data_inizio` date NOT NULL,
  `data_fine` date NOT NULL,
  KEY `Id_cliente` (`Id_cliente`),
  CONSTRAINT `clienti_ragione_sociale_ibfk_1` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.clienti_sconto
CREATE TABLE IF NOT EXISTS `clienti_sconto` (
  `id_cliente` int(11) NOT NULL,
  `marca` varchar(5) NOT NULL,
  `sconto` float(11,2) NOT NULL,
  `Listino` int(11) NOT NULL,
  PRIMARY KEY (`id_cliente`,`marca`),
  KEY `marca` (`marca`),
  KEY `Listino` (`Listino`),
  CONSTRAINT `clienti_sconto_ibfk_1` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `clienti_sconto_ibfk_2` FOREIGN KEY (`marca`) REFERENCES `marca` (`Id_marca`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `clienti_sconto_ibfk_3` FOREIGN KEY (`Listino`) REFERENCES `listino` (`Id_listino`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.collaudo
CREATE TABLE IF NOT EXISTS `collaudo` (
  `inviato` bit(1) DEFAULT NULL,
  `id_collaudo_invio` int(11) DEFAULT NULL,
  `id_collaudo` int(11) DEFAULT NULL,
  `anno` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.collaudo_firma
CREATE TABLE IF NOT EXISTS `collaudo_firma` (
  `id_rapporto` int(10) unsigned NOT NULL,
  `anno` int(10) unsigned NOT NULL,
  `firma_cliente` blob,
  `firma_tecnico` blob,
  PRIMARY KEY (`id_rapporto`,`anno`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.collaudo_tecnici
CREATE TABLE IF NOT EXISTS `collaudo_tecnici` (
  `id_collaudo` varchar(15) NOT NULL DEFAULT '',
  `anno` varchar(15) NOT NULL DEFAULT '',
  `id_tecnico` varchar(15) NOT NULL DEFAULT '',
  PRIMARY KEY (`id_collaudo`,`anno`,`id_tecnico`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa
CREATE TABLE IF NOT EXISTS `commessa` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_commessa` int(11) NOT NULL,
  `id_cliente` int(11) DEFAULT NULL,
  `data_inizio` date DEFAULT NULL,
  `data_fine` date DEFAULT NULL,
  `stato_commessa` int(11) DEFAULT NULL,
  `Descrizione` longtext,
  `anno` int(11) NOT NULL DEFAULT '0',
  `nr_appalto` varchar(13) DEFAULT NULL,
  `codice_commessa` varchar(13) DEFAULT NULL,
  `data_scadenza` date DEFAULT NULL,
  `tipo_commessa` int(11) DEFAULT NULL,
  `num_ordine` varchar(13) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `inv_com` bit(1) DEFAULT b'0',
  `stamp_com` bit(1) DEFAULT b'0',
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) DEFAULT NULL,
  PRIMARY KEY (`Id_commessa`,`anno`) USING BTREE,
  UNIQUE KEY `Id` (`Id`),
  KEY `stato_commessa` (`stato_commessa`),
  KEY `anno` (`anno`),
  KEY `id_cliente` (`id_cliente`,`stato_commessa`) USING BTREE,
  KEY `Id_preventivo` (`anno`) USING BTREE,
  KEY `Index_6_ut` (`id_utente`),
  CONSTRAINT `commessa_ibfk_1` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `commessa_ibfk_2` FOREIGN KEY (`stato_commessa`) REFERENCES `stato_commessa` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_commessa_3_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=536 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_articoli
CREATE TABLE IF NOT EXISTS `commessa_articoli` (
  `id_commessa` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL,
  `descrizione` text,
  `quantità` decimal(11,2) DEFAULT NULL,
  `codice_articolo` varchar(16) DEFAULT NULL,
  `codice_fornitore` varchar(40) DEFAULT NULL,
  `UM` varchar(5) DEFAULT NULL,
  `id_tab` int(11) NOT NULL,
  `economia` decimal(11,2) DEFAULT '0.00',
  `id_lotto` int(11) NOT NULL DEFAULT '0',
  `prezzo` decimal(11,2) DEFAULT '0.00',
  `costo` decimal(11,2) DEFAULT '0.00',
  `costo_ora` decimal(11,2) DEFAULT '0.00',
  `tempo` int(11) DEFAULT '0',
  `sconto` decimal(11,2) DEFAULT '0.00',
  `prezzo_ora` decimal(11,2) DEFAULT '0.00',
  `preventivati` decimal(11,2) DEFAULT '0.00',
  `portati` decimal(11,2) DEFAULT '0.00',
  `Lunghezza` int(11) DEFAULT NULL,
  `iva` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_commessa`,`anno`,`id_lotto`,`id_tab`,`id_sottocommessa`) USING BTREE,
  KEY `ar` (`codice_articolo`),
  KEY `lotto_fk` (`id_lotto`,`id_commessa`,`anno`,`id_sottocommessa`) USING BTREE,
  KEY `com` (`id_commessa`,`anno`,`id_tab`,`id_lotto`,`id_sottocommessa`),
  KEY `PK_commessa_articoli_lotto` (`id_commessa`,`anno`,`id_sottocommessa`,`id_lotto`),
  CONSTRAINT `ar` FOREIGN KEY (`codice_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `comme` FOREIGN KEY (`id_lotto`, `id_commessa`, `anno`) REFERENCES `commessa_lotto` (`id_lotto`, `id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `PK_commessa_articoli_lotto` FOREIGN KEY (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`) REFERENCES `commessa_lotto` (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_articoli_storico
CREATE TABLE IF NOT EXISTS `commessa_articoli_storico` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `id_commessa` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL,
  `descrizione` text,
  `quantità` decimal(11,2) DEFAULT NULL,
  `codice_articolo` varchar(16) DEFAULT NULL,
  `codice_fornitore` varchar(40) DEFAULT NULL,
  `UM` varchar(5) DEFAULT NULL,
  `id_tab` int(11) NOT NULL,
  `economia` decimal(11,2) DEFAULT '0.00',
  `id_lotto` int(11) NOT NULL DEFAULT '0',
  `prezzo` decimal(11,2) DEFAULT '0.00',
  `costo` decimal(11,2) DEFAULT '0.00',
  `costo_ora` decimal(11,2) DEFAULT '0.00',
  `tempo` int(11) DEFAULT '0',
  `sconto` decimal(11,2) DEFAULT '0.00',
  `prezzo_ora` decimal(11,2) DEFAULT '0.00',
  `preventivati` decimal(11,2) DEFAULT '0.00',
  `portati` decimal(11,2) DEFAULT '0.00',
  `Lunghezza` int(11) DEFAULT NULL,
  `iva` int(11) DEFAULT NULL,
  `id_utente` int(11) NOT NULL,
  `timestamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  KEY `FK__commessa_articoli_storico__articolo` (`codice_articolo`),
  KEY `FK__commessa_articoli_storico__commessa_articoli` (`id_commessa`,`anno`,`id_sottocommessa`,`id_lotto`,`id_tab`),
  CONSTRAINT `FK__commessa_articoli_storico__articolo` FOREIGN KEY (`codice_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK__commessa_articoli_storico__commessa_articoli` FOREIGN KEY (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`, `id_tab`) REFERENCES `commessa_articoli` (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`, `id_tab`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=100 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_articolo_comp
CREATE TABLE IF NOT EXISTS `commessa_articolo_comp` (
  `id_forfait` int(11) NOT NULL,
  `id_dettaglio` int(11) NOT NULL,
  `id_commessa` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL DEFAULT '1',
  `anno` int(11) NOT NULL,
  `lotto` int(11) NOT NULL,
  PRIMARY KEY (`id_forfait`,`id_dettaglio`,`anno`,`id_commessa`,`lotto`,`id_sottocommessa`) USING BTREE,
  KEY `com_lot` (`lotto`,`id_commessa`,`anno`),
  KEY `forf` (`id_forfait`,`id_commessa`,`anno`,`lotto`),
  KEY `forf<` (`id_commessa`,`anno`,`id_forfait`),
  KEY `det` (`id_commessa`,`anno`,`id_dettaglio`,`lotto`),
  CONSTRAINT `commm` FOREIGN KEY (`id_commessa`, `anno`) REFERENCES `commessa` (`Id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `com_lot` FOREIGN KEY (`lotto`, `id_commessa`, `anno`) REFERENCES `commessa_lotto` (`id_lotto`, `id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `det` FOREIGN KEY (`id_commessa`, `anno`, `id_dettaglio`, `lotto`) REFERENCES `commessa_articoli` (`id_commessa`, `anno`, `id_tab`, `id_lotto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_ddt
CREATE TABLE IF NOT EXISTS `commessa_ddt` (
  `Id_commessa` int(11) NOT NULL,
  `Id_ddt` int(11) NOT NULL,
  `Anno_ddt` int(11) NOT NULL,
  `anno_commessa` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL,
  `id_lotto` int(11) NOT NULL,
  PRIMARY KEY (`Id_commessa`,`Id_ddt`,`Anno_ddt`,`anno_commessa`,`id_lotto`,`id_sottocommessa`) USING BTREE,
  KEY `Anno_ddt` (`Anno_ddt`),
  KEY `Id_ddt` (`Id_ddt`),
  KEY `artddt` (`Id_ddt`,`Anno_ddt`),
  KEY `anno_commessa` (`anno_commessa`,`Id_commessa`) USING BTREE,
  KEY `artcomme` (`Id_commessa`,`anno_commessa`,`id_lotto`),
  KEY `ibfk_commessa_ddt_commessa` (`id_lotto`,`Id_commessa`,`anno_commessa`,`id_sottocommessa`),
  KEY `FK_commessa_ddt_commessa_lotto` (`Id_commessa`,`anno_commessa`,`id_sottocommessa`,`id_lotto`),
  CONSTRAINT `commessa_ddt_ibfk_1` FOREIGN KEY (`id_lotto`, `Id_commessa`, `anno_commessa`) REFERENCES `commessa_lotto` (`id_lotto`, `id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `commessa_ddt_ibfk_2` FOREIGN KEY (`Id_ddt`, `Anno_ddt`) REFERENCES `ddt` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_commessa_ddt_commessa_lotto` FOREIGN KEY (`Id_commessa`, `anno_commessa`, `id_sottocommessa`, `id_lotto`) REFERENCES `commessa_lotto` (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_ddtr
CREATE TABLE IF NOT EXISTS `commessa_ddtr` (
  `id_commessa` int(11) NOT NULL,
  `anno_commessa` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL,
  `id_lotto` int(11) NOT NULL,
  `id_ddtr` int(11) NOT NULL,
  `anno_ddtr` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  `quantita` decimal(11,2) NOT NULL,
  KEY `FK_commessa_ddtr_2_ddtr` (`id_ddtr`,`anno_ddtr`),
  KEY `FK_commessa_ddtr_1_commessa` (`id_lotto`,`id_commessa`,`anno_commessa`,`id_sottocommessa`),
  KEY `FK_commessa_ddtr_commessa_lotto` (`id_commessa`,`anno_commessa`,`id_sottocommessa`,`id_lotto`),
  CONSTRAINT `FK_commessa_ddtr_2_ddtr` FOREIGN KEY (`id_ddtr`, `anno_ddtr`) REFERENCES `ddt_ricevuti` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_commessa_ddtr_commessa_lotto` FOREIGN KEY (`id_commessa`, `anno_commessa`, `id_sottocommessa`, `id_lotto`) REFERENCES `commessa_lotto` (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_fattura
CREATE TABLE IF NOT EXISTS `commessa_fattura` (
  `Id_commessa` int(11) NOT NULL,
  `Id_fattura` int(11) NOT NULL,
  `anno_fattura` int(11) NOT NULL,
  `anno_commessa` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL,
  `id_lotto` int(11) NOT NULL,
  `tipo` int(11) NOT NULL,
  PRIMARY KEY (`anno_fattura`,`Id_fattura`,`Id_commessa`,`anno_commessa`,`id_sottocommessa`,`id_lotto`),
  KEY `com` (`Id_commessa`,`anno_commessa`),
  KEY `fatt` (`Id_fattura`,`anno_fattura`),
  KEY `lottt` (`id_lotto`,`Id_commessa`,`anno_commessa`),
  KEY `FK_commessa_fattura_commessa_lotto` (`Id_commessa`,`anno_commessa`,`id_sottocommessa`,`id_lotto`),
  CONSTRAINT `comm` FOREIGN KEY (`Id_commessa`, `anno_commessa`) REFERENCES `commessa` (`Id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fattt` FOREIGN KEY (`Id_fattura`, `anno_fattura`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_commessa_fattura_commessa_lotto` FOREIGN KEY (`Id_commessa`, `anno_commessa`, `id_sottocommessa`, `id_lotto`) REFERENCES `commessa_lotto` (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_impostazioni
CREATE TABLE IF NOT EXISTS `commessa_impostazioni` (
  `id_commessa` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `tipo` varchar(30) NOT NULL,
  `valore` tinyint(4) DEFAULT NULL,
  PRIMARY KEY (`id_commessa`,`anno`,`tipo`) USING BTREE,
  CONSTRAINT `FK_commessa_impostazioni_1` FOREIGN KEY (`id_commessa`, `anno`) REFERENCES `commessa` (`Id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_impostazioni_default
CREATE TABLE IF NOT EXISTS `commessa_impostazioni_default` (
  `tipo` varchar(40) NOT NULL,
  `valore` tinyint(4) NOT NULL,
  PRIMARY KEY (`tipo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_lista
CREATE TABLE IF NOT EXISTS `commessa_lista` (
  `id_commessa` int(11) NOT NULL,
  `id_lista` int(11) NOT NULL,
  `anno_lista` int(11) NOT NULL,
  `anno_commessa` int(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_lotto
CREATE TABLE IF NOT EXISTS `commessa_lotto` (
  `id_lotto` int(11) NOT NULL,
  `id_commessa` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  `impianto` int(11) DEFAULT NULL,
  `numero` varchar(10) DEFAULT NULL,
  `codice` varchar(10) DEFAULT NULL,
  `data_inizio` date DEFAULT NULL,
  `data_fine` date DEFAULT NULL,
  `scadenza` date DEFAULT NULL,
  `stato` int(11) DEFAULT NULL,
  `nota` text,
  `csora` decimal(11,2) DEFAULT '0.00',
  `prora` decimal(11,2) DEFAULT '0.00',
  `sc` decimal(11,2) DEFAULT '0.00',
  PRIMARY KEY (`id_commessa`,`anno`,`id_sottocommessa`,`id_lotto`),
  KEY `sottocommessa` (`id_sottocommessa`,`id_commessa`,`anno`),
  KEY `detta` (`id_lotto`,`id_commessa`,`anno`),
  KEY `commessa` (`id_commessa`,`anno`),
  CONSTRAINT `sottocommessa` FOREIGN KEY (`id_sottocommessa`, `id_commessa`, `anno`) REFERENCES `commessa_sotto` (`id_sotto`, `id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_note
CREATE TABLE IF NOT EXISTS `commessa_note` (
  `id_commessa` int(11) NOT NULL,
  `descrizione` varchar(45) NOT NULL,
  `nota` text NOT NULL,
  `anno` int(11) NOT NULL,
  PRIMARY KEY (`id_commessa`,`anno`,`descrizione`),
  CONSTRAINT `com_1` FOREIGN KEY (`id_commessa`, `anno`) REFERENCES `commessa` (`Id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_preventivo
CREATE TABLE IF NOT EXISTS `commessa_preventivo` (
  `id_commessa` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL,
  `preventivo` int(11) NOT NULL,
  `anno_prev` int(11) NOT NULL,
  `rev` int(11) NOT NULL,
  `lotto` int(11) NOT NULL,
  `Pidlotto` int(10) NOT NULL,
  `preventivo_prezzo_materiale` decimal(11,2) NOT NULL,
  `preventivo_costo_materiale` decimal(11,2) NOT NULL,
  `preventivo_prezzo_lavoro` decimal(11,2) NOT NULL,
  `preventivo_costo_lavoro` decimal(11,2) NOT NULL,
  `preventivo_totale_ore` decimal(11,2) NOT NULL,
  `preventivo_sconto` decimal(11,2) NOT NULL,
  PRIMARY KEY (`id_commessa`,`anno`,`preventivo`,`anno_prev`,`lotto`,`Pidlotto`,`id_sottocommessa`) USING BTREE,
  KEY `com` (`id_commessa`,`anno`) USING BTREE,
  KEY `compre` (`lotto`,`id_commessa`,`anno`),
  KEY `pr` (`preventivo`,`anno_prev`,`lotto`,`rev`),
  KEY `preve` (`preventivo`,`anno`,`Pidlotto`,`rev`) USING BTREE,
  KEY `pr1` (`preventivo`,`anno_prev`,`Pidlotto`,`rev`),
  KEY `FK_commessa_preventivo_commessa_lotto` (`id_commessa`,`anno`,`id_sottocommessa`,`lotto`),
  CONSTRAINT `FK_commessa_preventivo_commessa_lotto` FOREIGN KEY (`id_commessa`, `anno`, `id_sottocommessa`, `lotto`) REFERENCES `commessa_lotto` (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `pr1` FOREIGN KEY (`preventivo`, `anno_prev`, `Pidlotto`, `rev`) REFERENCES `preventivo_lotto` (`id_preventivo`, `anno`, `posizione`, `id_revisione`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_rapporto
CREATE TABLE IF NOT EXISTS `commessa_rapporto` (
  `id_commessa` int(11) NOT NULL,
  `id_rapporto` bigint(20) NOT NULL,
  `anno_rapporto` int(11) NOT NULL,
  `anno_commessa` int(11) NOT NULL,
  `id_sottocommessa` int(11) NOT NULL,
  `id_lotto` int(11) NOT NULL,
  PRIMARY KEY (`anno_rapporto`,`id_rapporto`,`id_commessa`,`anno_commessa`,`id_lotto`,`id_sottocommessa`),
  KEY `rap` (`id_rapporto`,`anno_rapporto`),
  KEY `lot` (`id_commessa`,`anno_commessa`,`id_sottocommessa`,`id_lotto`),
  CONSTRAINT `FK_commessa_rapporto_commessa_lotto` FOREIGN KEY (`id_commessa`, `anno_commessa`, `id_sottocommessa`, `id_lotto`) REFERENCES `commessa_lotto` (`id_commessa`, `anno`, `id_sottocommessa`, `id_lotto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `rap` FOREIGN KEY (`id_rapporto`, `anno_rapporto`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_riferimento
CREATE TABLE IF NOT EXISTS `commessa_riferimento` (
  `id_commessa` int(10) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_riferimento` int(11) NOT NULL,
  `id_cliente` int(11) NOT NULL,
  PRIMARY KEY (`id_commessa`,`anno`,`id_riferimento`,`id_cliente`) USING BTREE,
  KEY `FK_commessa_riferimento_2` (`id_cliente`,`id_riferimento`),
  CONSTRAINT `FK_commessa_riferimento_1` FOREIGN KEY (`id_commessa`, `anno`) REFERENCES `commessa` (`Id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_commessa_riferimento_2` FOREIGN KEY (`id_cliente`, `id_riferimento`) REFERENCES `riferimento_clienti` (`Id_cliente`, `Id_riferimento`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.commessa_sotto
CREATE TABLE IF NOT EXISTS `commessa_sotto` (
  `id_sotto` int(11) NOT NULL,
  `id_commessa` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `destinazione` int(11) DEFAULT NULL,
  `descrizione` text,
  `scadenza` date DEFAULT NULL,
  `inizio` date DEFAULT NULL,
  `fine` date DEFAULT NULL,
  `numero` varchar(10) DEFAULT NULL,
  `codice` varchar(10) DEFAULT NULL,
  `stato` int(11) NOT NULL DEFAULT '1',
  `nome` varchar(60) DEFAULT NULL,
  PRIMARY KEY (`id_sotto`,`id_commessa`,`anno`),
  KEY `com` (`id_commessa`,`anno`),
  CONSTRAINT `com` FOREIGN KEY (`id_commessa`, `anno`) REFERENCES `commessa` (`Id_commessa`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.comune
CREATE TABLE IF NOT EXISTS `comune` (
  `Id_comune` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `provincia` varchar(15) NOT NULL,
  `cap` varchar(10) NOT NULL,
  `id_provincia` int(11) NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`Id_comune`),
  UNIQUE KEY `Index_4_comune` (`Nome`,`cap`),
  KEY `id_provincia` (`provincia`),
  KEY `FK_comune_1_pro` (`provincia`,`id_provincia`),
  CONSTRAINT `FK_comune_1_pro` FOREIGN KEY (`provincia`, `id_provincia`) REFERENCES `province` (`Sigla`, `id_provincia`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=9180 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.condizione_pagamento
CREATE TABLE IF NOT EXISTS `condizione_pagamento` (
  `Id_condizione` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) DEFAULT NULL,
  `Descrizione` varchar(20) DEFAULT NULL,
  `tipo` int(11) NOT NULL,
  `mesi` int(10) unsigned NOT NULL DEFAULT '0',
  `pagato` bit(1) NOT NULL DEFAULT b'0',
  `temporanea` bit(1) NOT NULL DEFAULT b'0',
  `modalitaPA` varchar(5) DEFAULT NULL,
  `condizioniPA` varchar(5) DEFAULT NULL,
  `Chiusura_alla_scadenza` bit(1) NOT NULL DEFAULT b'0',
  `Id_utente` smallint(6) NOT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id_condizione`),
  UNIQUE KEY `Nome` (`Nome`),
  KEY `tipo` (`tipo`),
  CONSTRAINT `t_cond` FOREIGN KEY (`tipo`) REFERENCES `tipo_pagamento` (`id_Tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=155 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.condizioni_giorno
CREATE TABLE IF NOT EXISTS `condizioni_giorno` (
  `id_condizione` int(11) NOT NULL,
  `mesi` int(11) NOT NULL,
  `giorni` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_condizione`,`mesi`),
  KEY `mesi` (`mesi`),
  CONSTRAINT `condizioni_giorno_ibfk_1` FOREIGN KEY (`id_condizione`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.configurazione_loghi
CREATE TABLE IF NOT EXISTS `configurazione_loghi` (
  `nome` varchar(30) NOT NULL,
  `attivo` tinyint(4) NOT NULL DEFAULT '1',
  `tipo` varchar(45) NOT NULL,
  PRIMARY KEY (`nome`,`tipo`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.configurazione_mail
CREATE TABLE IF NOT EXISTS `configurazione_mail` (
  `id_conf` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(45) NOT NULL,
  `time_polling` int(10) unsigned NOT NULL,
  `numero_pacchetti` int(10) unsigned NOT NULL,
  `smtp` varchar(45) NOT NULL,
  `porta` varchar(45) NOT NULL,
  `ssl` varchar(45) NOT NULL,
  `nome_utente` varchar(45) NOT NULL,
  `password` varchar(45) NOT NULL,
  `nome_mail` varchar(45) NOT NULL,
  `tempo_pausa` int(11) NOT NULL,
  PRIMARY KEY (`id_conf`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.configurazione_percorsi
CREATE TABLE IF NOT EXISTS `configurazione_percorsi` (
  `Percorso` varchar(300) NOT NULL,
  `Tipo_percorso` varchar(50) NOT NULL,
  PRIMARY KEY (`Percorso`,`Tipo_percorso`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.configurazione_resoconto
CREATE TABLE IF NOT EXISTS `configurazione_resoconto` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `abbonamento` int(11) NOT NULL,
  `impianto` int(11) NOT NULL,
  `ticket` int(11) NOT NULL,
  `titolo` text NOT NULL,
  `testo` text NOT NULL,
  `ordine` text NOT NULL,
  `lavorazione` int(11) NOT NULL,
  `mail` text NOT NULL,
  `spese` tinyint(4) DEFAULT NULL,
  `stampa_desc_estesa` bit(1) NOT NULL DEFAULT b'0',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.configurazione_trigger
CREATE TABLE IF NOT EXISTS `configurazione_trigger` (
  `itrigger` varchar(50) NOT NULL,
  `value` varchar(5) NOT NULL,
  PRIMARY KEY (`itrigger`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto
CREATE TABLE IF NOT EXISTS `contratto` (
  `id_contratto` int(11) NOT NULL AUTO_INCREMENT,
  `id_cliente` int(11) NOT NULL,
  `pagamento` int(11) DEFAULT NULL,
  `varie` text,
  `data_inserimento` date DEFAULT NULL,
  `data_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `data` date DEFAULT NULL,
  `stato` int(11) NOT NULL,
  `signor` varchar(100) DEFAULT NULL,
  `qualifica` varchar(100) DEFAULT NULL,
  `tipo_contratto` int(11) NOT NULL,
  `tipo_stampa` int(11) NOT NULL DEFAULT '2',
  `id_destinazione` int(11) DEFAULT NULL,
  `telefono` varchar(11) DEFAULT NULL,
  `iban` varchar(27) DEFAULT NULL,
  `id_preventivo` int(11) DEFAULT NULL,
  `id_revisione` int(11) DEFAULT NULL,
  `anno` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_contratto`),
  KEY `FK_contratto_1_tipo` (`tipo_contratto`),
  KEY `FK_contratto_2_des` (`id_cliente`,`id_destinazione`),
  KEY `FK_contratto_3_pag` (`pagamento`),
  KEY `FK_contratto_4_sta` (`stato`),
  KEY `FK_contratto_5_pre` (`id_revisione`,`id_preventivo`,`anno`),
  KEY `FK_contratto_tipo_stampa` (`tipo_stampa`),
  CONSTRAINT `FK_contratto_1_tipo` FOREIGN KEY (`tipo_contratto`) REFERENCES `tipo_contratto` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_2_des` FOREIGN KEY (`id_cliente`, `id_destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_3_pag` FOREIGN KEY (`pagamento`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_4_sta` FOREIGN KEY (`stato`) REFERENCES `stato_contratto` (`id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_5_pre` FOREIGN KEY (`id_revisione`, `id_preventivo`, `anno`) REFERENCES `revisione_preventivo` (`Id_revisione`, `Id_preventivo`, `Anno`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_tipo_stampa` FOREIGN KEY (`tipo_stampa`) REFERENCES `tipo_contratto_stampa` (`id_tipo_stampa`) ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=44 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto_fornitura
CREATE TABLE IF NOT EXISTS `contratto_fornitura` (
  `id_fornitura` int(11) NOT NULL AUTO_INCREMENT,
  `id_contratto` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  `id_impianto` int(11) DEFAULT NULL,
  `oneri` decimal(11,2) NOT NULL DEFAULT '0.00',
  PRIMARY KEY (`id_fornitura`,`id_contratto`),
  KEY `FK_contratto_fornitura_1_cont` (`id_contratto`),
  CONSTRAINT `FK_contratto_fornitura_1_cont` FOREIGN KEY (`id_contratto`) REFERENCES `contratto` (`id_contratto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto_impianto
CREATE TABLE IF NOT EXISTS `contratto_impianto` (
  `id_impianto` int(11) NOT NULL,
  `id_cliente` int(11) NOT NULL,
  `id_destinazione` int(11) NOT NULL,
  `tipo_impianto` int(11) NOT NULL,
  `id_abbonamento` int(11) DEFAULT NULL,
  `id_contratto` int(11) NOT NULL,
  `abbuono` decimal(11,2) NOT NULL DEFAULT '0.00',
  PRIMARY KEY (`id_impianto`,`id_contratto`) USING BTREE,
  KEY `FK_contratto_impianto_3_des` (`id_cliente`,`id_destinazione`),
  KEY `FK_contratto_impianto_4con` (`id_contratto`),
  CONSTRAINT `FK_contratto_impianto_1_imp` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_impianto_3_cli` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_impianto_3_des` FOREIGN KEY (`id_cliente`, `id_destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_impianto_4con` FOREIGN KEY (`id_contratto`) REFERENCES `contratto` (`id_contratto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto_impianto_mese
CREATE TABLE IF NOT EXISTS `contratto_impianto_mese` (
  `id_contratto` int(11) NOT NULL,
  `id_impianto` int(11) NOT NULL,
  `id_mese` int(11) NOT NULL,
  PRIMARY KEY (`id_contratto`,`id_impianto`,`id_mese`),
  KEY `FK_contratto_impianto_mese_1_cont` (`id_impianto`,`id_contratto`),
  KEY `FK_contratto_impianto_mese_2_mese` (`id_mese`),
  CONSTRAINT `FK_contratto_impianto_mese_1_cont` FOREIGN KEY (`id_impianto`, `id_contratto`) REFERENCES `contratto_impianto` (`id_impianto`, `id_contratto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_impianto_mese_2_mese` FOREIGN KEY (`id_mese`) REFERENCES `mese` (`Id_mese`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto_materiale
CREATE TABLE IF NOT EXISTS `contratto_materiale` (
  `id_fornitura` int(11) NOT NULL,
  `id_articolo` varchar(15) DEFAULT NULL,
  `quantita` double(11,2) DEFAULT NULL,
  `sconto` double(11,2) DEFAULT NULL,
  `descrizione` text NOT NULL,
  `codice_fornitore` varchar(22) DEFAULT NULL,
  `id_contratto` int(11) NOT NULL,
  `prezzo` decimal(11,2) DEFAULT NULL,
  `id_tab` int(11) NOT NULL,
  PRIMARY KEY (`id_fornitura`,`id_contratto`,`id_tab`) USING BTREE,
  KEY `FK_contratto_materiale_1` (`id_articolo`),
  CONSTRAINT `FK_contratto_materiale_1` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_contratto_materiale_2_forn` FOREIGN KEY (`id_fornitura`, `id_contratto`) REFERENCES `contratto_fornitura` (`id_fornitura`, `id_contratto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto_modello_paragrafo
CREATE TABLE IF NOT EXISTS `contratto_modello_paragrafo` (
  `id_paragrafo` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  `descrizione` text,
  `id_tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_paragrafo`,`id_tipo`) USING BTREE,
  KEY `FK_contratto_modello_paragrafo_1_tipo` (`id_tipo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto_modello_subparagrafo
CREATE TABLE IF NOT EXISTS `contratto_modello_subparagrafo` (
  `id_subparagrafo` int(11) NOT NULL,
  `id_paragrafo` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  `descrizione` text,
  `id_tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_subparagrafo`,`id_paragrafo`,`id_tipo`) USING BTREE,
  KEY `FK_contratto_modello_subparagrafo_2_tipo` (`id_tipo`),
  KEY `FK_contratto_modello_subparagrafo_1_par` (`id_paragrafo`,`id_tipo`),
  CONSTRAINT `FK_contratto_modello_subparagrafo_1_par` FOREIGN KEY (`id_paragrafo`, `id_tipo`) REFERENCES `contratto_modello_paragrafo` (`id_paragrafo`, `id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto_paragrafo
CREATE TABLE IF NOT EXISTS `contratto_paragrafo` (
  `id_paragrafo` int(11) NOT NULL,
  `id_contratto` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  `descrizione` text,
  `id_tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_paragrafo`,`id_contratto`,`id_tipo`) USING BTREE,
  KEY `FK_contratto_paragrafo_1_cont` (`id_contratto`),
  CONSTRAINT `FK_contratto_paragrafo_1_cont` FOREIGN KEY (`id_contratto`) REFERENCES `contratto` (`id_contratto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.contratto_subparagrafo
CREATE TABLE IF NOT EXISTS `contratto_subparagrafo` (
  `id_subparagrafo` int(11) NOT NULL,
  `id_paragrafo` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  `descrizione` text,
  `id_contratto` int(11) NOT NULL,
  `id_tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_subparagrafo`,`id_paragrafo`,`id_contratto`,`id_tipo`) USING BTREE,
  KEY `FK_contratto_subparagrafo_1_per` (`id_paragrafo`,`id_contratto`,`id_tipo`),
  CONSTRAINT `FK_contratto_subparagrafo_1_per` FOREIGN KEY (`id_paragrafo`, `id_contratto`, `id_tipo`) REFERENCES `contratto_paragrafo` (`id_paragrafo`, `id_contratto`, `id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.corso
CREATE TABLE IF NOT EXISTS `corso` (
  `id_corso` int(11) NOT NULL AUTO_INCREMENT,
  `descrizione` varchar(145) NOT NULL,
  `costo` double DEFAULT NULL,
  `richiede_verifica` bit(1) NOT NULL DEFAULT b'0',
  `verificato` bit(1) NOT NULL DEFAULT b'0',
  `id_tipo` int(11) NOT NULL,
  `durata` int(11) DEFAULT NULL,
  `nota` mediumtext,
  `relatore` varchar(45) DEFAULT NULL,
  `argomenti` mediumtext NOT NULL,
  `data_inizio` date NOT NULL,
  `data_fine` date NOT NULL,
  `ora_inizio` time NOT NULL,
  `ora_fine` time NOT NULL,
  `tipo_evento` int(11) NOT NULL DEFAULT '9',
  `stato` tinyint(4) NOT NULL DEFAULT '1',
  `id_evento_gruppo` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_corso`),
  KEY `Index_2_tipo` (`id_tipo`),
  KEY `FK_corso_evento_gruppo` (`id_evento_gruppo`),
  CONSTRAINT `FK_corso_1_tipo` FOREIGN KEY (`id_tipo`) REFERENCES `tipo_corso` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_corso_evento_gruppo` FOREIGN KEY (`id_evento_gruppo`) REFERENCES `evento_gruppo` (`Id`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.dati_personali
CREATE TABLE IF NOT EXISTS `dati_personali` (
  `id_paragrafo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(100) NOT NULL,
  `descrizione` text NOT NULL,
  PRIMARY KEY (`id_paragrafo`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ddt
CREATE TABLE IF NOT EXISTS `ddt` (
  `Id_ddt` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_cliente` int(11) DEFAULT NULL,
  `id_fornitore` int(11) DEFAULT NULL,
  `Id_destinazione` int(11) DEFAULT NULL,
  `condizione_pagamento` int(11) DEFAULT NULL,
  `Porto_resa` int(11) DEFAULT NULL,
  `data_documento` date DEFAULT NULL,
  `Vettore` int(11) DEFAULT NULL,
  `data_ora_ritiro` datetime DEFAULT NULL,
  `data_ora_inizio` datetime DEFAULT NULL,
  `trasport_a_cura` int(11) NOT NULL DEFAULT '1',
  `Causale` varchar(8) DEFAULT NULL,
  `Fattura` int(11) DEFAULT NULL,
  `Anno_fattura` int(11) DEFAULT NULL,
  `colli` int(11) DEFAULT NULL,
  `Peso` float(11,4) DEFAULT NULL,
  `Nota` text,
  `Descrizione` text,
  `id_principale` int(11) DEFAULT NULL,
  `impianto` int(11) DEFAULT NULL,
  `STAMPA` int(11) unsigned NOT NULL DEFAULT '0',
  `destinazione_forn` int(11) DEFAULT NULL,
  `principale_forn` int(11) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `data_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `stampa_ora` tinyint(4) DEFAULT NULL,
  `stampa_data_ora_ritiro` bit(1) DEFAULT NULL,
  `fatturaf` int(11) DEFAULT NULL,
  `anno_fatturaf` int(11) DEFAULT NULL,
  `stato` int(11) NOT NULL DEFAULT '1',
  `filename_firma_destinatario` varchar(50) DEFAULT NULL,
  `filename_firma_conducente` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`Id_ddt`,`anno`),
  KEY `condizione_pagamento` (`condizione_pagamento`),
  KEY `id_cliente` (`id_cliente`),
  KEY `Vettore` (`Vettore`),
  KEY `Causale` (`Causale`),
  KEY `Fattura` (`Fattura`),
  KEY `Id_desti` (`Id_destinazione`),
  KEY `Porto_resa` (`Porto_resa`),
  KEY `trasport_a_cura` (`trasport_a_cura`),
  KEY `anno` (`anno`),
  KEY `id_fornitore` (`id_fornitore`),
  KEY `fattur` (`Fattura`,`Anno_fattura`),
  KEY `destinazione` (`id_cliente`,`Id_destinazione`),
  KEY `princiaple` (`id_cliente`,`id_principale`),
  KEY `dest_FORN` (`id_fornitore`,`destinazione_forn`),
  KEY `princ_forn` (`id_fornitore`,`principale_forn`),
  KEY `Index_17_ut` (`id_utente`),
  KEY `stato` (`stato`),
  CONSTRAINT `ddt_ibfk_1` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_ibfk_10` FOREIGN KEY (`Vettore`) REFERENCES `vettore` (`Id_vettore`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `ddt_ibfk_12` FOREIGN KEY (`Porto_resa`) REFERENCES `porto_resa` (`Id_porto_resa`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_ibfk_13` FOREIGN KEY (`trasport_a_cura`) REFERENCES `trasporto_cura` (`Id_trasporto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_ibfk_8` FOREIGN KEY (`Causale`) REFERENCES `causale_trasporto` (`Id_causale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_ibfk_9` FOREIGN KEY (`condizione_pagamento`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `destinazione` FOREIGN KEY (`id_cliente`, `Id_destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `dest_FORN` FOREIGN KEY (`id_fornitore`, `destinazione_forn`) REFERENCES `destinazione_fornitore` (`id_fornitore`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fattur` FOREIGN KEY (`Fattura`, `Anno_fattura`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_ddt_12_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ddt_stato_ddt` FOREIGN KEY (`stato`) REFERENCES `stato_ddt` (`Id_stato`) ON UPDATE CASCADE,
  CONSTRAINT `princiaple` FOREIGN KEY (`id_cliente`, `id_principale`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `princ_forn` FOREIGN KEY (`id_fornitore`, `principale_forn`) REFERENCES `destinazione_fornitore` (`id_fornitore`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ddt_aspetto
CREATE TABLE IF NOT EXISTS `ddt_aspetto` (
  `Id_ddt` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `vista` varchar(3) NOT NULL,
  PRIMARY KEY (`Id_ddt`,`anno`,`vista`),
  KEY `anno` (`anno`),
  KEY `vista` (`vista`),
  KEY `ddt_aspetto_ibfk_3` (`anno`,`Id_ddt`),
  CONSTRAINT `ddt_aspetto_ibfk_4` FOREIGN KEY (`vista`) REFERENCES `aspetto` (`Id_aspetto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ddt_aspetto_3` FOREIGN KEY (`Id_ddt`, `anno`) REFERENCES `ddt` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ddt_impostazioni
CREATE TABLE IF NOT EXISTS `ddt_impostazioni` (
  `impostazione` varchar(20) NOT NULL,
  `valore` varchar(150) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ddt_rapporto
CREATE TABLE IF NOT EXISTS `ddt_rapporto` (
  `Id_ddt` int(11) NOT NULL,
  `id_rapporto` bigint(11) NOT NULL,
  `anno_ddt` int(11) NOT NULL,
  `anno_rapporto` int(11) NOT NULL,
  PRIMARY KEY (`Id_ddt`,`id_rapporto`,`anno_ddt`,`anno_rapporto`),
  KEY `anno_ddt` (`anno_ddt`),
  KEY `anno_rapporto` (`anno_rapporto`),
  KEY `id_rapporto` (`id_rapporto`),
  KEY `ddt_rapporto_ibfk_4` (`id_rapporto`,`anno_rapporto`),
  KEY `ddt_rapporto_ibfk_1` (`Id_ddt`,`anno_ddt`),
  CONSTRAINT `ddt_rapporto_ibfk_1` FOREIGN KEY (`Id_ddt`, `anno_ddt`) REFERENCES `ddt` (`Id_ddt`, `anno`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_rapporto_ibfk_4` FOREIGN KEY (`id_rapporto`, `anno_rapporto`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ddt_ricevuti
CREATE TABLE IF NOT EXISTS `ddt_ricevuti` (
  `Id_ddt` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_cliente` int(11) DEFAULT NULL,
  `id_fornitore` int(11) DEFAULT NULL,
  `Id_destinazione` int(11) DEFAULT NULL,
  `condizione_pagamento` int(11) DEFAULT NULL,
  `Porto_resa` int(11) DEFAULT NULL,
  `data_documento` date DEFAULT NULL,
  `Vettore` int(11) DEFAULT NULL,
  `data_ora_ritiro` datetime DEFAULT NULL,
  `data_ora_inizio` datetime DEFAULT NULL,
  `trasport_a_cura` int(11) NOT NULL DEFAULT '1',
  `Causale` varchar(8) DEFAULT NULL,
  `Fattura` int(11) DEFAULT NULL,
  `Anno_fattura` int(11) DEFAULT NULL,
  `colli` int(11) DEFAULT NULL,
  `Peso` float(11,4) DEFAULT NULL,
  `Nota` text,
  `Descrizione` text,
  `id_principale` int(11) DEFAULT NULL,
  `impianto` int(11) DEFAULT NULL,
  `scan` int(11) unsigned NOT NULL DEFAULT '0',
  `destinazione_forn` int(11) DEFAULT NULL,
  `principale_forn` int(11) DEFAULT NULL,
  `numero_ddt` varchar(20) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_ddt`,`anno`),
  KEY `condizione_pagamento` (`condizione_pagamento`),
  KEY `id_cliente` (`id_cliente`),
  KEY `Vettore` (`Vettore`),
  KEY `Causale` (`Causale`),
  KEY `Fattura` (`Fattura`),
  KEY `Id_desti` (`Id_destinazione`),
  KEY `Porto_resa` (`Porto_resa`),
  KEY `trasport_a_cura` (`trasport_a_cura`),
  KEY `anno` (`anno`),
  KEY `id_fornitore` (`id_fornitore`),
  KEY `fattur` (`Fattura`,`Anno_fattura`),
  KEY `destinazione` (`id_cliente`,`Id_destinazione`),
  KEY `princiaple` (`id_cliente`,`id_principale`),
  KEY `dest_FORN` (`id_fornitore`,`destinazione_forn`),
  KEY `princ_forn` (`id_fornitore`,`principale_forn`),
  KEY `Index_17_ut` (`id_utente`),
  CONSTRAINT `ddt_R_ibfk_1` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_R_ibfk_10` FOREIGN KEY (`Vettore`) REFERENCES `vettore` (`Id_vettore`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_R_ibfk_12` FOREIGN KEY (`Porto_resa`) REFERENCES `porto_resa` (`Id_porto_resa`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_R_ibfk_13` FOREIGN KEY (`trasport_a_cura`) REFERENCES `trasporto_cura` (`Id_trasporto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_R_ibfk_8` FOREIGN KEY (`Causale`) REFERENCES `causale_trasporto` (`Id_causale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ddt_R_ibfk_9` FOREIGN KEY (`condizione_pagamento`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `destinazione_R` FOREIGN KEY (`id_cliente`, `Id_destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `dest_FORN_R` FOREIGN KEY (`id_fornitore`, `destinazione_forn`) REFERENCES `destinazione_fornitore` (`id_fornitore`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fattur_R` FOREIGN KEY (`Fattura`, `Anno_fattura`) REFERENCES `fornfattura` (`Id_fattura`, `anno`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_ddt_ricevuti_12_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `princiaple_R` FOREIGN KEY (`id_cliente`, `id_principale`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `princ_forn_R` FOREIGN KEY (`id_fornitore`, `principale_forn`) REFERENCES `destinazione_fornitore` (`id_fornitore`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ddt_ricevuti_aspetto
CREATE TABLE IF NOT EXISTS `ddt_ricevuti_aspetto` (
  `Id_ddt` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `vista` varchar(3) NOT NULL,
  PRIMARY KEY (`Id_ddt`,`anno`,`vista`),
  KEY `anno` (`anno`),
  KEY `vista` (`vista`),
  KEY `ddt_aspetto_ibfk_3` (`anno`,`Id_ddt`),
  CONSTRAINT `ddt_r_aspetto_ibfk_4` FOREIGN KEY (`vista`) REFERENCES `aspetto` (`Id_aspetto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ddt_r_aspetto_3` FOREIGN KEY (`Id_ddt`, `anno`) REFERENCES `ddt_ricevuti` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ddt_ricevuti_emessi
CREATE TABLE IF NOT EXISTS `ddt_ricevuti_emessi` (
  `id_r` int(11) NOT NULL,
  `id_e` int(11) NOT NULL,
  `anno_r` int(11) NOT NULL,
  `anno_e` int(11) NOT NULL,
  `tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_r`,`anno_e`,`id_e`,`anno_r`),
  KEY `Ric` (`id_r`,`anno_r`),
  KEY `eme` (`id_e`,`anno_e`),
  CONSTRAINT `eme` FOREIGN KEY (`id_e`, `anno_e`) REFERENCES `ddt` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `Ric` FOREIGN KEY (`id_r`, `anno_r`) REFERENCES `ddt_ricevuti` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.destinazione_cliente
CREATE TABLE IF NOT EXISTS `destinazione_cliente` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `id_cliente` int(11) NOT NULL,
  `Id_destinazione` int(11) NOT NULL,
  `Provincia` varchar(5) DEFAULT NULL,
  `Comune` int(11) DEFAULT NULL,
  `Frazione` int(11) DEFAULT NULL,
  `Indirizzo` varchar(50) DEFAULT NULL,
  `numero_civico` smallint(6) DEFAULT NULL,
  `Descrizione` varchar(105) NOT NULL,
  `scala` varchar(6) DEFAULT NULL,
  `Altro` varchar(9) DEFAULT NULL,
  `Km_sede` smallint(6) DEFAULT '0',
  `Pedaggio` decimal(11,2) DEFAULT '0.00',
  `Tempo_strada` smallint(6) DEFAULT '0',
  `attivo` bit(1) DEFAULT b'1',
  `ztl` bit(1) NOT NULL DEFAULT b'0',
  `Note` text,
  `Autostrada` bit(1) NOT NULL DEFAULT b'0',
  `Sede_principale` bit(1) NOT NULL DEFAULT b'0',
  `dalle1` time DEFAULT NULL,
  `alle1` time DEFAULT NULL,
  `dalle2` time DEFAULT NULL,
  `alle2` time DEFAULT NULL,
  `piano` tinyint(4) DEFAULT NULL,
  `interno` tinyint(3) unsigned DEFAULT NULL,
  `id_autostrada` int(11) DEFAULT NULL,
  `longitudine` decimal(11,8) NOT NULL DEFAULT '0.00000000',
  `latitudine` decimal(11,8) NOT NULL DEFAULT '0.00000000',
  `Utente_mod` smallint(6) NOT NULL,
  `Utente_ins` smallint(6) NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_cliente`,`Id_destinazione`),
  UNIQUE KEY `nome` (`id_cliente`,`Id_destinazione`,`Descrizione`) USING BTREE,
  UNIQUE KEY `Id` (`Id`),
  KEY `Provincia` (`Provincia`),
  KEY `Comune` (`Comune`,`Frazione`),
  KEY `Id_destinazione` (`Id_destinazione`),
  KEY `princ_uni` (`id_cliente`,`Sede_principale`),
  KEY `FK_destinazione_cliente_2` (`id_autostrada`),
  CONSTRAINT `destinazione_cliente_ibfk_1` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_destinazione_cliente_2` FOREIGN KEY (`id_autostrada`) REFERENCES `tipo_autostrada` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=6947 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.destinazione_fornitore
CREATE TABLE IF NOT EXISTS `destinazione_fornitore` (
  `id_fornitore` int(11) NOT NULL,
  `Id_destinazione` int(11) NOT NULL,
  `Provincia` varchar(5) DEFAULT NULL,
  `Comune` int(11) DEFAULT NULL,
  `Frazione` int(11) DEFAULT NULL,
  `Indirizzo` varchar(50) DEFAULT NULL,
  `numero_civico` int(11) DEFAULT NULL,
  `Descrizione` varchar(50) NOT NULL,
  `scala` int(11) DEFAULT NULL,
  `Altro` varchar(10) DEFAULT NULL,
  `attivo` tinyint(4) DEFAULT '1',
  `Note` text,
  `Sede_principale` int(11) NOT NULL DEFAULT '0',
  `piano` int(10) DEFAULT NULL,
  `interno` int(10) DEFAULT NULL,
  `fcap` varchar(7) DEFAULT NULL,
  `id_autostrada` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_fornitore`,`Id_destinazione`),
  KEY `Provincia` (`Provincia`),
  KEY `Comune` (`Comune`,`Frazione`),
  KEY `Id_destinazione` (`Id_destinazione`),
  KEY `FK_destinazione_fornitore_2` (`id_autostrada`),
  CONSTRAINT `destinazione_fornitore_ibfk_1` FOREIGN KEY (`id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_destinazione_fornitore_2` FOREIGN KEY (`id_autostrada`) REFERENCES `tipo_autostrada` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.destinazione_giorni
CREATE TABLE IF NOT EXISTS `destinazione_giorni` (
  `Id_destinazione` int(11) NOT NULL,
  `Id_giorno` int(11) NOT NULL,
  `Id_cliente` int(11) NOT NULL,
  PRIMARY KEY (`Id_destinazione`,`Id_giorno`,`Id_cliente`),
  KEY `Id_giorno` (`Id_giorno`),
  KEY `Id_cliente` (`Id_cliente`),
  KEY `destinazione_giorni_ibfk_1` (`Id_destinazione`,`Id_cliente`),
  CONSTRAINT `destinazione_giorni_ibfk_1` FOREIGN KEY (`Id_destinazione`, `Id_cliente`) REFERENCES `destinazione_cliente` (`Id_destinazione`, `id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `destinazione_giorni_ibfk_2` FOREIGN KEY (`Id_giorno`) REFERENCES `giorni` (`Id_giorno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.destinazione_riferimento
CREATE TABLE IF NOT EXISTS `destinazione_riferimento` (
  `Id_riferimento` int(11) NOT NULL,
  `Id_Destinazione` int(11) NOT NULL,
  `id_cliente` int(11) NOT NULL,
  PRIMARY KEY (`Id_riferimento`,`Id_Destinazione`,`id_cliente`) USING BTREE,
  KEY `Id_Destinazione` (`Id_Destinazione`),
  KEY `destinazione_riferimento_ibfk_1` (`id_cliente`,`Id_riferimento`),
  KEY `destinazione_riferimento_ibfk_2` (`Id_Destinazione`,`id_cliente`),
  CONSTRAINT `destinazione_riferimento_ibfk_1` FOREIGN KEY (`id_cliente`, `Id_riferimento`) REFERENCES `riferimento_clienti` (`Id_cliente`, `Id_riferimento`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `destinazione_riferimento_ibfk_2` FOREIGN KEY (`Id_Destinazione`, `id_cliente`) REFERENCES `destinazione_cliente` (`Id_destinazione`, `id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.dichiarazione_articoli
CREATE TABLE IF NOT EXISTS `dichiarazione_articoli` (
  `id_dichiarazione` int(10) NOT NULL AUTO_INCREMENT,
  `id_articolo` varchar(11) NOT NULL,
  `descrizione` varchar(50) NOT NULL,
  `quantità` float(4,2) NOT NULL,
  `id_tab` int(11) NOT NULL,
  `note` varchar(50) NOT NULL,
  `id_ddt` int(11) DEFAULT NULL,
  `anno` int(11) DEFAULT NULL,
  `codice_fornitore` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`id_dichiarazione`,`id_tab`),
  CONSTRAINT `dichiarazione` FOREIGN KEY (`id_dichiarazione`) REFERENCES `dichiarazione_conformita` (`id_dichiarazione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.dichiarazione_articoli_normative
CREATE TABLE IF NOT EXISTS `dichiarazione_articoli_normative` (
  `id_dichiarazione` int(10) NOT NULL,
  `id_articolo` int(11) NOT NULL,
  `id_normativa` int(11) NOT NULL,
  PRIMARY KEY (`id_dichiarazione`,`id_articolo`,`id_normativa`) USING BTREE,
  KEY `norme` (`id_normativa`),
  CONSTRAINT `arti` FOREIGN KEY (`id_dichiarazione`, `id_articolo`) REFERENCES `dichiarazione_articoli` (`id_dichiarazione`, `id_tab`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `norme` FOREIGN KEY (`id_normativa`) REFERENCES `normative` (`Id_normativa`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.dichiarazione_conformita
CREATE TABLE IF NOT EXISTS `dichiarazione_conformita` (
  `id_dichiarazione` int(10) NOT NULL AUTO_INCREMENT,
  `destinazione` int(11) NOT NULL,
  `proprietà` varchar(500) NOT NULL,
  `ind` tinyint(4) NOT NULL,
  `civ` tinyint(4) NOT NULL,
  `com` tinyint(4) NOT NULL,
  `altr_usi` tinyint(4) NOT NULL,
  `altr_usi_e` varchar(100) NOT NULL,
  `risp` tinyint(4) NOT NULL,
  `risp_e` varchar(100) NOT NULL,
  `descrizione_impianto` varchar(300) NOT NULL,
  `nuovo` tinyint(4) NOT NULL,
  `trasf` tinyint(4) NOT NULL,
  `ampl` tinyint(4) NOT NULL,
  `man` tinyint(4) NOT NULL,
  `alt` tinyint(4) NOT NULL,
  `altro_nota` varchar(300) NOT NULL,
  `Id_commissionato` int(11) DEFAULT NULL,
  `commissionato` varchar(500) NOT NULL,
  `comune` int(11) DEFAULT NULL,
  `provincia` varchar(3) NOT NULL,
  `via` varchar(100) NOT NULL,
  `n` varchar(8) NOT NULL,
  `scala` varchar(4) DEFAULT NULL,
  `piano` varchar(4) DEFAULT NULL,
  `interno` varchar(4) DEFAULT NULL,
  `id_impianto` int(11) NOT NULL,
  `note` text,
  `tipo_impianto` int(11) NOT NULL,
  `id_cliente` int(11) NOT NULL,
  `risp_prog` tinyint(4) NOT NULL,
  `norm` tinyint(4) NOT NULL,
  `tecnico` varchar(60) DEFAULT NULL,
  `norma` varchar(60) DEFAULT NULL,
  `installato` tinyint(4) NOT NULL,
  `progetto` tinyint(4) NOT NULL,
  `progetto_e` varchar(60) NOT NULL,
  `relazione` tinyint(4) NOT NULL,
  `sche` tinyint(4) NOT NULL,
  `old` tinyint(4) NOT NULL,
  `non_norm` tinyint(4) NOT NULL,
  `facoltativi` text NOT NULL,
  `old_e` varchar(60) NOT NULL,
  `data` date NOT NULL,
  `responsabile` int(11) NOT NULL,
  `dichiarante` int(11) NOT NULL,
  `contr` tinyint(4) NOT NULL,
  `copia` tinyint(3) NOT NULL,
  `copia_e` varchar(90) DEFAULT NULL,
  `schema_e` varchar(100) DEFAULT NULL,
  `Altro` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`id_dichiarazione`)
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.dichiarazione_ddt
CREATE TABLE IF NOT EXISTS `dichiarazione_ddt` (
  `id_ddt` int(11) NOT NULL,
  `id_dichiarazione` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  PRIMARY KEY (`id_ddt`,`id_dichiarazione`,`anno`),
  KEY `ddt` (`id_ddt`,`anno`),
  KEY `dichi` (`id_dichiarazione`),
  CONSTRAINT `ddt` FOREIGN KEY (`id_ddt`, `anno`) REFERENCES `ddt` (`Id_ddt`, `anno`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `dichi` FOREIGN KEY (`id_dichiarazione`) REFERENCES `dichiarazione_conformita` (`id_dichiarazione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.dichiarazione_normative
CREATE TABLE IF NOT EXISTS `dichiarazione_normative` (
  `id_dichiarazione` int(11) NOT NULL AUTO_INCREMENT,
  `id_normativa` int(11) NOT NULL,
  PRIMARY KEY (`id_dichiarazione`,`id_normativa`)
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.documenti_messaggi
CREATE TABLE IF NOT EXISTS `documenti_messaggi` (
  `id_documento` int(11) NOT NULL,
  `id_nota` int(11) NOT NULL,
  PRIMARY KEY (`id_documento`,`id_nota`),
  KEY `no` (`id_nota`),
  CONSTRAINT `doc_i` FOREIGN KEY (`id_documento`) REFERENCES `tipo_documento` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `no` FOREIGN KEY (`id_nota`) REFERENCES `clienti_note` (`Id_nota`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.documento_messaggi_fornitore
CREATE TABLE IF NOT EXISTS `documento_messaggi_fornitore` (
  `id_documento` int(11) NOT NULL,
  `id_nota` int(11) NOT NULL,
  PRIMARY KEY (`id_documento`,`id_nota`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.duvri
CREATE TABLE IF NOT EXISTS `duvri` (
  `id_duvri` int(11) NOT NULL AUTO_INCREMENT,
  `id_azi` int(11) NOT NULL,
  `id_clie` int(11) NOT NULL,
  `data` date NOT NULL,
  `commissionato` varchar(45) DEFAULT NULL,
  `comune` varchar(45) DEFAULT NULL,
  `indirizzo` varchar(45) DEFAULT NULL,
  `numero` varchar(45) DEFAULT NULL,
  `titolare` varchar(45) DEFAULT NULL,
  `settore` varchar(45) DEFAULT NULL,
  `numero_rea` varchar(45) DEFAULT NULL,
  `posizione_inps` varchar(45) DEFAULT NULL,
  `codice_ateco` varchar(45) DEFAULT NULL,
  `posizione_inail` varchar(45) DEFAULT NULL,
  `assicu_rct` varchar(45) DEFAULT NULL,
  `data_consegna` date DEFAULT NULL,
  `nome` varchar(45) DEFAULT NULL,
  `funzione` int(11) DEFAULT NULL,
  `durata` int(11) DEFAULT NULL,
  `importo` float DEFAULT NULL,
  `lavori` text,
  `fornitura` text,
  `servizi` text,
  `id_commessa` int(11) DEFAULT NULL,
  `rev` int(11) DEFAULT '0',
  `anno` int(11) DEFAULT NULL,
  `locale` varchar(45) DEFAULT NULL,
  `appalto` varchar(45) DEFAULT NULL,
  `oneri` float(11,2) DEFAULT '0.00',
  `stampato` tinyint(4) DEFAULT '0',
  `inviato` tinyint(4) DEFAULT '0',
  PRIMARY KEY (`id_duvri`),
  KEY `Index_2_azi` (`id_azi`),
  KEY `Index_4_clie` (`id_clie`),
  KEY `Index_5_comme` (`id_commessa`),
  KEY `FK_duvri_4_commessa` (`id_commessa`,`anno`),
  KEY `Index_7_anno` (`anno`),
  CONSTRAINT `FK_duvri_1_azi` FOREIGN KEY (`id_azi`) REFERENCES `azienda` (`id_azienda`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_duvri_3_clie` FOREIGN KEY (`id_clie`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_duvri_4_commessa` FOREIGN KEY (`id_commessa`, `anno`) REFERENCES `commessa` (`Id_commessa`, `anno`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.duvri_check
CREATE TABLE IF NOT EXISTS `duvri_check` (
  `id_duvri` int(11) NOT NULL,
  `id_risc` int(11) NOT NULL,
  PRIMARY KEY (`id_duvri`,`id_risc`),
  KEY `Index_2_duvri` (`id_duvri`),
  KEY `Index_3_risc` (`id_risc`),
  CONSTRAINT `FK_duvri_check_1_duvri` FOREIGN KEY (`id_duvri`) REFERENCES `duvri` (`id_duvri`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_duvri_check_2_risc` FOREIGN KEY (`id_risc`) REFERENCES `duvri_risc` (`id_risc`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.duvri_funz_azi
CREATE TABLE IF NOT EXISTS `duvri_funz_azi` (
  `id_duvri` int(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  `funzione` int(11) NOT NULL,
  PRIMARY KEY (`id_duvri`,`id_operaio`,`funzione`) USING BTREE,
  KEY `Index_2_funz` (`funzione`),
  KEY `Index_3_ope` (`id_operaio`),
  CONSTRAINT `FK_duvri_funz_azi_3_duvri` FOREIGN KEY (`id_duvri`) REFERENCES `duvri` (`id_duvri`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_duvri_funz_int_1_ope` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_duvri_funz_int_2_funz` FOREIGN KEY (`funzione`) REFERENCES `tipo_funzione` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.duvri_funz_cli
CREATE TABLE IF NOT EXISTS `duvri_funz_cli` (
  `id_duvri` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `funzione` int(11) NOT NULL,
  PRIMARY KEY (`id_duvri`,`nome`,`funzione`) USING BTREE,
  KEY `Index_2_funzi` (`funzione`),
  CONSTRAINT `FK_duvri_funz_1_funz` FOREIGN KEY (`funzione`) REFERENCES `tipo_funzione` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_duvri_funz_cli_2_duvri` FOREIGN KEY (`id_duvri`) REFERENCES `duvri` (`id_duvri`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.duvri_risc
CREATE TABLE IF NOT EXISTS `duvri_risc` (
  `id_risc` int(11) NOT NULL AUTO_INCREMENT,
  `aspetto` text,
  `fattore` text,
  `indi` text,
  `rischio` int(11) DEFAULT NULL,
  `mis_add` text,
  `mis_da_add` text,
  PRIMARY KEY (`id_risc`),
  KEY `Index_2_ris` (`rischio`),
  CONSTRAINT `FK_duvririsc_1_risc` FOREIGN KEY (`rischio`) REFERENCES `tipo_rischio` (`id_rischio`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.duvri_subapp
CREATE TABLE IF NOT EXISTS `duvri_subapp` (
  `id_duvri` int(10) NOT NULL,
  `id_cliente` int(10) NOT NULL,
  `titolare` varchar(45) DEFAULT NULL,
  `settore` varchar(45) DEFAULT NULL,
  `numero_rea` varchar(45) DEFAULT NULL,
  `posizione_inps` varchar(45) DEFAULT NULL,
  `codice_ateco` varchar(45) DEFAULT NULL,
  `posizione_inail` varchar(45) DEFAULT NULL,
  `comune` varchar(45) DEFAULT NULL,
  `indirizzo` varchar(45) DEFAULT NULL,
  `assicu_rct` varchar(45) DEFAULT NULL,
  `numero` int(11) DEFAULT NULL,
  `mansione` text,
  PRIMARY KEY (`id_duvri`,`id_cliente`) USING BTREE,
  KEY `Index_2_subb` (`id_cliente`),
  CONSTRAINT `FK_duvri_subapp_1sub` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.environment_variables
CREATE TABLE IF NOT EXISTS `environment_variables` (
  `var_key` varchar(100) NOT NULL,
  `var_value` text,
  `timestamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`var_key`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.errore
CREATE TABLE IF NOT EXISTS `errore` (
  `id_errore` int(11) NOT NULL AUTO_INCREMENT,
  `descrizione` text NOT NULL,
  `data` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `invio` tinyint(4) DEFAULT '0',
  `data_invio` datetime DEFAULT NULL,
  `errore` text,
  `indice` int(11) DEFAULT '0',
  `title` varchar(145) DEFAULT NULL,
  PRIMARY KEY (`id_errore`)
) ENGINE=InnoDB AUTO_INCREMENT=5978 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.errore_aggiornamento
CREATE TABLE IF NOT EXISTS `errore_aggiornamento` (
  `id_errore` int(11) NOT NULL AUTO_INCREMENT,
  `data` varchar(45) NOT NULL,
  `errore` text NOT NULL,
  `codice` text NOT NULL,
  PRIMARY KEY (`id_errore`)
) ENGINE=InnoDB AUTO_INCREMENT=157 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.esclusioni
CREATE TABLE IF NOT EXISTS `esclusioni` (
  `id_esclusione` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(40) NOT NULL,
  `descrizione` text NOT NULL,
  PRIMARY KEY (`id_esclusione`)
) ENGINE=InnoDB AUTO_INCREMENT=25 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evente_agente_check
CREATE TABLE IF NOT EXISTS `evente_agente_check` (
  `id_check` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_check`)
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evento
CREATE TABLE IF NOT EXISTS `evento` (
  `Id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Oggetto` varchar(50) NOT NULL,
  `Descrizione` text NOT NULL,
  `Id_riferimento` int(11) DEFAULT NULL,
  `Id_tipo_evento` tinyint(3) unsigned NOT NULL,
  `Eseguito` bit(1) NOT NULL DEFAULT b'0',
  `Ricorrente` bit(1) NOT NULL DEFAULT b'0',
  `Giorni_ricorrenza` int(11) DEFAULT '0',
  `Data_esecuzione` date NOT NULL,
  `Ora_inizio_esecuzione` time NOT NULL,
  `Ora_fine_esecuzione` time NOT NULL,
  `Sveglia` bit(1) NOT NULL DEFAULT b'0',
  `Data_sveglia` datetime NOT NULL DEFAULT '0000-00-00 00:00:00',
  `Stato_notifica` tinyint(4) DEFAULT '3',
  `Data_notifica` datetime DEFAULT NULL,
  `Promemoria_inviato` bit(1) NOT NULL DEFAULT b'0',
  `Eliminato` bit(1) DEFAULT b'0',
  `Data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `Data_mod` timestamp NOT NULL DEFAULT '0000-00-00 00:00:00',
  `Utente_ins` mediumint(9) NOT NULL DEFAULT '0',
  `Utente_mod` mediumint(9) NOT NULL DEFAULT '0',
  PRIMARY KEY (`Id`),
  KEY `Data_esecuzione` (`Data_esecuzione`),
  KEY `Evento_tipo_evento` (`Id_tipo_evento`),
  CONSTRAINT `Evento_tipo_evento` FOREIGN KEY (`Id_tipo_evento`) REFERENCES `tipo_evento` (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=1318 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evento_anno
CREATE TABLE IF NOT EXISTS `evento_anno` (
  `anno` int(11) NOT NULL,
  PRIMARY KEY (`anno`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evento_file_associati_caldav
CREATE TABLE IF NOT EXISTS `evento_file_associati_caldav` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `file_name` varchar(150) NOT NULL DEFAULT '0',
  `id_evento` int(11) NOT NULL DEFAULT '0',
  `id_operaio` int(11) NOT NULL DEFAULT '0',
  `data_ins` datetime NOT NULL,
  `data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `utente_ins` int(11) NOT NULL DEFAULT '0',
  `utente_mod` int(11) DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `file_name_id_operaio` (`file_name`,`id_operaio`),
  KEY `file_name` (`file_name`)
) ENGINE=InnoDB AUTO_INCREMENT=31 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evento_gruppo
CREATE TABLE IF NOT EXISTS `evento_gruppo` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Oggetto` varchar(50) NOT NULL,
  `Descrizione` text NOT NULL,
  `Id_cliente` int(11) DEFAULT NULL,
  `Id_impianto` int(11) DEFAULT NULL,
  `Id_stato` tinyint(4) NOT NULL DEFAULT '1',
  `Stato_notifica` tinyint(4) DEFAULT '3',
  `Data_notifica` datetime DEFAULT NULL,
  `Eliminato` bit(1) DEFAULT b'0',
  `Data_ora_inizio` datetime DEFAULT NULL,
  `Data_ora_fine` datetime DEFAULT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) DEFAULT NULL,
  PRIMARY KEY (`Id`),
  KEY `Fk_gruppo_evento_clienti` (`Id_cliente`),
  KEY `Fk_gruppo_evento_impianto` (`Id_impianto`),
  KEY `Fk_gruppo_evento_stato_evento_gruppo` (`Id_stato`),
  CONSTRAINT `Fk_gruppo_evento_clienti` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE SET NULL ON UPDATE SET NULL,
  CONSTRAINT `Fk_gruppo_evento_impianto` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE SET NULL ON UPDATE SET NULL,
  CONSTRAINT `Fk_gruppo_evento_stato_evento_gruppo` FOREIGN KEY (`Id_stato`) REFERENCES `stato_evento_gruppo` (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=1159 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evento_gruppo_evento
CREATE TABLE IF NOT EXISTS `evento_gruppo_evento` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_evento` int(10) unsigned NOT NULL,
  `Id_gruppo_evento` int(11) NOT NULL,
  `Tipo_associazione` tinyint(4) NOT NULL DEFAULT '1',
  `Timestamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_evento_Id_gruppo_evento` (`Id_evento`,`Id_gruppo_evento`),
  KEY `FK_event_gruppo_id` (`Id_gruppo_evento`),
  CONSTRAINT `FK_evento_id` FOREIGN KEY (`Id_evento`) REFERENCES `evento` (`Id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_event_gruppo_id` FOREIGN KEY (`Id_gruppo_evento`) REFERENCES `evento_gruppo` (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=1374 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evento_operaio
CREATE TABLE IF NOT EXISTS `evento_operaio` (
  `Id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Id_evento` int(10) unsigned NOT NULL,
  `Id_operaio` int(10) unsigned NOT NULL,
  `Utente_ins` smallint(5) unsigned NOT NULL,
  `Utente_mod` smallint(5) unsigned NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evento_rapporto
CREATE TABLE IF NOT EXISTS `evento_rapporto` (
  `Id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Id_evento` int(10) unsigned NOT NULL,
  `Id_rapporto` int(11) NOT NULL,
  `Anno_rapporto` int(11) NOT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_evento_Id_rapporto` (`Id_evento`,`Id_rapporto`,`Anno_rapporto`),
  CONSTRAINT `Fk_evento_rapporto_Id_evento` FOREIGN KEY (`Id_evento`) REFERENCES `evento` (`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.evento_tipo_ricorrenza
CREATE TABLE IF NOT EXISTS `evento_tipo_ricorrenza` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(39) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattforn_impost
CREATE TABLE IF NOT EXISTS `fattforn_impost` (
  `tipo` varchar(50) NOT NULL,
  `valore` varchar(100) NOT NULL,
  PRIMARY KEY (`tipo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura
CREATE TABLE IF NOT EXISTS `fattura` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_cliente` int(11) NOT NULL,
  `id_destinazione` int(11) NOT NULL,
  `destinazione` int(11) NOT NULL,
  `Data_registrazione` date NOT NULL,
  `data_modifica` date DEFAULT NULL,
  `data` date NOT NULL,
  `cond_pagamento` int(11) NOT NULL,
  `banca` int(11) NOT NULL,
  `annotazioni` text NOT NULL,
  `Stato` int(11) NOT NULL,
  `causale_fattura` int(11) NOT NULL,
  `nota_interna` varchar(100) DEFAULT NULL,
  `iban` varchar(45) NOT NULL,
  `abi` varchar(6) NOT NULL,
  `cab` varchar(6) NOT NULL,
  `tipo_fattura` int(11) NOT NULL,
  `incasso` float(11,2) NOT NULL DEFAULT '0.00',
  `bollo` float(11,2) NOT NULL DEFAULT '0.00',
  `trasporto` float(11,2) NOT NULL DEFAULT '0.00',
  `importo_imponibile` float(11,2) NOT NULL DEFAULT '0.00',
  `importo_iva` float(11,2) NOT NULL DEFAULT '0.00',
  `importo_totale` float(11,2) NOT NULL DEFAULT '0.00',
  `costo_totale` float(11,2) NOT NULL DEFAULT '0.00',
  `inviato` int(11) unsigned NOT NULL DEFAULT '0',
  `pagato_il` time DEFAULT NULL,
  `tramite` int(11) unsigned DEFAULT '0',
  `insoluto` int(11) unsigned NOT NULL DEFAULT '0',
  `stampato` tinyint(1) NOT NULL DEFAULT '0',
  `subappalto` tinyint(4) NOT NULL DEFAULT '0',
  `id_utente` int(11) DEFAULT NULL,
  `scont_mat` varchar(15) DEFAULT '0',
  `id_iv` int(11) DEFAULT NULL,
  `id_tipo_natura_iva` int(11) DEFAULT NULL,
  `data_invio_promemoria` date DEFAULT NULL,
  `data_annullamento_promemoria` date DEFAULT NULL,
  `controllo_promemoria` tinyint(1) DEFAULT '1',
  `area_attivita` varchar(45) DEFAULT NULL,
  `nostra` tinyint(1) DEFAULT '0',
  `id_documento_ricezione` varchar(150) DEFAULT NULL,
  `data_ultima_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `movimenta_magazzino` bit(1) DEFAULT b'0',
  PRIMARY KEY (`Id_fattura`,`anno`),
  UNIQUE KEY `Id` (`Id`),
  KEY `id_cliente` (`id_cliente`),
  KEY `destinazione` (`destinazione`),
  KEY `cond_pagamento` (`cond_pagamento`),
  KEY `anno` (`anno`),
  KEY `Stato` (`Stato`),
  KEY `causale_fattura` (`causale_fattura`),
  KEY `tipo_fattura` (`tipo_fattura`),
  KEY `fattura_ibfk_3` (`destinazione`,`id_cliente`),
  KEY `Index_10_ut` (`id_utente`),
  KEY `FK_fattura_8` (`id_iv`),
  KEY `FK_fattura_tipo_natura_iva` (`id_tipo_natura_iva`),
  CONSTRAINT `fattura_ibfk_1` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fattura_ibfk_3` FOREIGN KEY (`destinazione`, `id_cliente`) REFERENCES `destinazione_cliente` (`Id_destinazione`, `id_cliente`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fattura_ibfk_4` FOREIGN KEY (`cond_pagamento`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fattura_ibfk_6` FOREIGN KEY (`Stato`) REFERENCES `stato_fattura` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fattura_ibfk_7` FOREIGN KEY (`causale_fattura`) REFERENCES `causale_fattura` (`id_causale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fattura_ibfk_8` FOREIGN KEY (`tipo_fattura`) REFERENCES `tipo_fattura` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_7_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_tipo_iva` FOREIGN KEY (`id_iv`) REFERENCES `tipo_iva` (`Id_iva`),
  CONSTRAINT `FK_fattura_tipo_natura_iva` FOREIGN KEY (`id_tipo_natura_iva`) REFERENCES `tipo_natura_iva` (`id_tipo_natura_iva`)
) ENGINE=InnoDB AUTO_INCREMENT=7028 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_acconto
CREATE TABLE IF NOT EXISTS `fattura_acconto` (
  `id_acconto` int(11) NOT NULL AUTO_INCREMENT,
  `id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_pagamento` int(11) NOT NULL,
  `importo` decimal(11,2) NOT NULL,
  `data` date DEFAULT NULL,
  `modo` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_acconto`),
  KEY `FK_fattura_acconto_1` (`id_fattura`,`anno`),
  KEY `FK_fattura_acconto_2` (`modo`),
  CONSTRAINT `FK_fattura_acconto_1` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_acconto_2` FOREIGN KEY (`modo`) REFERENCES `tipo_pagamento` (`id_Tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=129 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_allegati
CREATE TABLE IF NOT EXISTS `fattura_allegati` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_fattura` int(11) NOT NULL,
  `Anno_fattura` int(11) NOT NULL,
  `Nome` varchar(150) NOT NULL,
  `Formato` varchar(10) NOT NULL,
  `Descrizione` mediumtext,
  `File_path` varchar(250) NOT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  KEY `FK_fattura_allegati` (`Id_fattura`,`Anno_fattura`),
  CONSTRAINT `FK_fattura_allegati` FOREIGN KEY (`Id_fattura`, `Anno_fattura`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=2051 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_articoli
CREATE TABLE IF NOT EXISTS `fattura_articoli` (
  `id_fattura` int(11) NOT NULL,
  `Anno` int(11) NOT NULL,
  `n_tab` int(11) NOT NULL,
  `Descrizione` text NOT NULL,
  `um` varchar(5) DEFAULT NULL,
  `quantità` decimal(11,2) DEFAULT NULL,
  `prezzo_unitario` decimal(11,2) DEFAULT NULL,
  `sconto` decimal(11,2) DEFAULT NULL,
  `costo` decimal(11,2) DEFAULT NULL,
  `serial_number` varchar(35) DEFAULT NULL,
  `id_materiale` varchar(13) DEFAULT NULL,
  `Iva` int(10) unsigned DEFAULT NULL,
  `codice_fornitore` varchar(45) DEFAULT NULL,
  `anno_rif` varchar(10) DEFAULT NULL,
  `id_rif` varchar(10) DEFAULT NULL,
  `tipo` char(10) DEFAULT NULL,
  `idnota` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_fattura`,`Anno`,`n_tab`),
  KEY `id_materiale` (`id_materiale`),
  KEY `Anno` (`Anno`),
  KEY `notaa` (`idnota`),
  CONSTRAINT `fattura_articoli_ibfk_1` FOREIGN KEY (`id_fattura`, `Anno`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fattura_articoli_ibfk_2` FOREIGN KEY (`id_materiale`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `notaa` FOREIGN KEY (`idnota`) REFERENCES `nota` (`id_nota`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_configurazione
CREATE TABLE IF NOT EXISTS `fattura_configurazione` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `colonna1` varchar(40) NOT NULL,
  `colonna3` varchar(40) NOT NULL,
  `nota_fissa` text,
  `nome_col3` varchar(45) NOT NULL,
  `jjoin` varchar(195) NOT NULL,
  `nota_mail` text,
  `nome_col1` varchar(45) NOT NULL,
  `imp_rap` varchar(45) NOT NULL DEFAULT '0',
  `ddt_prezzorap` varchar(45) DEFAULT '1',
  `scontozero` tinyint(1) unsigned NOT NULL DEFAULT '1',
  `prezzozero` tinyint(1) unsigned NOT NULL DEFAULT '1',
  `impianto` tinyint(1) unsigned NOT NULL DEFAULT '1',
  `id_certificato_firma` int(11) DEFAULT NULL,
  `email_sdi` varchar(100) DEFAULT NULL,
  `estratto_conto_testo_mail` text,
  `utente_mod` mediumint(8) unsigned NOT NULL,
  `data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `FK_fattura_cert_firma` (`id_certificato_firma`),
  CONSTRAINT `FK_fattura_cert_firma` FOREIGN KEY (`id_certificato_firma`) REFERENCES `certificato_importato` (`id`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_elettronica_versione
CREATE TABLE IF NOT EXISTS `fattura_elettronica_versione` (
  `id_fattura_elettronica_versione` int(11) NOT NULL AUTO_INCREMENT,
  `versione` varchar(20) NOT NULL,
  `codice_versione_pa` varchar(10) NOT NULL,
  `codice_versione_privato` varchar(10) NOT NULL,
  `styles_versione_pa` text NOT NULL,
  `local_styles_versione_pa` text NOT NULL,
  `styles_versione_privato` text NOT NULL,
  `local_styles_versione_privato` text NOT NULL,
  `data_inizio` date DEFAULT NULL,
  `data_fine` date DEFAULT NULL,
  `corrente` bit(1) NOT NULL,
  `data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_fattura_elettronica_versione`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_ordine_acquisto
CREATE TABLE IF NOT EXISTS `fattura_ordine_acquisto` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_fattura` int(11) NOT NULL,
  `Anno_fattura` int(11) NOT NULL,
  `Id_documento` varchar(20) NOT NULL,
  `Data` date NOT NULL,
  `Codice_cig` varchar(15) NOT NULL,
  `Codice_cup` varchar(15) NOT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  KEY `Fk_fattura_ordine_acquisto_ordine` (`Id_fattura`,`Anno_fattura`),
  CONSTRAINT `Fk_fattura_ordine_acquisto_ordine` FOREIGN KEY (`Id_fattura`, `Anno_fattura`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=86 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_pagamenti
CREATE TABLE IF NOT EXISTS `fattura_pagamenti` (
  `id_fattura` int(11) NOT NULL AUTO_INCREMENT,
  `anno` int(11) NOT NULL,
  `nota` text,
  `data` date DEFAULT NULL,
  `id_pagamento` int(11) NOT NULL,
  `tipo_pagamento` int(11) DEFAULT NULL,
  `insoluto` tinyint(4) DEFAULT NULL,
  `id_prima_nota` int(11) DEFAULT NULL,
  `anno_prima_nota` int(11) DEFAULT NULL,
  `id_trasferimento_verso` int(11) DEFAULT NULL,
  `anno_trasferimento_verso` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_fattura`,`anno`,`id_pagamento`) USING BTREE,
  KEY `Index_3_tipopag` (`tipo_pagamento`),
  KEY `Index_3_fat` (`id_fattura`,`anno`),
  KEY `FK_fattura_pagamenti_prima_nota_trasf` (`id_trasferimento_verso`,`anno_trasferimento_verso`),
  KEY `FK_fattura_pagamenti_prima_nota` (`id_prima_nota`,`anno_prima_nota`),
  CONSTRAINT `FK_fattura_pagamenti_1` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_pagamenti_2_tipo` FOREIGN KEY (`tipo_pagamento`) REFERENCES `tipo_pagamento` (`id_Tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_pagamenti_prima_nota` FOREIGN KEY (`id_prima_nota`, `anno_prima_nota`) REFERENCES `prima_nota` (`Id_prima_nota`, `anno`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_pagamenti_prima_nota_trasf` FOREIGN KEY (`id_trasferimento_verso`, `anno_trasferimento_verso`) REFERENCES `prima_nota` (`Id_prima_nota`, `anno`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=413 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_pagamenti_comunicazione
CREATE TABLE IF NOT EXISTS `fattura_pagamenti_comunicazione` (
  `id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_comunicazione` int(11) NOT NULL,
  `id_pagamento` int(11) NOT NULL,
  `nota` text,
  `tipo` int(11) DEFAULT NULL,
  `data` date DEFAULT NULL,
  `mail` int(11) DEFAULT NULL,
  `stato` int(11) DEFAULT '1',
  PRIMARY KEY (`id_fattura`,`anno`,`id_pagamento`,`id_comunicazione`) USING BTREE,
  KEY `Index_2` (`id_fattura`,`anno`),
  KEY `Index_3p` (`id_pagamento`),
  KEY `FK_fattura_pagamenti_comunicazione_mail` (`mail`),
  CONSTRAINT `FK_fattura_pagamenti_comunicazione_1_fatt` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_pagamenti_comunicazione_mail` FOREIGN KEY (`mail`) REFERENCES `mail` (`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_sollecito
CREATE TABLE IF NOT EXISTS `fattura_sollecito` (
  `id_sollecito` int(11) NOT NULL AUTO_INCREMENT,
  `data` date NOT NULL,
  `id_mail` int(11) DEFAULT NULL,
  `tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_sollecito`),
  KEY `FK_fattura_sollecito_1_tipo` (`tipo`),
  CONSTRAINT `FK_fattura_sollecito_1_tipo` FOREIGN KEY (`tipo`) REFERENCES `pervenuta_per` (`Id_modo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=279 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_sollecito_numeri
CREATE TABLE IF NOT EXISTS `fattura_sollecito_numeri` (
  `id_sollecito` int(11) NOT NULL AUTO_INCREMENT,
  `anno_fattura` int(11) NOT NULL,
  `fattura` int(11) NOT NULL,
  `id_pagamento` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_sollecito`,`anno_fattura`,`fattura`,`id_pagamento`) USING BTREE,
  KEY `FK_fattura_sollecito_numeri_2` (`fattura`,`anno_fattura`,`id_pagamento`),
  CONSTRAINT `FK_fattura_sollecito_numeri_1` FOREIGN KEY (`id_sollecito`) REFERENCES `fattura_sollecito` (`id_sollecito`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_sollecito_numeri_2` FOREIGN KEY (`fattura`, `anno_fattura`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=279 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_studi
CREATE TABLE IF NOT EXISTS `fattura_studi` (
  `id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `tipo_intervento` int(11) DEFAULT NULL,
  `tipo_impianto` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_fattura`,`anno`) USING BTREE,
  KEY `FK_fattura_studi_tipo_impianto` (`tipo_impianto`),
  KEY `FK_fattura_studi_tipo_intervento` (`tipo_intervento`) USING BTREE,
  CONSTRAINT `FK_fattura_studi_tipo_impianto` FOREIGN KEY (`tipo_impianto`) REFERENCES `tipo_impianto` (`id_tipo`) ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_studi_tipo_intervento` FOREIGN KEY (`tipo_intervento`) REFERENCES `tipo_intervento` (`Id_tipo`) ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_tag
CREATE TABLE IF NOT EXISTS `fattura_tag` (
  `id_fattura` int(11) NOT NULL,
  `anno_fattura` int(11) NOT NULL,
  `id_tag` int(11) NOT NULL,
  `utente_ins` int(11) DEFAULT NULL,
  `data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_fattura`,`anno_fattura`,`id_tag`),
  KEY `FK_fattura_tag_tag` (`id_tag`),
  KEY `FK_fattura_tag_fattura` (`id_fattura`,`anno_fattura`),
  KEY `FK_fattura_tag_utente_ins` (`utente_ins`),
  CONSTRAINT `FK_fattura_tag_fattura` FOREIGN KEY (`id_fattura`, `anno_fattura`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_tag_tag` FOREIGN KEY (`id_tag`) REFERENCES `tag` (`id_tag`) ON UPDATE CASCADE,
  CONSTRAINT `FK_fattura_tag_utente_ins` FOREIGN KEY (`utente_ins`) REFERENCES `utente` (`Id_utente`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_tipo_sollecito
CREATE TABLE IF NOT EXISTS `fattura_tipo_sollecito` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `testo` text NOT NULL,
  `titolo` varchar(105) NOT NULL,
  `numero` int(11) NOT NULL,
  `coda` text,
  `giorni` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fattura_totali_iva
CREATE TABLE IF NOT EXISTS `fattura_totali_iva` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_iva` int(11) NOT NULL,
  `importo_imponibile` decimal(10,2) NOT NULL,
  `importo_iva` decimal(10,2) NOT NULL,
  `importo_totale` decimal(10,2) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_fattura_anno_id_iva` (`id_fattura`,`anno`,`id_iva`),
  KEY `fk_fattura_totali_id_iva` (`id_iva`),
  CONSTRAINT `fk_fattura_totali_fattura` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_fattura_totali_id_iva` FOREIGN KEY (`id_iva`) REFERENCES `tipo_iva` (`Id_iva`) ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=9069 DEFAULT CHARSET=latin1 COMMENT='Storico dei totali delle fatture suddivisi per iva';

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.festivita
CREATE TABLE IF NOT EXISTS `festivita` (
  `Id_festività` int(11) NOT NULL,
  `Nome` varchar(30) NOT NULL,
  `Data` date NOT NULL,
  PRIMARY KEY (`Id_festività`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.festivita_variabile
CREATE TABLE IF NOT EXISTS `festivita_variabile` (
  `Id_festività` int(11) NOT NULL,
  `Nome` varchar(30) NOT NULL,
  `anno` int(11) NOT NULL,
  `data` date NOT NULL,
  PRIMARY KEY (`Id_festività`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.figura_riferimento
CREATE TABLE IF NOT EXISTS `figura_riferimento` (
  `nome` varchar(20) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.file_calendario
CREATE TABLE IF NOT EXISTS `file_calendario` (
  `nome_file` varchar(150) NOT NULL,
  `id_evento` int(10) unsigned DEFAULT NULL,
  `id_impianto` int(10) unsigned DEFAULT NULL,
  `id_ticket` int(10) unsigned DEFAULT NULL,
  `anno` int(10) unsigned DEFAULT NULL,
  `mese` int(10) unsigned DEFAULT NULL,
  `id_tecnico` int(10) unsigned NOT NULL DEFAULT '0',
  PRIMARY KEY (`nome_file`,`id_tecnico`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.filiale
CREATE TABLE IF NOT EXISTS `filiale` (
  `Id_banca` bigint(20) NOT NULL,
  `Id_filiale` bigint(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) DEFAULT NULL,
  `Cab` varchar(5) DEFAULT NULL,
  `Cin` char(1) DEFAULT NULL,
  `Provincia` varchar(5) DEFAULT NULL,
  `Comune` int(11) DEFAULT NULL,
  `Frazione` int(11) DEFAULT NULL,
  `Indirizzo` varchar(50) DEFAULT NULL,
  `numero` varchar(10) DEFAULT '0',
  PRIMARY KEY (`Id_filiale`),
  KEY `Id_banca` (`Id_banca`),
  KEY `Comune` (`Comune`),
  KEY `Frazione` (`Frazione`),
  KEY `Provincia` (`Provincia`,`Comune`,`Frazione`) USING BTREE,
  CONSTRAINT `filiale_ibfk_2` FOREIGN KEY (`Comune`) REFERENCES `comune` (`Id_comune`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `filiale_ibfk_3` FOREIGN KEY (`Frazione`) REFERENCES `frazione` (`Id_frazione`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `filiale_ibfk_4` FOREIGN KEY (`Id_banca`) REFERENCES `banca` (`Id_banca`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=3819 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di funzione emmebi.fnc_ddtHasJobLink
DELIMITER //
CREATE FUNCTION `fnc_ddtHasJobLink`(ddt_id INT, ddt_year INT) RETURNS bit(1)
BEGIN

	DECLARE has_job_link BIT(1);

    SELECT COUNT(id_commessa) > 0
        INTO has_job_link
    FROM commessa_ddt
    WHERE id_ddt = ddt_id
        AND anno_ddt = ddt_year;
	
	RETURN  has_job_link;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_invoiceProductAllowDepotsScale
DELIMITER //
CREATE FUNCTION `fnc_invoiceProductAllowDepotsScale`(invoice_id INT, invoice_year INT, product_code VARCHAR(16)) RETURNS bit(1)
BEGIN

	DECLARE allow_insert BIT(1);

	-- CONTROL IF INVOICE TYPE = 5 (FATTURA ACCOMPAGNATORIA)
	SELECT movimenta_magazzino
				INTO allow_insert
	FROM  	fattura 
	WHERE 	(id_fattura=invoice_id AND anno=invoice_year); 
	
	-- CONTROL IF PRODUCT HAS CATEGORY THAT ALLOW DEPOSITS MOVEMENT
	IF (allow_insert = 1) THEN
		SELECT  fnc_productAllowDepotsScale(product_code)
			INTO allow_insert; 
	END IF; 
    
    IF allow_insert IS NULL THEN
        SET allow_insert = 0;
    END IF;

	RETURN  allow_insert;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_jobGetCostHourByJob
DELIMITER //
CREATE FUNCTION `fnc_jobGetCostHourByJob`(job_id INT, job_year INT,
    sub_job_id INT, lot_id INT) RETURNS decimal(11,2)
BEGIN

	DECLARE hour_cost DECIMAL(11, 2);

    SELECT DISTINCT ora_c
        INTO hour_cost
    FROM commessa_preventivo
        INNER JOIN preventivo_lotto
        ON id_preventivo = commessa_preventivo.preventivo 
            AND anno_prev = preventivo_lotto.anno
            AND Pidlotto = preventivo_lotto.posizione
            AND rev = preventivo_lotto.id_revisione
    WHERE commessa_preventivo.id_commessa = job_id AND commessa_preventivo.anno = job_year
        AND commessa_preventivo.id_sottocommessa = sub_job_id AND commessa_preventivo.lotto = lot_id
    LIMIT 1;

	
    IF hour_cost IS NULL THEN
        SELECT MAX(costo_ora)
            INTO hour_cost
        FROM commessa_articoli
        WHERE id_commessa = job_id AND anno = job_year
            AND id_lotto = lot_id AND id_sottocommessa = sub_job_id;
    END IF;

    IF hour_cost IS NULL THEN
        SELECT costo_h INTO hour_cost
        FROM tariffario
        WHERE normale=1
        LIMIT 1;
    END IF;
	
	RETURN  hour_cost;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_jobGetNextIdTab
DELIMITER //
CREATE FUNCTION `fnc_jobGetNextIdTab`(job_id INT, job_year INT, sub_job_id INT, lot_id INT) RETURNS int(11)
BEGIN

	DECLARE tab_id INT;
	
    SELECT IFNULL(MAX(id_tab + 1), 1)
        INTO tab_id
    FROM commessa_articoli
    WHERE id_commessa = job_id AND anno = job_year
        AND id_sottocommessa = sub_job_id AND id_lotto = lot_id;

    RETURN tab_id;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_jobGetPriceHourByJob
DELIMITER //
CREATE FUNCTION `fnc_jobGetPriceHourByJob`(job_id INT, job_year INT,
    sub_job_id INT, lot_id INT) RETURNS decimal(11,2)
BEGIN

	DECLARE hour_price DECIMAL(11, 2);

    SELECT DISTINCT ora_p
        INTO hour_price
    FROM commessa_preventivo
        INNER JOIN preventivo_lotto
        ON id_preventivo = commessa_preventivo.preventivo 
            AND anno_prev = preventivo_lotto.anno
            AND Pidlotto = preventivo_lotto.posizione
            AND rev = preventivo_lotto.id_revisione
    WHERE commessa_preventivo.id_commessa = job_id AND commessa_preventivo.anno = job_year
        AND commessa_preventivo.id_sottocommessa = sub_job_id AND commessa_preventivo.lotto = lot_id
    LIMIT 1;

	
    IF hour_price IS NULL THEN
        SELECT MAX(prezzo_ora)
            INTO hour_price
        FROM commessa_articoli
        WHERE id_commessa = job_id AND anno = job_year
            AND id_lotto = lot_id AND id_sottocommessa = sub_job_id;
    END IF;

    IF hour_price IS NULL THEN
        SELECT ora_normale
            INTO hour_price
        FROM abbonamento
        WHERE generale=1 ORDER BY generale desc, anno desc
        LIMIT 1;
    END IF;
	
	RETURN  hour_price;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_jobGetVatValueByJob
DELIMITER //
CREATE FUNCTION `fnc_jobGetVatValueByJob`(job_id INT, job_year INT,
    sub_job_id INT, lot_id INT) RETURNS int(11)
BEGIN

	DECLARE vat_value INT;

    SELECT DISTINCT iv_lot
        INTO vat_value
    FROM commessa_preventivo
        INNER JOIN preventivo_lotto
        ON id_preventivo = commessa_preventivo.preventivo 
            AND anno_prev = preventivo_lotto.anno
            AND Pidlotto = preventivo_lotto.posizione
            AND rev = preventivo_lotto.id_revisione
    WHERE commessa_preventivo.id_commessa = job_id AND commessa_preventivo.anno = job_year
        AND commessa_preventivo.id_sottocommessa = sub_job_id AND commessa_preventivo.lotto = lot_id
    LIMIT 1;

	
    IF vat_value IS NULL THEN
        SELECT MAX(iva)
            INTO vat_value
        FROM commessa_articoli
        WHERE id_commessa = job_id AND anno = job_year
            AND id_lotto = lot_id AND id_sottocommessa = sub_job_id;
    END IF;

    	
    IF vat_value IS NULL THEN
        SELECT aliquota
            INTO vat_value
        FROM tipo_iva
        WHERE normale = 1;
    END IF;
	
	RETURN  vat_value;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_jobremainingamountforspecificproduct
DELIMITER //
CREATE FUNCTION `fnc_jobremainingamountforspecificproduct`(JobId SMALLINT, JobYear SMALLINT, 
	SubJobId SMALLINT, JobLotId SMALLINT, productid VARCHAR (11)) RETURNS smallint(6)
BEGIN
	DECLARE outVal DECIMAL(11,2);
	
	SELECT SUM(qta_commessa - qta_utilizzata)
	INTO outVal
	FROM vw_jobbody
	WHERE Id_commessa = JobId 
		AND anno= JobYear 
		AND lotto = JobLotId
        AND id_sottocommessa=SubJobId
		AND codice_articolo=productid;
	
	IF outVal<=0 THEN 
		SET outVal = 0 ;
	END IF;
	
	IF outVal IS NULL THEN 
		SET outVal =-1;
	END IF;
	
	RETURN outVal;
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_jobscaleproductsfromreports
DELIMITER //
CREATE FUNCTION `fnc_jobscaleproductsfromreports`(JobId INT, JobYear INT) RETURNS tinyint(4)
BEGIN

	DECLARE ScaleFromReports TINYINT;
	DECLARE typename VARCHAR(12);
	
	SET typename = "cont_mat_rap";
	
	SELECT valore
	INTO ScaleFromReports
	FROM commessa_impostazioni 
	WHERE id_commessa = JobId 
		AND anno = JobYear 
		AND tipo = typename;
	
	IF ScaleFromReports IS NULL THEN
		SELECT valore
		INTO ScaleFromReports
		FROM commessa_impostazioni_default
		WHERE tipo = typename;
	END IF;
	
	IF ScaleFromReports IS NULL THEN
		SET ScaleFromReports = 0;
	END IF;
	
	RETURN  ScaleFromReports ;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_productAllowDepotsScale
DELIMITER //
CREATE FUNCTION `fnc_productAllowDepotsScale`(product_code VARCHAR(16)) RETURNS bit(1)
BEGIN

	DECLARE allow_insert BIT(1);
	
	-- CONTROL IF PRODUCT HAS CATEGORY THAT ALLOW DEPOSITS MOVEMENT
    SELECT  IFNULL(categoria_merciologica.Movimenta_magazzino, 1)
                INTO allow_insert
    FROM  	articolo 
                LEFT JOIN categoria_merciologica 
                    ON articolo.Categoria = categoria_merciologica.Id_categoria 
    WHERE 	articolo.Codice_articolo = product_code;
    

    IF allow_insert IS NULL THEN
        SET allow_insert = 0;
    END IF;
	
	RETURN  allow_insert;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_productAllowSystemScale
DELIMITER //
CREATE FUNCTION `fnc_productAllowSystemScale`(product_code VARCHAR(16)) RETURNS bit(1)
BEGIN

	DECLARE allow_insert BIT(1);
	
	-- CHECK IF PRODUCT HAS CATEGORY THAT ALLOW DEPOSITS MOVEMENT
    SELECT  IFNULL(categoria_merciologica.Movimenta_impianto, 1)
                INTO allow_insert
    FROM  	articolo 
                LEFT JOIN categoria_merciologica 
                    ON articolo.Categoria = categoria_merciologica.Id_categoria 
    WHERE 	articolo.Codice_articolo = product_code;

    IF allow_insert IS NULL THEN
        SET allow_insert = 0;
    END IF;
	
	RETURN  allow_insert;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_productInternalCostId
DELIMITER //
CREATE FUNCTION `fnc_productInternalCostId`() RETURNS int(11)
BEGIN
	DECLARE val INT(11);
	SET val = 1;
	RETURN  val;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_productInternalPriceId
DELIMITER //
CREATE FUNCTION `fnc_productInternalPriceId`() RETURNS int(11)
BEGIN
	DECLARE val INT(11);
	SET val = 2;
	RETURN  val;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_productIsKit
DELIMITER //
CREATE FUNCTION `fnc_productIsKit`(product_code VARCHAR(16)) RETURNS bit(1)
BEGIN

	DECLARE is_kit BIT(1);
	
    SELECT  IFNULL(articolo.is_kit, 0)
                INTO is_kit
    FROM  	articolo
    WHERE 	Codice_articolo = product_code;

    IF is_kit IS NULL THEN
        SET is_kit = 0;
    END IF;
	
	RETURN  is_kit;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_quoteStatusShouldClearReminders
DELIMITER //
CREATE FUNCTION `fnc_quoteStatusShouldClearReminders`(quote_status_id INT(11)) RETURNS bit(1)
BEGIN
	DECLARE val BIT(1) DEFAULT 0;
	
    SELECT reset_promemoria_invio
        INTO val 
    FROM stato_preventivo
    WHERE Id_stato = quote_status_id;

	RETURN  val;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_reportHasDdtLink
DELIMITER //
CREATE FUNCTION `fnc_reportHasDdtLink`(report_id INT, report_year INT) RETURNS bit(1)
BEGIN

	DECLARE has_ddt_link BIT(1);

    SELECT COUNT(id_rapporto) > 0
        INTO has_ddt_link
    FROM ddt_rapporto
    WHERE id_rapporto = report_id
        AND anno_rapporto = report_year;
	
	RETURN  has_ddt_link;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_reportHasJobLink
DELIMITER //
CREATE FUNCTION `fnc_reportHasJobLink`(report_id INT, report_year INT) RETURNS bit(1)
BEGIN

	DECLARE has_job_link BIT(1);

    SELECT COUNT(id_commessa) > 0
        INTO has_job_link
    FROM commessa_rapporto
    WHERE id_rapporto = report_id
        AND anno_rapporto = report_year;
	
	RETURN  has_job_link;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_reportIsRightOfCallChargeable
DELIMITER //
CREATE FUNCTION `fnc_reportIsRightOfCallChargeable`(report_id INT(11), year INT(11)) RETURNS bit(1)
BEGIN
	DECLARE is_right_of_call_chargeble BIT(1);
	DECLARE included_roc INT(11);
	DECLARE subscription_id INT(11);
	DECLARE used_roc INT(11);
    DECLARE system_id INT(11);
    DECLARE report_has_right_of_call BIT(1);
    DECLARE is_extra_ordinary BIT(1);

    SELECT
        id_impianto, tipo_diritto_chiamata = 2, diritto_chiamata = 1 AND tipo_diritto_chiamata <> 0, abbonamento
    INTO system_id, is_extra_ordinary, report_has_right_of_call, subscription_id
    FROM rapporto
    WHERE id_rapporto = report_id AND anno = year;

    IF subscription_id IS NOT NULL AND report_has_right_of_call THEN
        SELECT IF(is_extra_ordinary, diritto_chiamata_straordinario_inclusa, diritto_chiamata_gratis) INTO included_roc
        FROM abbonamento
        WHERE id_abbonamento = subscription_id;

        SELECT COUNT(*) INTO used_roc
        FROM rapporto
        WHERE anno = year
            AND id_impianto = system_id
            AND diritto_chiamata = 1
            AND id_rapporto <> report_id
            AND IF(is_extra_ordinary, 2, 1) = tipo_diritto_chiamata;

        SET is_right_of_call_chargeble = IFNULL(included_roc, 0) <= IFNULL(used_roc, 0);
    END IF;

    IF is_right_of_call_chargeble IS NULL THEN
        SET is_right_of_call_chargeble = 0;
    END IF;
	
	RETURN  is_right_of_call_chargeble;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_reportIsRightOfCallChargeble
DELIMITER //
CREATE FUNCTION `fnc_reportIsRightOfCallChargeble`(report_id INT(11), year INT(11), is_extra_ordinary BIT(1)) RETURNS bit(1)
BEGIN
	 DECLARE is_right_of_call_chargeble BIT(1);
	 DECLARE included_roc INT(11);
	 DECLARE subscription_id INT(11);
	 DECLARE used_roc INT(11);
    DECLARE system_id INT(11);

    SELECT id_impianto INTO system_id
    FROM rapporto
    WHERE id_rapporto = report_id AND anno = year;
	
    SELECT id_abbonamenti INTO subscription_id
    FROM impianto_abbonamenti
    WHERE id_impianto = system_id AND anno = year;

    IF subscription_id IS NOT NULL THEN
        SELECT IF(is_extra_ordinary, diritto_chiamata_straordinario_inclusa, diritto_chiamata_gratis) INTO included_roc
        FROM abbonamento
        WHERE abbonamento = subscription_id;

        SELECT COUNT(*) INTO used_roc
        FROM rapporto
        WHERE anno = year
            AND id_impianto = system_id
            AND diritto_chiamata = 1
            AND id_rapporto <> report_id
            AND year <> anno
            AND IF(is_extra_ordinary, 2, dir_ric_chiamata) = dir_ric_chiamata;

        SET is_right_of_call_chargeble = IFNULL(included_roc, 0) < IFNULL(used_roc, 0);
    END IF;

    IF is_right_of_call_chargeble IS NULL THEN
        SET is_right_of_call_chargeble = 0;
    END IF;
	
	RETURN  is_right_of_call_chargeble;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_reportProductHasDepotLink
DELIMITER //
CREATE FUNCTION `fnc_reportProductHasDepotLink`(
    report_id INT,
    report_year INT,
    tab_id INT
) RETURNS bit(1)
BEGIN

	DECLARE has_depot_link BIT(1);

    SELECT COUNT(id_rapporto) > 0
        INTO has_depot_link
    FROM magazzino_rapporto_materiale
    WHERE id_rapporto = report_id
        AND anno_rapporto = report_year
        AND id_tab = tab_id;
	
	RETURN  has_depot_link;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_supplierInvoiceProductAllowDepotsScale
DELIMITER //
CREATE FUNCTION `fnc_supplierInvoiceProductAllowDepotsScale`(invoice_id INT, invoice_year INT, product_code VARCHAR(16)) RETURNS bit(1)
BEGIN

	DECLARE allow_insert BIT(1);

	-- CONTROL IF INVOICE TYPE = 5 (FATTURA ACCOMPAGNATORIA)
	SELECT 	movimenta_magazzino
				INTO allow_insert
	FROM  	fornfattura 
	WHERE 	(id_fattura=invoice_id AND anno=invoice_year); 
	
	-- CONTROL IF PRODUCT HAS CATEGORY THAT ALLOW DEPOSITS MOVEMENT
	IF (allow_insert = 1) THEN
		SELECT  fnc_productAllowDepotsScale(product_code)
			INTO allow_insert;
	END IF;
    
    IF allow_insert IS NULL THEN
        SET allow_insert = 0;
    END IF;
	
	RETURN  allow_insert;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_systemIsRightOfCallChargeable
DELIMITER //
CREATE FUNCTION `fnc_systemIsRightOfCallChargeable`(system_id INT(11), year INT(11), is_extra_ordinary BIT(1)) RETURNS bit(1)
BEGIN
	DECLARE is_right_of_call_chargeble BIT(1);
	DECLARE included_roc INT(11);
	DECLARE subscription_id INT(11);
	DECLARE used_roc INT(11);
	
    SELECT id_abbonamenti INTO subscription_id
    FROM impianto_abbonamenti
    WHERE id_impianto = system_id AND anno = year;

    IF subscription_id IS NOT NULL THEN
        SELECT IF(is_extra_ordinary, diritto_chiamata_straordinario_inclusa, diritto_chiamata_gratis) INTO included_roc
        FROM abbonamento
        WHERE id_abbonamento = subscription_id;

        SELECT COUNT(*) INTO used_roc
        FROM rapporto
        WHERE anno = year
            AND id_impianto = system_id
            AND diritto_chiamata = 1
            AND IF(is_extra_ordinary, 2, 1) = tipo_diritto_chiamata;

        SET is_right_of_call_chargeble = IFNULL(included_roc, 0) < IFNULL(used_roc, 0);
    END IF;

    IF is_right_of_call_chargeble IS NULL THEN
        SET is_right_of_call_chargeble = 0;
    END IF;
	
	RETURN  is_right_of_call_chargeble;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_systemIsRightOfCallChargeble
DELIMITER //
CREATE FUNCTION `fnc_systemIsRightOfCallChargeble`(system_id INT(11), year INT(11), is_extra_ordinary BIT(1)) RETURNS bit(1)
BEGIN
	DECLARE is_right_of_call_chargeble BIT(1);
	DECLARE included_roc INT(11);
	DECLARE subscription_id INT(11);
	DECLARE used_roc INT(11);
	
    SELECT id_abbonamenti INTO subscription_id
    FROM impianto_abbonamenti
    WHERE id_impianto = system_id AND anno = year;

    IF subscription_id IS NOT NULL THEN
        SELECT IF(is_extra_ordinary, diritto_chiamata_straordinario_inclusa, diritto_chiamata_gratis) INTO included_roc
        FROM abbonamento
        WHERE abbonamento = subscription_id;

        SELECT COUNT(*) INTO used_roc
        FROM rapporto
        WHERE anno = year
            AND id_impianto = system_id
            AND diritto_chiamata = 1
            AND IF(is_extra_ordinary, 2, dir_ric_chiamata) = dir_ric_chiamata;

        SET is_right_of_call_chargeble = IFNULL(included_roc, 0) < IFNULL(used_roc, 0);
    END IF;

    IF is_right_of_call_chargeble IS NULL THEN
        SET is_right_of_call_chargeble = 0;
    END IF;
	
	RETURN  is_right_of_call_chargeble;
	
END//
DELIMITER ;

-- Dump della struttura di funzione emmebi.fnc_userHasModuleAccess
DELIMITER //
CREATE FUNCTION `fnc_userHasModuleAccess`(user_id INT(11), module_name VARCHAR(100)) RETURNS bit(1)
BEGIN
	DECLARE val BIT(1) DEFAULT 0;
   CALL sp_userHasModuleAccess(user_id, module_name, val);
	RETURN  val;
	
END//
DELIMITER ;

-- Dump della struttura di tabella emmebi.fornfattura
CREATE TABLE IF NOT EXISTS `fornfattura` (
  `Id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_fornitore` int(11) NOT NULL,
  `Data_registrazione` date NOT NULL,
  `data_modifica` date NOT NULL,
  `data` date NOT NULL,
  `cond_pagamento` int(11) NOT NULL,
  `annotazioni` text NOT NULL,
  `Stato` int(11) NOT NULL,
  `causale_fattura` int(11) NOT NULL,
  `nota_interna` varchar(100) DEFAULT NULL,
  `tipo_fattura` int(11) NOT NULL,
  `incasso` decimal(11,2) NOT NULL DEFAULT '0.00',
  `bollo` decimal(11,2) NOT NULL DEFAULT '0.00',
  `trasporto` decimal(11,2) NOT NULL DEFAULT '0.00',
  `ricevuto` int(11) unsigned NOT NULL DEFAULT '0',
  `pagato_il` time DEFAULT NULL,
  `tramite` int(11) unsigned DEFAULT '0',
  `insoluto` int(11) unsigned NOT NULL DEFAULT '0',
  `fattura_fornitore` varchar(45) NOT NULL,
  `totale` decimal(11,2) NOT NULL DEFAULT '0.00',
  `totiva` decimal(11,2) NOT NULL DEFAULT '0.00',
  `scan` tinyint(4) DEFAULT '0',
  `modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `id_attività` int(11) DEFAULT NULL,
  `iva_incasso` int(10) unsigned NOT NULL DEFAULT '0',
  `iva_bollo` int(10) unsigned NOT NULL DEFAULT '0',
  `aliquota_iva_BTI` int(11) DEFAULT NULL,
  `formato_trasmissione` varchar(10) DEFAULT NULL,
  `codice_destinatario` varchar(10) DEFAULT NULL,
  `pec_destinatario` varchar(100) DEFAULT NULL,
  `progressivo_invio` varchar(20) DEFAULT NULL,
  `tipo_fattura_elettronica` varchar(5) DEFAULT NULL,
  `sorgente_documento` varchar(15) DEFAULT 'manuale',
  `e_fattura_filename` text,
  `movimenta_magazzino` bit(1) DEFAULT b'0',
  PRIMARY KEY (`Id_fattura`,`anno`),
  UNIQUE KEY `fattura_fornitore` (`fattura_fornitore`,`id_fornitore`,`anno`) USING BTREE,
  KEY `cond_pagamento` (`cond_pagamento`),
  KEY `anno` (`anno`),
  KEY `Stato` (`Stato`),
  KEY `causale_fattura` (`causale_fattura`),
  KEY `tipo_fattura` (`tipo_fattura`),
  KEY `id_cliente` (`id_fornitore`) USING BTREE,
  KEY `FK_fornfattura_3` (`id_attività`),
  CONSTRAINT `condizione` FOREIGN KEY (`cond_pagamento`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_fornfattura_3` FOREIGN KEY (`id_attività`) REFERENCES `tipo_attivita` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fornitore` FOREIGN KEY (`id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfatturaapp1
CREATE TABLE IF NOT EXISTS `fornfatturaapp1` (
  `id_listino` varchar(1) NOT NULL DEFAULT '',
  `nome` varchar(7) NOT NULL DEFAULT '',
  `prezzo` varchar(50) DEFAULT NULL,
  `netto` varchar(50) DEFAULT NULL,
  `ultimo` varchar(50) DEFAULT NULL,
  `percentuale` varchar(66) DEFAULT NULL,
  `id` varchar(1) NOT NULL DEFAULT '',
  `Tipo` varchar(7) NOT NULL DEFAULT '',
  `id_articolo` varchar(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfatturaapp10
CREATE TABLE IF NOT EXISTS `fornfatturaapp10` (
  `id_listino` varchar(1) NOT NULL DEFAULT '',
  `nome` varchar(7) NOT NULL DEFAULT '',
  `prezzo` varchar(50) DEFAULT NULL,
  `netto` varchar(50) DEFAULT NULL,
  `ultimo` varchar(50) DEFAULT NULL,
  `percentuale` varchar(66) DEFAULT NULL,
  `id` varchar(1) NOT NULL DEFAULT '',
  `Tipo` varchar(7) NOT NULL DEFAULT '',
  `id_articolo` varchar(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfatturaapp16
CREATE TABLE IF NOT EXISTS `fornfatturaapp16` (
  `id_listino` varchar(1) NOT NULL DEFAULT '',
  `nome` varchar(7) NOT NULL DEFAULT '',
  `prezzo` varchar(50) DEFAULT NULL,
  `netto` varchar(50) DEFAULT NULL,
  `ultimo` varchar(50) DEFAULT NULL,
  `percentuale` varchar(66) DEFAULT NULL,
  `id` varchar(1) NOT NULL DEFAULT '',
  `Tipo` varchar(7) NOT NULL DEFAULT '',
  `id_articolo` varchar(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfatturaapp6
CREATE TABLE IF NOT EXISTS `fornfatturaapp6` (
  `id_listino` varchar(1) NOT NULL DEFAULT '',
  `nome` varchar(7) NOT NULL DEFAULT '',
  `prezzo` varchar(50) DEFAULT NULL,
  `netto` varchar(50) DEFAULT NULL,
  `ultimo` varchar(50) DEFAULT NULL,
  `percentuale` varchar(66) DEFAULT NULL,
  `id` varchar(1) NOT NULL DEFAULT '',
  `Tipo` varchar(7) NOT NULL DEFAULT '',
  `id_articolo` varchar(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfattura_acconto
CREATE TABLE IF NOT EXISTS `fornfattura_acconto` (
  `id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_pagamento` int(11) NOT NULL,
  `importo` decimal(11,2) NOT NULL,
  `data` date DEFAULT NULL,
  `modo` int(11) DEFAULT NULL,
  `id_acconto` int(11) NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`id_acconto`),
  KEY `FK_fornfattura_acc` (`id_fattura`,`anno`),
  CONSTRAINT `FK_fornfattura_acc` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fornfattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=17 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfattura_allegati
CREATE TABLE IF NOT EXISTS `fornfattura_allegati` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_fattura` int(11) NOT NULL,
  `Anno_fattura` int(11) NOT NULL,
  `Nome` varchar(150) NOT NULL,
  `Algoritmo` varchar(10) DEFAULT NULL,
  `Formato` varchar(10) NOT NULL,
  `Descrizione` mediumtext,
  `File_path` varchar(250) NOT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  KEY `FK_fornfattura_allegati` (`Id_fattura`,`Anno_fattura`),
  CONSTRAINT `FK_fornfattura_allegati` FOREIGN KEY (`Id_fattura`, `Anno_fattura`) REFERENCES `fornfattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=2074 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfattura_articoli
CREATE TABLE IF NOT EXISTS `fornfattura_articoli` (
  `id_fattura` int(11) NOT NULL,
  `Anno` int(11) NOT NULL,
  `n_tab` int(11) NOT NULL,
  `Descrizione` text NOT NULL,
  `um` varchar(5) DEFAULT NULL,
  `quantità` decimal(11,4) DEFAULT NULL,
  `prezzo_unitario` decimal(11,4) DEFAULT NULL,
  `sconto` decimal(11,2) DEFAULT NULL,
  `costo` decimal(11,4) DEFAULT NULL,
  `serial_number` varchar(55) DEFAULT NULL,
  `id_materiale` varchar(13) DEFAULT NULL,
  `Iva` int(10) DEFAULT NULL,
  `codice_fornitore` varchar(45) DEFAULT NULL,
  `anno_rif` int(10) DEFAULT NULL,
  `id_rif` int(10) DEFAULT NULL,
  `tipo` char(10) DEFAULT NULL,
  `anomalo` tinyint(1) NOT NULL DEFAULT '0',
  `corretto` tinyint(1) NOT NULL DEFAULT '0',
  `id_nota` int(11) DEFAULT NULL,
  `corretto2` tinyint(4) NOT NULL DEFAULT '0',
  `riparazione` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`id_fattura`,`Anno`,`n_tab`),
  KEY `id_materiale` (`id_materiale`),
  KEY `Anno` (`Anno`),
  KEY `Index_4_nota` (`id_nota`),
  CONSTRAINT `art` FOREIGN KEY (`id_materiale`) REFERENCES `articolo` (`Codice_articolo`) ON UPDATE CASCADE,
  CONSTRAINT `fattura` FOREIGN KEY (`id_fattura`, `Anno`) REFERENCES `fornfattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_fornfattura_articoli_3_nota` FOREIGN KEY (`id_nota`) REFERENCES `nota` (`id_nota`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfattura_auto
CREATE TABLE IF NOT EXISTS `fornfattura_auto` (
  `id_fattura` int(10) NOT NULL AUTO_INCREMENT,
  `anno` int(10) unsigned NOT NULL,
  `id_automezzo` int(10) unsigned NOT NULL,
  PRIMARY KEY (`id_fattura`,`anno`,`id_automezzo`)
) ENGINE=InnoDB AUTO_INCREMENT=866 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfattura_auto_app
CREATE TABLE IF NOT EXISTS `fornfattura_auto_app` (
  `id_fattura` int(10) NOT NULL AUTO_INCREMENT,
  `anno` int(10) unsigned NOT NULL,
  `id_automezzo` int(10) unsigned NOT NULL,
  PRIMARY KEY (`id_fattura`,`anno`,`id_automezzo`)
) ENGINE=InnoDB AUTO_INCREMENT=819 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfattura_pagamenti
CREATE TABLE IF NOT EXISTS `fornfattura_pagamenti` (
  `id_fattura` int(11) NOT NULL AUTO_INCREMENT,
  `anno` int(11) NOT NULL,
  `nota` text,
  `data` date DEFAULT NULL,
  `id_pagamento` int(11) NOT NULL,
  `tipo_pagamento` int(11) NOT NULL,
  `insoluto` tinyint(4) DEFAULT NULL,
  `id_prima_nota` int(11) DEFAULT NULL,
  `anno_prima_nota` int(11) DEFAULT NULL,
  `id_trasferimento_verso` int(11) DEFAULT NULL,
  `anno_trasferimento_verso` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_fattura`,`anno`,`id_pagamento`) USING BTREE,
  KEY `Index_2for` (`id_fattura`,`anno`),
  KEY `Index_3_tipag` (`tipo_pagamento`),
  KEY `FK_fornfattura_pagamenti_prima_nota_trasf` (`id_trasferimento_verso`,`anno_trasferimento_verso`),
  KEY `FK_fornfattura_pagamenti_prima_nota` (`id_prima_nota`,`anno_prima_nota`),
  CONSTRAINT `FK_fornfattura_pagamenti_prima_nota` FOREIGN KEY (`id_prima_nota`, `anno_prima_nota`) REFERENCES `prima_nota` (`Id_prima_nota`, `anno`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_fornfattura_pagamenti_prima_nota_trasf` FOREIGN KEY (`id_trasferimento_verso`, `anno_trasferimento_verso`) REFERENCES `prima_nota` (`Id_prima_nota`, `anno`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_forn_fattura_pagamenti_1_for` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fornfattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_forn_fattura_pagamenti_2_tipo` FOREIGN KEY (`tipo_pagamento`) REFERENCES `tipo_pagamento` (`id_Tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=876 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornfattura_pagamenti_comunicazione
CREATE TABLE IF NOT EXISTS `fornfattura_pagamenti_comunicazione` (
  `id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_comunicazione` int(11) NOT NULL,
  `id_pagamento` int(11) NOT NULL,
  `nota` text,
  `tipo` int(11) DEFAULT NULL,
  `data` date DEFAULT NULL,
  `mail` int(11) DEFAULT NULL,
  `stato` int(11) DEFAULT '1',
  PRIMARY KEY (`id_fattura`,`anno`,`id_pagamento`,`id_comunicazione`) USING BTREE,
  KEY `Index_2_com` (`id_comunicazione`),
  KEY `Index_3_pag` (`id_pagamento`),
  CONSTRAINT `FK_forn_fattura_pagamenti_comunicazione_1_fatt` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fornfattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornitore
CREATE TABLE IF NOT EXISTS `fornitore` (
  `Id_fornitore` int(11) NOT NULL AUTO_INCREMENT,
  `Ragione_Sociale` varchar(100) DEFAULT NULL,
  `Ragione_Sociale2` varchar(100) DEFAULT NULL,
  `Partita_iva` varchar(17) DEFAULT NULL,
  `Codice_Fiscale` varchar(20) DEFAULT NULL,
  `Data_inserimento` date DEFAULT NULL,
  `Stato_Fornitore` varchar(10) DEFAULT NULL,
  `stato_economico` int(11) DEFAULT NULL,
  `condizione_pagamento` int(11) DEFAULT NULL,
  `Sito_internet` varchar(200) DEFAULT NULL,
  `password` varchar(20) DEFAULT NULL,
  `Utente_sito` varchar(60) DEFAULT NULL,
  `iva` int(11) DEFAULT NULL,
  `tipo_fornitore` int(10) unsigned DEFAULT NULL,
  `modi` tinyint(1) NOT NULL DEFAULT '0',
  `id_tiporapp` int(11) NOT NULL DEFAULT '1',
  `id_utente` int(11) DEFAULT NULL,
  `costruttore` varchar(5) DEFAULT NULL,
  `id_attività` int(11) DEFAULT NULL,
  `cod_fornitore` varchar(45) NOT NULL,
  PRIMARY KEY (`Id_fornitore`),
  KEY `condizione_pagamento` (`condizione_pagamento`),
  KEY `Stato_Fornitore` (`Stato_Fornitore`),
  KEY `stato_economico` (`stato_economico`),
  KEY `tiporap` (`id_tiporapp`),
  KEY `tipoiva` (`iva`),
  KEY `Index_7_ut` (`id_utente`),
  KEY `FK_fornitore_7` (`costruttore`),
  KEY `FK_fornitore_8` (`id_attività`),
  CONSTRAINT `FK_fornitore_6_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_fornitore_7` FOREIGN KEY (`costruttore`) REFERENCES `marca` (`Id_marca`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_fornitore_8` FOREIGN KEY (`id_attività`) REFERENCES `tipo_attivita` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_iva` FOREIGN KEY (`iva`) REFERENCES `tipo_iva` (`Id_iva`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fk_tiporap` FOREIGN KEY (`id_tiporapp`) REFERENCES `tipo_fornitore` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fornitore_ibfk_18` FOREIGN KEY (`Stato_Fornitore`) REFERENCES `stato_fornitore` (`Id_stato`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `fornitore_ibfk_19` FOREIGN KEY (`stato_economico`) REFERENCES `stato_economico` (`Id_stato`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `fornitore_ibfk_21` FOREIGN KEY (`condizione_pagamento`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=841 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornitore_articolo
CREATE TABLE IF NOT EXISTS `fornitore_articolo` (
  `Id_fornitore` int(11) NOT NULL,
  `Id_articolo` varchar(11) NOT NULL,
  `Codice_fornitore` varchar(50) DEFAULT NULL,
  `prezzo_listino` int(11) DEFAULT NULL,
  `Barcode` varchar(50) DEFAULT NULL,
  `Listino_clienti` int(11) DEFAULT NULL,
  `listino1` int(11) NOT NULL,
  `Ordinabile` tinyint(1) DEFAULT NULL,
  `Ult_data_acq` date DEFAULT NULL,
  PRIMARY KEY (`Id_fornitore`,`Id_articolo`),
  KEY `Id_articolo` (`Id_articolo`),
  CONSTRAINT `fornitore_articolo_ibfk_1` FOREIGN KEY (`Id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fornitore_articolo_ibfk_2` FOREIGN KEY (`Id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornitore_filiale
CREATE TABLE IF NOT EXISTS `fornitore_filiale` (
  `id_fornitore` int(10) NOT NULL AUTO_INCREMENT,
  `id_filiale` bigint(20) NOT NULL,
  `data_inizio` date NOT NULL,
  `data_fine` date DEFAULT NULL,
  `iban` varchar(45) NOT NULL,
  PRIMARY KEY (`id_fornitore`,`iban`,`id_filiale`) USING BTREE,
  KEY `filiale_bgfd` (`id_filiale`),
  CONSTRAINT `filiale_bgfd` FOREIGN KEY (`id_filiale`) REFERENCES `filiale` (`Id_filiale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `foni_filiale` FOREIGN KEY (`id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=824 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornitore_listino
CREATE TABLE IF NOT EXISTS `fornitore_listino` (
  `id_fornitore` int(11) NOT NULL,
  `id_listino` int(11) NOT NULL AUTO_INCREMENT,
  `acquisto` int(11) NOT NULL,
  `netto` int(11) NOT NULL,
  `Nome` varchar(60) NOT NULL,
  `Speciale` int(11) NOT NULL,
  `ultimo` int(11) NOT NULL,
  PRIMARY KEY (`id_listino`),
  KEY `id_fornitore` (`id_fornitore`,`acquisto`,`netto`),
  KEY `acquisto` (`acquisto`),
  KEY `netto` (`netto`),
  KEY `FK_fornitore_listino_speciale` (`Speciale`),
  KEY `FK_fornitore_listino_ultimo` (`ultimo`),
  CONSTRAINT `FK_fornitore_listino_acquisto` FOREIGN KEY (`acquisto`) REFERENCES `listino` (`Id_listino`) ON UPDATE CASCADE,
  CONSTRAINT `FK_fornitore_listino_netto` FOREIGN KEY (`netto`) REFERENCES `listino` (`Id_listino`) ON UPDATE CASCADE,
  CONSTRAINT `FK_fornitore_listino_speciale` FOREIGN KEY (`Speciale`) REFERENCES `listino` (`Id_listino`) ON UPDATE CASCADE,
  CONSTRAINT `FK_fornitore_listino_ultimo` FOREIGN KEY (`ultimo`) REFERENCES `listino` (`Id_listino`) ON UPDATE CASCADE,
  CONSTRAINT `fornitore_listino_ibfk_2` FOREIGN KEY (`id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=679 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornitore_marca
CREATE TABLE IF NOT EXISTS `fornitore_marca` (
  `Id_fornitore` int(11) NOT NULL,
  `Id_marca` varchar(3) NOT NULL,
  `Scontistica` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_fornitore`,`Id_marca`),
  KEY `Id_marca` (`Id_marca`),
  CONSTRAINT `fornitore_marca_ibfk_1` FOREIGN KEY (`Id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fornitore_marca_ibfk_2` FOREIGN KEY (`Id_marca`) REFERENCES `marca` (`Id_marca`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornitore_nota
CREATE TABLE IF NOT EXISTS `fornitore_nota` (
  `id_fornitore` int(11) NOT NULL,
  `nota` text NOT NULL,
  `id_nota` int(11) NOT NULL,
  `data_ult_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_fornitore`,`id_nota`) USING BTREE,
  KEY `forn_notb` (`id_nota`) USING BTREE,
  CONSTRAINT `FK_fornitore_nota_1` FOREIGN KEY (`id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_fornitore_nota_2` FOREIGN KEY (`id_nota`) REFERENCES `fornitore_note_descrizione` (`id_nota`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornitore_note_descrizione
CREATE TABLE IF NOT EXISTS `fornitore_note_descrizione` (
  `id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `descrizione` varchar(45) NOT NULL,
  PRIMARY KEY (`id_nota`)
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.fornitore_ragione_sociale
CREATE TABLE IF NOT EXISTS `fornitore_ragione_sociale` (
  `id_fornitore` int(10) unsigned NOT NULL,
  `ragione_sociale` varchar(45) NOT NULL,
  `data_inizio` date NOT NULL,
  `data_fine` date NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.frazione
CREATE TABLE IF NOT EXISTS `frazione` (
  `Id_frazione` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Id_comune` int(11) NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`Id_frazione`),
  UNIQUE KEY `Index_3` (`Nome`,`Id_comune`),
  KEY `Id_comune` (`Id_comune`),
  CONSTRAINT `frazione_ibfk_1` FOREIGN KEY (`Id_comune`) REFERENCES `comune` (`Id_comune`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=654 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.giorni
CREATE TABLE IF NOT EXISTS `giorni` (
  `Id_giorno` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(10) NOT NULL,
  PRIMARY KEY (`Id_giorno`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto
CREATE TABLE IF NOT EXISTS `impianto` (
  `Id_impianto` int(11) NOT NULL AUTO_INCREMENT,
  `Id_cliente` int(11) NOT NULL,
  `Id_gestore` int(11) NOT NULL,
  `Id_occupante` int(11) NOT NULL,
  `Data_Funzione` date DEFAULT NULL,
  `Data_terminazione` date DEFAULT NULL,
  `altro` varchar(15) DEFAULT NULL,
  `Abbonamento` int(11) DEFAULT NULL,
  `Tipo_impianto` int(11) DEFAULT NULL,
  `Stato` int(11) DEFAULT NULL,
  `scadenza_garanzia` date DEFAULT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `Destinazione` int(11) NOT NULL,
  `Tempo_manutenzione` float(11,0) NOT NULL DEFAULT '0',
  `Costo_Manutenzione` float(11,2) DEFAULT '0.00',
  `Data_registrazione` date DEFAULT NULL,
  `Persone` int(11) DEFAULT NULL,
  `Data_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `CONTR` tinyint(4) NOT NULL DEFAULT '0',
  `sub` tinyint(4) DEFAULT '0',
  `orario_prog` int(11) DEFAULT '0',
  `id_utente` int(11) DEFAULT NULL,
  `auto` tinyint(4) DEFAULT '0',
  `condizione` int(11) DEFAULT NULL,
  `eta` int(11) DEFAULT NULL,
  `stato_invio_doc` varchar(15) DEFAULT 'clblue',
  `data_invio_doc` date DEFAULT NULL,
  `checklist` tinyint(1) NOT NULL DEFAULT '0',
  `centrale` varchar(11) DEFAULT NULL,
  `gsm` varchar(11) DEFAULT NULL,
  `combinatore_telefonico` varchar(11) DEFAULT NULL,
  `flag_abbonamento` tinyint(1) unsigned DEFAULT NULL,
  `flag_abbonamento_anno` int(4) unsigned DEFAULT NULL,
  `data_promemoria_garanzia` datetime DEFAULT NULL,
  `data_ultimo_promemoria_garanzia` datetime DEFAULT NULL,
  `id_stato_promemoria_garanzia` int(11) NOT NULL DEFAULT '1',
  PRIMARY KEY (`Id_impianto`),
  KEY `Abbonamento` (`Abbonamento`),
  KEY `Tipo_impianto` (`Tipo_impianto`),
  KEY `Stato` (`Stato`),
  KEY `Destinazione` (`Destinazione`),
  KEY `Id_cliente` (`Id_cliente`,`Id_gestore`,`Id_occupante`),
  KEY `Id_gestore` (`Id_gestore`),
  KEY `Id_occupante` (`Id_occupante`),
  KEY `dest1` (`Id_cliente`,`Destinazione`),
  KEY `Index_10_ut` (`id_utente`),
  KEY `condi` (`condizione`),
  KEY `Fk_impianto_combinatore_telefonico` (`combinatore_telefonico`),
  KEY `Fk_impianto_gsm` (`gsm`),
  KEY `Fk_impianto_centrale` (`centrale`),
  KEY `impianto_stato_invio_abbonamento` (`stato_invio_doc`),
  KEY `FK_impianto_stato_promemoria_garanzia_cliente` (`id_stato_promemoria_garanzia`),
  CONSTRAINT `condi` FOREIGN KEY (`condizione`) REFERENCES `impianto_condizioni` (`id_condizione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `dest1` FOREIGN KEY (`Id_cliente`, `Destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_7_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `Fk_impianto_centrale` FOREIGN KEY (`centrale`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE SET NULL ON UPDATE SET NULL,
  CONSTRAINT `Fk_impianto_combinatore_telefonico` FOREIGN KEY (`combinatore_telefonico`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE SET NULL ON UPDATE SET NULL,
  CONSTRAINT `Fk_impianto_gsm` FOREIGN KEY (`gsm`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE SET NULL ON UPDATE SET NULL,
  CONSTRAINT `FK_impianto_stato_promemoria_garanzia_cliente` FOREIGN KEY (`id_stato_promemoria_garanzia`) REFERENCES `stato_promemoria_cliente` (`id`),
  CONSTRAINT `impianto_ibfk_11` FOREIGN KEY (`Tipo_impianto`) REFERENCES `tipo_impianto` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `impianto_ibfk_12` FOREIGN KEY (`Stato`) REFERENCES `stato_impianto` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `impianto_ibfk_14` FOREIGN KEY (`Id_gestore`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `impianto_ibfk_16` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `impianto_ibfk_17` FOREIGN KEY (`Id_occupante`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `impianto_stato_invio_abbonamento` FOREIGN KEY (`stato_invio_doc`) REFERENCES `stato_invio_abbonamento` (`colore`) ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=5668 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_abbonamenti
CREATE TABLE IF NOT EXISTS `impianto_abbonamenti` (
  `Id_impianto` int(11) NOT NULL,
  `Id_abbonamenti` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `data_ultima_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id_impianto`,`anno`) USING BTREE,
  KEY `Id_abbonamenti` (`Id_abbonamenti`),
  KEY `abbo` (`Id_impianto`,`Id_abbonamenti`,`anno`),
  CONSTRAINT `abb` FOREIGN KEY (`Id_abbonamenti`) REFERENCES `abbonamento` (`Id_abbonamento`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_abbonamenti_2` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_abbonamenti_cliente_im
CREATE TABLE IF NOT EXISTS `impianto_abbonamenti_cliente_im` (
  `id_cliente` int(11) NOT NULL,
  `importo` float NOT NULL,
  `mese` int(11) NOT NULL,
  `tipo` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_fattura` int(11) DEFAULT NULL,
  `anno_fattura` int(11) DEFAULT '0',
  `fatturato` tinyint(4) DEFAULT '0',
  PRIMARY KEY (`id_cliente`,`tipo`,`anno`) USING BTREE,
  KEY `mes` (`mese`),
  CONSTRAINT `Imp_clie` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `mes` FOREIGN KEY (`mese`) REFERENCES `mese` (`Id_mese`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_abbonamenti_importi
CREATE TABLE IF NOT EXISTS `impianto_abbonamenti_importi` (
  `id_impianto` int(11) NOT NULL DEFAULT '0',
  `importo` float NOT NULL,
  `mese` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `tipo` int(11) NOT NULL,
  `fatturato` tinyint(4) NOT NULL DEFAULT '0',
  `id_Fattura` int(11) DEFAULT NULL,
  `anno_fattura` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_impianto`,`anno`,`tipo`) USING BTREE,
  KEY `mese` (`mese`),
  KEY `tipob` (`tipo`),
  CONSTRAINT `impian` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `imp_abbo` FOREIGN KEY (`id_impianto`, `anno`) REFERENCES `impianto_abbonamenti` (`Id_impianto`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `mese` FOREIGN KEY (`mese`) REFERENCES `mese` (`Id_mese`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `tipob` FOREIGN KEY (`tipo`) REFERENCES `tipo_impabbo` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_abbonamenti_mesi
CREATE TABLE IF NOT EXISTS `impianto_abbonamenti_mesi` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `impianto` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `abbonamenti` int(11) NOT NULL,
  `mese` int(11) NOT NULL DEFAULT '0',
  `Eseguito_il` date DEFAULT NULL,
  `Id_rapp` bigint(11) DEFAULT NULL,
  `anno_rapp` int(11) DEFAULT NULL,
  `da_eseguire` date DEFAULT NULL,
  `prezzo` decimal(10,2) DEFAULT NULL,
  `nota_mese` text,
  `modifica_mese` int(11) DEFAULT NULL,
  `modifica_anno` int(11) DEFAULT NULL,
  `data_promemoria` datetime DEFAULT NULL,
  `data_ultimo_promemoria` datetime DEFAULT NULL,
  `id_stato_promemoria` int(11) NOT NULL DEFAULT '1',
  PRIMARY KEY (`impianto`,`anno`,`mese`) USING BTREE,
  UNIQUE KEY `Id` (`Id`),
  KEY `mese` (`mese`),
  KEY `abbonamenti` (`abbonamenti`),
  KEY `impianto_abbonamenti_mesi_ibfk_4` (`Id_rapp`,`anno`),
  KEY `mese_abbo` (`impianto`,`abbonamenti`,`anno`),
  KEY `Id_rapp` (`Id_rapp`,`anno_rapp`) USING BTREE,
  KEY `an_rap` (`anno_rapp`),
  KEY `FK_impianto_abbonamenti_mesi_stato_promemoria_cliente` (`id_stato_promemoria`),
  CONSTRAINT `abbona` FOREIGN KEY (`abbonamenti`) REFERENCES `abbonamento` (`Id_abbonamento`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_abbonamenti_mesi_stato_promemoria_cliente` FOREIGN KEY (`id_stato_promemoria`) REFERENCES `stato_promemoria_cliente` (`id`),
  CONSTRAINT `impianto_abbonamenti_mesi_ibfk_3` FOREIGN KEY (`mese`) REFERENCES `mese` (`Id_mese`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `imp_Ab` FOREIGN KEY (`impianto`, `anno`) REFERENCES `impianto_abbonamenti` (`Id_impianto`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `rappo` FOREIGN KEY (`Id_rapp`, `anno_rapp`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=5406 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_abbonamento_articolo
CREATE TABLE IF NOT EXISTS `impianto_abbonamento_articolo` (
  `id_impianto` int(11) NOT NULL,
  `abbonamento` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_articolo` varchar(15) NOT NULL,
  `qt` decimal(11,2) NOT NULL,
  `prezzo` decimal(11,2) NOT NULL,
  PRIMARY KEY (`id_impianto`,`anno`,`id_articolo`) USING BTREE,
  KEY `imp_fk` (`id_impianto`,`abbonamento`,`anno`) USING BTREE,
  KEY `FK_impianto_abbonamento_articolo_2` (`abbonamento`,`id_impianto`,`anno`),
  KEY `FK_impianto_abbonamento_articolo_3` (`id_articolo`),
  CONSTRAINT `FK_impianto_abbonamento_articolo_2` FOREIGN KEY (`abbonamento`, `id_impianto`, `anno`) REFERENCES `impianto_abbonamenti` (`Id_abbonamenti`, `Id_impianto`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_abbonamento_articolo_3` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_attrezzatura
CREATE TABLE IF NOT EXISTS `impianto_attrezzatura` (
  `id_impianto` int(11) NOT NULL,
  `id_attr` varchar(13) NOT NULL,
  `qt` int(11) NOT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_impianto`,`id_attr`) USING BTREE,
  KEY `FK_impianto_attrezzatura_1` (`id_attr`),
  CONSTRAINT `FK_impianto_attrezzatura_1` FOREIGN KEY (`id_attr`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_box
CREATE TABLE IF NOT EXISTS `impianto_box` (
  `Id_impianto` int(11) NOT NULL,
  `Id_box` int(11) NOT NULL,
  `Descrizione` varchar(30) DEFAULT NULL,
  `Note` mediumtext,
  PRIMARY KEY (`Id_impianto`,`Id_box`),
  KEY `Id_box` (`Id_box`),
  CONSTRAINT `impianto_box_ibfk_1` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_box_componenti
CREATE TABLE IF NOT EXISTS `impianto_box_componenti` (
  `Id_impianto` int(11) NOT NULL,
  `Id_box` int(11) NOT NULL,
  `Id_componente` varchar(13) NOT NULL,
  `id` int(11) NOT NULL,
  PRIMARY KEY (`Id_impianto`,`Id_box`) USING BTREE,
  KEY `Id_componente` (`Id_componente`),
  KEY `Id_box` (`Id_box`),
  KEY `Serial_number` (`id`) USING BTREE,
  KEY `compo` (`Id_impianto`,`Id_componente`,`id`),
  KEY `impianto_box_componenti_ibfk_4` (`Id_box`,`Id_impianto`),
  CONSTRAINT `impianto_box_componenti_ibfk_1` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `impianto_box_componenti_ibfk_4` FOREIGN KEY (`Id_box`, `Id_impianto`) REFERENCES `impianto_box` (`Id_box`, `Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_cliente
CREATE TABLE IF NOT EXISTS `impianto_cliente` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_impianto` int(11) NOT NULL,
  `Id_cliente` int(11) NOT NULL,
  `Id_impianto_figura` int(11) NOT NULL,
  `Data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` int(11) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_impianto_Id_cliente_Id_impianto_figura` (`Id_impianto`,`Id_cliente`,`Id_impianto_figura`),
  KEY `fk-impianto_cliente-clienti` (`Id_cliente`),
  KEY `fk-impainto_cliente-impianto_figura` (`Id_impianto_figura`),
  CONSTRAINT `fk-impainto_cliente-impianto_figura` FOREIGN KEY (`Id_impianto_figura`) REFERENCES `impianto_figura` (`Id_figura`),
  CONSTRAINT `fk-impianto_cliente-clienti` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`),
  CONSTRAINT `fk-impianto_cliente-impianto` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_cliente_storico
CREATE TABLE IF NOT EXISTS `impianto_cliente_storico` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_impianto` int(11) NOT NULL,
  `Id_cliente` int(11) NOT NULL,
  `Data_Inizio` datetime NOT NULL,
  `Data_fine` datetime NOT NULL,
  `Figura` int(11) NOT NULL,
  `Utente_ins` int(11) NOT NULL,
  `Data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  KEY `Id_impianto` (`Id_impianto`,`Id_cliente`),
  KEY `Id_cliente` (`Id_cliente`),
  KEY `Figura` (`Figura`),
  CONSTRAINT `impianto_cliente_storico_ibfk_1` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `impianto_cliente_storico_ibfk_2` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `impianto_cliente_storico_ibfk_3` FOREIGN KEY (`Figura`) REFERENCES `impianto_figura` (`Id_figura`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=998 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_componenti
CREATE TABLE IF NOT EXISTS `impianto_componenti` (
  `id_impianto_componenti` int(11) NOT NULL AUTO_INCREMENT,
  `Id_impianto` int(11) NOT NULL,
  `Id_articolo` varchar(13) NOT NULL,
  `Data_scadenza` date DEFAULT NULL,
  `data_installazione` date DEFAULT NULL,
  `fine_Garanzia` date DEFAULT NULL,
  `id` int(11) NOT NULL DEFAULT '0',
  `data_dismesso` date DEFAULT NULL,
  `BOX` int(11) DEFAULT NULL,
  `checked` int(11) NOT NULL DEFAULT '0',
  `garanzia_fornitore` date DEFAULT NULL,
  `data_fine` date DEFAULT NULL,
  `ora_inizio` time DEFAULT NULL,
  `ora_fine` time DEFAULT NULL,
  `stato` tinyint(4) DEFAULT '1',
  `tipo_evento` int(11) NOT NULL DEFAULT '1',
  `id_versione` int(11) DEFAULT NULL,
  `data_inizio` date DEFAULT NULL,
  `data_promemoria` datetime DEFAULT NULL,
  `data_ultimo_promemoria` datetime DEFAULT NULL,
  `id_stato_promemoria` int(11) NOT NULL DEFAULT '1',
  PRIMARY KEY (`Id_impianto`,`Id_articolo`,`id`),
  UNIQUE KEY `id_impianto_componenti` (`id_impianto_componenti`),
  KEY `Id_articolo` (`Id_articolo`),
  KEY `fk_impianto_componenti_versione` (`id_versione`),
  KEY `FK_impianto_componenti_stato_promemoria_cliente` (`id_stato_promemoria`),
  CONSTRAINT `FK_impianto_componenti_stato_promemoria_cliente` FOREIGN KEY (`id_stato_promemoria`) REFERENCES `stato_promemoria_cliente` (`id`),
  CONSTRAINT `fk_impianto_componenti_versione` FOREIGN KEY (`id_versione`) REFERENCES `impianto_componenti_versione` (`id_versione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `impianto_componenti_ibfk_2` FOREIGN KEY (`Id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=36944 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_componenti_codice
CREATE TABLE IF NOT EXISTS `impianto_componenti_codice` (
  `id_impianto` int(11) NOT NULL,
  `id_articolo` varchar(13) NOT NULL,
  `codice` int(11) NOT NULL,
  `seriale` varchar(150) NOT NULL,
  `tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_impianto`,`id_articolo`,`codice`,`tipo`) USING BTREE,
  KEY `tip_cod_ar` (`tipo`),
  CONSTRAINT `impian_ser` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `imp_ar_cod` FOREIGN KEY (`id_impianto`, `id_articolo`, `codice`) REFERENCES `impianto_componenti` (`Id_impianto`, `Id_articolo`, `id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `tip_cod_ar` FOREIGN KEY (`tipo`) REFERENCES `tipo_serial_number` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_componenti_ddt
CREATE TABLE IF NOT EXISTS `impianto_componenti_ddt` (
  `id_impianto` int(11) NOT NULL,
  `id_articolo` varchar(13) NOT NULL,
  `codice` int(11) NOT NULL,
  `id_ddt` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  PRIMARY KEY (`id_impianto`,`id_articolo`,`codice`,`id_ddt`,`anno`,`id_tab`) USING BTREE,
  KEY `FK_impianto_componenti_ddt_2` (`id_ddt`,`anno`,`id_tab`),
  CONSTRAINT `FK_impianto_componenti_ddt_1` FOREIGN KEY (`id_impianto`, `id_articolo`, `codice`) REFERENCES `impianto_componenti` (`Id_impianto`, `Id_articolo`, `id`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `FK_impianto_componenti_ddt_2` FOREIGN KEY (`id_ddt`, `anno`, `id_tab`) REFERENCES `articoli_ddt` (`id_ddt`, `anno`, `numero_tab`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_componenti_indirizzi
CREATE TABLE IF NOT EXISTS `impianto_componenti_indirizzi` (
  `id_host` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `id_articolo` varchar(13) NOT NULL,
  `codice` int(11) NOT NULL,
  `host` varchar(25) NOT NULL,
  `descrizione` varchar(50) NOT NULL,
  `id_impianto` int(11) NOT NULL,
  PRIMARY KEY (`id_host`,`id_articolo`,`codice`,`id_impianto`) USING BTREE,
  KEY `imp_comp` (`id_impianto`,`id_articolo`,`codice`),
  CONSTRAINT `imp_comp` FOREIGN KEY (`id_impianto`, `id_articolo`, `codice`) REFERENCES `impianto_componenti` (`Id_impianto`, `Id_articolo`, `id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_componenti_password
CREATE TABLE IF NOT EXISTS `impianto_componenti_password` (
  `id_impianto` int(11) NOT NULL,
  `id_articolo` varchar(13) NOT NULL,
  `codice` int(11) NOT NULL,
  `password` varchar(45) NOT NULL,
  `utente` varchar(50) NOT NULL,
  `proprietario` varchar(50) NOT NULL,
  PRIMARY KEY (`id_impianto`,`id_articolo`,`codice`,`proprietario`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_componenti_porte
CREATE TABLE IF NOT EXISTS `impianto_componenti_porte` (
  `id_porta` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `id_impianto` int(11) NOT NULL,
  `codice` int(11) NOT NULL,
  `id_articolo` varchar(13) NOT NULL,
  `porta` int(11) NOT NULL,
  `tipo` varchar(10) NOT NULL,
  `id_indirizzo` bigint(20) unsigned NOT NULL,
  PRIMARY KEY (`id_porta`,`id_impianto`,`id_articolo`,`codice`,`id_indirizzo`,`tipo`,`porta`) USING BTREE,
  KEY `FK_impianto_componenti_porte_1` (`id_impianto`,`id_articolo`,`codice`),
  KEY `ind` (`id_indirizzo`,`id_articolo`,`codice`,`id_impianto`),
  CONSTRAINT `FK_impianto_componenti_porte_1` FOREIGN KEY (`id_impianto`, `id_articolo`, `codice`) REFERENCES `impianto_componenti` (`Id_impianto`, `Id_articolo`, `id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `ind` FOREIGN KEY (`id_indirizzo`, `id_articolo`, `codice`, `id_impianto`) REFERENCES `impianto_componenti_indirizzi` (`id_host`, `id_articolo`, `codice`, `id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_componenti_sostituiti
CREATE TABLE IF NOT EXISTS `impianto_componenti_sostituiti` (
  `id_impianto` int(11) NOT NULL,
  `id_articolo` varchar(13) NOT NULL,
  `codice` int(11) NOT NULL,
  `id_articolo_s` varchar(13) NOT NULL,
  `codice_s` int(11) NOT NULL,
  PRIMARY KEY (`id_impianto`,`id_articolo`,`codice`,`codice_s`,`id_articolo_s`),
  KEY `sostituito` (`id_impianto`,`id_articolo_s`,`codice_s`),
  CONSTRAINT `sost` FOREIGN KEY (`id_impianto`, `id_articolo`, `codice`) REFERENCES `impianto_componenti` (`Id_impianto`, `Id_articolo`, `id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `sostituito` FOREIGN KEY (`id_impianto`, `id_articolo_s`, `codice_s`) REFERENCES `impianto_componenti` (`Id_impianto`, `Id_articolo`, `id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_componenti_versione
CREATE TABLE IF NOT EXISTS `impianto_componenti_versione` (
  `id_versione` int(11) NOT NULL AUTO_INCREMENT,
  `codice` int(11) NOT NULL,
  `id_articolo` varchar(13) NOT NULL,
  `versione` varchar(45) NOT NULL,
  `data` date NOT NULL,
  `id_impianto` int(11) NOT NULL,
  PRIMARY KEY (`id_versione`,`id_impianto`,`id_articolo`,`codice`),
  KEY `ver` (`id_impianto`,`id_articolo`,`codice`),
  CONSTRAINT `ver` FOREIGN KEY (`id_impianto`, `id_articolo`, `codice`) REFERENCES `impianto_componenti` (`Id_impianto`, `Id_articolo`, `id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_condizioni
CREATE TABLE IF NOT EXISTS `impianto_condizioni` (
  `id_condizione` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_condizione`),
  UNIQUE KEY `Index_2` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_descrizioni
CREATE TABLE IF NOT EXISTS `impianto_descrizioni` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_impianto` int(11) NOT NULL,
  `Descrizione` varchar(100) NOT NULL,
  `Data_inizio` datetime NOT NULL,
  `data_fine` datetime NOT NULL,
  `Utente_ins` int(11) NOT NULL,
  `Data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  KEY `Id_impianto` (`Id_impianto`),
  CONSTRAINT `impianto_descrizioni_ibfk_1` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=1704 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_etichetta
CREATE TABLE IF NOT EXISTS `impianto_etichetta` (
  `id` int(11) NOT NULL DEFAULT '1',
  `foto` int(11) NOT NULL DEFAULT '1',
  `titolo` varchar(150) DEFAULT NULL,
  `numero` varchar(45) DEFAULT NULL,
  `testo` text,
  `tel` int(11) NOT NULL DEFAULT '0',
  `intestazione` text,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_etichetta_parametri
CREATE TABLE IF NOT EXISTS `impianto_etichetta_parametri` (
  `parametro` varchar(150) NOT NULL,
  `pos` int(11) NOT NULL,
  PRIMARY KEY (`pos`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_figura
CREATE TABLE IF NOT EXISTS `impianto_figura` (
  `Id_figura` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(200) NOT NULL,
  PRIMARY KEY (`Id_figura`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_mesi
CREATE TABLE IF NOT EXISTS `impianto_mesi` (
  `Id_impianto` int(11) NOT NULL,
  `Id_mese` int(11) NOT NULL,
  PRIMARY KEY (`Id_impianto`,`Id_mese`),
  KEY `Id_mese` (`Id_mese`),
  CONSTRAINT `impianto_mesi_ibfk_1` FOREIGN KEY (`Id_mese`) REFERENCES `mese` (`Id_mese`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `impianto_mesi_ibfk_2` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_note
CREATE TABLE IF NOT EXISTS `impianto_note` (
  `Id_impianto` int(11) NOT NULL,
  `Id_nota` int(11) NOT NULL,
  `Testo` longtext,
  `data_ult_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id_impianto`,`Id_nota`),
  KEY `Id_nota` (`Id_nota`),
  CONSTRAINT `impianto_note_ibfk_1` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `impianto_note_ibfk_3` FOREIGN KEY (`Id_nota`) REFERENCES `impianto_note_descrizione` (`Id_descrizione`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_note_descrizione
CREATE TABLE IF NOT EXISTS `impianto_note_descrizione` (
  `Id_descrizione` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(100) NOT NULL,
  PRIMARY KEY (`Id_descrizione`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=318 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_operazione
CREATE TABLE IF NOT EXISTS `impianto_operazione` (
  `id_operazione` int(11) NOT NULL,
  `id_impianto` int(11) NOT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_operazione`,`id_impianto`),
  KEY `imp_op` (`id_impianto`),
  CONSTRAINT `imp_op` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `oper_imp` FOREIGN KEY (`id_operazione`) REFERENCES `operazioni_articoli` (`id_operazione`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_reperibilita
CREATE TABLE IF NOT EXISTS `impianto_reperibilita` (
  `anno` int(11) NOT NULL,
  `id_impianto` int(11) NOT NULL AUTO_INCREMENT,
  `reperibilita` tinyint(1) NOT NULL,
  `id_rapporto` bigint(20) NOT NULL,
  PRIMARY KEY (`anno`,`id_impianto`,`id_rapporto`) USING BTREE,
  KEY `FK_impianto_reperibilita_1` (`id_rapporto`,`anno`),
  KEY `FK_impianto_reperibilita_2` (`id_impianto`),
  CONSTRAINT `FK_impianto_reperibilita_1` FOREIGN KEY (`id_rapporto`, `anno`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_reperibilita_2` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=5600 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_ricambio
CREATE TABLE IF NOT EXISTS `impianto_ricambio` (
  `id_impianto` int(11) NOT NULL,
  `id_ricambio` varchar(13) NOT NULL,
  `qt` int(11) NOT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_impianto`,`id_ricambio`),
  KEY `FK_impianto_ricambio_1` (`id_ricambio`),
  CONSTRAINT `FK_impianto_ricambio_1` FOREIGN KEY (`id_ricambio`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_ricambio_2` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_ricarica
CREATE TABLE IF NOT EXISTS `impianto_ricarica` (
  `id_ricarica` int(10) NOT NULL AUTO_INCREMENT,
  `importo` decimal(10,2) NOT NULL DEFAULT '0.00',
  `data` date NOT NULL,
  `scadenza` date DEFAULT '0000-00-00',
  `descrizione` text,
  `tipo_ricarica` int(11) NOT NULL,
  `impianto` int(11) NOT NULL,
  PRIMARY KEY (`id_ricarica`,`impianto`) USING BTREE,
  KEY `FK_impianto_ricarica_1_tipo` (`tipo_ricarica`),
  KEY `FK_impianto_ricarica_2_impianto` (`impianto`),
  KEY `FK_impianto_ricarica_3` (`impianto`,`tipo_ricarica`),
  CONSTRAINT `FK_impianto_ricarica_2` FOREIGN KEY (`tipo_ricarica`) REFERENCES `tipo_ricarica` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_ricarica_2_impianto` FOREIGN KEY (`impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_ricarica_3` FOREIGN KEY (`impianto`, `tipo_ricarica`) REFERENCES `impianto_ricarica_tipo` (`id_impianto`, `tipo_ricarica`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_ricarica_tipo
CREATE TABLE IF NOT EXISTS `impianto_ricarica_tipo` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_impianto` int(11) NOT NULL,
  `tipo_ricarica` int(11) NOT NULL,
  `nota` text,
  `importo` double(11,2) DEFAULT '0.00',
  `durata` int(11) DEFAULT NULL,
  `numero` varchar(45) DEFAULT NULL,
  `intestatario` varchar(45) DEFAULT NULL,
  `acarico` varchar(45) DEFAULT NULL,
  `data_attivazione` date DEFAULT NULL,
  `data_rinnovo` date DEFAULT NULL,
  `data_scadenza` date DEFAULT NULL,
  `data_promemoria` datetime DEFAULT NULL,
  `data_ultimo_promemoria` datetime DEFAULT NULL,
  `id_stato_promemoria` int(11) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id_impianto`,`tipo_ricarica`),
  UNIQUE KEY `id` (`id`),
  KEY `FK_impianto_ricarica_tipo_stato_promemoria_cliente` (`id_stato_promemoria`),
  CONSTRAINT `FK_impianto_ricarica_tipo_impianto` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_ricarica_tipo_stato_promemoria_cliente` FOREIGN KEY (`id_stato_promemoria`) REFERENCES `stato_promemoria_cliente` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=70 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_riferimento
CREATE TABLE IF NOT EXISTS `impianto_riferimento` (
  `id_impianto` int(11) NOT NULL,
  `id_riferimento` int(11) NOT NULL,
  `id_cliente` int(11) NOT NULL,
  `tipo` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_impianto`,`id_riferimento`,`id_cliente`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_sottoimp
CREATE TABLE IF NOT EXISTS `impianto_sottoimp` (
  `id_impianto` int(11) NOT NULL,
  `id_sotto` int(11) NOT NULL,
  `livello` int(11) DEFAULT '0',
  PRIMARY KEY (`id_impianto`,`id_sotto`),
  KEY `imp_sub` (`id_sotto`),
  CONSTRAINT `imp_prin` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `imp_sub` FOREIGN KEY (`id_sotto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_tecnico
CREATE TABLE IF NOT EXISTS `impianto_tecnico` (
  `id_impianto` int(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  PRIMARY KEY (`id_impianto`,`id_operaio`),
  KEY `FK_impianto_tecnico_2_ope` (`id_operaio`),
  CONSTRAINT `FK_impianto_tecnico_1_imp` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_impianto_tecnico_2_ope` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_uscita
CREATE TABLE IF NOT EXISTS `impianto_uscita` (
  `id_impianto` int(11) NOT NULL,
  `id_abbonamento` int(11) NOT NULL,
  `Prima_ora` float(11,2) NOT NULL DEFAULT '0.00',
  `diritto_chiamata` int(11) NOT NULL DEFAULT '0',
  `diritto_chiamata_straordinario` int(11) NOT NULL DEFAULT '0',
  `Reperibilità` int(11) DEFAULT '0',
  `Ore` int(11) NOT NULL DEFAULT '0',
  `Ore_straordinarie` int(11) NOT NULL DEFAULT '0',
  `Teleassistenza` int(11) NOT NULL DEFAULT '0',
  `anno` int(11) NOT NULL,
  `Importo_abbonamento` float(11,2) NOT NULL DEFAULT '0.00',
  `Manutenzione` float(11,2) NOT NULL DEFAULT '0.00',
  PRIMARY KEY (`id_impianto`,`id_abbonamento`,`anno`),
  KEY `id_abbonamento` (`id_abbonamento`),
  CONSTRAINT `ab` FOREIGN KEY (`id_abbonamento`) REFERENCES `abbonamento` (`Id_abbonamento`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `impianto_uscita_ibfk_1` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `imp_abb` FOREIGN KEY (`id_impianto`, `id_abbonamento`, `anno`) REFERENCES `impianto_abbonamenti` (`Id_impianto`, `Id_abbonamenti`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_uscita_articolo
CREATE TABLE IF NOT EXISTS `impianto_uscita_articolo` (
  `Impianto` int(11) NOT NULL,
  `articolo` varchar(11) NOT NULL,
  `quantità` int(11) NOT NULL,
  `abbonamento` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  PRIMARY KEY (`Impianto`,`articolo`,`abbonamento`),
  KEY `abbonamento` (`abbonamento`),
  KEY `articolo` (`articolo`),
  CONSTRAINT `impianto_uscita_articolo_ibfk_1` FOREIGN KEY (`Impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `impianto_uscita_articolo_ibfk_2` FOREIGN KEY (`abbonamento`) REFERENCES `abbonamento` (`Id_abbonamento`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `impianto_uscita_articolo_ibfk_3` FOREIGN KEY (`articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_vigilante
CREATE TABLE IF NOT EXISTS `impianto_vigilante` (
  `Id_impianto` int(11) NOT NULL,
  `Id_vigilante` int(11) NOT NULL,
  PRIMARY KEY (`Id_impianto`,`Id_vigilante`) USING BTREE,
  KEY `Id_vigilante` (`Id_vigilante`),
  CONSTRAINT `impianto_vigilante_ibfk_1` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `impianto_vigilante_ibfk_2` FOREIGN KEY (`Id_vigilante`) REFERENCES `vigilante` (`Id_vigilante`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impianto_vigilante_collegamenti
CREATE TABLE IF NOT EXISTS `impianto_vigilante_collegamenti` (
  `id_impianto` int(11) NOT NULL,
  `id_vigilante` int(11) NOT NULL,
  `tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_impianto`,`tipo`,`id_vigilante`),
  KEY `imp_vi` (`id_impianto`,`id_vigilante`),
  KEY `FK_impianto_vigilante_collegamenti_2` (`tipo`),
  CONSTRAINT `FK_impianto_vigilante_collegamenti_2` FOREIGN KEY (`tipo`) REFERENCES `tipo_collegamento_impianto` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `imp_vi` FOREIGN KEY (`id_impianto`, `id_vigilante`) REFERENCES `impianto_vigilante` (`Id_impianto`, `Id_vigilante`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.importazione
CREATE TABLE IF NOT EXISTS `importazione` (
  `id_importazione` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(145) NOT NULL,
  `descrizione` text NOT NULL,
  `tabella` varchar(145) NOT NULL,
  `separatore` char(1) NOT NULL,
  `delimitatore` char(1) NOT NULL,
  `excel` tinyint(4) NOT NULL DEFAULT '0',
  `ignore` tinyint(4) NOT NULL DEFAULT '0',
  `stringa_Connessione` varchar(545) DEFAULT NULL,
  `nome_tab` varchar(45) DEFAULT NULL,
  `query` text,
  `note` text,
  PRIMARY KEY (`id_importazione`)
) ENGINE=InnoDB AUTO_INCREMENT=37 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.importazione_campi
CREATE TABLE IF NOT EXISTS `importazione_campi` (
  `posizione` int(11) NOT NULL,
  `campo` varchar(145) NOT NULL,
  `id_importazione` int(11) NOT NULL,
  `fisso` int(11) NOT NULL DEFAULT '0',
  `reference` text,
  `esterna` text,
  `null_valido` tinyint(4) DEFAULT '0',
  `repl1` varchar(145) DEFAULT NULL,
  `replace1` varchar(145) DEFAULT NULL,
  `tipo` varchar(10) DEFAULT NULL,
  `duplicate` tinyint(4) DEFAULT '0',
  `lunghezza` int(11) DEFAULT '0',
  PRIMARY KEY (`posizione`,`id_importazione`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.importazione_fine
CREATE TABLE IF NOT EXISTS `importazione_fine` (
  `id_importazione` int(11) NOT NULL,
  `id_ordine` int(11) NOT NULL,
  `query` text NOT NULL,
  PRIMARY KEY (`id_importazione`,`id_ordine`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impostazioni_backup
CREATE TABLE IF NOT EXISTS `impostazioni_backup` (
  `id_impostazioni` varchar(100) NOT NULL,
  `valore` varchar(500) NOT NULL,
  PRIMARY KEY (`id_impostazioni`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impostazioni_fattura
CREATE TABLE IF NOT EXISTS `impostazioni_fattura` (
  `tipo_impostazione` varchar(45) NOT NULL,
  `valore` varchar(100) NOT NULL DEFAULT '0',
  PRIMARY KEY (`tipo_impostazione`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.impostazioni_prima_nota
CREATE TABLE IF NOT EXISTS `impostazioni_prima_nota` (
  `tipo_impostazione` varchar(45) NOT NULL,
  `valore` int(10) unsigned NOT NULL,
  PRIMARY KEY (`tipo_impostazione`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.imp_app
CREATE TABLE IF NOT EXISTS `imp_app` (
  `Id_imp` int(11) NOT NULL,
  `cliente` varchar(50) NOT NULL,
  `gest` int(11) NOT NULL,
  `cli` int(11) NOT NULL,
  `subcliente` varchar(50) NOT NULL,
  PRIMARY KEY (`Id_imp`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lavoro_lotto
CREATE TABLE IF NOT EXISTS `lavoro_lotto` (
  `Id_lotto` int(11) NOT NULL,
  `Id_causale_lavoro` int(11) NOT NULL,
  `Nome` varchar(30) DEFAULT NULL,
  `Prezzo` int(11) DEFAULT NULL,
  `Quantità` int(11) DEFAULT NULL,
  `unità_misura` varchar(5) DEFAULT NULL,
  `Tempo_installazione` int(11) DEFAULT NULL,
  `sconto` int(11) DEFAULT NULL,
  `prezzo_h` int(11) DEFAULT NULL,
  `Desc_brev` varchar(30) DEFAULT NULL,
  `id_tab` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`Id_lotto`,`id_tab`),
  KEY `unità_misura` (`unità_misura`),
  KEY `Id_causale_lavoro` (`Id_causale_lavoro`),
  CONSTRAINT `lavoro_lotto_ibfk_1` FOREIGN KEY (`Id_lotto`) REFERENCES `lotto` (`Id_lotto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `lavoro_lotto_ibfk_2` FOREIGN KEY (`Id_causale_lavoro`) REFERENCES `causale_lavoro` (`Id_causale`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `lavoro_lotto_ibfk_3` FOREIGN KEY (`unità_misura`) REFERENCES `unita_misura` (`sigla`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lavoro_preventivo
CREATE TABLE IF NOT EXISTS `lavoro_preventivo` (
  `Id_preventivo` int(11) NOT NULL,
  `Id_revisione` int(11) NOT NULL DEFAULT '0',
  `Id_causale_lavoro` int(11) NOT NULL,
  `Prezzo` float(11,2) DEFAULT NULL,
  `Quantità` int(11) DEFAULT NULL,
  `unità_misura` int(11) DEFAULT NULL,
  `Tempo_installazione` int(11) DEFAULT NULL,
  `sistema` int(11) DEFAULT NULL,
  `sconto` int(11) DEFAULT NULL,
  `prezzo_h` int(11) DEFAULT NULL,
  `Desc_brev` int(30) DEFAULT NULL,
  `id_tab` int(11) NOT NULL DEFAULT '0',
  `Lotto` varchar(30) DEFAULT NULL,
  `anno` int(11) NOT NULL,
  PRIMARY KEY (`Id_preventivo`,`Id_revisione`,`id_tab`,`anno`),
  KEY `sistema` (`sistema`),
  KEY `Id_causale_lavoro` (`Id_causale_lavoro`),
  KEY `Id_revisione` (`Id_revisione`),
  KEY `Lotto` (`Lotto`),
  CONSTRAINT `lavoro_preventivo_ibfk_1` FOREIGN KEY (`Id_preventivo`) REFERENCES `preventivo` (`Id_preventivo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `lavoro_preventivo_ibfk_2` FOREIGN KEY (`Id_causale_lavoro`) REFERENCES `causale_lavoro` (`Id_causale`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `lavoro_preventivo_ibfk_3` FOREIGN KEY (`sistema`) REFERENCES `sistema_preventivo` (`Id_sistema`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `lavoro_preventivo_ibfk_4` FOREIGN KEY (`Id_revisione`) REFERENCES `revisione_preventivo` (`Id_revisione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lavoro_tipo_impianto
CREATE TABLE IF NOT EXISTS `lavoro_tipo_impianto` (
  `id_tipo_impianto` int(11) NOT NULL,
  `id_lavoro` int(11) NOT NULL,
  `Descrizione` varchar(30) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lista_articoli
CREATE TABLE IF NOT EXISTS `lista_articoli` (
  `id_articolo` varchar(11) DEFAULT NULL,
  `id_lista` int(11) NOT NULL,
  `Desc_breve` varchar(50) NOT NULL,
  `anno` int(11) NOT NULL,
  `codice_fornitore` varchar(45) DEFAULT NULL,
  `numero_tab` int(11) NOT NULL,
  `quantità` float(11,4) DEFAULT NULL,
  `Unità_misura` varchar(5) DEFAULT NULL,
  `Serial_number` varchar(27) DEFAULT NULL,
  `non_consegnati` float(11,4) NOT NULL DEFAULT '0.0000',
  `data_consegna` date DEFAULT NULL,
  `causale_scarico` int(11) DEFAULT NULL,
  `foto_filename` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`id_lista`,`anno`,`numero_tab`),
  KEY `id_articolo` (`id_articolo`,`id_lista`),
  KEY `id_lista` (`id_lista`),
  KEY `anno` (`anno`),
  KEY `Unità_misura` (`Unità_misura`),
  KEY `lista_articoli_ibfk_3` (`id_lista`,`anno`),
  CONSTRAINT `lista_articoli_ibfk_1` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lista_articoli_ibfk_2` FOREIGN KEY (`Unità_misura`) REFERENCES `unita_misura` (`sigla`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lista_articoli_ibfk_3` FOREIGN KEY (`id_lista`, `anno`) REFERENCES `lista_prelievo` (`Id_lista`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lista_aspetto
CREATE TABLE IF NOT EXISTS `lista_aspetto` (
  `Id_lista` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `vista` varchar(3) NOT NULL,
  PRIMARY KEY (`Id_lista`,`anno`,`vista`),
  KEY `anno` (`anno`),
  KEY `vista` (`vista`),
  CONSTRAINT `lista_aspetto_ibfk_1` FOREIGN KEY (`Id_lista`) REFERENCES `lista_prelievo` (`Id_lista`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `lista_aspetto_ibfk_2` FOREIGN KEY (`anno`) REFERENCES `lista_prelievo` (`Anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `lista_aspetto_ibfk_3` FOREIGN KEY (`vista`) REFERENCES `aspetto` (`Id_aspetto`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lista_prelievo
CREATE TABLE IF NOT EXISTS `lista_prelievo` (
  `Id_lista` int(11) NOT NULL,
  `Anno` int(11) NOT NULL,
  `cliente` int(11) DEFAULT NULL,
  `id_destinazione` int(11) DEFAULT NULL,
  `Id_operaio` int(11) DEFAULT NULL,
  `rientro` bit(1) DEFAULT NULL,
  `causale` int(11) DEFAULT NULL,
  `Data` date DEFAULT NULL,
  `Tipo_materiale` int(11) DEFAULT NULL,
  `Nota` text NOT NULL,
  `colli` int(11) NOT NULL,
  `id_principale` int(11) DEFAULT NULL,
  `Id_ddt` int(11) DEFAULT NULL,
  `id_anno` int(11) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id_lista`,`Anno`),
  KEY `cliente` (`cliente`),
  KEY `Id_operaio` (`Id_operaio`),
  KEY `causale` (`causale`),
  KEY `Tipo_materiale` (`Tipo_materiale`),
  KEY `Anno` (`Anno`),
  KEY `id_destinazione` (`id_destinazione`),
  KEY `Id_ddt` (`Id_ddt`),
  KEY `lista_prelievo_ibfk_7` (`Id_ddt`,`id_anno`),
  KEY `lista_prelievo_ibfk_6` (`id_destinazione`,`cliente`),
  KEY `Index_11_ut` (`id_utente`),
  CONSTRAINT `dt` FOREIGN KEY (`Id_ddt`, `id_anno`) REFERENCES `ddt` (`Id_ddt`, `anno`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_lista_prelievo_7_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lista_prelievo_ibfk_1` FOREIGN KEY (`Id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lista_prelievo_ibfk_2` FOREIGN KEY (`Tipo_materiale`) REFERENCES `tipo_materiale` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lista_prelievo_ibfk_3` FOREIGN KEY (`causale`) REFERENCES `causale_magazzino` (`Id_causale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lista_prelievo_ibfk_4` FOREIGN KEY (`cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lista_prelievo_ibfk_6` FOREIGN KEY (`id_destinazione`, `cliente`) REFERENCES `destinazione_cliente` (`Id_destinazione`, `id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lista_prelievo_ibfk_7` FOREIGN KEY (`Id_ddt`, `id_anno`) REFERENCES `ddt` (`Id_ddt`, `anno`) ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lista_stampa
CREATE TABLE IF NOT EXISTS `lista_stampa` (
  `id_lista` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  PRIMARY KEY (`id_lista`,`anno`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.listino
CREATE TABLE IF NOT EXISTS `listino` (
  `Id_listino` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`Id_listino`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=2859 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.livello_associato
CREATE TABLE IF NOT EXISTS `livello_associato` (
  `Id_livello` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) DEFAULT NULL,
  `Descrizione` longtext,
  `Prezzo` float(11,2) DEFAULT NULL,
  `Costo` float(11,2) DEFAULT NULL,
  PRIMARY KEY (`Id_livello`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.log_aries
CREATE TABLE IF NOT EXISTS `log_aries` (
  `id_log` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `anno` int(10) unsigned NOT NULL,
  `id_utente` varchar(5) NOT NULL,
  `azione` varchar(45) CHARACTER SET latin1 COLLATE latin1_bin NOT NULL,
  `query` text,
  `data` datetime NOT NULL,
  `indirizzo_ip` varchar(45) NOT NULL,
  PRIMARY KEY (`id_log`,`anno`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=1052 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.log_aries_server
CREATE TABLE IF NOT EXISTS `log_aries_server` (
  `id_log` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `anno` int(10) unsigned NOT NULL,
  `azione` varchar(45) CHARACTER SET latin1 COLLATE latin1_bin NOT NULL,
  `errore` text,
  `data` datetime NOT NULL,
  PRIMARY KEY (`id_log`,`anno`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=258748 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lotto
CREATE TABLE IF NOT EXISTS `lotto` (
  `Id_lotto` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(250) NOT NULL,
  `Descrizione` longtext,
  `stato` int(11) DEFAULT '0',
  PRIMARY KEY (`Id_lotto`),
  KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=3899 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lotto_escass
CREATE TABLE IF NOT EXISTS `lotto_escass` (
  `id_lotto` int(11) NOT NULL,
  `id_esc` int(11) NOT NULL,
  PRIMARY KEY (`id_lotto`,`id_esc`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lotto_esclusioni
CREATE TABLE IF NOT EXISTS `lotto_esclusioni` (
  `id_lotto` int(11) NOT NULL,
  `id_revisione` int(11) NOT NULL,
  `id_preventivo` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_esclusione` int(11) NOT NULL,
  PRIMARY KEY (`id_lotto`,`id_revisione`,`id_preventivo`,`anno`,`id_esclusione`),
  KEY `FK_lotto_esclusioni_1` (`id_preventivo`,`id_revisione`,`anno`,`id_lotto`),
  CONSTRAINT `FK_lotto_esclusioni_1` FOREIGN KEY (`id_preventivo`, `id_revisione`, `anno`, `id_lotto`) REFERENCES `preventivo_lotto` (`id_preventivo`, `id_revisione`, `anno`, `posizione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lotto_nome
CREATE TABLE IF NOT EXISTS `lotto_nome` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.lotto_prefazione
CREATE TABLE IF NOT EXISTS `lotto_prefazione` (
  `id_lotto` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `revisione` int(11) NOT NULL,
  `preventivo` int(11) NOT NULL,
  `testo` text NOT NULL,
  PRIMARY KEY (`id_lotto`,`anno`,`revisione`,`preventivo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.macro_impianto
CREATE TABLE IF NOT EXISTS `macro_impianto` (
  `Id_Macro` int(11) NOT NULL,
  `id_impianto` int(11) NOT NULL,
  `Data_associazione` date DEFAULT NULL,
  `Data_fine` date DEFAULT NULL,
  PRIMARY KEY (`Id_Macro`,`id_impianto`),
  KEY `id_impianto` (`id_impianto`),
  CONSTRAINT `macro_impianto_ibfk_1` FOREIGN KEY (`Id_Macro`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `macro_impianto_ibfk_2` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino
CREATE TABLE IF NOT EXISTS `magazzino` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_articolo` varchar(11) NOT NULL,
  `giacenza` decimal(11,2) NOT NULL DEFAULT '0.00',
  `tipo_magazzino` int(11) NOT NULL DEFAULT '1',
  `data_ultimo_movimento` datetime NOT NULL,
  `Utente_ins` smallint(6) DEFAULT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  `Data_ins` datetime DEFAULT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_articolo__tipo_magazzino` (`Id_articolo`,`tipo_magazzino`),
  KEY `Id_articolo` (`Id_articolo`),
  KEY `tipo_magazzino` (`tipo_magazzino`),
  CONSTRAINT `magazzino_ibfk_1` FOREIGN KEY (`Id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `magazzino_ibfk_2` FOREIGN KEY (`tipo_magazzino`) REFERENCES `tipo_magazzino` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=73536 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_arch
CREATE TABLE IF NOT EXISTS `magazzino_arch` (
  `id_arch` int(11) NOT NULL AUTO_INCREMENT,
  `anno` smallint(6) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  `Utente_ins` smallint(6) DEFAULT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  `Data_ins` datetime DEFAULT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_arch`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=17 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_azzera
CREATE TABLE IF NOT EXISTS `magazzino_azzera` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Id_tipo_magazzino` int(11) NOT NULL,
  `data_azzeramento` date NOT NULL,
  `Id_utente` int(11) NOT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=320 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_blocco
CREATE TABLE IF NOT EXISTS `magazzino_blocco` (
  `id_blocco` int(11) NOT NULL AUTO_INCREMENT,
  `data` date DEFAULT NULL,
  PRIMARY KEY (`id_blocco`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_ddt_emessi
CREATE TABLE IF NOT EXISTS `magazzino_ddt_emessi` (
  `id_operazione` bigint(11) NOT NULL AUTO_INCREMENT,
  `id_ddt` int(11) NOT NULL,
  `anno_ddt` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  `id_reso` bigint(11) DEFAULT NULL,
  PRIMARY KEY (`id_operazione`,`id_ddt`,`anno_ddt`,`id_tab`) USING BTREE,
  KEY `ddt` (`id_ddt`,`anno_ddt`),
  KEY `ddt_fk` (`id_ddt`,`anno_ddt`,`id_tab`),
  KEY `FK_id_reso_magazzino_operazione` (`id_reso`),
  CONSTRAINT `ddt_fk` FOREIGN KEY (`id_ddt`, `anno_ddt`, `id_tab`) REFERENCES `articoli_ddt` (`id_ddt`, `anno`, `numero_tab`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_id_operazione_magazzino_operazione` FOREIGN KEY (`id_operazione`) REFERENCES `magazzino_operazione` (`Id_operazione`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `FK_id_reso_magazzino_operazione` FOREIGN KEY (`id_reso`) REFERENCES `magazzino_operazione` (`Id_operazione`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=97415 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_ddt_ricevuti
CREATE TABLE IF NOT EXISTS `magazzino_ddt_ricevuti` (
  `id_ddt` int(11) NOT NULL,
  `id_anno` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  `id_operazione` bigint(20) NOT NULL,
  `id_reso` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`id_ddt`,`id_anno`,`id_tab`,`id_operazione`) USING BTREE,
  KEY `ddr` (`id_ddt`,`id_anno`,`id_tab`) USING BTREE,
  KEY `maga_ope` (`id_operazione`),
  KEY `ope_mag` (`id_reso`),
  CONSTRAINT `ddt_r` FOREIGN KEY (`id_ddt`, `id_anno`, `id_tab`) REFERENCES `articoli_ddt_ricevuti` (`id_ddt`, `anno`, `numero_tab`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `maga_ope` FOREIGN KEY (`id_operazione`) REFERENCES `magazzino_operazione` (`Id_operazione`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `ope_mag` FOREIGN KEY (`id_reso`) REFERENCES `magazzino_operazione` (`Id_operazione`) ON DELETE CASCADE ON UPDATE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_fattura
CREATE TABLE IF NOT EXISTS `magazzino_fattura` (
  `id_operazione` bigint(20) NOT NULL AUTO_INCREMENT,
  `id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  PRIMARY KEY (`id_operazione`,`id_fattura`,`anno`,`id_tab`),
  KEY `FK_magazzino_fattura_1` (`id_fattura`,`anno`),
  CONSTRAINT `FK_magazzino_fattura_1` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fattura` (`Id_fattura`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_magazzino_fattura_operazione` FOREIGN KEY (`id_operazione`) REFERENCES `magazzino_operazione` (`Id_operazione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=97372 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_fornfattura
CREATE TABLE IF NOT EXISTS `magazzino_fornfattura` (
  `id_operazione` bigint(20) NOT NULL AUTO_INCREMENT,
  `id_fattura` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  PRIMARY KEY (`id_operazione`,`id_fattura`,`anno`,`id_tab`),
  KEY `FK_magazzino_fornfattura_1` (`id_fattura`,`anno`),
  CONSTRAINT `FK_magazzino_fornfattura_fornfatt` FOREIGN KEY (`id_fattura`, `anno`) REFERENCES `fornfattura` (`Id_fattura`, `anno`) ON UPDATE CASCADE,
  CONSTRAINT `FK_magazzino_fornfattura_operazione` FOREIGN KEY (`id_operazione`) REFERENCES `magazzino_operazione` (`Id_operazione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=94552 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_kit_riferimento
CREATE TABLE IF NOT EXISTS `magazzino_kit_riferimento` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_operazione_kit` bigint(11) NOT NULL,
  `Id_operazione_articolo` bigint(11) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_operazione_kit_Id_operazione_articolo` (`Id_operazione_kit`,`Id_operazione_articolo`),
  KEY `fk_magazzino_operazione_articolo` (`Id_operazione_articolo`),
  CONSTRAINT `fk_magazzino_operazione_articolo` FOREIGN KEY (`Id_operazione_articolo`) REFERENCES `magazzino_operazione` (`Id_operazione`),
  CONSTRAINT `fk_magazzino_operazione_kit` FOREIGN KEY (`Id_operazione_kit`) REFERENCES `magazzino_operazione` (`Id_operazione`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_liste
CREATE TABLE IF NOT EXISTS `magazzino_liste` (
  `id_lista` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_operazione_ins` bigint(20) NOT NULL,
  `id_tab` int(11) NOT NULL,
  `id_operazione_del` bigint(20) NOT NULL,
  PRIMARY KEY (`id_lista`,`id_tab`,`id_operazione_ins`,`anno`,`id_operazione_del`) USING BTREE,
  KEY `fk_lis` (`id_lista`,`anno`,`id_tab`),
  KEY `FK_magaz_ope` (`id_operazione_ins`) USING BTREE,
  KEY `maga_del` (`id_operazione_del`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_operazione
CREATE TABLE IF NOT EXISTS `magazzino_operazione` (
  `Id_operazione` bigint(11) NOT NULL AUTO_INCREMENT,
  `Data` date NOT NULL,
  `causale` int(11) NOT NULL,
  `Articolo` varchar(11) NOT NULL,
  `quantità` float(11,2) NOT NULL,
  `id_magazzino` int(11) NOT NULL DEFAULT '1',
  `sorgente` int(11) NOT NULL COMMENT '1 = manuale | 2 = rapporto  | 3 = ddt | 4 = traferimento magazzini | 5 = manuale da mobile | 6 fatt forn | 7 fattura | 8 ddt ricevuto',
  PRIMARY KEY (`Id_operazione`),
  KEY `Articolo` (`Articolo`),
  KEY `id_magazzino` (`id_magazzino`),
  KEY `causale` (`causale`) USING BTREE,
  KEY `FK_magazzino_operazione_sorgente` (`sorgente`),
  CONSTRAINT `FK_magazzino_operazione_sorgente` FOREIGN KEY (`sorgente`) REFERENCES `magazzino_operazione_sorgente` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `magazzino_operazione_ibfk_1` FOREIGN KEY (`causale`) REFERENCES `causale_magazzino` (`Id_causale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `magazzino_operazione_ibfk_2` FOREIGN KEY (`Articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `magazzino_operazione_ibfk_3` FOREIGN KEY (`id_magazzino`) REFERENCES `tipo_magazzino` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=97415 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_operazione_sorgente
CREATE TABLE IF NOT EXISTS `magazzino_operazione_sorgente` (
  `id` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL DEFAULT '',
  `attivo` bit(1) DEFAULT b'1',
  `data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_rapporto
CREATE TABLE IF NOT EXISTS `magazzino_rapporto` (
  `id_rapporto` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_ins` int(11) NOT NULL,
  `id_del` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  PRIMARY KEY (`id_rapporto`,`anno`,`id_tab`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_rapporto_materiale
CREATE TABLE IF NOT EXISTS `magazzino_rapporto_materiale` (
  `id_magazzino_rapporto` bigint(11) NOT NULL AUTO_INCREMENT,
  `id_operazione` bigint(11) NOT NULL,
  `id_rapporto` bigint(11) NOT NULL,
  `anno_rapporto` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  PRIMARY KEY (`id_magazzino_rapporto`),
  UNIQUE KEY `id_rapporto_anno_rapporto_id_tab` (`id_rapporto`,`anno_rapporto`,`id_tab`),
  UNIQUE KEY `id_operazione` (`id_operazione`),
  CONSTRAINT `FK_magazzino_rapporto_magazzino_operazione` FOREIGN KEY (`id_operazione`) REFERENCES `magazzino_operazione` (`Id_operazione`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_magazzino_rapporto_rapporto` FOREIGN KEY (`id_rapporto`, `anno_rapporto`, `id_tab`) REFERENCES `rapporto_materiale` (`Id_rapporto`, `anno`, `id_tab`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=2182 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_serial_number
CREATE TABLE IF NOT EXISTS `magazzino_serial_number` (
  `Id_Articolo` varchar(11) NOT NULL,
  `numero` int(11) NOT NULL,
  PRIMARY KEY (`Id_Articolo`,`numero`),
  CONSTRAINT `magazzino_serial_number_ibfk_3` FOREIGN KEY (`Id_Articolo`) REFERENCES `magazzino` (`Id_articolo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.magazzino_stored
CREATE TABLE IF NOT EXISTS `magazzino_stored` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `id_stored` int(11) NOT NULL,
  `id_articolo` varchar(11) NOT NULL,
  `giacenza` decimal(11,2) NOT NULL,
  `tipo_magazzino` int(11) NOT NULL,
  `Utente_ins` smallint(6) DEFAULT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  `Data_ins` datetime DEFAULT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_articolo__tipo_magazzino__id_stored` (`id_articolo`,`tipo_magazzino`,`id_stored`),
  KEY `Fk_id_stored` (`id_stored`),
  CONSTRAINT `Fk_id_stored` FOREIGN KEY (`id_stored`) REFERENCES `magazzino_arch` (`id_arch`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=129172 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail
CREATE TABLE IF NOT EXISTS `mail` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_mittente` int(11) NOT NULL COMMENT 'Corrisponde all''id_utente con cui viene fatto l invio della email',
  `Destinatari_cc` varchar(500) DEFAULT NULL,
  `Destinatari_ccn` varchar(500) DEFAULT NULL,
  `Oggetto` varchar(100) NOT NULL,
  `Corpo` text NOT NULL,
  `Pec` bit(1) NOT NULL DEFAULT b'0',
  `Id_stato` int(11) NOT NULL,
  `Id_risposta` int(11) DEFAULT NULL,
  `Id_gruppo` int(11) DEFAULT NULL,
  `Tipo` varchar(15) DEFAULT '1',
  `Id_documento` varchar(10) DEFAULT NULL,
  `Anno_documento` varchar(10) DEFAULT NULL,
  `Revisione_documento` varchar(10) DEFAULT NULL,
  `Tipo_documento` varchar(30) DEFAULT NULL,
  `Tentativo` tinyint(4) NOT NULL DEFAULT '0',
  `Data_invio` datetime NOT NULL,
  `Letto` bit(1) NOT NULL DEFAULT b'0',
  `Id_stato_errore` mediumint(9) DEFAULT NULL,
  `Messaggio_errore` varchar(500) DEFAULT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(5) unsigned NOT NULL,
  `Utente_mod` smallint(5) unsigned DEFAULT NULL,
  PRIMARY KEY (`Id`),
  KEY `mitt` (`Id_mittente`),
  KEY `GRUPPO` (`Id_gruppo`),
  KEY `FK_mail_3` (`Id_stato`),
  CONSTRAINT `FK_mail_id_mittente_utente` FOREIGN KEY (`Id_mittente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_mail_mail_gruppo` FOREIGN KEY (`Id_gruppo`) REFERENCES `mail_gruppo` (`id_gruppo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_mail_mail_stato` FOREIGN KEY (`Id_stato`) REFERENCES `mail_stato` (`id_Stato`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=24501 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_allegati
CREATE TABLE IF NOT EXISTS `mail_allegati` (
  `id_mail` int(11) NOT NULL,
  `nome_file` varchar(100) NOT NULL,
  PRIMARY KEY (`id_mail`,`nome_file`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_fax_impostazioni_server
CREATE TABLE IF NOT EXISTS `mail_fax_impostazioni_server` (
  `time_polling` int(11) NOT NULL,
  `wait` int(11) NOT NULL,
  `tempo_controllo` int(11) NOT NULL,
  `prefisso` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`time_polling`,`wait`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_fax_indirizzi_fatti
CREATE TABLE IF NOT EXISTS `mail_fax_indirizzi_fatti` (
  `id_mail` int(11) NOT NULL,
  `inizio` int(11) NOT NULL,
  `fine` int(11) NOT NULL,
  `indirizzo` varchar(45) NOT NULL,
  `stato` int(11) NOT NULL,
  PRIMARY KEY (`id_mail`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_fax_scheduler
CREATE TABLE IF NOT EXISTS `mail_fax_scheduler` (
  `id_schedulazione` int(11) NOT NULL,
  `ora_inizio` time NOT NULL,
  `data_inizio` date NOT NULL,
  `stato` int(11) NOT NULL,
  PRIMARY KEY (`id_schedulazione`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_gruppo
CREATE TABLE IF NOT EXISTS `mail_gruppo` (
  `id_gruppo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` text,
  `tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_gruppo`),
  UNIQUE KEY `Index_2_nome` (`nome`),
  KEY `FK_mail_gruppo_1` (`tipo`),
  CONSTRAINT `FK_mail_gruppo_1` FOREIGN KEY (`tipo`) REFERENCES `mail_gruppo_tipo` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_gruppo_cliente
CREATE TABLE IF NOT EXISTS `mail_gruppo_cliente` (
  `id_cliente` int(11) NOT NULL,
  `id_riferimento` int(11) NOT NULL,
  `id_gruppo` int(11) NOT NULL,
  PRIMARY KEY (`id_cliente`,`id_riferimento`,`id_gruppo`) USING BTREE,
  KEY `Index_2_cli` (`id_cliente`,`id_riferimento`) USING BTREE,
  KEY `Index_3_grup` (`id_gruppo`),
  CONSTRAINT `FK_mail_gruppo_cliente_1_rif` FOREIGN KEY (`id_cliente`, `id_riferimento`) REFERENCES `riferimento_clienti` (`Id_cliente`, `Id_riferimento`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_mail_gruppo_cliente_2_grup` FOREIGN KEY (`id_gruppo`) REFERENCES `mail_gruppo` (`id_gruppo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_gruppo_fornitore
CREATE TABLE IF NOT EXISTS `mail_gruppo_fornitore` (
  `id_fornitore` int(11) NOT NULL,
  `id_riferimento` int(11) NOT NULL,
  `id_gruppo` int(11) NOT NULL,
  PRIMARY KEY (`id_fornitore`,`id_riferimento`,`id_gruppo`),
  KEY `Index_2_rif` (`id_fornitore`,`id_riferimento`),
  KEY `Index_3_gruop` (`id_gruppo`),
  CONSTRAINT `FK_mail_gruppo_fornitori_1_rif` FOREIGN KEY (`id_fornitore`, `id_riferimento`) REFERENCES `riferimento_fornitore` (`Id_fornitore`, `Id_riferimento`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_mail_gruppo_fornitori_2_grup` FOREIGN KEY (`id_gruppo`) REFERENCES `mail_gruppo` (`id_gruppo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_gruppo_inviate
CREATE TABLE IF NOT EXISTS `mail_gruppo_inviate` (
  `id_mail` int(11) NOT NULL,
  `id_riferimento` int(11) NOT NULL,
  `id_cliente` int(11) NOT NULL,
  `stato` int(11) NOT NULL DEFAULT '0',
  `Codice_errore` int(11) DEFAULT NULL,
  `Messaggio_errore` varchar(250) DEFAULT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_mail`,`id_riferimento`,`id_cliente`),
  KEY `clientr` (`id_cliente`,`id_riferimento`),
  CONSTRAINT `clientr` FOREIGN KEY (`id_cliente`, `id_riferimento`) REFERENCES `riferimento_clienti` (`Id_cliente`, `Id_riferimento`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_mail_gruppo_inviate_mail` FOREIGN KEY (`id_mail`) REFERENCES `mail` (`Id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_gruppo_inviate_fornitore
CREATE TABLE IF NOT EXISTS `mail_gruppo_inviate_fornitore` (
  `id_mail` int(11) NOT NULL,
  `id_fornitore` int(11) NOT NULL,
  `id_riferimento` int(11) NOT NULL,
  `stato` int(11) NOT NULL,
  `Codice_errore` int(11) DEFAULT NULL,
  `Messaggio_errore` varchar(250) DEFAULT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_mail`,`id_fornitore`,`id_riferimento`) USING BTREE,
  KEY `id_rifd` (`id_fornitore`,`id_riferimento`),
  CONSTRAINT `id_rifd` FOREIGN KEY (`id_fornitore`, `id_riferimento`) REFERENCES `riferimento_fornitore` (`Id_fornitore`, `Id_riferimento`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_gruppo_regola
CREATE TABLE IF NOT EXISTS `mail_gruppo_regola` (
  `id_regola` int(11) NOT NULL AUTO_INCREMENT,
  `regola` text NOT NULL,
  `id_gruppo` int(11) NOT NULL,
  `qjoin` text NOT NULL,
  `wher` varchar(105) DEFAULT NULL,
  PRIMARY KEY (`id_regola`,`id_gruppo`) USING BTREE,
  KEY `FK_mail_gruppo_regola_1_grup` (`id_gruppo`),
  CONSTRAINT `FK_mail_gruppo_regola_1_grup` FOREIGN KEY (`id_gruppo`) REFERENCES `mail_gruppo` (`id_gruppo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_gruppo_tipo
CREATE TABLE IF NOT EXISTS `mail_gruppo_tipo` (
  `id_tipo` int(11) NOT NULL,
  `nome` varchar(45) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_impostazioni_server
CREATE TABLE IF NOT EXISTS `mail_impostazioni_server` (
  `n_indirizzi` int(11) NOT NULL,
  `time_polling` int(11) NOT NULL,
  `wait` int(11) NOT NULL,
  `ip_ping` varchar(105) NOT NULL,
  `percorso` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`n_indirizzi`,`time_polling`,`wait`,`ip_ping`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_regola
CREATE TABLE IF NOT EXISTS `mail_regola` (
  `id_regola` int(11) NOT NULL AUTO_INCREMENT,
  `regola` text NOT NULL,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(145) DEFAULT NULL,
  `nometab` varchar(45) NOT NULL,
  `nomecampo` varchar(45) NOT NULL,
  `qjoin` text NOT NULL,
  `wher` varchar(100) DEFAULT NULL,
  `tipo` tinyint(4) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_regola`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_scheduler
CREATE TABLE IF NOT EXISTS `mail_scheduler` (
  `id_schedulazione` int(11) NOT NULL,
  `data_inizio` date DEFAULT NULL,
  `ora_inizio` time DEFAULT NULL,
  `stato` int(11) DEFAULT NULL,
  `utente` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_schedulazione`) USING BTREE,
  KEY `ute` (`utente`),
  CONSTRAINT `ute` FOREIGN KEY (`utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mail_stato
CREATE TABLE IF NOT EXISTS `mail_stato` (
  `id_Stato` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  PRIMARY KEY (`id_Stato`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.marca
CREATE TABLE IF NOT EXISTS `marca` (
  `Id_marca` varchar(5) NOT NULL,
  `Nome` varchar(50) DEFAULT NULL,
  `Logo` varchar(900) DEFAULT NULL,
  `mail` varchar(200) DEFAULT NULL,
  `sito` varchar(300) DEFAULT NULL,
  `password` varchar(30) DEFAULT NULL,
  `Utente_sito` varchar(60) DEFAULT NULL,
  `Nota` longtext,
  `modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `id_utente` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_marca`),
  UNIQUE KEY `nome` (`Nome`),
  KEY `Index_3_u` (`id_utente`),
  CONSTRAINT `FK_marca_1_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.marca_categoria
CREATE TABLE IF NOT EXISTS `marca_categoria` (
  `Marca` varchar(3) NOT NULL,
  `Categoria` int(11) unsigned NOT NULL,
  PRIMARY KEY (`Marca`),
  CONSTRAINT `FK_marca_categoria_1` FOREIGN KEY (`Marca`) REFERENCES `marca` (`Id_marca`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.marca_listino
CREATE TABLE IF NOT EXISTS `marca_listino` (
  `id_marca` varchar(5) NOT NULL,
  `id_listino` int(11) NOT NULL,
  `cartaceo` tinyint(1) NOT NULL DEFAULT '0',
  `digitale` tinyint(1) NOT NULL DEFAULT '0',
  `data` date DEFAULT NULL,
  `categoria` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_marca`,`id_listino`),
  KEY `categoria` (`categoria`) USING BTREE,
  KEY `listino` (`id_listino`),
  CONSTRAINT `categoria` FOREIGN KEY (`categoria`) REFERENCES `categoria_merciologica` (`Id_categoria`) ON UPDATE CASCADE,
  CONSTRAINT `listino` FOREIGN KEY (`id_listino`) REFERENCES `listino` (`Id_listino`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `marca` FOREIGN KEY (`id_marca`) REFERENCES `marca` (`Id_marca`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mese
CREATE TABLE IF NOT EXISTS `mese` (
  `Id_mese` int(11) NOT NULL,
  `Nome` varchar(15) NOT NULL,
  PRIMARY KEY (`Id_mese`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.mportazione_fine
CREATE TABLE IF NOT EXISTS `mportazione_fine` (
  `ID_ordine` int(11) NOT NULL,
  `query` text NOT NULL,
  `id_importazione` varchar(45) NOT NULL,
  PRIMARY KEY (`ID_ordine`,`id_importazione`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.nazione
CREATE TABLE IF NOT EXISTS `nazione` (
  `id_nazione` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `sigla` varchar(45) NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`id_nazione`),
  UNIQUE KEY `Index_2_nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.new1
CREATE TABLE IF NOT EXISTS `new1` (
  `q` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `aa` varchar(45) NOT NULL,
  `bb` varchar(45) NOT NULL,
  PRIMARY KEY (`q`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.normative
CREATE TABLE IF NOT EXISTS `normative` (
  `Id_normativa` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(50) NOT NULL,
  `Tipo_normativa` int(11) DEFAULT NULL,
  `Nota` varchar(300) DEFAULT NULL,
  `Data_pubblicazione` date DEFAULT NULL,
  `Data_scadenza` date DEFAULT NULL,
  `Costo` float(11,4) NOT NULL DEFAULT '0.0000',
  `articolo` tinyint(4) DEFAULT '0',
  `lavoro` tinyint(4) DEFAULT '0',
  `id_utente` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_normativa`),
  UNIQUE KEY `Nome` (`Nome`),
  KEY `Tipo_normativa` (`Tipo_normativa`),
  KEY `Index_4_ur` (`id_utente`),
  CONSTRAINT `FK_normative_2_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `normative_ibfk_1` FOREIGN KEY (`Tipo_normativa`) REFERENCES `tipo_normativa` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=136 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.normative_impianto
CREATE TABLE IF NOT EXISTS `normative_impianto` (
  `normativa` int(11) NOT NULL,
  `impianto` int(11) NOT NULL,
  PRIMARY KEY (`normativa`,`impianto`),
  KEY `impianto` (`impianto`),
  CONSTRAINT `normative_impianto_ibfk_1` FOREIGN KEY (`normativa`) REFERENCES `normative` (`Id_normativa`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `normative_impianto_ibfk_2` FOREIGN KEY (`impianto`) REFERENCES `tipo_impianto` (`id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.nota
CREATE TABLE IF NOT EXISTS `nota` (
  `id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(60) NOT NULL,
  `note` text NOT NULL,
  `prezz` decimal(10,2) DEFAULT NULL,
  `cost` decimal(10,2) DEFAULT NULL,
  `temp` int(11) DEFAULT NULL,
  `nota_stato` tinyint(4) DEFAULT '1',
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_nota`),
  UNIQUE KEY `nom` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=1823 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.note_cat
CREATE TABLE IF NOT EXISTS `note_cat` (
  `id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` text NOT NULL,
  `id_categoria` int(11) NOT NULL,
  PRIMARY KEY (`id_nota`,`id_categoria`) USING BTREE,
  KEY `Index_2` (`id_categoria`),
  CONSTRAINT `FK_note_cat_1cate` FOREIGN KEY (`id_categoria`) REFERENCES `categoria_merciologica` (`Id_categoria`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.note_lotto
CREATE TABLE IF NOT EXISTS `note_lotto` (
  `Id_lotto` int(11) NOT NULL,
  `Id_nota` int(11) NOT NULL,
  `Nome` varchar(30) DEFAULT NULL,
  `Descrizione` longtext,
  `Quantità` int(11) DEFAULT NULL,
  `unità_misura` varchar(5) DEFAULT NULL,
  `prezzo` float(11,2) DEFAULT NULL,
  `Lavoro_h` int(11) DEFAULT NULL,
  `Prezzo_h` int(11) NOT NULL,
  `id_tab` int(11) NOT NULL,
  PRIMARY KEY (`Id_lotto`,`id_tab`),
  KEY `unità_misura` (`unità_misura`),
  KEY `Id_nota` (`Id_nota`),
  CONSTRAINT `note_lotto_ibfk_1` FOREIGN KEY (`Id_lotto`) REFERENCES `lotto` (`Id_lotto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `note_lotto_ibfk_2` FOREIGN KEY (`Id_nota`) REFERENCES `nota` (`id_nota`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `note_lotto_ibfk_3` FOREIGN KEY (`unità_misura`) REFERENCES `unita_misura` (`sigla`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.note_preventivo
CREATE TABLE IF NOT EXISTS `note_preventivo` (
  `Id_preventivo` int(11) NOT NULL,
  `Id_revisione` int(11) NOT NULL,
  `Desc_brev` varchar(30) DEFAULT NULL,
  `Quantità` int(11) DEFAULT NULL,
  `unità_misura` varchar(5) DEFAULT NULL,
  `prezzo` float(11,2) DEFAULT NULL,
  `Tempo_installazione` int(11) DEFAULT NULL,
  `Prezzo_h` int(11) NOT NULL,
  `Lotto` varchar(30) DEFAULT NULL,
  `Sconto` int(11) DEFAULT NULL,
  `id_tab` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `pagina` int(11) NOT NULL,
  PRIMARY KEY (`Id_preventivo`,`Id_revisione`,`id_tab`,`anno`),
  KEY `unità_misura` (`unità_misura`),
  KEY `Id_preventivo` (`Id_preventivo`),
  KEY `Id_revisione` (`Id_revisione`),
  KEY `Lotto` (`Lotto`),
  CONSTRAINT `note_preventivo_ibfk_1` FOREIGN KEY (`Id_preventivo`) REFERENCES `preventivo` (`Id_preventivo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `note_preventivo_ibfk_2` FOREIGN KEY (`Id_revisione`) REFERENCES `revisione_preventivo` (`Id_revisione`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `note_preventivo_ibfk_4` FOREIGN KEY (`unità_misura`) REFERENCES `unita_misura` (`sigla`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.note_sot
CREATE TABLE IF NOT EXISTS `note_sot` (
  `id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` text NOT NULL,
  `id_sottocategoria` int(11) NOT NULL,
  PRIMARY KEY (`id_nota`,`id_sottocategoria`) USING BTREE,
  KEY `Index_2_sot` (`id_sottocategoria`),
  CONSTRAINT `FK_note_sot_1_sot` FOREIGN KEY (`id_sottocategoria`) REFERENCES `sottocategoria` (`id_sottocategoria`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.note_sot2
CREATE TABLE IF NOT EXISTS `note_sot2` (
  `id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` text NOT NULL,
  `id_livello2` int(11) NOT NULL,
  PRIMARY KEY (`id_nota`,`id_livello2`) USING BTREE,
  KEY `Index_2_sot2` (`id_livello2`),
  CONSTRAINT `FK_note_sot2_1_sot2` FOREIGN KEY (`id_livello2`) REFERENCES `sottocategoria2` (`Id_livello2`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.note_tipo
CREATE TABLE IF NOT EXISTS `note_tipo` (
  `id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `id_tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_nota`,`id_tipo`),
  KEY `ti` (`id_tipo`),
  CONSTRAINT `nota` FOREIGN KEY (`id_nota`) REFERENCES `nota` (`id_nota`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `ti` FOREIGN KEY (`id_tipo`) REFERENCES `tipo_nota` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=1823 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio
CREATE TABLE IF NOT EXISTS `operaio` (
  `Id_operaio` int(11) NOT NULL AUTO_INCREMENT,
  `id_pubblico` char(36) DEFAULT NULL,
  `Ragione_sociale` varchar(50) NOT NULL,
  `Codice_Fiscale` varchar(20) DEFAULT NULL,
  `Provincia` varchar(5) DEFAULT NULL,
  `Comune` int(11) DEFAULT NULL,
  `Frazione` int(11) DEFAULT NULL,
  `Indirizzo` varchar(50) DEFAULT NULL,
  `Iban` varchar(27) DEFAULT NULL,
  `livello_associato` int(11) DEFAULT NULL,
  `N_matricola` int(11) DEFAULT NULL,
  `Scade_contratto` date DEFAULT NULL,
  `Telefono` varchar(15) DEFAULT NULL,
  `Telefono_abitazione` varchar(15) DEFAULT NULL,
  `altro_telefono` varchar(15) DEFAULT NULL,
  `E_mail` varchar(50) DEFAULT NULL,
  `qualifica` int(11) DEFAULT NULL,
  `Data_assunzione` date DEFAULT NULL,
  `Data_licenziamento` date DEFAULT NULL,
  `Tariffario` int(11) DEFAULT NULL,
  `collaboratore` int(11) NOT NULL DEFAULT '0',
  `id_filiale` bigint(20) DEFAULT NULL,
  `l_nas` int(11) DEFAULT NULL,
  `d_nas` date NOT NULL DEFAULT '1970-01-01',
  `tipo_operaio` int(11) DEFAULT NULL,
  `agente` tinyint(4) DEFAULT '0',
  `id_utente` int(11) DEFAULT NULL,
  `is_cassa` int(11) unsigned DEFAULT '0',
  `is_tecnico` tinyint(1) DEFAULT '0',
  `mail_account` varchar(45) DEFAULT NULL,
  `password` varchar(45) DEFAULT NULL,
  `username` varchar(45) DEFAULT NULL,
  `sigla_operaio` varchar(50) DEFAULT NULL,
  `Data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  `Data_mod` timestamp NULL DEFAULT NULL,
  `Utente_ins` smallint(6) DEFAULT NULL,
  `Utente_mod` smallint(6) DEFAULT NULL,
  PRIMARY KEY (`Id_operaio`),
  UNIQUE KEY `Ragione_sociale` (`Ragione_sociale`),
  UNIQUE KEY `unique_id_pubblico` (`id_pubblico`),
  KEY `Provincia` (`Provincia`,`Comune`,`Frazione`),
  KEY `Frazione` (`Frazione`),
  KEY `Comune` (`Comune`),
  KEY `livello_associato` (`livello_associato`),
  KEY `Tariffario` (`Tariffario`),
  KEY `qua` (`qualifica`),
  KEY `filiale` (`id_filiale`),
  KEY `banca_appoggio` (`livello_associato`) USING BTREE,
  KEY `Index_10_tipoope` (`tipo_operaio`) USING BTREE,
  KEY `Index_11_ut` (`id_utente`),
  CONSTRAINT `FK_operaio_7_filiale` FOREIGN KEY (`id_filiale`) REFERENCES `filiale` (`Id_filiale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_operaio_8` FOREIGN KEY (`tipo_operaio`) REFERENCES `tipo_operaio` (`id_tipo`),
  CONSTRAINT `FK_operaio_9_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_qual` FOREIGN KEY (`qualifica`) REFERENCES `qualifica` (`id_qualifica`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `operaio_ibfk_2` FOREIGN KEY (`Comune`) REFERENCES `comune` (`Id_comune`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `operaio_ibfk_3` FOREIGN KEY (`Frazione`) REFERENCES `frazione` (`Id_frazione`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `operaio_ibfk_4` FOREIGN KEY (`livello_associato`) REFERENCES `livello_associato` (`Id_livello`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `operaio_ibfk_5` FOREIGN KEY (`Tariffario`) REFERENCES `tariffario` (`Id_tariffario`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=194 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio_comunicazione
CREATE TABLE IF NOT EXISTS `operaio_comunicazione` (
  `id_comunicazione` int(11) NOT NULL AUTO_INCREMENT,
  `id_operaio` int(11) NOT NULL,
  `nota` mediumtext NOT NULL,
  PRIMARY KEY (`id_comunicazione`),
  KEY `Index_operaio` (`id_operaio`),
  CONSTRAINT `FK_operaio_comunicazione_1` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio_contratto
CREATE TABLE IF NOT EXISTS `operaio_contratto` (
  `id_contratto` int(11) NOT NULL AUTO_INCREMENT,
  `id_tariffario` int(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  `data_inizio` date NOT NULL,
  `data_fine` date NOT NULL,
  `stato` tinyint(4) NOT NULL,
  PRIMARY KEY (`id_contratto`),
  KEY `Index_2_tariffario` (`id_tariffario`),
  KEY `Index_3_operaio` (`id_operaio`),
  CONSTRAINT `FK_operaio_contratto_operaio` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_operaio_contratto_tariffario` FOREIGN KEY (`id_tariffario`) REFERENCES `tariffario` (`Id_tariffario`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=41 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio_corso
CREATE TABLE IF NOT EXISTS `operaio_corso` (
  `id_corso` int(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  `passato` tinyint(4) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_corso`,`id_operaio`) USING BTREE,
  KEY `Index_2_operaio` (`id_operaio`),
  KEY `Index_3_id_corso` (`id_corso`),
  CONSTRAINT `FK_operaio_corso_2_corso` FOREIGN KEY (`id_corso`) REFERENCES `corso` (`id_corso`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_operaio_corso_operaio` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio_dpi
CREATE TABLE IF NOT EXISTS `operaio_dpi` (
  `id_dpi` int(11) NOT NULL AUTO_INCREMENT,
  `id_articolo` varchar(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  `data_consegna` date DEFAULT NULL,
  `stato` tinyint(4) DEFAULT NULL,
  `data_disuso` date DEFAULT NULL,
  `quantita` int(11) NOT NULL DEFAULT '1',
  `firma` blob,
  `data_scadenza` date DEFAULT NULL,
  `id_evento_scadenza` int(10) unsigned DEFAULT NULL,
  `data_promemoria` date DEFAULT NULL,
  `id_evento_promemoria` int(10) unsigned DEFAULT NULL,
  PRIMARY KEY (`id_dpi`),
  KEY `Index_operaio` (`id_operaio`),
  KEY `Index_3_articolo` (`id_articolo`),
  KEY `Index_4_stato` (`stato`),
  KEY `FK_operatio_dpi_evento_scadenza` (`id_evento_scadenza`),
  KEY `FK_operatio_dpi_evento_promemoria` (`id_evento_promemoria`),
  CONSTRAINT `FK_operaio_dpi_articolo` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_operaio_dpi_operaio` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_operaio_dpi_stato` FOREIGN KEY (`stato`) REFERENCES `stato_dpi` (`id_stato`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_operatio_dpi_evento_promemoria` FOREIGN KEY (`id_evento_promemoria`) REFERENCES `evento` (`Id`) ON DELETE SET NULL ON UPDATE NO ACTION,
  CONSTRAINT `FK_operatio_dpi_evento_scadenza` FOREIGN KEY (`id_evento_scadenza`) REFERENCES `evento` (`Id`) ON DELETE SET NULL ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=57 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio_nota
CREATE TABLE IF NOT EXISTS `operaio_nota` (
  `id_operaio` int(11) NOT NULL,
  `nota` mediumtext NOT NULL,
  `descrizione` varchar(30) NOT NULL,
  `data_ult_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_operaio`,`descrizione`) USING BTREE,
  KEY `on_operaio` (`id_operaio`),
  KEY `Index_on_tiponota` (`descrizione`) USING BTREE,
  CONSTRAINT `FK_on_operaio` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio_patente
CREATE TABLE IF NOT EXISTS `operaio_patente` (
  `id_patente` int(11) NOT NULL AUTO_INCREMENT,
  `descrizione` varchar(1) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  `data_patente` date NOT NULL,
  PRIMARY KEY (`id_patente`),
  KEY `operaio` (`id_operaio`),
  KEY `tipo` (`descrizione`) USING BTREE,
  CONSTRAINT `FK_operaio` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio_spostamenti
CREATE TABLE IF NOT EXISTS `operaio_spostamenti` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_operaio` int(11) NOT NULL DEFAULT '0' COMMENT 'id_operatio connesso al tablet',
  `Id_utente` int(11) NOT NULL DEFAULT '0' COMMENT 'id_utente connesso al tablet',
  `Latitudine` decimal(11,8) NOT NULL DEFAULT '0.00000000',
  `Longitudine` decimal(11,8) NOT NULL DEFAULT '0.00000000',
  `Data_rilevazione` datetime NOT NULL COMMENT 'Data rilevazione coordinate',
  `Sorgente_rilevazione` tinyint(4) DEFAULT NULL COMMENT 'Tipo di sorgente rilevazione. 1 = GPS | 2 = rete telefonica  | 3 = Altro',
  `Data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=63522 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operaio_telefono
CREATE TABLE IF NOT EXISTS `operaio_telefono` (
  `id_telefono` int(11) NOT NULL AUTO_INCREMENT,
  `id_operaio` int(11) NOT NULL,
  `gestore` varchar(45) DEFAULT NULL,
  `contratto` varchar(45) DEFAULT NULL,
  `telefono` varchar(11) NOT NULL,
  `pin` varchar(20) DEFAULT NULL,
  `puk` varchar(20) DEFAULT NULL,
  `nota` text,
  `data` date DEFAULT NULL,
  `scadenza` date DEFAULT NULL,
  `imai` varchar(72) DEFAULT NULL,
  PRIMARY KEY (`id_telefono`),
  KEY `FK_operaio_telefono_1_oper` (`id_operaio`),
  CONSTRAINT `FK_operaio_telefono_1_oper` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operazione
CREATE TABLE IF NOT EXISTS `operazione` (
  `Id_operazione` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(200) NOT NULL,
  PRIMARY KEY (`Id_operazione`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operazione_serial_number
CREATE TABLE IF NOT EXISTS `operazione_serial_number` (
  `Articolo` varchar(11) NOT NULL,
  `Id_operazione` bigint(20) NOT NULL,
  `numero` int(11) NOT NULL,
  PRIMARY KEY (`Id_operazione`,`numero`),
  KEY `Id_operazione` (`Id_operazione`),
  CONSTRAINT `operazione_serial_number_ibfk_2` FOREIGN KEY (`Id_operazione`) REFERENCES `magazzino_operazione` (`Id_operazione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.operazioni_articoli
CREATE TABLE IF NOT EXISTS `operazioni_articoli` (
  `id_operazione` int(10) NOT NULL AUTO_INCREMENT,
  `nome` varchar(100) NOT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_operazione`)
) ENGINE=InnoDB AUTO_INCREMENT=146 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ordine_dettaglio
CREATE TABLE IF NOT EXISTS `ordine_dettaglio` (
  `id_ordine` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `numero_tab` int(11) NOT NULL,
  `id_Articolo` varchar(13) DEFAULT NULL,
  `desc_breve` text,
  `codice_fornitore` varchar(20) DEFAULT NULL,
  `id_cliente` int(11) DEFAULT NULL,
  `id_fornitore` int(11) DEFAULT NULL,
  `qt` double(11,2) DEFAULT NULL,
  `scadenza` date DEFAULT NULL,
  `id_nota` int(11) DEFAULT NULL,
  `id_commessa` int(11) DEFAULT NULL,
  `anno_commessa` int(11) DEFAULT NULL,
  `id_sottocommessa` int(11) DEFAULT NULL,
  `com_lotto` int(11) DEFAULT NULL,
  `tipo` varchar(5) DEFAULT NULL,
  `prez` decimal(11,2) DEFAULT NULL,
  `iva` varchar(10) DEFAULT NULL,
  PRIMARY KEY (`id_ordine`,`anno`,`numero_tab`),
  KEY `Index_3` (`id_cliente`),
  KEY `FK_ordine_Forn` (`id_fornitore`),
  KEY `FK_ordine_art` (`id_Articolo`),
  KEY `FK_ordine_not` (`id_nota`),
  CONSTRAINT `FK_ordine` FOREIGN KEY (`id_ordine`, `anno`) REFERENCES `ordine_fornitore` (`id_ordine`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_art` FOREIGN KEY (`id_Articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_Forn` FOREIGN KEY (`id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_not` FOREIGN KEY (`id_nota`) REFERENCES `nota` (`id_nota`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_o_cliente` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ordine_fornitore
CREATE TABLE IF NOT EXISTS `ordine_fornitore` (
  `id_ordine` int(11) NOT NULL,
  `descrizione` varchar(45) DEFAULT NULL,
  `data_ordine` date DEFAULT NULL,
  `data_creazione` date DEFAULT NULL,
  `nota_interna` text,
  `nota` text,
  `id_fornitore` int(11) DEFAULT NULL,
  `condizione_pagamento` int(11) DEFAULT NULL,
  `anno` int(11) NOT NULL,
  `destinazione` int(11) DEFAULT NULL,
  `id_cliente` int(11) DEFAULT NULL,
  `vettore` int(11) DEFAULT NULL,
  `porto_reso` int(11) DEFAULT NULL,
  `trasporto_cura` int(11) DEFAULT NULL,
  `stato` int(11) NOT NULL DEFAULT '0',
  `segna_come_evaso` bit(1) NOT NULL DEFAULT b'0',
  `stato_pre_evasione` int(11) DEFAULT NULL,
  `utente_evasione` int(11) DEFAULT NULL,
  `inviato` int(11) NOT NULL DEFAULT '0',
  `stampato` tinyint(4) NOT NULL DEFAULT '0',
  `id_utente` int(11) DEFAULT NULL,
  `data_ultima_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_ordine`,`anno`) USING BTREE,
  KEY `FK_ordine_fornitore_1.` (`condizione_pagamento`),
  KEY `FK_ordine_fornitore_2` (`id_fornitore`),
  KEY `Index_5` (`id_cliente`),
  KEY `FK_ordine_fornitore_4` (`id_cliente`,`destinazione`),
  KEY `FK_ordine_fornitore_5` (`id_utente`),
  KEY `FK_ordine_fornitore_7` (`vettore`),
  KEY `FK_ordine_fornitore_8` (`trasporto_cura`),
  KEY `FK_ordine_fornitore_6` (`porto_reso`) USING BTREE,
  KEY `FK_ordine_fornitore_9` (`utente_evasione`),
  CONSTRAINT `FK_ordine_fornitore_1.` FOREIGN KEY (`condizione_pagamento`) REFERENCES `condizione_pagamento` (`Id_condizione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_fornitore_2` FOREIGN KEY (`id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_fornitore_3` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_fornitore_4` FOREIGN KEY (`id_cliente`, `destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_fornitore_5` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_fornitore_6` FOREIGN KEY (`porto_reso`) REFERENCES `porto_resa` (`Id_porto_resa`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_fornitore_7` FOREIGN KEY (`vettore`) REFERENCES `vettore` (`Id_vettore`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_fornitore_8` FOREIGN KEY (`trasporto_cura`) REFERENCES `trasporto_cura` (`Id_trasporto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ordine_fornitore_9` FOREIGN KEY (`utente_evasione`) REFERENCES `utente` (`Id_utente`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ordine_impostazione
CREATE TABLE IF NOT EXISTS `ordine_impostazione` (
  `tipo_impostazione` varchar(20) NOT NULL,
  `valore` varchar(100) NOT NULL,
  PRIMARY KEY (`tipo_impostazione`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ordini_ddt_ricevuti
CREATE TABLE IF NOT EXISTS `ordini_ddt_ricevuti` (
  `id_ordine` int(11) NOT NULL,
  `anno_ordine` int(11) NOT NULL,
  `id_ddt` int(11) NOT NULL,
  `anno_ddt` int(11) NOT NULL,
  PRIMARY KEY (`id_ordine`,`anno_ordine`,`anno_ddt`,`id_ddt`),
  KEY `FK_ordini_ddt_ricevuti_1` (`id_ddt`,`anno_ddt`),
  CONSTRAINT `FK_ordini_ddt_ricevuti_1` FOREIGN KEY (`id_ddt`, `anno_ddt`) REFERENCES `ddt_ricevuti` (`Id_ddt`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_ordini_ddt_ricevuti_2` FOREIGN KEY (`id_ordine`, `anno_ordine`) REFERENCES `ordine_fornitore` (`id_ordine`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.password
CREATE TABLE IF NOT EXISTS `password` (
  `Utente` varchar(30) NOT NULL,
  `Password` varchar(50) DEFAULT NULL,
  PRIMARY KEY (`Utente`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pericolo
CREATE TABLE IF NOT EXISTS `pericolo` (
  `id_frase` int(11) NOT NULL AUTO_INCREMENT,
  `id_tipo` int(11) NOT NULL,
  `codice` varchar(20) NOT NULL,
  `descrizione` varchar(150) NOT NULL,
  PRIMARY KEY (`id_frase`)
) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.periti
CREATE TABLE IF NOT EXISTS `periti` (
  `id_perito` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(100) NOT NULL,
  PRIMARY KEY (`id_perito`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.permessi_firme
CREATE TABLE IF NOT EXISTS `permessi_firme` (
  `id_utente` int(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  PRIMARY KEY (`id_utente`,`id_operaio`),
  KEY `FK_firme` (`id_operaio`),
  CONSTRAINT `FK_firme` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_utenti` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pervenuta_per
CREATE TABLE IF NOT EXISTS `pervenuta_per` (
  `Id_modo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(30) NOT NULL,
  PRIMARY KEY (`Id_modo`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.porto_resa
CREATE TABLE IF NOT EXISTS `porto_resa` (
  `Id_porto_resa` int(11) NOT NULL AUTO_INCREMENT,
  `Descrizione` varchar(200) NOT NULL,
  `Nome` varchar(50) NOT NULL,
  PRIMARY KEY (`Id_porto_resa`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos
CREATE TABLE IF NOT EXISTS `pos` (
  `id_pos` int(11) NOT NULL AUTO_INCREMENT,
  `id_azi` int(11) NOT NULL,
  `id_clie` int(11) NOT NULL,
  `data` date NOT NULL,
  `commissionato` varchar(45) DEFAULT NULL,
  `comune` varchar(45) DEFAULT NULL,
  `indirizzo` varchar(45) DEFAULT NULL,
  `numero` varchar(45) DEFAULT NULL,
  `titolare` varchar(45) DEFAULT NULL,
  `settore` varchar(45) DEFAULT NULL,
  `numero_rea` varchar(45) DEFAULT NULL,
  `posizione_inps` varchar(45) DEFAULT NULL,
  `codice_ateco` varchar(45) DEFAULT NULL,
  `posizione_inail` varchar(45) DEFAULT NULL,
  `assicu_rct` varchar(45) DEFAULT NULL,
  `durata` int(11) DEFAULT NULL,
  `importo` float DEFAULT NULL,
  `lavori` text,
  `fornitura` text,
  `servizi` text,
  `id_commessa` int(11) DEFAULT NULL,
  `anno` int(11) DEFAULT NULL,
  `locale` varchar(45) DEFAULT NULL,
  `appalto` varchar(45) DEFAULT NULL,
  `oneri` float DEFAULT '0',
  `inviato` tinyint(4) NOT NULL DEFAULT '0',
  `stampato` tinyint(4) NOT NULL DEFAULT '0',
  `presenti_dal` date NOT NULL,
  `presenti_al` date NOT NULL,
  `direzione` tinyint(4) NOT NULL,
  `altro` varchar(60) DEFAULT NULL,
  PRIMARY KEY (`id_pos`),
  KEY `Index_2_azi` (`id_azi`),
  KEY `Index_4_clie` (`id_clie`),
  KEY `Index_5_comme` (`id_commessa`),
  KEY `FK_pos_4_commessa` (`id_commessa`,`anno`),
  KEY `Index_7_anno` (`anno`),
  CONSTRAINT `FK_pos_1_azi` FOREIGN KEY (`id_azi`) REFERENCES `azienda` (`id_azienda`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_pos_3_clie` FOREIGN KEY (`id_clie`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_pos_4_commessa` FOREIGN KEY (`id_commessa`, `anno`) REFERENCES `commessa` (`Id_commessa`, `anno`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_attivita
CREATE TABLE IF NOT EXISTS `pos_attivita` (
  `id_pos` int(11) NOT NULL,
  `id_attivita` int(11) NOT NULL,
  PRIMARY KEY (`id_pos`,`id_attivita`),
  KEY `FK_pos_attivita_2_lav` (`id_attivita`),
  CONSTRAINT `FK_pos_attivita_2_lav` FOREIGN KEY (`id_attivita`) REFERENCES `causale_lavoro` (`Id_causale`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_pos_check_attivita_1_pos` FOREIGN KEY (`id_pos`) REFERENCES `pos` (`id_pos`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_check
CREATE TABLE IF NOT EXISTS `pos_check` (
  `id_pos` int(11) NOT NULL,
  `id_risc` int(11) NOT NULL,
  PRIMARY KEY (`id_pos`,`id_risc`),
  KEY `Index_2_pos` (`id_pos`),
  KEY `Index_3_risc` (`id_risc`),
  CONSTRAINT `FK_pos_check_1_pos` FOREIGN KEY (`id_pos`) REFERENCES `pos` (`id_pos`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_pos_check_2_risc` FOREIGN KEY (`id_risc`) REFERENCES `pos_risc` (`id_risc`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_funz_azi
CREATE TABLE IF NOT EXISTS `pos_funz_azi` (
  `id_pos` int(11) NOT NULL AUTO_INCREMENT,
  `id_operaio` int(11) NOT NULL,
  `funzione` int(11) NOT NULL,
  PRIMARY KEY (`id_pos`,`id_operaio`,`funzione`) USING BTREE,
  KEY `Index_2_funz` (`funzione`),
  KEY `Index_3_ope` (`id_operaio`),
  CONSTRAINT `FK_pos_funz_azi_3_pos` FOREIGN KEY (`id_pos`) REFERENCES `pos` (`id_pos`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_pos_funz_int_1_ope` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_pos_funz_int_2_funz` FOREIGN KEY (`funzione`) REFERENCES `tipo_funzione` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_furgoni
CREATE TABLE IF NOT EXISTS `pos_furgoni` (
  `id_pos` int(11) NOT NULL,
  `id_auto` int(11) NOT NULL,
  PRIMARY KEY (`id_pos`,`id_auto`),
  KEY `FK_pos_furgoni_2_auto` (`id_auto`),
  CONSTRAINT `FK_pos_furgoni_1_pos` FOREIGN KEY (`id_pos`) REFERENCES `pos` (`id_pos`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_pos_furgoni_2_auto` FOREIGN KEY (`id_auto`) REFERENCES `automezzo` (`id_auto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_furgoni_attrez
CREATE TABLE IF NOT EXISTS `pos_furgoni_attrez` (
  `id_furgone` int(11) NOT NULL,
  `descrizione` varchar(150) NOT NULL,
  `quantita` double(11,2) NOT NULL,
  `id_pos` int(11) NOT NULL,
  `id_articolo` varchar(11) NOT NULL,
  PRIMARY KEY (`id_furgone`,`id_pos`,`id_articolo`) USING BTREE,
  KEY `FK_pos_furgoni_attrez_1_fur` (`id_pos`,`id_furgone`),
  CONSTRAINT `FK_pos_furgoni_attrez_1_fur` FOREIGN KEY (`id_pos`, `id_furgone`) REFERENCES `pos_furgoni` (`id_pos`, `id_auto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_interferenza
CREATE TABLE IF NOT EXISTS `pos_interferenza` (
  `id_pos` int(11) NOT NULL,
  `id_interferenza` int(11) NOT NULL,
  `descrizione` text NOT NULL,
  `misure` text NOT NULL,
  `costo` double(11,2) NOT NULL,
  PRIMARY KEY (`id_pos`,`id_interferenza`),
  CONSTRAINT `FK_pos_interferenze_1_pos` FOREIGN KEY (`id_pos`) REFERENCES `pos` (`id_pos`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_modifica
CREATE TABLE IF NOT EXISTS `pos_modifica` (
  `id_modifica` int(11) NOT NULL,
  `id_pos` int(11) NOT NULL,
  `data_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `paragrafo` varchar(150) NOT NULL,
  `descrizione` text NOT NULL,
  `origine` text NOT NULL,
  PRIMARY KEY (`id_modifica`,`id_pos`),
  KEY `FK_pos_modifche_1_pos` (`id_pos`),
  CONSTRAINT `FK_pos_modifche_1_pos` FOREIGN KEY (`id_pos`) REFERENCES `pos` (`id_pos`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_paragrafo
CREATE TABLE IF NOT EXISTS `pos_paragrafo` (
  `id_paragrafo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(100) DEFAULT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_paragrafo`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_risc
CREATE TABLE IF NOT EXISTS `pos_risc` (
  `id_risc` int(11) NOT NULL AUTO_INCREMENT,
  `aspetto` text,
  `fattore` text,
  `indi` text,
  `rischio` int(11) DEFAULT NULL,
  `mis_add` text,
  `mis_da_add` text,
  PRIMARY KEY (`id_risc`),
  KEY `Index_2_ris` (`rischio`),
  CONSTRAINT `FK_posrisc_1_risc` FOREIGN KEY (`rischio`) REFERENCES `tipo_rischio` (`id_rischio`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_sostanza
CREATE TABLE IF NOT EXISTS `pos_sostanza` (
  `id_pos` int(11) NOT NULL,
  `id_sostanza` int(11) NOT NULL,
  `uso` varchar(150) NOT NULL,
  PRIMARY KEY (`id_pos`,`id_sostanza`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_subapp
CREATE TABLE IF NOT EXISTS `pos_subapp` (
  `id_pos` int(10) NOT NULL,
  `id_cliente` int(10) NOT NULL,
  `titolare` varchar(45) DEFAULT NULL,
  `settore` varchar(45) DEFAULT NULL,
  `numero_rea` varchar(45) DEFAULT NULL,
  `posizione_inps` varchar(45) DEFAULT NULL,
  `codice_ateco` varchar(45) DEFAULT NULL,
  `posizione_inail` varchar(45) DEFAULT NULL,
  `comune` varchar(45) DEFAULT NULL,
  `indirizzo` varchar(45) DEFAULT NULL,
  `assicu_rct` varchar(45) DEFAULT NULL,
  `numero` int(11) DEFAULT NULL,
  `mansione` text,
  PRIMARY KEY (`id_pos`,`id_cliente`) USING BTREE,
  KEY `Index_2_subb` (`id_cliente`),
  CONSTRAINT `FK_pos_subapp_1sub` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.pos_subparagrafo
CREATE TABLE IF NOT EXISTS `pos_subparagrafo` (
  `id_subparagrafo` int(11) NOT NULL AUTO_INCREMENT,
  `id_paragrafo` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  `descrizione` text NOT NULL,
  PRIMARY KEY (`id_subparagrafo`,`id_paragrafo`) USING BTREE,
  KEY `FK_pos_subparagrafo_1_paragrafo` (`id_paragrafo`),
  CONSTRAINT `FK_pos_subparagrafo_1_paragrafo` FOREIGN KEY (`id_paragrafo`) REFERENCES `pos_paragrafo` (`id_paragrafo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo
CREATE TABLE IF NOT EXISTS `preventivo` (
  `Id_preventivo` int(11) NOT NULL,
  `revisione` int(11) DEFAULT NULL,
  `data_creazione` date NOT NULL,
  `Stato` int(11) DEFAULT NULL,
  `Note` longtext,
  `anno` int(11) NOT NULL DEFAULT '0',
  `tipo_preventivo` int(11) NOT NULL DEFAULT '1',
  `tipo` int(11) DEFAULT '1',
  `agente` int(11) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `per` int(11) DEFAULT NULL,
  `da` int(11) DEFAULT NULL,
  `segnalato` varchar(100) DEFAULT NULL,
  `data_invio` date DEFAULT NULL,
  `controllo_promemoria` tinyint(1) unsigned DEFAULT '1',
  `primo_sollecito` date DEFAULT NULL,
  `secondo_sollecito` date DEFAULT NULL,
  PRIMARY KEY (`Id_preventivo`,`anno`),
  KEY `Stato` (`Stato`),
  KEY `anno` (`anno`),
  KEY `Index_6` (`tipo_preventivo`) USING BTREE,
  KEY `Index_8` (`anno`,`Id_preventivo`) USING BTREE,
  KEY `Index_6_agi` (`agente`),
  KEY `Index_7_ut` (`id_utente`),
  KEY `Index_8_per` (`per`),
  KEY `Index_9_da` (`da`),
  KEY `FK_preventivo_7` (`tipo`),
  CONSTRAINT `FK_preventivo_3_agi` FOREIGN KEY (`agente`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_preventivo_4_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_preventivo_5_per` FOREIGN KEY (`per`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_preventivo_6_da` FOREIGN KEY (`da`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_preventivo_7` FOREIGN KEY (`tipo`) REFERENCES `tipo_preventivo` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `preventivo_ibfk_13` FOREIGN KEY (`Stato`) REFERENCES `stato_preventivo` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `tipo` FOREIGN KEY (`tipo_preventivo`) REFERENCES `tipo_intprev` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_confcost_categoria
CREATE TABLE IF NOT EXISTS `preventivo_confcost_categoria` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_articolo_abbonamento
CREATE TABLE IF NOT EXISTS `preventivo_articolo_abbonamento` (
  `id_preventivo` int(11) NOT NULL,
  `id_lotto` int(11) NOT NULL,
  `numero` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `revisione` int(11) NOT NULL,
  `parametro` decimal(11,2) DEFAULT NULL,
  `tab` int(11) NOT NULL,
  PRIMARY KEY (`id_preventivo`,`id_lotto`,`anno`,`revisione`,`tab`,`numero`) USING BTREE,
  KEY `Index_2` (`revisione`,`tab`,`anno`,`id_preventivo`,`id_lotto`),
  KEY `preve_abbo` (`id_preventivo`,`revisione`,`anno`,`id_lotto`,`tab`),
  CONSTRAINT `preve_abbo` FOREIGN KEY (`id_preventivo`, `revisione`, `anno`, `id_lotto`, `tab`) REFERENCES `articolo_preventivo` (`Id_preventivo`, `Id_revisione`, `anno`, `Lotto`, `id_tab`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_azioni
CREATE TABLE IF NOT EXISTS `preventivo_azioni` (
  `id_azione` int(11) NOT NULL AUTO_INCREMENT,
  `id_nome` varchar(45) NOT NULL,
  `stato` varchar(45) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id_azione`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_confcost
CREATE TABLE IF NOT EXISTS `preventivo_confcost` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `conservare` decimal(11,2) DEFAULT '0.00',
  `costi` decimal(11,2) NOT NULL DEFAULT '0.00',
  `utile` decimal(11,2) NOT NULL DEFAULT '0.00',
  `agente` decimal(11,2) NOT NULL DEFAULT '0.00',
  `sconto` decimal(11,2) NOT NULL DEFAULT '0.00',
  `fattore1` decimal(11,2) NOT NULL DEFAULT '0.00',
  `fattore2` decimal(11,2) NOT NULL DEFAULT '0.00',
  `id_categoria` int(11) NOT NULL DEFAULT '1',
  `data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `utente_ins` mediumint(9) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id`),
  KEY `FK_categoria` (`id_categoria`),
  CONSTRAINT `FK_categoria` FOREIGN KEY (`id_categoria`) REFERENCES `preventivo_confcost_categoria` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_controllo_esclusioni
CREATE TABLE IF NOT EXISTS `preventivo_controllo_esclusioni` (
  `id_esclusione` int(11) NOT NULL,
  `tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_esclusione`,`tipo`) USING BTREE,
  KEY `esdc_tipo` (`tipo`),
  CONSTRAINT `esdc_tipo` FOREIGN KEY (`tipo`) REFERENCES `tipo_intprev` (`id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_esc` FOREIGN KEY (`id_esclusione`) REFERENCES `esclusioni` (`id_esclusione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_default
CREATE TABLE IF NOT EXISTS `preventivo_default` (
  `testo` text NOT NULL,
  `oggetto` varchar(45) NOT NULL,
  PRIMARY KEY (`oggetto`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_fine
CREATE TABLE IF NOT EXISTS `preventivo_fine` (
  `id_paragrafo` int(11) NOT NULL AUTO_INCREMENT,
  `id_tipo` int(11) NOT NULL,
  `titolo` varchar(200) NOT NULL,
  `testo` text,
  `posizione` int(11) NOT NULL,
  `tipo_preventivo` int(11) NOT NULL,
  PRIMARY KEY (`id_paragrafo`,`id_tipo`,`tipo_preventivo`) USING BTREE,
  UNIQUE KEY `Index_2_posizion` (`posizione`,`id_tipo`,`tipo_preventivo`) USING BTREE,
  KEY `FK_preventivo_fine_1` (`tipo_preventivo`),
  CONSTRAINT `FK_preventivo_fine_1` FOREIGN KEY (`tipo_preventivo`) REFERENCES `tipo_preventivo` (`id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=35 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_impianto
CREATE TABLE IF NOT EXISTS `preventivo_impianto` (
  `id_preventivo` int(11) NOT NULL AUTO_INCREMENT,
  `anno` int(11) NOT NULL,
  `revisione` int(11) NOT NULL,
  `impianto` int(11) NOT NULL,
  PRIMARY KEY (`id_preventivo`,`impianto`,`revisione`,`anno`),
  KEY `revev` (`revisione`,`id_preventivo`,`anno`),
  KEY `FK_preventivo_impianto_2` (`impianto`),
  CONSTRAINT `FK_preventivo_impianto_2` FOREIGN KEY (`impianto`) REFERENCES `preventivo_predefinito` (`id_predefinito`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `revev` FOREIGN KEY (`revisione`, `id_preventivo`, `anno`) REFERENCES `revisione_preventivo` (`Id_revisione`, `Id_preventivo`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=271 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_impost
CREATE TABLE IF NOT EXISTS `preventivo_impost` (
  `tipo` varchar(50) NOT NULL,
  `valore` text NOT NULL,
  PRIMARY KEY (`tipo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_lotto
CREATE TABLE IF NOT EXISTS `preventivo_lotto` (
  `id_lotto` int(11) NOT NULL,
  `id_preventivo` int(11) NOT NULL,
  `id_revisione` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `posizione` int(11) NOT NULL,
  `nota` text,
  `prefazione` longtext,
  `id_impianto` int(11) DEFAULT NULL,
  `id_Abbo` int(11) DEFAULT NULL,
  `scon` double DEFAULT NULL,
  `ora_p` double DEFAULT NULL,
  `ora_c` double DEFAULT NULL,
  `optional` tinyint(4) DEFAULT '0',
  `iv_lot` int(11) DEFAULT NULL,
  `tipo_ricar` tinyint(4) DEFAULT '0',
  `perc_ric` decimal(10,0) DEFAULT '0',
  PRIMARY KEY (`posizione`,`anno`,`id_revisione`,`id_preventivo`) USING BTREE,
  KEY `Index_2` (`id_preventivo`,`id_revisione`,`anno`,`posizione`),
  KEY `preventivo` (`id_preventivo`,`anno`),
  KEY `rev` (`id_revisione`,`id_preventivo`,`anno`),
  KEY `lotto` (`id_lotto`),
  KEY `abbo_preve` (`id_Abbo`),
  CONSTRAINT `abbo_preve` FOREIGN KEY (`id_Abbo`) REFERENCES `abbonamento` (`Id_abbonamento`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `lotto` FOREIGN KEY (`id_lotto`) REFERENCES `lotto` (`Id_lotto`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `preventivo` FOREIGN KEY (`id_preventivo`, `anno`) REFERENCES `preventivo` (`Id_preventivo`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `rev` FOREIGN KEY (`id_revisione`, `id_preventivo`, `anno`) REFERENCES `revisione_preventivo` (`Id_revisione`, `Id_preventivo`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_lotto_pdf
CREATE TABLE IF NOT EXISTS `preventivo_lotto_pdf` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_preventivo` int(11) NOT NULL,
  `id_revisione` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `posizione_lotto` int(11) NOT NULL,
  `posizione` int(11) NOT NULL,
  `filepath` mediumtext NOT NULL,
  `filename` varchar(250) NOT NULL,
  `utente_mod` int(11) DEFAULT NULL,
  `data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_preventivo_id_revisione_anno_posizione_lotto_posizione` (`id_preventivo`,`id_revisione`,`anno`,`posizione_lotto`,`posizione`),
  KEY `FK_preventivo_lotto_pdf_utente` (`utente_mod`),
  CONSTRAINT `FK_preventivo_lotto_pdf_utente` FOREIGN KEY (`utente_mod`) REFERENCES `utente` (`Id_utente`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_preventivo_lotto_preventivo_lotto_preventivo_lotto_pdf` FOREIGN KEY (`id_preventivo`, `id_revisione`, `anno`, `posizione_lotto`) REFERENCES `preventivo_lotto` (`id_preventivo`, `id_revisione`, `anno`, `posizione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=31 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_lotto_pdf_posizione
CREATE TABLE IF NOT EXISTS `preventivo_lotto_pdf_posizione` (
  `id_posizione` int(11) NOT NULL,
  `nome` varchar(50) NOT NULL,
  PRIMARY KEY (`id_posizione`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_note_controlli
CREATE TABLE IF NOT EXISTS `preventivo_note_controlli` (
  `id_nota` int(11) DEFAULT NULL,
  `tipo_impianto` int(11) NOT NULL,
  `nota_prova` int(11) DEFAULT NULL,
  PRIMARY KEY (`tipo_impianto`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_note_imp_manutenzione
CREATE TABLE IF NOT EXISTS `preventivo_note_imp_manutenzione` (
  `tipo_impianto` int(11) DEFAULT NULL,
  `id_nota` int(11) DEFAULT NULL,
  `id_azioni` int(11) DEFAULT NULL,
  `id_prima` int(11) DEFAULT NULL,
  KEY `Index_1` (`tipo_impianto`),
  CONSTRAINT `FK_preventivo_note_imp_manutenzione_1` FOREIGN KEY (`tipo_impianto`) REFERENCES `tipo_impianto` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_predefinito
CREATE TABLE IF NOT EXISTS `preventivo_predefinito` (
  `id_predefinito` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `stato` int(11) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id_predefinito`)
) ENGINE=InnoDB AUTO_INCREMENT=23 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_progetti
CREATE TABLE IF NOT EXISTS `preventivo_progetti` (
  `id_preventivo` int(11) NOT NULL,
  `anno_Preventivo` int(11) NOT NULL,
  `id_progetto` int(11) NOT NULL,
  PRIMARY KEY (`id_preventivo`,`anno_Preventivo`,`id_progetto`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_ticket
CREATE TABLE IF NOT EXISTS `preventivo_ticket` (
  `id_preventivo` int(11) NOT NULL,
  `anno_preventivo` int(11) NOT NULL,
  `id_ticket` int(11) NOT NULL,
  `anno_ticket` int(11) NOT NULL,
  PRIMARY KEY (`id_preventivo`,`id_ticket`,`anno_preventivo`,`anno_ticket`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.preventivo_tipo_predefinito
CREATE TABLE IF NOT EXISTS `preventivo_tipo_predefinito` (
  `id_lotto` int(11) DEFAULT NULL,
  `id_Predefinito` int(11) NOT NULL,
  `id_tipo` int(11) NOT NULL,
  PRIMARY KEY (`id_Predefinito`,`id_tipo`) USING BTREE,
  KEY `FK_preventivo_tipo_predefinito_2` (`id_tipo`),
  KEY `FK_preventivo_tipo_predefinito_2_lotto` (`id_lotto`),
  CONSTRAINT `FK_preventivo_tipo_predefinito_2` FOREIGN KEY (`id_tipo`) REFERENCES `tipo_intprev` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_preventivo_tipo_predefinito_2_lotto` FOREIGN KEY (`id_lotto`) REFERENCES `lotto` (`Id_lotto`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.primanota_impostazioni
CREATE TABLE IF NOT EXISTS `primanota_impostazioni` (
  `nome` varchar(100) NOT NULL,
  `valore` varchar(100) NOT NULL,
  PRIMARY KEY (`nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.prima_nota
CREATE TABLE IF NOT EXISTS `prima_nota` (
  `Id_prima_nota` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `Data` date NOT NULL,
  `Dipendente` int(11) NOT NULL,
  `Tipo_spesa` int(11) NOT NULL,
  `Spesa` decimal(11,2) NOT NULL,
  `Note_spesa` varchar(100) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `id_fattura` int(11) DEFAULT NULL,
  `anno_fattura` int(11) DEFAULT NULL,
  `id_fornfattura` int(11) DEFAULT NULL,
  `anno_fornfattura` int(11) DEFAULT NULL,
  `id_pagamento` int(11) DEFAULT NULL,
  `ricevente` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_prima_nota`,`anno`),
  KEY `Dipendente` (`Dipendente`),
  KEY `Tipo_spesa` (`Tipo_spesa`),
  KEY `Index_4_ut` (`id_utente`),
  KEY `FK_prima_nota_4_fattura` (`id_fattura`,`anno_fattura`),
  KEY `FK_prima_nota_4_fattura_pag` (`id_fattura`,`anno_fornfattura`,`id_pagamento`),
  KEY `FK_prima_nota_5_fornfattura_pag` (`id_fornfattura`,`anno_fornfattura`,`id_pagamento`),
  CONSTRAINT `FK_prima_nota_3_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_prima_nota_4_fattura_pag` FOREIGN KEY (`id_fattura`, `anno_fornfattura`, `id_pagamento`) REFERENCES `fattura_pagamenti` (`id_fattura`, `anno`, `id_pagamento`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_prima_nota_5_fornfattura_pag` FOREIGN KEY (`id_fornfattura`, `anno_fornfattura`, `id_pagamento`) REFERENCES `fornfattura_pagamenti` (`id_fattura`, `anno`, `id_pagamento`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `prima_nota_ibfk_1` FOREIGN KEY (`Dipendente`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `prima_nota_ibfk_2` FOREIGN KEY (`Tipo_spesa`) REFERENCES `tipo_spesa` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.progetti
CREATE TABLE IF NOT EXISTS `progetti` (
  `id_progetto` int(11) NOT NULL AUTO_INCREMENT,
  `id_cliente` int(11) DEFAULT NULL,
  `descrizione` varchar(45) NOT NULL,
  `data_inizio` date NOT NULL,
  `data_fine` date DEFAULT NULL,
  `tipo_progetto` int(11) NOT NULL,
  `stato_progetto` int(11) NOT NULL,
  `id_impianto` int(11) DEFAULT NULL,
  `nota` text,
  PRIMARY KEY (`id_progetto`),
  UNIQUE KEY `cartell` (`id_cliente`,`descrizione`) USING BTREE,
  KEY `tip` (`tipo_progetto`),
  KEY `stato` (`stato_progetto`),
  KEY `FK_progetti_4_imp` (`id_impianto`),
  CONSTRAINT `clien` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_progetti_4_imp` FOREIGN KEY (`id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `stato` FOREIGN KEY (`stato_progetto`) REFERENCES `stato_progetto` (`id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `tip` FOREIGN KEY (`tipo_progetto`) REFERENCES `tipo_progetti` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=191 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.progetti_nota
CREATE TABLE IF NOT EXISTS `progetti_nota` (
  `id_nota` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `descrizione` text NOT NULL,
  `data_ult_modifica` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `id_progetto` int(11) NOT NULL,
  PRIMARY KEY (`id_nota`,`id_progetto`) USING BTREE,
  KEY `FK_progetti_nota_1_prog` (`id_progetto`),
  CONSTRAINT `FK_progetti_nota_1_prog` FOREIGN KEY (`id_progetto`) REFERENCES `progetti` (`id_progetto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.province
CREATE TABLE IF NOT EXISTS `province` (
  `id_provincia` int(11) NOT NULL AUTO_INCREMENT,
  `Sigla` varchar(15) NOT NULL DEFAULT '',
  `Nome` varchar(45) NOT NULL,
  `Regione` int(11) NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`id_provincia`),
  KEY `Regione` (`Regione`),
  KEY `Sigla` (`Sigla`),
  CONSTRAINT `province_ibfk_1` FOREIGN KEY (`Regione`) REFERENCES `regione` (`Id_regione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=108 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.proxies_configurazione
CREATE TABLE IF NOT EXISTS `proxies_configurazione` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `tipo` varchar(20) NOT NULL,
  `base_host` varchar(150) NOT NULL,
  `basic_auth` varchar(200) DEFAULT NULL,
  `timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.qualifica
CREATE TABLE IF NOT EXISTS `qualifica` (
  `id_qualifica` int(11) NOT NULL AUTO_INCREMENT,
  `descrizione` varchar(45) DEFAULT NULL,
  `nome` varchar(100) NOT NULL,
  PRIMARY KEY (`id_qualifica`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto
CREATE TABLE IF NOT EXISTS `rapporto` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_rapporto` bigint(20) NOT NULL,
  `Anno` int(11) NOT NULL,
  `Id_Impianto` int(11) DEFAULT NULL,
  `id_destinazione` int(11) DEFAULT NULL,
  `Id_cliente` int(11) DEFAULT NULL,
  `Richiesto` varchar(30) DEFAULT NULL COMMENT 'Testo libero per inserire il nome del richiedente dell''intervento',
  `Mansione` varchar(20) DEFAULT NULL COMMENT 'Mansione del responabile',
  `Responsabile` varchar(30) DEFAULT NULL,
  `Tipo_intervento` int(11) DEFAULT NULL,
  `Diritto_chiamata` bit(1) NOT NULL DEFAULT b'0',
  `tipo_diritto_chiamata` tinyint(4) NOT NULL DEFAULT '0',
  `relazione` text,
  `Terminato` tinyint(1) DEFAULT NULL,
  `Funzionante` tinyint(1) DEFAULT NULL,
  `Stato` int(11) DEFAULT NULL,
  `Note_Generali` varchar(1000) DEFAULT NULL COMMENT 'Note generali (o in evidenza)',
  `Fattura` int(11) DEFAULT NULL,
  `Data` date DEFAULT NULL,
  `Commessa` int(11) DEFAULT NULL,
  `abbonamento` int(11) DEFAULT NULL,
  `Numero_ordine` varchar(11) DEFAULT NULL,
  `Totale` decimal(11,2) DEFAULT '0.00',
  `Nr_rapporto` varchar(40) DEFAULT ' ',
  `Data_esecuzione` date DEFAULT NULL,
  `Costo` decimal(10,2) DEFAULT '0.00',
  `scan` bit(1) DEFAULT b'0' COMMENT 'Identifica se il rapporto è stato scanerizzato o meno ',
  `anno_fattura` int(10) DEFAULT '0',
  `controllo_periodico` decimal(10,2) DEFAULT '0.00' COMMENT 'Prezzo del controllo periodico',
  `controllo_periodico_costo` decimal(10,2) DEFAULT '0.00' COMMENT 'Costo del controllo periodico',
  `controllo_periodico_quantita` int(11) DEFAULT '1' COMMENT 'Quantita del controllo periodico',
  `prima` bit(1) DEFAULT b'0' COMMENT 'Identifica se il rapporto prevede la prima ora',
  `numero` varchar(45) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `cost_lav` decimal(10,2) DEFAULT '0.00',
  `prez_lav` decimal(10,2) DEFAULT '0.00',
  `dest_cli` int(11) DEFAULT NULL,
  `appunti` text,
  `firma1` bit(1) DEFAULT NULL,
  `firma2` bit(1) DEFAULT NULL,
  `firma3` bit(1) DEFAULT NULL,
  `economia` decimal(10,2) DEFAULT '0.00',
  `Id_tipo_sorgente` int(11) NOT NULL DEFAULT '1' COMMENT 'TIPO SORGENTE DI ARRIVO DEL RAPPORTO ( 1 = cartaceo, 2 = telematico)',
  `id_tipo_rapporto` int(11) DEFAULT NULL,
  `filename_firma_cliente` varchar(50) DEFAULT NULL,
  `filename_firma_tecnico` varchar(50) DEFAULT NULL,
  `usa_firma_su_ddt` bit(1) DEFAULT b'0' COMMENT 'Se true viene usata la firma del rapporto su DDT automaticamente alla stampa',
  `filename_firma_per_ddt` varchar(50) DEFAULT NULL,
  `numero_allegati` smallint(6) NOT NULL DEFAULT '0',
  PRIMARY KEY (`Id_rapporto`,`Anno`),
  UNIQUE KEY `Id` (`Id`),
  KEY `Id_Impianto` (`Id_Impianto`),
  KEY `Id_cliente` (`Id_cliente`),
  KEY `Tipo_intervento` (`Tipo_intervento`),
  KEY `Stato` (`Stato`),
  KEY `id_destinazione` (`id_destinazione`),
  KEY `Anno` (`Anno`),
  KEY `abbonamento` (`abbonamento`),
  KEY `dest` (`id_destinazione`,`Id_cliente`),
  KEY `Fattura` (`Fattura`) USING BTREE,
  KEY `anfat` (`anno_fattura`) USING BTREE,
  KEY `fatt` (`anno_fattura`,`Fattura`),
  KEY `Index_13_ut` (`id_utente`),
  KEY `rap_dest` (`dest_cli`,`id_destinazione`),
  KEY `FK_rapporto_tipo_sorgente` (`Id_tipo_sorgente`),
  KEY `FK_rapporto_tipo_rapporto` (`id_tipo_rapporto`),
  CONSTRAINT `abbonamento` FOREIGN KEY (`abbonamento`) REFERENCES `abbonamento` (`Id_abbonamento`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `clie` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `fatt` FOREIGN KEY (`anno_fattura`, `Fattura`) REFERENCES `fattura` (`anno`, `Id_fattura`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_rapporto_8_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_rapporto_tipo_rapporto` FOREIGN KEY (`id_tipo_rapporto`) REFERENCES `tipo_rapporto` (`id`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_rapporto_tipo_sorgente` FOREIGN KEY (`Id_tipo_sorgente`) REFERENCES `rapporto_sorgente` (`id`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `rapporto_ibfk_10` FOREIGN KEY (`Id_Impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `rapporto_ibfk_12` FOREIGN KEY (`Stato`) REFERENCES `stato_rapporto` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `rapporto_ibfk_8` FOREIGN KEY (`Tipo_intervento`) REFERENCES `tipo_intervento` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `rap_dest` FOREIGN KEY (`dest_cli`, `id_destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=26161 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_allegati
CREATE TABLE IF NOT EXISTS `rapporto_allegati` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_rapporto` bigint(20) NOT NULL,
  `anno_rapporto` int(11) NOT NULL,
  `file_path` varchar(500) NOT NULL,
  `file_name` varchar(150) NOT NULL,
  `invia_a_cliente` bit(1) DEFAULT b'0',
  `genera_ticket` bit(1) DEFAULT b'0',
  `timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `utente_ins` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `file_path` (`file_path`),
  KEY `fk_rapporto_rapporto_allegati` (`id_rapporto`,`anno_rapporto`)
) ENGINE=InnoDB AUTO_INCREMENT=87 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_causale
CREATE TABLE IF NOT EXISTS `rapporto_causale` (
  `Id_rapporto` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `causale` int(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_convalida
CREATE TABLE IF NOT EXISTS `rapporto_convalida` (
  `tipo_utente` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `Firma1` tinyint(3) unsigned DEFAULT NULL,
  `Firma2` tinyint(3) unsigned DEFAULT NULL,
  `Firma3` tinyint(3) unsigned DEFAULT NULL,
  PRIMARY KEY (`tipo_utente`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_giornaliero
CREATE TABLE IF NOT EXISTS `rapporto_giornaliero` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_operaio` int(11) NOT NULL,
  `data_rapporto` date NOT NULL,
  `stampato` bit(1) NOT NULL DEFAULT b'0',
  `visionato` bit(1) NOT NULL DEFAULT b'0',
  `note` text,
  `data_ins` datetime NOT NULL,
  `data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `utente_ins` mediumint(9) NOT NULL,
  `utente_mod` mediumint(9) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `Fk_rapportino_giornaliero_operaio` (`id_operaio`),
  CONSTRAINT `Fk_rapportino_giornaliero_operaio` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`)
) ENGINE=InnoDB AUTO_INCREMENT=330 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_giornaliero_attivita
CREATE TABLE IF NOT EXISTS `rapporto_giornaliero_attivita` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_rapporto_giornaliero` int(11) NOT NULL,
  `tipo_lavoro` int(11) NOT NULL,
  `descrizione_lavoro` varchar(200) DEFAULT NULL,
  `ora_inizio` time NOT NULL,
  `ora_fine` time NOT NULL,
  `note` text,
  `data_ins` datetime NOT NULL,
  `data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `utente_ins` mediumint(9) NOT NULL,
  `utente_mod` mediumint(9) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `Fk_rapportino_giornaliero_attivita` (`Id_rapporto_giornaliero`),
  CONSTRAINT `Fk_rapportino_giornaliero_attivita` FOREIGN KEY (`Id_rapporto_giornaliero`) REFERENCES `rapporto_giornaliero` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2287 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_giornaliero_attivita_posizione
CREATE TABLE IF NOT EXISTS `rapporto_giornaliero_attivita_posizione` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_rapporto_giornaliero` int(11) NOT NULL,
  `Id_rapporto_giornaliero_attivita` int(11) NOT NULL,
  `id_operaio` int(11) NOT NULL,
  `latitudine` decimal(10,2) NOT NULL,
  `longitudine` decimal(10,2) NOT NULL,
  `sorgente_rilevamento` int(11) NOT NULL,
  `tipo_posizione` int(11) NOT NULL,
  `data_ins` datetime NOT NULL,
  `utente_ins` mediumint(9) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `Fk_rapportino_giornaliero_attivita` (`Id_rapporto_giornaliero`),
  KEY `FK_rapporto_giornaliero_att_pos_rapporto_giornaliero_att` (`Id_rapporto_giornaliero_attivita`),
  CONSTRAINT `FK_rapporto_giornaliero_att_pos_rapporto_giornaliero_att` FOREIGN KEY (`Id_rapporto_giornaliero_attivita`) REFERENCES `rapporto_giornaliero_attivita` (`id`),
  CONSTRAINT `rapporto_giornaliero_attivita_posizione_ibfk_1` FOREIGN KEY (`Id_rapporto_giornaliero`) REFERENCES `rapporto_giornaliero` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 ROW_FORMAT=COMPACT;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_giornaliero_attivita_rapporto
CREATE TABLE IF NOT EXISTS `rapporto_giornaliero_attivita_rapporto` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_rapporto_giornaliero` int(11) NOT NULL,
  `Id_rapporto_giornaliero_attivita` int(11) NOT NULL,
  `Id_rapporto` int(11) NOT NULL,
  `Anno_rapporto` int(11) NOT NULL,
  `data_ins` datetime NOT NULL,
  `utente_ins` mediumint(9) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `Fk_rapportino_giornaliero_attivita` (`Id_rapporto_giornaliero`),
  KEY `FK_rapporto_giornaliero_att_rapp_rapporto_giornaliero_att` (`Id_rapporto_giornaliero_attivita`),
  CONSTRAINT `FK_rapporto_giornaliero_att_rapp_rapporto_giornaliero_att` FOREIGN KEY (`Id_rapporto_giornaliero_attivita`) REFERENCES `rapporto_giornaliero_attivita` (`id`),
  CONSTRAINT `rapporto_giornaliero_attivita_rapporto_ibfk_1` FOREIGN KEY (`Id_rapporto_giornaliero`) REFERENCES `rapporto_giornaliero` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=264 DEFAULT CHARSET=latin1 ROW_FORMAT=COMPACT;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_giornaliero_tipo_attivita
CREATE TABLE IF NOT EXISTS `rapporto_giornaliero_tipo_attivita` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_materiale
CREATE TABLE IF NOT EXISTS `rapporto_materiale` (
  `Id_rapporto` bigint(11) NOT NULL,
  `Id_materiale` varchar(11) DEFAULT NULL,
  `anno` int(11) NOT NULL,
  `unita_misura` varchar(5) DEFAULT NULL,
  `quantità` decimal(11,2) DEFAULT NULL,
  `Prezzo` decimal(11,2) DEFAULT NULL,
  `costo` decimal(11,2) DEFAULT NULL,
  `descrizione` text NOT NULL,
  `sconto` decimal(11,2) DEFAULT '0.00',
  `economia` tinyint(4) DEFAULT '0',
  `id_magazzino` int(11) DEFAULT NULL,
  `id_tab` int(11) NOT NULL DEFAULT '0',
  `tipo` varchar(2) NOT NULL,
  `qeconomia` float(11,2) DEFAULT '0.00',
  PRIMARY KEY (`id_tab`,`Id_rapporto`,`anno`),
  KEY `Id_materiale` (`Id_materiale`),
  KEY `anno` (`anno`),
  KEY `id_rappo` (`Id_rapporto`) USING BTREE,
  KEY `rapporto_materiale_ibfk_1` (`Id_rapporto`,`anno`),
  KEY `FK_rapporto_materiale_3` (`id_magazzino`),
  KEY `rapporto_materiale_um` (`unita_misura`),
  CONSTRAINT `FK_rapporto_materiale_3` FOREIGN KEY (`id_magazzino`) REFERENCES `tipo_magazzino` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `rapporto_materiale_ibfk_1` FOREIGN KEY (`Id_rapporto`, `anno`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `rapporto_materiale_ibfk_2` FOREIGN KEY (`Id_materiale`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `rapporto_materiale_um` FOREIGN KEY (`unita_misura`) REFERENCES `unita_misura` (`sigla`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile
CREATE TABLE IF NOT EXISTS `rapporto_mobile` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_rapporto` mediumint(9) NOT NULL,
  `Anno` smallint(6) NOT NULL,
  `Id_Impianto` int(11) DEFAULT NULL,
  `id_destinazione` int(11) DEFAULT NULL,
  `Id_cliente` int(11) DEFAULT NULL,
  `Richiesto` varchar(30) DEFAULT NULL,
  `Mansione` varchar(20) DEFAULT NULL,
  `Responsabile` varchar(30) DEFAULT NULL,
  `Tipo_intervento` int(11) DEFAULT NULL,
  `Diritto_chiamata` tinyint(1) NOT NULL DEFAULT '0',
  `tipo_diritto_chiamata` tinyint(4) NOT NULL DEFAULT '0',
  `relazione` text,
  `Terminato` tinyint(1) DEFAULT NULL,
  `Funzionante` tinyint(1) DEFAULT NULL,
  `Stato` int(11) DEFAULT NULL,
  `Note_Generali` varchar(1000) DEFAULT NULL,
  `Fattura` int(11) DEFAULT NULL,
  `Data` date DEFAULT NULL,
  `Commessa` int(11) DEFAULT NULL,
  `abbonamento` int(11) DEFAULT NULL,
  `Numero_ordine` varchar(11) DEFAULT NULL,
  `Totale` float(11,4) DEFAULT '0.0000',
  `Nr_rapporto` varchar(40) DEFAULT ' ',
  `Data_esecuzione` date DEFAULT NULL,
  `Costo` float(11,4) DEFAULT '0.0000',
  `scan` int(1) unsigned DEFAULT '0',
  `anno_fattura` int(10) DEFAULT '0',
  `controllo_periodico` float(11,4) DEFAULT '0.0000',
  `prima` int(10) unsigned DEFAULT '0',
  `numero` varchar(45) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `cost_lav` double DEFAULT '0',
  `prez_lav` double DEFAULT '0',
  `dest_cli` int(11) DEFAULT NULL,
  `email_invio` varchar(45) DEFAULT NULL,
  `inviato` tinyint(1) DEFAULT '0',
  `visionato` tinyint(1) DEFAULT NULL,
  `id_ticket` varchar(100) DEFAULT NULL,
  `tecnici` varchar(150) DEFAULT NULL,
  `APPUNTI` text,
  `notturno` tinyint(3) unsigned DEFAULT NULL,
  `festivo` tinyint(3) unsigned NOT NULL,
  `su_chiamata` tinyint(3) unsigned NOT NULL,
  `eff_giorn` tinyint(3) unsigned NOT NULL,
  `sost` tinyint(3) unsigned NOT NULL,
  `ripar` tinyint(3) unsigned NOT NULL,
  `not` varchar(45) NOT NULL,
  `c_not` tinyint(3) unsigned NOT NULL,
  `abbon` tinyint(3) unsigned NOT NULL,
  `garanz` tinyint(3) unsigned NOT NULL,
  `man_ordi` tinyint(3) unsigned NOT NULL,
  `fuorigaranz` tinyint(3) unsigned NOT NULL,
  `fuoriabbon` tinyint(3) unsigned NOT NULL,
  `man_straord` tinyint(3) unsigned NOT NULL,
  `tipo_impianto` varchar(45) NOT NULL,
  `ragione_sociale` varchar(60) NOT NULL,
  `indirizzo` varchar(100) NOT NULL,
  `citta` varchar(100) NOT NULL,
  `luogo_lavoro` varchar(255) NOT NULL,
  `difetto` varchar(100) NOT NULL,
  `id_riferimento` int(10) unsigned DEFAULT NULL,
  `mail_responsabile` varchar(100) DEFAULT NULL,
  `invia_a_tecnico` bit(1) DEFAULT NULL,
  `da_reperibilita_telefonica` bit(1) DEFAULT b'0',
  `filename_firma_cliente` varchar(50) DEFAULT NULL,
  `filename_firma_tecnico` varchar(50) DEFAULT NULL,
  `usa_altra_firma_su_ddt` bit(1) DEFAULT b'0' COMMENT 'Se true viene usata la firma del rapporto su DDT automaticamente alla stampa',
  `filename_firma_per_ddt` varchar(50) DEFAULT NULL,
  `numero_allegati` smallint(6) NOT NULL DEFAULT '0',
  `usa_firma_su_ddt` bit(1) DEFAULT b'0' COMMENT 'Se true viene usata la firma del rapporto su DDT automaticamente alla stampa',
  `tipo_rapporto` int(11) DEFAULT NULL COMMENT '2 Customer, 1  Internal',
  `id_tecnico` mediumint(9) DEFAULT NULL,
  `timestamp_reperibilita` datetime DEFAULT NULL,
  `timestamp_creazione` datetime DEFAULT NULL,
  `timestamp_invio` datetime DEFAULT NULL,
  PRIMARY KEY (`Id_rapporto`,`Anno`),
  UNIQUE KEY `Id` (`Id`),
  KEY `FK_rapporto_mobile_tipo_rapporto` (`tipo_rapporto`),
  CONSTRAINT `FK_rapporto_mobile_tipo_rapporto` FOREIGN KEY (`tipo_rapporto`) REFERENCES `tipo_rapporto` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=16750 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_collaudo
CREATE TABLE IF NOT EXISTS `rapporto_mobile_collaudo` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_rapporto` smallint(6) NOT NULL,
  `Anno` smallint(6) NOT NULL,
  `Id_cliente` int(11) NOT NULL,
  `Id_impianto` int(11) DEFAULT NULL,
  `Indirizzo` varchar(255) NOT NULL,
  `Telefono` varchar(20) DEFAULT NULL,
  `Fax` varchar(20) DEFAULT NULL,
  `Partita_iva_cod_fisc` varchar(20) DEFAULT NULL,
  `Richiedente_intervento` varchar(30) DEFAULT NULL,
  `Email` varchar(35) DEFAULT NULL,
  `Email_responsabile` varchar(35) DEFAULT NULL,
  `Data` datetime NOT NULL,
  `Descrizione_veicolo` varchar(100) DEFAULT NULL,
  `Tipo_intervento` int(11) NOT NULL,
  `Tipo_impianto` int(11) DEFAULT NULL,
  `Ragione_sociale` varchar(100) NOT NULL,
  `Tipo_modello_impianto` varchar(100) DEFAULT NULL,
  `Stato_impianto` varchar(100) DEFAULT NULL,
  `Test_check_1` bit(1) NOT NULL,
  `Test_check_2` bit(1) NOT NULL,
  `Test_check_3` bit(1) NOT NULL,
  `Test_check_4` bit(1) NOT NULL,
  `Test_check_5` bit(1) NOT NULL,
  `Test_check_6` bit(1) NOT NULL,
  `Test_check_7` bit(1) NOT NULL,
  `Test_check_8` bit(1) NOT NULL,
  `Test_check_9` bit(1) NOT NULL,
  `Test_check_10` bit(1) NOT NULL,
  `Test_check_11` bit(1) NOT NULL,
  `Test_check_12` bit(1) NOT NULL,
  `Test_check_13` bit(1) NOT NULL,
  `Test_check_14` bit(1) NOT NULL,
  `Test_check_15` bit(1) NOT NULL,
  `Test_check_16` bit(1) NOT NULL,
  `Test_check_17` bit(1) NOT NULL,
  `Test_check_18` bit(1) NOT NULL,
  `Test_check_19` bit(1) NOT NULL,
  `Test_check_20` bit(1) NOT NULL,
  `Test_check_21` bit(1) NOT NULL,
  `Test_check_22` bit(1) NOT NULL,
  `Test_check_23` bit(1) NOT NULL,
  `Test_check_24` bit(1) NOT NULL,
  `Test_check_25` bit(1) NOT NULL,
  `Test_check_26` bit(1) NOT NULL,
  `Test_check_27` bit(1) NOT NULL,
  `Test_check_28` bit(1) NOT NULL,
  `Test_check_29` bit(1) NOT NULL,
  `Test_check_30` bit(1) NOT NULL,
  `Test_check_31` bit(1) NOT NULL,
  `Test_check_32` bit(1) NOT NULL,
  `Test_check_33` bit(1) NOT NULL,
  `Test_check_34` bit(1) NOT NULL,
  `Test_check_35` bit(1) NOT NULL,
  `Test_check_36` bit(1) NOT NULL,
  `Test_check_37` bit(1) NOT NULL,
  `Test_check_38` bit(1) NOT NULL,
  `Test_check_39` bit(1) NOT NULL,
  `Test_check_40` bit(1) NOT NULL,
  `Test_check_41` bit(1) NOT NULL,
  `Test_check_42` bit(1) NOT NULL,
  `Test_check_43` bit(1) NOT NULL,
  `Test_check_44` bit(1) NOT NULL,
  `Test_check_45` bit(1) NOT NULL,
  `Test_check_46_1` bit(1) NOT NULL,
  `Test_check_47_1` bit(1) NOT NULL,
  `Test_check_48_1` bit(1) NOT NULL,
  `Test_check_46_2` bit(1) NOT NULL,
  `Test_check_47_2` bit(1) NOT NULL,
  `Test_check_48_2` bit(1) NOT NULL,
  `Test_check_46_3` bit(1) NOT NULL,
  `Test_check_47_3` bit(1) NOT NULL,
  `Test_check_48_3` bit(1) NOT NULL,
  `Test_quantita_1` decimal(11,2) NOT NULL,
  `Test_quantita_2` decimal(11,2) NOT NULL,
  `Test_quantita_3` decimal(11,2) NOT NULL,
  `Test_quantita_4` decimal(11,2) NOT NULL,
  `Test_quantita_5` decimal(11,2) NOT NULL,
  `Test_quantita_6` decimal(11,2) NOT NULL,
  `Test_quantita_7` decimal(11,2) NOT NULL,
  `Test_quantita_8` decimal(11,2) NOT NULL,
  `Test_quantita_9` decimal(11,2) NOT NULL,
  `Test_quantita_10` decimal(11,2) NOT NULL,
  `Test_quantita_11` decimal(11,2) NOT NULL,
  `Test_quantita_12` decimal(11,2) NOT NULL,
  `Test_quantita_13` decimal(11,2) NOT NULL,
  `Test_quantita_14` decimal(11,2) NOT NULL,
  `Test_quantita_15` decimal(11,2) NOT NULL,
  `Test_quantita_16` decimal(11,2) NOT NULL,
  `Test_quantita_17` decimal(11,2) NOT NULL,
  `Test_quantita_18` decimal(11,2) NOT NULL,
  `Test_quantita_19` decimal(11,2) NOT NULL,
  `Test_quantita_20` decimal(11,2) NOT NULL,
  `Test_quantita_21` decimal(11,2) NOT NULL,
  `Test_quantita_22` decimal(11,2) NOT NULL,
  `Test_quantita_23` decimal(11,2) NOT NULL,
  `Test_quantita_24` decimal(11,2) NOT NULL,
  `Test_quantita_25` decimal(11,2) NOT NULL,
  `Test_quantita_26` decimal(11,2) NOT NULL,
  `Test_quantita_27` decimal(11,2) NOT NULL,
  `Test_quantita_28` decimal(11,2) NOT NULL,
  `Test_quantita_29` decimal(11,2) NOT NULL,
  `Test_quantita_30` decimal(11,2) NOT NULL,
  `Test_quantita_31` decimal(11,2) NOT NULL,
  `Test_quantita_32` decimal(11,2) NOT NULL,
  `Test_quantita_33` decimal(11,2) NOT NULL,
  `Test_quantita_34` decimal(11,2) NOT NULL,
  `Test_quantita_35` decimal(11,2) NOT NULL,
  `Test_quantita_36` decimal(11,2) NOT NULL,
  `Test_quantita_37` decimal(11,2) NOT NULL,
  `Test_quantita_38` decimal(11,2) NOT NULL,
  `Test_quantita_39` decimal(11,2) NOT NULL,
  `Test_quantita_40` decimal(11,2) NOT NULL,
  `Test_quantita_41` decimal(11,2) NOT NULL,
  `Test_quantita_42` decimal(11,2) NOT NULL,
  `Test_quantita_43` decimal(11,2) NOT NULL,
  `Test_quantita_44` decimal(11,2) NOT NULL,
  `Test_quantita_45` decimal(11,2) NOT NULL,
  `Test_quantita_46_1` decimal(11,2) NOT NULL,
  `Test_quantita_47_1` decimal(11,2) NOT NULL,
  `Test_quantita_48_1` decimal(11,2) NOT NULL,
  `Test_quantita_46_2` decimal(11,2) NOT NULL,
  `Test_quantita_47_2` decimal(11,2) NOT NULL,
  `Test_quantita_48_2` decimal(11,2) NOT NULL,
  `Test_quantita_46_3` decimal(11,2) NOT NULL,
  `Test_quantita_47_3` decimal(11,2) NOT NULL,
  `Test_quantita_48_3` decimal(11,2) NOT NULL,
  `Note` text,
  `Data_intervento` date DEFAULT NULL,
  `Ora_inizio_intervento_1` time DEFAULT NULL,
  `Ora_fine_intervento_1` time DEFAULT NULL,
  `Ora_inizio_intervento_2` time DEFAULT NULL,
  `Ora_fine_intervento_2` time DEFAULT NULL,
  `Ore_intervento` varchar(30) DEFAULT NULL,
  `Ore_Viaggio` decimal(11,2) DEFAULT NULL,
  `Ore_totali` decimal(11,2) DEFAULT NULL,
  `Prezzo_ora` decimal(11,2) DEFAULT NULL,
  `Note_viaggio` varchar(255) DEFAULT NULL,
  `Numero_viaggi` tinyint(4) NOT NULL,
  `Km_percorsi` smallint(6) NOT NULL,
  `Km_complessivi` smallint(6) NOT NULL,
  `Prezzo_km` decimal(11,2) NOT NULL,
  `Totale_prezzo_viaggio` decimal(11,2) NOT NULL,
  `Totale_prezzo_orario` decimal(11,2) NOT NULL,
  `Totale_prezzo_materiale` decimal(11,2) NOT NULL,
  `Imponibile` decimal(11,2) NOT NULL,
  `Iva` decimal(11,2) NOT NULL,
  `Totale_prezzo` decimal(11,2) NOT NULL,
  `Inviato` bit(1) DEFAULT b'0',
  `Processato` bit(1) DEFAULT b'0',
  `filename_firma_cliente` varchar(50) DEFAULT NULL,
  `filename_firma_tecnico` varchar(50) DEFAULT NULL,
  `Utente_inserimento` smallint(6) NOT NULL,
  `Operaio_inserimento` smallint(6) NOT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `timestamp_creazione` datetime DEFAULT NULL,
  `timestamp_invio` datetime DEFAULT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_rapporto_Anno` (`Id_rapporto`,`Anno`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_collaudo_rif_tipo_impianto
CREATE TABLE IF NOT EXISTS `rapporto_mobile_collaudo_rif_tipo_impianto` (
  `Id` smallint(6) NOT NULL AUTO_INCREMENT,
  `Posizione` smallint(6) NOT NULL,
  `Id_tipo_impianto` smallint(6) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Posizione_Id_tipo_impianto` (`Posizione`,`Id_tipo_impianto`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_collaudo_rif_tipo_intervento
CREATE TABLE IF NOT EXISTS `rapporto_mobile_collaudo_rif_tipo_intervento` (
  `Id` smallint(6) NOT NULL AUTO_INCREMENT,
  `Posizione` smallint(6) NOT NULL,
  `Id_tipo_intervento` smallint(6) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Posizione_Id_tipo_intervento` (`Posizione`,`Id_tipo_intervento`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_destinatario
CREATE TABLE IF NOT EXISTS `rapporto_mobile_destinatario` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_rapporto` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `email` varchar(100) NOT NULL,
  `tipo_email` tinyint(4) NOT NULL COMMENT '1 = MAIN, 2 = RESPONSIBLE, 3 = MANUAL, 4 = FROM CONTACTS',
  `id_mail` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `FK_rapporto_mobile_destinatario_mail` (`id_mail`),
  CONSTRAINT `FK_rapporto_mobile_destinatario_mail` FOREIGN KEY (`id_mail`) REFERENCES `mail` (`Id`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=5987 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_evento
CREATE TABLE IF NOT EXISTS `rapporto_mobile_evento` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_rapporto` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `id_evento` int(11) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_firma
CREATE TABLE IF NOT EXISTS `rapporto_mobile_firma` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_rapporto` mediumint(9) NOT NULL,
  `anno_rapporto` smallint(6) NOT NULL,
  `firma_tecnico` blob NOT NULL,
  `firma_cliente` blob,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_rapporto` (`id_rapporto`,`anno_rapporto`)
) ENGINE=InnoDB AUTO_INCREMENT=1985 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_intervento_rif_tipo_intervento
CREATE TABLE IF NOT EXISTS `rapporto_mobile_intervento_rif_tipo_intervento` (
  `Id` smallint(6) NOT NULL AUTO_INCREMENT,
  `Posizione` smallint(6) NOT NULL,
  `Id_tipo_intervento` smallint(6) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Posizione_Id_tipo_intervento` (`Posizione`,`Id_tipo_intervento`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_lavoro
CREATE TABLE IF NOT EXISTS `rapporto_mobile_lavoro` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `id_rapporto` mediumint(9) unsigned NOT NULL,
  `anno_rapporto` smallint(6) unsigned NOT NULL,
  `controllo_periodico` tinyint(4) DEFAULT NULL,
  `materiale_uso` decimal(10,2) DEFAULT NULL,
  `diritto_chiamata` bit(1) DEFAULT NULL,
  `viaggio_consuntivo` bit(1) DEFAULT NULL,
  `spese_consuntivo` bit(1) DEFAULT NULL,
  `spese` decimal(10,2) DEFAULT NULL,
  `ora_inizio_primo_periodo` time DEFAULT NULL,
  `ora_fine_primo_periodo` time DEFAULT NULL,
  `ora_inizio_secondo_periodo` time DEFAULT NULL,
  `ora_fine_secondo_periodo` time DEFAULT NULL,
  `tecnici` varchar(150) DEFAULT NULL,
  `totale_ore` varchar(45) DEFAULT NULL,
  `extra_consuntivo` bit(1) DEFAULT NULL,
  `extra_testo` varchar(45) DEFAULT NULL,
  `extra` decimal(10,2) DEFAULT NULL,
  `numero_furgoni` tinyint(4) DEFAULT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `unique_index` (`id_rapporto`,`anno_rapporto`)
) ENGINE=InnoDB AUTO_INCREMENT=7717 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_materiale
CREATE TABLE IF NOT EXISTS `rapporto_mobile_materiale` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `codice_articolo` varchar(11) NOT NULL DEFAULT '0',
  `descrizione` varchar(50) NOT NULL DEFAULT '',
  `quantita` decimal(11,2) NOT NULL DEFAULT '0.00',
  `posizione` tinyint(4) NOT NULL DEFAULT '0',
  `id_rapporto` mediumint(9) NOT NULL DEFAULT '0',
  `anno_rapporto` smallint(6) NOT NULL DEFAULT '0',
  PRIMARY KEY (`Id`),
  UNIQUE KEY `unique_index` (`id_rapporto`,`anno_rapporto`,`posizione`)
) ENGINE=InnoDB AUTO_INCREMENT=2926 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_tecnico
CREATE TABLE IF NOT EXISTS `rapporto_mobile_tecnico` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_rapporto` mediumint(9) NOT NULL DEFAULT '0',
  `anno_rapporto` smallint(6) NOT NULL DEFAULT '0',
  `id_tecnico` smallint(6) NOT NULL DEFAULT '0',
  `tempo_lavorato` smallint(6) NOT NULL DEFAULT '0',
  `km` smallint(6) NOT NULL,
  `tempo_viaggio` smallint(6) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_rapporto` (`id_rapporto`,`anno_rapporto`,`id_tecnico`)
) ENGINE=InnoDB AUTO_INCREMENT=9436 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_mobile_ticket
CREATE TABLE IF NOT EXISTS `rapporto_mobile_ticket` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_rapporto` mediumint(9) DEFAULT NULL,
  `anno_rapporto` smallint(6) DEFAULT NULL,
  `id_ticket` mediumint(9) DEFAULT NULL,
  `anno_ticket` smallint(6) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_ticket` (`id_ticket`,`anno_ticket`)
) ENGINE=InnoDB AUTO_INCREMENT=341 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_reperibilita
CREATE TABLE IF NOT EXISTS `rapporto_reperibilita` (
  `id_rapporto` bigint(20) NOT NULL AUTO_INCREMENT,
  `anno` int(11) NOT NULL,
  PRIMARY KEY (`id_rapporto`,`anno`)
) ENGINE=InnoDB AUTO_INCREMENT=2869 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_sorgente
CREATE TABLE IF NOT EXISTS `rapporto_sorgente` (
  `id` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL DEFAULT '',
  `attivo` bit(1) DEFAULT b'1',
  `data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_tecnico
CREATE TABLE IF NOT EXISTS `rapporto_tecnico` (
  `Id_rapporto` bigint(11) NOT NULL,
  `Anno` int(11) NOT NULL,
  `Tecnico` int(11) NOT NULL,
  `Km` int(11) NOT NULL DEFAULT '0',
  `Tempo_viaggio` int(11) NOT NULL DEFAULT '0',
  `Spesa_trasferta` float(11,2) DEFAULT '0.00',
  `autostrada` float(11,2) DEFAULT '0.00',
  `parcheggio` float(11,2) DEFAULT '0.00',
  `altro` float(11,2) DEFAULT '0.00',
  `altro_n` varchar(45) DEFAULT '',
  `rapporto` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_rapporto`,`Anno`,`Tecnico`),
  KEY `Tecnico` (`Tecnico`),
  KEY `Anno` (`Anno`),
  KEY `rapp` (`Id_rapporto`) USING BTREE,
  CONSTRAINT `rapp` FOREIGN KEY (`Id_rapporto`, `Anno`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `rapporto_tecnico_ibfk_3` FOREIGN KEY (`Tecnico`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_tecnico_app
CREATE TABLE IF NOT EXISTS `rapporto_tecnico_app` (
  `Tecnico` int(11) NOT NULL,
  `Km` int(11) NOT NULL,
  `Tempo_viaggio` int(11) NOT NULL,
  `Spesa_trasferta` float(11,2) DEFAULT NULL,
  `id` int(10) unsigned NOT NULL,
  `data` date DEFAULT NULL,
  `autostrada` float(11,2) DEFAULT '0.00',
  `parcheggio` float(11,2) DEFAULT '0.00',
  `altro` float(11,2) DEFAULT '0.00',
  `altro_n` varchar(30) DEFAULT NULL,
  PRIMARY KEY (`Tecnico`,`id`) USING BTREE,
  KEY `Tecnico` (`Tecnico`),
  CONSTRAINT `rapporto_tecnico_app_ibfk_1` FOREIGN KEY (`Tecnico`) REFERENCES `operaio` (`Id_operaio`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_tecnico_lavoro
CREATE TABLE IF NOT EXISTS `rapporto_tecnico_lavoro` (
  `Id_rapporto` bigint(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `tecnico` int(11) NOT NULL,
  `id_lavoro` int(11) NOT NULL DEFAULT '1',
  `ora_inizio` time DEFAULT '00:00:00',
  `ora_fine` time DEFAULT '00:00:00',
  `totale` decimal(11,2) NOT NULL DEFAULT '0.00',
  `nota` varchar(100) DEFAULT ' ',
  `straordinario` tinyint(1) DEFAULT '0' COMMENT '(0,1) = ore normali    (3,4) = ore economia ',
  `ora_normale` double DEFAULT '0',
  `tipo_anomalia` int(10) unsigned DEFAULT '1',
  `descrizione_anomalie` text,
  PRIMARY KEY (`Id_rapporto`,`anno`,`tecnico`,`id_lavoro`),
  KEY `id_lavoro` (`id_lavoro`),
  KEY `anno` (`anno`),
  KEY `tecnico` (`tecnico`),
  KEY `rapporto_tecnico_lavoro_ibfk_1` (`anno`,`Id_rapporto`),
  CONSTRAINT `rapporto_tecnico_lavoro_ibfk_1` FOREIGN KEY (`anno`, `Id_rapporto`) REFERENCES `rapporto` (`Anno`, `Id_rapporto`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `rapporto_tecnico_lavoro_ibfk_3` FOREIGN KEY (`tecnico`) REFERENCES `operaio` (`Id_operaio`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_tecnico_lavoro_app
CREATE TABLE IF NOT EXISTS `rapporto_tecnico_lavoro_app` (
  `tecnico` int(11) DEFAULT NULL,
  `id_lavoro` int(11) NOT NULL,
  `ora_inizio` time DEFAULT NULL,
  `ora_fine` time DEFAULT NULL,
  `totale` float(11,2) NOT NULL DEFAULT '0.00',
  `Nota` varchar(100) DEFAULT NULL,
  `Straordinario` tinyint(1) NOT NULL DEFAULT '0',
  `id` int(10) unsigned DEFAULT '0',
  `data` date DEFAULT NULL,
  `ora_normale` double DEFAULT '0',
  `tipo_anomalia` int(10) unsigned DEFAULT '1',
  `descrizione_anomalie` text,
  KEY `id_lavoro` (`id_lavoro`),
  KEY `tecnico` (`tecnico`),
  KEY `FK_rapporto_tecnico_lavoro_app_2` (`tecnico`,`id`),
  CONSTRAINT `rapporto_tecnico_lavoro_app_ibfk_2` FOREIGN KEY (`id_lavoro`) REFERENCES `causale_lavoro` (`Id_causale`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_totali
CREATE TABLE IF NOT EXISTS `rapporto_totali` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_rapporto` bigint(20) NOT NULL,
  `anno` int(11) NOT NULL,
  `prezzo_manutenzione` decimal(10,2) NOT NULL DEFAULT '0.00',
  `costo_manutenzione` decimal(10,2) NOT NULL DEFAULT '0.00',
  `costo_diritto_chiamata` decimal(10,2) NOT NULL DEFAULT '0.00',
  `prezzo_diritto_chiamata` decimal(10,2) NOT NULL DEFAULT '0.00',
  `costo_lavoro` decimal(10,2) NOT NULL,
  `prezzo_lavoro` decimal(10,2) NOT NULL,
  `costo_viaggio` decimal(10,2) NOT NULL,
  `prezzo_viaggio` decimal(10,2) NOT NULL,
  `costo_materiale` decimal(10,2) NOT NULL,
  `prezzo_materiale` decimal(10,2) NOT NULL,
  `costo_totale` decimal(10,2) NOT NULL,
  `prezzo_totale` decimal(10,2) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `rapporto_totali_id_anno` (`id_rapporto`,`anno`),
  CONSTRAINT `fk_rapporto_rapporto` FOREIGN KEY (`id_rapporto`, `anno`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=26013 DEFAULT CHARSET=latin1 COMMENT='Storico dei totali rapporto';

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_uscita
CREATE TABLE IF NOT EXISTS `rapporto_uscita` (
  `Id_rapporto` bigint(11) NOT NULL,
  `Anno` int(11) NOT NULL,
  `Id_tipo_uscita` int(11) NOT NULL,
  PRIMARY KEY (`Id_rapporto`,`Anno`,`Id_tipo_uscita`),
  KEY `Id_tipo_uscita` (`Id_tipo_uscita`),
  KEY `Anno` (`Anno`),
  CONSTRAINT `rapporto_uscita_ibfk_3` FOREIGN KEY (`Id_tipo_uscita`) REFERENCES `tipo_uscita` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `rapporto_uscita_ibfk_4` FOREIGN KEY (`Id_rapporto`, `Anno`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rapporto_uscita_appoggio
CREATE TABLE IF NOT EXISTS `rapporto_uscita_appoggio` (
  `Id_uscita` int(11) NOT NULL,
  `contr` varchar(10) NOT NULL,
  PRIMARY KEY (`Id_uscita`),
  CONSTRAINT `rapporto_uscita_appoggio_ibfk_1` FOREIGN KEY (`Id_uscita`) REFERENCES `tipo_uscita` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.regione
CREATE TABLE IF NOT EXISTS `regione` (
  `Id_regione` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(30) NOT NULL,
  `nazione` int(11) NOT NULL,
  `Data_ins` datetime NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` smallint(6) NOT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  PRIMARY KEY (`Id_regione`),
  UNIQUE KEY `nome` (`nome`),
  KEY `FK_regione_1_naz` (`nazione`),
  CONSTRAINT `FK_regione_1_naz` FOREIGN KEY (`nazione`) REFERENCES `nazione` (`id_nazione`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.regola
CREATE TABLE IF NOT EXISTS `regola` (
  `provincia` varchar(30) NOT NULL,
  `altra` varchar(50) NOT NULL,
  `frazione` varchar(30) DEFAULT NULL,
  PRIMARY KEY (`provincia`,`altra`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.resoconto
CREATE TABLE IF NOT EXISTS `resoconto` (
  `id_resoconto` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `data` date NOT NULL,
  `Descrizione` varchar(150) NOT NULL,
  `Numero_ordine` varchar(50) DEFAULT NULL,
  `Id_cliente` int(11) NOT NULL,
  `stato` int(11) NOT NULL,
  `Nota` text,
  `fattura` int(11) DEFAULT NULL,
  `anno_fattura` int(11) DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `tipo_resoconto` int(11) NOT NULL DEFAULT '1',
  `inviato` int(11) NOT NULL DEFAULT '0',
  `nota_fine` text,
  `stm` tinyint(4) DEFAULT '0',
  `fat_SpeseRap` tinyint(4) DEFAULT '0',
  `costo_extra` decimal(10,2) DEFAULT NULL,
  `prezzo_extra` decimal(10,2) DEFAULT NULL,
  PRIMARY KEY (`id_resoconto`,`anno`),
  KEY `Id_cliente` (`Id_cliente`),
  KEY `stato` (`stato`),
  KEY `fattura` (`fattura`),
  KEY `anno_fattura` (`anno_fattura`),
  KEY `resoconto_ibfk_3` (`anno_fattura`,`fattura`),
  KEY `Index_7_ut` (`id_utente`),
  KEY `Index_8` (`tipo_resoconto`),
  CONSTRAINT `FK_resoconto_4_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `resoconto_ibfk_1` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `resoconto_ibfk_2` FOREIGN KEY (`stato`) REFERENCES `stato_resoconto` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `resoconto_ibfk_3` FOREIGN KEY (`anno_fattura`, `fattura`) REFERENCES `fattura` (`anno`, `Id_fattura`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `TIPO_RESO` FOREIGN KEY (`tipo_resoconto`) REFERENCES `tipo_resoconto` (`id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.resoconto_rapporto
CREATE TABLE IF NOT EXISTS `resoconto_rapporto` (
  `id_resoconto` int(11) NOT NULL,
  `id_rapporto` bigint(11) NOT NULL AUTO_INCREMENT,
  `anno` int(11) NOT NULL,
  `anno_reso` int(11) NOT NULL,
  PRIMARY KEY (`id_rapporto`,`anno`,`id_resoconto`,`anno_reso`) USING BTREE,
  KEY `id_resoconto` (`id_resoconto`,`anno_reso`),
  KEY `anno_reso` (`anno_reso`),
  CONSTRAINT `resoconto_rapporto_ibfk_1` FOREIGN KEY (`id_resoconto`, `anno_reso`) REFERENCES `resoconto` (`id_resoconto`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `resoconto_rapporto_ibfk_2` FOREIGN KEY (`id_rapporto`, `anno`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=15059 DEFAULT CHARSET=latin1 ROW_FORMAT=DYNAMIC;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.resoconto_totali
CREATE TABLE IF NOT EXISTS `resoconto_totali` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_resoconto` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `prezzo_manutenzione` decimal(10,2) NOT NULL DEFAULT '0.00',
  `costo_manutenzione` decimal(10,2) NOT NULL DEFAULT '0.00',
  `costo_diritto_chiamata` decimal(10,2) NOT NULL DEFAULT '0.00',
  `prezzo_diritto_chiamata` decimal(10,2) NOT NULL DEFAULT '0.00',
  `costo_lavoro` decimal(10,2) NOT NULL,
  `prezzo_lavoro` decimal(10,2) NOT NULL,
  `costo_viaggio` decimal(10,2) NOT NULL,
  `prezzo_viaggio` decimal(10,2) NOT NULL,
  `costo_materiale` decimal(10,2) NOT NULL,
  `prezzo_materiale` decimal(10,2) NOT NULL,
  `costo_extra` decimal(10,2) NOT NULL DEFAULT '0.00',
  `prezzo_extra` decimal(10,2) NOT NULL DEFAULT '0.00',
  `costo_totale` decimal(10,2) NOT NULL,
  `prezzo_totale` decimal(10,2) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `resoconto_totali_id_anno` (`id_resoconto`,`anno`),
  CONSTRAINT `fk_resoconto_totali_resoconto` FOREIGN KEY (`id_resoconto`, `anno`) REFERENCES `resoconto` (`id_resoconto`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=2052 DEFAULT CHARSET=latin1 COMMENT='Storico dei totali resoconto';

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.revisione_preventivo
CREATE TABLE IF NOT EXISTS `revisione_preventivo` (
  `Id_revisione` int(11) NOT NULL,
  `Id_preventivo` int(11) NOT NULL,
  `Stampato` tinyint(1) DEFAULT '0',
  `Inviato` tinyint(1) DEFAULT '0',
  `data_creazione` date DEFAULT NULL,
  `data` date DEFAULT NULL,
  `Anno` int(11) NOT NULL DEFAULT '0',
  `Listino` int(11) DEFAULT '0',
  `Sconto_perc` float(11,2) NOT NULL DEFAULT '0.00',
  `Prezzo_ora` float(11,2) NOT NULL DEFAULT '0.00',
  `costo_ora` float(11,2) NOT NULL DEFAULT '0.00',
  `aliquota` int(11) NOT NULL DEFAULT '0',
  `corpo` longtext NOT NULL,
  `cortese` varchar(100) NOT NULL,
  `oggetto` text NOT NULL,
  `nota` text NOT NULL,
  `tariffa` int(11) DEFAULT NULL COMMENT 'Id abbonamento',
  `sitoin` text,
  `Id_riferimento` int(11) DEFAULT NULL,
  `id_cliente` int(11) DEFAULT NULL,
  `destinazione` int(11) DEFAULT NULL,
  `ric_tip` tinyint(4) DEFAULT '0',
  `ric_perc` decimal(10,0) DEFAULT '0',
  `corpo_rtf` longtext,
  PRIMARY KEY (`Id_revisione`,`Id_preventivo`,`Anno`),
  KEY `Id_preventivo` (`Id_preventivo`),
  KEY `Anno` (`Anno`),
  KEY `revisione_preventivo_ibfk_1` (`Id_preventivo`,`Anno`),
  KEY `dest` (`id_cliente`,`destinazione`),
  KEY `clie` (`id_cliente`),
  KEY `FK_revisione_preventivo_abbonamento` (`tariffa`),
  CONSTRAINT `client` FOREIGN KEY (`id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `destin` FOREIGN KEY (`id_cliente`, `destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_revisione_preventivo_abbonamento` FOREIGN KEY (`tariffa`) REFERENCES `abbonamento` (`Id_abbonamento`) ON UPDATE CASCADE,
  CONSTRAINT `revisione_preventivo_ibfk_1` FOREIGN KEY (`Id_preventivo`, `Anno`) REFERENCES `preventivo` (`Id_preventivo`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.riferimento_clienti
CREATE TABLE IF NOT EXISTS `riferimento_clienti` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `id_pubblico` char(36) DEFAULT NULL,
  `Id_cliente` int(11) NOT NULL,
  `Id_riferimento` int(11) NOT NULL,
  `Nome` varchar(50) NOT NULL,
  `figura` int(11) NOT NULL,
  `Telefono` varchar(20) DEFAULT NULL,
  `altro_telefono` varchar(20) DEFAULT NULL,
  `fax` varchar(20) DEFAULT NULL,
  `mail` varchar(100) DEFAULT NULL,
  `centralino` varchar(20) DEFAULT NULL,
  `Fatturazione` tinyint(1) NOT NULL DEFAULT '0',
  `Promemoria_cliente` bit(1) DEFAULT b'0',
  `titolo` varchar(20) DEFAULT NULL,
  `nota_cli` text,
  `esterno` tinyint(4) NOT NULL DEFAULT '0',
  `sito` varchar(100) DEFAULT NULL,
  `skype` varchar(100) DEFAULT NULL,
  `rif_esterno` varchar(45) DEFAULT NULL,
  `sito_utente` varchar(45) DEFAULT NULL,
  `sito_passwd` varchar(45) DEFAULT NULL,
  `mail_pec` varchar(100) DEFAULT NULL,
  `mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `idut` int(11) DEFAULT NULL,
  PRIMARY KEY (`Id_cliente`,`Id_riferimento`),
  UNIQUE KEY `Id` (`Id`),
  UNIQUE KEY `unique_id_pubblico` (`id_pubblico`),
  KEY `figura` (`figura`),
  CONSTRAINT `riferimento_clienti_ibfk_1` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `riferimento_clienti_ibfk_2` FOREIGN KEY (`figura`) REFERENCES `riferimento_figura` (`Id_figura`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=10400 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.riferimento_figura
CREATE TABLE IF NOT EXISTS `riferimento_figura` (
  `Id_figura` int(11) NOT NULL AUTO_INCREMENT,
  `Figura` varchar(40) NOT NULL,
  `Abbreviazione` varchar(30) NOT NULL DEFAULT '',
  `Descrizione_breve` varchar(80) DEFAULT NULL,
  PRIMARY KEY (`Id_figura`),
  UNIQUE KEY `Figura` (`Figura`)
) ENGINE=InnoDB AUTO_INCREMENT=738 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.riferimento_fornitore
CREATE TABLE IF NOT EXISTS `riferimento_fornitore` (
  `id_pubblico` char(36) DEFAULT NULL,
  `Id_fornitore` int(11) NOT NULL,
  `Id_riferimento` int(11) NOT NULL,
  `Nome` varchar(50) NOT NULL,
  `figura` int(10) NOT NULL DEFAULT '1',
  `Telefono` varchar(15) DEFAULT NULL,
  `altro_telefono` varchar(15) DEFAULT NULL,
  `telefono2` varchar(15) DEFAULT NULL,
  `fax` varchar(15) DEFAULT NULL,
  `mail` varchar(200) DEFAULT NULL,
  `centralino` varchar(15) DEFAULT NULL,
  `fatturazione` tinyint(1) NOT NULL DEFAULT '0',
  `nota` text,
  `titolo` varchar(20) DEFAULT NULL,
  `esterno` tinyint(4) NOT NULL DEFAULT '0',
  `sito` varchar(100) DEFAULT NULL,
  `skype` varchar(100) DEFAULT NULL,
  `rif_esterno` varchar(45) DEFAULT NULL,
  `sito_utente` varchar(45) DEFAULT NULL,
  `sito_passwd` varchar(45) DEFAULT NULL,
  `mail_pec` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`Id_fornitore`,`Id_riferimento`),
  UNIQUE KEY `unique_id_pubblico` (`id_pubblico`),
  KEY `Index_2` (`figura`) USING BTREE,
  CONSTRAINT `FK_riferimento_fornitore_2` FOREIGN KEY (`figura`) REFERENCES `riferimento_figura` (`Id_figura`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `riferimento_fornitore_ibfk_1` FOREIGN KEY (`Id_fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.riferimento_kit_articoli
CREATE TABLE IF NOT EXISTS `riferimento_kit_articoli` (
  `id_articolo` varchar(45) NOT NULL DEFAULT '0',
  `id_kit` varchar(45) NOT NULL DEFAULT '0',
  `quantita` float(11,2) NOT NULL DEFAULT '0.00',
  `prezzo` float(11,2) NOT NULL DEFAULT '0.00',
  `costo` float(11,2) NOT NULL DEFAULT '0.00',
  `sconto` float(11,2) NOT NULL DEFAULT '0.00',
  `ordinamento` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_articolo`,`id_kit`),
  KEY `FK_referimento_kit_articoli_kit` (`id_kit`),
  CONSTRAINT `FK_referimento_kit_articoli_componente` FOREIGN KEY (`id_articolo`) REFERENCES `articolo` (`Codice_articolo`) ON UPDATE CASCADE,
  CONSTRAINT `FK_referimento_kit_articoli_kit` FOREIGN KEY (`id_kit`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.riferimento_progetto
CREATE TABLE IF NOT EXISTS `riferimento_progetto` (
  `Id_cliente` int(11) NOT NULL,
  `id_progetto` int(11) NOT NULL,
  `Id_riferimento` int(11) NOT NULL,
  `Nome` varchar(50) NOT NULL,
  `figura` varchar(30) NOT NULL,
  `Telefono` varchar(11) DEFAULT NULL,
  `altro_telefono` varchar(15) DEFAULT NULL,
  `fax` bigint(15) DEFAULT NULL,
  `mail` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`Id_cliente`,`id_progetto`,`Id_riferimento`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.riferimento_sn_ddt_kit
CREATE TABLE IF NOT EXISTS `riferimento_sn_ddt_kit` (
  `id_ddt` int(10) unsigned NOT NULL,
  `anno` int(10) unsigned NOT NULL,
  `id_tab` int(10) unsigned NOT NULL,
  `id_articolo` varchar(45) NOT NULL,
  `serial_number` varchar(150) DEFAULT NULL,
  `id_kit` varchar(45) NOT NULL,
  `cod_forn` varchar(30) DEFAULT NULL,
  PRIMARY KEY (`id_ddt`,`anno`,`id_tab`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.rifiuti
CREATE TABLE IF NOT EXISTS `rifiuti` (
  `Id_Articolo` int(11) NOT NULL,
  `Data_operazione` date NOT NULL,
  `Causale` int(11) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.sconto
CREATE TABLE IF NOT EXISTS `sconto` (
  `Id_sconto` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(200) NOT NULL,
  `Sconto_perc` float NOT NULL,
  PRIMARY KEY (`Id_sconto`),
  UNIQUE KEY `Nome` (`Nome`),
  UNIQUE KEY `Sconto%` (`Sconto_perc`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.serial_number
CREATE TABLE IF NOT EXISTS `serial_number` (
  `ID_Articolo` varchar(11) NOT NULL,
  `Serial_number` varchar(20) NOT NULL,
  `tipo_sn` int(11) NOT NULL,
  `Id_sn` int(11) NOT NULL,
  PRIMARY KEY (`ID_Articolo`,`Serial_number`,`Id_sn`),
  UNIQUE KEY `Serial_number` (`Serial_number`),
  KEY `tipo_sn` (`tipo_sn`),
  CONSTRAINT `serial_number_ibfk_1` FOREIGN KEY (`tipo_sn`) REFERENCES `tipo_serial_number` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `serial_number_ibfk_2` FOREIGN KEY (`ID_Articolo`) REFERENCES `articolo` (`Codice_articolo`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.servizio_alert_configurazione
CREATE TABLE IF NOT EXISTS `servizio_alert_configurazione` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Cartella` varchar(100) NOT NULL,
  `Tipo_intervallo` smallint(6) NOT NULL COMMENT '1 = Giorno del mese,  2 = Intervallo giorni',
  `Valore` int(11) NOT NULL,
  `Numero_mesi` smallint(6) NOT NULL,
  `Data_ultima_esecuzione` datetime NOT NULL,
  `Oggetto_email` varchar(150) NOT NULL,
  `Corpo_email` text NOT NULL,
  `Data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_mod` int(11) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.servizio_alert_configurazione_generale
CREATE TABLE IF NOT EXISTS `servizio_alert_configurazione_generale` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Email_host` varchar(50) NOT NULL,
  `Email_username` varchar(50) NOT NULL,
  `Email_password` varchar(50) NOT NULL,
  `Email_port` int(11) NOT NULL DEFAULT '0',
  `Email_ssl` bit(1) NOT NULL DEFAULT b'0',
  `Email_from` varchar(50) NOT NULL DEFAULT '0',
  `Data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` int(11) NOT NULL,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=16 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.servizio_alert_esecuzione
CREATE TABLE IF NOT EXISTS `servizio_alert_esecuzione` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_servizio` int(11) NOT NULL,
  `Data_esecuzione` datetime NOT NULL,
  `Filename` varchar(50) NOT NULL,
  `Errore` mediumtext,
  PRIMARY KEY (`Id`),
  KEY `FK__servizio_alert_configurazione` (`Id_servizio`),
  CONSTRAINT `FK__servizio_alert_configurazione` FOREIGN KEY (`Id_servizio`) REFERENCES `servizio_alert_configurazione` (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=123 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.servizio_alert_ricevente
CREATE TABLE IF NOT EXISTS `servizio_alert_ricevente` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_servizio` int(11) NOT NULL,
  `Email` varchar(50) NOT NULL,
  `Data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `Utente_ins` int(11) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_servizio_Email` (`Id_servizio`,`Email`),
  CONSTRAINT `t` FOREIGN KEY (`Id_servizio`) REFERENCES `servizio_alert_configurazione` (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.session_rap
CREATE TABLE IF NOT EXISTS `session_rap` (
  `id` int(11) NOT NULL,
  `id_rapporto` int(11) DEFAULT NULL,
  `anno` int(11) DEFAULT NULL,
  `data` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.sistema_preventivo
CREATE TABLE IF NOT EXISTS `sistema_preventivo` (
  `Id_sistema` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` longtext,
  PRIMARY KEY (`Id_sistema`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.sostanza
CREATE TABLE IF NOT EXISTS `sostanza` (
  `id_sostanza` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  `fornitore` int(11) DEFAULT NULL,
  `classificazione` varchar(100) NOT NULL,
  `uso` varchar(100) DEFAULT NULL,
  `note` text,
  PRIMARY KEY (`id_sostanza`),
  KEY `FK_sostanza_1_for` (`fornitore`),
  CONSTRAINT `FK_sostanza_1_for` FOREIGN KEY (`fornitore`) REFERENCES `fornitore` (`Id_fornitore`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.sostanza_pericolo
CREATE TABLE IF NOT EXISTS `sostanza_pericolo` (
  `id_sostanza` int(11) NOT NULL,
  `id_pericolo` int(11) NOT NULL,
  PRIMARY KEY (`id_pericolo`,`id_sostanza`),
  KEY `FK_sostanza_pericolo_1_soso` (`id_sostanza`),
  CONSTRAINT `FK_sostanza_pericolo_1_soso` FOREIGN KEY (`id_sostanza`) REFERENCES `sostanza` (`id_sostanza`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_sostanza_pericolo_2_per` FOREIGN KEY (`id_pericolo`) REFERENCES `pericolo` (`id_frase`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.sottocategoria
CREATE TABLE IF NOT EXISTS `sottocategoria` (
  `Id_categoria` int(11) NOT NULL,
  `id_sottocategoria` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Descrizione` longtext,
  PRIMARY KEY (`id_sottocategoria`),
  KEY `Id_categoria` (`Id_categoria`),
  CONSTRAINT `sottocategoria_ibfk_1` FOREIGN KEY (`Id_categoria`) REFERENCES `categoria_merciologica` (`Id_categoria`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.sottocategoria2
CREATE TABLE IF NOT EXISTS `sottocategoria2` (
  `Id_sottocategoria` int(11) NOT NULL,
  `Id_livello2` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id_livello2`,`Id_sottocategoria`) USING BTREE,
  UNIQUE KEY `descrizione` (`descrizione`),
  KEY `Id_sottocategoria` (`Id_sottocategoria`),
  CONSTRAINT `sottocategoria2_ibfk_1` FOREIGN KEY (`Id_sottocategoria`) REFERENCES `sottocategoria` (`id_sottocategoria`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di procedura emmebi.sp_apiChecklistCheckExistence
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistCheckExistence`(
	mobile_id INT(11),
	OUT result INT(11) 
)
BEGIN
   	
	SET result = 0;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistDelete
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistDelete`(
	enter_id INT(11),
	OUT result  TINYINT
)
BEGIN

	SET result = 0; 
	
	CALL sp_apiChecklistParagraphDeleteByChecklist(enter_id, result);
	CALL sp_apiChecklistEmployeeDeleteByChecklist(enter_id, result);
	CALL sp_apiChecklistReportDeleteByChecklist(enter_id, result);

	DELETE FROM checklist 
	WHERE id = enter_id;

	SET result = 1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistEmployeeDeleteByChecklist
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistEmployeeDeleteByChecklist`(
	enter_id INT(11),
	OUT result  TINYINT
)
BEGIN

	SET result = 0; 
	
	DELETE FROM checklist_tecnico
	WHERE id_checklist = enter_id;

	SET result = 1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistGet
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistGet`(
)
BEGIN
	SELECT
		`id`,
		`id_mobile`,
		`data_esecuzione`,
		`id_checklist_model`,
		`id_operaio`,
		`id_cliente`,
		`id_responsabile`,
		`id_impianto`,
		`ragione_sociale`,
		`indirizzo`,
		`citta`,
		`responsabile`,
		`impianto_luogo_installazione`,
		`impianto_centrale`,
		`impianto_data_installazione`,
		`impianto_dipartimento`,
		`timestamp_creazione`,
		`numero_visita`,
		`controllo_periodico`,
		`altro`,
		`responsabile_lavoro`,
		`appunti`,
		`filename_firma_cliente`,
		`filename_firma_tecnico`,
		visionata, 
		stampata, 
		inviata,
		`utente_ins`,
		`utente_mod`,
		`data_ins`,
		`data_mod`
	FROM checklist
	ORDER BY visionata;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistGetById
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistGetById`(
	IN enter_id INT(11)
)
BEGIN
	SELECT
		`id`,
		`id_mobile`,
		`data_esecuzione`,
		`id_checklist_model`,
		`id_operaio`,
		`id_cliente`,
		`id_responsabile`,
		`id_impianto`,
		`ragione_sociale`,
		`indirizzo`,
		`citta`,
		`responsabile`,
		`impianto_luogo_installazione`,
		`impianto_centrale`,
		`impianto_data_installazione`,
		`impianto_dipartimento`,
		`timestamp_creazione`,
		`numero_visita`,
		`controllo_periodico`,
		`altro`,
		`responsabile_lavoro`,
		`appunti`,
		`filename_firma_cliente`,
		`filename_firma_tecnico`,
		visionata, 
		stampata, 
		inviata,
		`utente_ins`,
		`utente_mod`,
		`data_ins`,
		`data_mod`
	FROM checklist
	WHERE id = enter_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistInsert
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistInsert`(
	mobile_id INT(11),
	execution_date DATE,
	model_id INT(11),
	employee_id INT(11),
	customer_id INT(11),
	responsable_id INT(11),
	responsable VARCHAR(150),
	system_id INT(11),
	company_name VARCHAR(150),
	address VARCHAR(150),
	city VARCHAR(150),
	system_installation_place VARCHAR(150),
	system_central VARCHAR(150),
	system_installation_date DATE,
	system_department VARCHAR(150),
	creation_timestamp DATETIME,
	user_id INT(11), 
	others TEXT, 
	notes TEXT, 
	visit_number TINYINT, 
	periodic_check TINYINT, 
	responsable_job VARCHAR(150),
	OUT result INT(11)
)
MainLabel:BEGIN


	SET Result = 1; 
	
	IF Result 
	THEN

		INSERT INTO checklist
		SET 
			`id_mobile`                       = mobile_id,
			`data_esecuzione`                       = execution_date,
			`id_checklist_model`                       = model_id,
			`id_operaio`                       = employee_id,
			`id_cliente`                       = customer_id,
			`id_responsabile`                       = responsable_id,
			`id_impianto`                       =  system_id,
			responsabile = responsable,
			`ragione_sociale`                       = company_name,
			`indirizzo`                       = address,
			`citta`                       = city,
			`impianto_luogo_installazione`                       = system_installation_place,
			`impianto_centrale`                       = system_central, 
			`impianto_data_installazione`                       = system_installation_date,
			`impianto_dipartimento`                       = system_department, 
			`timestamp_creazione`                       = creation_timestamp, 
			altro = others, 
			appunti = notes, 
			responsabile_lavoro = responsable_job, 
			numero_visita = visit_number, 
			controllo_periodico = periodic_check,
			`utente_ins`                       = user_id,
			`utente_mod`                       = user_id,
			`data_ins`                       = NOW(),
			`data_mod`                       = NOW();

		SET result = LAST_INSERT_ID();
	END IF;  
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelElementDefValueGet
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelElementDefValueGet`( 
)
BEGIN
	SELECT 	
		IFNULL(checklist_model_elemento_def_valore.Id, -1) AS Id,
		checklist_model_elemento_def_valore.id_elemento,
		tipo_checklist_model_elemento_def_valore.Id as Id_tipo_def_val,
		tipo_checklist_model_elemento_def_valore.Nome AS Label,
		tipo_checklist_model_elemento_def_valore.Field As Field,
		tipo_checklist_model_elemento_def_valore.Field_type As Field_type,
		checklist_model_elemento_def_valore.Value,
		IFNULL(checklist_model_elemento_def_valore.Data_mod, NOW()) AS Data_mod,
		IFNULL(Utente_mod, @USER_ID) AS Utente_mod
	FROM checklist_model_elemento_def_valore
		INNER JOIN tipo_checklist_model_elemento_def_valore
		ON checklist_model_elemento_def_valore.Id_tipo_def_val = tipo_checklist_model_elemento_def_valore.Id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelGet
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelGet`(	)
BEGIN
        
	SELECT Checklist_model.Id_check, 
		checklist_model.nome,
		checklist_model.descrizione, 
		checklist_model.note, 
		IFNULL(checklist_model.tipo_impianto, 0) tipo_impianto,
		checklist_model.Stato
	FROM Checklist_model;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelGetFromDate
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelGetFromDate`(	from_date DATETIME )
BEGIN
        
	SELECT Checklist_model.Id_check, 
		checklist_model.nome,
		checklist_model.descrizione, 
		checklist_model.note, 
		IFNULL(checklist_model.tipo_impianto, 0) tipo_impianto,
		checklist_model.Stato
	FROM Checklist_model 
	WHERE IFNULL(Checklist_model.Data_mod, Checklist_model.Data_Ins) >= from_date;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelParagraphElementGet
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelParagraphElementGet`(	)
BEGIN
        
	SELECT 
		checklist_model_elemento.Id as "id_elemento",
		checklist_model_elemento.Id_paragrafo,
		checklist_model_elemento.id_checklist, 
		checklist_model_elemento.Posizione,
		checklist_model_elemento.nome,
		IFNULL(checklist_model_elemento.descrizione, "") descrizione,
		checklist_model_elemento.indicazioni, 
		checklist_model_elemento.tipo_elemento
	FROM checklist_model_elemento;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelParagraphElementGetFromDate
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelParagraphElementGetFromDate`(	from_date DATETIME )
BEGIN
        
	SELECT 
		checklist_model_elemento.Id as "id_elemento",
		checklist_model_elemento.Id_paragrafo,
		checklist_model_elemento.id_checklist, 
		checklist_model_elemento.Posizione,
		checklist_model_elemento.nome,
		IFNULL(checklist_model_elemento.descrizione, "") descrizione,
		checklist_model_elemento.indicazioni, 
		checklist_model_elemento.tipo_elemento	
	FROM checklist_model_elemento
	WHERE IFNULL(checklist_model_elemento.Data_mod, checklist_model_elemento.Data_Ins) >= from_date;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelParagraphGet
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelParagraphGet`(	)
BEGIN
        
	SELECT checklist_model_paragrafo.Id, 
		checklist_model_paragrafo.Id_checklist,
		checklist_model_paragrafo.nome,
		checklist_model_paragrafo.descrizione, 
		checklist_model_paragrafo.ordine
	FROM checklist_model_paragrafo;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelParagraphGetFromDate
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelParagraphGetFromDate`(	from_date DATETIME )
BEGIN
        
	SELECT checklist_model_paragrafo.Id, 
			checklist_model_paragrafo.Id_checklist,
		checklist_model_paragrafo.nome,
		checklist_model_paragrafo.descrizione, 
		checklist_model_paragrafo.ordine
	FROM checklist_model_paragrafo 
	WHERE IFNULL(checklist_model_paragrafo.Data_mod, checklist_model_paragrafo.Data_Ins) >= from_date;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelSystemGet
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelSystemGet`(	)
BEGIN
        
	SELECT checklist_model_impianto.Id_checklist,
		checklist_model_impianto.Id_impianto
	FROM checklist_model_impianto;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistModelSystemGetFromDate
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistModelSystemGetFromDate`(	from_date DATETIME )
BEGIN
        
	SELECT checklist_model_impianto.Id_checklist,
		checklist_model_impianto.Id_impianto
	FROM checklist_model_impianto 
	WHERE checklist_model_impianto.Data_Ins >= from_date;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistParagraphDeleteByChecklist
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistParagraphDeleteByChecklist`(
	enter_id INT(11),
	OUT result  TINYINT
)
BEGIN

	SET result = 0; 
	
	CALL sp_apiChecklistParagraphRowDeleteByChecklist(enter_id, result);

	DELETE FROM checklist_paragrafo 
	WHERE id_checklist = enter_id;

	SET result = 1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistParagraphGetByChecklistIds
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistParagraphGetByChecklistIds`(
	IN checklist_ids MEDIUMTEXT
)
BEGIN
	SELECT
		`id`,
		`id_checklist`,
		`id_checklist_model_paragrafo`,
		`nome`,
		`descrizione`,
		`ordine`,
		`utente_mod`,
		`data_mod`
	FROM checklist_paragrafo
	WHERE FIND_IN_SET(id_checklist, checklist_ids)
	ORDER BY ordine;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistParagraphInsert
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistParagraphInsert`(
	`checklist_id`                       INT(11),
	`paragraph_model_id`                       INT(11),
	`name`                       VARCHAR(150),
	`description`                       TEXT,
	`my_order`                       INT(11),
	user_id INT(11), 
	OUT result INT(11)
)
MainLabel:BEGIN


	SET Result = 1; 
	
	IF Result 
	THEN

		INSERT INTO checklist_paragrafo
		SET 
			id_checklist = checklist_id,
			id_checklist_model_paragrafo = paragraph_model_id,
			nome = name,
			descrizione = description,
			ordine = my_order,
			utente_mod= user_id,
			data_mod = NOW();

		SET result = LAST_INSERT_ID();
	END IF;  
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistParagraphRowDeleteByChecklist
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistParagraphRowDeleteByChecklist`(
	enter_id INT(11),
	OUT result  TINYINT
)
BEGIN

	SET result = 0; 
	
	DELETE FROM checklist_paragrafo_riga
	WHERE id_checklist = enter_id;

	SET result = 1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistParagraphRowGetByChecklistIds
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistParagraphRowGetByChecklistIds`(
	IN checklist_ids MEDIUMTEXT
)
BEGIN
	SELECT
		`id`,
		`id_checklist`,
		`id_paragrafo`,
		`json_data`,
		`tipo_riga`,
		`id_checklist_model_elemento`,
		`id_checklist_model_paragrafo`,
		`id_checklist_model`,
		`ordine`,
		`nome`,
		`descrizione`,
		`indicazioni_tecnico`
	FROM checklist_paragrafo_riga
	WHERE FIND_IN_SET(id_checklist, checklist_ids)
	ORDER BY ordine;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistReportDeleteByChecklist
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistReportDeleteByChecklist`(
	enter_id INT(11),
	OUT result  TINYINT
)
BEGIN

	SET result = 0; 
	
	DELETE FROM checklist_rapporto
	WHERE id_checklist = enter_id;

	SET result = 1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistSaveSignaturesRefs
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistSaveSignaturesRefs`(
	checklist_id INT(11),
	customer_filename VARCHAR(50), 
	technician_filename VARCHAR(50)
)
BEGIN

	UPDATE checklist 
	SET 
		`filename_firma_cliente`                       = customer_filename,
		`filename_firma_tecnico`                       = technician_filename
	WHERE Id = checklist_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiChecklistUpdate
DELIMITER //
CREATE PROCEDURE `sp_apiChecklistUpdate`(
	enter_id INT(11),
	customer_id INT(11),
	responsable_id INT(11),
	responsable VARCHAR(150),
	system_id INT(11),
	company_name VARCHAR(150),
	address VARCHAR(150),
	city VARCHAR(150),
	system_installation_place VARCHAR(150),
	system_central VARCHAR(150),
	system_installation_date DATE,
	system_department VARCHAR(150),
	user_id INT(11), 
	others TEXT,
	visit_number TINYINT, 
	periodic_check TINYINT, 
	responsable_job VARCHAR(150),
	OUT result INT(11)
)
MainLabel:BEGIN


	SET Result = 1; 
	
	IF Result 
	THEN

		UPDATE checklist
		SET 
			`id_cliente`                       = customer_id,
			`id_responsabile`                       = responsable_id,
			`id_impianto`                       =  system_id,
			responsabile = responsable,
			`ragione_sociale`                       = company_name,
			`indirizzo`                       = address,
			`citta`                       = city,
			`impianto_luogo_installazione`                       = system_installation_place,
			`impianto_centrale`                       = system_central, 
			`impianto_data_installazione`                       = system_installation_date,
			`impianto_dipartimento`                       = system_department, 
			altro = others,
			responsabile_lavoro = responsable_job, 
			numero_visita = visit_number, 
			controllo_periodico = periodic_check,
			`utente_mod`                       = user_id,
			`data_mod`                       = NOW(),
			stampata = 0
		WHERE Id = enter_id;

		SET result = 1;
	END IF;  
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCompanyGetLast
DELIMITER //
CREATE PROCEDURE `sp_apiCompanyGetLast`(
)
BEGIN
	SELECT `id_azienda`,
		`titolare`,
		`ragione_sociale`,
		`settore`,
		`indirizzo`,
		`comune`,
		`provincia`,
		`telefono`,
		`cellulare`,
		`partita_iva`,
		`regImprese`,
		`alboProvinciale`,
		`ciaa`,
		`ciaa_n`,
		`albo_provincia`,
		`albo_n`,
		`numero`,
		`sito_internet`,
		`fax`,
		`e_mail`,
		`cod_fis`,
		`numero_rea`,
		`posizione_inps`,
		`posizione_inail`,
		`codice_ateco`,
		`assicu_rct`,
		`frazione`,
		`capi_soc`,
		`data`,
		`abilitazione`,
		`smtp`,
		`porta`,
		`mssl`,
		`utente_mail`,
		`password`,
		`nome_mail`,
		`banca`,
		`iban`,
		`listino`,
		`sconto`,
		`tipo_sconto`,
		`stampa_ragione`,
		`stampa_ri`,
		`giorni_promemoria`,
		`cap2`,
		`stampante_promemoria`,
		`mail_amministrazione`,
		`intestazione_promemoria`,
		`host_caldav`,
		`nome_caldav`,
		`license`,
		`abilita_convalida_rapporto`,
		`tele_fatt`,
		`circolare_per_garanzia`,
		`notifica_attesa`,
		`passaggio_nonaccettato`,
		`percorso_default_aggiornamento`,
		`giorni_avviso_rapporto`,
		`regime_fiscale`,
		'TO_REMOVE' AS aries_web_host,
		`Data_fine`,
		`Data_ins`,
		`Data_mod`,
		`Utente_ins`,
		`Utente_mod`,
		`email_provider_caldav`
	FROM Azienda ORDER BY Id_azienda DESC LIMIT 1; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCompanyInvalidateLicence
DELIMITER //
CREATE PROCEDURE `sp_apiCompanyInvalidateLicence`()
BEGIN
	
	UPDATE azienda
	SET license = 'GfbYgCInF9YsnqhVEvdFKRIdJGDYfnuJ196QlupiESHehGfXq2cidboHdmtnMwqx9HO6cCJGfu5PydeN59Q1ahKDpxqRaW9mkrNn';
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiConfigurationPathGetByKey
DELIMITER //
CREATE PROCEDURE `sp_apiConfigurationPathGetByKey`(
	IN path_key VARCHAR(50)
)
BEGIN
	SELECT Tipo_percorso, 
		Percorso
	FROM configurazione_percorsi
	WHERE Tipo_percorso = path_key;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerContactGet
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerContactGet`()
BEGIN


	SELECT DISTINCT id_riferimento, 
		riferimento_clienti.id_cliente, 
		IFNULL(titolo, "") 'titolo', 
		IFNULL(nome, "") 'nome', 
		IFNULL(riferimento_figura.Figura, "") 'figura',
		IFNULL(riferimento_clienti.Telefono, "") 'telefono', 
		IFNULL(riferimento_clienti.altro_telefono, "") 'altro_telefono', 
		IFNULL(riferimento_clienti.mail, "") 'mail',
		riferimento_clienti.Promemoria_cliente
	FROM riferimento_clienti 
		INNER JOIN riferimento_figura ON 
			riferimento_clienti.figura = riferimento_figura.Id_figura;
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerContactGetByCustomers
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerContactGetByCustomers`(
	IN customer_ids MEDIUMTEXT
)
BEGIN

	SELECT DISTINCT id_riferimento, 
		riferimento_clienti.id_cliente, 
		IFNULL(titolo, "") 'titolo', 
		IFNULL(nome, "") 'nome', 
		IFNULL(riferimento_figura.Figura, "") 'figura',
		IFNULL(riferimento_clienti.Telefono, "") 'telefono', 
		IFNULL(riferimento_clienti.altro_telefono, "") 'altro_telefono', 
		IFNULL(riferimento_clienti.mail, "") 'mail',
		riferimento_clienti.Promemoria_cliente	
	FROM riferimento_clienti 
		INNER JOIN riferimento_figura ON 
			riferimento_clienti.figura = riferimento_figura.Id_figura
	WHERE FIND_IN_SET(riferimento_clienti.id_cliente, customer_ids);
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerDestinationDaysToAvoidGet
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerDestinationDaysToAvoidGet`()
BEGIN   
	SELECT id_destinazione,
		id_cliente, 
		id_giorno
	FROM destinazione_giorni; 	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerDestinationGet
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerDestinationGet`()
BEGIN

	SELECT DISTINCT id_destinazione, 
		destinazione_cliente.id_cliente,
		IFNULL(destinazione_cliente.provincia, "") 'provincia',
		IFNULL(comune.nome, "") 'comune',
		IFNULL(frazione.nome, "") 'frazione',
		IFNULL(indirizzo, "") 'indirizzo', 
		IFNULL(numero_civico, 0) 'numero_civico', 
		IFNULL(destinazione_cliente.altro, "") 'altro', 
		comune.cap,
		km_sede, 
		tempo_strada,
		longitudine,
		latitudine
	FROM destinazione_cliente  
		LEFT JOIN comune ON
			destinazione_cliente.comune = id_comune
		LEFT JOIN frazione ON
			destinazione_cliente.Frazione = id_frazione;
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerDestinationGetByCustomers
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerDestinationGetByCustomers`(
	IN customer_ids MEDIUMTEXT
)
BEGIN

	SELECT DISTINCT id_destinazione, 
		destinazione_cliente.id_cliente,
		IFNULL(destinazione_cliente.provincia, "") 'provincia',
		IFNULL(comune.nome, "") 'comune',
		IFNULL(frazione.nome, "") 'frazione',
		IFNULL(indirizzo, "") 'indirizzo', 
		IFNULL(numero_civico, 0) 'numero_civico', 
		IFNULL(destinazione_cliente.altro, "") 'altro', 
		comune.cap,
		km_sede, 
		tempo_strada,
		longitudine,
		latitudine
	FROM destinazione_cliente  
		LEFT JOIN comune ON
			destinazione_cliente.comune = id_comune
		LEFT JOIN frazione ON
			destinazione_cliente.Frazione = id_frazione
	WHERE FIND_IN_SET(destinazione_cliente.id_cliente, customer_ids);
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerDestinationGetById
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerDestinationGetById`(
customer_id INT,
destination_id INT
)
BEGIN

	SELECT DISTINCT id_destinazione, 
		destinazione_cliente.id_cliente,
		IFNULL(destinazione_cliente.provincia, "") 'provincia',
		IFNULL(comune.nome, "") 'comune',
		IFNULL(frazione.nome, "") 'frazione',
		IFNULL(indirizzo, "") 'indirizzo', 
		IFNULL(numero_civico, 0) 'numero_civico', 
		IFNULL(destinazione_cliente.altro, "") 'altro', 
		comune.cap,
		km_sede, 
		tempo_strada,
		longitudine,
		latitudine
	FROM destinazione_cliente  
		LEFT JOIN comune ON
			destinazione_cliente.comune = id_comune
		LEFT JOIN frazione ON
			destinazione_cliente.Frazione = id_frazione
	WHERE destinazione_cliente.id_cliente = customer_id AND id_destinazione = destination_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerDestinationGetBySystemIds
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerDestinationGetBySystemIds`(system_ids MEDIUMTEXT)
BEGIN
	SELECT DISTINCT id_destinazione, 
		destinazione_cliente.id_cliente,
		IFNULL(destinazione_cliente.provincia, "") 'provincia',
		IFNULL(comune.nome, "") 'comune',
		IFNULL(frazione.nome, "") 'frazione',
		IFNULL(indirizzo, "") 'indirizzo', 
		IFNULL(numero_civico, 0) 'numero_civico', 
		IFNULL(destinazione_cliente.altro, "") 'altro', 
		comune.cap,
		km_sede, 
		tempo_strada,
		longitudine,
		latitudine
	FROM impianto
		INNER JOIN destinazione_cliente ON destinazione_cliente.id_cliente = impianto.id_cliente
			AND destinazione_cliente.id_destinazione = impianto.destinazione
		LEFT JOIN comune ON
			destinazione_cliente.comune = id_comune
		LEFT JOIN frazione ON
			destinazione_cliente.Frazione = id_frazione
	WHERE FIND_IN_SET(impianto.id_impianto, system_ids);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerGet
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerGet`()
BEGIN

	SELECT DISTINCT
		c.Id_cliente,
		c.Ragione_Sociale,
		c.Ragione_sociale2,
		IFNULL(c.Partita_iva, '') AS partita_iva,
		IFNULL(c.Codice_Fiscale, '') AS codice_fiscale,
		c.Cortese_attenzione,
		c.Data_inserimento,
		c.Stato_cliente,
		c.Tipo_Cliente,
		c.stato_economico,
		c.condizione_pagamento,
		c.Sito_internet,
		c.password,
		c.Utente_sito,
		c.iva,
		c.modi,
		c.rc,
		c.posta,
		c.ex,
		c.tipo_rapporto,
		c.id_utente,
		c.id_agente,
		c.id_abbona,
		c.id_attività as id_attivita,
		c.pec,
		c.codice_univoco,
		c.e_codice_destinatario,
		IFNULL(c.Insolvente, FALSE) AS Insolvente,
		c.data_ultima_modifica
	FROM clienti c
		INNER JOIN impianto ON 
			c.Id_cliente IN (impianto.Id_cliente, impianto.Id_gestore, impianto.Id_occupante);
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerGetByIds
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerGetByIds`(
	IN customer_ids MEDIUMTEXT
)
BEGIN

	SELECT DISTINCT 
		c.Id_cliente,
		c.Ragione_Sociale,
		c.Ragione_sociale2,
		IFNULL(c.Partita_iva, '') AS partita_iva,
		IFNULL(c.Codice_Fiscale, '') AS codice_fiscale,
		c.Cortese_attenzione,
		c.Data_inserimento,
		c.Stato_cliente,
		c.Tipo_Cliente,
		c.stato_economico,
		c.condizione_pagamento,
		c.Sito_internet,
		c.password,
		c.Utente_sito,
		c.iva,
		c.modi,
		c.rc,
		c.posta,
		c.ex,
		c.tipo_rapporto,
		c.id_utente,
		c.id_agente,
		c.id_abbona,
		c.id_attività as id_attivita,
		c.pec,
		c.codice_univoco,
		c.e_codice_destinatario,
		IFNULL(c.Insolvente, FALSE) AS Insolvente,
		c.data_ultima_modifica
	FROM clienti c
	WHERE FIND_IN_SET(`c`.`id_cliente`, customer_ids);
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerReminderConfigExecutedNow
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerReminderConfigExecutedNow`(
	IN service_id INT(11)
)
BEGIN
	UPDATE cliente_promemoria_configurazione
	SET Data_ultima_esecuzione = NOW()
	WHERE Id = service_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerReminderConfigGetById
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerReminderConfigGetById`(
	IN service_id INT(11)
)
BEGIN
	SELECT `Id`,
		`Nome`,
		`Tipo_intervallo`,
		`Valore`,
		Oggetto_email, 
		Corpo_email,
		Testo_sms,
		abilita_sms,
		abilita_email,
		Data_ultima_esecuzione,
		`Data_mod`,
		`Utente_mod`
	FROM cliente_promemoria_configurazione
	WHERE Id = service_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiCustomerReminderGeneralConfigurationGetLast
DELIMITER //
CREATE PROCEDURE `sp_apiCustomerReminderGeneralConfigurationGetLast`(
)
BEGIN
	SELECT
		`Id`,
		`Email_host`,
		`Email_username`,
		`Email_password`,
		`Email_port`,
		`Email_ssl`,
		Email_from,
		Sms_host,
		Sms_endpoint,
		Sms_password,
		Sms_host,
		`Data_ins`,
		`Utente_ins`
	FROM cliente_promemoria_configurazione_generale
	ORDER BY Id DESC
	LIMIT 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiDownloadFileHistoryInsert
DELIMITER //
CREATE PROCEDURE `sp_apiDownloadFileHistoryInsert`(
	IN `user_id` INT(11),
	IN `employee_id` INT(11),
	IN `file_path` VARCHAR(500),
	IN `file_name` VARCHAR(100),
	IN `application_ref` VARCHAR(50),
	OUT result INT(11)
)
BEGIN
	INSERT INTO storico_download_file
	SET `id_utente` = user_id,
		`id_operaio` = employee_id,
		`rif_applicazione` = application_ref,
		`file_path` = file_path,
		`file_name` = file_name;

	SET result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEmailSetReadFlag
DELIMITER //
CREATE PROCEDURE `sp_apiEmailSetReadFlag`(
	email_id INT(11),
	read_value BIT(1)
)
BEGIN

	UPDATE mail
	SET 
		Letto = read_value
	WHERE Id = email_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEmployeeGet
DELIMITER //
CREATE PROCEDURE `sp_apiEmployeeGet`()
BEGIN
	SELECT id_operaio, 
	ragione_sociale, 
	mail_account 
	FROM  Operaio 
	WHERE Data_licenziamento is null and Is_tecnico=1;	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEmployeeInsertLightContractor
DELIMITER //
CREATE PROCEDURE `sp_apiEmployeeInsertLightContractor`(
	IN company_name VARCHAR(50) ,
	IN insert_user_id SMALLINT, 
	OUT result INT
)
BEGIN

	INSERT INTO operaio
	SET 
		Ragione_sociale = company_name,
		d_nas= '1970-01-01',
		collaboratore = 1, 
		Tipo_operaio = 4,
		is_cassa = 0, 
		is_tecnico = 1,
		Data_ins = NOW(), 
		Utente_ins = insert_user_id;
		
	SELECT LAST_INSERT_ID() INTO result;
	
	SELECT id_operaio, 
		ragione_sociale, 
		mail_account 
	FROM  Operaio 
	WHERE Id_operaio = result;	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEmployeeShiftGetByBymployee
DELIMITER //
CREATE PROCEDURE `sp_apiEmployeeShiftGetByBymployee`(
employee_id INT(11),
start_date DATETIME
)
BEGIN
	SELECT 
		Id,
		Id_operaio, 
		Id_utente, 
		Latitudine, 
		Longitudine, 
		Data_rilevazione, 
		Sorgente_rilevazione, 
		Data_ins		
	FROM  operaio_spostamenti 
	WHERE id_operaio = employee_id AND Data_ins >= start_date
	ORDER BY Data_rilevazione desc; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEmployeeShiftInsert
DELIMITER //
CREATE PROCEDURE `sp_apiEmployeeShiftInsert`(
	IN user_id INT,  
	IN employee_id INT,
	IN source_detection TINYINT, 
	IN timestamp_detection DATETIME, 
	IN latitude DECIMAL(11,8), 
	IN longitude DECIMAL(11,8),
	OUT result INT
)
BEGIN	
	DECLARE `_rollback`                       BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback`                       = 1;
	
	SELECT COUNT(Id_utente) 
		INTO result 
	FROM Utente
	Where Id_utente = user_id; 
	
	IF result = 0 THEN 
		SET result = -1; -- user not found	
	ELSE
		SELECT COUNT(Id_operaio) 
			INTO result 
		FROM Operaio
		Where Id_operaio = employee_id; 
		
		IF result = 0 THEN 
			SET result = -2; -- employee not found	
		END IF; 
	END IF; 
	
	IF result > 0 THEN
	
		INSERT INTO Operaio_spostamenti
		SET
			Id_utente = user_id, 
			Id_operaio = employee_id, 
			Data_rilevazione = timestamp_detection, 
			Sorgente_rilevazione = source_detection, 
			Latitudine = latitude, 
			Longitudine = longitude;
	
		SET result = 1; 
	
	END IF; 
	
	IF `_rollback`                       THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEmployeeShiftLastForEachEmployee
DELIMITER //
CREATE PROCEDURE `sp_apiEmployeeShiftLastForEachEmployee`()
BEGIN
	SELECT 
		Id,
		Id_operaio, 
		Id_utente, 
		Latitudine, 
		Longitudine, 
		Data_rilevazione, 
		Sorgente_rilevazione, 
		Data_ins		
	FROM 
		(SELECT 
			operaio_spostamenti.Id,
			operaio_spostamenti.Id_operaio, 
			operaio_spostamenti.Id_utente, 
			operaio_spostamenti.Latitudine, 
			operaio_spostamenti.Longitudine, 
			operaio_spostamenti.Data_rilevazione, 
			operaio_spostamenti.Sorgente_rilevazione, 
			operaio_spostamenti.Data_ins		
		FROM operaio_spostamenti
			INNER JOIN operaio ON operaio.Id_operaio = operaio_spostamenti.id_operaio
				AND operaio.Data_licenziamento IS NULL
		WHERE Latitudine > 0 and Longitudine > 0
		ORDER BY Data_rilevazione DESC) AS employee_shift
	GROUP BY Id_operaio;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventEmployeeGet
DELIMITER //
CREATE PROCEDURE `sp_apiEventEmployeeGet`()
BEGIN   
	SELECT Evento_operaio.Id, 
		Evento_operaio.Id_evento,
		Evento_operaio.id_operaio,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione
	FROM Evento_operaio
		INNER JOIN Evento 
		ON Evento_operaio.Id_evento = Evento.Id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventEmployeeGetByNotifStatus
DELIMITER //
CREATE PROCEDURE `sp_apiEventEmployeeGetByNotifStatus`(	notification_status SMALLINT )
BEGIN
        
	SELECT Evento_operaio.Id, 
		Evento_operaio.Id_evento,
		Evento_operaio.id_operaio,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione
	FROM Evento_operaio
		INNER JOIN Evento 
		ON Evento_operaio.Id_evento = Evento.Id
	WHERE Evento.stato_notifica = notification_status; 
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventEmployeeGetFromDate
DELIMITER //
CREATE PROCEDURE `sp_apiEventEmployeeGetFromDate`(	from_date DATETIME )
BEGIN
        
	SELECT Evento_operaio.Id, 
		Evento_operaio.Id_evento,
		Evento_operaio.id_operaio,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione
	FROM Evento_operaio
		INNER JOIN Evento 
		ON Evento_operaio.Id_evento = Evento.Id
	WHERE IFNULL(Evento.Data_mod, Evento.Data_Ins) >= from_date;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventGet
DELIMITER //
CREATE PROCEDURE `sp_apiEventGet`()
BEGIN
        
	SELECT Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		IFNULL(impianto_abbonamenti_mesi.impianto,  Evento.Id_riferimento) id_riferimento,
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione, 
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Stato_notifica, 
		Evento.Data_notifica,
		Evento.Promemoria_inviato,
		Evento.Eliminato,
		Evento.Data_ins, 
		Evento.Data_mod,  
		evento_gruppo_evento.Id_gruppo_evento AS Id_gruppo,
		evento_gruppo.Id_impianto AS Id_impianto,
		evento_gruppo.Id_cliente AS Id_cliente
	FROM Evento
		LEFT JOIN evento_gruppo_evento
		ON evento_gruppo_evento.Id_evento = Evento.Id AND tipo_associazione = 1
		LEFT JOIN evento_gruppo
		ON evento_gruppo_evento.Id_gruppo_evento = Evento_gruppo.Id
		LEFT JOIN impianto_abbonamenti_mesi 
		ON evento.Id_riferimento = impianto_abbonamenti_mesi.id AND
			evento.Id_tipo_evento = 1; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventGetBetweenDates
DELIMITER //
CREATE PROCEDURE `sp_apiEventGetBetweenDates`(
	from_date DATETIME,
	to_date DATETIME
)
BEGIN
        
	SELECT Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		IFNULL(impianto_abbonamenti_mesi.impianto,  Evento.Id_riferimento) id_riferimento,
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione, 
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Stato_notifica, 
		Evento.Data_notifica, 
		Evento.Promemoria_inviato,
		Evento.Eliminato,
		Evento.Data_ins, 
		Evento.Data_mod,  
		evento_gruppo_evento.Id_gruppo_evento AS Id_gruppo,
		evento_gruppo.Id_impianto AS Id_impianto,
		evento_gruppo.Id_cliente AS Id_cliente
	FROM Evento
		LEFT JOIN evento_gruppo_evento
		ON evento_gruppo_evento.Id_evento = Evento.Id AND tipo_associazione = 1
		LEFT JOIN evento_gruppo
		ON evento_gruppo_evento.Id_gruppo_evento = Evento_gruppo.Id
		LEFT JOIN impianto_abbonamenti_mesi 
		ON evento.Id_riferimento = impianto_abbonamenti_mesi.id AND
			evento.Id_tipo_evento = 1
	WHERE TIMESTAMP(`Data_esecuzione`,`Ora_inizio_esecuzione`) BETWEEN from_date AND to_date; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventGetByNotifStatus
DELIMITER //
CREATE PROCEDURE `sp_apiEventGetByNotifStatus`(	notification_status SMALLINT )
BEGIN
    
	UPDATE evento 
	SET data_notifica = NULL 
	WHERE stato_notifica = 1 AND data_notifica IS NOT NULL; 
		
		
	SELECT Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		IFNULL(impianto_abbonamenti_mesi.impianto,  Evento.Id_riferimento) id_riferimento,
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione, 
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Stato_notifica, 
		Evento.Data_notifica, 
		Evento.Promemoria_inviato,
		Evento.Eliminato,
		Evento.Data_ins, 
		Evento.Data_mod,  
		evento_gruppo_evento.Id_gruppo_evento AS Id_gruppo,
		evento_gruppo.Id_impianto AS Id_impianto,
		evento_gruppo.Id_cliente AS Id_cliente
	FROM Evento
		LEFT JOIN evento_gruppo_evento
		ON evento_gruppo_evento.Id_evento = Evento.Id AND tipo_associazione = 1
		LEFT JOIN evento_gruppo
		ON evento_gruppo_evento.Id_gruppo_evento = Evento_gruppo.Id
		LEFT JOIN impianto_abbonamenti_mesi 
		ON evento.Id_riferimento = impianto_abbonamenti_mesi.id AND
			evento.Id_tipo_evento = 1
	WHERE evento.Stato_notifica = notification_status; 
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventGetFromDate
DELIMITER //
CREATE PROCEDURE `sp_apiEventGetFromDate`(	from_date DATETIME )
BEGIN
        
	SELECT Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		IFNULL(impianto_abbonamenti_mesi.impianto,  Evento.Id_riferimento) id_riferimento,
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione, 
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Stato_notifica, 
		Evento.Data_notifica, 
		Evento.Promemoria_inviato,
		Evento.Eliminato,
		Evento.Data_ins, 
		Evento.Data_mod,  
		evento_gruppo_evento.Id_gruppo_evento AS Id_gruppo,
		evento_gruppo.Id_impianto AS Id_impianto,
		evento_gruppo.Id_cliente AS Id_cliente
	FROM Evento
		LEFT JOIN evento_gruppo_evento
		ON evento_gruppo_evento.Id_evento = Evento.Id AND tipo_associazione = 1
		LEFT JOIN evento_gruppo
		ON evento_gruppo_evento.Id_gruppo_evento = Evento_gruppo.Id
		LEFT JOIN impianto_abbonamenti_mesi 
		ON evento.Id_riferimento = impianto_abbonamenti_mesi.id AND
			evento.Id_tipo_evento = 1
	WHERE IFNULL(evento.Data_mod, evento.Data_Ins) >= from_date; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventSetExecStatus
DELIMITER //
CREATE PROCEDURE `sp_apiEventSetExecStatus`(

	IN event_ids MEDIUMTEXT,
	IN exec_status BIT,
	IN report_id INT, 
	IN report_year INT
)
BEGIN

	START TRANSACTION; 

	SET @stmt = CONCAT("INSERT INTO splitArrayData(array_values) VALUES (", REPLACE(serializedArray, ",","),(") , ");");
	
	DROP TEMPORARY TABLE IF EXISTS splitArrayData;
	CREATE TEMPORARY TABLE splitArrayData (
		array_index INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		array_values VARCHAR(64) NOT NULL DEFAULT ""
	) ENGINE = innoDB;
	
	PREPARE sttmnt FROM @stmt;
	EXECUTE sttmnt;
	DEALLOCATE PREPARE sttmnt;
	
	SET @stmt = "";
	

	UPDATE evento
	SET evento.Eseguito = exec_status
	WHERE FIND_IN_SET(evento.Id, event_ids);
	
	INSERT INTO evento_rapporto (Id_evento, Id_rapporto, Anno_rapporto)
	SELECT array_values, 
		report_id, 
		report_year
	FROM splitArrayData;
	
	COMMIT;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventSetNotificationStatus
DELIMITER //
CREATE PROCEDURE `sp_apiEventSetNotificationStatus`(
IN idArray VARCHAR(1000),
IN notificationStatus TINYINT)
BEGIN

  SET @sql = CONCAT('UPDATE Evento 
  SET Stato_notifica = ', notificationStatus ,',
  Data_notifica = NOW()
  WHERE Id IN  (',idArray,'); ');
  PREPARE stmt FROM @sql;
  EXECUTE stmt;
  DEALLOCATE PREPARE stmt;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventSetPerformed
DELIMITER //
CREATE PROCEDURE `sp_apiEventSetPerformed`(
	IN event_id INT(11)
)
BEGIN
	DECLARE group_id INT(11); 
	DECLARE events_number_open INT(11);
	DECLARE events_number_close INT(11);
	
	SELECT Id_gruppo_evento 
		INTO group_id
	FROM evento_gruppo_evento
	WHERE tipo_associazione = 1 AND id_evento = event_id;
	
	UPDATE evento
	SET Data_mod = NOW(), 
		Eseguito = 1 
	WHERE evento.id = event_id;
	
	SELECT COUNT(Eseguito)
		INTO events_number_open
	FROM evento
		INNER JOIN evento_gruppo_evento 	
		ON tipo_associazione = 1 AND Id_gruppo_evento = group_id AND Evento.Id = evento_gruppo_evento.id_evento
	WHERE Evento.Eseguito = 0;
	
	SELECT COUNT(Eseguito)
		INTO events_number_close
	FROM evento
		INNER JOIN evento_gruppo_evento 	
		ON tipo_associazione = 1 AND Id_gruppo_evento = group_id AND Evento.Id = evento_gruppo_evento.id_evento
	WHERE Evento.Eseguito = 1;
	
	
	
	IF events_number_open = 0 then
		UPDATE evento_gruppo
		SET Data_mod = NOW(), 
			Id_stato = 3 
		WHERE id = group_id;
	ELSE
		IF events_number_close = 0 then
			UPDATE evento_gruppo
			SET Data_mod = NOW(), 
				Id_stato = 1 
			WHERE id = group_id;
		ELSE 
			UPDATE evento_gruppo
			SET Data_mod = NOW(), 
				Id_stato = 2
			WHERE id = group_id;
		END IF;
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventSetReminderSent
DELIMITER //
CREATE PROCEDURE `sp_apiEventSetReminderSent`(
IN idArray MEDIUMTEXT,
IN isReminderSent BIT)
BEGIN
  UPDATE Evento 
  SET Promemoria_inviato = isReminderSent
  WHERE FIND_IN_SET(Id, idArray);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiEventTypeGet
DELIMITER //
CREATE PROCEDURE `sp_apiEventTypeGet`()
BEGIN   
	SELECT id_tipo, 
			nome,
			tipo_evento.Id_tipologia ,
			tipologia_tipo_evento.Rif_applicazione as "Rif_applicazione_tipologia"
	FROM Tipo_evento
		INNER JOIN tipologia_tipo_evento
		ON tipo_evento.Id_tipologia = tipologia_tipo_evento.Id;	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiInvoiceOpenedGet
DELIMITER //
CREATE PROCEDURE `sp_apiInvoiceOpenedGet`()
BEGIN
	SELECT 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiInvoicePaymentsGetByPaymentStatus
DELIMITER //
CREATE PROCEDURE `sp_apiInvoicePaymentsGetByPaymentStatus`(
	payment_status BIT(1)
)
BEGIN

	SELECT 
		
		fattura.id_fattura,
		fattura.anno, 
		fattura.id_cliente,
		
		ROUND(fattura.importo_totale/a.mesi - (
	SELECT IF(SUM(importo) IS NULL,0, SUM(importo))
	FROM fattura_acconto
	WHERE fattura_acconto.id_fattura=fattura.id_fattura AND fattura_acconto.anno=fattura.anno AND fattura_acconto.id_pagamento = DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d'))+((bollo+incasso+trasporto)*((22+100)/100))/a.mesi, 2) AS "importo_rata", 

			IFNULL(fattura_pagamenti.`data`, LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY) AS "data_pagamento", 
			IFNULL(fattura_pagamenti.id_pagamento, CAST(DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY, '%Y%m%d')  AS UNSIGNED)) AS "id_pagamento", 
			a.nome AS "condizione_pagamento", 
			IF(fattura_pagamenti.tipo_pagamento IS NOT NULL, tipopag_pagamento1.nome, tipopag_pagamento.nome) AS "tipo_pagamento", 
			IF(fattura_pagamenti.tipo_pagamento IS NOT NULL, tipopag_pagamento1.Id_tipo, tipopag_pagamento.Id_tipo) AS "id_tipo_pagamento", 
			fattura_pagamenti.insoluto
	FROM fattura
		INNER JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione
		INNER JOIN condizioni_giorno AS g ON g.id_condizione = a.id_condizione
		LEFT JOIN fattura_pagamenti ON fattura.id_fattura=fattura_pagamenti.id_fattura AND fattura_pagamenti.anno=fattura.anno AND fattura_pagamenti.id_pagamento= DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d')
		LEFT JOIN tipo_pagamento AS tipopag_pagamento ON a.tipo = tipopag_pagamento.id_tipo
		LEFT JOIN tipo_pagamento AS tipopag_pagamento1 ON fattura_pagamenti.tipo_pagamento = tipopag_pagamento1.id_tipo
	WHERE fattura_pagamenti.data IS NULL AND fattura.anno <> 0
	GROUP BY fattura.id_fattura, fattura.anno, Data_pagamento
	ORDER BY fattura.anno desc, fattura.id_fattura desc;
	

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiNotificationTypeGet
DELIMITER //
CREATE PROCEDURE `sp_apiNotificationTypeGet`()
BEGIN   
	SELECT id,
		descrizione, 
		id_traduzione,
		rif_applicazioni
	FROM tipo_notifica
	WHERE abilitato = 1; 	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiProductGet
DELIMITER //
CREATE PROCEDURE `sp_apiProductGet`()
BEGIN
	SELECT codice_articolo,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		Desc_brev,
		Tempo_installazione,
		stato_articolo, 
		CAST(Data_inserimento as Datetime) Data_ins, 
		articolo.modifica, 
		barcode,
		unità_misura unita_misura, 
		marca.nome as 'marca', 
		marca.id_marca,
		listino_prezzo.prezzo as "prezzo_interno",
		listino_costo.prezzo as "costo_interno",
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	 FROM articolo 
		LEFT JOIN marca ON marca.id_marca = articolo.marca
		INNER JOIN articolo_listino AS listino_prezzo ON listino_prezzo.id_articolo = articolo.codice_articolo AND listino_prezzo.id_listino = fnc_productInternalPriceId()
		INNER JOIN articolo_listino AS listino_costo ON listino_costo.id_articolo = articolo.codice_articolo AND listino_costo.id_listino = fnc_productInternalCostId();
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiProductGetByCodes
DELIMITER //
CREATE PROCEDURE `sp_apiProductGetByCodes`(
	IN product_codes MEDIUMTEXT
)
BEGIN
	SELECT DISTINCT codice_articolo,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		Desc_brev,
		Tempo_installazione,
		stato_articolo, 
		CAST(Data_inserimento as Datetime) Data_ins, 
		articolo.modifica, 
		barcode,
		unità_misura unita_misura, 
		marca.nome as 'marca', 
		marca.id_marca,
		listino_prezzo.prezzo as "prezzo_interno",
		listino_costo.prezzo as "costo_interno",
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	 FROM articolo 
		LEFT JOIN marca ON marca.id_marca = articolo.marca
		LEFT JOIN articolo_codice ON articolo.codice_articolo = articolo_codice.id_articolo
		INNER JOIN articolo_listino AS listino_prezzo ON listino_prezzo.id_articolo = articolo.codice_articolo AND listino_prezzo.id_listino = fnc_productInternalPriceId()
		INNER JOIN articolo_listino AS listino_costo ON listino_costo.id_articolo = articolo.codice_articolo AND listino_costo.id_listino = fnc_productInternalCostId()
	 WHERE FIND_IN_SET(`articolo`.`codice_articolo`, product_codes);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiProductSearch
DELIMITER //
CREATE PROCEDURE `sp_apiProductSearch`(
	IN product_code VARCHAR(100), 
	IN supplier_product_code VARCHAR(100), 
	IN description VARCHAR(100), 
	IN my_barcode VARCHAR(100)
)
BEGIN
	SELECT DISTINCT codice_articolo,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		Desc_brev,
		Tempo_installazione,
		stato_articolo, 
		CAST(Data_inserimento as Datetime) Data_ins, 
		articolo.modifica, 
		barcode,
		unità_misura unita_misura, 
		marca.nome as 'marca', 
		marca.id_marca,
		IFNULL(listino_prezzo.prezzo, 0) as "prezzo_interno",
		IFNULL(listino_costo.prezzo, 0) as "costo_interno",
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	 FROM articolo 
		LEFT JOIN marca ON marca.id_marca = articolo.marca
		LEFT JOIN articolo_codice ON articolo.codice_articolo = articolo_codice.id_articolo
		LEFT JOIN articolo_listino AS listino_prezzo ON listino_prezzo.id_articolo = articolo.codice_articolo AND listino_prezzo.id_listino = fnc_productInternalPriceId()
		LEFT JOIN articolo_listino AS listino_costo ON listino_costo.id_articolo = articolo.codice_articolo AND listino_costo.id_listino = fnc_productInternalCostId()
	 WHERE (product_code IS NOT NULL AND codice_articolo LIKE CONCAT("%", product_code, "%"))
		OR (supplier_product_code IS NOT NULL AND Codice_fornitore LIKE CONCAT("%", supplier_product_code, "%"))
		OR (description IS NOT NULL AND Desc_brev LIKE CONCAT("%", description, "%"))
		OR (my_barcode IS NOT NULL AND barcode LIKE CONCAT("%", my_barcode, "%"))
		OR (supplier_product_code IS NOT NULL AND articolo_codice.codice LIKE CONCAT("%", supplier_product_code, "%"))
		OR (my_barcode IS NOT NULL AND articolo_codice.codice LIKE CONCAT("%", my_barcode, "%"))
	ORDER BY Desc_brev;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiProductStatusGet
DELIMITER //
CREATE PROCEDURE `sp_apiProductStatusGet`()
BEGIN
	SELECT id_stato, 
	nome, 
	bloccato
	FROM articolo_stato; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiProductUpdate
DELIMITER //
CREATE PROCEDURE `sp_apiProductUpdate`(
	IN product_code VARCHAR(11), 
	IN my_barcode VARCHAR(50), 
	IN allow_my_barcode BIT(1),
	IN depot_shelf VARCHAR(50), 
	IN allow_depot_shelf BIT(1),
	IN depot_shelf_tier VARCHAR(50), 
	IN allow_depot_shelf_tier BIT(1),
	IN depot_position_description VARCHAR(255), 
	IN allow_depot_position_description BIT(1)
)
BEGIN
	UPDATE Articolo 
	SET
		barcode = IF(IFNULL(allow_my_barcode, FALSE), my_barcode, barcode),
		scaffaliera_magazzino = IF(IFNULL(allow_depot_shelf, FALSE), depot_shelf, scaffaliera_magazzino),
		ripiano_magazzino = IF(IFNULL(allow_depot_shelf_tier, FALSE), depot_shelf_tier, ripiano_magazzino),
		descrizione_posizione_magazzino = IF(IFNULL(allow_depot_position_description, FALSE), depot_position_description, descrizione_posizione_magazzino)
	WHERE codice_articolo = product_code;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportAttachmentDeleteByReport
DELIMITER //
CREATE PROCEDURE `sp_apiReportAttachmentDeleteByReport`(
	id INT, 
	`year`                       INT
)
BEGIN
	
	DELETE 
	FROM rapporto_allegati 
	WHERE id_rapporto= id AND anno_rapporto = `year`; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportAttachmentGetByReport
DELIMITER //
CREATE PROCEDURE `sp_apiReportAttachmentGetByReport`(
	IN report_id INT,
	IN report_year INT
)
BEGIN
	SELECT rapporto_allegati.*
	FROM rapporto_allegati
	WHERE rapporto_allegati.id_rapporto = report_id and rapporto_allegati.anno_rapporto = report_year
	ORDER BY rapporto_allegati.timestamp;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportAttachmentInsert
DELIMITER //
CREATE PROCEDURE `sp_apiReportAttachmentInsert`(
	report_id INT(11), 
	`report_year`                       INT(11),
	`file_name`                       VARCHAR(250), 
	file_path MEDIUMTEXT,
	send_to_customer BIT(1),
	generate_ticket BIT(1),
	`timestamp`                       TIMESTAMP,
	`user_id`                       INT(11)
)
BEGIN	

	INSERT INTO rapporto_allegati
	SET `id_rapporto`= report_id,
		`anno_rapporto`                       = report_year,
		`file_path`                       = file_path,
		`file_name`                       = file_name,
		`timestamp`                       = timestamp,
		`utente_ins`                       = user_id,
		invia_a_cliente = send_to_customer,
		genera_ticket = generate_ticket
		;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportDailyActivityDeleteByReportDaily
DELIMITER //
CREATE PROCEDURE `sp_apiReportDailyActivityDeleteByReportDaily`(
	`report_daily_id`                       INT(11))
BEGIN

	CALL sp_apiReportDailyActivityReportDeleteByReportDaily(report_daily_id);
	CALL sp_apiReportDailyActivityPositionDeleteByReportDaily(report_daily_id);

	DELETE FROM rapporto_giornaliero_attivita  
	WHERE Id_rapporto_giornaliero = report_daily_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportDailyActivityInsert
DELIMITER //
CREATE PROCEDURE `sp_apiReportDailyActivityInsert`(
	`report_daily_id`                       INT(11),
	`work_type`                       INT(11),
	`work_description`                       VARCHAR(200),
	`start_time`                       TIME,
	`end_time`                       TIME,
	`notes`                       TEXT,
	`user_id`                       MEDIUMINT(9),
	OUT `result`                       INT)
MainLabel:BEGIN

	SET result = 1;
	
	SELECT COUNT(report_daily_id) 
		INTO result
	FROM rapporto_giornaliero
	WHERE rapporto_giornaliero.Id = report_daily_id; 
	
	IF result = 0 THEN
		SET result = -1; -- report daily not found
		LEAVE MainLabel; 
	END IF;  
	
	SELECT COUNT(id_utente) 
		INTO result
	FROM Utente
	WHERE utente.Id_utente = user_id;
	
	IF result = 0 THEN 
		SET result = -2; -- user not found
		LEAVE MainLabel; 
	END IF;

	IF result = 1 THEN
	
		INSERT INTO rapporto_giornaliero_attivita 
		SET 
			`Id_rapporto_giornaliero`                       = report_daily_id,
			`tipo_lavoro`= work_type,
			`descrizione_lavoro`                       = work_description,
			`ora_inizio`                       = start_time,
			`ora_fine`                       = end_time,
			`note`                       = notes,
			data_ins = NOW(), 
			utente_ins = user_id;
			
		SELECT LAST_INSERT_ID() INTO result; 
			
	END IF; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportDailyActivityPositionDeleteByReportDaily
DELIMITER //
CREATE PROCEDURE `sp_apiReportDailyActivityPositionDeleteByReportDaily`(
	`report_daily_id`                       INT(11))
BEGIN	

	DELETE FROM rapporto_giornaliero_attivita_posizione 
	WHERE Id_rapporto_giornaliero = report_daily_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportDailyActivityReportDeleteByReportDaily
DELIMITER //
CREATE PROCEDURE `sp_apiReportDailyActivityReportDeleteByReportDaily`(
	`report_daily_id`                       INT(11))
BEGIN	

	DELETE FROM rapporto_giornaliero_attivita_rapporto  
	WHERE Id_rapporto_giornaliero = report_daily_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportDailyActivityTypeGet
DELIMITER //
CREATE PROCEDURE `sp_apiReportDailyActivityTypeGet`()
BEGIN	

	SELECT Id, 
		Nome 
	FROM rapporto_giornaliero_tipo_attivita;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportDailyDelete
DELIMITER //
CREATE PROCEDURE `sp_apiReportDailyDelete`(
	`report_daily_id`                       INT(11))
BEGIN	

	CALL sp_apiReportDailyActivityDeleteByReportDaily(report_daily_id);

	DELETE FROM rapporto_giornaliero  
	WHERE rapporto_giornaliero.Id = report_daily_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportDailyInsert
DELIMITER //
CREATE PROCEDURE `sp_apiReportDailyInsert`(
	`employee_id`                       INT(11),
	`report_date`                       DATE,
	`user_id`                       MEDIUMINT(9),
	OUT `result`                       INT)
MainLabel:BEGIN

	SET result = 1;
	
	SELECT COUNT(Id_operaio) 
		INTO result
	FROM Operaio
	WHERE Id_operaio = employee_id; 
	
	IF result = 0 THEN
		SET result = -1; -- employee not found
		LEAVE MainLabel; 
	END IF;  
	
	SELECT COUNT(id_utente) 
		INTO result
	FROM Utente
	WHERE utente.Id_utente = user_id;
	
	IF result = 0 THEN 
		SET result = -2; -- user not found
		LEAVE MainLabel; 
	END IF;

	IF result = 1 THEN
	
		INSERT INTO rapporto_giornaliero 
		SET 
			Id_operaio = employee_id,  
			data_rapporto = report_date,
			data_ins = NOW(), 
			utente_ins = user_id;
			
		SELECT LAST_INSERT_ID() INTO result; 
			
	END IF; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportGet
DELIMITER //
CREATE PROCEDURE `sp_apiReportGet`()
BEGIN
	SELECT Id_rapporto,
		anno, 
		Id_impianto, 
		id_destinazione, 
		id_cliente, 
		Stato as id_stato,
		stato_rapporto.nome as stato,
		CAST(Data_esecuzione AS DATETIME) Data_esecuzione, 
		CONCAT(IFNULL(relazione, ""), "\nNOTE IN EVIDENZA: ", IFNULL(note_generali, ""),
			"\nAPPUNTI: ", IFNULL(appunti, "")) relazione,
		IFNULL(note_generali, "") note_generali,
		stato_rapporto.fatturato,
		rapporto.numero_allegati
	FROM  rapporto
		INNER JOIN stato_rapporto ON stato_rapporto.Id_stato = rapporto.stato
	WHERE id_impianto IS NOT NULL;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportGetIds
DELIMITER //
CREATE PROCEDURE `sp_apiReportGetIds`(quantity INT)
BEGIN
	CALL sp_apiReportGetIdsByYear(quantity, YEAR(CURDATE())); 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportGetIdsByYear
DELIMITER //
CREATE PROCEDURE `sp_apiReportGetIdsByYear`(quantity INT, current_year INT)
BEGIN

	
	DECLARE id_rapp INT;
	DECLARE id_rapp_mobile INT;
	
	DECLARE start_report_id INT;
	DECLARE counter INT;
	
	
	START TRANSACTION; 
		
	SET counter = 0; 
	
	DROP TABLE IF EXISTS ReportIds;
	CREATE TEMPORARY TABLE ReportIds
	(
		id_rapporto INT, 
		anno INT
	);
	
	SELECT IFNULL(MAX(a.id_rapporto)+1, 1) INTO id_rapp 
	from rapporto as a 
	where anno=current_year;
	
	SELECT IFNULL(max(a.id_rapporto)+1, 1) INTO id_rapp_mobile 
	from rapporto_mobile as a 
	where anno=current_year;
	
	
	if id_rapp>id_rapp_mobile then
	 set start_report_id=id_rapp;
	else
	 set start_report_id=id_rapp_mobile;
	end if;
	
	
   WHILE(counter < quantity) DO
    INSERT INTO ReportIds VALUES (start_report_id + counter, current_year);
    SET counter = counter + 1; 
   END WHILE;

	INSERT INTO rapporto_mobile (id_rapporto, anno, diritto_chiamata, tipo_diritto_chiamata, festivo, su_chiamata, eff_giorn,sost, ripar, `not`, c_not, abbon, garanz, man_ordi, fuorigaranz, man_straord, tipo_impianto,ragione_sociale, indirizzo, citta, luogo_lavoro, difetto, inviato, visionato, fuoriabbon, id_tecnico,
		numero_allegati)
	SELECT id_rapporto ,
			  anno, 
			  "0",
			  "0",
			  "0",
			  "0",
			  "0",
			  "0","0","0", "0","0","0","0","0","0","0","0","0","0","0","0","0", 0, 0 , 0, 0
	FROM ReportIds;


	
	SELECT id_rapporto, 
		anno
	FROM ReportIds; 
	
	COMMIT;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportGroupGet
DELIMITER //
CREATE PROCEDURE `sp_apiReportGroupGet`()
BEGIN
	SELECT 
		resoconto.`id_resoconto`,
		resoconto.`anno`,
		`data`,
		resoconto.`Descrizione`,
		`Numero_ordine`,
		`Id_cliente`,
		stato_resoconto.Id_stato AS id_stato_resoconto,
		stato_resoconto.nome AS stato_resoconto,
		`Nota`,
		`fattura`,
		`anno_fattura`,
		`id_utente`,
		tipo_resoconto.id_tipo AS id_tipo_resoconto,
		tipo_resoconto.nome AS tipo_resoconto,
		IFNULL(inviato, 0) AS inviato,
		`nota_fine`,
		IFNULL(stm, 0) as stm,
		`fat_SpeseRap`,
		`prezzo_manutenzione`,
		`resoconto_totali`.costo_manutenzione,
		`costo_diritto_chiamata`,
		`prezzo_diritto_chiamata`,
		`costo_lavoro`,
		`prezzo_lavoro`,
		`costo_viaggio`,
		`prezzo_viaggio`,
		`costo_materiale`,
		`prezzo_materiale`,
		`costo_totale`,
		`prezzo_totale`
	FROM resoconto
		INNER JOIN resoconto_totali ON resoconto.id_resoconto = resoconto_totali.id_resoconto AND resoconto.anno = resoconto_totali.anno
		INNER JOIN stato_resoconto ON resoconto.stato = stato_resoconto.id_stato
		INNER JOIN tipo_resoconto ON resoconto.tipo_resoconto = tipo_resoconto.id_tipo;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileEventDelete
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileEventDelete`(
	id INT, 
	`year`                       INT
)
BEGIN	
	DELETE 
	FROM rapporto_mobile_evento
	WHERE id_rapporto= id AND anno = `year`; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileEventInsert
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileEventInsert`(
	IN report_id INT(11) ,
	IN report_year INT(11) ,
	IN event_id INT(11) 
)
BEGIN

	INSERT INTO rapporto_mobile_evento
	SET 
		Id_rapporto = report_id,
		anno = report_year,
		Id_evento = event_id;
		

	CALL sp_apiEventSetPerformed(event_id);

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionCancelInsertOperation
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionCancelInsertOperation`(
	id INT, 
	`year`                       INT
)
BEGIN	
	CALL sp_apiReportMobileInterventionProductDeleteByReport(id, `year`); 
	CALL sp_apiReportMobileInterventionTicketDeleteByReport(id, `year`); 
	CALL sp_apiReportMobileInterventionWorkDelete(id, `year`); 
	CALL sp_apiReportMobileInterventionDelete(id, `year`); 
	CALL sp_apiReportMobileInterventionTechnicianDelete(id, `year`); 
	CALL sp_apiReportMobileInterventionSignatureDeleteByReport(id, `year`); 
	CALL sp_apiReportMobileRecipientDelete(id, `year`); 
	CALL sp_apiReportAttachmentDeleteByReport(id, `year`); 
	
	INSERT INTO rapporto_mobile 
	(id_rapporto, anno, diritto_chiamata, tipo_diritto_chiamata, 
	festivo, su_chiamata, eff_giorn,sost, ripar, `not`, c_not, 
	abbon, garanz, man_ordi, fuorigaranz, man_straord, 
	tipo_impianto,ragione_sociale, indirizzo, citta, 
	luogo_lavoro, difetto, inviato, visionato, fuoriabbon, numero_allegati)
	VALUES
	(id ,`year`, "0","0","0","0","0","0","0","0", "0","0","0","0","0","0","0","0","0","0","0","0","0",'1', 0, 0 );

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionCheckExistence
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionCheckExistence`(
	id INT, 
	`year`                       INT,
	OUT result BIT 
)
BEGIN
   	
	SELECT IFNULL(COUNT(id_rapporto),0)
	INTO
	result 
	FROM rapporto_mobile 
	WHERE id_rapporto= id AND anno = `year`                       AND inviato = 1; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionDelete
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionDelete`(
	id INT, 
	`year`                       INT
)
BEGIN
 	
	DELETE 
	FROM rapporto_mobile 
	WHERE id_rapporto= id AND anno = `year`; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionInsert
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionInsert`(
	id INT, 
	`year` INT,
	system_id INT,  
	customer_id INT,  
	requesting_intervention VARCHAR(30),
	responsible_job VARCHAR(30),
	responsible VARCHAR(30), 
	intervention_type TINYINT, 
	right_call BIT, 
	technical_report TEXT, 
	notes_highlights TEXT, 
	is_work_finished BIT, 
	system_conditions TINYINT,
	execution_date DATE, 
	report_number INT, 
	user_id INT, 
	email_company VARCHAR(45),
	is_nocturnal BIT, 
	is_public_holiday BIT, 
	is_on_call BIT, 
	is_carried_out_in_day BIT, 
	is_replaced BIT, 
	is_repair BIT, 
	is_custom BIT,
	intervention_detail_custom_text VARCHAR(45),
	is_under_warranty BIT,
	is_subscribed BIT, 
	is_not_under_warranty BIT,
	is_not_subscribed BIT, 
	ordinary_maintenance BIT, 
	extra_ordinary_maintenance BIT, 
	system_type INT, 
	company_name VARCHAR(60), 
	address VARCHAR(100), 
	city VARCHAR(100),  
	work_place VARCHAR(255), 
	problem_detected VARCHAR(100),
	email_responsible VARCHAR(100), 
	responsible_id INT,
	send_to_technician INT,
	clipboard TEXT,
	is_telephone_avaibility BIT,
	technician_sender_id MEDIUMINT, 
	creation_timestamp DATETIME, 
	delivery_timestamp DATETIME,
	telephone_avaibility_timestamp DATETIME, 
	has_ddt_signature BIT(1),
	attachments_number SMALLINT,
	report_type SMALLINT
)
BEGIN
	DECLARE subscription_id INT; 
	DECLARE destination_id INT;
	DECLARE ref_interventionType TINYINT;  
	
	SET subscription_id = 0; 
	SET destination_id = 0; 
	
	IF(system_id>0) THEN 
		SELECT abbonamento, destinazione
		INTO subscription_id, destination_id
		FROM Impianto 
		WHERE id_impianto = system_id; 
	END IF; 
	
	IF(destination_id=0) THEN 
		SET destination_id = 1;  
	END IF; 
	
	SELECT rapporto_mobile_intervento_rif_tipo_intervento.Id_tipo_intervento 
		INTO
			ref_interventionType
	FROM rapporto_mobile_intervento_rif_tipo_intervento 
	WHERE rapporto_mobile_intervento_rif_tipo_intervento.Posizione = intervention_type; 
	
	INSERT INTO rapporto_mobile SET 
		id_rapporto = id,
		anno = year, 
		id_impianto = system_id, 
		id_destinazione = destination_id, 
		id_cliente = customer_id, 
		Richiesto = requesting_intervention, 
		mansione = responsible_job, 
		responsabile = responsible,
		tipo_intervento = IFNULL(ref_interventionType, 2), 
		Diritto_chiamata = right_call, 
		tipo_diritto_chiamata = 0, 
		relazione = technical_report, 
		terminato = is_work_finished, 
		funzionante = system_conditions, 
		stato = 1, 
		Note_generali = notes_highlights,
		Fattura = NULL, 
		Data = CURDATE(), 
		Commessa = NULL, 
		abbonamento = NULL, 
		Numero_ordine = NULL, 
		Totale = 0, 
		Nr_rapporto = report_number, 
		Data_esecuzione = execution_date, 
		costo = 0, 
		scan = 0, 
		anno_fattura = NULL, 
		controllo_periodico = NULL,
		prima = 0, 
		numero = report_number,
		id_utente = user_id, 
		cost_lav = NULL, 
		prez_lav = NULL, 
		dest_cli = customer_id, 
		email_invio = email_company,
		inviato = 0, 
		visionato = 0, 
		id_ticket = NULL, 
		tecnici = NULL, 
		appunti = clipboard, 
		notturno = is_nocturnal, 
		festivo = is_public_holiday, 
		su_chiamata = is_on_call, 
		eff_giorn = is_carried_out_in_day, 
		sost = is_replaced, 
		ripar = is_repair, 
		`not`                       = intervention_detail_custom_text, 
		c_not = is_custom, 
		abbon = is_subscribed, 
		garanz = is_under_warranty,
		man_ordi = ordinary_maintenance, 
		fuoriabbon = IFNULL(is_not_subscribed, 0), 
		fuorigaranz = IFNULL(is_not_under_warranty, 0),
		man_straord = extra_ordinary_maintenance, 
		tipo_impianto = system_type,
		ragione_sociale = company_name, 
		indirizzo = address, 
		citta = city, 
		luogo_lavoro = work_place, 
		difetto = problem_detected, 
		id_riferimento = responsible_id,
		mail_responsabile = email_responsible, 
		invia_a_tecnico = send_to_technician,
		da_reperibilita_telefonica = is_telephone_avaibility,
		id_tecnico = technician_sender_id, 
		timestamp_creazione = creation_timestamp, 
		timestamp_invio = delivery_timestamp, 
		timestamp_reperibilita = telephone_avaibility_timestamp,
		usa_altra_firma_su_ddt = has_ddt_signature,
		tipo_rapporto = report_type,
		numero_allegati = attachments_number;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionProductDeleteByReport
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionProductDeleteByReport`(
	id INT, 
	`year`                       INT
)
BEGIN	
	DELETE 
	FROM rapporto_mobile_materiale 
	WHERE id_rapporto= id AND anno_rapporto = `year`; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionSaveSignaturesRefs
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionSaveSignaturesRefs`(
	report_id INT(11),
	report_year INT(11),
	customer_filename VARCHAR(50), 
	technician_filename VARCHAR(50), 
	ddt_signature_filename VARCHAR(50)
)
BEGIN

	UPDATE rapporto_mobile 
	SET 
		`filename_firma_cliente`                       = customer_filename,
		`filename_firma_tecnico`                       = technician_filename, 
		filename_firma_per_ddt = ddt_signature_filename
	WHERE Id_rapporto = report_id AND Anno = report_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionSignatureDeleteByReport
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionSignatureDeleteByReport`(
	id INT, 
	`year`                       INT
)
BEGIN	
	DELETE FROM rapporto_mobile_firma
	WHERE id_rapporto = id AND anno_rapporto = `year`;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionSignatureInsert
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionSignatureInsert`(
	id INT, 
	`year`                       INT,
	technician_signature BLOB, 
	customer_signature BLOB
)
BEGIN	

	INSERT INTO rapporto_mobile_firma
	SET id_rapporto = id,
	  anno_rapporto = `year`,
	  firma_tecnico = technician_signature, 
	  firma_cliente = customer_signature; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionTechnicianDelete
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionTechnicianDelete`(
	id INT, 
	`year`                       INT
)
BEGIN	
	DELETE 
	FROM rapporto_mobile_tecnico
	WHERE id_rapporto= id AND anno_rapporto = `year`; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionTicketDeleteByReport
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionTicketDeleteByReport`(
	id INT, 
	`year`                       INT
)
BEGIN
	
	DELETE 
	FROM rapporto_mobile_ticket 
	WHERE id_rapporto= id AND anno_rapporto = `year`; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionWorkDelete
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionWorkDelete`(
	id INT, 
	`year`                       INT
)
BEGIN 	
	DELETE 
	FROM rapporto_mobile_lavoro 
	WHERE id_rapporto= id AND anno_rapporto = `year`; 		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileInterventionWorkInsert
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileInterventionWorkInsert`(
	id INT, 
	`year`                       INT,
	work_description TINYINT,
	material_use DeCIMAL(11,2), 
	right_call BIT, 
	travel_consuntive BIT, 
	expense_consuntive BIT, 
	expense DECIMAL(11,2), 
	first_period_start TIME,
	second_period_start TIME, 
	first_period_end TIME, 
	second_period_end TIME, 
	technicians VARCHAR(100), 
	total_hours VARCHAR(45) , 
	extra_consuntive  BIT, 
	extra_text VARCHAR(35), 
	extra_expense DECIMAL(11,2),
	vans_number TINYINT
)
BEGIN
        
		
	INSERT INTO rapporto_mobile_lavoro
	SET id_rapporto = id,
		anno_rapporto = `year`, 
		controllo_periodico = work_description,
		materiale_uso = material_use, 
		diritto_chiamata = right_call, 
		viaggio_consuntivo = travel_consuntive,
		spese_consuntivo = expense_consuntive, 
		spese = expense, 
		ora_inizio_primo_periodo = first_period_start, 
		ora_fine_primo_periodo = first_period_end,
		ora_inizio_secondo_periodo = second_period_start, 
		ora_fine_secondo_periodo = second_period_end,
		tecnici = technicians, 
		totale_ore = total_hours, 
		extra_consuntivo = extra_consuntive, 
		extra_testo = extra_text,
		extra = extra_expense,
		numero_furgoni = vans_number;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileRecipientDelete
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileRecipientDelete`(
	id INT, 
	`year`                       INT
)
BEGIN	
	DELETE 
	FROM rapporto_mobile_destinatario
	WHERE id_rapporto= id AND anno = `year`; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileTestCancelInsertOperation
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileTestCancelInsertOperation`(
	report_id INT, 
	`report_year`                       INT
)
BEGIN	
	CALL sp_apiReportMobileTestDelete(report_id, `report_year`); 
	CALL sp_apiReportMobileInterventionTechnicianDelete(report_id, `report_year`); 
	CALL sp_apiReportMobileInterventionWorkDelete(report_id, `report_year`); 
	CALL sp_apiReportMobileInterventionSignatureDeleteByReport(report_id, `report_year`); 
	CALL sp_apiReportMobileRecipientDelete(id, `year`); 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileTestCheckExistence
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileTestCheckExistence`(
	report_id INT, 
	report_year INT,
	OUT result BIT 
)
BEGIN
   	
	SELECT IFNULL(COUNT(id_rapporto),0)
	INTO
		result 
	FROM rapporto_mobile_collaudo 
	WHERE id_rapporto = report_id AND anno = report_year; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileTestDelete
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileTestDelete`(
	report_id INT, 
	`report_year`                       INT
)
BEGIN	
	DELETE 
	FROM rapporto_mobile_collaudo
	WHERE id_rapporto= report_id AND anno = `report_year`; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileTestInsert
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileTestInsert`(
	`report_id`                       SMALLINT,
	`report_year`                       SMALLINT,
	`customer_id`                       INT,
	`system_id`                       INT,
	`address`                       VARCHAR(255),
	`telephone_number`                       VARCHAR(20),
	`fax_number`                       VARCHAR(20),
	`tax_fiscal_code`                       VARCHAR(20),
	`request_from`                       VARCHAR(30),
	`email`                       VARCHAR(35),
	`email_responsible`                       VARCHAR(35),
	`enter_date`                       DATETIME,
	`vehicle_description`                       VARCHAR(100),
	`ref_intervention_type`                       INT(11),
	`ref_system_type`                       INT(11),
	`company_name`                       VARCHAR(100),
	`system_type_and_model`                       VARCHAR(100),
	`system_status`                       VARCHAR(100),
	`enter_test_check_1`                       BIT,
	`enter_test_check_2`                       BIT,
	`enter_test_check_3`                       BIT,
	`enter_test_check_4`                       BIT,
	`enter_test_check_5`                       BIT,
	`enter_test_check_6`                       BIT,
	`enter_test_check_7`                       BIT,
	`enter_test_check_8`                       BIT,
	`enter_test_check_9`                       BIT,
	`enter_test_check_10`                       BIT,
	`enter_test_check_11`                       BIT,
	`enter_test_check_12`                       BIT,
	`enter_test_check_13`                       BIT,
	`enter_test_check_14`                       BIT,
	`enter_test_check_15`                       BIT,
	`enter_test_check_16`                       BIT,
	`enter_test_check_17`                       BIT,
	`enter_test_check_18`                       BIT,
	`enter_test_check_19`                       BIT,
	`enter_test_check_20`                       BIT,
	`enter_test_check_21`                       BIT,
	`enter_test_check_22`                       BIT,
	`enter_test_check_23`                       BIT,
	`enter_test_check_24`                       BIT,
	`enter_test_check_25`                       BIT,
	`enter_test_check_26`                       BIT,
	`enter_test_check_27`                       BIT,
	`enter_test_check_28`                       BIT,
	`enter_test_check_29`                       BIT,
	`enter_test_check_30`                       BIT,
	`enter_test_check_31`                       BIT,
	`enter_test_check_32`                       BIT,
	`enter_test_check_33`                       BIT,
	`enter_test_check_34`                       BIT,
	`enter_test_check_35`                       BIT,
	`enter_test_check_36`                       BIT,
	`enter_test_check_37`                       BIT,
	`enter_test_check_38`                       BIT,
	`enter_test_check_39`                       BIT,
	`enter_test_check_40`                       BIT,
	`enter_test_check_41`                       BIT,
	`enter_test_check_42`                       BIT,
	`enter_test_check_43`                       BIT,
	`enter_test_check_44`                       BIT,
	`enter_test_check_45`                       BIT,
	`enter_test_check_46_1`                       BIT,
	`enter_test_check_47_1`                       BIT,
	`enter_test_check_48_1`                       BIT,
	`enter_test_check_46_2`                       BIT,
	`enter_test_check_47_2`                       BIT,
	`enter_test_check_48_2`                       BIT,
	`enter_test_check_46_3`                       BIT,
	`enter_test_check_47_3`                       BIT,
	`enter_test_check_48_3`                       BIT,
	`test_amount_1`                       DECIMAL(11,2),
	`test_amount_2`                       DECIMAL(11,2),
	`test_amount_3`                       DECIMAL(11,2),
	`test_amount_4`                       DECIMAL(11,2),
	`test_amount_5`                       DECIMAL(11,2),
	`test_amount_6`                       DECIMAL(11,2),
	`test_amount_7`                       DECIMAL(11,2),
	`test_amount_8`                       DECIMAL(11,2),
	`test_amount_9`                       DECIMAL(11,2),
	`test_amount_10`                       DECIMAL(11,2),
	`test_amount_11`                       DECIMAL(11,2),
	`test_amount_12`                       DECIMAL(11,2),
	`test_amount_13`                       DECIMAL(11,2),
	`test_amount_14`                       DECIMAL(11,2),
	`test_amount_15`                       DECIMAL(11,2),
	`test_amount_16`                       DECIMAL(11,2),
	`test_amount_17`                       DECIMAL(11,2),
	`test_amount_18`                       DECIMAL(11,2),
	`test_amount_19`                       DECIMAL(11,2),
	`test_amount_20`                       DECIMAL(11,2),
	`test_amount_21`                       DECIMAL(11,2),
	`test_amount_22`                       DECIMAL(11,2),
	`test_amount_23`                       DECIMAL(11,2),
	`test_amount_24`                       DECIMAL(11,2),
	`test_amount_25`                       DECIMAL(11,2),
	`test_amount_26`                       DECIMAL(11,2),
	`test_amount_27`                       DECIMAL(11,2),
	`test_amount_28`                       DECIMAL(11,2),
	`test_amount_29`                       DECIMAL(11,2),
	`test_amount_30`                       DECIMAL(11,2),
	`test_amount_31`                       DECIMAL(11,2),
	`test_amount_32`                       DECIMAL(11,2),
	`test_amount_33`                       DECIMAL(11,2),
	`test_amount_34`                       DECIMAL(11,2),
	`test_amount_35`                       DECIMAL(11,2),
	`test_amount_36`                       DECIMAL(11,2),
	`test_amount_37`                       DECIMAL(11,2),
	`test_amount_38`                       DECIMAL(11,2),
	`test_amount_39`                       DECIMAL(11,2),
	`test_amount_40`                       DECIMAL(11,2),
	`test_amount_41`                       DECIMAL(11,2),
	`test_amount_42`                       DECIMAL(11,2),
	`test_amount_43`                       DECIMAL(11,2),
	`test_amount_44`                       DECIMAL(11,2),
	`test_amount_45`                       DECIMAL(11,2),
	`test_amount_46_1`                       DECIMAL(11,2),
	`test_amount_47_1`                       DECIMAL(11,2),
	`test_amount_48_1`                       DECIMAL(11,2),
	`test_amount_46_2`                       DECIMAL(11,2),
	`test_amount_47_2`                       DECIMAL(11,2),
	`test_amount_48_2`                       DECIMAL(11,2),
	`test_amount_46_3`                       DECIMAL(11,2),
	`test_amount_47_3`                       DECIMAL(11,2),
	`test_amount_48_3`                       DECIMAL(11,2),
	`notes`                       TEXT,
	`execution_date`                       DATE,
	`first_start_time`                       TIME,
	`first_end_time`                       TIME,
	`second_start_time`                       TIME,
	`second_end_time`                       TIME,
	`intervention_hours`                       VARCHAR(30),
	`trip_hours`                       DECIMAL(11,2),
	`total_hours`                       DECIMAL(11,2),
	`hourly_price`                       DECIMAL(11,2),
	`work_notes`                       VARCHAR(255),
	`trips_number`                       TINYINT,
	`trip_kms`                       SMALLINT,
	`total_kms`                       SMALLINT,
	`km_price`                       DECIMAL(11,2),
	`total_trips_price`                       DECIMAL(11,2),
	`total_hours_price`                       DECIMAL(11,2),
	`total_products_price`                       DECIMAL(11,2),
	`total_taxable_price`                       DECIMAL(11,2),
	`vat`                       DECIMAL(11,2),
	`total_price`                       DECIMAL(11,2),
	`insertion_user`                       SMALLINT,
	`insertion_employee`                       SMALLINT, 
	creation_timestamp DATETIME, 
	delivery_timestamp DATETIME,
	OUT Result INT
)
BEGIN

	
	IF(system_id>0) THEN 
	
		SELECT id_cliente
		INTO Result
		FROM Impianto 
		WHERE id_impianto = system_id; 

	
		IF(Result IS NULL) THEN 
			SET Result = -1; -- System not found
		ELSE
			IF(Result <> customer_id) THEN
				SET Result = -2;  -- not found link customer - system
			ELSE
				SET Result = 1; 
			END IF; 
		END IF; 
		
		
	ELSE
	
		SELECT id_cliente
		INTO Result
		FROM Clienti 
		WHERE Id_cliente = customer_id; 
		
		IF Result IS NULL THEN
			SET Result = -3; -- customer not found
		END IF;
		
	END IF; 
	
	IF Result IS NULL OR Result >= 0 THEN 
	
		SET Result = 1; 
			
		INSERT INTO rapporto_mobile_collaudo SET 
			`Id_rapporto`=`report_id`,
			`Anno`=`report_year`,
			`Id_cliente`=`customer_id`,
			`Id_impianto`=`system_id`,
			`Indirizzo`=`address`,
			`Telefono`=`telephone_number`,
			`Fax`=`fax_number`,
			`Partita_iva_cod_fisc`=`tax_fiscal_code`,
			`Richiedente_intervento`=`request_from`,
			`Email`=`email`,
			`Email_responsabile`=`email_responsible`,
			`Data`=`enter_date`,
			`Descrizione_veicolo`=`vehicle_description`,
			`Tipo_intervento`=`ref_intervention_type`,
			`Tipo_impianto`=`ref_system_type`,
			`Ragione_sociale`=`company_name`,
			`Tipo_modello_impianto`=`system_type_and_model`,
			`Stato_impianto`=`system_status`,
			`Test_check_1`=`enter_test_check_1`,
			`Test_check_2`=`enter_test_check_2`,
			`Test_check_3`=`enter_test_check_3`,
			`Test_check_4`=`enter_test_check_4`,
			`Test_check_5`=`enter_test_check_5`,
			`Test_check_6`=`enter_test_check_6`,
			`Test_check_7`=`enter_test_check_7`,
			`Test_check_8`=`enter_test_check_8`,
			`Test_check_9`=`enter_test_check_9`,
			`Test_check_10`=`enter_test_check_10`,
			`Test_check_11`=`enter_test_check_11`,
			`Test_check_12`=`enter_test_check_12`,
			`Test_check_13`=`enter_test_check_13`,
			`Test_check_14`=`enter_test_check_14`,
			`Test_check_15`=`enter_test_check_15`,
			`Test_check_16`=`enter_test_check_16`,
			`Test_check_17`=`enter_test_check_17`,
			`Test_check_18`=`enter_test_check_18`,
			`Test_check_19`=`enter_test_check_19`,
			`Test_check_20`=`enter_test_check_20`,
			`Test_check_21`=`enter_test_check_21`,
			`Test_check_22`=`enter_test_check_22`,
			`Test_check_23`=`enter_test_check_23`,
			`Test_check_24`=`enter_test_check_24`,
			`Test_check_25`=`enter_test_check_25`,
			`Test_check_26`=`enter_test_check_26`,
			`Test_check_27`=`enter_test_check_27`,
			`Test_check_28`=`enter_test_check_28`,
			`Test_check_29`=`enter_test_check_29`,
			`Test_check_30`=`enter_test_check_30`,
			`Test_check_31`=`enter_test_check_31`,
			`Test_check_32`=`enter_test_check_32`,
			`Test_check_33`=`enter_test_check_33`,
			`Test_check_34`=`enter_test_check_34`,
			`Test_check_35`=`enter_test_check_35`,
			`Test_check_36`=`enter_test_check_36`,
			`Test_check_37`=`enter_test_check_37`,
			`Test_check_38`=`enter_test_check_38`,
			`Test_check_39`=`enter_test_check_39`,
			`Test_check_40`=`enter_test_check_40`,
			`Test_check_41`=`enter_test_check_41`,
			`Test_check_42`=`enter_test_check_42`,
			`Test_check_43`=`enter_test_check_43`,
			`Test_check_44`=`enter_test_check_44`,
			`Test_check_45`=`enter_test_check_45`,
			`Test_check_46_1`=`enter_test_check_46_1`,
			`Test_check_47_1`=`enter_test_check_47_1`,
			`Test_check_48_1`=`enter_test_check_48_1`,
			`Test_check_46_2`=`enter_test_check_46_2`,
			`Test_check_47_2`=`enter_test_check_47_2`,
			`Test_check_48_2`=`enter_test_check_48_2`,
			`Test_check_46_3`=`enter_test_check_46_3`,
			`Test_check_47_3`=`enter_test_check_47_3`,
			`Test_check_48_3`=`enter_test_check_48_3`,
			`Test_quantita_1`=`test_amount_1`,
			`Test_quantita_2`=`test_amount_2`,
			`Test_quantita_3`=`test_amount_3`,
			`Test_quantita_4`=`test_amount_4`,
			`Test_quantita_5`=`test_amount_5`,
			`Test_quantita_6`=`test_amount_6`,
			`Test_quantita_7`=`test_amount_7`,
			`Test_quantita_8`=`test_amount_8`,
			`Test_quantita_9`=`test_amount_9`,
			`Test_quantita_10`=`test_amount_10`,
			`Test_quantita_11`=`test_amount_11`,
			`Test_quantita_12`=`test_amount_12`,
			`Test_quantita_13`=`test_amount_13`,
			`Test_quantita_14`=`test_amount_14`,
			`Test_quantita_15`=`test_amount_15`,
			`Test_quantita_16`=`test_amount_16`,
			`Test_quantita_17`=`test_amount_17`,
			`Test_quantita_18`=`test_amount_18`,
			`Test_quantita_19`=`test_amount_19`,
			`Test_quantita_20`=`test_amount_20`,
			`Test_quantita_21`=`test_amount_21`,
			`Test_quantita_22`=`test_amount_22`,
			`Test_quantita_23`=`test_amount_23`,
			`Test_quantita_24`=`test_amount_24`,
			`Test_quantita_25`=`test_amount_25`,
			`Test_quantita_26`=`test_amount_26`,
			`Test_quantita_27`=`test_amount_27`,
			`Test_quantita_28`=`test_amount_28`,
			`Test_quantita_29`=`test_amount_29`,
			`Test_quantita_30`=`test_amount_30`,
			`Test_quantita_31`=`test_amount_31`,
			`Test_quantita_32`=`test_amount_32`,
			`Test_quantita_33`=`test_amount_33`,
			`Test_quantita_34`=`test_amount_34`,
			`Test_quantita_35`=`test_amount_35`,
			`Test_quantita_36`=`test_amount_36`,
			`Test_quantita_37`=`test_amount_37`,
			`Test_quantita_38`=`test_amount_38`,
			`Test_quantita_39`=`test_amount_39`,
			`Test_quantita_40`=`test_amount_40`,
			`Test_quantita_41`=`test_amount_41`,
			`Test_quantita_42`=`test_amount_42`,
			`Test_quantita_43`=`test_amount_43`,
			`Test_quantita_44`=`test_amount_44`,
			`Test_quantita_45`=`test_amount_45`,
			`Test_quantita_46_1`=`test_amount_46_1`,
			`Test_quantita_47_1`=`test_amount_47_1`,
			`Test_quantita_48_1`=`test_amount_48_1`,
			`Test_quantita_46_2`=`test_amount_46_2`,
			`Test_quantita_47_2`=`test_amount_47_2`,
			`Test_quantita_48_2`=`test_amount_48_2`,
			`Test_quantita_46_3`=`test_amount_46_3`,
			`Test_quantita_47_3`=`test_amount_47_3`,
			`Test_quantita_48_3`=`test_amount_48_3`,
			`Note`=`notes`,
			`Data_intervento`=`execution_date`,
			`Ora_inizio_intervento_1`=`first_start_time`,
			`Ora_fine_intervento_1`=`first_end_time`,
			`Ora_inizio_intervento_2`=`second_start_time`,
			`Ora_fine_intervento_2`=`second_end_time`,
			`Ore_intervento`=`intervention_hours`,
			`Ore_Viaggio`=`trip_hours`,
			`Ore_totali`=`total_hours`,
			`Prezzo_ora`=`hourly_price`,
			`Note_viaggio`=`work_notes`,
			`Numero_viaggi`=`trips_number`,
			`Km_percorsi`=`trip_kms`,
			`Km_complessivi`=`total_kms`,
			`Prezzo_km`=`km_price`,
			`Totale_prezzo_viaggio`=`total_trips_price`,
			`Totale_prezzo_orario`=`total_hours_price`,
			`Totale_prezzo_materiale`=`total_products_price`,
			`Imponibile`=`total_taxable_price`,
			`Iva`=`vat`,
			`Totale_prezzo`=`total_price`,
			`Utente_inserimento`=`insertion_user`,
			`Operaio_inserimento`=`insertion_employee`, 
			timestamp_creazione = creation_timestamp,
			timestamp_invio = delivery_timestamp;
	END IF;
	 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiReportMobileTestSaveSignaturesRefs
DELIMITER //
CREATE PROCEDURE `sp_apiReportMobileTestSaveSignaturesRefs`(
	report_id INT(11),
	report_year INT(11),
	customer_filename VARCHAR(50), 
	technician_filename VARCHAR(50)
)
BEGIN

	UPDATE rapporto_mobile_collaudo
	SET 
		`filename_firma_cliente`                       = customer_filename,
		`filename_firma_tecnico`                       = technician_filename
	WHERE Id_rapporto = report_id AND Anno = report_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiServiceAlertConfigurationGetById
DELIMITER //
CREATE PROCEDURE `sp_apiServiceAlertConfigurationGetById`(
	IN service_id INT(11)
)
BEGIN
	SELECT `Id`,
		`Nome`,
		`Cartella`,
		`Tipo_intervallo`,
		`Valore`,
		Oggetto_email, 
		Corpo_email,
		Data_ultima_esecuzione,
		`Data_mod`,
		`Utente_mod`
	FROM servizio_alert_configurazione
	WHERE Id = service_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiServiceAlertExecutionInsert
DELIMITER //
CREATE PROCEDURE `sp_apiServiceAlertExecutionInsert`(
	`service_id`                       INT(11),
	`exec_date`                       DATETIME,
	`filename`                       VARCHAR(50),
	`error` MEDIUMTEXT
)
BEGIN
	INSERT INTO servizio_alert_esecuzione 
	SET Id_servizio = service_id, 
		data_esecuzione = exec_date,
		Filename = filename,
		Errore = error;
		
	IF (error IS NULL OR error = '') THEN
		UPDATE servizio_alert_configurazione 
		SET Data_ultima_esecuzione = NOW()
		WHERE Id = service_id;
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiServiceAlertGeneralConfigurationGetLast
DELIMITER //
CREATE PROCEDURE `sp_apiServiceAlertGeneralConfigurationGetLast`(
)
BEGIN
	SELECT
		`Id`,
		`Email_host`,
		`Email_username`,
		`Email_password`,
		`Email_port`,
		`Email_ssl`,
		Email_from,
		`Data_ins`,
		`Utente_ins`
	FROM servizio_alert_configurazione_generale
	ORDER BY Id DESC
	LIMIT 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiServiceAlertRecipientGetByService
DELIMITER //
CREATE PROCEDURE `sp_apiServiceAlertRecipientGetByService`(
	IN service_id INT(11)
)
BEGIN
	SELECT
		`Id`,
		`Id_servizio`,
		`Email`,
		`Data_ins`,
		`Utente_ins`                       
	FROM servizio_alert_ricevente
	WHERE Id_servizio = service_id
	ORDER BY Email;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSubscriptionGet
DELIMITER //
CREATE PROCEDURE `sp_apiSubscriptionGet`(
start_date DATETIME
)
BEGIN
	SELECT 
		Id_abbonamento,
		Anno, 
		Nome, 
		Descrizione, 
		Generale
	FROM  Abbonamento; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSupervisionGet
DELIMITER //
CREATE PROCEDURE `sp_apiSupervisionGet`()
BEGIN
	SELECT Id_vigilante,
	IFNULL(tipo, 0) AS Tipo, 
	IFNULL(Descrizione, "") AS Descrizione,
	IFNULL(telefono, "") AS Telefono, 
	IFNULL(altro_telefono, "") AS Altro_telefono,
	IFNULL(cellulare, "") Cellulare, 
	IFNULL(mail,"") Email
	FROM vigilante;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSupervisionTypeGet
DELIMITER //
CREATE PROCEDURE `sp_apiSupervisionTypeGet`()
BEGIN
	SELECT Id_tipo, 
	Nome 
	FROM tipo_vigilante;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSupplierContactGetBySupplier
DELIMITER //
CREATE PROCEDURE `sp_apiSupplierContactGetBySupplier`(
	IN supplier_id INT(11)
)
BEGIN
	SELECT 
		`Id_fornitore`,
		Id_pubblico,
		`Id_riferimento`,
		`Nome`,
		`figura`,
		`Telefono`,
		`altro_telefono`,
		`telefono2`,
		`fax`,
		`mail`,
		`centralino`,
		`fatturazione`,
		`nota`,
		`titolo`,
		`esterno`,
		`sito`,
		`skype`,
		`rif_esterno`,
		`sito_utente`,
		`sito_passwd`,
		`mail_pec`
	FROM riferimento_fornitore 
	WHERE riferimento_fornitore.id_fornitore = supplier_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSupplierDestinationGetBySupplier
DELIMITER //
CREATE PROCEDURE `sp_apiSupplierDestinationGetBySupplier`(
	IN supplier_id INT(11)
)
BEGIN
	SELECT 
		`id_fornitore`,
		`Id_destinazione`,
		comune.Id_provincia,
		comune.Provincia,
		comune.id_comune,
		comune.nome AS 'bomune',
		comune.cap AS 'cap',
		Frazione.Id_frazione,
		Frazione.nome AS 'frazione',
		`Indirizzo`,
		`numero_civico`,
		`Descrizione`,
		`scala`,
		`Altro`,
		`attivo`,
		`Note`,
		`Sede_principale`,
		`piano`,
		`interno`,
		`fcap`,
		`id_autostrada`
	FROM destinazione_fornitore 
		LEFT JOIN comune ON comune.id_comune = destinazione_fornitore.comune
		LEFT JOIN frazione ON frazione.id_frazione = destinazione_fornitore.Frazione
	WHERE destinazione_fornitore.id_fornitore = supplier_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSupplierGetById
DELIMITER //
CREATE PROCEDURE `sp_apiSupplierGetById`(
	IN supplier_id INT(11)
)
BEGIN
	SELECT 
		`Id_fornitore`,
		`Ragione_Sociale`,
		`Ragione_Sociale2`,
		`Partita_iva`,
		`Codice_Fiscale`,
		`Data_inserimento`,
		stato_fornitore.id_stato, 
		stato_fornitore.nome AS 'Stato', 
		stato_economico.id_stato AS 'Id_stato_economico',
		stato_economico.nome, 
		condizione_pagamento.id_condizione,
		condizione_pagamento.nome as condizione_pagamento,
		`Sito_internet`,
		`password`,
		`Utente_sito`,
		tipo_iva.Id_iva,
		tipo_iva.nome as 'iva',
		tipo_fornitore.Id_tipo AS 'Id_tipo_fornitore',
		tipo_fornitore.nome as 'Tipo_fornitore',
		`modi`,
		`id_tiporapp`,
		Fornitore.`id_utente`,
		`costruttore`,
		`id_attività`                       as 'id_attivita',
		tipo_attivita.nome AS 'attivita',
		`cod_fornitore`
	FROM fornitore 
		INNER JOIN stato_fornitore ON stato_fornitore.id_stato = fornitore.stato_fornitore
		LEFT JOIN tipo_attivita ON tipo_attivita.id_tipo = fornitore.id_attività
		LEFT JOIN stato_economico ON stato_economico.id_stato = fornitore.stato_economico
		LEFT JOIN condizione_pagamento ON condizione_pagamento.id_condizione = fornitore.condizione_pagamento
		LEFT JOIN tipo_iva ON tipo_iva.Id_iva = fornitore.iva
		LEFT JOIN tipo_fornitore ON tipo_fornitore.Id_tipo = fornitore.tipo_fornitore
	WHERE fornitore.id_fornitore = supplier_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSupplierGetByIds
DELIMITER //
CREATE PROCEDURE `sp_apiSupplierGetByIds`(
	IN supplier_ids MEDIUMTEXT
)
BEGIN


	SELECT DISTINCT
		`Id_fornitore`,
		`Ragione_Sociale`,
		`Ragione_Sociale2`,
		`Partita_iva`,
		`Codice_Fiscale`,
		`Data_inserimento`,
		stato_fornitore.id_stato, 
		stato_fornitore.nome AS 'Stato', 
		stato_economico.id_stato AS 'Id_stato_economico',
		stato_economico.nome, 
		condizione_pagamento.id_condizione,
		condizione_pagamento.nome as condizione_pagamento,
		`Sito_internet`,
		`password`,
		`Utente_sito`,
		tipo_iva.Id_iva,
		tipo_iva.nome as 'iva',
		tipo_fornitore.Id_tipo AS 'Id_tipo_fornitore',
		tipo_fornitore.nome as 'Tipo_fornitore',
		`modi`,
		`id_tiporapp`,
		Fornitore.`id_utente`,
		`costruttore`,
		`id_attività`                       as 'id_attivita',
		tipo_attivita.nome AS 'attivita',
		`cod_fornitore`
	FROM fornitore 
		INNER JOIN stato_fornitore ON stato_fornitore.id_stato = fornitore.stato_fornitore
		LEFT JOIN tipo_attivita ON tipo_attivita.id_tipo = fornitore.id_attività
		LEFT JOIN stato_economico ON stato_economico.id_stato = fornitore.stato_economico
		LEFT JOIN condizione_pagamento ON condizione_pagamento.id_condizione = fornitore.condizione_pagamento
		LEFT JOIN tipo_iva ON tipo_iva.Id_iva = fornitore.iva
		LEFT JOIN tipo_fornitore ON tipo_fornitore.Id_tipo = fornitore.tipo_fornitore
	WHERE FIND_IN_SET(fornitore.id_fornitore, supplier_ids);
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemComponentsUpdateReminderStatus
DELIMITER //
CREATE PROCEDURE `sp_apiSystemComponentsUpdateReminderStatus`(
	IN system_id INT,
	IN product_code VARCHAR(50),
	IN expiration_date DATE,
	IN status_ref varchar(50)
	)
BEGIN
	DECLARE new_status_id INT;

	SELECT id
	INTO new_status_id
	FROM stato_promemoria_cliente
	WHERE rif_applicazioni = status_ref;

	UPDATE impianto_componenti 
	SET id_stato_promemoria = new_status_id,
		data_ultimo_promemoria = NOW()
	WHERE Data_scadenza = expiration_date
		AND id_impianto = system_id
		AND id_articolo = product_code;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemGet`()
BEGIN
	SELECT `impianto`.`Id_impianto`                       AS `id_impianto`,
		`impianto`.`Id_cliente`                       AS `id_cliente`,
		IFNULL(`impianto`.`Abbonamento`,0) AS `id_abbonamento`, 
		impianto.Destinazione AS Id_destinazione, 
		IFNULL(`impianto`.`Data_Funzione`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `data_funzione`, 
		IFNULL(`impianto`.`scadenza_garanzia`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `Scadenza_Garanzia`,
		`impianto`.`Tipo_impianto` AS `tipo_impianto`,
		`tipo_impianto`.`Nome` AS `tipo_impianto_descrizione`,
		`impianto`.`Stato` AS `stato`,
		`stato_impianto`.`Nome` AS `stato_descrizione`,
		`impianto`.`Descrizione`                       AS `descrizione`, 
		IFNULL(`impianto`.`centrale`,'') AS `centrale`, 
		IFNULL(`impianto`.`gsm`,'') AS `gsm`, 
		IFNULL(`impianto`.`combinatore_telefonico`,'') AS `combinatore_telefonico`,
		`impianto`.`orario_prog`                       AS `orario_prog`, 
		checklist_model_impianto.id_checklist,
		abbonamento.nome as "abbonamento",
		impianto.id_stato_promemoria_garanzia,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria_garanzia
	FROM impianto
		INNER JOIN stato_promemoria_cliente ON impianto.id_stato_promemoria_garanzia = stato_promemoria_cliente.id
		INNER JOIN tipo_impianto ON id_tipo = Tipo_impianto
		INNER JOIN stato_impianto ON id_stato = Stato
		LEFT JOIN abbonamento ON impianto.abbonamento = abbonamento.id_abbonamento
		LEFT JOIN checklist_model_impianto ON impianto.id_impianto = checklist_model_impianto.id_impianto
	WHERE ((`impianto`.`Stato`                       < 4) OR (`impianto`.`Stato`                       > 7))
	GROUP BY `impianto`.`Id_impianto`;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemGetBetweenWarrantyDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemGetBetweenWarrantyDates`(
	from_date DATE,
	to_date DATE
)
BEGIN
	SELECT `impianto`.`Id_impianto`,
		`impianto`.`Id_cliente`                       AS `id_cliente`,
		IFNULL(`impianto`.`Abbonamento`,0) AS `id_abbonamento`, 
		impianto.Destinazione AS Id_destinazione, 
		IFNULL(`impianto`.`Data_Funzione`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `data_funzione`, 
		IFNULL(`impianto`.`scadenza_garanzia`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `Scadenza_Garanzia`,
		`impianto`.`Tipo_impianto` AS `tipo_impianto`,
		`tipo_impianto`.`Nome` AS `tipo_impianto_descrizione`,
		`impianto`.`Stato` AS `stato`,
		`stato_impianto`.`Nome` AS `stato_descrizione`,
		`impianto`.`Descrizione`                       AS `descrizione`, 
		IFNULL(`impianto`.`centrale`,'') AS `centrale`, 
		IFNULL(`impianto`.`gsm`,'') AS `gsm`, 
		IFNULL(`impianto`.`combinatore_telefonico`,'') AS `combinatore_telefonico`,
		`impianto`.`orario_prog`                       AS `orario_prog`, 
			checklist_model_impianto.id_checklist,
		abbonamento.nome as "abbonamento",
		impianto.id_stato_promemoria_garanzia,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria_garanzia
	FROM impianto
		INNER JOIN stato_promemoria_cliente ON impianto.id_stato_promemoria_garanzia = stato_promemoria_cliente.id
		INNER JOIN tipo_impianto ON id_tipo = Tipo_impianto
		INNER JOIN stato_impianto ON id_stato = Stato
		LEFT JOIN checklist_model_impianto ON impianto.id_impianto = checklist_model_impianto.id_impianto
		LEFT JOIN abbonamento ON impianto.abbonamento = abbonamento.id_abbonamento
	WHERE scadenza_garanzia BETWEEN from_date AND to_date;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemGetBetweenWarrantyReminderDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemGetBetweenWarrantyReminderDates`(
	from_date DATE,
	to_date DATE
)
BEGIN
	SELECT `impianto`.`Id_impianto`,
		`impianto`.`Id_cliente`                       AS `id_cliente`,
		IFNULL(`impianto`.`Abbonamento`,0) AS `id_abbonamento`, 
		impianto.Destinazione AS Id_destinazione, 
		IFNULL(`impianto`.`Data_Funzione`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `data_funzione`, 
		IFNULL(`impianto`.`scadenza_garanzia`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `Scadenza_Garanzia`,
		`impianto`.`Tipo_impianto` AS `tipo_impianto`,
		`tipo_impianto`.`Nome` AS `tipo_impianto_descrizione`,
		`impianto`.`Stato` AS `stato`,
		`stato_impianto`.`Nome` AS `stato_descrizione`,
		`impianto`.`Descrizione`                       AS `descrizione`, 
		IFNULL(`impianto`.`centrale`,'') AS `centrale`, 
		IFNULL(`impianto`.`gsm`,'') AS `gsm`, 
		IFNULL(`impianto`.`combinatore_telefonico`,'') AS `combinatore_telefonico`,
		`impianto`.`orario_prog`                       AS `orario_prog`, 
			checklist_model_impianto.id_checklist,
		abbonamento.nome as "abbonamento",
		impianto.id_stato_promemoria_garanzia,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria_garanzia
	FROM impianto
		INNER JOIN stato_promemoria_cliente ON impianto.id_stato_promemoria_garanzia = stato_promemoria_cliente.id
		INNER JOIN tipo_impianto ON id_tipo = Tipo_impianto
		INNER JOIN stato_impianto ON id_stato = Stato
		LEFT JOIN checklist_model_impianto ON impianto.id_impianto = checklist_model_impianto.id_impianto
		LEFT JOIN abbonamento ON impianto.abbonamento = abbonamento.id_abbonamento
	WHERE data_promemoria_garanzia BETWEEN from_date AND to_date;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemGetByDistance
DELIMITER //
CREATE PROCEDURE `sp_apiSystemGetByDistance`(
	IN latitude DECIMAL(11,8),
	IN longitude DECIMAL(11,8),
	IN distance DECIMAL(8,2)
)
BEGIN 

	SELECT * 
	FROM (
		SELECT 
			`impianto`.`Id_impianto`                       AS `id_impianto`,
			`impianto`.`Id_cliente`                       AS `id_cliente`,
			IFNULL(`impianto`.`Abbonamento`,0) AS `id_abbonamento`, 
			impianto.Destinazione AS Id_destinazione, 
			IFNULL(`impianto`.`Data_Funzione`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `data_funzione`, 
			IFNULL(`impianto`.`scadenza_garanzia`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `Scadenza_Garanzia`,
			`impianto`.`Tipo_impianto` AS `tipo_impianto`,
			`tipo_impianto`.`Nome` AS `tipo_impianto_descrizione`,
			`impianto`.`Stato` AS `stato`,
			`stato_impianto`.`Nome` AS `stato_descrizione`,
			`impianto`.`Descrizione`                       AS `descrizione`, 
			IFNULL(`impianto`.`centrale`,'') AS `centrale`, 
			IFNULL(`impianto`.`gsm`,'') AS `gsm`, 
			IFNULL(`impianto`.`combinatore_telefonico`,'') AS `combinatore_telefonico`,
			`impianto`.`orario_prog`                       AS `orario_prog`,
			destinazione_cliente.latitudine,
			destinazione_cliente.longitudine,
			111.1111 *
    		DEGREES(ACOS(COS(RADIANS(latitude))
			 * COS(RADIANS(destinazione_cliente.latitudine))
			 * COS(RADIANS(longitude - destinazione_cliente.longitudine))
			 + SIN(RADIANS(latitude))
			 * SIN(RADIANS(destinazione_cliente.latitudine)))) AS distanza,
			abbonamento.nome as "abbonamento",
			impianto.id_stato_promemoria_garanzia,
			stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria_garanzia
		FROM impianto
			INNER JOIN stato_promemoria_cliente ON impianto.id_stato_promemoria_garanzia = stato_promemoria_cliente.id
			INNER JOIN tipo_impianto ON id_tipo = Tipo_impianto
			INNER JOIN stato_impianto ON id_stato = Stato
			LEFT JOIN abbonamento ON impianto.abbonamento = abbonamento.id_abbonamento
			INNER JOIN destinazione_cliente ON impianto.Id_cliente = destinazione_cliente.id_cliente AND impianto.Destinazione = destinazione_cliente.Id_destinazione
		WHERE ((`impianto`.`Stato`                       < 4) OR (`impianto`.`Stato`                       > 7)) AND destinazione_cliente.latitudine IS NOT NULL AND destinazione_cliente.latitudine > 0
	) AS result
	WHERE distanza <= distance;
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemGetById
DELIMITER //
CREATE PROCEDURE `sp_apiSystemGetById`(id INT)
BEGIN
	SELECT `impianto`.`Id_impianto`                       AS `id_impianto`,
		`impianto`.`Id_cliente`                       AS `id_cliente`,
		IFNULL(`impianto`.`Abbonamento`,0) AS `id_abbonamento`, 
		impianto.Destinazione AS Id_destinazione, 
		IFNULL(`impianto`.`Data_Funzione`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `data_funzione`, 
		IFNULL(`impianto`.`scadenza_garanzia`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `Scadenza_Garanzia`,
		`impianto`.`Tipo_impianto` AS `tipo_impianto`,
		`tipo_impianto`.`Nome` AS `tipo_impianto_descrizione`,
		`impianto`.`Stato` AS `stato`,
		`stato_impianto`.`Nome` AS `stato_descrizione`,
		`impianto`.`Descrizione`                       AS `descrizione`, 
		IFNULL(`impianto`.`centrale`,'') AS `centrale`, 
		IFNULL(`impianto`.`gsm`,'') AS `gsm`, 
		IFNULL(`impianto`.`combinatore_telefonico`,'') AS `combinatore_telefonico`,
		`impianto`.`orario_prog`                       AS `orario_prog`, 
			checklist_model_impianto.id_checklist,
		abbonamento.nome as "abbonamento",
		impianto.id_stato_promemoria_garanzia,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria_garanzia
	FROM impianto
		INNER JOIN stato_promemoria_cliente ON impianto.id_stato_promemoria_garanzia = stato_promemoria_cliente.id
		INNER JOIN tipo_impianto ON id_tipo = Tipo_impianto
		INNER JOIN stato_impianto ON id_stato = Stato
		LEFT JOIN checklist_model_impianto ON impianto.id_impianto = checklist_model_impianto.id_impianto
		LEFT JOIN abbonamento ON impianto.abbonamento = abbonamento.id_abbonamento
	WHERE impianto.id_impianto = id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemGetByIds
DELIMITER //
CREATE PROCEDURE `sp_apiSystemGetByIds`(
	IN system_ids MEDIUMTEXT
)
BEGIN
	SELECT `impianto`.`Id_impianto`                       AS `id_impianto`,
		`impianto`.`Id_cliente`                       AS `id_cliente`,
		IFNULL(`impianto`.`Abbonamento`,0) AS `id_abbonamento`, 
		impianto.Destinazione AS Id_destinazione, 
		IFNULL(`impianto`.`Data_Funzione`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `data_funzione`, 
		IFNULL(`impianto`.`scadenza_garanzia`, CAST('0000-00-00 00:00:00' AS DATETIME)) AS `Scadenza_Garanzia`,
		`impianto`.`Tipo_impianto` AS `tipo_impianto`,
		`tipo_impianto`.`Nome` AS `tipo_impianto_descrizione`,
		`impianto`.`Stato` AS `stato`,
		`stato_impianto`.`Nome` AS `stato_descrizione`,
		`impianto`.`Descrizione`                       AS `descrizione`, 
		IFNULL(`impianto`.`centrale`,'') AS `centrale`, 
		IFNULL(`impianto`.`gsm`,'') AS `gsm`, 
		IFNULL(`impianto`.`combinatore_telefonico`,'') AS `combinatore_telefonico`,
		`impianto`.`orario_prog`                       AS `orario_prog`, 
		checklist_model_impianto.id_checklist,
		abbonamento.nome as "abbonamento",
		impianto.id_stato_promemoria_garanzia,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria_garanzia
	FROM impianto
		INNER JOIN stato_promemoria_cliente ON impianto.id_stato_promemoria_garanzia = stato_promemoria_cliente.id
		INNER JOIN tipo_impianto ON id_tipo = Tipo_impianto
		INNER JOIN stato_impianto ON id_stato = Stato
		LEFT JOIN checklist_model_impianto ON impianto.id_impianto = checklist_model_impianto.id_impianto
		LEFT JOIN abbonamento ON impianto.abbonamento = abbonamento.id_abbonamento
	WHERE FIND_IN_SET(`impianto`.`Id_impianto`, system_ids);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemNoteGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemNoteGet`()
BEGIN
	SELECT  impianto_note.Id_impianto, 
		impianto_note.Id_nota, 
		impianto_note_descrizione.Nome, 
		impianto_note.Testo 
	FROM impianto_note
		INNER JOIN impianto_note_descrizione ON impianto_note.id_nota = impianto_note_descrizione.id_descrizione; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemNoteInsert
DELIMITER //
CREATE PROCEDURE `sp_apiSystemNoteInsert`(
	IN system_id INT(11), 
	IN note_id INT(11),
	IN name VARCHAR(100),
	IN description TEXT, 
	OUT result SMALLINT
)
BEGIN
	DECLARE note_name VARCHAR(45);
	DECLARE note_occurance SMALLINT;
	DECLARE has_already_note BIT; 
	SET Result = 1;
	
	SELECT id_descrizione, Nome
		INTO note_id, note_name
	FROM impianto_note_descrizione
	WHERE impianto_note_descrizione.nome = name; 
	-- check if note description is already present
	if note_name IS NULL THEN
		INSERT INTO impianto_note_descrizione (nome) VALUES (name); 
		SELECT LAST_INSERT_ID() INTO note_id;
	ELSE
	
		SELECT 
			COUNT(*) > 0 
		INTO 
			has_already_note 
		FROM impianto_note 
		WHERE id_nota = note_id AND id_impianto = system_id;
		
		IF has_already_note THEN
			SET note_name = CONCAT(note_name, ' - ', UNIX_TIMESTAMP());
			
			INSERT INTO impianto_note_descrizione (nome) VALUES (note_name); 
			SELECT LAST_INSERT_ID() INTO note_id;
			
		END IF;  
	
	END IF;
	
	
	
	INSERT INTO impianto_note (id_impianto, id_nota, Testo)
	VALUES (system_id, note_id, description); 

	SELECT 
		impianto_note.Id_impianto,
		impianto_note.Id_nota, 
		impianto_note_descrizione.Nome, 
		impianto_note.Testo 
	FROM impianto_note
		INNER JOIN impianto_note_descrizione ON impianto_note.id_nota = impianto_note_descrizione.id_descrizione
	WHERE impianto_note.Id_impianto = system_id AND impianto_note.id_nota = note_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemNoteTypeGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemNoteTypeGet`()
BEGIN
	SELECT impianto_note_descrizione.Id_descrizione, 
		Nome
	FROM impianto_note_descrizione;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemOperationGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemOperationGet`(
)
BEGIN

	SELECT 
		impianto_operazione.Id_impianto,
		impianto_operazione.Id_operazione, 
		operazioni_articoli.Nome, 
		impianto_operazione.Descrizione 
	FROM impianto_operazione
		INNER JOIN operazioni_articoli ON impianto_operazione.id_operazione = operazioni_articoli.Id_operazione;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemOperationInsert
DELIMITER //
CREATE PROCEDURE `sp_apiSystemOperationInsert`(
	IN system_id INT(11), 
	IN operation_id INT(11), 
	IN name VARCHAR(100), 
	IN description TEXT, 
	OUT result SMALLINT
)
BEGIN
	
	DECLARE operation_name VARCHAR(45);
	DECLARE has_already_operation BIT; 
	SET Result = 1;
	
	SELECT id_operazione, Nome
		INTO operation_id, operation_name
	FROM operazioni_articoli
	WHERE operazioni_articoli.nome = name; 
	
	if operation_name IS NULL THEN
		INSERT INTO operazioni_articoli (nome, descrizione) VALUES (name, description); 
		SELECT LAST_INSERT_ID() INTO operation_id;
	ELSE
	
		SELECT 
			COUNT(*) > 0 
		INTO 
			has_already_operation
		FROM impianto_operazione 
		WHERE id_operazione = operation_id AND id_impianto = system_id;
		
		IF has_already_operation THEN
			SET operation_name = CONCAT(operation_name, ' - ', UNIX_TIMESTAMP());
				
			INSERT INTO operazioni_articoli (nome, descrizione) VALUES (operation_name, description); 
			SELECT LAST_INSERT_ID() INTO operation_id;
		END IF;  
	
	END IF;
	
	INSERT INTO impianto_operazione (id_impianto, id_operazione, descrizione)
	VALUES (system_id, operation_id, description); 

	SELECT 
		impianto_operazione.Id_impianto,
		impianto_operazione.Id_operazione, 
		operazioni_articoli.Nome, 
		impianto_operazione.Descrizione 
	FROM impianto_operazione
		INNER JOIN operazioni_articoli ON impianto_operazione.id_operazione = operazioni_articoli.Id_operazione
	WHERE impianto_operazione.Id_impianto = system_id AND impianto_operazione.id_operazione = operation_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemPeriodicCheckGetBetweenExpectedExecutionDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemPeriodicCheckGetBetweenExpectedExecutionDates`(
	from_date DATE,
	to_date DATE
)
BEGIN
	SELECT impianto_abbonamenti_mesi.Id, 
		impianto AS Id_impianto, 
		mese,
		anno,
		abbonamenti AS Id_abbonamento, 
		da_eseguire, 
		eseguito_il, 
		prezzo,
		impianto_abbonamenti_mesi.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_abbonamenti_mesi
		INNER JOIN stato_promemoria_cliente ON impianto_abbonamenti_mesi.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE da_eseguire BETWEEN from_date AND to_date
	ORDER BY da_eseguire;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemPeriodicCheckGetBetweenReminderDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemPeriodicCheckGetBetweenReminderDates`(
	from_date DATE,
	to_date DATE
)
BEGIN
	SELECT impianto_abbonamenti_mesi.Id, 
		impianto AS Id_impianto, 
		mese,
		anno,
		abbonamenti AS Id_abbonamento, 
		da_eseguire, 
		eseguito_il, 
		prezzo,
		impianto_abbonamenti_mesi.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_abbonamenti_mesi
		INNER JOIN stato_promemoria_cliente ON impianto_abbonamenti_mesi.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE data_promemoria BETWEEN from_date AND to_date
	ORDER BY data_promemoria;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemPeriodicCheckGetNextBySystems
DELIMITER //
CREATE PROCEDURE `sp_apiSystemPeriodicCheckGetNextBySystems`(
	IN system_ids MEDIUMTEXT 
)
BEGIN

	SELECT * 
	FROM
	(
		SELECT impianto_abbonamenti_mesi.Id, 
			impianto AS Id_impianto, 
			mese,
			anno,
			abbonamenti AS Id_abbonamento, 
			da_eseguire, 
			eseguito_il, 
			prezzo,
			impianto_abbonamenti_mesi.id_stato_promemoria,
			stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
		FROM impianto_abbonamenti_mesi
			INNER JOIN stato_promemoria_cliente ON impianto_abbonamenti_mesi.id_stato_promemoria = stato_promemoria_cliente.id
		WHERE Eseguito_il IS NULL AND FIND_IN_SET(`impianto_abbonamenti_mesi`.`impianto`, system_ids)
		ORDER BY IFNULL(da_eseguire, LAST_DAY(STR_TO_DATE(CONCAT(Anno,'-', mese, '-', '01'), '%Y-%m-%d'))) ASC 
		
	) AS subquery
	GROUP BY Id_impianto;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemPeriodicCheckUpdateReminderStatus
DELIMITER //
CREATE PROCEDURE `sp_apiSystemPeriodicCheckUpdateReminderStatus`(
IN id_array MEDIUMTEXT,
IN status_ref VARCHAR(50))
BEGIN
	DECLARE new_status_id INT;

	SELECT id
	INTO new_status_id
	FROM stato_promemoria_cliente
	WHERE rif_applicazioni = status_ref;

	UPDATE impianto_abbonamenti_mesi
	SET id_stato_promemoria = new_status_id,
		data_ultimo_promemoria = NOW()
	WHERE FIND_IN_SET(Id, id_array);
	END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemProductGetBetweenExpirationDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemProductGetBetweenExpirationDates`(
	from_date DATE,
	to_date DATE
)
BEGIN
	SELECT Id_impianto, 
		Id_articolo,
		Data_scadenza, 
		Data_installazione, 
		impianto_componenti.Id AS Posizione, 
		Data_dismesso, 
		COUNT(*) AS quantita,
		BOX,
		impianto_componenti.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_componenti
		INNER JOIN stato_promemoria_cliente ON impianto_componenti.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE scadenza BETWEEN from_date AND to_date
	GROUP BY id_impianto, id_articolo, Data_scadenza;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemProductGetBetweenReminderDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemProductGetBetweenReminderDates`(
	from_date DATE,
	to_date DATE
)
BEGIN
	SELECT Id_impianto, 
		Id_articolo,
		Data_scadenza, 
		Data_installazione, 
		impianto_componenti.Id AS Posizione, 
		Data_dismesso, 
		COUNT(*) AS quantita,
		BOX,
		impianto_componenti.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_componenti
		INNER JOIN stato_promemoria_cliente ON impianto_componenti.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE data_promemoria BETWEEN from_date AND to_date
	GROUP BY id_impianto, id_articolo, Data_scadenza;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemProductGetExpiring
DELIMITER //
CREATE PROCEDURE `sp_apiSystemProductGetExpiring`(
)
BEGIN

	DECLARE start_date DATE; 
	DECLARE end_date DATE; 
		
	DECLARE months_number SMALLINT;
	SELECT IFNULL(Numero_mesi, 1) INTO months_number 
	FROM servizio_alert_configurazione 
	WHERE Id = 1;


	SET start_date = CAST(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 1 MONTH),'%Y-%m-01') AS DATE);
	SET end_date = LAST_DAY(DATE_ADD(NOW(), INTERVAL months_number MONTH));

	SELECT Id_impianto, 
		Id_articolo, 
		Data_scadenza, 
		Data_installazione, 
		impianto_componenti.Id AS Posizione, 
		Data_dismesso, 
		BOX,
		impianto_componenti.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_componenti
		INNER JOIN stato_promemoria_cliente ON impianto_componenti.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE (data_scadenza < end_date)
	ORDER BY data_scadenza DESC;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemProductGetMobileSync
DELIMITER //
CREATE PROCEDURE `sp_apiSystemProductGetMobileSync`(
)
BEGIN
	SELECT Id_impianto, 
		Id_articolo,
		Data_scadenza, 
		Data_installazione, 
		impianto_componenti.Id AS Posizione, 
		Data_dismesso, 
		COUNT(*) AS quantita,
		BOX,
		impianto_componenti.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_componenti
		INNER JOIN stato_promemoria_cliente ON impianto_componenti.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE data_dismesso IS NULL
	GROUP BY id_impianto, id_articolo, Data_scadenza;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemProductUpdateReminderStatus
DELIMITER //
CREATE PROCEDURE `sp_apiSystemProductUpdateReminderStatus`(
IN id_array MEDIUMTEXT,
IN status_ref VARCHAR(50))
BEGIN
	DECLARE new_status_id INT;

	SELECT id
	INTO new_status_id
	FROM stato_promemoria_cliente
	WHERE rif_applicazioni = status_ref;

	UPDATE impianto_componenti 
	SET id_stato_promemoria = new_status_id,
		data_ultimo_promemoria = NOW()
	WHERE FIND_IN_SET(Id_impianto_componenti, id_array);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemReferenceContactGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemReferenceContactGet`()
BEGIN
SELECT id_impianto,
id_cliente,
id_riferimento
	FROM impianto_riferimento ;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSearch
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSearch`(
	IN system_id VARCHAR(200), 
	IN company_name VARCHAR(200), 
	IN description VARCHAR(200)
)
BEGIN
	SELECT `impianto`.`Id_impianto` AS `id_impianto`,
		`impianto`.`Id_cliente` AS `id_cliente`,
		`impianto`.`Abbonamento` AS `id_abbonamento`, 
		impianto.Destinazione AS Id_destinazione, 
		`impianto`.`Data_Funzione` AS `data_funzione`, 
		`impianto`.`scadenza_garanzia` AS `Scadenza_Garanzia`,
		`impianto`.`Tipo_impianto` AS `tipo_impianto`,
		`tipo_impianto`.`Nome` AS `tipo_impianto_descrizione`,
		`impianto`.`Stato` AS `stato`,
		`stato_impianto`.`Nome` AS `stato_descrizione`,
		`impianto`.`Descrizione` AS `descrizione`, 
		`impianto`.`centrale` AS `centrale`, 
		`impianto`.`gsm` AS `gsm`, 
		`impianto`.`combinatore_telefonico` AS `combinatore_telefonico`,
		`impianto`.`orario_prog` AS `orario_prog`,
		clienti.ragione_sociale AS `ragione_sociale`,
		checklist_model_impianto.id_checklist,
		abbonamento.nome as abbonamento,
		impianto.id_stato_promemoria_garanzia,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria_garanzia
	FROM `impianto`
		LEFT JOIN checklist_model_impianto ON impianto.id_impianto = checklist_model_impianto.id_impianto
		INNER JOIN clienti ON impianto.id_cliente = clienti.id_cliente
		INNER JOIN stato_promemoria_cliente ON impianto.id_stato_promemoria_garanzia = stato_promemoria_cliente.id
		INNER JOIN tipo_impianto ON id_tipo = Tipo_impianto
		INNER JOIN stato_impianto ON id_stato = Stato
		LEFT JOIN abbonamento ON impianto.abbonamento = abbonamento.id_abbonamento
	WHERE ((`impianto`.`Stato` < 4) OR (`impianto`.`Stato` > 7))
		AND  (
			(description IS NOT NULL AND impianto.descrizione LIKE CONCAT("%", description, "%"))
			OR (system_id IS NOT NULL AND impianto.id_impianto LIKE CONCAT("%", system_id, "%"))
			OR (company_name IS NOT NULL AND Clienti.ragione_sociale LIKE CONCAT("%", company_name, "%"))
		)
	GROUP BY `impianto`.`Id_impianto`
	ORDER BY Clienti.ragione_sociale
	LIMIT 100;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSimTopUpdateReminderStatus
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSimTopUpdateReminderStatus`(
IN id_array MEDIUMTEXT,
IN status_ref VARCHAR(50))
BEGIN
	DECLARE new_status_id INT;

	SELECT id
	INTO new_status_id
	FROM stato_promemoria_cliente
	WHERE rif_applicazioni = status_ref;

	UPDATE impianto_ricarica_tipo 
	SET id_stato_promemoria = new_status_id,
		data_ultimo_promemoria = NOW()
	WHERE FIND_IN_SET(Id, id_array);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSimTopUpGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSimTopUpGet`(
)
BEGIN
	SELECT impianto_ricarica_tipo.id,
		impianto_ricarica_tipo.Id_impianto, 
		impianto_ricarica_tipo.Tipo_ricarica, 
		Tipo_ricarica.Nome AS 'nome_tipo_ricarica', 
		impianto_ricarica_tipo.`nota`,
		impianto_ricarica_tipo.`importo`,
		impianto_ricarica_tipo.`durata`,
		impianto_ricarica_tipo.`numero`,
		impianto_ricarica_tipo.`intestatario`,
		impianto_ricarica_tipo.`acarico`,
		impianto_ricarica_tipo.`data_attivazione`,
		impianto_ricarica_tipo.`data_rinnovo`,
		impianto_ricarica_tipo.`data_scadenza`,
		impianto_ricarica_tipo.`data_ultimo_promemoria`,
		impianto_ricarica_tipo.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_ricarica_tipo
		INNER JOIN stato_promemoria_cliente ON impianto_ricarica_tipo.id_stato_promemoria = stato_promemoria_cliente.id
		INNER JOIN Tipo_ricarica ON Tipo_ricarica.Id_tipo = impianto_ricarica_tipo.Tipo_ricarica;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSimTopUpGetBetweenExpirationDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSimTopUpGetBetweenExpirationDates`(
	from_date DATE,
	to_date DATE
)
BEGIN

	SELECT impianto_ricarica_tipo.id,
		impianto_ricarica_tipo.Id_impianto, 
		impianto_ricarica_tipo.Tipo_ricarica, 
		Tipo_ricarica.Nome AS 'nome_tipo_ricarica', 
		impianto_ricarica_tipo.`nota`,
		impianto_ricarica_tipo.`importo`,
		impianto_ricarica_tipo.`durata`,
		impianto_ricarica_tipo.`numero`,
		impianto_ricarica_tipo.`intestatario`,
		impianto_ricarica_tipo.`acarico`,
		impianto_ricarica_tipo.`data_attivazione`,
		impianto_ricarica_tipo.`data_rinnovo`,
		impianto_ricarica_tipo.`data_scadenza`,
		impianto_ricarica_tipo.`data_ultimo_promemoria`,
		impianto_ricarica_tipo.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_ricarica_tipo
		INNER JOIN stato_promemoria_cliente ON impianto_ricarica_tipo.id_stato_promemoria = stato_promemoria_cliente.id
		INNER JOIN Tipo_ricarica ON Tipo_ricarica.Id_tipo = impianto_ricarica_tipo.Tipo_ricarica
	WHERE data_scadenza BETWEEN from_date AND to_date; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSimTopUpGetBetweenReminderDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSimTopUpGetBetweenReminderDates`(
	from_date DATE,
	to_date DATE
)
BEGIN

	SELECT impianto_ricarica_tipo.id,
		impianto_ricarica_tipo.Id_impianto, 
		impianto_ricarica_tipo.Tipo_ricarica, 
		Tipo_ricarica.Nome AS 'nome_tipo_ricarica', 
		impianto_ricarica_tipo.`nota`,
		impianto_ricarica_tipo.`importo`,
		impianto_ricarica_tipo.`durata`,
		impianto_ricarica_tipo.`numero`,
		impianto_ricarica_tipo.`intestatario`,
		impianto_ricarica_tipo.`acarico`,
		impianto_ricarica_tipo.`data_attivazione`,
		impianto_ricarica_tipo.`data_rinnovo`,
		impianto_ricarica_tipo.`data_scadenza`,
		impianto_ricarica_tipo.`data_ultimo_promemoria`, 
		impianto_ricarica_tipo.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_ricarica_tipo
		INNER JOIN stato_promemoria_cliente ON impianto_ricarica_tipo.id_stato_promemoria = stato_promemoria_cliente.id
		INNER JOIN Tipo_ricarica ON Tipo_ricarica.Id_tipo = impianto_ricarica_tipo.Tipo_ricarica
	WHERE data_promemoria BETWEEN from_date AND to_date; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSimTopUpGetBetweenRenewDates
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSimTopUpGetBetweenRenewDates`(
	from_date DATE,
	to_date DATE
)
BEGIN

	SELECT impianto_ricarica_tipo.id,
		impianto_ricarica_tipo.Id_impianto, 
		impianto_ricarica_tipo.Tipo_ricarica, 
		Tipo_ricarica.Nome AS 'nome_tipo_ricarica', 
		impianto_ricarica_tipo.`nota`,
		impianto_ricarica_tipo.`importo`,
		impianto_ricarica_tipo.`durata`,
		impianto_ricarica_tipo.`numero`,
		impianto_ricarica_tipo.`intestatario`,
		impianto_ricarica_tipo.`acarico`,
		impianto_ricarica_tipo.`data_attivazione`,
		impianto_ricarica_tipo.`data_rinnovo`,
		impianto_ricarica_tipo.`data_scadenza`,
		impianto_ricarica_tipo.`data_ultimo_promemoria`,
		impianto_ricarica_tipo.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_ricarica_tipo
		INNER JOIN stato_promemoria_cliente ON impianto_ricarica_tipo.id_stato_promemoria = stato_promemoria_cliente.id
		INNER JOIN Tipo_ricarica ON Tipo_ricarica.Id_tipo = impianto_ricarica_tipo.Tipo_ricarica
	WHERE data_rinnovo BETWEEN from_date AND to_date; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSImTopUpGetMobileSync
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSImTopUpGetMobileSync`(
)
BEGIN
	SELECT impianto_ricarica_tipo.id,
		impianto_ricarica_tipo.Id_impianto, 
		impianto_ricarica_tipo.Tipo_ricarica, 
		Tipo_ricarica.Nome AS 'nome_tipo_ricarica', 
		impianto_ricarica_tipo.`nota`,
		impianto_ricarica_tipo.`importo`,
		impianto_ricarica_tipo.`durata`,
		impianto_ricarica_tipo.`numero`,
		impianto_ricarica_tipo.`intestatario`,
		impianto_ricarica_tipo.`acarico`,
		impianto_ricarica_tipo.`data_attivazione`,
		impianto_ricarica_tipo.`data_rinnovo`,
		impianto_ricarica_tipo.`data_scadenza`,
		impianto_ricarica_tipo.`richiedi_invio_promemoria`,
		impianto_ricarica_tipo.`data_ultimo_promemoria`
	FROM impianto_ricarica_tipo
		INNER JOIN Tipo_ricarica ON Tipo_ricarica.Id_tipo = impianto_ricarica_tipo.Tipo_ricarica;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSImTopUpGetToNotify
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSImTopUpGetToNotify`(
)
BEGIN

	DECLARE end_date DATE; 
	
	DECLARE months_number SMALLINT;
	SELECT IFNULL(Numero_mesi, 1) INTO months_number 
	FROM servizio_alert_configurazione 
	WHERE Id = 2;
	
	SET end_date = LAST_DAY(DATE_ADD(NOW(), INTERVAL months_number MONTH));

	SELECT impianto_ricarica_tipo.id,
		impianto_ricarica_tipo.Id_impianto, 
		impianto_ricarica_tipo.Tipo_ricarica, 
		Tipo_ricarica.Nome AS 'nome_tipo_ricarica', 
		impianto_ricarica_tipo.`nota`,
		impianto_ricarica_tipo.`importo`,
		impianto_ricarica_tipo.`durata`,
		impianto_ricarica_tipo.`numero`,
		impianto_ricarica_tipo.`intestatario`,
		impianto_ricarica_tipo.`acarico`,
		impianto_ricarica_tipo.`data_attivazione`,
		impianto_ricarica_tipo.`data_rinnovo`,
		impianto_ricarica_tipo.`data_scadenza`,
		impianto_ricarica_tipo.`data_ultimo_promemoria`,
		impianto_ricarica_tipo.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM impianto_ricarica_tipo
		INNER JOIN stato_promemoria_cliente ON impianto_ricarica_tipo.id_stato_promemoria = stato_promemoria_cliente.id
		INNER JOIN Tipo_ricarica ON Tipo_ricarica.Id_tipo = impianto_ricarica_tipo.Tipo_ricarica
	WHERE (data_scadenza < end_date) 
		OR (data_rinnovo < end_date) 
		OR (data_scadenza IS NULL AND data_rinnovo IS NULL)
	ORDER BY data_scadenza DESC, data_rinnovo DESC;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemStatusGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemStatusGet`(
)
BEGIN
	SELECT 
		Id_stato,
		Nome, 
		Descrizione 
	FROM stato_impianto; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSubscriptionGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSubscriptionGet`(
)
BEGIN
	SELECT *
	FROM 
		(
			SELECT impianto_abbonamenti.Id_impianto,
				impianto_abbonamenti.Id_abbonamenti Id_abbonamento, 
				impianto_abbonamenti.anno, 
				IFNULL(impianto_uscita.Importo_abbonamento, 0) Importo_abbonamento,
				IFNULL(Manutenzione, 0) Tempo_manutenzione, 
				IFNULL(Reperibilità, false) Reperibilita
			FROM impianto_abbonamenti
				LEFT JOIN impianto_uscita 
				ON impianto_abbonamenti.Id_impianto = impianto_uscita.Id_impianto
					AND impianto_abbonamenti.Id_abbonamenti = impianto_uscita.id_abbonamento
			ORDER BY anno DESC, id_impianto DESC
		) AS impianto_abbonamenti_ordinato
	GROUP BY Id_impianto;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemSupervisionGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemSupervisionGet`()
BEGIN
	SELECT iv.Id_impianto, 
	iv.Id_vigilante, 
	IFNULL(tipo, 0) as Tipo
	FROM impianto_vigilante AS iv 
	LEFT JOIN impianto_vigilante_collegamenti AS ivc 
	ON iv.Id_impianto = ivc.id_impianto AND iv.Id_vigilante = ivc.id_vigilante; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemTypeGet
DELIMITER //
CREATE PROCEDURE `sp_apiSystemTypeGet`()
BEGIN
	SELECT id_tipo,
		nome
	FROM tipo_impianto;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiSystemUpdateWarrantyReminderStatus
DELIMITER //
CREATE PROCEDURE `sp_apiSystemUpdateWarrantyReminderStatus`(
	IN id_array MEDIUMTEXT,
	IN status_ref VARCHAR(50)
)
BEGIN
	DECLARE new_status_id INT;

	SELECT id
	INTO new_status_id
	FROM stato_promemoria_cliente
	WHERE rif_applicazioni = status_ref;

	UPDATE impianto
	SET id_stato_promemoria_garanzia = new_status_id,
		data_ultimo_promemoria_garanzia = NOW()
	WHERE FIND_IN_SET(Id_impianto, id_array);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTabletConfigurationGetLastInsert
DELIMITER //
CREATE PROCEDURE `sp_apiTabletConfigurationGetLastInsert`( 
)
BEGIN
      
	SELECT
		Id_tablet, 
		IFNULL(mail, "") AS mail, 
		IFNULL(testo_mail, "") AS testo_mail, 
		IFNULL(Host, "") AS host, 
		IFNULL(Password, "") AS Password, 
		IFNULL(porta, 0) AS Porta, 
		IFNULL(Username, "") AS Username, 
		IFNULL(DIsplay_name, "") AS Display_name, 
		messaggio_non_abbonato,
		email_ufficio,
		admin_password,
		IFNULL(Data_ins, Data_Mod) AS Data_ins,
		Data_Mod
	FROM tablet_configurazione ORDER BY id_tablet DESC LIMIT 1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTechnicianGet
DELIMITER //
CREATE PROCEDURE `sp_apiTechnicianGet`()
BEGIN
	SELECT id_operaio, 
	ragione_sociale, 
	mail_account 
	FROM  Operaio 
	WHERE Data_licenziamento is null and Is_tecnico=1;	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketAttachmentGetByTicketIds
DELIMITER //
CREATE PROCEDURE `sp_apiTicketAttachmentGetByTicketIds`(
	IN ticket_ids MEDIUMTEXT
)
BEGIN
	SELECT ticket_allegati.*
	FROM ticket_allegati
		INNER JOIN ticket ON ticket_allegati.id_ticket = ticket.id_ticket AND ticket_allegati.anno_ticket = ticket.anno
	WHERE FIND_IN_SET(`ticket`.`id`, ticket_ids)
	GROUP BY ticket_allegati.id_ticket, ticket_allegati.anno_ticket
	ORDER BY ticket_allegati.timestamp;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketGet
DELIMITER //
CREATE PROCEDURE `sp_apiTicketGet`()
BEGIN
	SELECT `ticket`.`id`                       AS `id`,
		`ticket`.`Id_ticket`                       AS `id_ticket`,
		`ticket`.`anno`                       AS `anno`,
		`ticket`.`Id_impianto`                       AS `id_impianto`,
		`ticket`.`Id_cliente`                       AS `id_cliente`,
		ticket.id_destinazione,
		`ticket`.`Urgenza`                       AS `urgenza`,
		`ticket`.`Descrizione`                       AS `ticket_descrizione`,
		IFNULL(ticket.Data_ticket, ticket.data_ora) AS "data_ticket", 
		ticket.scadenza AS Data_scadenza, 
		ticket.data_ora,
		ticket.data_soluzione, 
		ticket.Causale, 
		ticket.intervento,
		ticket.Comunicazione, 
		ticket.Stato_ticket,
		ticket.tempo, 
		ticket.id_utente, 
		ticket.stampato, 
		ticket.inviato, 
		ticket.data_promemoria,
		ticket.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM ticket
		INNER JOIN stato_promemoria_cliente ON ticket.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE ((`ticket`.`Stato_ticket`                       = '1' OR `ticket`.`Stato_ticket`                       = '2') AND (`ticket`.`Id_impianto`                       IS NOT NULL)); 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketGetBetweenExpirationDates
DELIMITER //
CREATE PROCEDURE `sp_apiTicketGetBetweenExpirationDates`(
	from_date DATE,
	to_date DATE
)
BEGIN
	SELECT `ticket`.`id`                       AS `id`,
		`ticket`.`Id_ticket`                       AS `id_ticket`,
		`ticket`.`anno`                       AS `anno`,
		`ticket`.`Id_impianto`                       AS `id_impianto`,
		`ticket`.`Id_cliente`                       AS `id_cliente`,
		ticket.id_destinazione,
		`ticket`.`Urgenza`                       AS `urgenza`,
		`ticket`.`Descrizione`                       AS `ticket_descrizione`,
		IFNULL(ticket.Data_ticket, ticket.data_ora) AS "data_ticket", 
		ticket.scadenza AS Data_scadenza, 
		ticket.data_ora,
		ticket.data_soluzione, 
		ticket.Causale, 
		ticket.intervento,
		ticket.Comunicazione, 
		ticket.Stato_ticket,
		ticket.tempo, 
		ticket.id_utente, 
		ticket.stampato, 
		ticket.inviato, 
		ticket.data_promemoria,
		ticket.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM ticket
		INNER JOIN stato_promemoria_cliente ON ticket.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE scadenza BETWEEN from_date AND to_date
	ORDER BY ticket.scadenza DESC; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketGetBetweenReminderDates
DELIMITER //
CREATE PROCEDURE `sp_apiTicketGetBetweenReminderDates`(
	from_date DATE,
	to_date DATE
)
BEGIN
	SELECT `ticket`.`id`                       AS `id`,
		`ticket`.`Id_ticket`                       AS `id_ticket`,
		`ticket`.`anno`                       AS `anno`,
		`ticket`.`Id_impianto`                       AS `id_impianto`,
		`ticket`.`Id_cliente`                       AS `id_cliente`,
		ticket.id_destinazione,
		`ticket`.`Urgenza`                       AS `urgenza`,
		`ticket`.`Descrizione`                       AS `ticket_descrizione`,
		IFNULL(ticket.Data_ticket, ticket.data_ora) AS "data_ticket", 
		ticket.scadenza AS Data_scadenza, 
		ticket.data_ora,
		ticket.data_soluzione, 
		ticket.Causale, 
		ticket.intervento,
		ticket.Comunicazione, 
		ticket.Stato_ticket,
		ticket.tempo, 
		ticket.id_utente, 
		ticket.stampato, 
		ticket.inviato, 
		ticket.data_promemoria,
		ticket.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM ticket
		INNER JOIN stato_promemoria_cliente ON ticket.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE data_promemoria BETWEEN from_date AND to_date
	ORDER BY ticket.data_promemoria DESC; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketGetById
DELIMITER //
CREATE PROCEDURE `sp_apiTicketGetById`(ticket_id INT)
BEGIN
	SELECT `ticket`.`id`                       AS `id`,
		`ticket`.`Id_ticket`                       AS `id_ticket`,
		`ticket`.`anno`                       AS `anno`,
		`ticket`.`Id_impianto`                       AS `id_impianto`,
		`ticket`.`Id_cliente`                       AS `id_cliente`,
		ticket.id_destinazione,
		`ticket`.`Urgenza`                       AS `urgenza`,
		`ticket`.`Descrizione`                       AS `ticket_descrizione`,
		IFNULL(ticket.Data_ticket, ticket.data_ora) AS "data_ticket", 
		ticket.scadenza AS Data_scadenza, 
		ticket.data_ora,
		ticket.data_soluzione, 
		ticket.Causale, 
		ticket.intervento,
		ticket.Comunicazione, 
		ticket.Stato_ticket,
		ticket.tempo, 
		ticket.id_utente, 
		ticket.stampato, 
		ticket.inviato, 
		ticket.data_promemoria,
		ticket.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM ticket
		INNER JOIN stato_promemoria_cliente ON ticket.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE ticket.id = ticket_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketGetBySystems
DELIMITER //
CREATE PROCEDURE `sp_apiTicketGetBySystems`(
	system_ids MEDIUMTEXT
)
BEGIN
	SELECT `ticket`.`id`                       AS `id`,
		`ticket`.`Id_ticket`                       AS `id_ticket`,
		`ticket`.`anno`                       AS `anno`,
		`ticket`.`Id_impianto`                       AS `id_impianto`,
		`ticket`.`Id_cliente`                       AS `id_cliente`,
		ticket.id_destinazione,
		`ticket`.`Urgenza`                       AS `urgenza`,
		`ticket`.`Descrizione`                       AS `ticket_descrizione`,
		IFNULL(ticket.Data_ticket, ticket.data_ora) AS "data_ticket", 
		ticket.scadenza AS Data_scadenza, 
		ticket.data_ora,
		ticket.data_soluzione, 
		ticket.Causale, 
		ticket.intervento,
		ticket.Comunicazione, 
		ticket.Stato_ticket,
		ticket.tempo, 
		ticket.id_utente, 
		ticket.stampato, 
		ticket.inviato, 
		ticket.data_promemoria,
		ticket.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM ticket
		INNER JOIN stato_promemoria_cliente ON ticket.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE ((`ticket`.`Stato_ticket`                       = '1' OR `ticket`.`Stato_ticket`                       = '2') AND  FIND_IN_SET(`ticket`.`Id_impianto`, system_ids)); 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketGetExpiring
DELIMITER //
CREATE PROCEDURE `sp_apiTicketGetExpiring`(
)
BEGIN
	DECLARE start_date DATE; 
	DECLARE end_date DATE; 

	DECLARE months_number SMALLINT;
	SELECT IFNULL(Numero_mesi, 1) INTO months_number 
	FROM servizio_alert_configurazione 
	WHERE Id = 4;

	SET start_date = CAST(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 1 MONTH),'%Y-%m-01') AS DATE);
	SET end_date = LAST_DAY(DATE_ADD(NOW(), INTERVAL months_number MONTH));

	SELECT `ticket`.`id`                       AS `id`,
		`ticket`.`Id_ticket`                       AS `id_ticket`,
		`ticket`.`anno`                       AS `anno`,
		`ticket`.`Id_impianto`                       AS `id_impianto`,
		`ticket`.`Id_cliente`                       AS `id_cliente`,
		ticket.id_destinazione,
		`ticket`.`Urgenza`                       AS `urgenza`,
		`ticket`.`Descrizione`                       AS `ticket_descrizione`,
		IFNULL(ticket.Data_ticket, ticket.data_ora) AS "data_ticket", 
		ticket.scadenza AS Data_scadenza, 
		ticket.data_ora,
		ticket.data_soluzione, 
		ticket.Causale, 
		ticket.intervento,
		ticket.Comunicazione, 
		ticket.Stato_ticket,
		ticket.tempo, 
		ticket.id_utente, 
		ticket.stampato, 
		ticket.inviato, 
		ticket.data_promemoria,
		ticket.id_stato_promemoria,
		stato_promemoria_cliente.rif_applicazioni as rif_stato_promemoria
	FROM ticket
		INNER JOIN stato_promemoria_cliente ON ticket.id_stato_promemoria = stato_promemoria_cliente.id
	WHERE (`ticket`.`Stato_ticket`                       IN (1,2) and ticket.scadenza < end_date)
	ORDER BY ticket.scadenza DESC; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketStatusGet
DELIMITER //
CREATE PROCEDURE `sp_apiTicketStatusGet`(
)
BEGIN
	SELECT Id_stato,
		nome,
		descrizione,
		colore,
		aperto
	FROM Stato_ticket;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketUpdate
DELIMITER //
CREATE PROCEDURE `sp_apiTicketUpdate`(
	IN ticket_id INT, 
	IN status_id VARCHAR(50), 
	IN allow_status_id BIT(1)
)
BEGIN
	UPDATE Ticket 
	SET
		stato_ticket = IF(IFNULL(allow_status_id, FALSE), status_id, stato_ticket)
	WHERE id = ticket_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiTicketUpdateReminderStatus
DELIMITER //
CREATE PROCEDURE `sp_apiTicketUpdateReminderStatus`(
	IN id_array MEDIUMTEXT,
	IN status_ref VARCHAR(50))
BEGIN
	DECLARE new_status_id INT;

	SELECT id
	INTO new_status_id
	FROM stato_promemoria_cliente
	WHERE rif_applicazioni = status_ref;

	UPDATE ticket 
	SET id_stato_promemoria = new_status_id,
		data_ultimo_promemoria = NOW()
	WHERE FIND_IN_SET(Id, id_array);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiUserGet
DELIMITER //
CREATE PROCEDURE `sp_apiUserGet`()
BEGIN
	SELECT `Id_utente`,
		Utente.Nome as Nome,
		Utente.Descrizione as Descrizione,
		Utente.mail,
		`Firma`,
		Utente.calendario as calendario,
		`smtp`,
		`porta`,
		`mssl`,
		`nome_utente_mail`,
		`password_mail`,
		utente.tipo_utente as Id_tipo_utente,
		tipo_utente.nome as Tipo_utente,
		`conferma`, 
		Password, 
		Salt
	FROM utente 
		INNER JOIN tipo_utente ON utente.tipo_utente = tipo_utente.id_tipo;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiUserGetById
DELIMITER //
CREATE PROCEDURE `sp_apiUserGetById`(
	IN user_id INT(11)
)
BEGIN
	SELECT `Id_utente`,
		Utente.Nome as Nome,
		Utente.Descrizione as Descrizione,
		Utente.mail,
		`Firma`,
		Utente.calendario as calendario,
		`smtp`,
		`porta`,
		`mssl`,
		`nome_utente_mail`,
		`password_mail`,
		utente.tipo_utente as Id_tipo_utente,
		tipo_utente.nome as Tipo_utente,
		`conferma`
	FROM utente 
		INNER JOIN tipo_utente ON utente.tipo_utente = tipo_utente.id_tipo
	WHERE Id_utente = user_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiUserRefreshTokenDelete
DELIMITER //
CREATE PROCEDURE `sp_apiUserRefreshTokenDelete`(
	IN id_token INT(11)
)
BEGIN
	DELETE FROM TokenRefresh Where TokenRefresh.id_token=id_token;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiUserRolesGetyUserId
DELIMITER //
CREATE PROCEDURE `sp_apiUserRolesGetyUserId`(
	IN user_id INT(11)
)
BEGIN
	SELECT 
		utente_roles.id, 
		utente_utente_roles.id_utente,
		nome, 
		descrizione,
		app_name
	FROM utente_roles
		INNER JOIN utente_utente_roles ON utente_utente_roles.id_utente_roles = utente_roles.id
	WHERE id_utente = user_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiUserRolesGetyUsers
DELIMITER //
CREATE PROCEDURE `sp_apiUserRolesGetyUsers`(
	IN user_ids MEDIUMTEXT
)
BEGIN
	SELECT 
		utente_roles.id, 
		utente_utente_roles.id_utente,
		nome, 
		descrizione,
		app_name
	FROM utente_roles
		INNER JOIN utente_utente_roles ON utente_utente_roles.id_utente_roles = utente_roles.id
	WHERE FIND_IN_SET(id_utente, user_ids);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiWarehouseOperationGetById
DELIMITER //
CREATE PROCEDURE `sp_apiWarehouseOperationGetById`(
	IN operation_id INT(11)
)
BEGIN	
	SELECT Id_operazione, 
		Articolo, 
		Id_magazzino,
		causale,
		causale_magazzino.Nome,
		Quantità as Quantita,		
		Data
	 FROM magazzino_operazione
		INNER JOIN causale_magazzino ON causale_magazzino.Id_causale = causale
	 WHERE Id_operazione = operation_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiWarehouseOperationInsert
DELIMITER //
CREATE PROCEDURE `sp_apiWarehouseOperationInsert`(
	IN product_code VARCHAR(11),
	IN warehouse_id INT(11),
	IN quantity FLOAT(11,2),
	IN operation_date DATE,
	IN causal_id INT(11), 
	IN user_id INT(11),
	OUT operation_id BIGINT(11)
)
BEGIN	
	SET @USER_ID = user_id;

	IF causal_id IS NULL THEN 
		SELECT id_causale 
			INTO causal_id
		FROM causale_magazzino
		WHERE Operazione = IF(quantity >= 0, 1, 2) AND tipo_magazzino = warehouse_id;
	END IF;
	
	IF quantity < 0 THEN
		SET quantity = quantity * -1; 
	END IF;
	
	CALL sp_ariesDepotOperationsInsert(
		quantity,
		product_code,
		warehouse_id,
		operation_date,
		5,
		causal_id,
		operation_id
	); 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_apiWarehouseProductGetBy
DELIMITER //
CREATE PROCEDURE `sp_apiWarehouseProductGetBy`(
	IN product_code VARCHAR(11), 
	IN warehouse_id INT(11)
)
BEGIN
	SELECT p1.* 
	FROM (
		SELECT IF(magazzino.tipo_magazzino = tipo_magazzino.id_tipo, Id, -1) Id, 
			Id_articolo, 
			tipo_magazzino.id_tipo as tipo_magazzino, 
			tipo_magazzino.nome,
			IF(magazzino.tipo_magazzino = tipo_magazzino.id_tipo, Giacenza, 0.00) Giacenza,		
			Data_ins, 
			Utente_ins, 
			tipo_magazzino.prior
		 FROM magazzino,tipo_magazzino 
		 WHERE (IF(product_code IS NULL, True, Id_articolo) = IFNULL(product_code, True))
			AND (IF(warehouse_id IS NULL, True, tipo_magazzino.id_tipo) = IFNULL(warehouse_id, True))
			AND tipo_magazzino.disabilitato = 0
		 ORDER BY Id DESC
	) AS p1
	GROUP BY id_articolo, tipo_magazzino
	ORDER BY Id_articolo, prior;


END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_areisSystemsExpirationsCounter
DELIMITER //
CREATE PROCEDURE `sp_areisSystemsExpirationsCounter`(
	IN start_date DATE,
	IN end_date DATE,
	IN system_id INT,
	IN customer_id INT
)
BEGIN
	SELECT COUNT(*)
	FROM vw_systems_expirations_summary
	WHERE
		data_scadenza >= iFNULL(start_date, '1970-01-01') 
		AND data_scadenza <= iFNULL(end_date, '2100-01-01') 
		AND id_impianto = iFNULL(system_id, id_impianto) 
		AND id_cliente = iFNULL(customer_id, id_cliente);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_areisSystemsExpirationsSearch
DELIMITER //
CREATE PROCEDURE `sp_areisSystemsExpirationsSearch`(
	IN start_date DATE,
	IN end_date DATE,
	IN system_id INT,
	IN customer_id INT,
	IN reminder_status VARCHAR(20) -- sent, to_be_sent, to_handle
)
BEGIN
	SELECT 
		ses.id_riferimento,
		tipo_entita,
		tipo_scadenza,
		ses.id_impianto,
		ses.id_cliente,
		Stato_clienti.Nome AS "stato_cliente",
		Tipo_impianto.nome AS "tipo_impianto",
		stato_impianto.Nome AS "stato_impianto",
		ses.descrizione,
		data_scadenza,
		richiedi_invio_promemoria,
		data_promemoria,
		quantita,
		CONCAT(CONCAT(dc.indirizzo,' n.',dc.numero_civico, dc.altro),' - ',concat(IF(f.nome IS NOT NULL AND f.nome <> '', concat(f.nome,' di '), ''), c.nome,' (',c.provincia,')')) AS 'Indirizzo',
		dc.Km_sede AS "km_viaggio",
		dc.Tempo_strada AS tempo_viaggio,
		rc.id_riferimento AS id_riferimento_promemoria,
		CONCAT(rc.mail, '/', rc.altro_telefono) AS riferimento_promemoria
	FROM vw_systems_expirations_summary AS ses
		INNER JOIN impianto ON ses.id_impianto = impianto.Id_impianto
		INNER JOIN clienti ON ses.Id_cliente = clienti.Id_cliente
		INNER JOIN stato_impianto ON impianto.Stato = stato_impianto.Id_stato
		INNER JOIN tipo_impianto ON impianto.Tipo_impianto = tipo_impianto.Id_tipo
		INNER JOIN stato_clienti ON clienti.Stato_cliente = stato_clienti.Id_stato
		INNER JOIN destinazione_cliente AS dc ON dc.id_cliente = ses.id_cliente
			AND impianto.destinazione = dc.Id_destinazione
		INNER JOIN comune AS c ON c.id_comune=dc.Comune
		LEFT JOIN frazione AS f ON f.id_frazione=dc.frazione
		LEFT JOIN riferimento_clienti AS rc ON rc.id_cliente=ses.id_cliente AND Promemoria_cliente=1
	WHERE
		ses.data_scadenza >= iFNULL(start_date, '1970-01-01') 
		AND ses.data_scadenza <= iFNULL(end_date, '2100-01-01') 
		AND ses.id_impianto = iFNULL(system_id, ses.id_impianto) 
		AND ses.id_cliente = iFNULL(customer_id, ses.id_cliente)
		AND IF(reminder_status = 'to_handle', 1, richiedi_invio_promemoria) = richiedi_invio_promemoria
		AND IF(reminder_status = 'to_be_sent', data_promemoria > CURRENT_DATE, True)
		AND IF(reminder_status = 'sent', data_promemoria <= CURRENT_DATE, True)
	ORDER BY data_scadenza DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesAgentSettingPercentagesCategoryGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesAgentSettingPercentagesCategoryGetById`(
	IN enter_id INT(11)
)
BEGIN

	SELECT id,
		nome
	FROM preventivo_confcost_categoria
	WHERE id = enter_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesAgentSettingPercentagesGetByCategory
DELIMITER //
CREATE PROCEDURE `sp_ariesAgentSettingPercentagesGetByCategory`(
	IN category_id INT(11)
)
BEGIN

	SELECT id,
		costi,
		utile,
		agente,
		sconto,
		fattore1,
		fattore2, 
		id_categoria,
		data_ins, 
		utente_ins
	FROM preventivo_confcost
	WHERE id_categoria = category_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesAgentSettingPercentagesGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesAgentSettingPercentagesGetById`(
enter_id INT(11)
)
BEGIN

	SELECT id,
		costi,
		utile,
		agente,
		sconto,
		fattore1,
		fattore2, 
		id_categoria,
		data_ins, 
		utente_ins
	FROM preventivo_confcost
	WHERE Id = enter_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesAgentSettingPercentagesInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesAgentSettingPercentagesInsert`(
	IN fixed_costs_percentage DECIMAL(11,2),
	IN profit_percentage DECIMAL(11,2),
	IN sale_percentage DECIMAL(11,2),
	IN agents_percentage DECIMAL(11,2),
	IN first_factor DECIMAL(11,2),
	IN second_factor DECIMAL(11,2),
	IN category_id INT(11), 
	OUT result INT(11)
)
BEGIN

	INSERT INTO preventivo_confcost
	SET costi = fixed_costs_percentage,
		utile = profit_percentage,
		agente = agents_percentage,
		sconto = sale_percentage,
		fattore1 = first_factor,
		fattore2 = second_factor, 
		id_categoria = category_id,
		data_ins = NOW(), 
		utente_ins = @USER_ID;


	SET Result = LAST_INSERT_ID(); 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesAgentSettingPercentagesUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesAgentSettingPercentagesUpdate`(
	IN fixed_costs_percentage DECIMAL(11,2),
	IN profit_percentage DECIMAL(11,2),
	IN sale_percentage DECIMAL(11,2),
	IN agents_percentage DECIMAL(11,2),
	IN first_factor DECIMAL(11,2),
	IN second_factor DECIMAL(11,2),
	IN category_id INT(11), 
	IN enter_id INT(11),
	OUT result INT(11)
)
BEGIN

	UPDATE preventivo_confcost
	SET costi = fixed_costs_percentage,
		utile = profit_percentage,
		agente = agents_percentage,
		sconto = sale_percentage,
		fattore1 = first_factor,
		fattore2 = second_factor, 
		id_categoria = category_id,
		data_ins = NOW(), 
		utente_ins = @USER_ID
	WHERE id = enter_id;


	SET Result = 1; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesBankDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesBankDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM banca 
	WHERE id_banca = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesBankGet
DELIMITER //
CREATE PROCEDURE `sp_ariesBankGet`( 
)
BEGIN
	SELECT id_banca,
	Nome,
	IFNULL(abi, '') AS 'abi',  
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM banca
	ORDER BY id_banca;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesBankGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesBankGetById`( 
	Bank_id INT
)
BEGIN
	SELECT id_banca,
	Nome,
	IFNULL(abi, '') AS 'abi',  
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM banca
	WHERE id_banca = Bank_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesBankGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesBankGetByName`( 
	name VARCHAR(45)
)
BEGIN
	SELECT id_banca,
	Nome,
	IFNULL(abi, '') AS 'abi',  
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM banca
	WHERE Nome = name;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesBankInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesBankInsert`( 
	name VARCHAR(45),
	enter_abi VARCHAR(5),
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	

	SELECT Count(Nome) INTO Result
	FROM Banca 
	WHERE Nome = Name; 
	
	IF Result > 0 THEN
		 SET Result = -1; # Bank name already exists
	END IF;

	
	IF Result = 0 THEN
		INSERT INTO Banca 
		SET 
			Nome = name,
			abi = enter_abi, 
			Data_ins = NOW(), 
			Data_mod = NOW(),
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesBankUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesBankUpdate`( 
	enter_id INTEGER,
	name VARCHAR(45),
	enter_abi VARCHAR(5),
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	

	SELECT Count(Nome) INTO Result
	FROM banca 
	WHERE Nome = Name AND id_banca != enter_id; 
	
	IF Result > 0 THEN
		 SET Result = -1; # Bank name already exists
	END IF;

	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM Banca 
			WHERE id_banca = enter_id;
			
			IF Result = 0 THEN
				SET Result = -2; # Bank ID not found							
			END IF; 
	END IF; 
	
	IF Result >0 THEN
		
		
		UPDATE Banca 
		SET 
			Nome = name,
			abi = enter_abi, 
			Utente_mod = @USER_ID
		Where id_banca = enter_id;
		
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCertificateImportedDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesCertificateImportedDelete`(
	IN `in_id` INT(11), 
	OUT `result` BIT(1)
)
BEGIN

	DELETE FROM certificato_importato
	WHERE id = in_id;
		
	SET Result = True; 
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCertificateImportedGet
DELIMITER //
CREATE PROCEDURE `sp_ariesCertificateImportedGet`( )
BEGIN

	SELECT  
		`id`,
		`nome`,
		`nome_rif`,
		`nome_emittente`,
		`email`,
		`data_inizio_validita`,
		`data_fine_validita`,
		`serial_number`,
		`pin`,
		`smart_device`,
		`attivo`,
		`data_mod`,
		`utente_mod`
	FROM certificato_importato;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCertificateImportedGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesCertificateImportedGetById`( IN in_id INT(11) )
BEGIN

	SELECT  
		`id`,
		`nome`,
		`nome_rif`,
		`nome_emittente`,
		`email`,
		`data_inizio_validita`,
		`data_fine_validita`,
		`serial_number`,
		`pin`,
		`smart_device`,
		`attivo`,
		`data_mod`,
		`utente_mod`
	FROM certificato_importato
	WHERE id = in_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCertificateImportedGetByIssuerAndSerialNumber
DELIMITER //
CREATE PROCEDURE `sp_ariesCertificateImportedGetByIssuerAndSerialNumber`( IN in_issuer VARCHAR(150), IN serial_number VARCHAR(150) )
BEGIN

	SELECT  
		`id`,
		`nome`,
		`nome_rif`,
		`nome_emittente`,
		`email`,
		`data_inizio_validita`,
		`data_fine_validita`,
		`serial_number`,
		`pin`,
		`smart_device`,
		`attivo`,
		`data_mod`,
		`utente_mod`
	FROM certificato_importato
	WHERE nome_emittente = in_issuer AND nome_emittente = in_serial_number;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCertificateImportedInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesCertificateImportedInsert`( 	
	IN `in_name` VARCHAR(150),
	IN `in_ref_name` VARCHAR(150),
	IN `in_issuer_name` VARCHAR(150),
	IN `in_email` VARCHAR(150),
	IN `in_valid_from` DATETIME,
	IN `in_valid_to` DATETIME,
	IN `in_serial_number` VARCHAR(150),
	IN `in_pin` VARCHAR(50),
	IN `in_smart_device` BIT(1),
	IN `in_is_active` BIT(1),
	IN `in_user` INT(11), 
	OUT `result` INT(11)
)
BEGIN

	INSERT INTO certificato_importato 
	SET
		`nome` = in_name,
		`nome_rif` = in_ref_name,
		`nome_emittente` = in_issuer_name,
		`email` = in_email,
		`data_inizio_validita` = in_valid_from,
		`data_fine_validita` = in_valid_to,
		`serial_number` = in_serial_number,
		`pin` = in_pin,
		`smart_device` = in_serial_number,
		`attivo` = in_is_active,
		`utente_mod` = IFNULL(in_user, @USER_ID);
		
	SET Result = LAST_INSERT_ID(); 
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCertificateImportedUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesCertificateImportedUpdate`( 	
	IN `in_name` VARCHAR(150),
	IN `in_ref_name` VARCHAR(150),
	IN `in_issuer_name` VARCHAR(150),
	IN `in_email` VARCHAR(150),
	IN `in_valid_from` DATETIME,
	IN `in_valid_to` DATETIME,
	IN `in_serial_number` VARCHAR(150),
	IN `in_pin` VARCHAR(50),
	IN `in_smart_device` BIT(1),
	IN `in_is_active` BIT(1),
	IN `in_user` INT(11), 
	IN `in_id` INT(11), 
	OUT `result` BIT(1)
)
BEGIN

	UPDATE certificato_importato 
	SET
		`nome` = in_name,
		`nome_rif` = in_ref_name,
		`nome_emittente` = in_issuer_name,
		`email` = in_email,
		`data_inizio_validita` = in_valid_from,
		`data_fine_validita` = in_valid_to,
		`serial_number` = in_serial_number,
		`pin` = in_pin,
		`smart_device` = in_serial_number,
		`attivo` = in_is_active,
		`utente_mod` = IFNULL(in_user, @USER_ID)
	WHERE id = in_id;
		
	SET Result = True; 
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCheckFutureInvoicesStatementReminder
DELIMITER //
CREATE PROCEDURE `sp_ariesCheckFutureInvoicesStatementReminder`(
	invoice_id INT(11), 
	invoice_year INT(11)
)
BEGIN
	DECLARE customer_id INT(11);
	DECLARE reminder_event_id INT(11);
	DECLARE reminder_event_date DATE;
	DECLARE reminder_event_delete_result INT(11);
	DECLARE has_opened_payments BIT(1);


	SELECT id_cliente
	INTO customer_id
	FROM fattura
	WHERE id_fattura = invoice_id
		and anno = invoice_year;

	SELECT id, data_esecuzione
	INTO reminder_event_id, reminder_event_date
	FROM Evento
	WHERE Id_riferimento = customer_id
		AND id_tipo_evento = 3
		AND oggetto LIKE "%ESTRATTO CONTO%"
		AND data_esecuzione >= NOW()
	LIMIT 1;

	IF reminder_event_id IS NOT NULL THEN
		SELECT count(*) > 0
		INTO has_opened_payments
		FROM vw_invoices_payments_details
		WHERE pagato = 0
			AND id_cliente = customer_id
			AND data_pagamento_prevista IS NOT NULL
			AND data_pagamento_prevista < reminder_event_date
			AND anno <> 0;

		IF has_opened_payments = 0 THEN
			CALL sp_ariesEventDelete(reminder_event_id, reminder_event_delete_result);
		END IF;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistElementTypeGet
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistElementTypeGet`( )
BEGIN
        

	SELECT tipo_checklist_elemento.Id,
		tipo_checklist_elemento.Nome,
		IFNULL(tipo_checklist_elemento.Descrizione, "") Descrizione, 
		tipo_checklist_elemento.RifApplicazioni
	FROM tipo_checklist_elemento;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistElementTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistElementTypeGetById`( IN element_type_id INT(11) )
BEGIN
        

	SELECT tipo_checklist_elemento.Id,
		tipo_checklist_elemento.Nome,
		IFNULL(tipo_checklist_elemento.Descrizione, "") Descrizione, 
		tipo_checklist_elemento.RifApplicazioni
	FROM tipo_checklist_elemento
	WHERE tipo_checklist_elemento.Id = element_type_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistLinkToSystem
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistLinkToSystem`( 
	IN enter_id INT(11),
	IN user_id INT(11),
	OUT result INT(11)
)
BEGIN
	DECLARE `_rollback`                       BOOL DEFAULT 0;
	DECLARE system_id INT(11);
	DECLARE new_checklist_id INT(11);
	DECLARE checklist_model_id INT(11);
	DECLARE cursor_id INT(11);
	DECLARE cursor_row_id INT(11);
	DECLARE paragraph_id INT(11); 
	DECLARE exit_paragraph_loop BOOLEAN;
	DECLARE exit_row_loop BOOLEAN;
	DECLARE paragraph_cursos CURSOR FOR SELECT id FROM checklist_paragrafo WHERE id_checklist = enter_id;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET exit_paragraph_loop = TRUE;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback`                       = 1;
	
	START TRANSACTION;
	
	SELECT checklist.id_impianto, 
			checklist.id_checklist_model
		INTO system_id, 
			checklist_model_id
	FROM checklist
	WHERE id = enter_id;
	
	-- Checklist model insert
	INSERT INTO checklist_model (`Id_check_parent`,
		`nome`,
		`descrizione`,
		`note`,
		`tipo_impianto`,
		`Stato`,
		`Data_ins`,
		`Utente_ins`)
	SELECT
		checklist_model_id,
		`nome`,
		`descrizione`,
		`note`                       ,
		`tipo_impianto`,
		`Stato`,
		NOW(),
		user_id
	FROM checklist_model 
	WHERE Id_check = checklist_model_id;
		
	SET new_checklist_id = LAST_INSERT_ID();
	SET Result = new_checklist_id;
		
	-- association system - checklist model
	DELETE FROM checklist_model_impianto WHERE Id_impianto = system_id;
	INSERT INTO `checklist_model_impianto`                       (`id_checklist`, `id_impianto`, `Data_ins`,`Utente_ins`)
	VALUES (new_checklist_id, system_id, NOW(), user_id);
		
	-- open the cursor
	OPEN paragraph_cursos;
	
	-- start looping
	paragrah_loop: LOOP
		
		-- read the name from next row into the variables 
		FETCH  paragraph_cursos INTO cursor_id;
		IF exit_paragraph_loop THEN
			CLOSE paragraph_cursos;
			LEAVE paragrah_loop;
		END IF;
		
		-- paragraph insert
		INSERT INTO `checklist_model_paragrafo`                       (`id_checklist`, `nome`, `descrizione`, `ordine`, `Data_ins`,
			`Data_mod`, `Utente_ins`, Utente_mod)
		SELECT
			new_checklist_id,
			`nome`,
			`descrizione`,
			`ordine`,
			NOW(),
			NOW(), 
			user_id, 
			user_id
		FROM checklist_paragrafo
		WHERE checklist_paragrafo.id = cursor_id;	
		
		SET paragraph_id = LAST_INSERT_ID();
		
		-- ###################################### ROWS INSERT ################################
		BEGIN
			DECLARE row_id INT(11);
			DECLARE rows_cursor CURSOR FOR SELECT id FROM checklist_paragrafo_riga WHERE id_paragrafo = cursor_id;
			DECLARE CONTINUE HANDLER FOR NOT FOUND SET exit_row_loop = TRUE;
			
			-- open the cursor
			OPEN rows_cursor;
	
			-- start looping
			row_loop: LOOP
			
				-- read the name from next row into the variables 
				FETCH  rows_cursor INTO cursor_row_id;
				IF exit_row_loop THEN
					CLOSE rows_cursor;
					LEAVE row_loop;
				END IF;

				-- row insert
				INSERT INTO `checklist_model_elemento`                       (
					`Id_paragrafo`,
					`Id_checklist`,
					`Posizione`,
					`tipo_elemento`,
					`nome`,
					`descrizione`,
					`indicazioni`,
					Id_elemento,
					`Data_ins`,
					`Data_mod`,
					`Utente_ins`,
					`Utente_mod`)
				SELECT
					paragraph_id,
					new_checklist_id,
					ordine,
					tipo_riga,
					nome,
					descrizione,
					indicazioni_tecnico,
					null,
					NOW(),
					NOW(), 
					user_id, 
					user_id
				FROM checklist_paragrafo_riga
				WHERE checklist_paragrafo_riga.id = cursor_row_id;	
				
				SET row_id = LAST_INSERT_ID(); 	
				
				INSERT INTO checklist_model_elemento_def_valore (
					`Id_elemento`,
					`Id_tipo_def_val`,
					`Label`,
					`Field`,
					`Value`,
					`Data_mod`,
					`Utente_mod`)
				SELECT 
					row_id, 
					checklist_model_elemento_def_valore.id_tipo_def_val, 
					checklist_model_elemento_def_valore.Label, 
					checklist_model_elemento_def_valore.Field, 
					checklist_model_elemento_def_valore.Value,
					NOW(), 
					user_id
				FROM checklist_model_elemento_def_valore 
					INNER JOIN checklist_paragrafo_riga 
					ON checklist_paragrafo_riga.id_checklist_model_elemento = checklist_model_elemento_def_valore.id_elemento
				WHERE checklist_paragrafo_riga.id = cursor_row_id;
								
			END LOOP row_loop;
		END;
	END LOOP paragrah_loop;

	
	IF `_rollback`                       THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelDelete`( 
	IN enter_id INT(11),
	OUT result INT(11)
)
BEGIN
   
  DECLARE `_rollback` BOOL DEFAULT 0;
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
   
	SELECT COUNT(checklist_model.id_check)
		INTO Result
	FROM checklist_model
	WHERE checklist_model.id_check = enter_id;
	
	IF Result > 0 THEN
		DELETE 	
		FROM checklist_model
		WHERE checklist_model.id_check = enter_id; 
	ELSE 
		SET Result = -4; -- checklist not found		
	END IF; 
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelDuplicate
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelDuplicate`( 
	IN enter_id INT(11),
	OUT result INT(11)
)
BEGIN

	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE checklist_id INT(11);
	DECLARE cursor_id INT(11);
	DECLARE paragraph_id INT(11); 
	DECLARE exit_loop BOOLEAN;
	DECLARE paragraph_cursos CURSOR FOR SELECT id FROM checklist_model_paragrafo WHERE id_checklist = enter_id;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET exit_loop = TRUE;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SELECT COUNT(checklist_model.id_check)
		INTO Result
	FROM checklist_model
	WHERE checklist_model.id_check = enter_id;
	
	IF Result > 0 THEN
		INSERT INTO checklist_model (`Id_check_parent`, `nome`, `descrizione`, `note`, `tipo_impianto`,
			`Stato`, `Data_ins`, `Data_mod`, `Utente_ins`, `Utente_mod`)
		SELECT
			`Id_check_parent`,
			`nome`,
			`descrizione`,
			`note` ,
			`tipo_impianto`,
			`Stato`,
			NOW(),
			NOW(),
			@USER_ID,
			@USER_ID
		FROM checklist_model 
		WHERE Id_check = enter_id;
		
		SET checklist_id = LAST_INSERT_ID();
		SET Result = checklist_id;
		
		INSERT INTO `checklist_model_impianto` (`id_checklist`, `id_impianto`, `Data_ins`,`Utente_ins`)
		SELECT 
			checklist_id,
			`id_impianto`,
			NOW(),
			@USER_ID
		FROM checklist_model_impianto
		WHERE Id_checklist = enter_id;
		
		
		-- open the cursor
		OPEN paragraph_cursos;
		
		-- start looping
		paragrah_loop: LOOP
		-- read the name from next row into the variables 
		FETCH  paragraph_cursos INTO cursor_id;
		IF exit_loop THEN
			CLOSE paragraph_cursos;
			LEAVE paragrah_loop;
		END IF;
		
		INSERT INTO `checklist_model_paragrafo` (`id_checklist`, `nome`, `descrizione`, `ordine`, `Data_ins`,
			`Data_mod`, `Utente_ins`, Utente_mod)
		SELECT
			checklist_id,
			`nome`,
			`descrizione`,
			`ordine`,
			NOW(),
			NOW(), 
			@USER_ID, 
			@USER_ID
		FROM checklist_model_paragrafo
		WHERE id = cursor_id;	
		
		SET paragraph_id = LAST_INSERT_ID();
		
		INSERT INTO `checklist_model_elemento` (`Id_paragrafo`, `Id_checklist`, `Posizione`, `tipo_elemento`, `nome`,
			`descrizione`, `indicazioni`, `Id_elemento`, `Data_ins`, `Data_mod`, `Utente_ins`, `Utente_mod`)
		SELECT
			paragraph_id,
			checklist_id,
			`Posizione`,
			`tipo_elemento`,
			`nome`,
			`descrizione`,
			`indicazioni`,
			`Id_elemento`,
			NOW(),
			NOW(), 
			@USER_ID, 
			@USER_ID
		FROM checklist_model_elemento
		WHERE id_paragrafo = cursor_id;
			
		END LOOP paragrah_loop;

		
	ELSE 
		SET Result = -4; -- checklist not found		
	END IF; 
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementDefValueDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementDefValueDelete`( 
	IN element_id INT(11),
	OUT result INT(11)
)
BEGIN


	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	DELETE FROM checklist_model_elemento_def_valore 
	WHERE Id_elemento = element_id;
	
	SET Result = 1;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementDefValueGet
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementDefValueGet`( 
)
BEGIN
	SELECT 	
		IFNULL(checklist_model_elemento_def_valore.Id, -1) AS Id,
		checklist_model_elemento_def_valore.id_elemento,
		tipo_checklist_model_elemento_def_valore.Id as Id_tipo_def_val,
		tipo_checklist_model_elemento_def_valore.Nome AS Label,
		tipo_checklist_model_elemento_def_valore.Field As Field,
		tipo_checklist_model_elemento_def_valore.Field_type As Field_type,
		checklist_model_elemento_def_valore.Value,
		IFNULL(checklist_model_elemento_def_valore.Data_mod, NOW()) AS Data_mod,
		IFNULL(Utente_mod, @USER_ID) AS Utente_mod
	FROM checklist_model_elemento_def_valore
		INNER JOIN tipo_checklist_model_elemento_def_valore
		ON checklist_model_elemento_def_valore.Id_tipo_def_val = tipo_checklist_model_elemento_def_valore.Id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementDefValueGetByElement
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementDefValueGetByElement`( 
	IN element_id INT(11), 
	IN element_type INT(11)
)
BEGIN
	SELECT 	
		IFNULL(checklist_model_elemento_def_valore.Id, -1) AS Id,
		element_id AS id_elemento,
		tipo_checklist_model_elemento_def_valore.Id as Id_tipo_def_val,
		tipo_checklist_model_elemento_def_valore.Nome AS Label,
		tipo_checklist_model_elemento_def_valore.Field As Field,
		tipo_checklist_model_elemento_def_valore.Field_type As Field_type,
		checklist_model_elemento_def_valore.Value,
		IFNULL(checklist_model_elemento_def_valore.Data_mod, NOW()) AS Data_mod,
		IFNULL(Utente_mod, @USER_ID) AS Utente_mod
	FROM tipo_checklist_model_elemento_def_valore
		LEFT JOIN checklist_model_elemento_def_valore
		ON checklist_model_elemento_def_valore.Id_tipo_def_val = tipo_checklist_model_elemento_def_valore.Id
			AND checklist_model_elemento_def_valore.ID_elemento = element_id
	WHERE Id_tipo = element_type;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementDefValueInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementDefValueInsert`( 
	IN field VARCHAR(100),
	IN label VARCHAR(100),
	IN value MEDIUMTEXT,
	IN element_id INT(11),
	IN element_type INT(11),
	OUT result INT(11)
)
BEGIN

	
	SET Result = 0;

	SELECT COUNT(Id) 
		INTO Result
	FROM checklist_model_elemento 
	WHERE Id = element_id; 

	IF Result = 0 THEN
		SET Result = -1; -- element not found
	END IF;
	
	IF Result >= 0 THEN
	
		INSERT INTO checklist_model_elemento_def_valore 
		SET 
	      `Id_elemento` = element_id,
		  `Id_tipo_def_val` = element_type,
	      `Label` = label,
	      `Field` = field,
	      `Value` = value,
	      `Data_mod` = NOW(),
	      `Utente_mod` = @USER_ID;
		 
		 SET Result  = LAST_INSERT_ID();
		 
	END IF; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementDefValueUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementDefValueUpdate`( 
	IN field VARCHAR(100),
	IN label VARCHAR(100),
	IN value MEDIUMTEXT,
	IN element_id INT(11),
	IN element_type INT(11),
	IN enter_id INT(11),
	OUT result INT(11)
)
BEGIN


	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = 0;

	SELECT COUNT(Id) 
		INTO Result
	FROM checklist_model_elemento 
	WHERE Id = element_id; 

	IF Result = 0 THEN
		SET Result = -1; -- element not found
	END IF;
	
	IF Result >= 0 THEN
	
		UPDATE checklist_model_elemento_def_valore 
		SET 
	      `Id_elemento` = element_id,
		  `Id_tipo_def_val` = element_type,
	      `Label` = label,
	      `Field` = field,
	      `Value` = value,
	      `Data_mod` = NOW(),
	      `Utente_mod` = @USER_ID
		 WHERE Id = enter_id;
		 
	END IF; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementDelete`( 
	IN enter_id INT(11),
	OUT Result INT(11)
)
BEGIN
   
  DECLARE `_rollback` BOOL DEFAULT 0;
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
   
	SELECT COUNT(checklist_model_elemento_generico.Id_elemento)
		INTO Result
	FROM checklist_model_elemento_generico
	WHERE checklist_model_elemento_generico.Id_elemento = enter_id;
	
	IF Result > 0 THEN
		DELETE 	
		FROM checklist_model_elemento_generico
		WHERE checklist_model_elemento_generico.Id_elemento = enter_id; 
	ELSE 
		SET Result = -3; -- checklist element not found		
	END IF; 
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementGet
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementGet`( )
BEGIN
        

	SELECT checklist_model_elemento_generico.Id_elemento,
		checklist_model_elemento_generico.tipo_elemento,
		checklist_model_elemento_generico.nome, 
		checklist_model_elemento_generico.Descrizione, 
		checklist_model_elemento_generico.Indicazioni,
		checklist_model_elemento_generico.Data_mod,
		checklist_model_elemento_generico.Data_ins,
		checklist_model_elemento_generico.Utente_ins, 
		checklist_model_elemento_generico.Utente_mod 
	FROM checklist_model_elemento_generico;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementGetById`( 
	enter_id INT(11) 
)
BEGIN
        

	SELECT checklist_model_elemento_generico.Id_elemento,
		checklist_model_elemento_generico.tipo_elemento,
		checklist_model_elemento_generico.nome, 
		checklist_model_elemento_generico.Descrizione, 
		checklist_model_elemento_generico.Indicazioni,
		checklist_model_elemento_generico.Data_mod,
		checklist_model_elemento_generico.Data_ins,
		checklist_model_elemento_generico.Utente_ins, 
		checklist_model_elemento_generico.Utente_mod 
	FROM checklist_model_elemento_generico
	WHERE checklist_model_elemento_generico.Id_elemento = enter_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementGetByName`( 
	IN name VARCHAR(150) 
)
BEGIN
    
	SELECT checklist_model_elemento_generico.Id_elemento,
		checklist_model_elemento_generico.tipo_elemento,
		checklist_model_elemento_generico.nome, 
		checklist_model_elemento_generico.Descrizione, 
		checklist_model_elemento_generico.Indicazioni,
		checklist_model_elemento_generico.Data_mod,
		checklist_model_elemento_generico.Data_ins,
		checklist_model_elemento_generico.Utente_ins, 
		checklist_model_elemento_generico.Utente_mod 
	FROM checklist_model_elemento_generico
	WHERE checklist_model_elemento_generico.nome = name;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementInsert`( 
	IN element_type INT(11), 
	IN name VARCHAR(45), 
	IN description TEXT,
	IN employee_indications VARCHAR(500), 
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = -1; 
	
	SELECT COUNT(checklist_model_elemento_generico.Id_Elemento)
		INTO Result
	FROM checklist_model_elemento_generico
	WHERE 
		checklist_model_elemento_generico.tipo_elemento = element_type
		AND checklist_model_elemento_generico.nome = name
		AND checklist_model_elemento_generico.Indicazioni = employee_indications; 
	
	IF Result > 0 THEN
		SET Result = -1; -- checklist model element already exists
	ELSE
		SELECT COUNT(tipo_checklist_elemento.Id)
			INTO Result 
		FROM tipo_checklist_elemento
		WHERE tipo_checklist_elemento.Id = element_type;
		
		IF Result <= 0 THEN
			SET Result = -2; -- element type not found
		END IF; 	
	END IF; 
	
	IF Result >= 0 THEN
		INSERT INTO checklist_model_elemento_generico
		SET checklist_model_elemento_generico.tipo_elemento = element_type,
			checklist_model_elemento_generico.nome = name, 
			checklist_model_elemento_generico.descrizione = description, 
			checklist_model_elemento_generico.Indicazioni = employee_indications, 
			checklist_model_elemento_generico.Data_ins = NOW(), 
			checklist_model_elemento_generico.Data_mod = NOW(), 
			checklist_model_elemento_generico.Utente_ins = @USER_ID, 
			checklist_model_elemento_generico.Utente_mod = @USER_ID; 
			
			SET Result = LAST_INSERT_ID();
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelElementUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelElementUpdate`( 
	IN enter_id INT(11),
	IN element_type INT(11), 
	IN name VARCHAR(45), 
	IN description TEXT,
	IN employee_indications VARCHAR(500), 
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = -1; 
	
	SELECT COUNT(checklist_model_elemento_generico.Id_Elemento)
		INTO Result
	FROM checklist_model_elemento_generico
	WHERE 
		checklist_model_elemento_generico.id_elemento = enter_id; 
	
	IF Result <= 0 THEN
		SET Result = -3; -- checklist model element already exists
	ELSE
		SELECT COUNT(tipo_checklist_elemento.Id)
			INTO Result 
		FROM tipo_checklist_elemento
		WHERE tipo_checklist_elemento.Id = element_type;
		
		IF Result <= 0 THEN
			SET Result = -2; -- element type not found
		END IF; 	
	END IF; 
	
	IF Result >= 0 THEN
	
		UPDATE checklist_model_elemento_generico
		SET checklist_model_elemento_generico.tipo_elemento = element_type,
			checklist_model_elemento_generico.nome = name, 
			checklist_model_elemento_generico.descrizione = description, 
			checklist_model_elemento_generico.Indicazioni = employee_indications, 
			checklist_model_elemento_generico.Data_mod = NOW(), 
			checklist_model_elemento_generico.Utente_mod = @USER_ID
		WHERE Id_elemento = enter_id; 
			
			SET Result = 1;
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelGet
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelGet`( )
BEGIN
        

	SELECT checklist_model.id_check,
		IFNULL(checklist_model.Id_check_parent, 0) Id_check_parent,
		checklist_model.nome, 
		Checklist_model.Descrizione, 
		Checklist_model.Note,
		IFNULL(Checklist_model.tipo_impianto, 0) tipo_impianto, 
		Checklist_model.Stato,
		IFNULL(Data_mod, STR_TO_DATE('1970-01-01 00:00:00', '%Y-%m-%d')) Data_mod,
		IFNULL(Data_ins, STR_TO_DATE( '1970-01-01 00:00:00', '%Y-%m-%d')) Data_ins,
		Checklist_model.Utente_ins, 
		IFNULL(Checklist_model.Utente_mod, 0) Utente_mod 
	FROM Checklist_model
	ORDER BY Id_check desc;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelGetById`( 
	enter_id INT(11) 
)
BEGIN
        

	SELECT checklist_model.id_check,
		IFNULL(checklist_model.Id_check_parent, 0) Id_check_parent,
		checklist_model.nome, 
		Checklist_model.Descrizione, 
		Checklist_model.Note,
		IFNULL(Checklist_model.tipo_impianto, 0) tipo_impianto, 
		Checklist_model.Stato,
		IFNULL(Data_mod, STR_TO_DATE('1970-01-01 00:00:00', '%Y-%m-%d')) Data_mod,
		IFNULL(Data_ins, STR_TO_DATE( '1970-01-01 00:00:00', '%Y-%m-%d')) Data_ins,
		Checklist_model.Utente_ins, 
		IFNULL(Checklist_model.Utente_mod, 0) Utente_mod 
	FROM Checklist_model
	WHERE Checklist_model.id_check = enter_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelInsert`( 
	IN parent_id INT(11), 
	IN name VARCHAR(45),
	IN description VARCHAR(300), 
	IN notes VARCHAR(200), 
	IN system_type_id SMALLINT(6), 
	IN `status` TINYINT(4),
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = -1; 
	
	SELECT COUNT(tipo_impianto.id_tipo)
		INTO Result
	FROM tipo_impianto
	WHERE tipo_impianto.id_tipo = system_type_id; 
	
	IF Result = 0 THEN
		SET Result = -1; -- system type not found
	ELSE
		SELECT COUNT(checklist_model.id_check)
			INTO Result
		FROM checklist_model
		WHERE checklist_model.nome = name;
		
		IF Result > 0 THEN
			SET Result = -2; -- already exists checklist with this name
		ELSE 
			IF parent_id > 0 THEN 
				SELECT COUNT(checklist_model.id_check)
					INTO Result
				FROM checklist_model
				WHERE checklist_model.id_check_parent = parent_id;
				
				IF Result = 0 THEN
					SET Result = -3; -- not found parent checklist
				END IF; 
				
			END IF; 
		END IF; 
	END IF; 
	
	IF Result >= 0 THEN
		INSERT INTO checklist_model 
		SET checklist_model.Id_check_parent = IF(parent_id = 0, NULL, parent_id),
			checklist_model.nome = name, 
			checklist_model.descrizione = description, 
			checklist_model.note = notes, 
			checklist_model.tipo_impianto = system_type_id, 
			checklist_model.Stato = `status`, 
			checklist_model.Data_ins = NOW(), 
			checklist_model.Utente_ins = @USER_ID, 
			checklist_model.Utente_mod = @USER_ID; 
			
			SET Result = LAST_INSERT_ID();
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphDelete`( 
	IN enter_id INT(11),
	OUT Result INT(11)
)
BEGIN
  DECLARE checklist_id INT(11);
  
  DECLARE `_rollback` BOOL DEFAULT 0;
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
   
	SELECT COUNT(Id), Id_Checklist
		INTO Result, checklist_id
	FROM checklist_model_paragrafo
	WHERE checklist_model_paragrafo.Id = enter_id;
	
	IF Result > 0 THEN
		DELETE 	
		FROM checklist_model_paragrafo
		WHERE checklist_model_paragrafo.Id = enter_id; 
		
		CALL sp_ariesChecklistModelParagraphSortAll (checklist_id, enter_id, -1);
	ELSE 
		SET Result = -2; -- checklist paragrph not found		
	END IF; 
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphDuplicate
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphDuplicate`( 
	IN enter_id INT(11),
	OUT Result INT(11)
)
BEGIN
   
    DECLARE checklist_id INT(10) DEFAULT 0;
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
		
	SELECT id_checklist 
		INTO checklist_id
	FROM checklist_model_paragrafo
	WHERE id = enter_id;
	
	START TRANSACTION;
	
	INSERT INTO `checklist_model_paragrafo` (`id_checklist`, `nome`, `descrizione`, `ordine`, `Data_ins`,
		`Data_mod`, `Utente_ins`, Utente_mod)
	SELECT
		checklist_id,
		`nome`,
		`descrizione`,
		IFNULL((SELECT MAX(ordine) + 1 FROM checklist_model_paragrafo WHERE id_checklist = checklist_id) ,1),
		NOW(),
		NOW(), 
		@USER_ID, 
		@USER_ID
	FROM checklist_model_paragrafo
	WHERE id = enter_id;	
	
	SET Result = LAST_INSERT_ID();
	
	INSERT INTO `checklist_model_elemento` (`Id_paragrafo`, `Id_checklist`, `Posizione`, `tipo_elemento`, `nome`,
		`descrizione`, `indicazioni`, `Id_elemento`, `Data_ins`, `Data_mod`, `Utente_ins`, `Utente_mod`)
	SELECT
		Result,
		checklist_id,
		`Posizione`,
		`tipo_elemento`,
		`nome`,
		`descrizione`,
		`indicazioni`,
		`Id_elemento`,
		NOW(),
		NOW(), 
		@USER_ID, 
		@USER_ID
	FROM checklist_model_elemento
	WHERE id_paragrafo = enter_id;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphElementDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphElementDelete`( 
	IN enter_id INT(11),
	OUT Result INT(11)
)
BEGIN
  DECLARE paragraph_id INT(11);
  DECLARE `_rollback` BOOL DEFAULT 0;
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
   
	SELECT COUNT(checklist_model_elemento.Id), Id_paragrafo
		INTO Result, paragraph_id
	FROM checklist_model_elemento
	WHERE checklist_model_elemento.Id = enter_id;
	
	IF Result > 0 THEN
		DELETE 	
		FROM checklist_model_elemento
		WHERE checklist_model_elemento.Id = enter_id; 
		
		CALL sp_ariesChecklistModelParagraphElementSortAll(paragraph_id, enter_id, -1);
	ELSE 
		SET Result = -3; -- checklist paragraph element not found		
	END IF; 
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphElementGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphElementGetById`( 
	enter_id INT(11) 
)
BEGIN
        

	SELECT checklist_model_elemento.Id,
		checklist_model_elemento.Id_paragrafo,
		checklist_model_elemento.Id_checklist, 
		checklist_model_elemento.Id_elemento, 
		checklist_model_elemento.Posizione,
		checklist_model_elemento.tipo_elemento,
		checklist_model_elemento.nome, 
		checklist_model_elemento.Descrizione, 
		checklist_model_elemento.Indicazioni,
		checklist_model_elemento.Data_mod,
		checklist_model_elemento.Data_ins,
		checklist_model_elemento.Utente_ins, 
		checklist_model_elemento.Utente_mod 
	FROM checklist_model_elemento
	WHERE checklist_model_elemento.Id = enter_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphElementGetByParagraph
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphElementGetByParagraph`( 
	paragraph_id INT(11) 
)
BEGIN
        

	SELECT checklist_model_elemento.Id,
		checklist_model_elemento.Id_paragrafo,
		checklist_model_elemento.Id_checklist, 
		checklist_model_elemento.Id_elemento, 
		checklist_model_elemento.Posizione,
		checklist_model_elemento.tipo_elemento,
		checklist_model_elemento.nome, 
		checklist_model_elemento.Descrizione, 
		checklist_model_elemento.Indicazioni,
		checklist_model_elemento.Data_mod,
		checklist_model_elemento.Data_ins,
		checklist_model_elemento.Utente_ins, 
		checklist_model_elemento.Utente_mod 
	FROM checklist_model_elemento
	WHERE checklist_model_elemento.Id_paragrafo = paragraph_id
	ORDER BY Posizione;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphElementInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphElementInsert`( 
	IN paragraph_id INT(11), 
	IN element_id INT(11),
	IN `order` SMALLINT(6), 
	IN `element_type` TINYINT(4) ,
	IN `name` VARCHAR(45),
	IN `description` TEXT,
	IN `employee_indications`VARCHAR(500),
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE checklist_id INT(11); 
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	

	SELECT COUNT(checklist_model_paragrafo.Id), 
			checklist_model_paragrafo.id_checklist
		INTO Result, checklist_id
	FROM checklist_model_paragrafo
	WHERE checklist_model_paragrafo.Id = paragraph_id;
	
	IF Result = 0 THEN
		SET Result = -2; -- paragraph not found
	END IF; 	

	IF Result >= 0 THEN

		INSERT INTO checklist_model_elemento
		SET checklist_model_elemento.id_elemento = element_id,
			checklist_model_elemento.id_checklist = checklist_id, 
			checklist_model_elemento.id_paragrafo = paragraph_id, 
			checklist_model_elemento.tipo_elemento = element_type,
			checklist_model_elemento.nome = name, 
			checklist_model_elemento.Descrizione = description, 
			checklist_model_elemento.Indicazioni = employee_indications,
			checklist_model_elemento.Posizione = `order`, 
			checklist_model_elemento.Data_ins = NOW(), 
			checklist_model_elemento.Data_mod = NOW(), 
			checklist_model_elemento.Utente_ins = @USER_ID, 
			checklist_model_elemento.Utente_mod = @USER_ID; 
			
		SET Result = LAST_INSERT_ID();
		
		CALL sp_ariesChecklistModelParagraphElementSortAll(paragraph_id, Result, `order`);
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphElementSortAll
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphElementSortAll`( 
	IN `paragraph_id` INT(11),
	IN element_id INT(11), 
	IN `new_element_position` INT(11)
)
BEGIN

	If new_element_position >= 0 THEN
		UPDATE checklist_model_elemento
		SET Posizione = Posizione + 1
		WHERE (Id <> element_id AND Posizione >= new_element_position AND Id_paragrafo = paragraph_id);
	END IF;
	
	set @fakeId=0;
	UPDATE checklist_model_elemento
	SET Posizione = getFakeId()
	WHERE Id_paragrafo = paragraph_id
	ORDER BY Posizione;
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphElementUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphElementUpdate`( 
	IN enter_id INT(11),
	IN paragraph_id INT(11), 
	IN element_id INT(11),
	IN `element_type` TINYINT(4) ,
	IN `name` VARCHAR(45),
	IN `description` TEXT,
	IN `employee_indications`VARCHAR(500),
	IN `order` SMALLINT(6), 
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE checklist_id INT(11); 
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;

	SELECT COUNT(checklist_model_paragrafo.Id), 
			checklist_model_paragrafo.id_checklist
		INTO Result, checklist_id
	FROM checklist_model_paragrafo
	WHERE checklist_model_paragrafo.Id = paragraph_id;
	
	IF Result = 0 THEN
		SET Result = -2; -- paragraph not found
	END IF; 	

	
	IF Result >= 0 THEN
	
		UPDATE checklist_model_elemento
		SET checklist_model_elemento.id_elemento = element_id,
			checklist_model_elemento.id_checklist = checklist_id, 
			checklist_model_elemento.id_paragrafo = paragraph_id, 
			checklist_model_elemento.Posizione = `order`, 
			checklist_model_elemento.tipo_elemento = element_type,
			checklist_model_elemento.nome = name, 
			checklist_model_elemento.Descrizione = description, 
			checklist_model_elemento.Indicazioni = employee_indications,
			checklist_model_elemento.Data_ins = NOW(), 
			checklist_model_elemento.Data_mod = NOW(), 
			checklist_model_elemento.Utente_ins = @USER_ID, 
			checklist_model_elemento.Utente_mod = @USER_ID
		WHERE id = enter_id;
		
		CALL sp_ariesChecklistModelParagraphElementSortAll(paragraph_id, enter_id, `order`);
		
		SET Result = 1;
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphGet
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphGet`( )
BEGIN
        

	SELECT checklist_model_paragrafo.id,
		checklist_model_paragrafo.id_checklist,
		checklist_model_paragrafo.nome, 
		checklist_model_paragrafo.Descrizione, 
		checklist_model_paragrafo.Ordine,
		Data_mod,
		Data_ins,
		checklist_model_paragrafo.Utente_ins, 
		Utente_mod 
	FROM checklist_model_paragrafo;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphGetByChecklistId
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphGetByChecklistId`( 
	checklist_id INT(11) 
)
BEGIN
        

	SELECT checklist_model_paragrafo.id,
		checklist_model_paragrafo.id_checklist,
		checklist_model_paragrafo.nome, 
		checklist_model_paragrafo.Descrizione, 
		checklist_model_paragrafo.Ordine,
		Data_mod,
		Data_ins,
		checklist_model_paragrafo.Utente_ins, 
		Utente_mod 
	FROM checklist_model_paragrafo
	WHERE checklist_model_paragrafo.id_checklist = checklist_id
	ORDER BY checklist_model_paragrafo.Ordine;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphGetById`( 
	IN enter_id INT(11) 
)
BEGIN
        

	SELECT checklist_model_paragrafo.id,
		checklist_model_paragrafo.id_checklist,
		checklist_model_paragrafo.nome, 
		checklist_model_paragrafo.Descrizione, 
		checklist_model_paragrafo.Ordine,
		Data_mod,
		Data_ins,
		checklist_model_paragrafo.Utente_ins, 
		Utente_mod 
	FROM checklist_model_paragrafo
	WHERE checklist_model_paragrafo.id = enter_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphInsert`( 
	IN checklist_id INT(11), 
	IN name VARCHAR(100), 
	IN description TEXT,
	IN `order` SMALLINT(6), 
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = -1; 
	
	SELECT COUNT(checklist_model.Id_check)
		INTO Result
	FROM checklist_model
	WHERE checklist_model.Id_check = checklist_id; 
	
	IF Result = 0 THEN
		SET Result = -1; -- checklist not found
	END IF; 
	
	IF Result >= 0 THEN
		SET Result = 0;
	
		INSERT INTO checklist_model_paragrafo 
		SET checklist_model_paragrafo.id_checklist = checklist_id,
			checklist_model_paragrafo.nome = name, 
			checklist_model_paragrafo.descrizione = description, 
			checklist_model_paragrafo.ordine = `order`, 
			checklist_model_paragrafo.Data_ins = NOW(), 
			checklist_model_paragrafo.Utente_ins = @USER_ID, 
			checklist_model_paragrafo.Utente_mod = @USER_ID; 
			
		SET Result = LAST_INSERT_ID();
				
		CALL sp_ariesChecklistModelParagraphSortAll(checklist_id, Result, `order`);
		
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphSortAll
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphSortAll`( 
	IN checklist_id INT(11),
	IN paragraph_id INT(11), 
	IN new_paragraph_position INT(11)
)
BEGIN

	If new_paragraph_position >= 0 THEN
		UPDATE checklist_model_paragrafo
		SET Ordine = Ordine + 1
		WHERE (Id <> paragraph_id AND Ordine >= new_paragraph_position AND Id_checklist = checklist_id);
	END IF;
	
	set @fakeId=0;
	UPDATE checklist_model_paragrafo
	SET Ordine = getFakeId()
	WHERE Id_checklist = checklist_id
	ORDER BY Ordine;
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelParagraphUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelParagraphUpdate`( 
	IN paragraph_id INT(11), 
	IN checklist_id INT(11), 
	IN name VARCHAR(100), 
	IN description TEXT,
	IN `order` SMALLINT(6), 
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE old_order INT(11) DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = -1; 
	
	SELECT COUNT(checklist_model.Id_check)
		INTO Result
	FROM checklist_model
	WHERE checklist_model.Id_check = checklist_id; 
	
	IF Result = 0 THEN
		SET Result = -1; -- checklist not found
	END IF; 
	
	
	IF Result >= 0 THEN
	
		UPDATE checklist_model_paragrafo 
		SET checklist_model_paragrafo.id_checklist = checklist_id,
			checklist_model_paragrafo.nome = name, 
			checklist_model_paragrafo.descrizione = description, 
			checklist_model_paragrafo.ordine = `order`, 
			checklist_model_paragrafo.Utente_mod = @USER_ID
		WHERE checklist_model_paragrafo.Id = paragraph_id; 	
		
		CALL sp_ariesChecklistModelParagraphSortAll(checklist_id, paragraph_id, `order`);
		
		SET Result = 1;
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelPragraphElementGet
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelPragraphElementGet`( )
BEGIN
        

	SELECT checklist_model_elemento.Id,
		checklist_model_elemento.Id_paragrafo,
		checklist_model_elemento.Id_checklist, 
		checklist_model_elemento.Id_elemento, 
		checklist_model_elemento.Posizione,
		checklist_model_elemento.tipo_elemento,
		checklist_model_elemento.nome, 
		checklist_model_elemento.Descrizione, 
		checklist_model_elemento.Indicazioni,
		checklist_model_elemento.Data_mod,
		checklist_model_elemento.Data_ins,
		checklist_model_elemento.Utente_ins, 
		checklist_model_elemento.Utente_mod 
	FROM checklist_model_elemento;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelSystemDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelSystemDelete`( 
	IN enter_id INT(11),
	OUT Result INT(11)
)
BEGIN
   
  DECLARE `_rollback` BOOL DEFAULT 0;
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
   
	SELECT COUNT(checklist_model_impianto.Id_elemento)
		INTO Result
	FROM checklist_model_impianto
	WHERE checklist_model_impianto.Id = enter_id;
	
	IF Result > 0 THEN
		DELETE 	
		FROM checklist_model_impianto
		WHERE checklist_model_impianto.Id = enter_id; 
	ELSE 
		SET Result = -4; -- nnot found	
	END IF; 
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelSystemDeleteByChecklist
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelSystemDeleteByChecklist`( 
	IN checklist_id INT(11)
)
BEGIN
	DELETE 	
	FROM checklist_model_impianto
	WHERE checklist_model_impianto.Id_checklist = checklist_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelSystemGet
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelSystemGet`( )
BEGIN
	SELECT checklist_model_impianto.Id,
		checklist_model_impianto.id_impianto,
		checklist_model_impianto.Id_checklist, 
		checklist_model_impianto.Data_ins,
		checklist_model_impianto.Utente_ins
	FROM checklist_model_impianto;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelSystemGetByChecklistId
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelSystemGetByChecklistId`( 
	checklist_id INT(11) 
)
BEGIN
        

	SELECT checklist_model_impianto.Id,
		checklist_model_impianto.id_impianto,
		checklist_model_impianto.Id_checklist, 
		checklist_model_impianto.Data_ins,
		checklist_model_impianto.Utente_ins
	FROM checklist_model_impianto
	WHERE checklist_model_impianto.Id_checklist = checklist_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelSystemGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelSystemGetById`( 
	enter_id INT(11) 
)
BEGIN
        

	SELECT checklist_model_impianto.Id,
		checklist_model_impianto.id_impianto,
		checklist_model_impianto.Id_checklist, 
		checklist_model_impianto.Data_ins,
		checklist_model_impianto.Utente_ins
	FROM checklist_model_impianto
	WHERE checklist_model_impianto.Id = enter_id;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelSystemInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelSystemInsert`( 
	IN system_id INT(11), 
	IN checklist_id INT(11),
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE checklist_id INT(11); 
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	
	SELECT COUNT(checklist_model_impianto.Id)
		INTO Result
	FROM checklist_model_impianto
	WHERE 
		checklist_model_impianto.id_impianto = system_id AND checklist_model_impianto.id_checklist = checklist_id; 
	
	IF Result > 0 THEN
		SET Result = -1; -- System already associated
	ELSE
		SELECT COUNT(impianto.Id)
			INTO Result
		FROM impianto
		WHERE impianto.Id_impianto = system_id;
		
		IF Result = 0 THEN
			SET Result = -2; -- system not found
		ELSE	
			SELECT COUNT(Checklist_model.Id_check) 
				INTO Result
			FROM Checklist_model
			WHERE Checklist_model.Id_check = checklist_id;
			
			IF Result = 0 THEN
				SET Result = -3; -- checklist not found
			END IF; 
		END IF; 	
	END IF; 
	
	IF Result >= 0 THEN
		INSERT INTO checklist_model_impianto
		SET checklist_model_impianto.id_impianto = system_id,
			checklist_model_impianto.id_checklist = checklist_id, 
			checklist_model_impianto.Data_ins = NOW(), 
			checklist_model_impianto.Utente_ins = @USER_ID; 
			
			SET Result = LAST_INSERT_ID();
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesChecklistModelUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesChecklistModelUpdate`( 
	IN enter_id INT(11), 
	IN parent_id INT(11), 
	IN name VARCHAR(45),
	IN description VARCHAR(300), 
	IN notes VARCHAR(200), 
	IN system_type_id SMALLINT(6), 
	IN `status` TINYINT(4),
	OUT result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = -1; 
	
	SELECT COUNT(tipo_impianto.id_tipo)
		INTO Result
	FROM tipo_impianto
	WHERE tipo_impianto.id_tipo = system_type_id; 
	
	IF Result = 0 THEN
		SET Result = -1; -- system type not found
	ELSE
		SELECT COUNT(checklist_model.id_check)
			INTO Result
		FROM checklist_model
		WHERE checklist_model.nome = name and checklist_model.id_check <> enter_id;
		
		IF Result > 0 THEN
			SET Result = -2; -- already exists checklist with this name
		ELSE 
			IF parent_id > 0 THEN 
				SELECT COUNT(checklist_model.id_check)
					INTO Result
				FROM checklist_model
				WHERE checklist_model.id_check_parent = parent_id;
				
				IF Result = 0 THEN
					SET Result = -3; -- not found parent checklist
				END IF; 
				
			END IF; 
		END IF; 
	END IF; 
	
	IF Result >= 0 THEN
		UPDATE checklist_model 
		SET checklist_model.Id_check_parent = IF(parent_id = 0, NULL, parent_id),
			checklist_model.nome = name, 
			checklist_model.descrizione = description, 
			checklist_model.note = notes, 
			checklist_model.tipo_impianto = system_type_id, 
			checklist_model.Stato = `status`, 
			checklist_model.Data_mod = NOW(), 
			checklist_model.Utente_mod = @USER_ID
		WHERE checklist_model.id_check = enter_id;
			
			SET Result = 1;
	END IF; 
		
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCompanyGet
DELIMITER //
CREATE PROCEDURE `sp_ariesCompanyGet`( 
)
BEGIN
	SELECT id_azienda as "id_azienda",
	IFNULL(titolare, "") as "titolare",
	IFNULL(ragione_sociale, "") as "ragione_sociale",
	IFNULL(settore, "") as "settore",
	IFNULL(indirizzo, "") as "indirizzo",
	IFNULL(comune, "") as "comune",
	IFNULL(provincia, "") as "provincia",
	IFNULL(telefono, "") as "telefono",
	cellulare as "cellulare",
	IFNULL(partita_iva, "") as "partita_iva",
	IFNULL(regImprese, 0) as "regImprese",
	IFNULL(alboProvinciale, 0) as "alboProvinciale",
	IFNULL(ciaa, "") as "ciaa",
	IFNULL(ciaa_n, "") as "ciaa_n",
	IFNULL(albo_provincia, "") as "albo_provincia",
	IFNULL(albo_n, "") as "albo_n",
	IFNULL(numero, "") as "numero",
	IFNULL(sito_internet, "") as "sito_internet",
	IFNULL(fax, "") as "fax",
	IFNULL(e_mail, "") as "e_mail",
	IFNULL(cod_fis, "") as "cod_fis",
	IFNULL(numero_rea, "") as "numero_rea",
	IFNULL(posizione_inps, "") as "posizione_inps",
	IFNULL(posizione_inail, "") as "posizione_inail",
	IFNULL(codice_ateco, "") as "codice_ateco",
	IFNULL(assicu_rct, "") as "assicu_rct",
	IFNULL(frazione, "") as "frazione",
	IFNULL(capi_soc, "") as "capi_soc",
	data as "data",
	IFNULL(abilitazione, "") as "abilitazione",
	IFNULL(smtp, "") as "smtp",
	IFNULL(porta, 0) as "porta",
	mssl as "mssl",
	IFNULL(utente_mail, "") as "utente_mail",
	IFNULL(password, "") as "password",
	IFNULL(nome_mail, "") as "nome_mail",
	id_filiale,
	IFNULL(banca, "") as "banca",
	IFNULL(iban, "") as "iban",
	listino as "listino",
	sconto as "sconto",
	tipo_sconto as "tipo_sconto",
	stampa_ragione as "stampa_ragione",
	stampa_ri as "stampa_ri",
	IFNULL(giorni_promemoria, 0) as "giorni_promemoria",
	IFNULL(cap2, "") as "cap2",
	IFNULL(stampante_promemoria, "") as "stampante_promemoria",
	IFNULL(mail_amministrazione, "") as "mail_amministrazione",
	IFNULL(intestazione_promemoria, "") as "intestazione_promemoria",
	IFNULL(host_caldav, "") as "host_caldav",
	IFNULL(nome_caldav, "") as "nome_caldav",
	IFNULL(email_provider_caldav, 0) as "email_provider_caldav",
	IFNULL(license, "") as "license",
	IFNULL(abilita_convalida_rapporto, 0) as "abilita_convalida_rapporto",
	IFNULL(tele_fatt, "") as "tele_fatt",
	IFNULL(circolare_per_garanzia, "") as "circolare_per_garanzia",
	IFNULL(notifica_attesa, 0) as "notifica_attesa",
	IFNULL(passaggio_nonaccettato, 0) as "passaggio_nonaccettato",
	IFNULL(percorso_default_aggiornamento, "") as "percorso_default_aggiornamento",
	IFNULL(giorni_avviso_rapporto, 0) as "giorni_avviso_rapporto",
	IFNULL(regime_fiscale, "") as "regime_fiscale",
	IFNULL(Data_fine, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_fine,
	Data_ins, 
	Data_mod, 
	Utente_ins,
	Utente_mod
	FROM Azienda; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCompanyGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesCompanyGetById`( 
	company_id INT
)
BEGIN
	SELECT id_azienda as "id_azienda",
	IFNULL(titolare, "") as "titolare",
	IFNULL(ragione_sociale, "") as "ragione_sociale",
	IFNULL(settore, "") as "settore",
	IFNULL(indirizzo, "") as "indirizzo",
	IFNULL(comune, "") as "comune",
	IFNULL(provincia, "") as "provincia",
	IFNULL(telefono, "") as "telefono",
	cellulare as "cellulare",
	IFNULL(partita_iva, "") as "partita_iva",
	IFNULL(regImprese, 0) as "regImprese",
	IFNULL(alboProvinciale, 0) as "alboProvinciale",
	IFNULL(ciaa, "") as "ciaa",
	IFNULL(ciaa_n, "") as "ciaa_n",
	IFNULL(albo_provincia, "") as "albo_provincia",
	IFNULL(albo_n, "") as "albo_n",
	IFNULL(numero, "") as "numero",
	IFNULL(sito_internet, "") as "sito_internet",
	IFNULL(fax, "") as "fax",
	IFNULL(e_mail, "") as "e_mail",
	IFNULL(cod_fis, "") as "cod_fis",
	IFNULL(numero_rea, "") as "numero_rea",
	IFNULL(posizione_inps, "") as "posizione_inps",
	IFNULL(posizione_inail, "") as "posizione_inail",
	IFNULL(codice_ateco, "") as "codice_ateco",
	IFNULL(assicu_rct, "") as "assicu_rct",
	IFNULL(frazione, "") as "frazione",
	IFNULL(capi_soc, "") as "capi_soc",
	data as "data",
	IFNULL(abilitazione, "") as "abilitazione",
	IFNULL(smtp, "") as "smtp",
	IFNULL(porta, 0) as "porta",
	mssl as "mssl",
	IFNULL(utente_mail, "") as "utente_mail",
	IFNULL(password, "") as "password",
	IFNULL(nome_mail, "") as "nome_mail",
	id_filiale,
	IFNULL(banca, "") as "banca",
	IFNULL(iban, "") as "iban",
	listino as "listino",
	sconto as "sconto",
	tipo_sconto as "tipo_sconto",
	stampa_ragione as "stampa_ragione",
	stampa_ri as "stampa_ri",
	IFNULL(giorni_promemoria, 0) as "giorni_promemoria",
	IFNULL(cap2, "") as "cap2",
	IFNULL(stampante_promemoria, "") as "stampante_promemoria",
	IFNULL(mail_amministrazione, "") as "mail_amministrazione",
	IFNULL(intestazione_promemoria, "") as "intestazione_promemoria",
	IFNULL(host_caldav, "") as "host_caldav",
	IFNULL(nome_caldav, "") as "nome_caldav",
	IFNULL(email_provider_caldav, 0) as "email_provider_caldav",
	IFNULL(license, "") as "license",
	IFNULL(abilita_convalida_rapporto, 0) as "abilita_convalida_rapporto",
	IFNULL(tele_fatt, "") as "tele_fatt",
	IFNULL(circolare_per_garanzia, "") as "circolare_per_garanzia",
	IFNULL(notifica_attesa, 0) as "notifica_attesa",
	IFNULL(passaggio_nonaccettato, 0) as "passaggio_nonaccettato",
	IFNULL(percorso_default_aggiornamento, "") as "percorso_default_aggiornamento",
	IFNULL(giorni_avviso_rapporto, 0) as "giorni_avviso_rapporto",
	IFNULL(regime_fiscale, "") as "regime_fiscale",
	IFNULL(Data_fine, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_fine,
	Data_ins, 
	Data_mod, 
	Utente_ins,
	Utente_mod
	FROM Azienda WHERE Id_azienda = company_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCompanyGetMostRecent
DELIMITER //
CREATE PROCEDURE `sp_ariesCompanyGetMostRecent`( 
)
BEGIN
	SELECT id_azienda as "id_azienda",
	IFNULL(titolare, "") as "titolare",
	IFNULL(ragione_sociale, "") as "ragione_sociale",
	IFNULL(settore, "") as "settore",
	IFNULL(indirizzo, "") as "indirizzo",
	IFNULL(comune, "") as "comune",
	IFNULL(provincia, "") as "provincia",
	IFNULL(telefono, "") as "telefono",
	cellulare as "cellulare",
	IFNULL(partita_iva, "") as "partita_iva",
	IFNULL(regImprese, 0) as "regImprese",
	IFNULL(alboProvinciale, 0) as "alboProvinciale",
	IFNULL(ciaa, "") as "ciaa",
	IFNULL(ciaa_n, "") as "ciaa_n",
	IFNULL(albo_provincia, "") as "albo_provincia",
	IFNULL(albo_n, "") as "albo_n",
	IFNULL(numero, "") as "numero",
	IFNULL(sito_internet, "") as "sito_internet",
	IFNULL(fax, "") as "fax",
	IFNULL(e_mail, "") as "e_mail",
	IFNULL(cod_fis, "") as "cod_fis",
	IFNULL(numero_rea, "") as "numero_rea",
	IFNULL(posizione_inps, "") as "posizione_inps",
	IFNULL(posizione_inail, "") as "posizione_inail",
	IFNULL(codice_ateco, "") as "codice_ateco",
	IFNULL(assicu_rct, "") as "assicu_rct",
	IFNULL(frazione, "") as "frazione",
	IFNULL(capi_soc, "") as "capi_soc",
	data as "data",
	IFNULL(abilitazione, "") as "abilitazione",
	IFNULL(smtp, "") as "smtp",
	IFNULL(porta, 0) as "porta",
	mssl as "mssl",
	IFNULL(utente_mail, "") as "utente_mail",
	IFNULL(password, "") as "password",
	IFNULL(nome_mail, "") as "nome_mail",
	id_filiale,
	IFNULL(banca, "") as "banca",
	IFNULL(iban, "") as "iban",
	listino as "listino",
	sconto as "sconto",
	tipo_sconto as "tipo_sconto",
	stampa_ragione as "stampa_ragione",
	stampa_ri as "stampa_ri",
	IFNULL(giorni_promemoria, 0) as "giorni_promemoria",
	IFNULL(cap2, "") as "cap2",
	IFNULL(stampante_promemoria, "") as "stampante_promemoria",
	IFNULL(mail_amministrazione, "") as "mail_amministrazione",
	IFNULL(intestazione_promemoria, "") as "intestazione_promemoria",
	IFNULL(host_caldav, "") as "host_caldav",
	IFNULL(nome_caldav, "") as "nome_caldav",
	IFNULL(email_provider_caldav, 0) as "email_provider_caldav",
	IFNULL(license, "") as "license",
	IFNULL(abilita_convalida_rapporto, 0) as "abilita_convalida_rapporto",
	IFNULL(tele_fatt, "") as "tele_fatt",
	IFNULL(circolare_per_garanzia, "") as "circolare_per_garanzia",
	IFNULL(notifica_attesa, 0) as "notifica_attesa",
	IFNULL(passaggio_nonaccettato, 0) as "passaggio_nonaccettato",
	IFNULL(percorso_default_aggiornamento, "") as "percorso_default_aggiornamento",
	IFNULL(giorni_avviso_rapporto, 0) as "giorni_avviso_rapporto",
	IFNULL(regime_fiscale, "") as "regime_fiscale",
	IFNULL(Data_fine, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_fine,
	Data_ins, 
	Data_mod, 
	Utente_ins,
	Utente_mod
	FROM Azienda ORDER BY Id_azienda DESC LIMIT 1; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCountryDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesCountryDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM Nazione 
	WHERE id_Nazione = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCountryGet
DELIMITER //
CREATE PROCEDURE `sp_ariesCountryGet`( 
)
BEGIN
	SELECT Id_nazione,
	Nome,
	sigla,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Nazione
	ORDER BY Id_nazione;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCountryGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesCountryGetById`( 
	Country_id INT
)
BEGIN
	SELECT Id_nazione,
	Nome,
	sigla,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Nazione
	WHERE Id_nazione = Country_id
	ORDER BY Id_nazione;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCountryGetByMunicipality
DELIMITER //
CREATE PROCEDURE `sp_ariesCountryGetByMunicipality`( 
	municipality_id INT
)
BEGIN


	DECLARE countryId INT(11); 
	
	SELECT Nazione.Id_nazione 
		into countryId 
	FROM comune
		INNER JOIN province ON comune.id_provincia = province.id_provincia 
		INNER JOIN regione ON Regione.id_regione = province.Regione 
		INNER JOIN Nazione on id_nazione = regione.nazione
	WHERE comune.Id_comune = municipality_id; 

	CALL sp_ariesCountryGetById(countryId);

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCountryGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesCountryGetByName`( 
	name VARCHAR(30)
)
BEGIN
	SELECT Id_nazione,
	Nome,
	sigla,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Nazione
	WHERE Nome = name
	ORDER BY Id_nazione;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCountryInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesCountryInsert`( 
	name VARCHAR(45),
	abbreviation varchar(10),
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT Count(id_nazione) INTO Result
	FROM Nazione 
	WHERE Nome = Name; 
	
	IF Result > 0 THEN
		 SET Result = -1; # Country name already exists
	END IF;

	
	IF Result = 0 THEN
		INSERT INTO Nazione 
		SET 
			Nome = name,
			sigla = Abbreviation, 
			Data_ins = NOW(), 
			Data_mod = NOW(), 
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCountryUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesCountryUpdate`( 
	enter_id INTEGER,
	name VARCHAR(45),
	abbreviation varchar(10),
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT Count(Id_nazione) INTO Result
	FROM Nazione 
	WHERE Nome = Name AND Id_nazione != enter_id; 
	
	IF Result > 0 THEN
		 SET Result = -1; # Country name already exists
	END IF;

	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM Nazione 
			WHERE id_Nazione = enter_id;
			
			IF Result = 0 THEN
				SET Result = -2; # Country ID not found							
			END IF; 
	END IF; 
	
	IF Result >0 THEN
		UPDATE Nazione 
		SET 
			Nome = name,
			sigla = Abbreviation, 
			Utente_mod = @USER_ID
		Where id_Nazione = enter_id;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCoursesCreateEvents
DELIMITER //
CREATE PROCEDURE `sp_ariesCoursesCreateEvents`(
	IN course_id INT(11),
	OUT result INT (11)
)
BEGIN
	DECLARE event_group_id INT;
	DECLARE event_id INT;
	DECLARE resul BIT;
	DECLARE course_description VARCHAR(145);
	DECLARE course_topics MEDIUMTEXT;
	DECLARE course_speaker VARCHAR(45);
	DECLARE course_start_date DATE;
	DECLARE course_end_date DATE;
	DECLARE course_start_time TIME;
	DECLARE course_end_time TIME;
	DECLARE course_duration_months INT;
	DECLARE course_expiration_date DATE;
	DECLARE course_date_loop DATE;

	SELECT 
		corso.`descrizione`,
		corso.`argomenti`,
		corso.`relatore`,
		corso.`data_inizio`,
		corso.`data_fine`,
		corso.`ora_inizio`,
		corso.`ora_fine`,
		tipo_corso.`durata`
	INTO
		course_description,
		course_topics,
		course_speaker,
		course_start_date,
		course_end_date,
		course_start_time,
		course_end_time,
		course_duration_months
	FROM corso
		INNER JOIN tipo_corso ON corso.id_tipo = tipo_corso.id_tipo
	WHERE id_corso = course_id;

	IF (course_duration_months IS NOT NULL AND course_duration_months != 0) THEN

		SET course_expiration_date = DATE_ADD(course_end_date, INTERVAL course_duration_months MONTH);

		CALL sp_ariesEventGroupInsert(
			CONCAT('CORSO: ', course_description),
			CONCAT(
				'CORSO: ', course_description, '\n',
				'RELATORE: ', IFNULL(course_speaker, ''), '\n',
				'ARGOMENTI: ', IFNULL(course_topics, ''), '\n'
			),
			5, 
			1, -- opened 
			CONCAT(course_start_date, ' ', course_start_time),
			CONCAT(course_end_date, ' ', course_end_time),
			null,
			null,
			event_group_id
		);

		CALL sp_ariesEventInsert(
			CONCAT('PROMEM. SCADENZA CORSO 1 MESE', course_description),
			CONCAT('La validità del corso "', course_description, '" scadrà tra un mese.'),
			NULL,
			event_group_id,
			5,
			0,
			0,
			0,
			0,
			DATE_ADD(course_expiration_date, INTERVAL -1 MONTH),
			'09:00:00',
			'10:00:00',
			NULL,
			result,
			event_id
		);
		INSERT INTO evento_operaio (id_evento, id_operaio, Utente_ins, Utente_mod, Data_ins, Data_mod)
		SELECT event_id, id_operaio, @USER_ID, @USER_ID, NOW(), NOW() FROM operaio_corso WHERE id_corso = course_id;

		
		CALL sp_ariesEventInsert(
			CONCAT('PROMEM. SCADENZA CORSO 3 MESI', course_description),
			CONCAT('La validità del corso "', course_description, '" scadrà tra tre mesi.'),
			NULL,
			event_group_id,
			5,
			0,
			0,
			0,
			0,
			DATE_ADD(course_expiration_date, INTERVAL -3 MONTH),
			'09:00:00',
			'10:00:00',
			NULL,
			result,
			event_id
		);
		INSERT INTO evento_operaio (id_evento, id_operaio, Utente_ins, Utente_mod, Data_ins, Data_mod)
		SELECT event_id, id_operaio, @USER_ID, @USER_ID, NOW(), NOW() FROM operaio_corso WHERE id_corso = course_id;

		CALL sp_ariesEventInsert(
			CONCAT('SCADENZA CORSO ', course_description),
			CONCAT('La validità del corso "', course_description, '" è scaduta.'),
			NULL,
			event_group_id,
			5,
			0,
			0,
			0,
			0,
			course_expiration_date,
			'09:00:00',
			'10:00:00',
			NULL,
			result,
			event_id
		);
		INSERT INTO evento_operaio (id_evento, id_operaio, Utente_ins, Utente_mod, Data_ins, Data_mod)
		SELECT event_id, id_operaio, @USER_ID, @USER_ID, NOW(), NOW() FROM operaio_corso WHERE id_corso = course_id;


		SET course_date_loop = course_start_date;

		WHILE(course_date_loop <= course_end_date) DO

			CALL sp_ariesEventInsert(
				CONCAT('CORSO: ', course_description),
				CONCAT(
					'CORSO: ', course_description, '\n',
					'RELATORE: ', IFNULL(course_speaker, ''), '\n',
					'ARGOMENTI: ', IFNULL(course_topics, ''), '\n'
				),
				NULL,
				event_group_id,
				5,
				0,
				0,
				0,
				0,
				course_date_loop,
				course_start_time,
				course_end_time,
				NULL,
				result,
				event_id
			);

			INSERT INTO evento_operaio (id_evento, id_operaio, Utente_ins, Utente_mod, Data_ins, Data_mod)
			SELECT event_id, id_operaio, @USER_ID, @USER_ID, NOW(), NOW() FROM operaio_corso WHERE id_corso = course_id;

			SET course_date_loop = DATE_ADD(course_date_loop, INTERVAL 1 DAY);
		END WHILE;

		UPDATE corso SET id_evento_gruppo = event_group_id WHERE id_corso = course_id; 
	END IF;

	SET result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCoursesDeleteEvents
DELIMITER //
CREATE PROCEDURE `sp_ariesCoursesDeleteEvents`(
	IN course_id INT(11),
	OUT result INT(11)
)
BEGIN
	DECLARE event_id INT;
	DECLARE event_group_id INT;
	DECLARE done INT DEFAULT 0;


	DECLARE V_curA CURSOR FOR
		SELECT id_evento
		FROM evento_gruppo_evento
		WHERE id_gruppo_evento = (
			SELECT 
				`id_evento_gruppo`
			FROM corso
			WHERE id_corso = course_id
		);
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO event_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;

		IF event_id IS NOT NULL THEN
			CALL sp_ariesEventEmployeeDeleteByEventId(event_id, result);
			CALL sp_ariesEventDelete(event_id, result);
		END IF;
	END LOOP;
	CLOSE V_curA;
	
	SELECT 
		`id_evento_gruppo`
	INTO
		event_group_id
	FROM corso
	WHERE id_corso = course_id;
	
	IF event_group_id IS NOT NULL THEN
		CALL sp_ariesEventGroupDelete(event_group_id, result);
		UPDATE corso SET id_evento_gruppo = NULL WHERE id_corso = course_id; 
	END IF;
	
	SET result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCoursesUpdateVerification
DELIMITER //
CREATE PROCEDURE `sp_ariesCoursesUpdateVerification`(
	IN course_id INT (11),
	OUT is_verified BIT(1)
)
BEGIN
	DECLARE current_is_verified BIT(1);
	DECLARE new_is_verified BIT(1) DEFAULT 0;
	DECLARE verification_required BIT (1);

	DECLARE number_of_employees INT(11) DEFAULT 0;
	DECLARE number_of_verified_employees INT(11) DEFAULT 0;

	SELECT richiede_verifica,
		verificato
	INTO
		verification_required,
		current_is_verified
	FROM corso
	WHERE id_corso = course_id;

	IF verification_required = False THEN
		SET new_is_verified = 1;
	ELSE 

		SELECT COUNT(passato),
			SUM(IF(passato = 1, 1, 0))
		INTO
			number_of_employees,
			number_of_verified_employees
		FROM operaio_corso
		WHERE id_corso = course_id;

		SET new_is_verified = (number_of_employees = number_of_verified_employees);

	END IF;

	IF new_is_verified != current_is_verified THEN
		UPDATE corso
		SET verificato = new_is_verified
		WHERE id_corso = course_id;
	END IF;

	SET is_verified = new_is_verified;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomeClone
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomeClone`(
	IN customer_id INT, 
	OUT new_customer_id INT
)
BEGIN

  DECLARE `_rollback` BOOL DEFAULT 0;
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	

  INSERT INTO clienti(
		Ragione_Sociale, Ragione_sociale2, Partita_iva, Codice_Fiscale, e_codice_destinatario,
		Cortese_attenzione, Data_inserimento, Stato_cliente, Tipo_Cliente, stato_economico,
		condizione_pagamento, Sito_internet, password, Utente_sito, iva, modi, rc, posta, ex, tipo_rapporto,
		id_utente, id_agente, id_abbona, id_attività, pec
	)
	SELECT Ragione_Sociale, Ragione_sociale2, Partita_iva, Codice_Fiscale, e_codice_destinatario,
		Cortese_attenzione, Data_inserimento, Stato_cliente, Tipo_Cliente, stato_economico,
		condizione_pagamento, Sito_internet, password, Utente_sito, iva, modi, rc, posta, ex, 
		tipo_rapporto, @USER_ID, id_agente, id_abbona, id_attività, pec
	FROM clienti
	WHERE id_cliente = customer_id;

	SET new_customer_id = LAST_INSERT_ID();

 
  INSERT INTO destinazione_cliente(
		id_cliente, Id_destinazione, Provincia, Comune, Frazione, Indirizzo, numero_civico, Descrizione, 
		scala, Altro, Km_sede, Pedaggio, Tempo_strada, attivo, ztl, Note, Autostrada, 
		Sede_principale, dalle1, alle1, dalle2, alle2, piano, interno, id_autostrada, Data_ins, Utente_ins, Utente_mod
	)
	SELECT new_customer_id, Id_destinazione, Provincia, Comune, Frazione, Indirizzo, numero_civico, Descrizione,
		scala, Altro, Km_sede, Pedaggio, Tempo_strada, attivo, ztl, Note, Autostrada, 
		Sede_principale, dalle1, alle1, dalle2, alle2, piano, interno, id_autostrada, NOW(), @USER_ID, @USER_ID
	FROM destinazione_cliente
	WHERE id_cliente = customer_id;


  INSERT INTO riferimento_clienti(
		Id_cliente, Id_riferimento, Nome, figura, Telefono, altro_telefono,
		fax, mail, centralino, Fatturazione, titolo, nota_cli, esterno, sito, skype, rif_esterno, sito_utente, sito_passwd,
		mail_pec, riferimento_clienti.mod,idut
	)
	SELECT new_customer_id, Id_riferimento, Nome, figura, Telefono, altro_telefono,
		fax, mail, centralino, Fatturazione, titolo, nota_cli, esterno, sito, skype, rif_esterno, sito_utente, sito_passwd,
		mail_pec, riferimento_clienti.mod, @USER_ID
	FROM riferimento_clienti
	WHERE id_cliente = customer_id;

  INSERT INTO clienti_banche (Id_cliente, Id_filiale, data_inizio, data_fine, Iban)
	select new_customer_id, Id_filiale, data_inizio, data_fine, Iban
	FROM clienti_banche
	WHERE id_cliente = customer_id;

  INSERT INTO cliente_nota (Id_cliente, Id_nota, Descrizione, data_ult_modifica)
	SELECT new_customer_id, Id_nota, Descrizione, data_ult_modifica
	FROM cliente_nota
	WHERE id_cliente = customer_id;

  UPDATE impianto SET id_cliente = new_customer_id WHERE id_cliente = customer_id;
  UPDATE impianto SET id_occupante = new_customer_id WHERE id_occupante = customer_id;
  UPDATE impianto SET id_gestore = new_customer_id WHERE id_gestore = customer_id;


  UPDATE ticket SET id_cliente = new_customer_id WHERE id_cliente = customer_id;


  UPDATE clienti
	SET stato_cliente=(SELECT id_stato FROM stato_clienti WHERE nome="VARIATO")
	WHERE id_cliente = customer_id;

		
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET new_customer_id = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerContactsGet
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerContactsGet`()
BEGIN
	SELECT 
		Id, 
		Id_pubblico,
		Id_cliente, 
		Id_riferimento, 
		Nome, 
		Figura, 
		Telefono, 
		altro_telefono, 
		fax, 
		mail,
		centralino, 
		IF(Fatturazione = 1, 1, 0) AS 'Fatturazione',
		titolo, 
		nota_cli, 
		esterno, 
		sito, 
		skype, 
		rif_esterno, 
		sito_utente, 
		sito_passwd, 
		mail_pec, 
		`mod`, 
		IFNULL(idut, 0) "idut",
		Promemoria_cliente
	FROM riferimento_clienti;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerContactsGetByCustomerId
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerContactsGetByCustomerId`(
	IN customer_id INT
)
BEGIN
	SELECT 
		Id, 
		Id_pubblico,
		Id_cliente, 
		Id_riferimento, 
		Nome, 
		Figura, 
		Telefono, 
		altro_telefono, 
		fax, 
		mail,
		centralino, 
		IF(Fatturazione = 1, 1, 0) AS 'Fatturazione',
		titolo, 
		nota_cli, 
		esterno, 
		sito, 
		skype, 
		rif_esterno, 
		sito_utente, 
		sito_passwd, 
		mail_pec, 
		`mod`, 
		IFNULL(idut, 0) "idut",
		Promemoria_cliente
	FROM riferimento_clienti
	WHERE Id_cliente = customer_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerContactsGetByCustomerIdAndContactsId
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerContactsGetByCustomerIdAndContactsId`(
	IN customer_id INT,
	IN contacts_id INT
)
BEGIN
	SELECT 
		Id, 
		Id_pubblico,
		Id_cliente, 
		Id_riferimento, 
		Nome, 
		Figura, 
		Telefono, 
		altro_telefono, 
		fax, 
		mail,
		centralino, 
		IF(Fatturazione = 1, 1, 0) AS 'Fatturazione',
		titolo, 
		nota_cli, 
		esterno, 
		sito, 
		skype, 
		rif_esterno, 
		sito_utente, 
		sito_passwd, 
		mail_pec, 
		`mod`, 
		IFNULL(idut, 0) "idut",
		Promemoria_cliente
	FROM riferimento_clienti
	WHERE Id_cliente = customer_id AND Id_riferimento = contacts_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerContactsGetByCustomerIds
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerContactsGetByCustomerIds`(
	IN customer_ids MEDIUMTEXT
)
BEGIN

	SELECT 
		Id, 
		Id_pubblico,
		Id_cliente, 
		Id_riferimento, 
		Nome, 
		Figura, 
		Telefono, 
		altro_telefono, 
		fax, 
		mail,
		centralino, 
		IF(Fatturazione = 1, 1, 0) AS 'Fatturazione',
		titolo, 
		nota_cli, 
		esterno, 
		sito, 
		skype, 
		rif_esterno, 
		sito_utente, 
		sito_passwd, 
		mail_pec, 
		`mod`, 
		IFNULL(idut, 0) "idut",
		Promemoria_cliente
	FROM riferimento_clienti
	WHERE FIND_IN_SET(Id_cliente, customer_ids) > 0;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerContactsGetByEmailGroupToSend
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerContactsGetByEmailGroupToSend`(
	IN email_group_id INT(11), 
	IN email_id INT(11)
)
BEGIN

	SELECT 
		Id, 
		Id_pubblico,
		riferimento_clienti.Id_cliente, 
		riferimento_clienti.Id_riferimento, 
		riferimento_clienti.Nome, 
		Figura, 
		Telefono, 
		altro_telefono, 
		fax, 
		mail,
		centralino, 
		IF(Fatturazione = 1, 1, 0) AS 'Fatturazione',
		titolo, 
		nota_cli, 
		esterno, 
		sito, 
		skype, 
		rif_esterno, 
		sito_utente, 
		sito_passwd, 
		mail_pec, 
		`mod`, 
		IFNULL(idut, 0) "idut",
		Promemoria_cliente
	FROM mail_gruppo_cliente
		INNER JOIN riferimento_clienti ON mail_gruppo_cliente.id_cliente = riferimento_clienti.id_cliente
			AND mail_gruppo_cliente.Id_riferimento = riferimento_clienti.Id_riferimento
			
		LEFT JOIN mail_gruppo_inviate ON mail_gruppo_inviate.id_mail = email_id
			AND mail_gruppo_cliente.id_cliente = mail_gruppo_inviate.id_cliente
			AND mail_gruppo_cliente.Id_riferimento = mail_gruppo_inviate.Id_riferimento	
				
	WHERE mail_gruppo_cliente.id_gruppo = email_group_id AND mail_gruppo_inviate.stato IS NULL; 
	  
		
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerContactsSetAsBilling
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerContactsSetAsBilling`(
	IN customer_id INT,
	IN contact_id INT, 
	OUT result INT
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	UPDATE riferimento_clienti 
	SET Fatturazione = 1, 
		IDUT = @USER_ID
	WHERE Id_cliente = customer_id AND
			Id_riferimento = contact_id; 
	
	UPDATE riferimento_clienti 
	SET Fatturazione = 0, 
		IDUT = @USER_ID
	WHERE Id_cliente = customer_id AND
			Id_riferimento <> contact_id;
			
	SET Result = 1; 
	

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerDestinationGet
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerDestinationGet`()
BEGIN
	SELECT 
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE('1970-01-01 00:00:00', '%y-%m-&d %h:%i:%s')) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerDestinationGetByCustomerId
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerDestinationGetByCustomerId`(
	IN customer_id INT
)
BEGIN
	SELECT 
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE('1970-01-01 00:00:00', '%y-%m-&d %h:%i:%s')) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente
	WHERE Id_cliente = customer_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerDestinationGetByCustomerIdAndDestinationId
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerDestinationGetByCustomerIdAndDestinationId`(
	IN customer_id INT,
	IN destination_id INT
)
BEGIN
	SELECT 
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE('1970-01-01 00:00:00', '%y-%m-&d %h:%i:%s')) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente
	WHERE Id_cliente = customer_id AND Id_destinazione = destination_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerDestinationGetByCustomerIds
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerDestinationGetByCustomerIds`(
	IN customer_ids MEDIUMTEXT
)
BEGIN

	SELECT DISTINCT
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE("1970-01-01 00:00:00", "%y-%m-&d %h:%i:%s")) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente
	WHERE FIND_IN_SET(Id_cliente,customer_ids) > 0;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerDestinationGetWithoutDistanceAndTime
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerDestinationGetWithoutDistanceAndTime`()
BEGIN
	SELECT 
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE('1970-01-01 00:00:00', '%y-%m-&d %h:%i:%s')) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente
	WHERE (Km_sede = 0 
		and Tempo_strada = 0 
		and comune IS NOT NULL 
		and indirizzo IS NOT NULL 
		and indirizzo <> "");
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerDestinationInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerDestinationInsert`(
  IN customer_id INT(11),
  IN province VARCHAR(5),
  IN municipality_id INT(11),
  IN district_id INT(11),
  IN street VARCHAR(50),
  IN street_number SMALLINT(6),
  IN description VARCHAR(105),
  IN stair VARCHAR(6),
  IN other VARCHAR(9),
  IN distance SMALLINT(6),
  IN toll DECIMAL(11,2),
  IN trip_time SMALLINT(6),
  IN is_active BIT,
  IN is_limited_traffic_zone BIT,
  IN notes TEXT,
  IN has_speedway BIT,
  IN is_main_destination BIT,
  IN from_morning TIME,
  IN to_morning TIME,
  IN from_afternoon TIME,
  IN to_afternoon TIME,
  IN floor TINYINT,
  IN intern TINYINT,
  IN speedway_id INT,
  IN latitude DECIMAL (11,8),
  IN longitude DECIMAL (11,8),
  OUT result INT,
  OUT destination_id INT
)
BEGIN
	
	DECLARE tmp_province VARCHAR(5) DEFAULT NULL;
	DECLARE tmp_municipality_id INT(11) DEFAULT NULL;
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SELECT COUNT(Id_cliente)
		INTO result 
	FROM clienti 
	WHERE Id_cliente = customer_id; 
	
	IF result = 0 THEN
		SET result = -1; -- customer not found
	ELSE
	
		IF province IS NOT NULL THEN
		
		  SELECT COUNT(province.Sigla)
		 	INTO result
		  FROM province 
		  WHERE province.Sigla = province;
		    
		END IF; 
		
		IF result = 0 THEN
			SET result = -7; -- province not found
		ELSE
			IF municipality_id IS NOT NULL THEN
			
				SELECT COUNT(Id_comune), comune.provincia
					INTO result, tmp_province 
				FROM comune 
				WHERE comune.Id_comune = municipality_id; 
				
				IF result = 0 THEN
					SET result = -2; -- municipality not found
				ELSE
					IF province <> tmp_province THEN
						SET result = -3; -- invalid province by municipality id
					END IF;			
				END IF; 
				
				IF result > 0 AND district_id IS NOT NULL THEN
				
					SELECT COUNT(Id_frazione), frazione.Id_comune
						INTO result, tmp_municipality_id 
					FROM frazione 
					WHERE frazione.Id_frazione = district_id; 
					
					IF result = 0 THEN
						SET result = -4; -- distirct not found
					ELSE
						IF municipality_id <> tmp_municipality_id THEN
							SET result = -5; -- invalid municipality id by destrict id
						END IF;			
					END IF; 
				
				END IF; 
				
				IF result > 0 AND speedway_id IS NOT NULL THEN
					
					SELECT id_autostrada
						INTO result
					FROM tipo_autostrada 
					WHERE tipo_autostrada.Id_tipo = speedway_id; 
	
					IF result = 0 THEN
						SET result = -6; -- speedway not found
					END IF; 
				END IF; 						
			END IF;
		END IF; 
	END IF;   		
	

	IF result > 0 THEN
	
		SELECT IFNULL(id_destinazione + 1, 1)
			INTO destination_id
		FROM destinazione_cliente 
		WHERE id_cliente = customer_id; 
		
		INSERT INTO destinazione_cliente
		SET  
			Id_cliente = customer_id, 
			Id_destinazione = destination_id, 
			Provincia = province, 
			Comune = municipality_id, 
			Frazione = district_id,
			Indirizzo = street, 
			Numero_civico = street_number, 
			Descrizione = description, 
			Scala = stair, 
			Altro = other, 
			Km_sede = distance, 
			Pedaggio = toll,
			Tempo_strada = trip_time, 
			Attivo = is_active, 
			ztl = is_limited_traffic_zone, 
			Note = notes, 
			Autostrada = has_speedway, 
			Sede_principale = is_main_destination,
			Dalle1 = from_morning,
			Alle1 = to_morning,
			Dalle2 = from_afternoon,
			Alle2 = to_afternoon,
			Piano = stair, 
			Interno = intern, 
			Id_autostrada = speedway_id,
			Longitudine = longitude,
			Latitudine = latitude, 
			Data_ins = NOW(),
			Utente_ins = @USER_ID,
			Utente_mod = @USER_ID;
			
			IF is_main_destination THEN
				CALL sp_ariesCustomerDestinationSetAsMainDestination(customer_id, destination_id, @Result);
			END IF; 
		 
		SET Result = LAST_INSERT_ID(); 
			
	END IF; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerDestinationResetAllDistance
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerDestinationResetAllDistance`(
)
BEGIN
	UPDATE destinazione_cliente 
	SET tempo_strada = 0,
		km_sede = 0;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerDestinationSetAsMainDestination
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerDestinationSetAsMainDestination`(
	IN customer_id INT,
	IN destination_id INT, 
	OUT result INT
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	UPDATE destinazione_cliente 
	SET Sede_principale = True, 
		Utente_mod = @USER_ID
	WHERE Id_cliente = customer_id AND
			Id_destinazione = destination_id; 
	
	UPDATE destinazione_cliente 
	SET Sede_principale = False, 
		Utente_mod = @USER_ID
	WHERE Id_cliente = customer_id AND
			Id_destinazione <> destination_id;
			
	SET Result = 1; 
	

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGet
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGet`(
)
BEGIN

	SELECT `Id_cliente`,
		`Ragione_Sociale` ,
		IFNULL(`Ragione_sociale2`, '') Ragione_Sociale2,
		IFNULL(`Partita_iva` , '') Partita_iva,
		IFNULL(`Codice_Fiscale`, '') Codice_fiscale,
		IFNULL(`Cortese_attenzione`, '') 'Cortese_attenzione',
		STR_TO_DATE( IFNULL(`Data_inserimento`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_inserimento,
		IFNULL(`Stato_cliente`,'') Stato_cliente,
		IFNULL(`Tipo_Cliente`, 0) 'Tipo_cliente',
		IFNULL(`stato_economico`, 0) 'stato_economico',
		IFNULL(`condizione_pagamento`, 0 ) 'condizione_pagamento',
		IFNULL(`Sito_internet` , '') Sito_internet,
		IFNULL(`password`, '') 'password',
		IFNULL(`Utente_sito`, '') Utente_sito,
		IFNULL(`iva` ,0) 'iva',
		`modi`,
		`rc` ,
		`posta` ,
		IFNULL(`ex` , 0) ex,
		IFNULL(`tipo_rapporto`  , 0) tipo_rapporto,
		IFNULL(`id_utente` , 0) id_utente,
		IFNULL(`id_agente` , 0) id_agente,
		IFNULL(`id_abbona` , 0) id_abbona,
		IFNULL(`id_attività` , 0) id_attività,
		IFNULL(`pec`, '') pec ,
		IFNULL(`codice_univoco`, '') codice_univoco,
		e_codice_destinatario,
		`data_ultima_modifica`
	FROM Clienti; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGetByCompanyName
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGetByCompanyName`(
	company_name VARCHAR(150)
)
BEGIN

	SELECT clienti.Id_cliente,
		`Ragione_Sociale` ,
		IFNULL(`Ragione_sociale2`, '') Ragione_Sociale2,
		IFNULL(`Partita_iva` , '') Partita_iva,
		IFNULL(`Codice_Fiscale`, '') Codice_fiscale,
		IFNULL(`Cortese_attenzione`, '') 'Cortese_attenzione',
		STR_TO_DATE( IFNULL(`Data_inserimento`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_inserimento,
		IFNULL(`Stato_cliente`,'') Stato_cliente,
		IFNULL(`Tipo_Cliente`, 0) 'Tipo_cliente',
		IFNULL(`stato_economico`, 0) 'stato_economico',
		IFNULL(`condizione_pagamento`, 0 ) 'condizione_pagamento',
		IFNULL(`Sito_internet` , '') Sito_internet,
		IFNULL(`password`, '') 'password',
		IFNULL(`Utente_sito`, '') Utente_sito,
		IFNULL(`iva` ,0) 'iva',
		`modi`,
		`rc` ,
		`posta` ,
		IFNULL(`ex` , 0) ex,
		IFNULL(`tipo_rapporto`  , 0) tipo_rapporto,
		IFNULL(`id_utente` , 0) id_utente,
		IFNULL(`id_agente` , 0) id_agente,
		IFNULL(`id_abbona` , 0) id_abbona,
		IFNULL(`id_attività` , 0) id_attività,
		IFNULL(`pec`, '') pec ,
		IFNULL(`codice_univoco`, '') codice_univoco,
		e_codice_destinatario,
		`data_ultima_modifica`
	FROM Clienti
	WHERE (ragione_sociale = company_name) OR (ragione_sociale2 = company_name)
	ORDER BY clienti.Stato_cliente LIKE 'clLime' DESC; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGetById`(
	customerId INT(11)
)
BEGIN

	SELECT `Id_cliente`,
		`Ragione_Sociale` ,
		IFNULL(`Ragione_sociale2`, '') Ragione_Sociale2,
		IFNULL(`Partita_iva` , '') Partita_iva,
		IFNULL(`Codice_Fiscale`, '') Codice_fiscale,
		IFNULL(`Cortese_attenzione`, '') 'Cortese_attenzione',
		STR_TO_DATE( IFNULL(`Data_inserimento`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_inserimento,
		IFNULL(`Stato_cliente`,'') Stato_cliente,
		IFNULL(`Tipo_Cliente`, 0) 'Tipo_cliente',
		IFNULL(`stato_economico`, 0) 'stato_economico',
		IFNULL(`condizione_pagamento`, 0 ) 'condizione_pagamento',
		IFNULL(`Sito_internet` , '') Sito_internet,
		IFNULL(`password`, '') 'password',
		IFNULL(`Utente_sito`, '') Utente_sito,
		IFNULL(`iva` ,0) 'iva',
		`modi`,
		`rc` ,
		`posta` ,
		IFNULL(`ex` , 0) ex,
		IFNULL(`tipo_rapporto`  , 0) tipo_rapporto,
		IFNULL(`id_utente` , 0) id_utente,
		IFNULL(`id_agente` , 0) id_agente,
		IFNULL(`id_abbona` , 0) id_abbona,
		IFNULL(`id_attività` , 0) id_attività,
		IFNULL(`pec`, '') pec ,
		IFNULL(`codice_univoco`, '') codice_univoco,
		e_codice_destinatario,
		`data_ultima_modifica`
	FROM Clienti
	WHERE Id_cliente = customerId; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGetByIds
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGetByIds`(
	IN idArray MEDIUMTEXT
	)
BEGIN

  SELECT DISTINCT Clienti.`Id_cliente`,
		Clienti.Ragione_Sociale ,
		IFNULL(Clienti.`Ragione_sociale2`, "") Ragione_Sociale2,
		IFNULL(Clienti.`Partita_iva` , "") Partita_iva,
		IFNULL(Clienti.`Codice_Fiscale`, "") Codice_fiscale,
		IFNULL(Clienti.`Cortese_attenzione`, "") Cortese_attenzione,
		STR_TO_DATE( IFNULL(Clienti.`Data_inserimento`, "1970-01-01 00:00:00"), "%Y-%m-%d") data_inserimento,
		IFNULL(Clienti.`Stato_cliente`,"") Stato_cliente,
		IFNULL(Clienti.`Tipo_Cliente`, 0) "Tipo_cliente",
		IFNULL(Clienti.`stato_economico`, 0) "stato_economico",
		IFNULL(Clienti.`condizione_pagamento`, 0 ) "condizione_pagamento",
		IFNULL(Clienti.`Sito_internet` , "") Sito_internet,
		IFNULL(Clienti.`password`, "") password,
		IFNULL(Clienti.`Utente_sito`, "") Utente_sito,
		IFNULL(Clienti.`iva` ,0) iva,
		Clienti.`modi`,
		Clienti.`rc` ,
		Clienti.`posta` ,
		IFNULL(Clienti.`ex` , 0) ex,
		IFNULL(Clienti.`tipo_rapporto`  , 0) tipo_rapporto,
		IFNULL(Clienti.`id_utente` , 0) id_utente,
		IFNULL(Clienti.`id_agente` , 0) id_agente,
		IFNULL(Clienti.`id_abbona` , 0) id_abbona,
		IFNULL(Clienti.`id_attività` , 0) id_attività,
		IFNULL(Clienti.`pec`, "") pec ,
		IFNULL(Clienti.`codice_univoco`, "") codice_univoco,
		e_codice_destinatario,
		Clienti.`data_ultima_modifica`
	FROM Clienti
  WHERE FIND_IN_SET(id_cliente ,idArray) > 0;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGetByTagId
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGetByTagId`(
	tag_id INT
)
BEGIN

	SELECT clienti.Id_cliente,
		`Ragione_Sociale` ,
		IFNULL(`Ragione_sociale2`, '') Ragione_Sociale2,
		IFNULL(`Partita_iva` , '') Partita_iva,
		IFNULL(`Codice_Fiscale`, '') Codice_fiscale,
		IFNULL(`Cortese_attenzione`, '') 'Cortese_attenzione',
		STR_TO_DATE( IFNULL(`Data_inserimento`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_inserimento,
		IFNULL(`Stato_cliente`,'') Stato_cliente,
		IFNULL(`Tipo_Cliente`, 0) 'Tipo_cliente',
		IFNULL(`stato_economico`, 0) 'stato_economico',
		IFNULL(`condizione_pagamento`, 0 ) 'condizione_pagamento',
		IFNULL(`Sito_internet` , '') Sito_internet,
		IFNULL(`password`, '') 'password',
		IFNULL(`Utente_sito`, '') Utente_sito,
		IFNULL(`iva` ,0) 'iva',
		`modi`,
		`rc` ,
		`posta` ,
		IFNULL(`ex` , 0) ex,
		IFNULL(`tipo_rapporto`  , 0) tipo_rapporto,
		IFNULL(`id_utente` , 0) id_utente,
		IFNULL(`id_agente` , 0) id_agente,
		IFNULL(`id_abbona` , 0) id_abbona,
		IFNULL(`id_attività` , 0) id_attività,
		IFNULL(`pec`, '') pec ,
		IFNULL(`codice_univoco`, '') codice_univoco,
		e_codice_destinatario,
		`data_ultima_modifica`
	FROM Clienti
		INNER JOIN cliente_tag ON clienti.Id_cliente = cliente_tag.id_cliente
	WHERE cliente_tag.id_tag = tag_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGetByTicketStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGetByTicketStatus`( 
	statusTicket INT(11)
)
BEGIN

	SELECT Clienti.`Id_cliente`,
		Clienti.`Ragione_Sociale` ,
		IFNULL(Clienti.`Ragione_sociale2`, '') Ragione_Sociale2,
		IFNULL(Clienti.`Partita_iva` , '') Partita_iva,
		IFNULL(Clienti.`Codice_Fiscale`, '') Codice_fiscale,
		IFNULL(Clienti.`Cortese_attenzione`, '') 'Cortese_attenzione',
		STR_TO_DATE( IFNULL(Clienti.`Data_inserimento`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_inserimento,
		IFNULL(Clienti.`Stato_cliente`,'') Stato_cliente,
		IFNULL(Clienti.`Tipo_Cliente`, 0) 'Tipo_cliente',
		IFNULL(Clienti.`stato_economico`, 0) 'stato_economico',
		IFNULL(Clienti.`condizione_pagamento`, 0 ) 'condizione_pagamento',
		IFNULL(Clienti.`Sito_internet` , '') Sito_internet,
		IFNULL(Clienti.`password`, '') 'password',
		IFNULL(Clienti.`Utente_sito`, '') Utente_sito,
		IFNULL(Clienti.`iva` ,0) 'iva',
		Clienti.`modi`,
		Clienti.`rc` ,
		Clienti.`posta` ,
		IFNULL(Clienti.`ex` , 0) ex,
		IFNULL(Clienti.`tipo_rapporto`  , 0) tipo_rapporto,
		IFNULL(Clienti.`id_utente` , 0) id_utente,
		IFNULL(Clienti.`id_agente` , 0) id_agente,
		IFNULL(Clienti.`id_abbona` , 0) id_abbona,
		IFNULL(Clienti.`id_attività` , 0) id_attività,
		IFNULL(Clienti.`pec`, '') pec ,
		IFNULL(Clienti.`codice_univoco`, '') codice_univoco,
		e_codice_destinatario,
		Clienti.`data_ultima_modifica`
	FROM Clienti
		INNER JOIN Ticket 
		ON Clienti.Id_cliente = Ticket.Id_impianto AND Ticket.Stato_ticket = statusTicket; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGetOrderByCompanyName
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGetOrderByCompanyName`(
)
BEGIN

	SELECT `Id_cliente`,
		`Ragione_Sociale` ,
		IFNULL(`Ragione_sociale2`, '') Ragione_Sociale2,
		IFNULL(`Partita_iva` , '') Partita_iva,
		IFNULL(`Codice_Fiscale`, '') Codice_fiscale,
		IFNULL(`Cortese_attenzione`, '') 'Cortese_attenzione',
		STR_TO_DATE( IFNULL(`Data_inserimento`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_inserimento,
		IFNULL(`Stato_cliente`,'') Stato_cliente,
		IFNULL(`Tipo_Cliente`, 0) 'Tipo_cliente',
		IFNULL(`stato_economico`, 0) 'stato_economico',
		IFNULL(`condizione_pagamento`, 0 ) 'condizione_pagamento',
		IFNULL(`Sito_internet` , '') Sito_internet,
		IFNULL(`password`, '') 'password',
		IFNULL(`Utente_sito`, '') Utente_sito,
		IFNULL(`iva` ,0) 'iva',
		`modi`,
		`rc` ,
		`posta` ,
		IFNULL(`ex` , 0) ex,
		IFNULL(`tipo_rapporto`  , 0) tipo_rapporto,
		IFNULL(`id_utente` , 0) id_utente,
		IFNULL(`id_agente` , 0) id_agente,
		IFNULL(`id_abbona` , 0) id_abbona,
		IFNULL(`id_attività` , 0) id_attività,
		IFNULL(`pec`, '') pec ,
		IFNULL(`codice_univoco`, '') codice_univoco,
		e_codice_destinatario,
		`data_ultima_modifica`
	FROM Clienti
	ORDER BY Clienti.Ragione_Sociale; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGroupEmailSent
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGroupEmailSent`()
BEGIN
	SELECT 
		Id_mail, 
		Id_riferimento, 
		id_cliente, 
		Stato, 
		IFNULL(Codice_errore, 0) Codice_errore,
		Messaggio_errore, 
		Timestamp
	FROM mail_gruppo_inviate;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGroupEmailSentByEmailId
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGroupEmailSentByEmailId`(
	IN email_id INT(11) 
)
BEGIN
	SELECT 
		Id_mail, 
		Id_riferimento, 
		id_cliente, 
		Stato, 
		IFNULL(Codice_errore, 0) Codice_errore,
		Messaggio_errore, 
		Timestamp
	FROM mail_gruppo_inviate
	WHERE Id_mail = email_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerGroupEmailSentInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerGroupEmailSentInsert`(
	IN email_id INT(11), 
	IN contact_id INT(11), 
	IN customer_id INT(11), 
	IN is_sent BIT(1), 
	IN error_code INT(11), 
	IN error_message VARCHAR(200), 
	OUT result SMALLINT
)
BEGIN

	
	INSERT INTO mail_gruppo_inviate 
	SET
		Id_mail = email_id, 
		Id_riferimento = contact_id, 
		id_cliente = customer_id, 
		Stato = is_sent, 
		Codice_errore = error_code,
		Messaggio_errore = error_message;
		
	SET result = 1; 	
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerInvoicesStatementCreateReminder
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerInvoicesStatementCreateReminder`(
	IN statement_id INT(11),
	OUT event_id INT(11)
)
BEGIN
	DECLARE customer_id INT(11);
	DECLARE send_date DATETIME;
	DECLARE email_id INT(11);
	DECLARE event_group_id INT(11);
	DECLARE company_name VARCHAR(200);
	DECLARE phone VARCHAR(20);
	DECLARE mobile_phone VARCHAR(20);
	DECLARE email VARCHAR(200);
	DECLARE event_subject TEXT;
	DECLARE event_description TEXT;
	DECLARE event_date DATE;
	

	SELECT
		id_cliente,
		id_email,
		data_ins
	INTO
		customer_id,
		email_id,
		send_date
	FROM cliente_estratto_conto
	WHERE id = statement_id;

	SELECT
		ragione_sociale
	INTO
		company_name
	FROM clienti
	WHERE clienti.id_cliente = customer_id;

	SELECT
		telefono, altro_telefono, mail
	INTO
		phone, mobile_phone, email
	FROM riferimento_clienti rc
	WHERE (rc.Promemoria_cliente = 1 OR rc.Id_riferimento = 1) AND id_cliente = customer_id
	ORDER BY rc.Promemoria_cliente DESC
	LIMIT 1;


	SET event_subject = CONCAT(company_name, ' - PROMEMORIA ESTRATTO CONTO');
	SET event_description = CONCAT(
		'CLIENTE: ', company_name, '\n',
		'TELEFONO: ', phone, '\n',
		'CELLULARE: ', mobile_phone, '\n',
		'MAIL: ', email, '\n',
		'DATA INVIO ESTRATTO CONTO: ', DATE_FORMAT(send_date, '%d/%m/%Y %H:%i'), '\n'
	);
	SET event_date = DATE_ADD(send_date, INTERVAL 20 DAY);

	INSERT INTO evento_gruppo
	SET
		oggetto = event_subject,
		descrizione = event_description,
		data_ora_inizio = CONCAT(event_date, ' ', '08:00:00'),
		data_ora_fine = CONCAT(event_date, ' ', '20:00:00'),
		Data_ins = NOW(),
		Data_mod = NOW(),
		Utente_ins = @USER_ID,
		Utente_mod = @USER_ID;
	
	SELECT LAST_INSERT_ID() INTO event_group_id;


	INSERT INTO Evento
	SET 
		Oggetto = event_subject, 
		Descrizione = event_description, 
		Id_riferimento = customer_id, 
		id_tipo_evento = 3, 
		Eseguito = 0, 
		Ricorrente = 0,
		giorni_ricorrenza = 0,
		Data_esecuzione = event_date, 
		Sveglia = 0, 
		Data_sveglia = '1970-01-01 00:00:00',
		Ora_inizio_esecuzione = '09:00:00',
		ora_fine_esecuzione = '10:00:00',
		Data_mod = CURRENT_TIMESTAMP, 
		Utente_ins = @USER_ID;
		
	SELECT LAST_INSERT_ID() INTO event_id;
	
	INSERT INTO Evento_gruppo_evento (Id_evento, Id_gruppo_evento, Tipo_associazione, Timestamp)
		VALUES (event_id, event_group_id, 1, CURRENT_TIMESTAMP);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerInvoicesStatementInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerInvoicesStatementInsert`(
	IN `email_id` INT(11),
	IN `customer_id` INT(11)
)
BEGIN
	INSERT INTO cliente_estratto_conto 
		(id_cliente, id_email, utente_ins)
	VALUES
		(customer_id, email_id, @USER_ID);	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerMarkAsVaried
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerMarkAsVaried`(
	IN customer_id INT, 
	OUT new_customer_id INT
)
BEGIN

	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;


	INSERT INTO clienti(
		Ragione_Sociale, Ragione_sociale2, Partita_iva, Codice_Fiscale, e_codice_destinatario,
		Cortese_attenzione, Data_inserimento, Stato_cliente, Tipo_Cliente, stato_economico,
		condizione_pagamento, Sito_internet, password, Utente_sito, iva, modi, rc, posta, ex, tipo_rapporto,
		id_utente, id_agente, id_abbona, id_attività, pec
	)
	SELECT Ragione_Sociale, Ragione_sociale2, Partita_iva, Codice_Fiscale, e_codice_destinatario,
		Cortese_attenzione, Data_inserimento, Stato_cliente, Tipo_Cliente, stato_economico,
		condizione_pagamento, Sito_internet, password, Utente_sito, iva, modi, rc, posta, ex, 
		tipo_rapporto, @USER_ID, id_agente, id_abbona, id_attività, pec
	FROM clienti
	WHERE id_cliente = customer_id;

	SET new_customer_id = LAST_INSERT_ID();


	INSERT INTO destinazione_cliente(
		id_cliente, Id_destinazione, Provincia, Comune, Frazione, Indirizzo, numero_civico, Descrizione, 
		scala, Altro, Km_sede, Pedaggio, Tempo_strada, attivo, ztl, Note, Autostrada, 
		Sede_principale, dalle1, alle1, dalle2, alle2, piano, interno, id_autostrada, Data_ins, Utente_ins, Utente_mod
	)
	SELECT new_customer_id, Id_destinazione, Provincia, Comune, Frazione, Indirizzo, numero_civico, Descrizione,
		scala, Altro, Km_sede, Pedaggio, Tempo_strada, attivo, ztl, Note, Autostrada, 
		Sede_principale, dalle1, alle1, dalle2, alle2, piano, interno, id_autostrada, NOW(), @USER_ID, @USER_ID
	FROM destinazione_cliente
	WHERE id_cliente = customer_id;


	INSERT INTO riferimento_clienti(
		Id_cliente, Id_riferimento, Nome, figura, Telefono, altro_telefono,
		fax, mail, centralino, Fatturazione, titolo, nota_cli, esterno, sito, skype, rif_esterno, sito_utente, sito_passwd,
		mail_pec, riferimento_clienti.mod,idut
	)
	SELECT new_customer_id, Id_riferimento, Nome, figura, Telefono, altro_telefono,
		fax, mail, centralino, Fatturazione, titolo, nota_cli, esterno, sito, skype, rif_esterno, sito_utente, sito_passwd,
		mail_pec, riferimento_clienti.mod, @USER_ID
	FROM riferimento_clienti
	WHERE id_cliente = customer_id;

	INSERT INTO clienti_banche (Id_cliente, Id_filiale, data_inizio, data_fine, Iban)
	select new_customer_id, Id_filiale, data_inizio, data_fine, Iban
	FROM clienti_banche
	WHERE id_cliente = customer_id;

	INSERT INTO cliente_nota (Id_cliente, Id_nota, Descrizione, data_ult_modifica)
	SELECT new_customer_id, Id_nota, Descrizione, data_ult_modifica
	FROM cliente_nota
	WHERE id_cliente = customer_id;

	INSERT INTO cliente_tag
	SELECT new_customer_id, id_tag, @USER_ID, NOW()
	FROM cliente_tag
	WHERE id_cliente = customer_id;
	

	UPDATE impianto SET id_cliente = new_customer_id WHERE id_cliente = customer_id;
	UPDATE impianto SET id_occupante = new_customer_id WHERE id_occupante = customer_id;
	UPDATE impianto SET id_gestore = new_customer_id WHERE id_gestore = customer_id;


	UPDATE ticket SET id_cliente = new_customer_id WHERE id_cliente = customer_id;


	UPDATE clienti
	SET stato_cliente=(SELECT id_stato FROM stato_clienti WHERE nome="VARIATO")
	WHERE id_cliente = customer_id;

		

	IF `_rollback` THEN
		ROLLBACK;
		SET new_customer_id = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerReminderConfigUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerReminderConfigUpdate`( 
	IN service_id INT(11), 
	IN interval_type SMALLINT(6), 
	IN interval_value INT(11),
	IN email_subject VARCHAR(150), 
	IN email_body TEXT,
	IN sms_text TEXT,
	IN sms_enabled BIT(1),
	IN email_enabled BIT(1),
	OUT result INTEGER
)
BEGIN

	UPDATE cliente_promemoria_configurazione
	SET
		`Tipo_intervallo` = interval_type,
		`Valore` = interval_value,
		`Oggetto_email` = email_subject,
		`Corpo_email` = email_body,
		Testo_sms = sms_text,
		abilita_sms = sms_enabled,
		abilita_email = email_enabled
	WHERE Id = service_id;
	
	SET result = 1; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerReminderConfigurationGet
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerReminderConfigurationGet`(
)
BEGIN
	SELECT `Id`,
		`Nome`,
		`Tipo_intervallo`,
		`Valore`,
		Oggetto_email, 
		Corpo_email,
		Testo_sms,
		abilita_sms,
		abilita_email,
		Data_ultima_esecuzione,
		`Data_mod`,
		`Utente_mod`
	FROM cliente_promemoria_configurazione;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerReminderGeneralConfigInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerReminderGeneralConfigInsert`( 
	IN `in_email_host` VARCHAR(50),
	IN `in_email_username` VARCHAR(50),
	IN `in_email_password` VARCHAR(50),
	IN `in_email_port` INT(11),
	IN `in_email_ssl` BIT(1),
	IN `in_email_from` VARCHAR(50),
	IN `in_sms_host` VARCHAR(50),
	OUT result INTEGER
)
BEGIN
	DECLARE in_sms_endpoint VARCHAR(150) DEFAULT '';
	DECLARE in_sms_password VARCHAR(150) DEFAULT '';

	SELECT sms_endpoint,
		sms_password
	INTO
		in_sms_endpoint,
		in_sms_password
	FROM cliente_promemoria_configurazione_generale
	ORDER BY ID desc
	LIMIT 1;

	SET result = 0;

	INSERT INTO cliente_promemoria_configurazione_generale
	SET
		`Email_host` = in_email_host,
		`Email_username` = in_email_username,
		`Email_password` = in_email_password,
		`Email_port` = in_email_port,
		`Email_ssl` = in_email_ssl,
		`Email_from` = in_email_from,
		`Sms_host` = in_sms_host,
		`Sms_endpoint` = in_sms_endpoint,
		`Sms_password` = in_sms_password,
		`Data_ins` = NOW(),  
		Utente_ins = @USER_ID;
	
	SET Result = LAST_INSERT_ID();

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerReminderGeneralConfigUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerReminderGeneralConfigUpdate`( 
	IN `in_email_host` VARCHAR(50),
	IN `in_email_username` VARCHAR(50),
	IN `in_email_password` VARCHAR(50),
	IN `in_email_port` INT(11),
	IN `in_email_ssl` BIT(1),
	IN `in_email_from` VARCHAR(50),
	IN `in_sms_host` VARCHAR(50),
	IN In_id INT(11),
	OUT result INTEGER
)
BEGIN

	UPDATE cliente_promemoria_configurazione_generale
	SET
		`Email_host` = in_email_host,
		`Email_username` = in_email_username,
		`Email_password` = in_email_password,
		`Email_port` = in_email_port,
		`Email_ssl` = in_email_ssl,
		`Email_from` = in_email_from, 
		`Sms_host` = in_sms_host, 
		`Data_ins` = NOW(),  
		Utente_ins = @USER_ID
	WHERE Id = In_id;
	
	SET result = 1; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerReminderGeneralConfigurationGetLast
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerReminderGeneralConfigurationGetLast`(
)
BEGIN
	SELECT
		`Id`,
		`Email_host`,
		`Email_username`,
		`Email_password`,
		`Email_port`,
		`Email_ssl`,
		Email_from,
		Sms_host,
		`Data_ins`,
		`Utente_ins`
	FROM cliente_promemoria_configurazione_generale
	ORDER BY Id DESC
	LIMIT 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerStatusGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerStatusGetById`(
	status_id VARCHAR(10)
)
BEGIN

	SELECT Id_stato,
		nome,
		descrizione,
		bloccato
	FROM stato_clienti
	WHERE Id_stato = status_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerTagDeleteByCustomer
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerTagDeleteByCustomer`( 
	IN customer_id INT(11)
)
BEGIN

	DELETE FROM cliente_tag
	WHERE id_cliente = customer_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesCustomerTagGetByCustomer
DELIMITER //
CREATE PROCEDURE `sp_ariesCustomerTagGetByCustomer`(
	IN customer_id INT
)
BEGIN
	SELECT 
		`id_cliente`,
		cliente_tag.id_tag,
		tag.tag
	FROM cliente_tag
		INNER JOIN tag ON tag.id_tag = cliente_tag.id_tag
	WHERE id_cliente = customer_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtDeleteById
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtDeleteById`( 
enter_id INT, 
enter_year INT
)
BEGIN

	DELETE FROM commessa_ddt
	WHERE id_ddt = enter_id AND anno_ddt = enter_year; 

	DELETE FROM articoli_ddt
	WHERE id_ddt = enter_id AND anno = enter_year; 

	DELETE FROM ddt_rapporto
	WHERE id_ddt = enter_id AND anno_ddt = enter_year; 

	DELETE FROM ddt
	WHERE id_ddt = enter_id AND anno = enter_year; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtGetById`( 
enter_id INT, 
enter_year INT
)
BEGIN
        
	SELECT 
		ddt.`Id_ddt`,
		ddt.`anno` ,
		IFNULL(`id_cliente`, 0) id_cliente,
		IFNULL(`id_fornitore`, 0) id_fornitore,
		IFNULL(`Id_destinazione`, 0) Id_destinazione,
		IFNULL(`condizione_pagamento`, 0) Condizione_pagamento,
		IFNULL(`Porto_resa`, 0) Porto_resa,
		CAST(IFNULL(data_documento ,'1970-01-01') AS DATE) `data_documento`,
		IFNULL(`Vettore`, 0) Vettore,
		CAST(IFNULL(data_ora_ritiro ,'1970-01-01') AS DATETIME) `data_ora_ritiro`,
		CAST(IFNULL(data_ora_inizio ,'1970-01-01') AS DATETIME) `data_ora_inizio`,
		`trasport_a_cura`,
		Causale,
		IFNULL(`Fattura`, 0) Fattura,
		IFNULL(`Anno_fattura`, 0) Anno_fattura,
		IFNULL(`colli`, 0)  colli,
		IFNULL(`Peso`, 0) Peso,
		`Nota`,
		`Descrizione`,
		IFNULL(`id_principale`, 0) id_principale,
		IFNULL(`impianto`, 0) Impianto,
		`STAMPA`,
		IFNULL(`destinazione_forn`, 0) destinazione_forn,
		IFNULL(`principale_forn`, 0) principale_forn,
		IFNULL(`id_utente`, 0) id_utente,
		`data_modifica`,
		IFNULL(`stampa_ora`, 0) stampa_ora,
		IFNULL(`fatturaf`, 0) fatturaf,
		IFNULL(`anno_fatturaf`, 0) anno_fatturaf,
		`stato`, 
		filename_firma_destinatario, 
		filename_firma_conducente,
		cd.Id_commessa,
		cd.id_sottocommessa,
		cd.anno_commessa
	FROM ddt
		INNER JOIN commessa_ddt cd
			ON ddt.id_ddt = cd.Id_ddt AND ddt.anno = cd.Anno_ddt
	WHERE id_ddt = enter_id AND anno = enter_year; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtGetByInvoiceId
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtGetByInvoiceId`( 
enter_id INT, 
enter_year INT
)
BEGIN
        
	SELECT 
		ddt.`Id_ddt`,
		ddt.`anno` ,
		IFNULL(`id_cliente`, 0) id_cliente,
		IFNULL(`id_fornitore`, 0) id_fornitore,
		IFNULL(`Id_destinazione`, 0) Id_destinazione,
		IFNULL(`condizione_pagamento`, 0) Condizione_pagamento,
		IFNULL(`Porto_resa`, 0) Porto_resa,
		CAST(IFNULL(data_documento ,'1970-01-01') AS DATE) `data_documento`,
		IFNULL(`Vettore`, 0) Vettore,
		CAST(IFNULL(data_ora_ritiro ,'1970-01-01') AS DATETIME) `data_ora_ritiro`,
		CAST(IFNULL(data_ora_inizio ,'1970-01-01') AS DATETIME) `data_ora_inizio`,
		`trasport_a_cura`,
		Causale,
		IFNULL(`Fattura`, 0) Fattura,
		IFNULL(`Anno_fattura`, 0) Anno_fattura,
		IFNULL(`colli`, 0)  colli,
		IFNULL(`Peso`, 0) Peso,
		`Nota`,
		`Descrizione`,
		IFNULL(`id_principale`, 0) id_principale,
		IFNULL(`impianto`, 0) Impianto,
		`STAMPA`,
		IFNULL(`destinazione_forn`, 0) destinazione_forn,
		IFNULL(`principale_forn`, 0) principale_forn,
		IFNULL(`id_utente`, 0) id_utente,
		`data_modifica`,
		IFNULL(`stampa_ora`, 0) stampa_ora,
		IFNULL(`fatturaf`, 0) fatturaf,
		IFNULL(`anno_fatturaf`, 0) anno_fatturaf,
		`stato`, 
		filename_firma_destinatario, 
		filename_firma_conducente,
		cd.Id_commessa,
		cd.id_sottocommessa,
		cd.anno_commessa
	FROM ddt
		LEFT JOIN commessa_ddt cd
			ON ddt.id_ddt = cd.Id_ddt AND ddt.anno = cd.Anno_ddt 
	WHERE Fattura = enter_id AND Anno_fattura = enter_year; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtGetByReportId
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtGetByReportId`( 
enter_id INT, 
enter_year INT
)
BEGIN
        
	SELECT 
		ddt.`Id_ddt`,
		ddt.`anno` ,
		IFNULL(`id_cliente`, 0) id_cliente,
		IFNULL(`id_fornitore`, 0) id_fornitore,
		IFNULL(`Id_destinazione`, 0) Id_destinazione,
		IFNULL(`condizione_pagamento`, 0) Condizione_pagamento,
		IFNULL(`Porto_resa`, 0) Porto_resa,
		CAST(IFNULL(data_documento ,'1970-01-01') AS DATE) `data_documento`,
		IFNULL(`Vettore`, 0) Vettore,
		CAST(IFNULL(data_ora_ritiro ,'1970-01-01') AS DATETIME) `data_ora_ritiro`,
		CAST(IFNULL(data_ora_inizio ,'1970-01-01') AS DATETIME) `data_ora_inizio`,
		`trasport_a_cura`,
		ddt.Causale,
		IFNULL(`Fattura`, 0) Fattura,
		IFNULL(`Anno_fattura`, 0) Anno_fattura,
		IFNULL(`colli`, 0)  colli,
		IFNULL(`Peso`, 0) Peso,
		ddt.`Nota`,
		ddt.`Descrizione`,
		IFNULL(`id_principale`, 0) id_principale,
		IFNULL(ddt.`impianto`, 0) Impianto,
		ddt.`STAMPA`,
		IFNULL(`destinazione_forn`, 0) destinazione_forn,
		IFNULL(`principale_forn`, 0) principale_forn,
		IFNULL(`id_utente`, 0) id_utente,
		ddt.`data_modifica`,
		IFNULL(`stampa_ora`, 0) stampa_ora,
		IFNULL(`fatturaf`, 0) fatturaf,
		IFNULL(`anno_fatturaf`, 0) anno_fatturaf,
		ddt.`stato`, 
		filename_firma_destinatario, 
		filename_firma_conducente,
		cd.Id_commessa,
		cd.id_sottocommessa,
		cd.anno_commessa
	FROM ddt
		INNER JOIN ddt_rapporto dr
			ON ddt.id_ddt = dr.Id_ddt AND ddt.anno = dr.Anno_ddt 
		LEFT JOIN commessa_ddt cd
			ON ddt.id_ddt = cd.Id_ddt AND ddt.anno = cd.Anno_ddt 
	WHERE dr.id_rapporto = enter_id AND dr.anno_rapporto = enter_year; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtGetNotInvoicedByJob
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtGetNotInvoicedByJob`( 
job_id INT, 
job_year INT,
sub_job_id INT, 
job_lot_id INT
)
BEGIN
	SELECT 
		d.`Id_ddt`,
		d.`anno` ,
		IFNULL(`id_cliente`, 0) id_cliente,
		IFNULL(`id_fornitore`, 0) id_fornitore,
		IFNULL(`Id_destinazione`, 0) Id_destinazione,
		IFNULL(`condizione_pagamento`, 0) Condizione_pagamento,
		IFNULL(`Porto_resa`, 0) Porto_resa,
		CAST(IFNULL(data_documento ,'1970-01-01') AS DATE) `data_documento`,
		IFNULL(`Vettore`, 0) Vettore,
		CAST(IFNULL(data_ora_ritiro ,'1970-01-01') AS DATETIME) `data_ora_ritiro`,
		CAST(IFNULL(data_ora_inizio ,'1970-01-01') AS DATETIME) `data_ora_inizio`,
		`trasport_a_cura`,
		Causale,
		IFNULL(`Fattura`, 0) Fattura,
		IFNULL(`Anno_fattura`, 0) Anno_fattura,
		IFNULL(`colli`, 0)  colli,
		IFNULL(`Peso`, 0) Peso,
		`Nota`,
		`Descrizione`,
		IFNULL(`id_principale`, 0) id_principale,
		IFNULL(`impianto`, 0) Impianto,
		`STAMPA`,
		IFNULL(`destinazione_forn`, 0) destinazione_forn,
		IFNULL(`principale_forn`, 0) principale_forn,
		IFNULL(`id_utente`, 0) id_utente,
		`data_modifica`,
		IFNULL(`stampa_ora`, 0) stampa_ora,
		IFNULL(`fatturaf`, 0) fatturaf,
		IFNULL(`anno_fatturaf`, 0) anno_fatturaf,
		`stato`, 
		filename_firma_destinatario, 
		filename_firma_conducente,
		cd.Id_commessa,
		cd.id_sottocommessa,
		cd.anno_commessa
	FROM ddt d
		INNER JOIN commessa_ddt cd
			ON d.id_ddt = cd.Id_ddt AND d.anno = cd.Anno_ddt 
				AND cd.Id_commessa = job_id AND cd.anno_commessa = job_year 
				AND cd.id_sottocommessa = sub_job_id AND IF(job_lot_id = -1, True, cd.id_lotto = job_lot_id)
	WHERE (Fattura IS NULL OR Fattura = 0) AND (Fatturaf IS NULL OR Fatturaf = 0);

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtProductDeleteByDdt
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtProductDeleteByDdt`(
ddt_id INT(11), 
ddt_year INT(11)
)
BEGIN

	DELETE FROM articoli_ddt
	WHERE Id_ddt = ddt_id 
		and anno = ddt_year;

	DELETE FROM riferimento_sn_ddt_kit 
	WHERE Id_ddt = ddt_id 
		and anno = ddt_year;
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtProductGetByDdt
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtProductGetByDdt`(
ddt_id INT(11), 
ddt_year INT(11)
)
BEGIN

	SELECT 
		id_articolo,
		Costo,
		id_ddt,
		Desc_breve,
		anno
		codice_fornitore,
		numero_tab,
		IFNULL(quantità, 0) quantità,
		Unità_misura,
		Prezzo,
		Serial_number,
		tipo,
		IFNULL(idnota, 0) idnota,
		IFNULL(causale_scarico, 0) causale_scarico,
		IFNULL(id_rif, 0) id_rif,
		IFNULL(anno_rif, 0) anno_rif,
		0 AS sconto2,
		sconto,
		IFNULL(economia, 0) economia,
		id_commessa,
		anno_commessa,
		id_sottocommessa,
		id_lotto_commessa,
		id_tab_commessa,
		sostituzione,
		codice_articolo_sostituzione,
		id_tab_sostituzione
	FROM articoli_ddt
	WHERE Id_ddt = ddt_id 
		and anno = ddt_year
	ORDER BY numero_tab; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtProductGetByDdtIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtProductGetByDdtIdAndYear`( 
	ddt_id INT, 
	ddt_year INT
)
BEGIN

	SELECT 
		IFNULL(Id_articolo, "") AS Id_articolo, 
		costo, 
		id_ddt, 
		IFNULL(Desc_breve, "") AS Desc_breve,
		Anno, 
		IFNULL(Codice_fornitore, "") AS codice_fornitore, 
		Numero_tab, 
		IFNULL(Quantità, 0) AS quantità,
		IFNULL(unità_misura, "") AS Unità_misura, 
		Prezzo, 
		IFNULL(Serial_number, "") AS Serial_number, 
		IFNULL(Tipo, "") AS tipo, 
		IFNULL(idnota, 0) as idnota, 
		IFNULL(causale_scarico, 0) AS causale_scarico, 
		IFNULL(id_rif, 0) AS id_rif, 
		IFNULL(anno_rif, 0) AS anno_rif, 
		IFNULL(sconto2, 0) AS sconto2, 
		sconto, 
		IFNULL(economia, 0) AS economia,
		id_commessa,
		anno_commessa,
		id_sottocommessa,
		id_lotto_commessa,
		id_tab_commessa,
		sostituzione,
		codice_articolo_sostituzione,
		id_tab_sostituzione
	FROM articoli_ddt
	WHERE Id_ddt = ddt_id AND anno = ddt_year
	ORDER BY Numero_tab; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtProductGetByJobAndProductCode
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtProductGetByJobAndProductCode`(
	job_id INT(11), 
	job_year INT(11), 
	sub_job_id INT(11),
	job_lot_id INT(11), 
	product_code VARCHAR(11)
)
BEGIN
	SELECT 
		id_articolo,
		Costo,
		articoli_ddt.id_ddt,
		Desc_breve,
		articoli_ddt.anno,
		codice_fornitore,
		numero_tab,
		IFNULL(quantità, 0) quantità,
		Unità_misura,
		Prezzo,
		Serial_number,
		tipo,
		IFNULL(idnota, 0) idnota,
		IFNULL(causale_scarico, 0) causale_scarico,
		IFNULL(id_rif, 0) id_rif,
		IFNULL(anno_rif, 0) anno_rif,
		0 AS sconto2,
		sconto,
		IFNULL(economia, 0) economia,
		articoli_ddt.id_commessa,
		articoli_ddt.anno_commessa,
		articoli_ddt.id_sottocommessa,
		articoli_ddt.id_lotto_commessa,
		articoli_ddt.id_tab_commessa,
		sostituzione,
		codice_articolo_sostituzione,
		id_tab_sostituzione
	FROM articoli_ddt
		INNER JOIN commessa_ddt 
			ON commessa_ddt.Id_ddt = articoli_ddt.id_ddt 
			AND commessa_ddt.anno_ddt = articoli_ddt.anno 
			AND commessa_ddt.id_lotto = job_lot_id
			AND commessa_ddt.id_commessa = job_id 
			AND commessa_ddt.anno_commessa = job_year
	WHERE articoli_ddt.id_articolo = product_code 
	ORDER BY numero_tab; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtProductSetQuantities
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtProductSetQuantities`(
	ddt_id INT(11), 
	ddt_year INT(11),
	row_id SMALLINT, 
	quantity DECIMAL(11,2), 
	economy_quantity DECIMAL(11,2)
)
BEGIN

	DECLARE job_id INT(11);
	DECLARE job_year INT(11);
	DECLARE sub_job_id INT(11);
	DECLARE lot_id INT(11);
	DECLARE has_job_link BIT(1);
	
	SELECT fnc_ddtHasJobLink(ddt_id, ddt_year)
		INTO has_job_link;
	
	-- WE CANNOT UPDATE A PRODUCT LINKED TO THE JOB.
	-- FOR THIS REASON WE NEED TO REMOVE JOB-DDT LINK FIRST, 
	-- UPDATE PRODUCT AND CREATE BACK JOB-DDT LINK
	IF has_job_link THEN
		SELECT id_commessa,
			anno_commessa,
			id_sottocommessa,
			id_lotto
		INTO job_id, 
			job_year,
			sub_job_id,
			lot_id
		FROM commessa_ddt
		WHERE id_ddt = ddt_id and anno_ddt = ddt_year;

		DELETE FROM commessa_ddt
		WHERE id_commessa = job_id
			AND anno_commessa = job_year
			AND id_sottocommessa = sub_job_id
			AND id_lotto = lot_id
			AND id_ddt = ddt_id 
			AND anno_ddt = ddt_year;
	END IF;

	UPDATE articoli_ddt
	SET
		quantità = quantity + economy_quantity, 
		economia = economy_quantity
	WHERE Id_ddt = ddt_id 
		and anno = ddt_year
		and numero_tab = row_id; 

	IF has_job_link THEN
		INSERT INTO commessa_ddt
		SET id_commessa = job_id,
			anno_commessa = job_year,
			id_sottocommessa = sub_job_id,
			id_lotto = lot_id,
			id_ddt = ddt_id, 
			anno_ddt = ddt_year;
	END IF;

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtReportLinkDeleteByDdt
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtReportLinkDeleteByDdt`(
	ddt_id INT, ddt_year INT
)
BEGIN
	DELETE FROM ddt_rapporto
	WHERE `Id_ddt` = ddt_id AND `anno_ddt` = ddt_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtReportLinkInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtReportLinkInsert`(
	report_id INT, report_year INT, ddt_id INT, ddt_year INT
)
BEGIN
	INSERT INTO ddt_rapporto
	SET 
		`Id_ddt` = ddt_id,
		`id_rapporto` = report_id,
		`anno_rapporto` = report_year,
		`anno_ddt` = ddt_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtSaveSignaturesRefs
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtSaveSignaturesRefs`(
	ddt_id INT(11),
	ddt_year INT(11),
	recipient_signature_filename VARCHAR(50), 
	driver_signature_filename VARCHAR(50)
)
BEGIN

	UPDATE ddt
	SET 
		`filename_firma_destinatario` = recipient_signature_filename,
		`filename_firma_conducente` = driver_signature_filename
	WHERE Id_ddt = ddt_id AND anno = ddt_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDdtSetIsPrinted
DELIMITER //
CREATE PROCEDURE `sp_ariesDdtSetIsPrinted`( 
enter_id INT, 
enter_year INT, 
is_printed BIT
)
BEGIN
        
	UPDATE DDT
	SET STAMPA = is_printed
	WHERE Id_ddt = enter_id AND anno = enter_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDefaultLotBodyDeleteByLotId
DELIMITER //
CREATE PROCEDURE `sp_ariesDefaultLotBodyDeleteByLotId`(
lot_id INT(11)
)
BEGIN

	DELETE FROM articolo_lotto
	WHERE id_lotto = lot_id;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDefaultLotBodyGetByLotId
DELIMITER //
CREATE PROCEDURE `sp_ariesDefaultLotBodyGetByLotId`(
lot_id INT(11)
)
BEGIN

	SELECT 
		Id_lotto,
		Id_tab,
		IFNULL(id_articolo, '') AS 'Id_articolo', 
		IFNULL(quantità, 0) AS 'Quantità', 
		IFNULL(Codice_fornitore, '') AS 'Codice_fornitore', 
		IFNULL(Unità_misura, '') AS 'Unità_misura', 
		IFNULL(Prezzo, 0) AS 'Prezzo',
		IFNULL(costo, 0) AS 'Costo', 
		IFNULL(Tempo_installazione, 0) AS 'Tempo_installazione',  
		IFNULL(Prezzo_h, 0) AS 'Prezzo_h',
		IFNULL(costo_h, 0) AS 'Costo_h',
		IFNULL(Desc_brev, '') AS 'Desc_brev', 
		Montato, 
		Tipo, 
		IFNULL(idnota, 0 ) AS 'IdNota'
	FROM articolo_lotto
	WHERE id_lotto = lot_id
	ORDER BY Id_tab; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDefaultLotDeleteById
DELIMITER //
CREATE PROCEDURE `sp_ariesDefaultLotDeleteById`(
lot_id INT(11), 
OUT result  TINYINT
)
BEGIN
	
	SET result = 1; 
	
		-- check if lot exists
	SELECT 
		IF(id_lotto IS NULL, -2, 1)
	INTO 
		result
	FROM lotto
	WHERE Id_lotto = lot_id; 
	
	IF result = 1 THEN 
	
		-- check if lot is already used in any quote
		SELECT 
			IF(id_lotto IS NOT NULL, -1, 1)
		INTO 
			result
		FROM preventivo_lotto
		WHERE Id_lotto = lot_id; 
		
	END IF;

	IF result = 1 THEN 
		DELETE FROM articolo_lotto
		WHERE id_lotto = lot_id;
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDefaultLotExclusionGetByLotId
DELIMITER //
CREATE PROCEDURE `sp_ariesDefaultLotExclusionGetByLotId`(
	IN lot_id INT(11)
)
BEGIN
	SELECT `id_lotto`,
		`id_esc`
	FROM lotto_escass
	WHERE id_lotto = lot_id
	ORDER BY id_esc DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDefaultLotGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesDefaultLotGetByName`(
	IN lot_name VARCHAR(255)
)
BEGIN
	SELECT `id_lotto`,
		`nome`,
		`descrizione`,
		`stato`
	FROM lotto
	WHERE nome = lot_name
	ORDER BY id_lotto DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDefaultLotUpdateStatusById
DELIMITER //
CREATE PROCEDURE `sp_ariesDefaultLotUpdateStatusById`(
lot_id INT(11), 
status_id TINYINT,
OUT result  TINYINT
)
BEGIN
	
	SET result = 1; 
	
	-- check if lot exists
	SELECT 
		IF(id_lotto IS NULL, -2, 1)
	INTO 
		result
	FROM lotto
	WHERE Id_lotto = lot_id; 

	IF result = 1 THEN 
		UPDATE lotto
		SET stato = status_id 
		WHERE id_lotto = lot_id;
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotMovementInOutComing
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotMovementInOutComing`(
	OUT outComing DECIMAL(11, 2),
	OUT inComing DECIMAL(11, 2)
)
BEGIN

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotOperationsDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotOperationsDelete`(
	operation_id INT
)
BEGIN

	DECLARE source_id INT(11);
	DECLARE is_kit BIT(1); 
	DECLARE product_code VARCHAR(16);

	SELECT sorgente
		INTO source_id
	FROM magazzino_operazione
  WHERE magazzino_operazione.id_operazione = operation_id;

	IF source_id IS NOT NULL THEN

		IF source_id = 2 THEN -- rapporto		
			DELETE FROM magazzino_rapporto_materiale
			WHERE id_operazione = operation_id;
		END IF;

		IF source_id = 3 THEN -- ddt		
			-- delete ddt product ref to the operation
			UPDATE magazzino_ddt_emessi
			SET id_reso = NULL
			WHERE id_reso = operation_id;

			DELETE FROM magazzino_ddt_emessi 
			WHERE id_operazione = operation_id;
		END IF;

		IF source_id = 6 THEN -- fattura forn
			-- delete invoice product ref to the operation
			DELETE FROM magazzino_fornfattura 
			WHERE id_operazione = operation_id;
		END IF;

		IF source_id = 7 THEN -- fattura		
			-- delete invoice product ref to the operation
			DELETE FROM magazzino_fattura 
			WHERE id_operazione = operation_id;
		END IF;

		IF source_id = 8 THEN -- ddt ricevuto
			-- delete received ddt product ref to the operation
			UPDATE magazzino_ddt_ricevuti
			SET id_reso = NULL
			WHERE id_reso = operation_id;

			DELETE FROM magazzino_ddt_ricevuti
			WHERE id_operazione = operation_id;
		END IF;
	END IF;

	SET is_kit = fnc_productIsKit(product_code);
	IF is_kit = 1 AND source_id IS NOT NULL THEN
		SET max_sp_recursion_depth = 255;
		CALL sp_ariesDepotOperationsUnscaleKitProducts(operation_id, source_id);
		SET max_sp_recursion_depth = 0;
	END IF;

  DELETE magazzino_operazione
	FROM magazzino_operazione
  WHERE magazzino_operazione.id_operazione = operation_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotOperationsInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotOperationsInsert`(
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16),
	depot_id INT(11),
	doc_date DATE,
	source_id SMALLINT,
	causal_id INT(11),
	OUT result BIGINT(11)
)
BEGIN

	DECLARE is_kit BIT(1);

	INSERT INTO magazzino_operazione (`Data`, causale, articolo, quantità, id_magazzino, sorgente)
		VALUES (doc_date,  causal_id, product_code, quantity, depot_id, source_id);

	SET result = LAST_INSERT_ID();

	SET is_kit = fnc_productIsKit(product_code);
	IF is_kit = 1 AND source_id IS NOT NULL THEN
		SET max_sp_recursion_depth = 255;
		CALL sp_ariesDepotOperationsScaleKitProducts(
			quantity,
			product_code,
			depot_id,
			source_id,
			doc_date,
		  result,
			causal_id
		);
		SET max_sp_recursion_depth = 0;
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotOperationsScaleKitProducts
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotOperationsScaleKitProducts`(
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16),
	depot_id INT(11),
	source_id SMALLINT,
	doc_date DATE,
	kit_operation_id BIGINT(11),
	kit_causal_id INT(11)
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE single_insert_result INT(11);
	DECLARE causal_id INT(11);
	DECLARE kit_depot_operation INT(11);
	DECLARE V_quantity DECIMAL(11,2);
	DECLARE V_product_code VARCHAR(16);
	DECLARE V_curA CURSOR FOR SELECT id_articolo, quantita
		FROM riferimento_kit_articoli
		WHERE id_kit = product_code;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	IF source_id = 1 THEN -- WE WANT TO SCALED ONLY FOR MANUAL OPERATION
		SELECT Operazione
			INTO kit_depot_operation
		FROM causale_magazzino
		WHERE Id_causale = kit_causal_id;
		
		SELECT Id_causale
			INTO causal_id
		FROM causale_magazzino
		WHERE tipo_magazzino = depot_id
			AND operazione = IF(kit_depot_operation = 1, 2, 1);

		OPEN V_curA;
		loopA: LOOP
			FETCH V_curA INTO V_product_code, V_quantity;
			IF done = 1 THEN 
				LEAVE loopA;
			END IF;
			
			CALL sp_ariesDepotOperationsInsert(
				(V_quantity * quantity) * -1,
				v_product_code,
				depot_id,
				doc_date,
				source_id,
				causal_id,
				single_insert_result
			);

			INSERT INTO magazzino_kit_riferimento
			SET Id_operazione_kit = kit_operation_id,
				Id_operazione_articolo = LAST_INSERT_ID();
		END LOOP;
		CLOSE V_curA;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotOperationsUnscaleKitProducts
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotOperationsUnscaleKitProducts`(
	IN kit_operation_id BIGINT(11),
	IN kit_source_id INT(11)
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_product_operation_id BIGINT(11);
	DECLARE V_id INT(11);
	DECLARE V_curA CURSOR FOR SELECT id, Id_operazione_articolo
		FROM magazzino_kit_riferimento
		WHERE Id_operazione_kit = kit_operation_id;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	IF kit_source_id = 1 THEN -- WE WANT TO UNSCALE ONLY FOR MANUAL OPERATION
		OPEN V_curA;
		loopA: LOOP
			FETCH V_curA INTO V_id, V_product_operation_id;
			IF done = 1 THEN 
				LEAVE loopA;
			END IF;
			
			DELETE FROM magazzino_kit_riferimento WHERE Id = V_id;
			DELETE FROM magazzino_operazione WHERE Id_operazione = V_product_operation_id;
		END LOOP;
		CLOSE V_curA;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotOperationsUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotOperationsUpdate`(
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16),
	depot_id INT(11),
	doc_date DATE,
	causal_id INT(11),
	operation_id INT(11),
	OUT result INT(11)
)
BEGIN

	UPDATE magazzino_operazione 
		SET `Data` = doc_date,
			causale = causal_id,
			articolo = product_code,
			quantità = quantity, 
			id_magazzino = dapot_id
	WHERE id_operazione = operation_id;

	SET result = 1;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductDelete`(
	IN depot_product_id INT(11),
	OUT result INT(11)
)
BEGIN

	DELETE
	FROM Magazzino
	WHERE Id = depot_product_id; 
	
	SET result = 1;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductDeleteByProductCodeAndDepotTypeId
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductDeleteByProductCodeAndDepotTypeId`(
	IN product_code VARCHAR(11),
	IN depot_type_id INT(11),
	OUT result INT(11)
)
BEGIN

	DELETE
	FROM Magazzino
	WHERE Magazzino.Id_articolo = product_code AND magazzino.tipo_magazzino = depot_type_id; 
	
	SET result = 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductGet
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductGet`(
)
BEGIN

	SELECT `Id`,
		`Id_articolo` ,
		Giacenza,
		Tipo_magazzino, 
		IFNULL(`Utente_ins` , 0) Utente_ins,
		Utente_mod,
		IFNULL(`Data_ins`, STR_TO_DATE('1970-01-01 00:00:00', '%Y-%m-%d')) data_ins,
		Data_mod
	FROM Magazzino; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductGetByCodeAndDepotTypeId
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductGetByCodeAndDepotTypeId`(
	IN depot_type_id INT(11), 
	IN product_code VARCHAR(11)
)
BEGIN

	SELECT `Id`,
		`Id_articolo` ,
		Giacenza,
		Tipo_magazzino, 
		IFNULL(`Utente_ins` , 0) Utente_ins,
		Utente_mod,
		IFNULL(`Data_ins`, STR_TO_DATE('1970-01-01 00:00:00', '%Y-%m-%d')) data_ins,
		Data_mod
	FROM Magazzino
	WHERE Id_articolo = product_code AND Tipo_magazzino = depot_type_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductGetById`(
	IN depot_product_id INT(11)
)
BEGIN

	SELECT `Id`,
		`Id_articolo` ,
		Giacenza,
		Tipo_magazzino, 
		IFNULL(`Utente_ins` , 0) Utente_ins,
		Utente_mod,
		IFNULL(`Data_ins`, STR_TO_DATE('1970-01-01 00:00:00', '%Y-%m-%d')) data_ins,
		Data_mod
	FROM Magazzino
	WHERE Id = depot_product_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductInsert`(
	IN product_code VARCHAR(11),
	IN depot_type_id INT(11),
	IN stock DECIMAL(11,2),
	OUT Result INT(11)
)
BEGIN


	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = 0;

	SELECT COUNT(Articolo.Codice_articolo) 
		INTO Result
	FROM Articolo 
	WHERE Articolo.Codice_articolo = product_code; 

	IF Result = 0 THEN
		SET Result = -1; -- product code not found
	ELSE
		SELECT COUNT(tipo_magazzino.Id_tipo) 
			INTO Result
		FROM tipo_magazzino 
		WHERE tipo_magazzino.Id_tipo = depot_type_id;
		
		IF Result = 0 THEN
			SET Result = -2; -- depot_type_id not found
		ELSE
			SELECT COUNT(Magazzino.Id) 
				INTO Result
			FROM Magazzino 
			WHERE Magazzino.id_articolo = product_code AND magazzino.tipo_magazzino = depot_type_id; 
			
			IF Result > 0 THEN
				SET Result = -3; -- product code alreadg exists for this depot type id
			END IF;
		END IF;
	END IF;
	
	IF Result >= 0 THEN
	
		INSERT INTO Magazzino 
		SET 
			Magazzino.Id_articolo = product_code, 
			magazzino.tipo_magazzino = depot_type_id, 
			magazzino.giacenza = stock, 
			magazzino.data_ultimo_movimento = NOW(),
			Magazzino.Data_ins = NOW(), 
			Magazzino.Utente_ins = @USER_ID, 
			Magazzino.Utente_mod = @USER_ID; 	 
		
		 SET Result  = LAST_INSERT_ID();
		 
	END IF; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductResetStocksBy
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductResetStocksBy`(
	IN depot_type_id INT(11),
	OUT Result INT(11)
)
BEGIN

	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = 0;
	
	If depot_type_id IS NOT NULL THEN
		SELECT COUNT(tipo_magazzino.Id_tipo) 
			INTO Result
		FROM tipo_magazzino 
		WHERE tipo_magazzino.Id_tipo = depot_type_id;

		IF Result = 0 THEN
			SET Result = -2; -- depot_type_id not found
		END IF;
	END IF;
	
	IF Result >= 0 THEN
	
		UPDATE Magazzino 
		SET 
			magazzino.giacenza = 0, 
			data_ultimo_movimento = NOW(),
			Magazzino.Utente_mod = @USER_ID
		WHERE IF(depot_type_id IS NULL, True, magazzino.tipo_magazzino = depot_type_id); 
		
		If depot_type_id IS NOT NULL THEN
		
			INSERT INTO magazzino_azzera 
				(data_azzeramento, Id_utente, Id_tipo_magazzino) 
			VALUES 
				(curdate(), @USER_ID, depot_type_id ); 
				
		ELSE
		
			INSERT INTO magazzino_azzera 
				(data_azzeramento, Id_utente, Id_tipo_magazzino) 
			SELECT 
				CURDATE(), 
				@USER_ID,
				tipo_magazzino.Id_tipo
			FROM Tipo_magazzino; 
			
		END IF; 
		
		SET Result  = 1;
		 
	END IF; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductStoredCurrentStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductStoredCurrentStatus`(
	IN stored_year SMALLINT, 
	IN description VARCHAR(100), 
	OUT Result INT(11)
)
BEGIN
	DECLARE stored_id INT DEFAULT 1; 
	
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = 0;
	

	IF Result >= 0 THEN
	
		INSERT INTO magazzino_arch
		SET
			magazzino_arch.anno = stored_year, 
			magazzino_arch.descrizione = description, 
			magazzino_arch.Utente_ins = @USER_ID, 
			magazzino_arch.Utente_mod = @USER_ID, 
			magazzino_arch.Data_ins = NOW();
			
		
		SET stored_id = LAST_INSERT_ID(); 
		
		INSERT INTO magazzino_stored 
		(  
			id_stored,	
			Id_articolo, 
			tipo_magazzino , 
			giacenza , 
			Data_ins,
			Data_mod, 
			Utente_ins, 
			Utente_mod
		)
		SELECT
			stored_id, 
			magazzino.Id_articolo, 
			magazzino.tipo_magazzino , 
			magazzino.giacenza , 
			magazzino.Data_ins, 
			magazzino.Data_mod,
			magazzino.Utente_ins, 
			magazzino.Utente_mod
		FROM Magazzino; 	 
		
		SET Result  = 1;
		 
	END IF; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotProductUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotProductUpdate`(
	IN product_code VARCHAR(11),
	IN depot_product_id INT(11), 
	IN depot_type_id INT(11),
	IN stock DECIMAL(11,2),
	OUT Result INT(11)
)
BEGIN

	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SET Result = 0;

	SELECT COUNT(Articolo.Codice_articolo) 
		INTO Result
	FROM Articolo 
	WHERE Articolo.Codice_articolo = product_code; 

	IF Result = 0 THEN
		SET Result = -1; -- product code not found
	ELSE
		SELECT COUNT(tipo_magazzino.Id_tipo) 
			INTO Result
		FROM tipo_magazzino 
		WHERE tipo_magazzino.Id_tipo = depot_type_id;
		
		IF Result = 0 THEN
			SET Result = -2; -- depot_type_id not found
		ELSE
			SELECT COUNT(Magazzino.Id) 
				INTO Result
			FROM Magazzino 
			WHERE Magazzino.id_articolo = product_code AND magazzino.tipo_magazzino = depot_type_id; 
			
			IF Result = 0 THEN
				SET Result = -4; -- not found record with this product code and depot type id
			END IF;
		END IF;
	END IF;
	
	IF Result >= 0 THEN
	
		UPDATE Magazzino 
		SET 
			Magazzino.Id_articolo = product_code, 
			magazzino.tipo_magazzino = depot_type_id, 
			magazzino.giacenza = stock, 
			data_ultimo_movimento = NOW(),
			Magazzino.Utente_mod = @USER_ID
		WHERE magazzino.Id = depot_product_id; 
		
		SET Result  = 1;
		 
	END IF; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotRebuildAll
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotRebuildAll`(
	OUT result INT (11)
)
BEGIN
	DECLARE quantity FLOAT(11,2);
	DECLARE product_code VARCHAR(100);
	DECLARE depot_id INT(11);
	DECLARE done INT DEFAULT 0;


	DECLARE V_curA CURSOR FOR
		SELECT `quantità`, articolo, id_magazzino
		FROM magazzino_operazione;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	UPDATE magazzino SET giacenza = 0;

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO quantity, product_code, depot_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;

		UPDATE magazzino
		SET 
			giacenza = giacenza + quantity
		WHERE id_articolo = product_code AND tipo_magazzino = depot_id;
		
	END LOOP;
	CLOSE V_curA;
	
	SET result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsDdtProductDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsDdtProductDelete`(
	ddt_id INT, ddt_year INT, tab_id INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE operation_id BIGINT;
	DECLARE reso_id BIGINT;
	
	DECLARE V_curA CURSOR FOR
		SELECT
			id_operazione,
			id_reso
		FROM magazzino_ddt_emessi
		WHERE id_ddt = ddt_id and anno_ddt = ddt_year and id_tab = tab_id;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO operation_id, reso_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		IF reso_id IS NOT NULL THEN
			CALL sp_ariesDepotOperationsDelete(reso_id);
		END IF;
		IF operation_id IS NOT NULL THEN
			CALL sp_ariesDepotOperationsDelete(operation_id);
		END IF;
	END LOOP;
	CLOSE V_curA;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsDdtProductInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsDdtProductInsert`(
	ddt_id INT,
	ddt_year INT,
	tab_id INT,
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16),
	depot_id INT
)
BEGIN
	DECLARE operation_id BIGINT(11);
	DECLARE reso_id BIGINT(11);
	
	DECLARE transport_causal_id VARCHAR(10);
	DECLARE causal_id INT(11);
	DECLARE operation_type INT(11);
	DECLARE new_quantity DECIMAL(11, 2);
	DECLARE doc_date DATE;
	DECLARE move_depot_id INT(11);

  -- get document date and transport causal id
	SELECT `data_documento`,
			causale
		INTO doc_date,
			transport_causal_id
	FROM ddt
	WHERE id_ddt = ddt_id
		AND anno = ddt_year;

	-- retrieve operation tpe and other depot id to trasfer if needed ( carico o scarico)
	SELECT operazione,
			ID_MAGA
		INTO operation_type,
			move_depot_id
	FROM causale_trasporto 
	WHERE id_causale = transport_causal_id;

	-- if operation is 2 or 4 it means it need to remove product from depot
	IF (operation_type = 2) OR (operation_type = 4) THEN 
		SET new_quantity = quantity * -1;
	ELSE
		SET new_quantity = quantity;
	END IF;

	-- get depot causal info
	SELECT id_causale,
		reso
	INTO causal_id,
		reso_id
	FROM causale_magazzino
	WHERE tipo_magazzino = depot_id
		AND Operazione = IF(operation_type > 2, operation_type - 2, operation_type);

	-- scale from depot
	CALL sp_ariesDepotOperationsInsert(
			new_quantity,
			product_code,
			depot_id,
			doc_date,
			3,
			causal_id,
			operation_id
		); 
	INSERT INTO magazzino_ddt_emessi(id_operazione, anno_ddt, id_ddt, id_tab)
		VALUES (operation_id, ddt_year, ddt_id, tab_id);

	-- IF ooperation type is 3 or 4 we are moving produt between depots, scale from other depot
	IF (operation_type = 3) OR (operation_type = 4) THEN
		CALL sp_ariesDepotOperationsInsert(
			new_quantity * -1,
			product_code,
			move_depot_id,
			doc_date,
			3,
			causal_id,
			operation_id
		);

		UPDATE magazzino_ddt_emessi
		SET id_reso = operation_id
		WHERE anno_ddt = ddt_year AND id_ddt = ddt_id  AND id_tab = tab_id;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsInvoiceProductDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsInvoiceProductDelete`(
	invoice_id INT, invoice_year INT, tab_id INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE operation_id BIGINT;
	
	DECLARE V_curA CURSOR FOR
		SELECT
			id_operazione
		FROM magazzino_fattura
		WHERE id_fattura = invoice_id and anno = invoice_year and id_tab = tab_id;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO operation_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;

		IF operation_id IS NOT NULL THEN
			CALL sp_ariesDepotOperationsDelete(operation_id);
		END IF;
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsInvoiceProductInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsInvoiceProductInsert`(
	invoice_id INT,
	invoice_year INT,
	tab_id INT,
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16),
	depot_id INT
)
BEGIN
	DECLARE operation_id BIGINT(11);
	DECLARE causal_id INT(11);
	DECLARE reso_id INT(11);
	DECLARE doc_date DATE;

	SELECT id_causale,
		reso
	INTO causal_id,
		reso_id
	FROM causale_magazzino
	WHERE tipo_magazzino = depot_id
		AND Operazione = 2;

	SELECT `data`
		INTO doc_date
	FROM fattura
	WHERE id_fattura = invoice_id
		AND anno = invoice_year;

	CALL sp_ariesDepotOperationsInsert(
		quantity * -1,
		product_code,
		depot_id,
		doc_date,
		7,
		causal_id,
		operation_id
	);

	INSERT INTO magazzino_fattura(id_operazione,anno,id_fattura,id_tab)
		VALUES (operation_id, invoice_year, invoice_id, tab_id);

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsReceivedDdtDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsReceivedDdtDelete`(
	ddt_id INT, ddt_year INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_operation_id BIGINT(11);
	DECLARE V_reso_id BIGINT(11);
	DECLARE V_curA CURSOR FOR SELECT id_operazione, id_reso
		FROM magazzino_ddt_emessi 
		WHERE id_ddt = ddt_id AND anno_ddt = ddt_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO V_operation_id, V_reso_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		CALL sp_ariesDepotOperationsDelete(V_operation_id);
		IF V_reso_id IS NOT NULL THEN
			CALL sp_ariesDepotOperationsDelete(V_reso_id);
		END IF;
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsReceivedDdtProductDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsReceivedDdtProductDelete`(
	ddt_id INT, ddt_year INT, tab_id INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE operation_id BIGINT;
	DECLARE reso_id BIGINT;
	
	DECLARE V_curA CURSOR FOR
		SELECT
			id_operazione,
			id_reso
		FROM magazzino_ddt_ricevuti
		WHERE id_ddt = ddt_id and id_anno = ddt_year and id_tab = tab_id;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO operation_id, reso_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		IF reso_id IS NOT NULL THEN
			CALL sp_ariesDepotOperationsDelete(reso_id);
		END IF;
		IF operation_id IS NOT NULL THEN
			CALL sp_ariesDepotOperationsDelete(operation_id);
		END IF;
	END LOOP;
	CLOSE V_curA;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsReceivedDdtProductInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsReceivedDdtProductInsert`(
	ddt_id INT,
	ddt_year INT,
	tab_id INT,
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16),
	depot_id INT
)
BEGIN
	DECLARE operation_id BIGINT(11);
	DECLARE reso_id BIGINT(11);
	
	DECLARE transport_causal_id VARCHAR(10);
	DECLARE causal_id INT(11);
	DECLARE operation_type INT(11);
	DECLARE new_quantity DECIMAL(11, 2);
	DECLARE doc_date DATE;
	DECLARE move_depot_id INT(11);

  -- get document date and transport causal id
	SELECT `data_documento`,
			causale
		INTO doc_date,
			transport_causal_id
	FROM ddt_ricevuti
	WHERE id_ddt = ddt_id
		AND anno = ddt_year;

	-- retrieve operation tpe and other depot id to trasfer if needed ( carico o scarico)
	SELECT operazione,
			ID_MAGA
		INTO operation_type,
			move_depot_id
	FROM causale_trasporto 
	WHERE id_causale = transport_causal_id;

	-- if operation is 2 or 4 it means it need to remove product from depot
	IF (operation_type = 2) OR (operation_type = 4) THEN 
		SET new_quantity = quantity * -1;
	ELSE
		SET new_quantity = quantity;
	END IF;

	-- get depot causal info
	SELECT id_causale,
		reso
	INTO causal_id,
		reso_id
	FROM causale_magazzino
	WHERE tipo_magazzino = depot_id
		AND Operazione = IF(operation_type > 2, operation_type - 2, operation_type);

	-- scale from depot
	CALL sp_ariesDepotOperationsInsert(
		new_quantity,
		product_code,
		depot_id,
		doc_date,
		8,
		causal_id,
		operation_id
	);

	INSERT INTO magazzino_ddt_ricevuti(id_operazione,id_anno,id_ddt,id_tab)
		VALUES (operation_id, ddt_year, ddt_id, tab_id);

	-- IF ooperation type is 3 or 4 we are moving produt between depots, scale from other depot
	IF (operation_type = 3) OR (operation_type = 4) THEN 
		CALL sp_ariesDepotOperationsInsert(
			new_quantity * -1,
			product_code,
			move_depot_id,
			doc_date,
			8,
			causal_id,
			operation_id
		);

		UPDATE magazzino_ddt_ricevuti
		SET id_reso = operation_id
		WHERE id_anno = ddt_year AND id_ddt = ddt_id  AND id_tab = tab_id;
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsReportProductDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsReportProductDelete`(
	report_id INT, report_year INT, tab_id INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE operation_id BIGINT;
	
	DECLARE V_curA CURSOR FOR
		SELECT
			id_operazione
		FROM magazzino_rapporto_materiale
		WHERE id_rapporto = report_id and anno_rapporto = report_year and id_tab = tab_id;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO operation_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;

		IF operation_id IS NOT NULL THEN
			CALL sp_ariesDepotOperationsDelete(operation_id);
		END IF;
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsReportProductInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsReportProductInsert`(
	report_id INT,
	report_year INT,
	tab_id INT,
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16),
	depot_id INT
)
BEGIN
	DECLARE operation_id BIGINT(11);
	DECLARE causal_id INT(11);
	DECLARE report_execution_date DATE;

	SELECT data_esecuzione
	INTO report_execution_date
	FROM rapporto
	WHERE id_rapporto = report_id AND anno = report_year;

	SELECT id_causale
	INTO causal_id
	FROM causale_magazzino
	WHERE tipo_magazzino = depot_id
		AND Operazione = 2;

	CALL sp_ariesDepotOperationsInsert(
		quantity * -1,
		product_code,
		depot_id,
		report_execution_date,
		2,
		causal_id,
		operation_id
	); 

	SET operation_id = LAST_INSERT_ID(); 

	INSERT INTO magazzino_rapporto_materiale (id_operazione, id_rapporto, anno_rapporto, id_tab)
		VALUES (operation_id, report_id, report_year, tab_id);

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsScaleByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsScaleByReport`(
	report_id INT, report_year INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_id_tab INT;
	DECLARE V_id_materiale VARCHAR(11);
	DECLARE V_quantity DECIMAL(11,2);
	DECLARE allow_insert BIT(1);
	DECLARE V_curA CURSOR FOR SELECT Id_tab, id_materiale, quantità
		FROM rapporto_materiale
		WHERE id_rapporto = report_id AND anno = report_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
	
	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO V_id_tab, V_id_materiale, V_quantity;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;

		IF V_id_materiale IS NOT NULL THEN
			SELECT  fnc_productAllowDepotsScale(V_id_materiale)
				INTO allow_insert;

			IF allow_insert THEN
				CALL sp_ariesDepotsScaleByReportProduct(report_id, report_year, V_id_tab, V_quantity, V_id_materiale);
			END IF;
		END IF;
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsScaleByReportProduct
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsScaleByReportProduct`(
	report_id INT, report_year INT, tab_id INT,
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16)
)
BEGIN
	DECLARE has_ddt_link BIT(1);
	DECLARE has_depot_link BIT(1);
	DECLARE depot_id INT(11);
	DECLARE operation_id BIGINT(11);
	DECLARE causal_id INT(11);
	DECLARE reso_id INT(11);
	
	SELECT fnc_reportHasDdtLink(report_id, report_year)
		INTO has_ddt_link;

	IF has_ddt_link = 0 THEN
		SELECT
			id_magazzino
		INTO
			depot_id
		FROM rapporto_materiale
		WHERE id_rapporto = report_id
			AND anno = report_year
			AND id_tab = tab_id;
			
		IF product_code IS NOT NULL AND depot_id IS NOT NULL THEN
			CALL sp_ariesDepotsReportProductInsert(report_id, report_year, tab_id, quantity,
				product_code, depot_id);
		END IF;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsSupplierInvoiceProductDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsSupplierInvoiceProductDelete`(
	invoice_id INT, invoice_year INT, tab_id INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE operation_id BIGINT;
	
	DECLARE V_curA CURSOR FOR
		SELECT
			id_operazione
		FROM magazzino_fornfattura
		WHERE id_fattura = invoice_id and anno = invoice_year and id_tab = tab_id;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO operation_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;

		IF operation_id IS NOT NULL THEN
			CALL sp_ariesDepotOperationsDelete(operation_id);
		END IF;
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsSupplierInvoiceProductInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsSupplierInvoiceProductInsert`(
	invoice_id INT,
	invoice_year INT,
	tab_id INT,
	quantity DECIMAL(11, 2),
	product_code VARCHAR(16),
	depot_id INT
)
BEGIN
	DECLARE operation_id BIGINT(11);
	DECLARE causal_id INT(11);
	DECLARE reso_id INT(11);
	DECLARE doc_date DATE;

	SELECT id_causale,
		reso
	INTO causal_id,
		reso_id
	FROM causale_magazzino
	WHERE tipo_magazzino = depot_id
		AND Operazione = 1;

	SELECT `data`
		INTO doc_date
	FROM fornfattura
	WHERE id_fattura = invoice_id
		AND anno = invoice_year;

	CALL sp_ariesDepotOperationsInsert(
		quantity,
		product_code,
		depot_id,
		doc_date,
		6,
		causal_id,
		operation_id
	);

	INSERT INTO magazzino_fornfattura(id_operazione,anno,id_fattura,id_tab)
		VALUES (operation_id, invoice_year, invoice_id, tab_id);
  
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsUndoScaleByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsUndoScaleByReport`(
	report_id INT, report_year INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_id_tab INT;
	DECLARE V_curA CURSOR FOR SELECT Id_tab
		FROM magazzino_rapporto_materiale
		WHERE id_rapporto = report_id AND anno_rapporto = report_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
	
	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO V_id_tab;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		CALL sp_ariesDepotsUndoScaleByReportProduct(report_id, report_year, V_id_tab);
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotsUndoScaleByReportProduct
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotsUndoScaleByReportProduct`(
	report_id INT, report_year INT, tab_id INT
)
BEGIN
	DECLARE has_ddt_link BIT(1);
	DECLARE has_depot_link BIT(1);
	DECLARE quantity DECIMAL(11, 2);
	DECLARE product_code VARCHAR(16);
	DECLARE depot_id INT(11);
	
	SELECT fnc_reportHasDdtLink(report_id, report_year)
		INTO has_ddt_link;

	IF has_ddt_link = 0 THEN
		
		SELECT fnc_reportProductHasDepotLink(report_id, report_year, tab_id)
			INTO has_depot_link;

		IF has_depot_link = 1 THEN

			SELECT quantità,
				Id_materiale,
				id_magazzino
			INTO quantity,
				product_code,
				depot_id
			FROM rapporto_materiale
			WHERE id_rapporto = report_id
				AND anno = report_year
				AND id_tab = tab_id;
				
			IF product_code IS NOT NULL AND depot_id IS NOT NULL THEN
				CALL sp_ariesDepotsReportProductDelete(report_id, report_year, tab_id);
			END IF;
		END IF;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotTypeDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotTypeDelete`(
	IN `depot_id` INT(11),
	OUT result INT(11)
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	DELETE FROM magazzino_azzera WHERE id_tipo_magazzino = depot_id;
	DELETE FROM magazzino_operazione WHERE id_magazzino = depot_id;
	DELETE FROM magazzino_stored WHERE tipo_magazzino = depot_id;
	DELETE FROM causale_magazzino WHERE tipo_magazzino = depot_id;
	DELETE FROM magazzino WHERE tipo_magazzino = depot_id;
	DELETE FROM tipo_magazzino WHERE Id_tipo = depot_id;
	
	SET Result = 1;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotTypeGet
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotTypeGet`(
)
BEGIN

	SELECT `Id_tipo`,
		`nome` ,
		Descrizione,
		IFNULL(prior, -1) prior,
		IFNULL(id_master, -1) id_master,
		IFNULL(reso, 0) reso,
		disabilitato
	FROM Tipo_magazzino; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotTypeGetByDepotCausal
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotTypeGetByDepotCausal`(
	IN causal_type_id VARCHAR(8)
)
BEGIN

	SELECT `Id_tipo`,
		Tipo_magazzino.`nome` ,
		Tipo_magazzino.Descrizione,
		IFNULL(prior, -1) prior,
		IFNULL(id_master, -1) id_master,
		IFNULL(Tipo_magazzino.reso, 0) reso,
		disabilitato
	FROM Tipo_magazzino
		INNER JOIN Causale_magazzino ON Tipo_magazzino.Id_tipo = causale_magazzino.tipo_magazzino
	WHERE Causale_magazzino.id_causale = causal_type_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotTypeGetById`(
	IN depot_type_id INT(11)
)
BEGIN

	SELECT `Id_tipo`,
		`nome` ,
		Descrizione,
		IFNULL(prior, -1) prior,
		IFNULL(id_master, -1) id_master,
		IFNULL(reso, 0) reso,
		disabilitato
	FROM Tipo_magazzino
	WHERE Id_tipo = depot_type_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotTypeGetWithHighestPriority
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotTypeGetWithHighestPriority`( )
BEGIN

	SELECT `Id_tipo`,
		`nome` ,
		Descrizione,
		IFNULL(prior, -1) prior,
		IFNULL(id_master, -1) id_master,
		IFNULL(reso, 0) reso,
		disabilitato
	FROM Tipo_magazzino
	ORDER BY prior DESC
	LIMIT 1; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDepotTypeUpdateDisbaled
DELIMITER //
CREATE PROCEDURE `sp_ariesDepotTypeUpdateDisbaled`(
	IN `depot_id` INT(11),
	IN depot_disabled BIT(1),
	OUT result INT(11)
)
BEGIN
	UPDATE tipo_magazzino SET disabilitato = depot_disabled WHERE Id_tipo = depot_id;
	
	SET Result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDocumentPrinterGet
DELIMITER //
CREATE PROCEDURE `sp_ariesDocumentPrinterGet`()
BEGIN

	SELECT 
		Id_documento,
		Stampante,
		copie
	FROM stampante_documento
	WHERE Id_utente = @USER_ID; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDocumentPrinterGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesDocumentPrinterGetById`(
	IN document_id INT(11)
)
BEGIN

	SELECT 
		Id_documento,
		Stampante,
		copie
	FROM stampante_documento
	WHERE Id_utente = @USER_ID AND Id_documento = document_id; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDocumentPrinterInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesDocumentPrinterInsert`(
	IN `document_id` INT(11),
	IN `printer_name` VARCHAR(100), 
	IN `copies_number` INT(11),
	OUT Result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;

	INSERT INTO stampante_documento
	SET 
		Id_documento = document_id, 
		Stampante = printer_name, 
		copie = copies_number, 
		Id_utente = @USER_ID;

	SET Result = 1;
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDocumentPrinterUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesDocumentPrinterUpdate`(
	IN `document_id` INT(11),
	IN `printer_name` VARCHAR(100), 
	IN `copies_number` INT(11),
	OUT Result INT(11)
)
BEGIN
   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;

	UPDATE stampante_documento
	SET
		Stampante = printer_name, 
		copie = copies_number
	WHERE Id_utente = @USER_ID AND Id_documento = document_id; 	

	SET Result = 1;
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesDocumentTypeObjGet
DELIMITER //
CREATE PROCEDURE `sp_ariesDocumentTypeObjGet`()
BEGIN

	SELECT 
		`Id_tipo`,
		Nome,
		Descrizione
	FROM tipo_documento; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEInvoiceVersionGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEInvoiceVersionGet`(
)
BEGIN

	SELECT `id_fattura_elettronica_versione`,
		`versione`,
		`codice_versione_pa`,
		`codice_versione_privato`,
		`styles_versione_pa`,
		`local_styles_versione_pa`,
		`styles_versione_privato`,
		`local_styles_versione_privato`,
		`data_inizio`,
		`data_fine`,
		`corrente`,
		`data_mod`
	FROM fattura_elettronica_versione;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEInvoiceVersionGetByDate
DELIMITER //
CREATE PROCEDURE `sp_ariesEInvoiceVersionGetByDate`(
		IN `in_date` DATE
)
BEGIN

	SELECT `id_fattura_elettronica_versione`,
		`versione`,
		`codice_versione_pa`,
		`codice_versione_privato`,
		`styles_versione_pa`,
		`local_styles_versione_pa`,
		`styles_versione_privato`,
		`local_styles_versione_privato`,
		`data_inizio`,
		`data_fine`,
		`corrente`,
		`data_mod`
	FROM fattura_elettronica_versione
	WHERE (in_date >= data_inizio) AND (in_date <= data_fine OR data_fine IS NULL);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailDelete`(
	IN `email_id` INT(11),
	OUT result SMALLINT
)
BEGIN

	DECLARE email_status SMALLINT; 
	

	
	SELECT COUNT(mail.Id)
		INTO Result
	FROM mail
	WHERE 
		mail.id = email_id;
		
	IF Result <= 0 THEN
		SET Result = -3; -- email not found	
	END IF;

	

	
	IF Result >= 0 THEN
	
		-- control if is in draft
		SELECT mail.Id_stato
			INTO email_status
		FROM mail
		WHERE 
			mail.id = email_id;
			
			
		If email_status = 5 THEN
			DELETE FROM mail
			WHERE mail.Id = email_id;  
		ELSE
			UPDATE mail
			SET Id_stato = 6
			WHERE mail.Id = email_id;  
		END IF; 
		
		SET Result = 1;
	END IF; 
		

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGet`()
BEGIN
	SELECT 
		`Id`,
		`Id_mittente`,
		IFNULL(`Destinatari_cc`, "") Destinatari_cc,
		IFNULL(`Destinatari_ccn`, "") Destinatari_ccn,
		`Oggetto`,
		`Corpo`,
		`Pec`,
		`Id_stato`,
		IFNULL(`Id_risposta`, 0) Id_risposta,
		IFNULL(`Id_gruppo`, 0) Id_gruppo,
		IFNULL(`Tipo`, '1') Tipo,
		IFNULL(`Id_documento`, "") Id_documento,
		IFNULL(`Anno_documento`, "") Anno_documento,
		IFNULL(`Revisione_documento`, "") Revisione_documento,
		IFNULL(`Tipo_documento`, "") Tipo_documento,
		`Tentativo`,
		`Data_invio`,
		`Letto`,
		IFNULL(Id_stato_errore, 0) Id_stato_errore, 
		IFNULL(Messaggio_errore, "") Messaggio_errore,
		`Data_ins`,
		IFNULL(Data_mod, STR_TO_DATE('1970-01-01', '%Y-%m-%d')) Data_mod,
		`Utente_ins`,
		IFNULL(`Utente_mod`, 0) Utente_mod
	FROM mail
	WHERE mail.Id_stato <> 6
	ORDER BY Id DESC; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGetById`(IN enter_id INT(11))
BEGIN
	SELECT 
		`Id`,
		`Id_mittente`,
		IFNULL(`Destinatari_cc`, "") Destinatari_cc,
		IFNULL(`Destinatari_ccn`, "") Destinatari_ccn,
		`Oggetto`,
		`Corpo`,
		`Pec`,
		`Id_stato`,
		IFNULL(`Id_risposta`, 0) Id_risposta,
		IFNULL(`Id_gruppo`, 0) Id_gruppo,
		IFNULL(`Tipo`, '1') Tipo,
		IFNULL(`Id_documento`, "") Id_documento,
		IFNULL(`Anno_documento`, "") Anno_documento,
		IFNULL(`Revisione_documento`, "") Revisione_documento,
		IFNULL(`Tipo_documento`, "") Tipo_documento,

		`Tentativo`,
		`Data_invio`,
		`Letto`,
		IFNULL(Id_stato_errore, 0) Id_stato_errore, 
		IFNULL(Messaggio_errore, "") Messaggio_errore,
		`Data_ins`,
		IFNULL(Data_mod, STR_TO_DATE('1970-01-01', '%Y-%m-%d')) Data_mod,
		`Utente_ins`,
		IFNULL(`Utente_mod`, 0) Utente_mod
	FROM mail
	WHERE Id = enter_id; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGetByStatusId
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGetByStatusId`(IN `status_id` MEDIUMINT(9))
BEGIN
	SELECT 
		`Id`,
		`Id_mittente`,
		IFNULL(`Destinatari_cc`, "") Destinatari_cc,
		IFNULL(`Destinatari_ccn`, "") Destinatari_ccn,
		`Oggetto`,
		`Corpo`,
		`Pec`,
		`Id_stato`,
		IFNULL(`Id_risposta`, 0) Id_risposta,
		IFNULL(`Id_gruppo`, 0) Id_gruppo,
		IFNULL(`Tipo`, '1') Tipo,
		IFNULL(`Id_documento`, "") Id_documento,
		IFNULL(`Anno_documento`, "") Anno_documento,
		IFNULL(`Revisione_documento`, "") Revisione_documento,
		IFNULL(`Tipo_documento`, "") Tipo_documento,
		`Tentativo`,
		`Data_invio`,
		`Letto`,
		IFNULL(Id_stato_errore, 0) Id_stato_errore, 
		IFNULL(Messaggio_errore, "") Messaggio_errore,
		`Data_ins`,
		IFNULL(Data_mod, STR_TO_DATE('1970-01-01', '%Y-%m-%d')) Data_mod,
		`Utente_ins`,
		IFNULL(`Utente_mod`, 0) Utente_mod
	FROM mail
	WHERE mail.Id_stato = status_id
	ORDER BY Id DESC;	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGetByUserPermissions
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGetByUserPermissions`(IN user_id INT(11))
BEGIN

	DECLARE is_admin BIT;
	
	SELECT COUNT(Id_utente)
	INTO is_admin
	FROM Utente
	WHERE Utente.Id_utente = user_id AND nome = 'admin'; 	 

	IF is_admin THEN
		CALL sp_ariesEmailGet();
	ELSE
		
		SELECT DISTINCT
			`Id`,
			`Id_mittente`,
			IFNULL(`Destinatari_cc`, "") Destinatari_cc,
			IFNULL(`Destinatari_ccn`, "") Destinatari_ccn,
			`Oggetto`,
			`Corpo`,
			`Pec`,
			`Id_stato`,
			IFNULL(`Id_risposta`, 0) Id_risposta,
			IFNULL(`Id_gruppo`, 0) Id_gruppo,
			IFNULL(`Tipo`, '1') Tipo,
			IFNULL(`Id_documento`, "") Id_documento,
			IFNULL(`Anno_documento`, "") Anno_documento,
			IFNULL(`Revisione_documento`, "") Revisione_documento,
			IFNULL(`Tipo_documento`, "") Tipo_documento,
	
			`Tentativo`,
			`Data_invio`,
			`Letto`,
			IFNULL(Id_stato_errore, 0) Id_stato_errore, 
			IFNULL(Messaggio_errore, "") Messaggio_errore,
			`Data_ins`,
			IFNULL(Data_mod, STR_TO_DATE('1970-01-01', '%Y-%m-%d')) Data_mod,
			`Utente_ins`,
			IFNULL(`Utente_mod`, 0) Utente_mod
		FROM mail
			INNER JOIN utente_mail
			ON utente_mail.id_utente = user_id
				AND utente_mail.id_utente_mail IN (mail.id_mittente, mail.Utente_ins, mail.Utente_mod)
			
		ORDER BY Id DESC;
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGetByUserPermissionsAndStatusId
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGetByUserPermissionsAndStatusId`(IN user_id INT(11), IN `status_id` MEDIUMINT(9))
BEGIN

	DECLARE is_admin BIT; 
	
	SELECT COUNT(Id_utente)
	INTO is_admin
	FROM Utente
	WHERE Utente.Id_utente = user_id AND nome = 'admin'; 	 

	IF is_admin THEN
		CALL sp_ariesEmailGetByStatusId(status_id);
	ELSE
	  
		
		SELECT DISTINCT
			`Id`,
			`Id_mittente`,
			IFNULL(`Destinatari_cc`, "") Destinatari_cc,
			IFNULL(`Destinatari_ccn`, "") Destinatari_ccn,
			`Oggetto`,
			`Corpo`,
			`Pec`,
			`Id_stato`,
			IFNULL(`Id_risposta`, 0) Id_risposta,
			IFNULL(`Id_gruppo`, 0) Id_gruppo,
			IFNULL(`Tipo`, '1') Tipo,
			IFNULL(`Id_documento`, "") Id_documento,
			IFNULL(`Anno_documento`, "") Anno_documento,
			IFNULL(`Revisione_documento`, "") Revisione_documento,
			IFNULL(`Tipo_documento`, "") Tipo_documento,
	
			`Tentativo`,
			`Data_invio`,
			`Letto`,
			IFNULL(Id_stato_errore, 0) Id_stato_errore, 
			IFNULL(Messaggio_errore, "") Messaggio_errore,
			`Data_ins`,
			IFNULL(Data_mod, STR_TO_DATE('1970-01-01', '%Y-%m-%d')) Data_mod,
			`Utente_ins`,
			IFNULL(`Utente_mod`, 0) Utente_mod
		FROM mail
			INNER JOIN utente_mail
			ON utente_mail.id_utente = user_id
				AND utente_mail.id_utente_mail IN (mail.id_mittente, mail.Utente_ins, mail.Utente_mod)
		WHERE mail.Id_stato = status_id	
		ORDER BY Id DESC;
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGetScheduledToSend
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGetScheduledToSend`()
BEGIN
	SELECT 
		`Id`,
		`Id_mittente`,
		IFNULL(`Destinatari_cc`, "") Destinatari_cc,
		IFNULL(`Destinatari_ccn`, "") Destinatari_ccn,
		`Oggetto`,
		`Corpo`,
		`Pec`,
		`Id_stato`,
		IFNULL(`Id_risposta`, 0) Id_risposta,
		IFNULL(`Id_gruppo`, 0) Id_gruppo,
		IFNULL(`Tipo`, '1') Tipo,
		IFNULL(`Id_documento`, "") Id_documento,
		IFNULL(`Anno_documento`, "") Anno_documento,
		IFNULL(`Revisione_documento`, "") Revisione_documento,
		IFNULL(`Tipo_documento`, "") Tipo_documento,
		`Tentativo`,
		`Data_invio`,
		`Letto`,
		IFNULL(Id_stato_errore, 0) Id_stato_errore, 
		IFNULL(Messaggio_errore, "") Messaggio_errore,
		`Data_ins`,
		IFNULL(Data_mod, STR_TO_DATE('1970-01-01', '%Y-%m-%d')) Data_mod,
		`Utente_ins`,
		IFNULL(`Utente_mod`, 0) Utente_mod
	FROM mail
		INNER JOIN mail_scheduler 
		ON mail.Id = mail_scheduler.id_schedulazione AND CAST(CONCAT(mail_scheduler.data_inizio, ' ', mail_scheduler.ora_inizio) AS DATETIME) < NOW() 
	WHERE mail.Id_stato = 3 ; 		
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGroupGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGroupGet`()
BEGIN
	SELECT 
		`Id_gruppo`,
		`nome`, 
		`descrizione`,
		`Tipo`
	FROM mail_gruppo
	ORDER BY nome; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGroupGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGroupGetById`(
	IN group_id INT(11)
)
BEGIN

	SELECT 
		`Id_gruppo`,
		`nome`, 
		`descrizione`,
		`Tipo`
	FROM mail_gruppo
	WHERE Id_gruppo = group_id; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailGroupGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailGroupGetByName`(
	IN group_name VARCHAR(45)
)
BEGIN

	SELECT 
		`Id_gruppo`,
		`nome`, 
		`descrizione`,
		`Tipo`
	FROM mail_gruppo
	WHERE nome = group_name; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailInsert`(
	IN `sender_id` INT(11),
	IN `recipients_cc` VARCHAR(500),
	IN `recipients_ccn` VARCHAR(500),
	IN `subject` VARCHAR(100),
	IN `body` TEXT,
	IN `is_pec` BIT,
	IN `status_id` INT(11),
	IN `response_id` INT(11),
	IN `group_id` INT(11),
	IN `mail_type` VARCHAR(15),
	IN `document_id` VARCHAR(10),
	IN `document_year` VARCHAR(10),
	IN `document_review` VARCHAR(10),
	IN `document_type` VARCHAR(30),
	IN `attempts` TINYINT(4),
	IN `send_date` DATETIME,
	IN `is_read` BIT(1),
	IN `error_status_id` MEDIUMINT(9),
	IN `error_message` VARCHAR(500),
	OUT result INT(32)
)
BEGIN

	SELECT COUNT(mail_stato.id_Stato)
		INTO Result
	FROM mail_stato
	WHERE 
		mail_stato.id_Stato = status_id;
		
	IF Result > 0 THEN
		SELECT COUNT(utente.Id_utente)
			INTO Result
		FROM utente
		WHERE 
			utente.id_utente = sender_id;
			
		IF Result <= 0 THEN
			SET Result = -2; -- user not found	
		END IF;
	ELSE 
		SET Result = -1; -- email status found	
	END IF;  
	

	IF Result >= 0 THEN
		INSERT INTO mail
		SET 		
			Id_mittente = sender_id,
			Destinatari_cc = recipients_cc,
			Destinatari_ccn = recipients_ccn,
			Oggetto = subject,
			Corpo = body,
			Pec = is_pec,
			Id_stato = status_id,
			Id_risposta = response_id,
			Id_gruppo = group_id,
			Tipo = mail_type,
			Id_documento = document_id,
			Anno_documento = document_year,
			Revisione_documento = document_review,
			Tipo_documento = document_type,
			Tentativo = attempts,
			Data_invio = send_date,
			Letto = is_read,
			Id_stato_errore = error_status_id,
			Messaggio_errore = error_message,
			Data_ins = NOW(),
			Utente_ins = @USER_ID; 
		
		SET Result = LAST_INSERT_ID();
		
		CALL sp_ariesEmailSetDocumentStatus(Result); 
		CALL sp_ariesEmailWriteSideEffects(Result); 
		
	END IF; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailSchedulerGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailSchedulerGet`()
BEGIN
	SELECT 
		`id_schedulazione`,
		`data_inizio`, 
		`ora_inizio`,
		`Stato`, 
		Utente
	FROM mail_scheduler; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailSchedulerGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailSchedulerGetById`(
	IN scheduler_id INT(11)
)
BEGIN

	SELECT 
		`id_schedulazione`,
		`data_inizio`, 
		`ora_inizio`,
		`Stato`, 
		Utente
	FROM mail_scheduler
	WHERE id_schedulazione = scheduler_id; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailSchedulerInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailSchedulerInsert`(
	IN scheduler_id INT(11), 
	IN start_date DATE, 
	IN start_time TIME, 
	IN Status_id INT(11), 
	IN user_id SMALLINT, 
	OUT result SMALLINT
)
BEGIN

	SET result = 1; 
	
	INSERT IGNORE INTO mail_scheduler 
	SET 
		`id_schedulazione` = scheduler_id,
		`data_inizio` = start_date, 
		`ora_inizio` = start_time,
		`Stato` = Status_id, 
		Utente = user_id; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailSetAllFailedAsCanceled
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailSetAllFailedAsCanceled`()
BEGIN
	
	UPDATE mail
	SET Id_stato = 4 -- canceled 
	WHERE Id_stato = 2; -- failed
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailSetAllFailedAsCanceledByUserPermissions
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailSetAllFailedAsCanceledByUserPermissions`(IN user_id INT(11))
BEGIN
	
	DECLARE is_admin BIT;
	
	SELECT COUNT(Id_utente)
	INTO is_admin
	FROM Utente
	WHERE Utente.Id_utente = user_id AND nome = 'admin'; 	 

	IF is_admin THEN
		CALL sp_ariesEmailSetAllFailedAsCanceled();
	ELSE
	
		UPDATE mail
			INNER JOIN utente_mail
			ON utente_mail.id_utente = user_id
				AND utente_mail.id_utente_mail IN (mail.id_mittente, mail.Utente_ins, mail.Utente_mod)
		SET Id_stato = 4
		WHERE Id_stato = 2;
		 
	END IF; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailSetDocumentStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailSetDocumentStatus`(
	IN `email_id` INT(11)
)
BEGIN
	
	DECLARE DocumentType VARCHAR(30); 
	DECLARE DocumentId VARCHAR(10);
	DECLARE DocumentYear VARCHAR(10); 
	DECLARE DocumentReview VARCHAR(10); 
	DECLARE StatusId INT(11);
	DECLARE SystemId INT(11); 
	DECLARE ReminderNumber TINYINT;
	
	SELECT mail.Tipo_documento,
		mail.Id_documento,
		mail.anno_documento, 
		mail.Revisione_documento, 
		mail.Id_stato 
	INTO 
		DocumentType, 
		DocumentId, 
		DocumentYear, 
		DocumentReview, 
		StatusId
	FROM mail
	WHERE Id = email_id; 
	
	IF (DocumentType IS NOT NULL) AND (StatusId = 1 OR DocumentType = 'rapporto_mobile_intervento' OR DocumentType = 'rapporto_mobile_collaudo')  THEN
		
		IF DocumentType = 'prev' THEN -- if document is quote
		
			UPDATE revisione_preventivo 
			SET inviato=1 
			WHERE id_preventivo=DocumentId AND anno = DocumentYear AND id_revisione = DocumentReview;
		   
			UPDATE preventivo 
			SET stato=3,
				data_invio=curdate() 
			WHERE id_preventivo = DocumentId AND anno = DocumentYear AND stato IN (5, 6); 
			
		END IF;
		
		
		
		IF DocumentType = 'sollecito_preventivo' AND (DocumentId IS NOT NULL) THEN
			
			UPDATE preventivo 
			SET secondo_sollecito = NOW()
			WHERE id_preventivo = DocumentId AND anno = DocumentYear AND primo_sollecito IS NOT NULL;  
				
			UPDATE preventivo 
			SET primo_sollecito = NOW()
			WHERE id_preventivo = DocumentId AND anno = DocumentYear AND primo_sollecito IS NULL;  	
			
		END IF;
		
		
		
		IF DocumentType = 'fatt' THEN
			UPDATE fattura 
			SET inviato = 1 
			WHERE id_fattura = DocumentId AND anno= DocumentYear;
		END IF;
		
		
		
		IF DocumentType = 'tk' THEN
		
			SELECT IFNULL(Id_impianto, -1) 
				INTO 
				SystemId
			FROM Ticket
			WHERE Id = DocumentId;
		
			UPDATE ticket  
			SET Stato_ticket=2, 
				inviato=1 
			WHERE id_impianto = SystemId;
			
		END IF;
		
		
		
		IF DocumentType = 'COMMESSA' THEN
			UPDATE commessa 
			SET inv_com = 1
			 WHERE id_commessa = DocumentId AND anno = DocumentYear;
		END IF;
		
		
		IF DocumentType = 'reso' THEN
			UPDATE resoconto 
			SET inviato=1 
			WHERE id_resoconto = DocumentId
				AND anno = DocumentYear;
		END IF;
		
		IF DocumentType = 'ordine' THEN
			UPDATE ordine_fornitore 
			SET inviato = 1 
			WHERE id_Ordine = DocumentId
				AND anno = DocumentYear;
		END IF;
		
		if DocumentType = 'fatt1' THEN

			 UPDATE fattura 
			 SET inviato = 1 
			 WHERE id_fattura = DocumentId
			    AND anno = DocumentYear; 
			    
			 UPDATE clienti 
			 SET rc = 1 
			 WHERE id_cliente = 
			 	(	
				 	SELECT id_cliente 
				 	FROM fattura  
				 	WHERE id_fattura = DocumentId
			    	AND anno = DocumentYear
			    ); 
			   
		
		END IF;
		
		
		IF DocumentType = 'rapporto_mobile_intervento' THEN

			 UPDATE rapporto_mobile 
			 SET inviato = 1 
			 WHERE Id_rapporto = DocumentId AND anno = DocumentYear; 

		
		END IF;
		
		
		IF DocumentType = 'rapporto_mobile_collaudo' THEN

			 UPDATE rapporto_mobile_collaudo 
			 SET inviato = 1 
			 WHERE Id_rapporto = DocumentId AND anno = DocumentYear; 

		
		END IF;

		
		
		if DocumentType = 'cliente_estratto_conto' AND (DocumentId IS NOT NULL) THEN
		
			CALL sp_ariesCustomerInvoicesStatementInsert (email_id, DocumentId);

		END IF;
		
		
	
	END IF; 		

		

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailSetStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailSetStatus`(
	IN `email_id` INT(11),
	IN `send_date` DATETIME,
	IN `status_id` INT(11),
	IN `attempts` TINYINT(4),
	IN `error_status_id` MEDIUMINT(9),
	IN `error_message` VARCHAR(500),
	OUT result SMALLINT
)
BEGIN
	
	SELECT COUNT(mail_stato.id_Stato)
		INTO Result
	FROM mail_stato
	WHERE 
		mail_stato.id_Stato = status_id;
		

	IF Result > 0 THEN
	
		SELECT COUNT(mail.Id)
			INTO Result
		FROM mail
		WHERE 
			mail.id = email_id;
			
		IF Result <= 0 THEN
			SET Result = -3; -- email not found	
		END IF;

		
	ELSE 
		SET Result = -1; -- email status found	
	END IF;  
	
	

	
	IF Result >= 0 THEN
	
		UPDATE mail
		SET Id_stato = status_id, 
			Data_invio = send_date, 
			Tentativo = attempts,
			Id_stato_errore = error_status_id,
			Messaggio_errore = error_message
		WHERE mail.Id = email_id;  
		
		CALL sp_ariesEmailSetDocumentStatus(email_id); 
		CALL sp_ariesEmailWriteSideEffects(email_id);

		SET Result = 1;
	END IF; 
		

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailUpdate`(
	IN `email_id` INT(11),
	IN `sender_id` INT(11),
	IN `recipients_cc` VARCHAR(500),
	IN `recipients_ccn` VARCHAR(500),
	IN `subject` VARCHAR(100),
	IN `body` TEXT,
	IN `is_pec` BIT,
	IN `status_id` INT(11),
	IN `response_id` INT(11),
	IN `group_id` INT(11),
	IN `mail_type` VARCHAR(15),
	IN `document_id` VARCHAR(10),
	IN `document_year` VARCHAR(10),
	IN `document_review` VARCHAR(10),
	IN `document_type` VARCHAR(30),
	IN `attempts` TINYINT(4),
	IN `send_date` DATETIME,
	IN `is_read` BIT(1),
	IN `error_status_id` MEDIUMINT(9),
	IN `error_message` VARCHAR(500),
	OUT result SMALLINT
)
BEGIN
	
	SELECT COUNT(mail_stato.id_Stato)
		INTO Result
	FROM mail_stato
	WHERE 
		mail_stato.id_Stato = status_id;
		
	IF Result > 0 THEN
		SELECT COUNT(utente.Id_utente)
			INTO Result
		FROM utente
		WHERE 
			utente.id_utente = sender_id;
			
		IF Result > 0 THEN
			SELECT COUNT(mail.Id)
				INTO Result
			FROM mail
			WHERE 
				mail.id = email_id;
				
			IF Result <= 0 THEN
				SET Result = -3; -- email not found	
			END IF;
		ELSE 
			SET Result = -2; -- user not found	
		END IF;
		
	ELSE 
		SET Result = -1; -- email status found	
	END IF;  
	

	
	IF Result >= 0 THEN
		UPDATE mail
		SET 		
			Id_mittente = sender_id,
			Destinatari_cc = recipients_cc,
			Destinatari_ccn = recipients_ccn,
			Oggetto = subject,
			Corpo = body,
			Pec = is_pec,
			Id_stato = status_id,
			Id_risposta = response_id,
			Id_gruppo = group_id,
			Tipo = mail_type,
			Id_documento = document_id,
			Anno_documento = document_year,
			Revisione_documento = document_review,
			Tipo_documento = document_type,
			Tentativo = attempts,
			Data_invio = send_date,
			Letto = is_read,
			Id_stato_errore = error_status_id,
			Messaggio_errore = error_message,
			Data_mod = NOW(),
			Utente_mod = @USER_ID
		WHERE mail.Id = email_id; 
		
		CALL sp_ariesEmailSetDocumentStatus(email_id); 
		CALL sp_ariesEmailWriteSideEffects(email_id); 
		
		SET Result = 1;
	END IF; 
		

			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmailWriteSideEffects
DELIMITER //
CREATE PROCEDURE `sp_ariesEmailWriteSideEffects`(
	IN `email_id` INT(11)
)
BEGIN
	
	DECLARE DocumentType VARCHAR(30); 
	DECLARE DocumentId VARCHAR(10);
	DECLARE DocumentYear VARCHAR(10);
	DECLARE StatusId INT(11);
	
	SELECT mail.Tipo_documento,
		mail.Id_documento,
		mail.anno_documento, 
		mail.Id_stato 
	INTO 
		DocumentType, 
		DocumentId, 
		DocumentYear, 
		StatusId 
	FROM mail
	WHERE Id = email_id; 
	
	IF StatusId = 0 AND (DocumentType = 'rapporto_mobile_intervento' OR DocumentType = 'rapporto_mobile_collaudo')  THEN
		UPDATE rapporto_mobile_destinatario 
		SET rapporto_mobile_destinatario.id_mail = email_id
		WHERE Id_rapporto = DocumentId AND anno = DocumentYear; 
	END IF; 		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmployeeDpiDeleteExpirationEvent
DELIMITER //
CREATE PROCEDURE `sp_ariesEmployeeDpiDeleteExpirationEvent`(
	IN employee_dpi_id INT
)
BEGIN
	DECLARE reminder_event_id INT(11);
	DECLARE expiration_event_id INT(11);
	DECLARE event_group_id INT(11);

	SELECT id_evento_promemoria, id_evento_scadenza
		INTO reminder_event_id, expiration_event_id
	FROM operaio_dpi
	WHERE id_dpi = employee_dpi_id;
	

	IF expiration_event_id IS NOT NULL THEN
		SELECT id_gruppo_evento
			INTO event_group_id
		FROM evento_gruppo_evento 
		WHERE id_evento = expiration_event_id;

		UPDATE evento
		SET Eliminato = 1,
			Utente_mod = @USER_ID
		WHERE id = expiration_event_id;

		IF reminder_event_id IS NULL THEN
			
			UPDATE evento_gruppo
			SET Eliminato = 1,
				Utente_mod = @USER_ID
			WHERE id = event_group_id;

		END IF;
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmployeeDpiDeleteReminderEvent
DELIMITER //
CREATE PROCEDURE `sp_ariesEmployeeDpiDeleteReminderEvent`(
	IN employee_dpi_id INT
)
BEGIN
	DECLARE reminder_event_id INT(11);
	DECLARE expiration_event_id INT(11);
	DECLARE event_group_id INT(11);

	SELECT id_evento_promemoria, id_evento_scadenza
		INTO reminder_event_id, expiration_event_id
	FROM operaio_dpi
	WHERE id_dpi = employee_dpi_id;


	IF reminder_event_id IS NOT NULL THEN
		SELECT id_gruppo_evento
			INTO event_group_id
		FROM evento_gruppo_evento 
		WHERE id_evento = reminder_event_id;

		UPDATE evento
		SET Eliminato = 1,
			Utente_mod = @USER_ID
		WHERE id = reminder_event_id;

		IF expiration_event_id IS NULL THEN
			UPDATE evento_gruppo
			SET Eliminato = 1,
				Utente_mod = @USER_ID
			WHERE id = event_group_id;
		END IF;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmployeeDpiEnsureExpirationEvent
DELIMITER //
CREATE PROCEDURE `sp_ariesEmployeeDpiEnsureExpirationEvent`(
	IN employee_dpi_id INT,
	IN employee_id INT,
	IN product_id VARCHAR(11),
	IN reminder_date DATE,
	IN reminder_event_id INT,
	IN expiration_date DATE,
	IN expiration_event_id INT,
	OUT event_id INT(11)
)
BEGIN
	DECLARE event_group_id INT(11);
	DECLARE employee_name TEXT;
	DECLARE product_name TEXT;
	DECLARE event_description TEXT;
	DECLARE event_subject TEXT;

	SET event_id = expiration_event_id;

	SELECT
		ragione_sociale
	INTO
		employee_name
	FROM operaio
	WHERE id_operaio = employee_id;

	SELECT
		desc_brev
	INTO
		product_name
	FROM articolo
	WHERE codice_articolo = product_id;

	SELECT 
		evento_gruppo.id
	INTO
		event_group_id
	FROM evento_gruppo
		LEFT JOIN evento_gruppo_evento as evento_gruppo_evento_promemoria ON evento_gruppo_evento_promemoria.id_evento = reminder_event_id
		LEFT JOIN evento_gruppo_evento as evento_gruppo_evento_scadenza ON evento_gruppo_evento_scadenza.id_evento = expiration_event_id
	WHERE evento_gruppo.id IN (evento_gruppo_evento_promemoria.id_gruppo_evento, evento_gruppo_evento_scadenza.id_gruppo_evento);


	IF event_group_id IS NULL THEN
		INSERT INTO evento_gruppo
		SET
			oggetto = CONCAT('PROMEMORIA/SCADENZA DPI ', employee_name),
			descrizione = CONCAT(
				'OPERAIO: ', employee_name, '\n',
				'DPI: ', IFNULL(product_name, ''), '\n'
			),
			data_ora_inizio = CONCAT(LEAST(reminder_date, expiration_date), ' ', '08:00:00'),
			data_ora_fine = CONCAT(GREATEST(reminder_date, expiration_date), ' ', '20:00:00'),
			Data_ins = NOW(),
			Data_mod = NOW(),
			Utente_ins = @USER_ID,
			Utente_mod = @USER_ID;
		
 		SELECT LAST_INSERT_ID() INTO event_group_id;

	ELSE
		UPDATE evento_gruppo
		SET
			oggetto = CONCAT('PROMEMORIA/SCADENZA DPI ', employee_name),
			descrizione = CONCAT(
				'OPERAIO: ', employee_name, '\n',
				'DPI: ', IFNULL(product_name, ''), '\n'
			),
			data_ora_inizio = CONCAT(LEAST(reminder_date, expiration_date), ' ', '08:00:00'),
			data_ora_fine = CONCAT(GREATEST(reminder_date, expiration_date), ' ', '20:00:00'),
			Data_mod = NOW(),
			Utente_mod = @USER_ID
		WHERE id = event_group_id;

	END IF;
	
	SET event_subject = CONCAT('SCADENZA DPI ', employee_name);
	SET event_description = CONCAT(
		'OPERAIO: ', employee_name, '\n',
		'DPI: ', IFNULL(product_name, ''), '\n'
	);


	IF event_id IS NULL THEN
		INSERT INTO Evento
		SET 
			Oggetto = event_subject, 
			Descrizione = event_description, 
			Id_riferimento = NULL, 
			id_tipo_evento = 70, 
			Eseguito = 0, 
			Ricorrente = 0,
			giorni_ricorrenza = 0,
			Data_esecuzione = expiration_date, 
			Sveglia = 0, 
			Data_sveglia = '1970-01-01 00:00:00',
			Ora_inizio_esecuzione = '09:00:00',
			ora_fine_esecuzione = '10:00:00',
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_ins = @USER_ID;
			
 		SELECT LAST_INSERT_ID() INTO event_id;
		
		INSERT INTO Evento_gruppo_evento (Id_evento, Id_gruppo_evento, Tipo_associazione, Timestamp)
			VALUES (event_id, event_group_id, 1, CURRENT_TIMESTAMP);
	ELSE
		UPDATE Evento
		SET 
			Oggetto = event_subject, 
			Descrizione = event_description, 
			Data_esecuzione = expiration_date, 
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_mod = @USER_ID
		WHERE Id = event_id; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmployeeDpiEnsureReminderEvent
DELIMITER //
CREATE PROCEDURE `sp_ariesEmployeeDpiEnsureReminderEvent`(
	IN employee_dpi_id INT,
	IN employee_id INT,
	IN product_id VARCHAR(11),
	IN reminder_date DATE,
	IN reminder_event_id INT,
	IN expiration_date DATE,
	IN expiration_event_id INT,
	OUT event_id INT(11)
)
BEGIN
	DECLARE event_group_id INT(11);
	DECLARE employee_name TEXT;
	DECLARE product_name TEXT;
	DECLARE event_description TEXT;
	DECLARE event_subject TEXT;

	SET event_id = reminder_event_id;

	SELECT
		ragione_sociale
	INTO
		employee_name
	FROM operaio
	WHERE id_operaio = employee_id;

	SELECT
		desc_brev
	INTO
		product_name
	FROM articolo
	WHERE codice_articolo = product_id;

	SELECT 
		evento_gruppo.id
	INTO
		event_group_id
	FROM evento_gruppo
		LEFT JOIN evento_gruppo_evento as evento_gruppo_evento_promemoria ON evento_gruppo_evento_promemoria.id_evento = reminder_event_id
		LEFT JOIN evento_gruppo_evento as evento_gruppo_evento_scadenza ON evento_gruppo_evento_scadenza.id_evento = expiration_event_id
	WHERE evento_gruppo.id IN (evento_gruppo_evento_promemoria.id_gruppo_evento, evento_gruppo_evento_scadenza.id_gruppo_evento);


	IF event_group_id IS NULL THEN
		INSERT INTO evento_gruppo
		SET
			oggetto = CONCAT('PROMEMORIA/SCADENZA DPI ', employee_name),
			descrizione = CONCAT(
				'OPERAIO: ', employee_name, '\n',
				'DPI: ', IFNULL(product_name, ''), '\n'
			),
			data_ora_inizio = CONCAT(LEAST(reminder_date, expiration_date), ' ', '08:00:00'),
			data_ora_fine = CONCAT(GREATEST(reminder_date, expiration_date), ' ', '20:00:00'),
			Data_ins = NOW(),
			Data_mod = NOW(),
			Utente_ins = @USER_ID,
			Utente_mod = @USER_ID;
		
 		SELECT LAST_INSERT_ID() INTO event_group_id;

	ELSE
		UPDATE evento_gruppo
		SET
			oggetto = CONCAT('PROMEMORIA/SCADENZA DPI ', employee_name),
			descrizione = CONCAT(
				'OPERAIO: ', employee_name, '\n',
				'DPI: ', IFNULL(product_name, ''), '\n'
			),
			data_ora_inizio = CONCAT(LEAST(reminder_date, expiration_date), ' ', '08:00:00'),
			Data_mod = NOW(),
			Utente_mod = @USER_ID
		WHERE id = event_group_id;

	END IF;

	
	SET event_subject = CONCAT('PROMEMORIA DPI ', employee_name);
	SET event_description = CONCAT(
		'OPERAIO: ', employee_name, '\n',
		'DPI: ', IFNULL(product_name, ''), '\n',
		'SCADENZA: ', IFNULL(expiration_date, ''), '\n'
	);

	IF event_id IS NULL THEN
		INSERT INTO Evento
		SET 
			Oggetto = event_subject, 
			Descrizione = event_description, 
			Id_riferimento = NULL, 
			id_tipo_evento = 70, 
			Eseguito = 0, 
			Ricorrente = 0,
			giorni_ricorrenza = 0,
			Data_esecuzione = reminder_date, 
			Sveglia = 0, 
			Data_sveglia = '1970-01-01 00:00:00',
			Ora_inizio_esecuzione = '09:00:00',
			ora_fine_esecuzione = '10:00:00',
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_ins = @USER_ID;
			
 		SELECT LAST_INSERT_ID() INTO event_id;
		
		INSERT INTO Evento_gruppo_evento (Id_evento, Id_gruppo_evento, Tipo_associazione, Timestamp)
			VALUES (event_id, event_group_id, 1, CURRENT_TIMESTAMP);
	ELSE
		UPDATE Evento
		SET 
			Oggetto = event_subject, 
			Descrizione = event_description, 
			Data_esecuzione = reminder_date, 
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_mod = @USER_ID
		WHERE Id = event_id; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmployeeGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEmployeeGet`( )
BEGIN
        
	SELECT Id_operaio,
		 Id_pubblico,
		 IFNULL(Ragione_sociale, "" ) AS Ragione_sociale,
		 IFNULL(Codice_Fiscale, "" ) AS Codice_Fiscale,
		 IFNULL(Provincia, "" ) AS Provincia,
		 IFNULL(Comune, 0) AS Comune,
		 IFNULL(Frazione, 0) AS Frazione ,
		 IFNULL(Codice_Fiscale, "" ) AS Codice_Fiscale,
		 IFNULL(Indirizzo, "" ) AS  Indirizzo,
		 IFNULL(Iban, "" ) AS Iban,
		 IFNULL(livello_associato, 0 ) AS  livello_associato,
		 IFNULL(N_matricola,0 ) AS N_matricola,
		 IFNULL(Scade_contratto, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Scade_contratto,
		 IFNULL(Telefono, "" ) AS Telefono,
		 IFNULL(Telefono_abitazione, "" ) AS Telefono_abitazione,
		 IFNULL(altro_telefono, "" ) AS altro_telefono,
		 IFNULL(E_mail, "" ) AS E_mail,
		 IFNULL(qualifica, 0 ) AS qualifica,
		 IFNULL(Data_assunzione, CAST("1970-01-01" AS DATE) ) AS Data_assunzione,
		 IFNULL(Data_licenziamento, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS   Data_licenziamento,
		 IFNULL(Tariffario, 0 ) AS Tariffario,
		 IFNULL(collaboratore, 0 ) AS collaboratore,
		 IFNULL(id_filiale, 0 ) AS id_filiale,
		 IFNULL(l_nas, 0 ) AS l_nas,
		 IFNULL(d_nas, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS d_nas,
		 IFNULL(tipo_operaio, 0 ) AS tipo_operaio,
		 IFNULL(agente, 0 ) AS agente,
		 IFNULL(id_utente, 0 ) AS id_utente,
		 IFNULL(is_cassa, 0 ) AS is_cassa,
		 IFNULL(is_tecnico, 0 ) AS  is_tecnico,
		 IFNULL(mail_account, "" ) AS mail_account,
		 IFNULL(password, "" ) AS password,
		 IFNULL(username, "" ) AS username,
		 IFNULL(sigla_operaio, "" ) AS sigla_operaio,
		 IFNULL(Data_ins, CAST("1970-01-01 00:00:00" AS DATETIME)) AS Data_ins,
		 IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME)) AS Data_mod,
		 IFNULL(Utente_ins, 0 ) AS Utente_ins,
		 IFNULL(Utente_mod, 0 ) AS Utente_mod
	FROM Operaio;  
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmployeeGetByEventGroupId
DELIMITER //
CREATE PROCEDURE `sp_ariesEmployeeGetByEventGroupId`( 
event_group_id INT
)
BEGIN
        
	SELECT DISTINCT Operaio.Id_operaio,
		 Operaio.Id_pubblico,
		 IFNULL(Operaio.Ragione_sociale, "" ) AS Ragione_sociale,
		 IFNULL(Operaio.Codice_Fiscale, "" ) AS Codice_Fiscale,
		 IFNULL(Operaio.Provincia, "" ) AS Provincia,
		 IFNULL(Operaio.Comune, 0) AS Comune,
		 IFNULL(Operaio.Frazione, 0) AS Frazione ,
		 IFNULL(Operaio.Codice_Fiscale, "" ) AS Codice_Fiscale,
		 IFNULL(Operaio.Indirizzo, "" ) AS  Indirizzo,
		 IFNULL(Operaio.Iban, "" ) AS Iban,
		 IFNULL(Operaio.livello_associato, 0 ) AS  livello_associato,
		 IFNULL(Operaio.N_matricola,0 ) AS N_matricola,
		 IFNULL(Operaio.Scade_contratto, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Scade_contratto,
		 IFNULL(Operaio.Telefono, "" ) AS Telefono,
		 IFNULL(Operaio.Telefono_abitazione, "" ) AS Telefono_abitazione,
		 IFNULL(Operaio.altro_telefono, "" ) AS altro_telefono,
		 IFNULL(Operaio.E_mail, "" ) AS E_mail,
		 IFNULL(Operaio.qualifica, 0 ) AS qualifica,
		 IFNULL(Operaio.Data_assunzione, CAST("1970-01-01" AS DATE) ) AS Data_assunzione,
		 IFNULL(Operaio.Data_licenziamento, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS   Data_licenziamento,
		 IFNULL(Operaio.Tariffario, 0 ) AS Tariffario,
		 IFNULL(Operaio.collaboratore, 0 ) AS collaboratore,
		 IFNULL(Operaio.id_filiale, 0 ) AS id_filiale,
		 IFNULL(Operaio.l_nas, 0 ) AS l_nas,
		 IFNULL(Operaio.d_nas, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS d_nas,
		 IFNULL(Operaio.tipo_operaio, 0 ) AS tipo_operaio,
		 IFNULL(Operaio.agente, 0 ) AS agente,
		 IFNULL(Operaio.id_utente, 0 ) AS id_utente,
		 IFNULL(Operaio.is_cassa, 0 ) AS is_cassa,
		 IFNULL(Operaio.is_tecnico, 0 ) AS  is_tecnico,
		 IFNULL(Operaio.mail_account, "" ) AS mail_account,
		 IFNULL(Operaio.password, "" ) AS password,
		 IFNULL(Operaio.username, "" ) AS username,
		 IFNULL(Operaio.sigla_operaio, "" ) AS sigla_operaio,
		 IFNULL(Operaio.Data_ins, CAST("1970-01-01 00:00:00" AS DATETIME)) AS Data_ins,
		 IFNULL(Operaio.Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME)) AS Data_mod,
		 IFNULL(Operaio.Utente_ins, 0 ) AS Utente_ins,
		 IFNULL(Operaio.Utente_mod, 0 ) AS Utente_mod
	FROM Evento_gruppo
		INNER JOIN evento_gruppo_evento ON Evento_gruppo.Id = evento_gruppo_evento.Id_gruppo_evento
		INNER JOIN evento_operaio ON evento_gruppo_evento.Id_evento = evento_operaio.Id_evento
		INNER JOIN operaio ON operaio.Id_operaio = evento_operaio.Id_operaio
	WHERE Evento_gruppo.Id = event_group_id
	ORDER BY operaio.Ragione_sociale; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmployeeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEmployeeGetById`( 
employee_id INT
)
BEGIN
        
	SELECT Id_operaio,
		 IFNULL(Ragione_sociale, "" ) AS Ragione_sociale,
		 IFNULL(Codice_Fiscale, "" ) AS Codice_Fiscale,
		 IFNULL(Provincia, "" ) AS Provincia,
		 IFNULL(Comune, 0) AS Comune,
		 IFNULL(Frazione, 0) AS Frazione ,
		 IFNULL(Codice_Fiscale, "" ) AS Codice_Fiscale,
		 IFNULL(Indirizzo, "" ) AS  Indirizzo,
		 IFNULL(Iban, "" ) AS Iban,
		 IFNULL(livello_associato, 0 ) AS  livello_associato,
		 IFNULL(N_matricola,0 ) AS N_matricola,
		 IFNULL(Scade_contratto, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Scade_contratto,
		 IFNULL(Telefono, "" ) AS Telefono,
		 IFNULL(Telefono_abitazione, "" ) AS Telefono_abitazione,
		 IFNULL(altro_telefono, "" ) AS altro_telefono,
		 IFNULL(E_mail, "" ) AS E_mail,
		 IFNULL(qualifica, 0 ) AS qualifica,
		 IFNULL(Data_assunzione, CAST("1970-01-01" AS DATE) ) AS Data_assunzione,
		 IFNULL(Data_licenziamento, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS   Data_licenziamento,
		 IFNULL(Tariffario, 0 ) AS Tariffario,
		 IFNULL(collaboratore, 0 ) AS collaboratore,
		 IFNULL(id_filiale, 0 ) AS id_filiale,
		 IFNULL(l_nas, 0 ) AS l_nas,
		 IFNULL(d_nas, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS d_nas,
		 IFNULL(tipo_operaio, 0 ) AS tipo_operaio,
		 IFNULL(agente, 0 ) AS agente,
		 IFNULL(id_utente, 0 ) AS id_utente,
		 IFNULL(is_cassa, 0 ) AS is_cassa,
		 IFNULL(is_tecnico, 0 ) AS  is_tecnico,
		 IFNULL(mail_account, "" ) AS mail_account,
		 IFNULL(password, "" ) AS password,
		 IFNULL(username, "" ) AS username,
		 IFNULL(sigla_operaio, "" ) AS sigla_operaio,
		 IFNULL(Data_ins, CAST("1970-01-01 00:00:00" AS DATETIME)) AS Data_ins,
		 IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME)) AS Data_mod,
		 IFNULL(Utente_ins, 0 ) AS Utente_ins,
		 IFNULL(Utente_mod, 0 ) AS Utente_mod
	FROM Operaio
	WHERE Id_operaio = employee_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEmployeeShiftLastForEachEmployee
DELIMITER //
CREATE PROCEDURE `sp_ariesEmployeeShiftLastForEachEmployee`()
BEGIN
	SELECT 
		Id,
		Id_operaio, 
		Id_utente, 
		Latitudine, 
		Longitudine, 
		Data_rilevazione, 
		Sorgente_rilevazione, 
		Data_ins		
	FROM 
		(SELECT 
			operaio_spostamenti.Id,
			operaio_spostamenti.Id_operaio, 
			operaio_spostamenti.Id_utente, 
			operaio_spostamenti.Latitudine, 
			operaio_spostamenti.Longitudine, 
			operaio_spostamenti.Data_rilevazione, 
			operaio_spostamenti.Sorgente_rilevazione, 
			operaio_spostamenti.Data_ins		
		FROM operaio_spostamenti
			INNER JOIN operaio ON operaio.Id_operaio = operaio_spostamenti.id_operaio
				AND operaio.Data_licenziamento IS NULL
		WHERE Latitudine > 0 and Longitudine > 0
		ORDER BY Data_rilevazione DESC) AS employee_shift
	GROUP BY Id_operaio; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEnvVariablesGetByKey
DELIMITER //
CREATE PROCEDURE `sp_ariesEnvVariablesGetByKey`(
 IN in_key VARCHAR(100)
)
BEGIN
	SELECT var_key,
		var_value
	FROM environment_variables
	WHERE var_key = in_key;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEnvVariablesUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesEnvVariablesUpdate`(
 IN in_key VARCHAR(100),
 IN in_value VARCHAR(100)
)
BEGIN
	UPDATE environment_variables
	SET var_value = in_value
	WHERE var_key = in_key;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesEventDelete`(
enter_id INT,
OUT result BIT
)
BEGIN
	DECLARE event_type INT;
	DECLARE refer_id INT;

	SET Result = 1; 

	If enter_id <= 0 OR enter_id IS NULL
	THEN
		SET Result = 0;  
	END IF; 	
	
	IF Result 
	THEN		 
	
		-- Retrive event informations 
		SELECT id_tipo_evento, 
			id_riferimento 
		INTO
			event_type, 
			refer_id 
		FROM Evento
		WHERE Id = enter_id; 
		
		IF event_type = 1 
		THEN
			DELETE FROM Impianto_abbonamenti_mesi 
			WHERE Id = refer_id; 
		END IF; 
	
		
		UPDATE evento 
		SET Eliminato = 1,
			stato_notifica = 1, 
			data_notifica = NULL,
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_mod = @USER_ID
		WHERE Id = enter_id; 

		DELETE FROM evento_gruppo_evento
		WHERE id_evento = enter_id;

	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventEmployeeDeleteByEventId
DELIMITER //
CREATE PROCEDURE `sp_ariesEventEmployeeDeleteByEventId`( 
event_Id INT,
OUT result BIT
)
BEGIN
        
	SET Result = 1; 

	If event_Id <= 0 OR event_Id IS NULL
	THEN
		SET Result = 0;  
	END IF; 	
	
	IF Result 
	THEN
		 	DELETE
			FROM Evento_Operaio
			WHERE id_evento = event_id;
	END IF; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventEmployeeGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEventEmployeeGet`( )
BEGIN
        
	SELECT Evento_Operaio.Id, 
		Id_evento, 
		id_operaio,
		Evento_Operaio.Data_ins, 
		Evento_Operaio.Data_mod, 
		Evento_Operaio.Utente_ins, 
		Evento_Operaio.Utente_mod
	FROM Evento_Operaio
		INNER JOIN Evento ON Id_evento = Evento.id
	ORDER BY Evento.Data_esecuzione ASC, Evento.Ora_inizio_esecuzione ASC; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventEmployeeGetByEmployeeId
DELIMITER //
CREATE PROCEDURE `sp_ariesEventEmployeeGetByEmployeeId`( 
employee_Id INT
)
BEGIN
        
	SELECT Evento_Operaio.Id, 
		Id_evento, 
		id_operaio,
		Evento_Operaio.Data_ins, 
		Evento_Operaio.Data_mod, 
		Evento_Operaio.Utente_ins, 
		Evento_Operaio.Utente_mod
	FROM Evento_Operaio
		INNER JOIN Evento ON Id_evento = Evento.id
	WHERE id_operaio = employee_id
	ORDER BY Evento.Data_esecuzione ASC, Evento.Ora_inizio_esecuzione ASC; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventEmployeeGetByEventId
DELIMITER //
CREATE PROCEDURE `sp_ariesEventEmployeeGetByEventId`( 
event_Id INT
)
BEGIN
        
	SELECT Id, 
		id_evento, 
		id_operaio,
		Data_ins, 
		Data_mod, 
		Utente_ins, 
		Utente_mod
	FROM Evento_Operaio
	WHERE id_evento = event_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventFileAssociatedCaldavDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesEventFileAssociatedCaldavDelete`( 
	enter_id INT
)
BEGIN
	DELETE FROM evento_file_associati_caldav WHERE id = enter_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventFileAssociatedCaldavGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEventFileAssociatedCaldavGet`( 
)
BEGIN

	SELECT Id, 
		File_name, 
		id_evento, 
		id_operaio, 
		data_ins, 
		data_mod, 
		utente_ins, 
		utente_mod	
	FROM evento_file_associati_caldav;   

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventFileAssociatedCaldavGetByEventId
DELIMITER //
CREATE PROCEDURE `sp_ariesEventFileAssociatedCaldavGetByEventId`( 
	event_id Integer
)
BEGIN

		SELECT Id, 
		File_name, 
		id_evento, 
		id_operaio, 
		data_ins, 
		data_mod, 
		utente_ins, 
		utente_mod	
	FROM evento_file_associati_caldav  
	WHERE id_evento = event_id; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventFileAssociatedCaldavGetByEventIdAndEmployeeId
DELIMITER //
CREATE PROCEDURE `sp_ariesEventFileAssociatedCaldavGetByEventIdAndEmployeeId`( 
	event_id Integer,
	employee_id integer
)
BEGIN

		SELECT Id, 
		File_name, 
		id_evento, 
		id_operaio, 
		data_ins, 
		data_mod, 
		utente_ins, 
		utente_mod	
	FROM evento_file_associati_caldav  
	WHERE id_evento = event_id AND id_operaio = employee_id; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventFileAssociatedCaldavGetByFileName
DELIMITER //
CREATE PROCEDURE `sp_ariesEventFileAssociatedCaldavGetByFileName`( 
	enter_file_name VARCHAR(150)
)
BEGIN

		SELECT Id, 
		File_name, 
		id_evento, 
		id_operaio, 
		data_ins, 
		data_mod, 
		utente_ins, 
		utente_mod	
	FROM evento_file_associati_caldav  
	WHERE file_name = enter_file_name; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventFileAssociatedCaldavGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEventFileAssociatedCaldavGetById`( 
	enter_id INT
)
BEGIN

		SELECT Id, 
		File_name, 
		id_evento, 
		id_operaio, 
		data_ins, 
		data_mod, 
		utente_ins, 
		utente_mod	
	FROM evento_file_associati_caldav  
	WHERE id = enter_id; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventFileAssociatedCaldavInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesEventFileAssociatedCaldavInsert`( 
	event_id INT, 
	input_file_name VARCHAR(150), 
	employee_id INT
)
BEGIN


	IF event_id IS NULL 
	THEN
		SET event_id = 1; 
	END IF; 

	 INSERT INTO evento_file_associati_caldav 
	 SET 
		File_name = input_file_name, 
		id_evento = event_id, 
		id_operaio = employee_id, 
		data_ins = NOW(), 
		utente_ins = @USER_ID, 
		utente_mod = @USER_ID;   

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGet`( )
BEGIN
        
	SELECT 
		Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		Evento.Id_riferimento, 
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Ricorrente, 
		Evento.Giorni_ricorrenza,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione,
		Evento.Stato_notifica, 
		Evento.Data_notifica,  
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Data_ins, 
		Evento.Data_mod, 
		Evento.Utente_ins, 
		Evento.Utente_mod, 
		Evento_gruppo_evento.Id_gruppo_evento
	FROM Evento
		INNER JOIN Evento_gruppo_evento 
		ON Evento.Id = Evento_gruppo_evento.Id_evento AND Tipo_associazione = 1
	WHERE Eliminato = 0
	ORDER BY Evento.Data_esecuzione ASC, Evento.Ora_inizio_esecuzione ASC; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGetBetweenDate
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGetBetweenDate`( 
	IN start_date DATETIME, 
	IN end_date DATETIME
)
BEGIN
        
	SELECT 
		Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		Evento.Id_riferimento, 
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Ricorrente, 
		Evento.Giorni_ricorrenza,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione,
		Evento.Stato_notifica, 
		Evento.Data_notifica,  
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Data_ins, 
		Evento.Data_mod, 
		Evento.Utente_ins, 
		Evento.Utente_mod, 
		Evento_gruppo_evento.Id_gruppo_evento
	FROM Evento
		INNER JOIN Evento_gruppo_evento 
		ON Evento.Id = Evento_gruppo_evento.Id_evento AND Tipo_associazione = 1
	WHERE Eliminato = 0 AND (Data_esecuzione BETWEEN start_date AND end_date)
	ORDER BY Evento.Data_esecuzione ASC, Evento.Ora_inizio_esecuzione ASC; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGetByGroupId
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGetByGroupId`( 
	event_group_id INT
)
BEGIN
        
	SELECT Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		Evento.Id_riferimento, 
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Ricorrente, 
		Evento.Giorni_ricorrenza,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione,
		Evento.Sveglia,  
		Evento.Stato_notifica, 
		Evento.Data_notifica,  
		Evento.Data_sveglia,
		Evento.Data_ins, 
		Evento.Data_mod, 
		Evento.Utente_ins, 
		Evento.Utente_mod,
		evento_gruppo_evento.Id_gruppo_evento AS Id_gruppo_evento
	FROM Evento
		INNER JOIN Evento_gruppo_evento
			ON Evento_gruppo_evento.Id_evento = Evento.Id AND evento_gruppo_evento.Id_gruppo_evento=event_group_id
	WHERE Eliminato = 0
	ORDER BY Evento.Data_esecuzione ASC, Evento.Ora_inizio_esecuzione ASC; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGetById`( 
enter_id INT
)
BEGIN
        
	SELECT 
		Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		Evento.Id_riferimento, 
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Ricorrente, 
		Evento.Giorni_ricorrenza,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione,
		Evento.Stato_notifica, 
		Evento.Data_notifica,  
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Data_ins, 
		Evento.Data_mod, 
		Evento.Utente_ins, 
		Evento.Utente_mod, 
		Evento_gruppo_evento.Id_gruppo_evento
	FROM Evento
		INNER JOIN Evento_gruppo_evento 
		ON Evento.Id = Evento_gruppo_evento.Id_evento AND Tipo_associazione = 1
	WHERE Evento.Id = enter_id AND Eliminato = 0; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGetByNotifStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGetByNotifStatus`( 
	IN notification_status TINYINT(4)
)
BEGIN
        
	SELECT 
		Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		Evento.Id_riferimento, 
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Ricorrente, 
		Evento.Giorni_ricorrenza,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione,
		Evento.Stato_notifica, 
		Evento.Data_notifica,  
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Data_ins, 
		Evento.Data_mod, 
		Evento.Utente_ins, 
		Evento.Utente_mod, 
		Evento_gruppo_evento.Id_gruppo_evento
	FROM Evento
		INNER JOIN Evento_gruppo_evento 
		ON Evento.Id = Evento_gruppo_evento.Id_evento AND Tipo_associazione = 1
	WHERE Eliminato = 0 AND Stato_notifica = notification_status
	ORDER BY Id; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGetByTypeAndReferId
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGetByTypeAndReferId`( 
refer_id INT,
event_type TINYINT
)
BEGIN
        
	SELECT 
		Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		Evento.Id_riferimento, 
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Ricorrente, 
		Evento.Giorni_ricorrenza,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione,
		Evento.Stato_notifica, 
		Evento.Data_notifica,  
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Data_ins, 
		Evento.Data_mod, 
		Evento.Utente_ins, 
		Evento.Utente_mod, 
		Evento_gruppo_evento.Id_gruppo_evento
	FROM Evento
		INNER JOIN Evento_gruppo_evento 
		ON Evento.Id = Evento_gruppo_evento.Id_evento AND Tipo_associazione = 1
	WHERE Evento.id_riferimento = refer_id
		AND id_tipo_evento = event_type 
		AND Eliminato = 0; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGetByTypes
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGetByTypes`( 
	IN event_types MEDIUMTEXT
)
BEGIN
        
	SELECT 
		Evento.Id,
		Evento.Oggetto, 
		Evento.Descrizione, 
		Evento.Id_riferimento, 
		Evento.id_tipo_evento, 
		Evento.Eseguito, 
		Evento.Ricorrente, 
		Evento.Giorni_ricorrenza,
		Evento.Data_esecuzione, 
		Evento.Ora_inizio_esecuzione, 
		Evento.Ora_fine_esecuzione,
		Evento.Stato_notifica, 
		Evento.Data_notifica,  
		Evento.Sveglia, 
		Evento.Data_sveglia,
		Evento.Data_ins, 
		Evento.Data_mod, 
		Evento.Utente_ins, 
		Evento.Utente_mod, 
		Evento_gruppo_evento.Id_gruppo_evento
	FROM Evento
		INNER JOIN Evento_gruppo_evento 
		ON Evento.Id = Evento_gruppo_evento.Id_evento AND Tipo_associazione = 1
	WHERE Eliminato = 0 AND FIND_IN_SET(Evento.id_tipo_evento ,event_types) > 0
	ORDER BY Id; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupDelete`( 
	event_group_id INT,
	OUT result INT
)
BEGIN
	SET result = 1; 
	DELETE FROM Evento_gruppo
	WHERE evento_gruppo.Id = event_group_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupEvaluateStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupEvaluateStatus`( 
enter_id INT,
OUT status_id TINYINT
)
BEGIN

	DECLARE STATUS_OPEN TINYINT DEFAULT 1; 
	DECLARE STATUS_PARTIAL TINYINT DEFAULT 2; 
	DECLARE STATUS_CLOSE TINYINT DEFAULT 3; 
	DECLARE open_events INT;
	DECLARE close_events INT; 
	DECLARE current_status TINYINT;
	
	SET open_events = 0;
	SET close_events = 0; 
	
	
	SELECT COUNT(*)
		INTO open_events
	FROM evento_gruppo_evento
		INNER JOIN evento 
		ON evento.id = evento_gruppo_evento.id_evento
			AND evento.eseguito = 0
	WHERE id_gruppo_evento = enter_id;
	
	SELECT COUNT(*)
		INTO close_events
	FROM evento_gruppo_evento
		INNER JOIN evento 
		ON evento.id = evento_gruppo_evento.id_evento
			AND evento.eseguito = 1
	WHERE id_gruppo_evento = enter_id;
	
	IF open_events = 0 THEN
		SET current_status = STATUS_CLOSE; 
	ELSE
		IF open_events = 0 THEN
			SET current_status = STATUS_OPEN;
		ELSE
			SET current_status = STATUS_PARTIAL;
		END IF;
	END IF;
	
	UPDATE evento_gruppo 
	SET Id_stato = current_status
	WHERE id = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupGet`( )
BEGIN
        
	SELECT 	
		Evento_gruppo.Id,
		Evento_gruppo.Oggetto,
		Evento_gruppo.Descrizione,
		Evento_gruppo.Id_cliente,
		Evento_gruppo.Id_impianto,
		Evento_gruppo.Id_stato,
		Evento_gruppo.Stato_notifica,
		Evento_gruppo.Data_notifica,
		Evento_gruppo.Data_ora_inizio,
		Evento_gruppo.Data_ora_fine,
		Evento_gruppo.Data_ins,
		Evento_gruppo.Data_mod,
		Evento_gruppo.Utente_ins,
		Evento_gruppo.Utente_mod
	FROM Evento_gruppo
	WHERE Eliminato = 0
	ORDER BY Data_ora_inizio; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupGetBetweenDate
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupGetBetweenDate`( 
	IN start_date DATETIME, 
	IN end_date DATETIME
)
BEGIN
        
	SELECT 
		Evento_gruppo.Id,
		Evento_gruppo.Oggetto,
		Evento_gruppo.Descrizione,
		Evento_gruppo.Id_cliente,
		Evento_gruppo.Id_impianto,
		Evento_gruppo.Id_stato,
		Evento_gruppo.Stato_notifica,
		Evento_gruppo.Data_notifica,
		Evento_gruppo.Data_ora_inizio,
		Evento_gruppo.Data_ora_fine,
		Evento_gruppo.Data_ins,
		Evento_gruppo.Data_mod,
		Evento_gruppo.Utente_ins,
		Evento_gruppo.Utente_mod
	FROM Evento_gruppo
	WHERE Eliminato = 0 AND 
			((Data_ora_inizio BETWEEN start_date AND end_date) OR (Data_ora_fine BETWEEN start_date AND end_date))
	ORDER BY Data_ora_inizio; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupGetById`( 
enter_id INT
)
BEGIN
        
	SELECT 
		Evento_gruppo.Id,
		Evento_gruppo.Oggetto,
		Evento_gruppo.Descrizione,
		Evento_gruppo.Id_cliente,
		Evento_gruppo.Id_impianto,
		Evento_gruppo.Id_stato,
		Evento_gruppo.Stato_notifica,
		Evento_gruppo.Data_notifica,
		Evento_gruppo.Data_ora_inizio,
		Evento_gruppo.Data_ora_fine,
		Evento_gruppo.Data_ins,
		Evento_gruppo.Data_mod,
		Evento_gruppo.Utente_ins,
		Evento_gruppo.Utente_mod
	FROM Evento_gruppo
	WHERE Id = enter_id AND Eliminato = 0; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupGetByNotifStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupGetByNotifStatus`( 
	IN notification_status TINYINT(4)
)
BEGIN
        
	SELECT 
		Evento_gruppo.Id,
		Evento_gruppo.Oggetto,
		Evento_gruppo.Descrizione,
		Evento_gruppo.Id_cliente,
		Evento_gruppo.Id_impianto,
		Evento_gruppo.Id_stato,
		Evento_gruppo.Stato_notifica,
		Evento_gruppo.Data_notifica,
		Evento_gruppo.Data_ora_inizio,
		Evento_gruppo.Data_ora_fine,
		Evento_gruppo.Data_ins,
		Evento_gruppo.Data_mod,
		Evento_gruppo.Utente_ins,
		Evento_gruppo.Utente_mod
	FROM Evento_gruppo
	WHERE Eliminato = 0 AND Stato_notifica = notification_status
	ORDER BY Id; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupInsert`(
subject VARCHAR(50),
description TEXT,
event_type TINYINT, 
status_id INTEGER, 
start_date_time DATETIME,
end_date_time DATETIME,
customer_id INTEGER, 
system_id INTEGER,
OUT result INTEGER
)
MainLabel:BEGIN
	SET Result = 1; 
	
	If subject = "" OR subject IS NULL
	THEN
		SET Result = -1; 
		LEAVE MainLabel;
	END IF; 	
	
	If description = "" OR description IS NULL
	THEN
		SET Result = -2;  
		LEAVE MainLabel;
	END IF;
	
	IF Result 
	THEN
		INSERT INTO Evento_gruppo
		SET 
			Oggetto = subject,
			Descrizione = description,
			Id_cliente = customer_id,
			Id_impianto = system_id,
			Data_ora_inizio = start_date_time, 
			Data_ora_fine = end_date_time,
			Id_stato = status_id,
			Data_ins = NOW(),
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID; 
		SET Result = LAST_INSERT_ID(); 
	END IF;  
		
	
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupReplaceEmployee
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupReplaceEmployee`( 
event_group_id INT,
new_employee INT,
old_employee INT,

OUT result TINYINT
)
BEGIN

	SET result = 1; 
	
	SELECT COUNT(Id)
		INTO result
	FROM Evento_gruppo
	WHERE evento_gruppo.Id = event_group_id; 
	
	If result = 0 THEN
		SET result = -10;	 
	END IF; 
	
	IF result = 1 THEN 
		
		UPDATE evento_operaio
			INNER JOIN evento_gruppo_evento ON evento_operaio.Id_evento = evento_gruppo_evento.Id_evento AND evento_gruppo_evento.Id_gruppo_evento = event_group_id
			INNER JOIN evento ON evento_operaio.Id_evento = evento.Id AND evento.Eseguito = 0
		SET evento_operaio.Id_operaio = new_employee
		WHERE evento_operaio.Id_operaio = old_employee; 
	
		SET result = 1; 
	END IF; 
	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupSetNotificationStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupSetNotificationStatus`(
IN ids MEDIUMTEXT,
IN notification_status TINYINT,
OUT result BIT)
BEGIN

	
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	
	START TRANSACTION; 
	
	UPDATE Evento_gruppo
	SET Stato_notifica = notification_status 
	WHERE FIND_IN_SET(Id ,ids) > 0;

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupStatusGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupStatusGetById`( 
enter_id INT
)
BEGIN
        
	SELECT Id,
		Nome, 
		Colore
	FROM Evento
	WHERE Id = enter_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventGroupUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesEventGroupUpdate`(
event_group_id INT,
subject VARCHAR(50),
Description TEXT,
event_type TINYINT, 
status_id INTEGER, 
start_date_time DATETIME,
end_date_time DATETIME,
customer_id INTEGER, 
system_id INTEGER,
OUT result INTEGER
)
MainLabel:BEGIN
	SET Result = 1; 
	
	If subject = "" OR subject IS NULL
	THEN
		SET Result = -1; 
		LEAVE MainLabel;
	END IF; 	
	
	If Description = "" OR Description IS NULL
	THEN
		SET Result = -2;  
		LEAVE MainLabel;
	END IF;
	
	IF Result 
	THEN
		UPDATE Evento_gruppo
		SET 
			Oggetto = subject,
			Descrizione = description,
			Id_cliente = customer_id,
			Id_impianto = system_id,
			Data_ora_inizio = start_date_time, 
			Data_ora_fine = end_date_time,
			Id_stato = status_id,
			stato_notifica = 3, 
			data_notifica = NULL,
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_mod = @USER_ID
		WHERE Id = event_group_id; 
		
		SET Result = 1; 
			
	END IF;  
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesEventInsert`(
subject VARCHAR(50),
Description TEXT,
refer_id INT, 
group_id INT,
event_type TINYINT, 
was_performed BIT,
is_recurs BIT, 
recurrence_days INT,
has_alarm BIT, 
execution_date DATE, 
execution_start_time TIME,
execution_end_time TIME,
alarm DATETIME,
OUT result BIT,
OUT InsertId INTEGER
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	SET InsertId = 0;
	
	START TRANSACTION; 

	If subject = "" OR subject IS NULL
	THEN
		SET Result = 0;  
	END IF; 	
	
	If Description = "" OR Description IS NULL
	THEN
		SET Result = 0;  
	END IF;
	
	If execution_date IS NULL
	THEN 
		SET Result = 0;  
	END IF;
	
	If group_id IS NULL
	THEN 
		SET Result = 0;  
	END IF;
	
	
	If execution_end_time <= execution_start_time
	THEN 
		SET Result = 0;  
	END IF;
	
	IF Result 
	THEN
	
		INSERT INTO Evento
		SET 
			Oggetto = Subject, 
			Descrizione = Description, 
			Id_riferimento = refer_id, 
			id_tipo_evento = event_type, 
			Eseguito = was_performed, 
			Ricorrente = is_recurs,
			giorni_ricorrenza = recurrence_days,
			Data_esecuzione = execution_date, 
			Sveglia = has_alarm, 
			Data_sveglia = IFNULL(alarm, '1970-01-01 00:00:00'), 
			Ora_inizio_esecuzione = execution_start_time, 
			ora_fine_esecuzione = execution_end_time,
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID; 
		SET InsertId = LAST_INSERT_ID();
		
		
		INSERT INTO Evento_gruppo_evento (Id_evento, Id_gruppo_evento, Tipo_associazione, Timestamp)
			VALUES (InsertId, group_id, 1, CURRENT_TIMESTAMP);
		
		
		SET Result = 1; 
	END IF;  
	
	IF `_rollback` THEN
		ROLLBACK;
		SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventSetNotificationStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesEventSetNotificationStatus`(
IN ids MEDIUMTEXT,
IN notification_status TINYINT,
OUT result BIT)
BEGIN

	
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	
	START TRANSACTION; 
	
	UPDATE Evento 
	SET Stato_notifica = notification_status 
	WHERE FIND_IN_SET(Id ,ids) > 0;

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventSetWasPermormed
DELIMITER //
CREATE PROCEDURE `sp_ariesEventSetWasPermormed`(
event_id INT,
was_performed BIT,
is_recurs BIT, 
OUT result INT
)
BEGIN
	DECLARE execution_date DATE; 
	DECLARE event_type TINYINT; 
	DECLARE refer_id INT; 
	
	SET Result = 1; 

	
	IF Result 
	THEN
		UPDATE Evento
		SET 
			Eseguito = was_performed, 
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_mod = @USER_ID
		WHERE Id = event_id; 
		
		-- Retrive event informations 
		SELECT Data_esecuzione,
			id_tipo_evento, 
			id_riferimento 
		INTO
			execution_date, 
			event_type, 
			refer_id 
		FROM Evento
		WHERE Id = event_id; 
		
		IF was_performed AND event_type = 1 
		THEN
			UPDATE Impianto_abbonamenti_mesi 
			SET eseguito_il = execution_date
			WHERE Id = refer_id; 
		ELSE
			IF event_type = 1  THEN	
				UPDATE Impianto_abbonamenti_mesi 
				SET eseguito_il = execution_date
				WHERE Id = refer_id; 
			END IF; 	
		END IF; 
			
		IF is_recurs
		THEN
			INSERT INTO EVENTO 
			(
				oggetto, 
				Descrizione, 
				Id_riferimento, 
				id_tipo_evento, 
				Eseguito, 
				Ricorrente, 
				Giorni_ricorrenza,
				Data_esecuzione, 
				Ora_inizio_esecuzione, 
				Ora_fine_esecuzione,
				Sveglia,  
				Data_sveglia,
				Data_ins, 
				Data_mod, 
				Utente_ins, 
				Utente_mod
			) 
			SELECT oggetto, 
				Descrizione, 
				Id_riferimento, 
				id_tipo_evento, 
				0, 
				Ricorrente, 
				Giorni_ricorrenza,
				DATE_ADD(Data_esecuzione, INTERVAL Giorni_ricorrenza DAY), 
				Ora_inizio_esecuzione, 
				Ora_fine_esecuzione,
				Sveglia,  
				Data_sveglia,
				CURRENT_TIMESTAMP, 
				CURRENT_TIMESTAMP, 
				@USER_ID, 
				@USER_ID
			FROM Evento 
			WHERE Id = event_id;		
			
			
			SET Result = LAST_INSERT_ID();
				
		END IF;	
		
	END IF;  
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventTypeGet
DELIMITER //
CREATE PROCEDURE `sp_ariesEventTypeGet`( 
)
BEGIN
        
	SELECT Id_tipo, 
		Nome, 
		Colore,
		Id_tipologia
	FROM Tipo_evento
	ORDER BY Nome ASC; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesEventTypeGetById`( 
	IN EventTypeId INT(11)
)
BEGIN
        
	SELECT Id_tipo, 
	Nome, 
	Colore,
	Id_tipologia
	FROM Tipo_evento
	WHERE Id_tipo = EventTypeId; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesEventUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesEventUpdate`(
event_id INT,
subject VARCHAR(50),
Description TEXT,
refer_id INT, 
event_type TINYINT, 
was_performed BIT,
is_recurs BIT, 
recurrence_days INT,
has_alarm BIT, 
execution_date DATE, 
execution_start_time TIME,
execution_end_time TIME,
alarm DATETIME,
OUT result BIT
)
BEGIN
	SET Result = 1; 


	If subject = "" OR subject IS NULL
	THEN
		SET Result = 0;  
	END IF; 	
	
	If Description = "" OR Description IS NULL
	THEN
		SET Result = 0;  
	END IF;
	
	If execution_date IS NULL
	THEN 
		SET Result = 0;  
	END IF;
	
		
	If execution_end_time <= execution_start_time
	THEN 
		SET Result = 0;  
	END IF;
	
	IF Result 
	THEN
		UPDATE Evento
		SET 
			Oggetto = Subject, 
			Descrizione = Description, 
			Id_riferimento = refer_id, 
			id_tipo_evento = event_type, 
			Eseguito = was_performed, 
			Ricorrente = is_recurs,
			giorni_ricorrenza = recurrence_days,
			Data_esecuzione = execution_date, 
			Sveglia = has_alarm, 
			Data_sveglia = IFNULL(alarm, '1970-01-01 00:00:00'),
			Ora_inizio_esecuzione = execution_start_time, 
			ora_fine_esecuzione = execution_end_time,
			stato_notifica = 3, 
			data_notifica = NULL,
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_mod = @USER_ID
		WHERE Id = event_id; 
		
		IF was_performed AND event_type = 1 
		THEN
			UPDATE Impianto_abbonamenti_mesi 
			SET eseguito_il = execution_date
			WHERE Id = refer_id; 
		ELSE
			IF event_type = 1  THEN	
				UPDATE Impianto_abbonamenti_mesi 
				SET eseguito_il = NULL
				WHERE Id = refer_id; 
			END IF; 	
		END IF; 
		
			
	END IF;  
		
	
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesExpenseTypeGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesExpenseTypeGetByName`( 
	IN name VARCHAR(45)
)
BEGIN

	SELECT 
		`Id_tipo`,
		`nome`,
		`Operazione`,
		`descrizione`,
		`trasf`,
		`appartenenza`
	FROM tipo_spesa 
	WHERE nome = name;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesExpenseTypeInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesExpenseTypeInsert`( 
	IN `type_id` INT(11),
	IN `name` VARCHAR(45),
	IN `operation_type` CHAR(2),
	IN `description` VARCHAR(100),
	IN `is_transf` INT(10),
	IN `membership` VARCHAR(45),
	OUT result INT(11)
)
BEGIN

	INSERT INTO tipo_spesa
	SET
		`Id_tipo` = type_id,
		`nome` = name,
		`Operazione` = operation_type,
		`descrizione` = description,
		`trasf` = is_transf,
		`appartenenza` = membership; 
		
	SET result = LAST_INSERT_ID();
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteDelete`( 
	IN first_note_id INT(11), 
	IN first_note_year INT(11), 
	OUT result INT(11)
)
BEGIN

	DELETE FROM prima_nota 
	WHERE Id_prima_nota = first_note_id
		AND anno = first_note_year;
	
	SET result = 1;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteDeleteByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteDeleteByInvoice`( 
	IN invoice_id INT(11), 
	IN invoice_year INT(11), 
	IN payment_id INT(11), 
	OUT result INT(11)
)
BEGIN

	DELETE FROM prima_nota 
	WHERE id_fattura = invoice_id
		AND anno_fattura = invoice_year
		AND IF(payment_id <> -1, id_pagamento = payment_id, TRUE);
	
	SET result = 1;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteDeleteBySupplierInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteDeleteBySupplierInvoice`( 
	IN invoice_id INT(11), 
	IN invoice_year INT(11), 
	IN payment_id INT(11), 
	OUT result INT(11)
)
BEGIN

	DELETE FROM prima_nota 
	WHERE id_fornfattura = invoice_id
		AND anno_fornfattura = invoice_year
		AND IF(payment_id <> -1, id_pagamento = payment_id, TRUE);
		
	SET result = 1;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteEvaluateInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteEvaluateInvoice`( 
	IN first_note_id INT(11), 
	IN first_note_year INT(11),
	IN invoice_id INT(11),
	IN invoice_year INT(11),
	IN invoice_payment INT(11),
	IN expense_type INT(11)
)
BEGIN
	DECLARE is_transfer_to BIT(1) DEFAULT false;
	
	SELECT IF(trasf = 1, true, false)
		INTO is_transfer_to
	FROM tipo_spesa
	WHERE Id_tipo = expense_type;

	IF (invoice_id IS NOT NULL 
	AND invoice_year IS NOT NULL
		AND invoice_payment IS NOT NULL) THEN
		
		if is_transfer_to = true THEN

			UPDATE fattura_pagamenti
			SET id_trasferimento_verso = first_note_id,
				anno_trasferimento_verso = first_note_year
			WHERE id_fattura = invoice_id
				AND anno = invoice_year
				AND id_pagamento = invoice_payment;

		ELSE

			UPDATE fattura_pagamenti
			SET Id_prima_nota = first_note_id,
				anno_prima_nota = first_note_year
			WHERE id_fattura = invoice_id
				AND anno = invoice_year
				AND id_pagamento = invoice_payment;

		END IF;
	END IF;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteEvaluateSupplierInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteEvaluateSupplierInvoice`( 
	IN first_note_id INT(11), 
	IN first_note_year INT(11),
	IN invoice_id INT(11),
	IN invoice_year INT(11),
	IN invoice_payment INT(11),
	IN expense_type INT(11)
)
BEGIN
	DECLARE is_transfer_to BIT(1) DEFAULT false;
	
	SELECT IF(trasf = 1, true, false)
		INTO is_transfer_to
	FROM tipo_spesa
	WHERE Id_tipo = expense_type;

	IF (invoice_id IS NOT NULL 
	AND invoice_year IS NOT NULL
		AND invoice_payment IS NOT NULL) THEN
		
		if is_transfer_to = true THEN

			UPDATE fornfattura_pagamenti
			SET id_trasferimento_verso = first_note_id,
				anno_trasferimento_verso = first_note_year
			WHERE id_fattura = invoice_id
				AND anno = invoice_year
				AND id_pagamento = invoice_payment;

		ELSE

			UPDATE fornfattura_pagamenti
			SET Id_prima_nota = first_note_id,
				anno_prima_nota = first_note_year
			WHERE id_fattura = invoice_id
				AND anno = invoice_year
				AND id_pagamento = invoice_payment;

		END IF;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteGet
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteGet`( 
)
BEGIN
	SELECT 
		`Id_prima_nota`,
		`anno`,
		`Data`,
		`Dipendente`,
		`Tipo_spesa`,
		`Spesa`,
		`Note_spesa`,
		`id_utente`,
		`id_fattura`,
		`anno_fattura`,
		`id_fornfattura`,
		`anno_fornfattura`,
		`id_pagamento`,
		`ricevente`
	FROM prima_nota; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteGetById`( 
	IN enter_id INT(11), 
	IN enter_year INT(11)
)
BEGIN
	SELECT 
		`Id_prima_nota`,
		`anno`,
		`Data`,
		`Dipendente`,
		`Tipo_spesa`,
		`Spesa`,
		`Note_spesa`,
		`id_utente`,
		`id_fattura`,
		`anno_fattura`,
		`id_fornfattura`,
		`anno_fornfattura`,
		`id_pagamento`,
		`ricevente`
	FROM prima_nota
	WHERE Id_prima_nota = enter_id
		AND anno = enter_year;
 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteGetByInvoice`( 
	IN invoice_id INT(11), 
	IN invoice_year INT(11), 
	IN payment_id INT(11)
)
BEGIN
	SELECT 
		`Id_prima_nota`,
		`anno`,
		`Data`,
		`Dipendente`,
		`Tipo_spesa`,
		`Spesa`,
		`Note_spesa`,
		`id_utente`,
		`id_fattura`,
		`anno_fattura`,
		`id_fornfattura`,
		`anno_fornfattura`,
		`id_pagamento`,
		`ricevente`
	FROM prima_nota
	WHERE id_fattura = invoice_id
		AND anno_fattura = invoice_year
		AND id_pagamento = payment_id;
 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteGetBySupplierInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteGetBySupplierInvoice`( 
	IN invoice_id INT(11), 
	IN invoice_year INT(11), 
	IN payment_id INT(11)
)
BEGIN
	SELECT 
		`Id_prima_nota`,
		`anno`,
		`Data`,
		`Dipendente`,
		`Tipo_spesa`,
		`Spesa`,
		`Note_spesa`,
		`id_utente`,
		`id_fattura`,
		`anno_fattura`,
		`id_fornfattura`,
		`anno_fornfattura`,
		`id_pagamento`,
		`ricevente`
	FROM prima_nota
	WHERE id_fornfattura = invoice_id
		AND anno_fornfattura = invoice_year
		AND id_pagamento = payment_id;
 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteInsert`( 
	IN exec_date DATE, 
	IN employee_id INT(11), 
	IN expense_type INT(11), 
	IN expense_value DECIMAL(11,2),
	IN expense_notes VARCHAR(100),
	IN invoice_id INT(11),
	IN invoice_year INT(11), 
	IN user_id INT(11), 
	IN recipient_id INT(11), 
	IN supplier_invoice_id INT(11), 
	IN supplier_invoice_year INT(11),
	IN payment_id INT(11), 
	OUT first_note_id INT(11), 
	OUT first_note_year INT(11), 
	OUT result INT(11)
)
BEGIN
	SET first_note_year = YEAR(exec_date);
	SELECT IFNULL(MAX(Id_prima_nota) + 1, 1)
		INTO first_note_id
	FROM prima_nota 
	WHERE anno = first_note_year;

	INSERT INTO prima_nota
	SET 
		Id_prima_nota = first_note_id, 
		anno = first_note_year,
		`Data` = exec_date,
		`Dipendente` = employee_Id,
		`Tipo_spesa` = expense_type,
		`Spesa` = expense_value,
		`Note_spesa` = expense_notes,
		`id_utente` = user_id,
		`id_fattura` = invoice_id,
		`anno_fattura` = invoice_year,
		`id_fornfattura` = supplier_invoice_id,
		`anno_fornfattura` = supplier_invoice_year,
		`id_pagamento` = payment_id,
		`ricevente` = recipient_id;
	
	CALL sp_ariesFirstNoteEvaluateSupplierInvoice(first_note_id,
		first_note_year, supplier_invoice_id, supplier_invoice_year, payment_id,
		expense_type);

	CALL sp_ariesFirstNoteEvaluateInvoice(first_note_id,
		first_note_year, invoice_id, invoice_year, payment_id,
		expense_type);

	SET result = 1;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesFirstNoteUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesFirstNoteUpdate`( 
	IN first_note_id INT(11), 
	IN first_note_year INT(11),
	IN exec_date DATE, 
	IN employee_id INT(11), 
	IN expense_type INT(11), 
	IN expense_value DECIMAL(11,2),
	IN expense_notes VARCHAR(100),
	IN invoice_id INT(11),
	IN invoice_year INT(11), 
	IN user_id INT(11), 
	IN recipient_id INT(11), 
	IN supplier_invoice_id INT(11), 
	IN supplier_invoice_year INT(11),
	IN payment_id INT(11), 
	OUT new_first_note_id INT(11), 
	OUT new_first_note_year INT(11), 
	OUT result INT(11)
)
BEGIN
	
	IF first_note_year <> YEAR(exec_date) THEN
		SET new_first_note_year = YEAR(exec_date);
		SELECT IFNULL(MAX(Id_prima_nota) + 1, 1)
			INTO new_first_note_id
		FROM prima_nota 
		WHERE anno = first_note_year;
	ELSE 
		SET new_first_note_year = first_note_year;
		SET new_first_note_id = first_note_id;
	END IF;

	UPDATE prima_nota
	SET 
		Id_prima_nota = new_first_note_id, 
		anno = new_first_note_year,
		`Data` = exec_date,
		`Dipendente` = employee_Id,
		`Tipo_spesa` = expense_type,
		`Spesa` = expense_value,
		`Note_spesa` = expense_notes,
		`id_utente` = user_id,
		`id_fattura` = invoice_id,
		`anno_fattura` = invoice_year,
		`id_fornfattura` = supplier_invoice_id,
		`anno_fornfattura` = supplier_invoice_year,
		`id_pagamento` = payment_id,
		`ricevente` = recipient_id
	WHERE `Id_prima_nota` = first_note_id AND
		`anno` = first_note_year;

	CALL sp_ariesFirstNoteEvaluateSupplierInvoice(new_first_note_id,
		new_first_note_year, supplier_invoice_id, supplier_invoice_year, payment_id,
		expense_type);

	CALL sp_ariesFirstNoteEvaluateInvoice(new_first_note_id,
		new_first_note_year, invoice_id, invoice_year, payment_id,
		expense_type);
		
	SET result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesGetCustomerRelationTypeById
DELIMITER //
CREATE PROCEDURE `sp_ariesGetCustomerRelationTypeById`(
	type_id VARCHAR(60)
)
BEGIN

	SELECT
		`id_tipo`,
		`nome`,
		`descrizione`
	FROM tipo_rapclie
	WHERE id_tipo = type_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesGetCustomerTypeById
DELIMITER //
CREATE PROCEDURE `sp_ariesGetCustomerTypeById`(
	type_id VARCHAR(60)
)
BEGIN

	SELECT
		`id_tipo`,
		`nome`,
		`descrizione`
	FROM tipo_cliente
	WHERE id_tipo = type_id; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesGetDdtById
DELIMITER //
CREATE PROCEDURE `sp_ariesGetDdtById`(
	enter_id INT(11), 
	enter_year INT(11)
)
BEGIN

	SELECT 
		`Id_ddt`,
		`anno`,
		`id_cliente`,
		`id_fornitore`,
		`Id_destinazione`,
		`condizione_pagamento`,
		`Porto_resa`,
		`data_documento`,
		`Vettore`,
		`data_ora_ritiro`,
		`data_ora_inizio`,
		`trasport_a_cura`,
		`Causale`,
		`Fattura`,
		`Anno_fattura`,
		`colli`,
		`Peso`,
		`Nota`,
		`Descrizione`,
		`id_principale`,
		`impianto`,
		`STAMPA`,
		`destinazione_forn`,
		`principale_forn`,
		`id_utente`,
		`data_modifica`,
		`stampa_ora`,
		`stampa_data_ora_ritiro`,
		`fatturaf`,
		`anno_fatturaf`,
		`stato`, 
		filename_firma_destinatario, 
		filename_firma_conducente
	FROM Ddt
	WHERE id_ddt = enter_id AND anno = enter_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesGetDdtStatusById
DELIMITER //
CREATE PROCEDURE `sp_ariesGetDdtStatusById`(
	status_id INT(11)
)
BEGIN

	SELECT `Id_stato`,
		`Nome`,
		`Descrizione`,
		`colore`
	FROM Stato_ddt
	WHERE Id_stato = status_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesGetReportStatusById
DELIMITER //
CREATE PROCEDURE `sp_ariesGetReportStatusById`(
	status_id INT(11)
)
BEGIN

	SELECT `Id_stato`,
		`Nome`,
		`Descrizione`,
		`colore`,
		`bloccato`,
		fatturato
	FROM Stato_rapporto
	WHERE Id_stato = status_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesGetReportValidPermissionsById
DELIMITER //
CREATE PROCEDURE `sp_ariesGetReportValidPermissionsById`(
	enter_id INT(11)
)
BEGIN

	SELECT `tipo_utente`,
		`Firma1`,
		`Firma2`,
		`Firma3`
	FROM rapporto_convalida
	WHERE tipo_utente = enter_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesHamletDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesHamletDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM frazione 
	WHERE id_frazione = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesHamletGet
DELIMITER //
CREATE PROCEDURE `sp_ariesHamletGet`( 
)
BEGIN
	SELECT Id_frazione,
	Nome,
	id_comune, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM frazione
	ORDER BY Id_frazione;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesHamletGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesHamletGetById`( 
	Hamlet_id INT
)
BEGIN
	SELECT Id_frazione,
	Nome,
	id_comune,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM frazione
	WHERE Id_frazione = Hamlet_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesHamletGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesHamletGetByName`( 
	name VARCHAR(30)
)
BEGIN
	SELECT Id_frazione,
	Nome,
	id_comune,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM frazione
	WHERE Nome = name;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesHamletInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesHamletInsert`( 
	name VARCHAR(30),
	municipality_id INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM comune 
	WHERE id_comune = municipality_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM frazione 
		WHERE Nome = Name; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Hamlet name already exists
		END IF;
	ELSE
		SET Result = -2; # municipality not found
	END IF;
	
	IF Result = 0 THEN
		INSERT INTO frazione 
		SET 
			Nome = name,
			id_comune = municipality_id, 
			Data_ins = NOW(), 
			Data_mod = NOW(),
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesHamletUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesHamletUpdate`( 
	enter_id INTEGER,
	name VARCHAR(30),
	municipality_id INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM comune 
	WHERE id_comune = municipality_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM frazione 
		WHERE Nome = Name AND Id_frazione != enter_id; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Hamlet name already exists
		END IF;
	ELSE
		SET Result = -2; # municipality not found
	END IF;
	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM frazione 
			WHERE id_frazione = enter_id;
			
			IF Result = 0 THEN
				SET Result = -3; # Hamlet ID not found							
			END IF; 
	END IF; 
	
	IF Result >0 THEN
		UPDATE frazione 
		SET 
			Nome = name,
			id_comune = municipality_id, 
			Utente_mod = @USER_ID
		Where id_frazione = enter_id;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesHomeNotifications
DELIMITER //
CREATE PROCEDURE `sp_ariesHomeNotifications`(IN user_id INT(11))
BEGIN
	DECLARE roles TEXT DEFAULT '';
	DECLARE is_admin BIT(1) DEFAULT 0;
	DECLARE user_type_id INT(11) default 0;

	DECLARE days_quotes_sent_reminder INT(11) default 0;
	DECLARE days_quotes_sent_expiration INT(11) default 0;

	DECLARE has_email_access BIT(1) DEFAULT 0;
	DECLARE has_quote_access BIT(1) DEFAULT 0;
	DECLARE has_report_access BIT(1) DEFAULT 0;
	DECLARE has_invoice_access BIT(1) DEFAULT 0;
	DECLARE has_supplier_invoice_access BIT(1) DEFAULT 0;
	DECLARE has_report_group_access BIT(1) DEFAULT 0;
	DECLARE has_customer_access BIT(1) DEFAULT 0;
	DECLARE has_supplier_access BIT(1) DEFAULT 0;
	DECLARE has_system_access BIT(1) DEFAULT 0;
	DECLARE has_product_access BIT(1) DEFAULT 0;
	DECLARE has_subscription_access BIT(1) DEFAULT 0;
	DECLARE has_ticket_access BIT(1) DEFAULT 0;

	DECLARE days_reminder_payment_invoices INT(11) DEFAULT 30;
	DECLARE days_reminder_subscription_requests INT(11) DEFAULT 30;

	SET roles = (SELECT GROUP_CONCAT(ur.app_name)
		FROM utente_utente_roles uur
			INNER JOIN utente_roles ur ON uur.id_utente_roles = ur.id
		WHERE uur.id_utente = user_id);
	
	SET is_admin = FIND_IN_SET('aries_admin', roles) > 0;

	SELECT
		IFNULL(giorni_promemoria, 30),
		IFNULL(notifica_attesa, 30)
	INTO 
		days_reminder_payment_invoices,
		days_reminder_subscription_requests
	FROM Azienda
	ORDER BY id_azienda DESC
	LIMIT 1;

	
   SELECT tipo_utente INTO user_type_id FROM utente WHERE id_utente = user_id;
	SELECT 
		mail,
		preventivo,
		rapporto,
		fattura,
		fatturar,
		resoconto,
		clienti,
		fornitore,
		impianto OR impianto_tecnico,
		articolo,
		abbonamento,
		ticket,
		rapporto
	INTO
		has_email_access,
		has_quote_access,
		has_report_access,
		has_invoice_access,
		has_supplier_invoice_access,
		has_report_group_access,
		has_customer_access,
		has_supplier_access,
		has_system_access,
		has_product_access,
		has_subscription_access,
		has_ticket_access,
		has_report_access
	FROM tipo_utente
	WHERE id_tipo = user_type_id;

	
	DROP TABLE IF EXISTS temp_notifications;
	CREATE TEMPORARY TABLE temp_notifications (
	  	`tipo_notifica` VARCHAR(50) NOT NULL,
	  	`colore` VARCHAR(50) NOT NULL,
	  	`data_notifica` DATE NULL,
	  	`descrizione` VARCHAR(255) NOT NULL,
	  	`nome` VARCHAR(100) NOT NULL,
		immagine INT(11) NOT NULL,
		giorni INT(11) NOT NULL,
		giorni_scaduto INT(11) NOT NULL,
		bold BIT(1) NOT NULL
	);
	
  	## EMAIL WITH SENDING ERROR OR INIFITE SENDING
	IF has_email_access THEN
		INSERT INTO temp_notifications
		SELECT "failed_emails" AS tipo_notifica,
			"clYellow" As colore,
			NULL as data,
			CONCAT(count(Id)," mail non inviate ") AS descrizione,
			"MAIL FALLITE",
			21 as immagine,
			0 as giorni,
			0 as giorni_scaduto,
			0 as bold
		FROM mail
			WHERE mail.Id_stato=2 OR ((NOW() - data_invio) div 60 > 20 AND mail.Id_stato=0 AND mail.tipo="1") AND mail.tipo="1" 
		HAVING count(Id) > 0;
	END IF;
   
  	## REPORTS
	IF has_report_access THEN
		INSERT INTO temp_notifications
		SELECT "new_reports" AS "tipo_notifica",
			"clyellow" AS "colore",
			NULL AS "data",
			CONCAT(count(*)," nuovi rapporti inviati da mobile") AS "descrizione",
			"NUOVI RAPPORTI",
			8 as immagine,
			0 as giorni,
			0 as giorni_scaduto,
			0 as bold
		FROM rapporto_mobile
		WHERE visionato = 0 AND inviato = 1 AND data IS NOT NULL
		HAVING count(*) > 0

		
   		## CHECKLISTS MOBILE - NEW
		UNION ALL
		SELECT "new_checklists" AS "tipo_notifica",
			"clyellow" AS "colore",
			NULL AS "data",
			CONCAT(count(*)," nuove checklist inviate da mobile") AS "descrizione",
			"NUOVE CHECKLISTS",
			3 as immagine,
			0 as giorni,
			0 as giorni_scaduto,
			0 as bold
		FROM checklist
		WHERE visionata = 0 
		HAVING count(*) > 0;
	END IF;



 
	## Invoices payments
	IF has_invoice_access THEN
		INSERT INTO temp_notifications
		SELECT "invoice_payments_reminder" AS "tipo_notifica",
			"clyellow" AS "colore",
			NULL AS "data", 
			CONCAT(count(*)," in scadenza entro ", days_reminder_payment_invoices, " giorni") AS "descrizione",
			"PAGAMENTI FATTURE",
			34 as immagine,
			days_reminder_payment_invoices as giorni,
			90 as giorni_scaduto,
			0 as bold
		FROM (
			SELECT p.*
			FROM vw_invoices_payments_details p
			INNER join fattura f ON f.id_fattura = p.id_fattura AND f.anno = p.anno
			WHERE p.anno <> 0 AND pagato = 0
				AND data_pagamento_prevista >=  CURRENT_DATE - INTERVAL 0 DAY 
				AND data_pagamento_prevista <= CURRENT_DATE + INTERVAL days_reminder_payment_invoices DAY
				AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_ultimo_promemoria OR data_ultimo_promemoria IS NULL)
				AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_annullamento_promemoria OR data_annullamento_promemoria IS NULL)
			GROUP BY p.id_fattura, p.anno
		) AS app
		HAVING count(*)>0;
	END IF;

	# Quotes waiting for reply
	IF has_quote_access THEN
		SELECT IFNULL(valore + 0, 30) INTO days_quotes_sent_reminder
		FROM preventivo_impost
		WHERE tipo = 'promem_invio';
		
		SELECT IFNULL(valore + 0, 60) INTO days_quotes_sent_expiration
		FROM preventivo_impost
		WHERE tipo = 'scad_invio';

		INSERT INTO temp_notifications
		SELECT "quotes_sent_reminder" AS "tipo_notifica",
			"clyellow" AS "colore",
			NULL AS "data", 
			CONCAT(count(*)," preventivi in attesa di risposta. ") AS "descrizione",
			"PREVENTIVI INVIATI",
			1 as immagine,
			0 as giorni,
			0 as giorni_scaduto,
			0 as bold
		FROM preventivo
		WHERE (
				(data_invio IS NOT NULL AND primo_sollecito IS NULL AND DATEDIFF(curdate(), data_invio) > days_quotes_sent_reminder)
				OR (primo_sollecito IS NOT NULL AND secondo_sollecito IS NULL AND DATEDIFF(curdate(), primo_sollecito) > days_quotes_sent_expiration)
			)
		HAVING count(*)>0;
	END IF;


  	# CUSTOMER - INSERTED TO DOUBLE CHECK
	IF has_customer_access THEN
		INSERT INTO temp_notifications
   		SELECT "customer_to_handle" AS "Id_evento",
			"clyellow" AS "colore",
			NULL AS "data",
			CONCAT(count(*)," nuovi clienti inseriti da gestire.") AS "descrizione",
			"CLIENTI INSERITI",
			13 as immagine,
			0 as giorni,
			0 as giorni_scaduto,
			0 as bold
		FROM clienti
		WHERE modi = 5
		HAVING count(*) > 0;
	END IF;


  	# Subscriptions
	IF has_subscription_access THEN
		INSERT INTO temp_notifications
		SELECT "subscription_requests_reminder" AS "Id_evento",
			"clyellow" AS "colore",
			NULL AS "data",
			CONCAT(count(*)," in attesa di risposta da piu di ", days_reminder_subscription_requests, " giorni.") AS "descrizione",
			"RICHIESTE DI ABBONAMENTO",
			19 as immagine,
			0 as giorni,
			0 as giorni_scaduto,
			0 as bold
		FROM impianto
		WHERE DATEDIFF(CURRENT_DATE, impianto.data_invio_doc) > days_reminder_subscription_requests
			AND impianto.stato_invio_doc="clyellow"
		HAVING count(*) > 0;
	END IF;

	IF has_system_access THEN
		INSERT INTO temp_notifications
		SELECT "expiring_systems_warranty" AS "Id_evento",
			"clyellow" AS "colore",
			NULL AS "data",
			CONCAT(count(*)," in scadenza entro 60 giorni.") AS "descrizione",
			"GARANZIE IMPIANTI",
			35 as immagine,
			60 as giorni,
			30 as giorni_scaduto,
			0 as bold
		FROM impianto
			INNER JOIN stato_impianto ON stato_impianto.id_stato = impianto.stato
		WHERE DATEDIFF(impianto.scadenza_garanzia,CURRENT_DATE) BETWEEN -30 AND 60
			AND stato_impianto.bloccato = 0
		HAVING count(*)>0

		UNION ALL
		SELECT "system_subscriptions_to_renew" AS "Id_evento",
			"ClYellow" AS "colore",
			NULL AS "data",
			CONCAT(count(*)," impianti in attesa di rinnovo abbonamento per l''anno ",  IF(MONTH(CURRENT_DATE()) >= 11, YEAR(CURRENT_DATE()) + 1,  YEAR(CURRENT_DATE())), ".") AS descrizione,
			"RINNOVO ABBONAMENTI",
			28 as immagine,
			0 as giorni,
			0 as giorni_scaduto,
			0 as bold
		FROM (
			SELECT IFNULL(flag_abbonamento, 0 ) as flag_abbonamento, impianto.id_impianto, impianto.descrizione,
				clienti.ragione_sociale, abbonamento.nome AS "abbonamento", tipo_impianto.nome AS "tipo_impianto", ia.anno,
				iu.manutenzione, iu.importo_abbonamento, impianto.persone, round(tempo_manutenzione/60,2) AS "Tempo_manutenzione", Costo_manutenzione
			FROM impianto
				LEFT JOIN impianto_abbonamenti AS ia ON ia.id_impianto=impianto.id_impianto
				LEFT JOIN abbonamento ON abbonamento.id_abbonamento=id_abbonamenti
				LEFT JOIN clienti ON clienti.id_cliente = impianto.id_cliente
				LEFT JOIN tipo_impianto ON id_tipo=tipo_impianto
				LEFT JOIN stato_impianto ON impianto.stato = id_stato
				LEFT JOIN impianto_uscita AS iu ON iu.id_impianto=ia.id_impianto AND iu.anno=ia.anno AND ia.id_abbonamenti=iu.id_abbonamento
			WHERE non_abbonato = 0
				AND ia.id_impianto IS NOT NULL
				AND ((flag_abbonamento_anno IS NULL) 
				AND stato_impianto.bloccato = 0
				OR (flag_abbonamento_anno <> year(curdate()) + 1 AND month(curdate()) >= 11)
				OR (flag_abbonamento_anno <> year(curdate()) AND month(curdate()) < 11))
			GROUP by ia.id_impianto) AS sub_exp_subquery
		HAVING count(*)>0

		UNION ALL
		SELECT "expiring_system_components",
			"clYellow",
			NULL, 
			CONCAT(count(*)," componenti impianto in scadenza entro 30 giorni") AS "descrizione",
			"COMPONENII IMPIANTI" ,
			17 as immagine,
			30 as giorni,
			60 as giorni_scaduto,
			0 as bold
		FROM impianto_componenti 
			INNER JOIN articolo ON impianto_componenti.id_articolo = articolo.codice_articolo 
			INNER JOIN impianto ON impianto_componenti.id_impianto = impianto.id_impianto
			INNER JOIN stato_impianto ON stato_impianto.id_stato = impianto.stato
		WHERE DATEDIFF(curdate(), data_scadenza) BETWEEN -60 AND 30
			AND data_scadenza IS NOT NULL
			AND data_dismesso IS NULL
			AND impianto_componenti.stato = 1
			AND stato_impianto.bloccato = 0
		HAVING count(*)>0

		UNION ALL
		SELECT "expiring_system_sims",
			"clyellow" AS "colore",
			NULL AS "data",
			CONCAT(count(*)," in scadenza entro 30 giorni.") AS "descrizione",
			"RICARICHE IMPIANTI",
			36 as immagine,
			30 as giorni,
			60 as giorni_scaduto,
			0 as bold
		FROM impianto_ricarica_tipo
			INNER JOIN impianto ON impianto.Id_impianto = impianto_ricarica_tipo.id_impianto
			INNER JOIN stato_impianto ON stato_impianto.id_stato = impianto.stato
		WHERE DATEDIFF(impianto_ricarica_tipo.data_scadenza, CURRENT_DATE) BETWEEN -60 AND 30
			AND stato_impianto.bloccato = 0
		HAVING count(*)>0
		

		UNION ALL
		SELECT "system_maintenance_list",
			"clyellow" AS "colore",
			NULL AS "data",
			CONCAT(count(*)," in scadenza entro 30 giorni.") AS "descrizione",
			"CONTROLLI PERIODICI",
			23 as immagine,
			30 as giorni,
			60 as giorni_scaduto,
			0 as bold
		FROM impianto_abbonamenti_mesi
			INNER JOIN impianto ON impianto.Id_impianto = impianto_abbonamenti_mesi.impianto
			INNER JOIN stato_impianto ON stato_impianto.id_stato = impianto.stato
		WHERE eseguito_il IS NULL
			AND DATEDIFF(
				IFNULL(da_eseguire, DATE_ADD(MAKEDATE(impianto_abbonamenti_mesi.anno, 1), INTERVAL (impianto_abbonamenti_mesi.mese)-1 MONTH)),
				CURRENT_DATE
			) BETWEEN -60 AND 30
			AND stato_impianto.bloccato = 0
		HAVING COUNT(*)>0;
	END IF;
    
	
	IF has_ticket_access THEN
		INSERT INTO temp_notifications 
		SELECT "expiring_tickets",
			"clyellow"  AS "colore",
			NULL AS "data",
			CONCAT(count(*)," in scadenza entro 30 giorni.") AS descrizione ,
			"SCADENZA TICKET" AS "tipo",
			7 as immagine,
			30 as giorni,
			60 as giorni_scaduto,
			0 as bold
		FROM ticket
		WHERE DATEDIFF(scadenza, CURRENT_DATE) BETWEEN -60 AND 30
			AND scadenza IS NOT NULL
			AND data_soluzione IS NULL
			AND stato_ticket IN (1, 2)
		HAVING count(*)>0;
	END IF;
      
  	## List corsi in scadenza
	INSERT INTO temp_notifications 
	SELECT "expiring_courses",
		"clWhite" AS colore,
		NULL AS data_inizio,
		CONCAT(count(*)," in scadenza entro 30 giorni.") AS descrizione,
		"CORSI SCADUTI",
		0 as immagine,
		30 as giorni,
		60 as giorni_scaduto,
		0 as bold
	FROM corso
			LEFT JOIN operaio_corso ON corso.id_corso = operaio_corso.id_corso
		LEFT JOIN operaio ON operaio.id_operaio = operaio_corso.id_operaio
		LEFT JOIN tipo_evento ON tipo_evento = tipo_evento.id_tipo
	WHERE DATEDIFF(data_fine, CURRENT_DATE) BETWEEN -60 AND 30
		AND corso.stato = 1
	HAVING COUNT(*) > 0;

	INSERT INTO temp_notifications 
	SELECT "aries_server_warning",
		"$7280FA" AS colore,
		NULL AS data_inizio,
		CONCAT("Ci sono ", count(*), " rapporti bloccati, Aries Server sembra BLOCCATO.") AS descrizione,
		"ARIES SERVER",
		19 as immagine,
		0 as giorni,
		0 as giorni_scaduto,
		1 as bold
	FROM (
		SELECT id_rapporto, anno
		FROM rapporto_mobile WHERE DATA IS NOT NULL AND inviato = 0 AND visionato = 0 AND ROUND(time_to_sec((TIMEDIFF(NOW(), timestamp_invio))) / 60) > 5
		UNION ALL 
		SELECT id_rapporto, anno
		FROM rapporto_mobile_collaudo WHERE DATA IS NOT NULL AND processato = 0 AND ROUND(time_to_sec((TIMEDIFF(NOW(), timestamp_invio))) / 60) > 5
	) AS blocked
	HAVING COUNT(*) > 0;
	
	
	SELECT * FROM temp_notifications ORDER BY nome;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInterventionTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesInterventionTypeGetById`(
type_id INT(11)
)
BEGIN

	SELECT Id_tipo, 
		Nome, 
		Descrizione
	FROM Tipo_intervento
	WHERE Id_tipo = type_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceAmountByTaxDeleteByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceAmountByTaxDeleteByInvoice`(
	IN invoice_id INT(11), 
	IN invoice_year INT(11),
	OUT result INT(11)
)
BEGIN
	DELETE FROM fattura_totali_iva
	WHERE id_fattura = invoice_id AND anno = invoice_year;	
	
	SET result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceAmountByTaxGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceAmountByTaxGetByInvoice`(
	IN invoice_id INT(11), 
	IN invoice_year INT(11)
)
BEGIN
	SELECT 	`id`,
		`id_fattura`,
		`anno`,
		`id_iva` ,
		`importo_imponibile`,
		`importo_iva`,
		`importo_totale`
	FROM fattura_totali_iva
	WHERE id_fattura = invoice_id AND anno = invoice_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceAttachsDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceAttachsDelete`(
	IN input_id INT(11)
)
BEGIN
	DELETE FROM fattura_allegati
	WHERE id = input_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceAttachsGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceAttachsGetByInvoice`(
	IN invoice_id INT(11), 
	IN invoice_year INT(11)
)
BEGIN
	SELECT
		`id`,
		`id_fattura`,
		`Anno_fattura`,
		`Nome` ,
		`Descrizione`,
		`Formato`,
		`File_path`,
		`Timestamp`
	FROM fattura_allegati
	WHERE id_fattura = invoice_id AND Anno_fattura = invoice_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceCancelReminder
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceCancelReminder`(
	IN `invoice_id` INT(11),
	IN invoice_year INT(11)
)
BEGIN
	UPDATE fattura
	SET data_annullamento_promemoria = CURRENT_DATE
	WHERE id_fattura = invoice_id AND anno = invoice_year;		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceChangeSentStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceChangeSentStatus`( 
	IN invoice_id INT(11),
	IN invoice_year INT(11),
	IN is_sent BIT(1)
)
BEGIN
	UPDATE fattura
	SET inviato = is_sent
	WHERE id_fattura = invoice_id AND anno = invoice_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceCheckAllowedIdAndDate
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceCheckAllowedIdAndDate`(
	IN invoice_id INT(11),
	IN invoice_year INT(11),
	IN invoice_date DATE,
	OUT result  BIT(1)
)
BEGIN
	DECLARE prev_invoice_date DATE;
	DECLARE next_invoice_date DATE;
	
	IF invoice_year != 0 THEN
		SELECT data
		INTO prev_invoice_date
		FROM fattura
		WHERE anno = invoice_year AND id_fattura < invoice_id
		ORDER BY id_fattura DESC
		LIMIT 1;
		
		IF prev_invoice_date IS NULL THEN
			SELECT data
			INTO prev_invoice_date
			FROM fattura
			WHERE anno < invoice_year AND anno != 0
			ORDER BY anno DESC, id_fattura DESC
			LIMIT 1;
		END IF;


		SELECT data
		INTO next_invoice_date
		FROM fattura
		WHERE anno = invoice_year AND id_fattura > invoice_id
		ORDER BY id_fattura ASC
		LIMIT 1;
		
		IF next_invoice_date IS NULL THEN
			SELECT data
			INTO next_invoice_date
			FROM fattura
			WHERE anno > invoice_year AND anno != 0
			ORDER BY anno ASC, id_fattura ASC
			LIMIT 1;
		END IF;


		SET result = (prev_invoice_date IS NULL OR invoice_date >= prev_invoice_date)
			AND (next_invoice_date IS NULL OR invoice_date <= next_invoice_date);
	ELSE
		SET result = 1;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceClone
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceClone`( 
	IN invoice_id INT(11),
	IN invoice_year INT(11),
	OUT result INT(11)
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
  	DECLARE new_id INT(11); 
  	DECLARE new_year INT(11);
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;	
		
	START TRANSACTION;
	SET result = 1;
	SET new_year = 0;
	
	SELECT IFNULL(MAX(id_fattura) + 1, 1) 
		INTO new_id
	FROM fattura
	WHERE anno = 0; 

	INSERT INTO fattura (
		Id_fattura, anno, id_cliente, id_destinazione, destinazione, Data_registrazione, data_modifica, DATA,
		cond_pagamento, banca, annotazioni, Stato, causale_fattura, nota_interna, iban, abi, cab, tipo_fattura,
		incasso, bollo, trasporto, pagato_il, tramite, insoluto, stampato, subappalto, id_utente, scont_mat, id_iv,
		movimenta_magazzino, id_documento_ricezione, id_tipo_natura_iva, area_attivita,
		importo_imponibile, importo_iva, importo_totale, costo_totale
	)
	SELECT new_id, new_year, id_cliente, id_destinazione, destinazione, NOW(), NOW(), NOW(),
		cond_pagamento, banca, annotazioni, 5, causale_fattura, nota_interna, iban, abi, cab, tipo_fattura,
		incasso, bollo, trasporto, pagato_il, tramite, 0, 0, subappalto, @USER_ID, scont_mat, id_iv,
		movimenta_magazzino, id_documento_ricezione, id_tipo_natura_iva, area_attivita,
		importo_imponibile, importo_iva, importo_totale, costo_totale
	FROM fattura
	WHERE id_fattura = invoice_id AND anno = invoice_year;

	INSERT INTO fattura_articoli (
		id_fattura, Anno, n_tab, Descrizione, um, quantità, prezzo_unitario, sconto, costo, serial_number,
		id_materiale, Iva, codice_fornitore, anno_rif, id_rif, tipo, idnota
	)
	SELECT new_id, new_year, n_tab, Descrizione, um, quantità, prezzo_unitario, sconto, costo, serial_number,
		id_materiale, Iva, codice_fornitore, anno_rif, id_rif, tipo, idnota
	FROM fattura_articoli
	WHERE id_fattura = invoice_id AND anno = invoice_year;
	
	INSERT INTO fattura_totali_iva (
		id_fattura, Anno, id_iva, importo_imponibile, importo_iva, importo_totale
	)
	SELECT new_id, new_year, id_iva, importo_imponibile, importo_iva, importo_totale
	FROM fattura_totali_iva
	WHERE id_fattura = invoice_id AND anno = invoice_year;


	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceDelete`(
	IN enter_id INT(11),
	IN enter_year INT(11),
	OUT result  TINYINT
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;	
		
	START TRANSACTION;

  UPDATE rapporto
	SET stato=1,
		Fattura = NULL,
		Anno_fattura = NULL
	WHERE anno_fattura = enter_year AND Fattura = enter_id;

	UPDATE resoconto 
	SET stato=1,
		Fattura = NULL,
		Anno_fattura = NULL
	WHERE anno_fattura = enter_year AND Fattura = enter_id;

  DELETE FROM commessa_fattura 
	WHERE anno_fattura = enter_year AND id_fattura = enter_id;

  UPDATE ddt 
	SET Fattura = NULL, 
		Anno_fattura = NULL, 
		Stato = 1
	WHERE anno_fattura = enter_year AND Fattura = enter_id;

  DELETE FROM fattura_totali_iva 
	WHERE anno = enter_year AND id_fattura = enter_id;

  DELETE FROM fattura_acconto
	WHERE anno = enter_year AND id_fattura = enter_id;
	
  DELETE FROM fattura_articoli 
	WHERE anno = enter_year AND id_fattura = enter_id;

  DELETE FROM fattura_pagamenti
	WHERE anno = enter_year AND id_fattura = enter_id;

	DELETE FROM fattura_sollecito_numeri
	WHERE anno_fattura = enter_year AND Fattura = enter_id;

	DELETE FROM fattura_studi
	WHERE anno = enter_year AND Id_fattura = enter_id;

	DELETE FROM fattura_ordine_acquisto
	WHERE anno_fattura = enter_year AND id_Fattura = enter_id;
	
  DELETE FROM fattura 
	WHERE anno = enter_year AND id_fattura = enter_id;

	SET result = 1;
					
	IF `_rollback` THEN
	  ROLLBACK;
	  SET result = -10; 
	ELSE
		COMMIT; 
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceEvaluateStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceEvaluateStatus`(
	invoice_id INT(11), 
	invoice_year INT(11)
)
BEGIN

	DECLARE totals_payments_to_do TINYINT; 
	DECLARE totals_payments_done TINYINT; 
	DECLARE new_status INT(11);
	DECLARE current_status INT(11);

	
	SELECT COUNT(IFNULL(Insoluto,1))
		INTO 
		totals_payments_done
	FROM fattura_pagamenti
	WHERE id_fattura=invoice_id AND anno=invoice_year AND data IS NOT NULL; 

	
	SELECT IFNULL(mesi, 0) , stato
		INTO
		totals_payments_to_do, current_status
	FROM fattura 
		INNER JOIN condizione_pagamento 
			ON fattura.cond_pagamento = condizione_pagamento.id_condizione
	WHERE id_fattura=invoice_id
			AND anno=invoice_year; 
	
	
	IF totals_payments_done = totals_payments_to_do THEN
		SET new_status = 3; 
	ELSE
		SET new_status = 1; 
	END IF; 
	
	IF new_status <> current_status THEN
		UPDATE fattura 
		SET stato = new_status
		WHERE id_fattura= invoice_id
			AND anno= invoice_year 
			AND stato <> new_status; 
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceGet
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceGet`(

)
BEGIN

	SELECT
		`Id`,
		`Id_fattura`,
		`anno`,
		1 as `Id_bollettario`,
		`id_cliente`,
		`id_destinazione`,
		`destinazione`,
		`Data_registrazione`,
		CAST(IFNULL(data_modifica ,'1970-01-01') AS DATETIME) data_modifica,
		`data`,
		`cond_pagamento`,
		`banca` ,
		`annotazioni`,
		`Stato`,
		`causale_fattura`,
		`nota_interna`,
		`iban`,
		`abi`,
		`cab`,
		`tipo_fattura`,
		`incasso`,
		`bollo`,
		`trasporto`,
		`inviato`,
		CAST(IFNULL(pagato_il ,'00:00:00') AS TIME) pagato_il,
		IFNULL(`tramite`, 0) tramite,
		`insoluto`,
		`stampato`,
		`subappalto`,
		IFNULL(`id_utente`, 0) id_utente,
		`scont_mat`,
		IFNULL(`id_iv`, 0) id_iv,
		id_tipo_natura_iva,
		CAST(IFNULL(data_invio_promemoria ,'1970-01-01') AS DATETIME) data_invio_promemoria,
		IFNULL(`controllo_promemoria`, 1) controllo_promemoria,
		`area_attivita`,
		IFNULL(`nostra`, 0) nostra,
		`data_ultima_modifica`,
		importo_imponibile, 
		importo_iva,
		importo_totale,
		costo_totale,
		id_documento_ricezione,
		movimenta_magazzino
	FROM Fattura;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceGetById`(
	IN enter_id INT(11)
)
BEGIN

	SELECT
		`Id`,
		`Id_fattura`,
		`anno`,
		1 as `Id_bollettario`,
		`id_cliente`,
		`id_destinazione`,
		`destinazione`,
		`Data_registrazione`,
		CAST(IFNULL(data_modifica ,'1970-01-01') AS DATETIME) data_modifica,
		`data`,
		`cond_pagamento`,
		`banca` ,
		`annotazioni`,
		`Stato`,
		`causale_fattura`,
		`nota_interna`,
		`iban`,
		`abi`,
		`cab`,
		`tipo_fattura`,
		`incasso`,
		`bollo`,
		`trasporto`,
		`inviato`,
		CAST(IFNULL(pagato_il ,'00:00:00') AS TIME) pagato_il,
		IFNULL(`tramite`, 0) tramite,
		`insoluto`,
		`stampato`,
		`subappalto`,
		IFNULL(`id_utente`, 0) id_utente,
		`scont_mat`,
		IFNULL(`id_iv`, 0) id_iv,
		id_tipo_natura_iva,
		CAST(IFNULL(data_invio_promemoria ,'1970-01-01') AS DATETIME) data_invio_promemoria,
		IFNULL(`controllo_promemoria`, 1) controllo_promemoria,
		`area_attivita`,
		IFNULL(`nostra`, 0) nostra,
		`data_ultima_modifica`,
		importo_imponibile, 
		importo_iva,
		importo_totale,
		costo_totale,
		id_documento_ricezione,
		movimenta_magazzino
	FROM Fattura
	WHERE Fattura.Id = enter_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceGetByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceGetByIdAndYear`(
	IN enter_id INT(11), 
	IN enter_year INT(11)
)
BEGIN

	SELECT
		`Id`,
		`Id_fattura`,
		`anno`,
		1 as `Id_bollettario`,
		`id_cliente`,
		`id_destinazione`,
		`destinazione`,
		`Data_registrazione`,
		CAST(IFNULL(data_modifica ,'1970-01-01') AS DATETIME) data_modifica,
		`data`,
		`cond_pagamento`,
		`banca` ,
		`annotazioni`,
		`Stato`,
		`causale_fattura`,
		`nota_interna`,
		`iban`,
		`abi`,
		`cab`,
		`tipo_fattura`,
		`incasso`,
		`bollo`,
		`trasporto`,
		`inviato`,
		CAST(IFNULL(pagato_il ,'00:00:00') AS TIME) pagato_il,
		IFNULL(`tramite`, 0) tramite,
		`insoluto`,
		`stampato`,
		`subappalto`,
		IFNULL(`id_utente`, 0) id_utente,
		`scont_mat`,
		IFNULL(`id_iv`, 0) id_iv,
		id_tipo_natura_iva,
		CAST(IFNULL(data_invio_promemoria ,'1970-01-01') AS DATETIME) data_invio_promemoria,
		IFNULL(`controllo_promemoria`, 1) controllo_promemoria,
		`area_attivita`,
		IFNULL(`nostra`, 0) nostra,
		`data_ultima_modifica`,
		importo_imponibile, 
		importo_iva,
		importo_totale,
		costo_totale,
		id_documento_ricezione,
		movimenta_magazzino
	FROM Fattura
	WHERE Fattura.Id_fattura = enter_id AND Fattura.anno = enter_year;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceGetByTagId
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceGetByTagId`(
	IN tag_id INT(11)
)
BEGIN

	SELECT
		`Id`,
		fattura.`Id_fattura`,
		`anno`,
		1 as `Id_bollettario`,
		`id_cliente`,
		`id_destinazione`,
		`destinazione`,
		`Data_registrazione`,
		CAST(IFNULL(data_modifica ,'1970-01-01') AS DATETIME) data_modifica,
		`data`,
		`cond_pagamento`,
		`banca` ,
		`annotazioni`,
		`Stato`,
		`causale_fattura`,
		`nota_interna`,
		`iban`,
		`abi`,
		`cab`,
		`tipo_fattura`,
		`incasso`,
		`bollo`,
		`trasporto`,
		`inviato`,
		CAST(IFNULL(pagato_il ,'00:00:00') AS TIME) pagato_il,
		IFNULL(`tramite`, 0) tramite,
		`insoluto`,
		`stampato`,
		`subappalto`,
		IFNULL(`id_utente`, 0) id_utente,
		`scont_mat`,
		IFNULL(`id_iv`, 0) id_iv,
		id_tipo_natura_iva,
		CAST(IFNULL(data_invio_promemoria ,'1970-01-01') AS DATETIME) data_invio_promemoria,
		IFNULL(`controllo_promemoria`, 1) controllo_promemoria,
		`area_attivita`,
		IFNULL(`nostra`, 0) nostra,
		`data_ultima_modifica`,
		importo_imponibile, 
		importo_iva,
		importo_totale,
		costo_totale,
		id_documento_ricezione,
		movimenta_magazzino
	FROM Fattura
		INNER JOIN fattura_tag ON Fattura.id_fattura = fattura_tag.id_fattura AND Fattura.anno = fattura_tag.anno_fattura
	WHERE fattura_tag.id_tag = tag_id; 
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceGetForDeadlineAlert
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceGetForDeadlineAlert`(

)
BEGIN
	SELECT
		`Id`,
		`Id_fattura`,
		`anno`,
		1 as `Id_bollettario`,
		`id_cliente`,
		`id_destinazione`,
		`destinazione`,
		`Data_registrazione`,
		CAST(IFNULL(data_modifica ,'1970-01-01') AS DATETIME) data_modifica,
		`data`,
		`cond_pagamento`,
		`banca`                       ,
		`annotazioni`,
		`Stato`,
		`causale_fattura`,
		`nota_interna`,
		`iban`,
		`abi`,
		`cab`,
		`tipo_fattura`,
		`incasso`,
		`bollo`,
		`trasporto`,
		`inviato`,
		CAST(IFNULL(pagato_il ,'00:00:00') AS TIME) pagato_il,
		IFNULL(`tramite`, 0) tramite,
		`insoluto`,
		`stampato`,
		`subappalto`,
		IFNULL(`id_utente`, 0) id_utente,
		`scont_mat`,
		IFNULL(`id_iv`, 0) id_iv,
		CAST(IFNULL(data_invio_promemoria ,'1970-01-01') AS DATETIME) data_invio_promemoria,
		IFNULL(`controllo_promemoria`, 1) controllo_promemoria,
		`area_attivita`,
		IFNULL(`nostra`, 0) nostra,
		`data_ultima_modifica`,
		importo_imponibile, 
		importo_iva,
		importo_totale,
		costo_totale,
		id_documento_ricezione
	FROM Fattura
	WHERE CURDATE() > DATE_ADD(Fattura.data, INTERVAL 5 DAY) AND Inviato = 0 AND (Anno > 2019 OR Anno = 0) 
	ORDER BY DATA ASC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceInsert`(
	IN invoice_id INT(11), 
	IN invoice_year INT(11), 
	IN invoice_category INT(11),
	IN invoice_date DATE, 
	IN customer_id INT(11), 
	IN destination INT(11), 
	IN destination_id INT(11), 
	IN `registration_date` DATE,
	IN `edit_date` DATE,
	IN `payment_condition_id` INT(11),
	IN `bank_id` INT(11),
	IN `annotations` TEXT,
	IN `status_id` INT(11),
	IN `transport_casual_id` INT(11),
	IN `internal_note` VARCHAR(100),
	IN `iban` VARCHAR(45),
	IN `abi` VARCHAR(6),
	IN `cab` VARCHAR(6),
	IN `type_id` INT(11),
	IN `recessed_import` FLOAT(11,2),
	IN `stamp_import` FLOAT(11,2),
	IN `transport_import` FLOAT(11,2),
	IN `is_sent` INT(11),
	IN `sending_method` INT(11),
	IN `is_printed` TINYINT(1),
	IN `subcontract` TINYINT(4),
	IN `user_id` INT(11),
	IN `products_discount` VARCHAR(15),
	IN `vat_id` INT(11),
	IN `reminder_date` DATE,
	IN `reminder_check` TINYINt(1),
	IN `work_area` VARCHAR(45),
	IN `is_our` TINYINT(1), 
	OUT result INT(11) 
)
BEGIN

	
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	
	START TRANSACTION; 

	

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePaymentGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePaymentGetById`( 
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11),
	IN `payment_id` INT(11)
)
BEGIN
	DECLARE iva_collectability VARCHAR(5); 
	SELECT esigibilita 
		INTO iva_collectability
	FROM fattura INNER JOIN tipo_iva ON fattura.id_iv = tipo_iva.id_iva
	WHERE Fattura.Id_fattura = invoice_id 
		AND fattura.anno = invoice_year;

	SELECT 
		IF(fattura_pagamenti.id_fattura IS NULL, false, True) AS 'Exists',
		fattura.id_fattura,
		fattura.anno, 
		fattura.id_cliente,
		ifNULL(id_pagamento, CAST(DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d') AS UNSIGNED)) as id_pagamento_fix,
		fattura_pagamenti.nota,
		IFNULL(fattura_pagamenti.tipo_pagamento, a.tipo) as 'tipo_pagamento',
		fattura_pagamenti.insoluto,
		fattura_pagamenti.id_prima_nota,
		fattura_pagamenti.anno_prima_nota,
		fattura_pagamenti.id_trasferimento_verso,
		fattura_pagamenti.anno_trasferimento_verso,
		ROUND(IF(iva_collectability <> 'S', fattura.importo_totale, fattura.importo_imponibile)/a.mesi, 2) AS "importo_rata", 
		ROUND(fattura.importo_imponibile/a.mesi, 2) AS "importo_rata_imponibile", 
		ROUND(IF(iva_collectability <> 'S', fattura.importo_iva/a.mesi, 0), 2) AS "importo_rata_iva",  
		if (iva_collectability = 'S', 1, 0)  AS "split_payment", -- in questo caso l'iva non va a fare parte dell'importo della rata
		fattura_pagamenti.`data` AS "data",
		LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY AS "data_prevista"
		
	FROM fattura
		INNER JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione
		INNER JOIN condizioni_giorno AS g ON g.id_condizione = a.id_condizione
		LEFT JOIN fattura_pagamenti ON fattura.id_fattura=fattura_pagamenti.id_fattura AND fattura_pagamenti.anno=fattura.anno AND fattura_pagamenti.id_pagamento= DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d')
	WHERE Fattura.Id_fattura = invoice_id 
		AND fattura.anno = invoice_year 
		AND IfNULL(id_pagamento, CAST(DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d') AS UNSIGNED)) = payment_id
	GROUP BY fattura.id_fattura, fattura.anno, id_pagamento_fix
	ORDER BY fattura.anno desc, fattura.id_fattura desc;

	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePaymentGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePaymentGetByInvoice`( 
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11)
)
BEGIN

	DECLARE iva_collectability VARCHAR(5); 
	SELECT esigibilita 
		INTO iva_collectability
	FROM fattura INNER JOIN tipo_iva ON fattura.id_iv = tipo_iva.id_iva
	WHERE Fattura.Id_fattura = invoice_id 
		AND fattura.anno = invoice_year;


	SELECT 
		IF(fattura_pagamenti.id_fattura IS NULL, false, True) AS 'Exists',
		fattura.id_fattura,
		fattura.anno, 
		fattura.id_cliente,
		ifNULL(id_pagamento, CAST(DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d') AS UNSIGNED)) as id_pagamento_fix,
		fattura_pagamenti.nota,
		IFNULL(fattura_pagamenti.tipo_pagamento, a.tipo) as 'tipo_pagamento',
		fattura_pagamenti.insoluto,
		fattura_pagamenti.id_prima_nota,
		fattura_pagamenti.anno_prima_nota,
		fattura_pagamenti.id_trasferimento_verso,
		fattura_pagamenti.anno_trasferimento_verso,
		ROUND(IF(iva_collectability <> 'S', fattura.importo_totale, fattura.importo_imponibile)/a.mesi, 2) AS "importo_rata", 
		ROUND(fattura.importo_imponibile/a.mesi, 2) AS "importo_rata_imponibile", 
		ROUND(IF(iva_collectability <> 'S', fattura.importo_iva/a.mesi, 0), 2) AS "importo_rata_iva",  
		if (iva_collectability = 'S', 1, 0)  AS "split_payment", -- in questo caso l'iva non va a fare parte dell'importo della rata
		fattura_pagamenti.`data` AS "data",
		LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY AS "data_prevista"
		
	FROM fattura
		INNER JOIN fattura_articoli AS c ON c.id_fattura = fattura.id_fattura AND c.anno=fattura.anno
		INNER JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione
		INNER JOIN condizioni_giorno AS g ON g.id_condizione = a.id_condizione
		LEFT JOIN fattura_pagamenti ON fattura.id_fattura=fattura_pagamenti.id_fattura AND fattura_pagamenti.anno=fattura.anno AND fattura_pagamenti.id_pagamento= DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d')
	WHERE Fattura.Id_fattura = invoice_id 
		AND fattura.anno = invoice_year 
	GROUP BY fattura.id_fattura, fattura.anno, id_pagamento_fix
	ORDER BY fattura.anno desc, fattura.id_fattura desc;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePaymentInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePaymentInsert`( 
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11),
	IN `payment_id` INT(11), 
	IN payment_date DATE, 
	IN notes TEXT, 
	IN payment_type INT(11), 
	IN unsolved BIT(1),
	OUT result INT(11)
)
BEGIN
	DECLARE reminder_date DATE;

	INSERT INTO fattura_pagamenti
	SET id_fattura = invoice_id, 
		anno = invoice_year, 
		id_pagamento = payment_id, 
		nota = notes, 
		tipo_pagamento = payment_type, 
		insoluto = unsolved,
		data = payment_date; 
	
	IF payment_date IS NULL THEN
		SET reminder_date = STR_TO_DATE('0002-02-02', '%Y-%m-%d');
	ELSE
		SET reminder_date = STR_TO_DATE(CONCAT(payment_id, ''), '%Y%m%d');
	END IF;
	
	UPDATE fattura 
	SET data_invio_promemoria = reminder_date 
	WHERE id_fattura = invoice_id AND anno = invoice_year;
	
	SET result = 1;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePaymentUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePaymentUpdate`( 
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11),
	IN `payment_id` INT(11), 
	IN payment_date DATE, 
	IN notes TEXT, 
	IN payment_type INT(11), 
	IN unsolved BIT(1),
	OUT result INT(11)
)
BEGIN
	DECLARE reminder_date DATE;
	DECLARE last_payment_date DATE; 
	
	IF (payment_date IS NULL OR (payment_type <> 4 AND payment_type <> 3)) THEN
		CALL sp_ariesFirstNoteDeleteByInvoice(invoice_id, invoice_year, payment_id, result);
	ELSE 
		SELECT data INTO last_payment_date 
		FROM fattura_pagamenti 
		WHERE id_fattura = invoice_id AND 
			anno = invoice_year AND 
			id_pagamento = payment_id;
			
		IF last_payment_date <> payment_date THEN
		
			UPDATE prima_nota
			SET Data = payment_date		
			WHERE id_fattura = invoice_id AND 
				anno_fattura = invoice_year AND 
				id_pagamento = payment_id;
			
		END IF; 
	END IF;
	
	UPDATE fattura_pagamenti
	SET  nota = notes, 
		tipo_pagamento = payment_type, 
		insoluto = unsolved,
		data = payment_date
	WHERE id_fattura = invoice_id AND 
		anno = invoice_year AND 
		id_pagamento = payment_id; 
		
	IF payment_date IS NULL THEN
		SET reminder_date = STR_TO_DATE('0002-02-02', '%Y-%m-%d');
	ELSE
		SET reminder_date = STR_TO_DATE(CONCAT(payment_id, ''), '%Y%m%d');
	END IF;
	
	UPDATE fattura 
	SET data_invio_promemoria = reminder_date 
	WHERE id_fattura = invoice_id AND anno = invoice_year;

	SET result = 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePrepaymentGet
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePrepaymentGet`( 

)
BEGIN
	SELECT 
		`id_acconto`,
		`id_fattura`,
		`anno`,
		`id_pagamento`,
		`importo`,
		`data`,
		`modo`
	FROM fattura_acconto;
 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePrepaymentGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePrepaymentGetById`( 
	IN prepayment_id INT(11)
)
BEGIN
	SELECT 
		`id_acconto`,
		`id_fattura`,
		`anno`,
		`id_pagamento`,
		`importo`,
		`data`,
		`modo`
	FROM fattura_acconto
	WHERE id_acconto = prepayment_id;
 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePrepaymentGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePrepaymentGetByInvoice`( 
	IN invoice_id INT(11), 
	IN invoice_year INT(11)
)
BEGIN
	SELECT 
		`id_acconto`,
		`id_fattura`,
		`anno`,
		`id_pagamento`,
		`importo`,
		`data`,
		`modo`
	FROM fattura_acconto
	WHERE id_fattura = invoice_id
		AND anno = invoice_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePrepaymentGetByPayment
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePrepaymentGetByPayment`( 
	IN invoice_id INT(11), 
	IN invoice_year INT(11), 
	IN payment_id INT(11)
)
BEGIN
	SELECT 
		`id_acconto`,
		`id_fattura`,
		`anno`,
		`id_pagamento`,
		`importo`,
		`data`,
		`modo`
	FROM fattura_acconto
	WHERE id_fattura = invoice_id
		AND anno = invoice_year
		AND id_pagamento = payment_id;
 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceProductGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceProductGetByInvoice`( 
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11)
)
BEGIN

	SELECT 
		`id_fattura`,
		`Anno`,
		`n_tab`,
		`Descrizione`,
		`um`,
		`quantità`,
		`prezzo_unitario`,
		`sconto`,
		`costo`,
		`serial_number`,
		`id_materiale`,
		`Iva`,
		`codice_fornitore`,
		`anno_rif`,
		`id_rif`,
		`tipo`,
		`idnota`
	FROM fattura_articoli
	WHERE id_fattura = invoice_id AND Anno = invoice_year
	ORDER BY n_tab ASC;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePurchaseOrderDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePurchaseOrderDelete`(
	IN in_id INT(11)
)
BEGIN
	DELETE FROM fattura_ordine_acquisto
	WHERE Id = in_id;	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePurchaseOrderGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePurchaseOrderGetByInvoice`(
	IN invoice_id INT(11),
	IN invoice_year INT(11)
)
BEGIN
	SELECT
		`Id`,
		`Id_fattura`,
		`Anno_fattura`,
		`Id_documento`,
		`Data`,
		`Codice_cig`,
		`Codice_cup`,
		`Timestamp`
	FROM fattura_ordine_acquisto
	WHERE Id_fattura = invoice_id AND Anno_fattura = invoice_year;	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePurchaseOrderInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePurchaseOrderInsert`(
	IN invoice_id INT(11),
	IN invoice_year INT(11),
	IN document_id VARCHAR(20),
	IN in_date DATE,
	IN cig_code VARCHAR(15),
	IN cup_code VARCHAR(15),
	OUT Result INT(11)
)
BEGIN
	INSERT INTO fattura_ordine_acquisto
	SET `Id_fattura` = invoice_id,
		`Anno_fattura` = invoice_year,
		`Id_documento` = document_id,
		`Data` = in_date,
		`Codice_cig` = cig_code,
		`Codice_cup` = cup_code;	

	SET Result = LAST_INSERT_ID(); 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicePurchaseOrderUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicePurchaseOrderUpdate`(
	IN in_id INT(11),
	IN invoice_id INT(11),
	IN invoice_year INT(11),
	IN document_id VARCHAR(20),
	IN in_date DATE,
	IN cig_code VARCHAR(15),
	IN cup_code VARCHAR(15),
	OUT Result INT(11)
)
BEGIN
	UPDATE fattura_ordine_acquisto
	SET `Id_fattura` = invoice_id,
		`Anno_fattura` = invoice_year,
		`Id_documento` = document_id,
		`Data` = in_date,
		`Codice_cig` = cig_code,
		`Codice_cup` = cup_code
	WHERE id = in_id;	

	SET Result = 1; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceSaveTotals
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceSaveTotals`(
	IN `invoice_id` INT(11),
	IN `total_amount` DECIMAL(11, 2),
	IN `taxable_amount` DECIMAL(11, 2),
	IN `tax_amount` DECIMAL(11, 2),
	IN `total_cost` DECIMAL(11, 2),
	OUT result BIT(11)
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	
	START TRANSACTION;
	
	UPDATE fattura
	SET importo_imponibile = taxable_amount,
		importo_iva = tax_amount,
		importo_totale = total_amount,
		costo_totale = total_cost
	WHERE id = invoice_id;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceSetPaymentCondition
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceSetPaymentCondition`(
	IN enter_id INT(11), 
	IN enter_year INT(11),
	IN payment_condition_id INT(1),
	OUT Result INT(11)
	
)
BEGIN

	UPDATE fattura
	SET cond_pagamento = payment_condition_id
	WHERE Id_fattura = enter_id AND anno = enter_year;
	SET Result = 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceSetReminderCheck
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceSetReminderCheck`(
	IN `invoice_id` INT(11),
	IN invoice_year INT(11),
	IN reminder_check BIT(1)
)
BEGIN
	UPDATE fattura
	SET controllo_promemoria = reminder_check
	WHERE id_fattura = invoice_id AND anno = invoice_year;		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceSettingsGetLast
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceSettingsGetLast`(  )
BEGIN

	SELECT 
		`id`,
		`colonna1`,
		`colonna3`,
		`nota_fissa`,
		`nome_col3`,
		`jjoin`,
		`nota_mail`,
		`nome_col1`,
		`imp_rap`,
		`ddt_prezzorap`,
		`scontozero`,
		`prezzozero`,
		`impianto`,
		`id_certificato_firma`,
		`email_sdi`,
		`estratto_conto_testo_mail`,
		`utente_mod`,
		`data_mod`
	FROM fattura_configurazione
	ORDER BY id DESC 
	LIMIT 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicesReminderCancelSelected
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicesReminderCancelSelected`()
BEGIN
	DECLARE days_reminder_payment_invoices INT(11) DEFAULT 30;

	SELECT
		IFNULL(giorni_promemoria, 30)
	INTO 
		days_reminder_payment_invoices
	FROM Azienda
	ORDER BY id_azienda DESC
	LIMIT 1;

	UPDATE fattura f
	INNER JOIN vw_invoices_payments_details p ON p.id_fattura = f.id_fattura and p.anno = f.anno
	SET f.data_annullamento_promemoria = CURRENT_DATE,
		f.controllo_promemoria = 0
	WHERE p.anno <> 0 AND pagato = 0
		AND data_pagamento_prevista >=  CURRENT_DATE - INTERVAL 0 DAY 
		AND data_pagamento_prevista <= CURRENT_DATE + INTERVAL days_reminder_payment_invoices DAY
		AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_ultimo_promemoria OR data_ultimo_promemoria IS NULL)
		AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_annullamento_promemoria OR data_annullamento_promemoria IS NULL)
		AND controllo_promemoria = 1;		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicesReminderList
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicesReminderList`()
BEGIN

	DECLARE days_reminder_payment_invoices INT(11) DEFAULT 30;

	SELECT
		IFNULL(giorni_promemoria, 30)
	INTO 
		days_reminder_payment_invoices
	FROM Azienda
	ORDER BY id_azienda DESC
	LIMIT 1;

	SELECT f.controllo_promemoria,
		p.id_fattura,
		p.anno,
		p.id_cliente,
		p.ragione_sociale,
		p.data_fattura,
		p.data_pagamento_prevista,
		(importo_pagamento - totale_acconti) as importo_rata,
		p.condizione_pagamento,
		GROUP_CONCAT(rc.mail) AS email_fatturazione
	FROM vw_invoices_payments_details p
		INNER JOIN fattura f ON p.id_fattura = f.id_fattura and p.anno = f.anno
		INNER JOIN riferimento_clienti rc ON rc.id_cliente = p.id_cliente AND rc.Fatturazione = 1
	WHERE p.anno <> 0 AND pagato = 0
		AND data_pagamento_prevista >=  CURRENT_DATE - INTERVAL 0 DAY 
		AND data_pagamento_prevista <= CURRENT_DATE + INTERVAL days_reminder_payment_invoices DAY
		AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_ultimo_promemoria OR data_ultimo_promemoria IS NULL)
		AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_annullamento_promemoria OR data_annullamento_promemoria IS NULL)
	GROUP BY p.id_fattura, p.anno, p.data_pagamento_prevista;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicesReminderListTotals
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicesReminderListTotals`()
BEGIN

	DECLARE days_reminder_payment_invoices INT(11) DEFAULT 30;

	SELECT
		IFNULL(giorni_promemoria, 30)
	INTO 
		days_reminder_payment_invoices
	FROM Azienda
	ORDER BY id_azienda DESC
	LIMIT 1;

	
	SELECT SUM(importo_pagamento - totale_acconti) as totale_da_pagare,
		IFNULL(SUM(importo_pagamento - totale_acconti) * f.controllo_promemoria, 0) as totale_da_pagare_selezionato
	FROM vw_invoices_payments_details p
	INNER JOIN fattura f ON p.id_fattura = f.id_fattura and p.anno = f.anno
	WHERE p.anno <> 0 AND pagato = 0
		AND data_pagamento_prevista >=  CURRENT_DATE - INTERVAL 0 DAY 
		AND data_pagamento_prevista <= CURRENT_DATE + INTERVAL days_reminder_payment_invoices DAY
		AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_ultimo_promemoria OR data_ultimo_promemoria IS NULL)
		AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_annullamento_promemoria OR data_annullamento_promemoria IS NULL);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoicesReminderSelectedToSend
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoicesReminderSelectedToSend`()
BEGIN

	DECLARE days_reminder_payment_invoices INT(11) DEFAULT 30;

	SELECT
		IFNULL(giorni_promemoria, 30)
	INTO 
		days_reminder_payment_invoices
	FROM Azienda
	ORDER BY id_azienda DESC
	LIMIT 1;

	SELECT p.id_cliente,
		GROUP_CONCAT(rc.mail) AS email_fatturazione
	FROM vw_invoices_payments_details p
		INNER JOIN fattura f ON p.id_fattura = f.id_fattura and p.anno = f.anno
		INNER JOIN riferimento_clienti rc ON rc.id_cliente = p.id_cliente AND rc.Fatturazione = 1
	WHERE p.anno <> 0 AND pagato = 0
		AND data_pagamento_prevista >=  CURRENT_DATE - INTERVAL 0 DAY 
		AND data_pagamento_prevista <= CURRENT_DATE + INTERVAL days_reminder_payment_invoices DAY
		AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_ultimo_promemoria OR data_ultimo_promemoria IS NULL)
		AND (LAST_DAY(CURRENT_DATE - INTERVAL 1 MONTH) > data_annullamento_promemoria OR data_annullamento_promemoria IS NULL)
		AND controllo_promemoria = 1
	GROUP BY p.id_cliente;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceTagDeleteByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceTagDeleteByInvoice`( 
	IN invoice_id INT(11),
	IN invoice_year INT(11)
)
BEGIN

	DELETE FROM fattura_tag
	WHERE id_fattura = invoice_id
		AND anno_fattura = invoice_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceTagDeleteByTicket
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceTagDeleteByTicket`( 
	IN invoice_id INT(11),
	IN invoice_year INT(11)
)
BEGIN

	DELETE FROM fattura_tag
	WHERE id_fattura = invoice_id
		AND anno_fattura = invoice_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceTagGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceTagGetByInvoice`(
	IN invoice_id INT,
	IN invoice_year INT
)
BEGIN
	SELECT 
		`id_fattura`,
		anno_fattura,
		fattura_tag.id_tag,
		tag.tag
	FROM fattura_tag
		INNER JOIN tag ON tag.id_tag = fattura_tag.id_tag
	WHERE id_fattura = invoice_id
		AND anno_fattura = invoice_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceTypeGet
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceTypeGet`(
)
BEGIN
	SELECT
		`Id_tipo`,
		`Nome`,
		`Descrizione`,
		`tipo_PA`
	FROM tipo_fattura;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceTypeGetByEInvoiceType
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceTypeGetByEInvoiceType`(
	e_invoice_type VARCHAR(5)
)
BEGIN

	SELECT
		`Id_tipo`,
		`Nome`,
		`Descrizione`,
		`tipo_PA`
	FROM tipo_fattura
	WHERE tipo_PA = e_invoice_type;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceTypeGetById`(
	type_id INT(11)
)
BEGIN

	SELECT
		`Id_tipo`,
		`Nome`,
		`Descrizione`,
		`tipo_PA`
	FROM tipo_fattura
	WHERE id_tipo = type_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceUpdate`(
	IN enter_id INT(11),
	IN invoice_id INT(11), 
	IN invoice_year INT(11), 
	IN invoice_category INT(11),
	IN invoice_date DATE, 
	IN customer_id INT(11), 
	IN destination INT(11), 
	IN destination_id INT(11), 
	IN `registration_date` DATE,
	IN `edit_date` DATE,
	IN `payment_condition_id` INT(11),
	IN `bank_id` INT(11),
	IN `annotations` TEXT,
	IN `status_id` INT(11),
	IN `transport_casual_id` INT(11),
	IN `internal_note` VARCHAR(100),
	IN `iban` VARCHAR(45),
	IN `abi` VARCHAR(6),
	IN `cab` VARCHAR(6),
	IN `type_id` INT(11),
	IN `recessed_import` FLOAT(11,2),
	IN `stamp_import` FLOAT(11,2),
	IN `transport_import` FLOAT(11,2),
	IN `is_sent` INT(11),
	IN `sending_method` INT(11),
	IN `is_printed` TINYINT(1),
	IN `subcontract` TINYINT(4),
	IN `user_id` INT(11),
	IN `products_discount` VARCHAR(15),
	IN `vat_id` INT(11),
	IN `reminder_date` DATE,
	IN `reminder_check` TINYINt(1),
	IN `work_area` VARCHAR(45),
	IN `is_our` TINYINT(1),
	OUT result INT(11)
)
BEGIN

	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	
	START TRANSACTION; 
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesInvoiceUpdateDate
DELIMITER //
CREATE PROCEDURE `sp_ariesInvoiceUpdateDate`(
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11),
	IN `invoice_date` DATE,
	OUT result BIT(11)
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	
	START TRANSACTION;
	
	UPDATE fattura
	SET `Data` = invoice_date 
	WHERE id_fattura = invoice_id AND anno = invoice_year;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobDdtLinkDeleteByDdt
DELIMITER //
CREATE PROCEDURE `sp_ariesJobDdtLinkDeleteByDdt`(
	ddt_id INT, ddt_year INT
)
BEGIN
	DELETE FROM commessa_ddt
	WHERE id_ddt = ddt_id
		AND anno_ddt = ddt_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobDdtLinkGetByDdt
DELIMITER //
CREATE PROCEDURE `sp_ariesJobDdtLinkGetByDdt`(
	ddt_id INT, ddt_year INT
)
BEGIN
	SELECT 
		`Id_commessa`,
		`id_ddt`,
		`anno_commessa`,
		`anno_ddt`,
		`id_sottocommessa`,
		`id_lotto`
	FROM commessa_ddt
	WHERE id_ddt = ddt_id
		AND anno_ddt = ddt_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobDdtLinkInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesJobDdtLinkInsert`(
	ddt_id INT, ddt_year INT, job_id INT, job_year INT, sub_job_id INT, lot_id INT
)
BEGIN
	INSERT INTO commessa_ddt
	SET 
		`Id_commessa` = job_id,
		`id_ddt` = ddt_id,
		`anno_ddt` = ddt_year,
		`anno_commessa` = job_year,
		`id_sottocommessa` = sub_job_id,
		`id_lotto` = lot_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesJobDelete`(
	job_id INT, job_year INT
)
BEGIN
	DELETE FROM commessa_articolo_comp
	WHERE id_commessa = job_id AND anno = job_year;

	DELETE FROM commessa_fattura
	WHERE id_commessa = job_id AND anno_commessa = job_year;
	
	DELETE FROM commessa_rapporto
	WHERE id_commessa = job_id AND anno_commessa = job_year;
	
	DELETE FROM commessa_ddt
	WHERE id_commessa = job_id AND anno_commessa = job_year;
	
	DELETE FROM commessa_ddtr
	WHERE id_commessa = job_id AND anno_commessa = job_year;

	UPDATE preventivo p
		INNER JOIN commessa_preventivo cp
			ON p.id_preventivo = cp.preventivo AND p.anno = cp.anno_prev
				AND cp.id_commessa = job_id AND cp.anno = job_year
	SET stato = 1;
	
	DELETE FROM commessa_preventivo
	WHERE id_commessa = job_id AND anno = job_year;
	
	DELETE FROM commessa_riferimento
	WHERE id_commessa = job_id AND anno = job_year;
	
	DELETE FROM commessa_articoli
	WHERE id_commessa = job_id AND anno = job_year;
	
	DELETE FROM commessa_lotto
	WHERE id_commessa = job_id AND anno = job_year;
	
	DELETE FROM commessa_note
	WHERE id_commessa = job_id AND anno = job_year;
	
	DELETE FROM commessa_sotto
	WHERE id_commessa = job_id AND anno = job_year;
	
	DELETE FROM commessa_impostazioni
	WHERE id_commessa = job_id AND anno = job_year;
	
	DELETE FROM commessa
	WHERE id_commessa = job_id AND anno = job_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobGet
DELIMITER //
CREATE PROCEDURE `sp_ariesJobGet`()
BEGIN

	SELECT 
		Id,
		`Id_commessa`,
		`anno`,
		IFNULL(`id_cliente`, 0) 'Id_cliente',
		IFNULL(data_inizio, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_inizio',
		IFNULL(data_fine, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_fine',
		IFNULL(`stato_commessa`, 0) 'stato_commessa',
		IFNULL(`Descrizione`, '') Descrizione,
		IFNULL(`nr_appalto` , '') nr_appalto,
		IFNULL(`codice_commessa` , '') codice_commessa,
		IFNULL(data_scadenza, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_scadenza',
		IFNULL(`tipo_commessa`,0) 'tipo_commessa',
		IFNULL(`num_ordine` , '') num_ordine,
		`inv_com`,
		`stamp_com`,
		`Data_ins`,
		IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME)) 'Data_mod',
		`Utente_ins`,
		IFNULL(`Utente_mod`, 0) 'Utente_mod'
	FROM Commessa; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobGetByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesJobGetByIdAndYear`(
job_id INT(11),
job_year SMALLINT)
BEGIN

	SELECT 
		Id, 
		`Id_commessa`,
		`anno`,
		IFNULL(`id_cliente`, 0) 'Id_cliente',
		IFNULL(data_inizio, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_inizio',
		IFNULL(data_fine, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_fine',
		IFNULL(`stato_commessa`, 0) 'stato_commessa',
		IFNULL(`Descrizione`, '') Descrizione,
		IFNULL(`nr_appalto` , '') nr_appalto,
		IFNULL(`codice_commessa` , '') codice_commessa,
		IFNULL(data_scadenza, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_scadenza',
		IFNULL(`tipo_commessa`,0) 'tipo_commessa',
		IFNULL(`num_ordine` , '') num_ordine,
		`inv_com`,
		`stamp_com`,
		`Data_ins`,
		IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME)) 'Data_mod',
		`Utente_ins`,
		IFNULL(`Utente_mod`, 0) 'Utente_mod'
	FROM Commessa
	WHERE anno = job_year AND Id_commessa = job_id; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesJobGetByInvoice`(
invoice_id SMALLINT,
invoice_year SMALLINT)
BEGIN

	SELECT 
		Id, 
		commessa.Id_commessa,
		commessa.anno,
		IFNULL(`id_cliente`, 0) 'Id_cliente',
		IFNULL(data_inizio, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_inizio',
		IFNULL(data_fine, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_fine',
		IFNULL(`stato_commessa`, 0) 'stato_commessa',
		IFNULL(`Descrizione`, '') Descrizione,
		IFNULL(`nr_appalto` , '') nr_appalto,
		IFNULL(`codice_commessa` , '') codice_commessa,
		IFNULL(data_scadenza, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_scadenza',
		IFNULL(`tipo_commessa`,0) 'tipo_commessa',
		IFNULL(`num_ordine` , '') num_ordine,
		`inv_com`,
		`stamp_com`,
		`Data_ins`,
		IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME)) 'Data_mod',
		`Utente_ins`,
		IFNULL(`Utente_mod`, 0) 'Utente_mod'
	FROM Commessa
		INNER JOIN commessa_fattura ON commessa.id_commessa = commessa_fattura.id_commessa
			AND commessa.anno = commessa_fattura.anno_commessa
	WHERE id_fattura = invoice_id AND anno_fattura = invoice_year; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobGetByYear
DELIMITER //
CREATE PROCEDURE `sp_ariesJobGetByYear`(
job_year SMALLINT)
BEGIN

	SELECT 
		Id, 
		`Id_commessa`,
		`anno`,
		IFNULL(`id_cliente`, 0) 'Id_cliente',
		IFNULL(data_inizio, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_inizio',
		IFNULL(data_fine, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_fine',
		IFNULL(`stato_commessa`, 0) 'stato_commessa',
		IFNULL(`Descrizione`, '') Descrizione,
		IFNULL(`nr_appalto` , '') nr_appalto,
		IFNULL(`codice_commessa` , '') codice_commessa,
		IFNULL(data_scadenza, CAST("1970-01-01 00:00:00" AS DATETIME)) 'data_scadenza',
		IFNULL(`tipo_commessa`,0) 'tipo_commessa',
		IFNULL(`num_ordine` , '') num_ordine,
		`inv_com`,
		`stamp_com`,
		`Data_ins`,
		IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME)) 'Data_mod',
		`Utente_ins`,
		IFNULL(`Utente_mod`, 0) 'Utente_mod'
	FROM Commessa
	WHERE anno = job_year; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobInitSettings
DELIMITER //
CREATE PROCEDURE `sp_ariesJobInitSettings`(
	job_id INT, job_year INT
)
BEGIN
	INSERT IGNORE INTO commessa_impostazioni
	SELECT job_id,
		job_year,
		tipo,
		valore
	FROM commessa_impostazioni_default;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobInvoiceLinkDeleteByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesJobInvoiceLinkDeleteByInvoice`(
	enter_id INT, enter_year INT
)
BEGIN
	DELETE FROM commessa_fattura
	WHERE id_fattura = enter_id
		AND anno_fattura = enter_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobInvoiceLinkGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesJobInvoiceLinkGetByInvoice`(
	enter_id INT, enter_year INT
)
BEGIN
	SELECT 
		`Id_commessa`,
		`Id_fattura`,
		`anno_fattura`,
		`anno_commessa`,
		`id_sottocommessa`,
		`id_lotto`,
		`tipo`
	FROM commessa_fattura
	WHERE id_fattura = enter_id
		AND anno_fattura = enter_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobInvoiceLinkInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesJobInvoiceLinkInsert`(
	enter_id INT, enter_year INT, job_id INT, job_year INT, sub_job_id INT, lot_id INT, link_type INT
)
BEGIN
	INSERT INTO commessa_fattura
	SET 
		`Id_commessa` = job_id,
		`Id_fattura` = enter_id,
		`anno_fattura` = enter_year,
		`anno_commessa` = job_year,
		`id_sottocommessa` = sub_job_id,
		`id_lotto` = lot_id,
		`tipo` = link_type;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobLotDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesJobLotDelete`(
	job_id INT, job_year INT, 
	sub_job_id INT,  lot_id INT
)
BEGIN
	DELETE FROM commessa_fattura
	WHERE id_commessa = job_id
		AND anno_commessa = job_year
		AND id_sottocommessa = sub_job_id
		AND id_lotto = lot_id;
	
	DELETE FROM commessa_rapporto
	WHERE id_commessa = job_id
		AND anno_commessa = job_year
		AND id_sottocommessa = sub_job_id
		AND id_lotto = lot_id;
	
	DELETE FROM commessa_ddt
	WHERE id_commessa = job_id
		AND anno_commessa = job_year
		AND id_sottocommessa = sub_job_id
		AND id_lotto = lot_id;
	
	DELETE FROM commessa_ddtr
	WHERE id_commessa = job_id
		AND anno_commessa = job_year
		AND id_sottocommessa = sub_job_id
		AND id_lotto = lot_id;

	DELETE FROM commessa_preventivo
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_sottocommessa = sub_job_id
		AND lotto = lot_id;
	
	DELETE FROM commessa_articoli
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_sottocommessa = sub_job_id
		AND id_lotto = lot_id;

	
	DELETE FROM commessa_lotto
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_sottocommessa = sub_job_id
		AND id_lotto = lot_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobLotFindSingle
DELIMITER //
CREATE PROCEDURE `sp_ariesJobLotFindSingle`(
	IN job_id INT (11),
	IN job_year INT (11),
	IN lot_id INT (11),
	IN sub_job_id INT (11)
)
BEGIN
	SELECT `id_lotto`,
		`id_commessa`,
		`id_sottocommessa`,
		`anno`,
		`descrizione`,
		`impianto`,
		`numero`,
		`codice`,
		`data_inizio`,
		`data_fine`,
		`scadenza`,
		`stato`,
		`nota`,
		`csora`,
		`prora`,
		`sc`
	FROM commessa_lotto
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_lotto = lot_id
		AND id_sottocommessa = sub_job_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobProductDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesJobProductDelete`(
	IN job_id INT, 
	IN job_year SMALLINT, 
	IN lot_id INT,
	IN sub_job_id INT,
	IN tab_id INT
)
BEGIN

	DECLARE quoted_quantity DECIMAL(11,2);

	DECLARE EXIT HANDLER FOR SQLEXCEPTION
	BEGIN
		ROLLBACK;
		RESIGNAL;
	END;
		
	START TRANSACTION;
	
	SELECT preventivati INTO quoted_quantity
	FROM commessa_articoli
	WHERE Id_commessa = job_id
		AND Anno = job_year
		AND id_sottocommessa = sub_job_id
		AND id_lotto = lot_id
		AND id_tab = tab_id;
		
	DELETE FROM commessa_articolo_comp
	WHERE Id_commessa = job_id
		AND Anno = job_year
		AND id_sottocommessa = sub_job_id
		AND lotto = lot_id
		AND id_dettaglio = tab_id;

	IF (quoted_quantity IS NOT NULL) AND (quoted_quantity > 0) THEN
		UPDATE commessa_articoli
		SET quantità = 0
		WHERE Id_commessa = job_id
			AND Anno = job_year
			AND id_sottocommessa = sub_job_id
			AND id_lotto = lot_id
			AND id_tab = tab_id;
	ELSE
		DELETE FROM commessa_articoli
		WHERE Id_commessa = job_id
			AND Anno = job_year
			AND id_sottocommessa = sub_job_id
			AND id_lotto = lot_id
			AND id_tab = tab_id;
			
	END IF;
	
	COMMIT;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobProductGetByJob
DELIMITER //
CREATE PROCEDURE `sp_ariesJobProductGetByJob`(
	IN job_id INT, 
	IN job_year SMALLINT, 
	IN lot_id INT,
	IN sub_job_id INT
)
BEGIN
	SELECT 
		Id_commessa,
		Anno,
		Id_sottocommessa,
		Lotto,
		Posizionamento,
		Codice_articolo,
		Codice_fornitore,
		Descrizione,
		Qta_utilizzata,
		Qta_commessa,
		Qta_preventivati,
		UM,
		Prezzo,
		Costo,
		Prezzo_ora,
		Costo_ora,
		Sconto,
		Tempo_installazione,
		Qta_economia
	FROM vw_jobbody
	WHERE Id_commessa = job_id
		AND Anno = job_year
		AND id_sottocommessa = sub_job_id
		AND IF(lot_id = -1, True, lot_id = Lotto);
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobProductGetByJobAndRowId
DELIMITER //
CREATE PROCEDURE `sp_ariesJobProductGetByJobAndRowId`(
	IN job_id INT, 
	IN job_year SMALLINT, 
	IN lot_id INT,
	IN sub_job_id INT,
	IN row_id INT(11)
)
BEGIN

	SELECT 
		Id_commessa,
		Anno,
		Id_sottocommessa,
		Lotto,
		Posizionamento,
		Codice_articolo,
		Codice_fornitore,
		Descrizione,
		Qta_utilizzata,
		Qta_commessa,
		Qta_preventivati,
		UM,
		Prezzo,
		Costo,
		Prezzo_ora,
		Costo_ora,
		Sconto,
		Tempo_installazione,
		Qta_economia
	FROM vw_jobbody
	WHERE Id_commessa = job_id	AND Anno = job_year
		AND id_sottocommessa = sub_job_id AND Lotto = lot_id AND Posizionamento = row_id;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobProductGetByJobs
DELIMITER //
CREATE PROCEDURE `sp_ariesJobProductGetByJobs`(
	IN job_ids MEDIUMTEXT)
BEGIN

	
SET @s = CONCAT('
SELECT 
		Id_commessa,
		Anno,
		Id_sottocommessa,
		Lotto,
		Posizionamento,
		Codice_articolo,
		Codice_fornitore,
		Descrizione,
		Qta_utilizzata,
		Qta_commessa,
		Qta_preventivati,
		UM,
		Prezzo,
		Costo,
		Prezzo_ora,
		Costo_ora,
		Sconto,
		Tempo_installazione,
		Qta_economia
	FROM vw_jobbody
	WHERE ', job_ids, ' ORDER BY Anno , Id_commessa, Posizionamento;'); 

PREPARE stmt1 FROM @s; 
EXECUTE stmt1; 
DEALLOCATE PREPARE stmt1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobProductHistoryCreate
DELIMITER //
CREATE PROCEDURE `sp_ariesJobProductHistoryCreate`(
	IN job_id INT(11),
	IN job_year INT(11),
	IN subjob_id INT(11),
	IN lot_id INT(11),
	IN tab_id INT(11),
	IN operation VARCHAR(10)
)
BEGIN

	DECLARE user_id INT(11);
	SET user_id = @USER_ID;

	IF user_id IS NULL THEN
		SELECT id_utente
		INTO user_id
		FROM utente
		WHERE Nome = 'admin';
	END IF;

	INSERT INTO commessa_articoli_storico (
		`id_commessa`,
		`anno`,
		`id_sottocommessa`,
		`descrizione`,
		`quantità`,
		`codice_articolo`,
		`codice_fornitore`,
		`UM`,
		`id_tab`,
		`economia`,
		`id_lotto`,
		`prezzo`,
		`costo`,
		`costo_ora`,
		`tempo`,
		`sconto`,
		`prezzo_ora`,
		`preventivati`,
		`portati`,
		`Lunghezza`,
		`iva`,
		`id_utente`,
		`operazione`,
		`timestamp`
	) SELECT `id_commessa`,
		`anno`,
		`id_sottocommessa`,
		`descrizione`,
		`quantità`,
		`codice_articolo`,
		`codice_fornitore`,
		`UM`,
		`id_tab`,
		`economia`,
		`id_lotto`,
		`prezzo`,
		`costo`,
		`costo_ora`,
		`tempo`,
		`sconto`,
		`prezzo_ora`,
		`preventivati`,
		`portati`,
		`Lunghezza`,
		`iva`,
		operation,
		user_id,
		NOW()
	FROM commessa_articoli
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_sottocommessa = subjob_id
		AND id_lotto = lot_id
		AND id_tab = tab_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobProductInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesJobProductInsert`(
	IN job_id INT, 
	IN job_year SMALLINT, 
	IN sub_job_id INT,
	IN lot_id INT,
	IN row_id INT(11), 
	IN product_code VARCHAR(16), 
	IN supplier_product_code VARCHAR(45), 
	IN description TEXT,
	IN measure_unit VARCHAR(5), 
	IN quantity DECIMAL(11,2), 
	IN price DECIMAL(11,2), 
	IN cost DECIMAL(11,2), 
	IN hourly_price DECIMAL(11,2), 
	IN hourly_cost DECIMAL(11,2), 
	IN installation_time INT(11), 
	IN discount INT(11), 
	IN quote_quantity DECIMAL(11,2), 
	OUT result SMALLINT
)
BEGIN


	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;

	IF (row_id = -1) OR (row_id = 999) OR (row_id IS NULL) THEN

	  SELECT MAX(id_tab) + 1
	  	INTO
		  row_id
	  FROM commessa_articoli
	  WHERE Id_commessa = job_id AND Anno = job_year AND id_lotto = lot_id; 

	END IF;

	INSERT INTO commessa_articoli
	SET 
		descrizione = description,
		quantità = quantity,
		codice_articolo = product_code,
		codice_fornitore = supplier_product_code,
		UM = measure_unit,
		prezzo = price,
		costo = cost,
		costo_ora = hourly_cost,
		tempo = installation_time,
		sconto = discount,
		prezzo_ora = hourly_price,
		preventivati = quote_quantity,
		Id_commessa = job_id, 
		Anno = job_year,
		id_lotto = lot_id,
		id_sottocommessa = sub_job_id,
		Id_tab = row_id;

	
	SET Result = 1;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobProductUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesJobProductUpdate`(
	IN job_id INT, 
	IN job_year SMALLINT, 
	IN sub_job_id INT,
	IN lot_id INT, 
	IN row_id INT(11), 
	IN product_code VARCHAR(16), 
	IN supplier_product_code VARCHAR(45), 
	IN description TEXT,
	IN measure_unit VARCHAR(5), 
	IN quantity DECIMAL(11,2), 
	IN price DECIMAL(11,2), 
	IN cost DECIMAL(11,2), 
	IN hourly_price DECIMAL(11,2), 
	IN hourly_cost DECIMAL(11,2), 
	IN installation_time INT(11), 
	IN discount INT(11), 
	IN quote_quantity DECIMAL(11,2), 
	OUT result SMALLINT
)
BEGIN

	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;

	UPDATE commessa_articoli
	SET 
		descrizione = description,
		quantità = quantity,
		codice_articolo = product_code,
		codice_fornitore = supplier_product_code,
		UM = measure_unit,
		prezzo = price,
		costo = cost,
		costo_ora = hourly_cost,
		tempo = installation_time,
		sconto = discount,
		prezzo_ora = hourly_price,
		preventivati = quote_quantity
	WHERE Id_commessa = job_id	AND Anno = job_year AND
		Id_sottocommessa = sub_job_id AND id_lotto = lot_id AND Id_tab = row_id;

	
	SET Result = 1;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobReportLinkDeleteByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesJobReportLinkDeleteByReport`(
	report_id INT, report_year INT
)
BEGIN
	DELETE FROM commessa_rapporto
	WHERE id_rapporto = report_id
		AND anno_rapporto = report_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobReportLinkGetByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesJobReportLinkGetByReport`(
	report_id INT, report_year INT
)
BEGIN
	SELECT 
		`Id_commessa`,
		`id_rapporto`,
		`anno_commessa`,
		`anno_rapporto`,
		`id_sottocommessa`,
		`id_lotto`
	FROM commessa_rapporto
	WHERE id_rapporto = report_id
		AND anno_rapporto = report_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobReportLinkInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesJobReportLinkInsert`(
	report_id INT, report_year INT, job_id INT, job_year INT, sub_job_id INT, lot_id INT
)
BEGIN
	INSERT INTO commessa_rapporto
	SET 
		`Id_commessa` = job_id,
		`id_rapporto` = report_id,
		`anno_rapporto` = report_year,
		`anno_commessa` = job_year,
		`id_sottocommessa` = sub_job_id,
		`id_lotto` = lot_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobScaleDdt
DELIMITER //
CREATE PROCEDURE `sp_ariesJobScaleDdt`(
	job_id INT, job_year INT, sub_job_id INT,
	lot_id INT, ddt_id INT, ddt_year INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_id_tab INT;
	DECLARE V_curA CURSOR FOR SELECT numero_tab
		FROM articoli_ddt
		WHERE id_ddt = ddt_id AND anno = ddt_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
	
	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO V_id_tab;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		CALL sp_ariesJobScaleDdtProduct(job_id, job_year, sub_job_id, lot_id, ddt_id, ddt_year, V_id_tab);
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobScaleDdtProduct
DELIMITER //
CREATE PROCEDURE `sp_ariesJobScaleDdtProduct`(
	job_id INT, job_year INT, sub_job_id INT,
	lot_id INT, ddt_id INT, ddt_year INT, tab_id INT
)
BEGIN
	DECLARE has_product INT(11);
	DECLARE product_description TEXT;
	DECLARE quantity DECIMAL(11, 2);
	DECLARE quantity_economy DECIMAL(11, 2);
	DECLARE price DECIMAL(11, 2);
	DECLARE cost DECIMAL(11, 2);
	DECLARE discount DECIMAL(11, 2);
	DECLARE hour_price DECIMAL(11, 2);
	DECLARE hour_cost DECIMAL(11, 2);
	DECLARE product_code VARCHAR(16);
	DECLARE supplier_product_code VARCHAR(40);
	DECLARE iva_value INT(11);
	DECLARE inst_time INT(11);
	DECLARE product_tab_id INT(11);
	DECLARE prod_length INT(11);
	DECLARE measure_unit VARCHAR(5);
	

	SELECT quantità - IFNULL(economia, 0),
		economia,
		Id_articolo,
		codice_fornitore,
		Desc_breve,
		prezzo,
		costo,
		sconto,
		Unità_misura
	INTO quantity,
		quantity_economy,
		product_code,
		supplier_product_code,
		product_description,
		price,
		cost,
		discount,
		measure_unit
	FROM articoli_ddt
	WHERE id_ddt = ddt_id
		AND anno = ddt_year
		AND numero_tab = tab_id;
		
	IF product_code IS NOT NULL THEN
	
		SELECT id_tab, IFNULL(COUNT(id_commessa), 0)
			INTO product_tab_id, has_product
		FROM commessa_articoli 
		WHERE id_commessa = job_id
			AND anno = job_year
			AND id_sottocommessa = sub_job_id
			AND id_lotto = lot_id
			AND codice_articolo = product_code
			AND prezzo = price;

		IF product_tab_id IS NULL
		THEN
			SELECT id_tab, IFNULL(COUNT(id_commessa), 0)
				INTO product_tab_id, has_product
			FROM commessa_articoli 
			WHERE id_commessa = job_id
				AND anno = job_year
				AND id_sottocommessa = sub_job_id
				AND id_lotto = lot_id
				AND codice_articolo = product_code
			LIMIT 1;
		END IF;
			
		IF has_product > 0 then
			UPDATE commessa_articoli
			SET portati = portati + IFNULL(quantity, 0),
				economia = economia + IFNULL(quantity_economy, 0)
			WHERE id_commessa = job_id
				AND anno = job_year
				AND id_sottocommessa = sub_job_id
				AND id_lotto = lot_id
				AND id_tab = product_tab_id;
		ELSE
			SELECT fnc_jobGetVatValueByJob(job_id, job_year, sub_job_id, lot_id) INTO iva_value;
			SELECT fnc_jobGetNextIdTab(job_id, job_year, sub_job_id, lot_id) INTO product_tab_id;
			SELECT fnc_jobGetCostHourByJob(job_id, job_year, sub_job_id, lot_id) INTO hour_cost;
			SELECT fnc_jobGetPriceHourByJob(job_id, job_year, sub_job_id, lot_id) INTO hour_price;

			SELECT 
				tempo_installazione,
				l
			INTO
				inst_time,
				prod_length 
			FROM articolo
			WHERE codice_articolo = product_code;
			
			INSERT INTO commessa_articoli
			SET `id_commessa` = job_id,
				`anno` = job_year,
				`id_sottocommessa` = sub_job_id,
				`descrizione` = product_description,
				`quantità` = quantity,
				`codice_articolo` = product_code,
				`codice_fornitore` = supplier_product_code,
				`UM` = measure_unit,
				`id_tab` = product_tab_id,
				`economia` = IFNULL(quantity_economy, 0),
				`id_lotto` = lot_id,
				`prezzo` = price,
				`costo` = cost,
				`costo_ora` = hour_cost,
				`tempo` = inst_time,
				`sconto` = discount,
				`prezzo_ora` = hour_price,
				`preventivati` = 0,
				`portati` = quantity,
				`Lunghezza` = prod_length,
				`iva` = iva_value;
		END IF;
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobScaleReport
DELIMITER //
CREATE PROCEDURE `sp_ariesJobScaleReport`(
	job_id INT, job_year INT, sub_job_id INT,
	lot_id INT, report_id INT, report_year INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_id_tab INT;
	DECLARE V_curA CURSOR FOR SELECT Id_tab
		FROM rapporto_materiale
		WHERE id_rapporto = report_id AND anno = report_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
	
	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO V_id_tab;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		CALL sp_ariesJobScaleReportProduct(job_id, job_year, sub_job_id, lot_id, report_id, report_year, V_id_tab);
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobScaleReportProduct
DELIMITER //
CREATE PROCEDURE `sp_ariesJobScaleReportProduct`(
	job_id INT, job_year INT, sub_job_id INT,
	lot_id INT, report_id INT, report_year INT, tab_id INT
)
BEGIN
	DECLARE should_scale TINYINT;
	DECLARE has_ddt_link INT(11);
	DECLARE has_product INT(11);
	DECLARE product_description TEXT;
	DECLARE quantity DECIMAL(11, 2);
	DECLARE quantity_economy DECIMAL(11, 2);
	DECLARE price DECIMAL(11, 2);
	DECLARE cost DECIMAL(11, 2);
	DECLARE discount DECIMAL(11, 2);
	DECLARE hour_price DECIMAL(11, 2);
	DECLARE hour_cost DECIMAL(11, 2);
	DECLARE product_code VARCHAR(16);
	DECLARE supplier_product_code VARCHAR(40);
	DECLARE iva_value INT(11);
	DECLARE inst_time INT(11);
	DECLARE product_tab_id INT(11);
	DECLARE prod_length INT(11);
	DECLARE measure_unit VARCHAR(5);

	SELECT fnc_jobscaleproductsfromreports(job_id, job_year)
		INTO should_scale;

	SELECT COUNT(id_ddt)
		INTO  has_ddt_link
	FROM ddt_rapporto
	WHERE id_rapporto = report_id AND anno_rapporto = report_year;
	
	IF should_scale = 1 AND has_ddt_link = 0  THEN
		SELECT quantità - IFNULL(qeconomia, 0),
			qeconomia,
			Id_materiale,
			descrizione,
			prezzo,
			costo,
			sconto,
			unita_misura
		INTO quantity,
			quantity_economy,
			product_code,
			product_description,
			price,
			cost,
			discount,
			measure_unit
		FROM rapporto_materiale
		WHERE id_rapporto = report_id
			AND anno = report_year
			AND id_tab = tab_id;
			
		IF product_code IS NOT NULL THEN

			SELECT id_tab, IFNULL(COUNT(id_commessa), 0)
				INTO product_tab_id, has_product
			FROM commessa_articoli 
			WHERE id_commessa = job_id
				AND anno = job_year
				AND id_sottocommessa = sub_job_id
				AND id_lotto = lot_id
				AND codice_articolo = product_code
				AND prezzo = price;

			IF product_tab_id IS NULL
			THEN
				SELECT id_tab, IFNULL(COUNT(id_commessa), 0)
					INTO product_tab_id, has_product
				FROM commessa_articoli 
				WHERE id_commessa = job_id
					AND anno = job_year
					AND id_sottocommessa = sub_job_id
					AND id_lotto = lot_id
					AND codice_articolo = product_code
				LIMIT 1;
			END IF;
				
			IF has_product > 0 then
				UPDATE commessa_articoli
				SET portati = portati + IFNULL(quantity, 0),
					economia = economia + IFNULL(quantity_economy, 0)
				WHERE id_commessa = job_id
					AND anno = job_year
					AND id_sottocommessa = sub_job_id
					AND id_lotto = lot_id
					AND id_tab = product_tab_id;
			ELSE
				SELECT fnc_jobGetVatValueByJob(job_id, job_year, sub_job_id, lot_id) INTO iva_value;
				SELECT fnc_jobGetNextIdTab(job_id, job_year, sub_job_id, lot_id) INTO product_tab_id;
				SELECT fnc_jobGetCostHourByJob(job_id, job_year, sub_job_id, lot_id) INTO hour_cost;
				SELECT fnc_jobGetPriceHourByJob(job_id, job_year, sub_job_id, lot_id) INTO hour_price;

				SELECT codice_fornitore,
					tempo_installazione,
					l
				INTO supplier_product_code,
					inst_time,
					prod_length 
				FROM articolo
				WHERE codice_articolo = product_code;
				
				INSERT INTO commessa_articoli
				SET `id_commessa` = job_id,
					`anno` = job_year,
					`id_sottocommessa` = sub_job_id,
					`descrizione` = product_description,
					`quantità` = quantity,
					`codice_articolo` = product_code,
					`codice_fornitore` = supplier_product_code,
					`UM` = measure_unit,
					`id_tab` = product_tab_id,
					`economia` =  IFNULL(quantity_economy, 0),
					`id_lotto` = lot_id,
					`prezzo` = price,
					`costo` = cost,
					`costo_ora` = hour_cost,
					`tempo` = inst_time,
					`sconto` = discount,
					`prezzo_ora` = hour_price,
					`preventivati` = 0,
					`portati` = quantity,
					`Lunghezza` = prod_length,
					`iva` = iva_value;
			END IF;
		END IF;
			
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobSettingsGet
DELIMITER //
CREATE PROCEDURE `sp_ariesJobSettingsGet`()
BEGIN

	SELECT 
		tipo, 
		valore
	FROM commessa_impostazioni_default; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobSpecificSettingsGet
DELIMITER //
CREATE PROCEDURE `sp_ariesJobSpecificSettingsGet`()
BEGIN

	SELECT 
		Id_commessa,
		anno,
		tipo, 
		valore
	FROM commessa_impostazioni; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobSpecificSettingsGetBy
DELIMITER //
CREATE PROCEDURE `sp_ariesJobSpecificSettingsGetBy`(
	IN `job_id` INT(11),
	IN `job_year` INT(11), 
	IN `name` VARCHAR(30)
	)
BEGIN
	IF name IS NULL THEN
		SELECT 
			Id_commessa,
			anno,
			tipo, 
			valore
		FROM commessa_impostazioni
		WHERE id_commessa = job_id AND anno = job_year; 
	
	ELSE
		SELECT 
			Id_commessa,
			anno,
			tipo, 
			valore
		FROM commessa_impostazioni
		WHERE id_commessa = job_id AND anno = job_year AND Tipo = name; 
	END IF; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobUndoScaleDdt
DELIMITER //
CREATE PROCEDURE `sp_ariesJobUndoScaleDdt`(
	job_id INT, job_year INT, sub_job_id INT,
	lot_id INT, ddt_id INT, ddt_year INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_id_tab INT;
	DECLARE V_curA CURSOR FOR SELECT numero_tab
		FROM articoli_ddt
		WHERE id_ddt = ddt_id AND anno = ddt_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
	
	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO V_id_tab;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		CALL sp_ariesJobUndoScaleDdtProduct(job_id, job_year, sub_job_id, lot_id, ddt_id, ddt_year, V_id_tab);
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobUndoScaleDdtProduct
DELIMITER //
CREATE PROCEDURE `sp_ariesJobUndoScaleDdtProduct`(
	job_id INT, job_year INT, sub_job_id INT,
	lot_id INT, ddt_id INT, ddt_year INT, tab_id INT
)
BEGIN
	DECLARE has_product INT(11);
	DECLARE quantity DECIMAL(11, 2);
	DECLARE quantity_economy DECIMAL(11, 2);
	DECLARE price DECIMAL(11, 2);
	DECLARE product_code VARCHAR(16);
	DECLARE product_tab_id INT(11);
	

	SELECT quantità  - IFNULL(economia, 0),
		economia,
		Id_articolo,
		prezzo
	INTO quantity,
		quantity_economy,
		product_code,
		price
	FROM articoli_ddt
	WHERE id_ddt = ddt_id
		AND anno = ddt_year
		AND numero_tab = tab_id;
		
	IF product_code IS NOT NULL THEN
	
		SELECT id_tab, IFNULL(COUNT(id_commessa), 0)
			INTO product_tab_id, has_product
		FROM commessa_articoli 
		WHERE id_commessa = job_id
			AND anno = job_year
			AND id_sottocommessa = sub_job_id
			AND id_lotto = lot_id
			AND codice_articolo = product_code
			AND prezzo = price;

		IF product_tab_id IS NULL
		THEN
			SELECT id_tab, IFNULL(COUNT(id_commessa), 0)
				INTO product_tab_id, has_product
			FROM commessa_articoli 
			WHERE id_commessa = job_id
				AND anno = job_year
				AND id_sottocommessa = sub_job_id
				AND id_lotto = lot_id
				AND codice_articolo = product_code
			LIMIT 1;
		END IF;
			
		IF has_product > 0 then
			UPDATE commessa_articoli
			SET portati = portati - IFNULL(quantity, 0),
				economia = economia - IFNULL(quantity_economy, 0)
			WHERE id_commessa = job_id
				AND anno = job_year
				AND id_sottocommessa = sub_job_id
				AND id_lotto = lot_id
				AND id_tab = product_tab_id;
		END IF;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobUndoScaleReport
DELIMITER //
CREATE PROCEDURE `sp_ariesJobUndoScaleReport`(
	job_id INT, job_year INT, sub_job_id INT,
	lot_id INT, report_id INT, report_year INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_id_tab INT;
	DECLARE V_curA CURSOR FOR SELECT Id_tab
		FROM rapporto_materiale
		WHERE id_rapporto = report_id AND anno = report_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
	
	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO V_id_tab;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		CALL sp_ariesJobUndoScaleReportProduct(job_id, job_year, sub_job_id, lot_id, report_id, report_year, V_id_tab);
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobUndoScaleReportProduct
DELIMITER //
CREATE PROCEDURE `sp_ariesJobUndoScaleReportProduct`(
	job_id INT, job_year INT, sub_job_id INT,
	lot_id INT, report_id INT, report_year INT, tab_id INT
)
BEGIN
	DECLARE has_product INT(11);
	DECLARE has_ddt_link INT(11);
	DECLARE quantity DECIMAL(11, 2);
	DECLARE quantity_economy DECIMAL(11, 2);
	DECLARE price DECIMAL(11, 2);
	DECLARE product_code VARCHAR(16);
	DECLARE product_tab_id INT(11);

	
	SELECT COUNT(id_ddt)
		INTO  has_ddt_link
	FROM ddt_rapporto
	WHERE id_rapporto = report_id AND anno_rapporto = report_year;
	
	IF has_ddt_link = 0 THEN
		SELECT quantità - IFNULL(qeconomia, 0),
			qeconomia,
			Id_materiale,
			prezzo
		INTO quantity,
			quantity_economy,
			product_code,
			price
		FROM rapporto_materiale
		WHERE id_rapporto = report_id
			AND anno = report_year
			AND id_tab = tab_id;
			
		IF product_code IS NOT NULL THEN

			SELECT id_tab, IFNULL(COUNT(id_commessa), 0)
				INTO product_tab_id, has_product
			FROM commessa_articoli 
			WHERE id_commessa = job_id
				AND anno = job_year
				AND id_sottocommessa = sub_job_id
				AND id_lotto = lot_id
				AND codice_articolo = product_code
				AND prezzo = price;

			IF product_tab_id IS NULL
			THEN
				SELECT id_tab, IFNULL(COUNT(id_commessa), 0)
					INTO product_tab_id, has_product
				FROM commessa_articoli 
				WHERE id_commessa = job_id
					AND anno = job_year
					AND id_sottocommessa = sub_job_id
					AND id_lotto = lot_id
					AND codice_articolo = product_code
				LIMIT 1;
			END IF;
				
			IF has_product > 0 then
				UPDATE commessa_articoli
				SET portati = portati - IFNULL(quantity, 0),
					economia = economia - IFNULL(quantity_economy, 0)
				WHERE id_commessa = job_id
					AND anno = job_year
					AND id_sottocommessa = sub_job_id
					AND id_lotto = lot_id
					AND id_tab = product_tab_id;
			END IF;
		END IF;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesJobUnionLots
DELIMITER //
CREATE PROCEDURE `sp_ariesJobUnionLots`(
	IN `job_id` INT(11),
	IN `job_year` INT(11),
	IN `sub_job_id` INT(11),
	IN `job_lot_destination` INT(11),
	IN `job_lot_source` INT(11),
	OUT result SMALLINT
)
BEGIN

  DECLARE `_rollback` BOOL DEFAULT 0;
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
  
  SET result = 1; 
  
  START TRANSACTION; 
  
  DROP TABLE IF EXISTS  temp_jobs_products_for_union; 
  
  CREATE TEMPORARY TABLE temp_jobs_products_for_union (
	  	`id` INT(11) NOT NULL AUTO_INCREMENT PRIMARY KEY,
	  	`id_commessa` INT(11) NOT NULL,
	  	`id_sottocommessa` INT(11) NOT NULL,
		`anno` INT(11) NOT NULL,
		`descrizione` TEXT NULL,
		`quantità` DECIMAL(11,2) NULL DEFAULT NULL,
		`codice_articolo` VARCHAR(16) NULL DEFAULT NULL,
		`codice_fornitore` VARCHAR(40) NULL DEFAULT NULL,
		`UM` VARCHAR(5) NULL DEFAULT NULL,
		`id_tab` INT(11) NOT NULL,
		`economia` DECIMAL(11,2) NULL DEFAULT NULL,
		`id_lotto` INT(11) NOT NULL DEFAULT '0',
		`prezzo` DECIMAL(11,2) NULL DEFAULT '0.00',
		`costo` DECIMAL(11,2) NULL DEFAULT '0.00',
		`costo_ora` DECIMAL(11,2) NULL DEFAULT '0.00',
		`tempo` INT(11) NULL DEFAULT '0',
		`sconto` DECIMAL(11,2) NULL DEFAULT '0.00',
		`prezzo_ora` DECIMAL(11,2) NULL DEFAULT '0.00',
		`preventivati` DECIMAL(11,2) NULL DEFAULT '0.00',
		`Lunghezza` INT(11) NULL DEFAULT NULL,
		`iva` INT(11) NULL DEFAULT NULL
	);
	
	INSERT INTO temp_jobs_products_for_union
	   (`id_commessa`, `anno`, id_sottocommessa, `descrizione`, `quantità`, `codice_articolo`, `codice_fornitore`, `UM`, `id_tab`, `economia`, `id_lotto`,
		`prezzo`, `costo`, `costo_ora`, `tempo`, `sconto`, `prezzo_ora`, `preventivati`, `Lunghezza`, `iva`)
		
	SELECT `id_commessa`, `anno`, id_sottocommessa, `descrizione`, SUM(`quantità`), `codice_articolo`, `codice_fornitore`, `UM`, `id_tab`, `economia`, `id_lotto`,
		`prezzo`, `costo`, `costo_ora`, `tempo`, `sconto`, `prezzo_ora`, SUM(`preventivati`), `Lunghezza`, `iva`
	FROM (
		-- EXTRACT ALL ARTICLE FROM DESTINATION
		SELECT `id_commessa`, `anno`, id_sottocommessa, `descrizione`, `quantità`, `codice_articolo`, `codice_fornitore`, `UM`, `id_tab`, `economia`, `id_lotto`,
			`prezzo`, `costo`, `costo_ora`, `tempo`, `sconto`, `prezzo_ora`, `preventivati`, `Lunghezza`, `iva`
		FROM commessa_articoli 
		WHERE id_commessa = job_id 
			AND id_sottocommessa = sub_job_id
			AND anno = job_year 
			AND id_lotto = job_lot_destination
		
		UNION ALL
		
		-- EXTRACT ALL ARTICLE FROM SOURCE 
		SELECT `id_commessa`, `anno`, id_sottocommessa, `descrizione`, `quantità`, `codice_articolo`, `codice_fornitore`, `UM`, `id_tab`, `economia`, `id_lotto`,
			`prezzo`, `costo`, `costo_ora`, `tempo`, `sconto`, `prezzo_ora`, `preventivati`, `Lunghezza`, `iva`
		FROM commessa_articoli 
		WHERE id_commessa = job_id 
			AND anno = job_year
			AND id_sottocommessa = sub_job_id
			AND id_lotto = job_lot_source	
	) AS under_query
	GROUP BY CONCAT(IFNULL(codice_articolo, "NOTA"),"-", prezzo, "-", costo, "-", sconto) 
	ORDER BY FIELD(id_lotto, job_lot_source) ASC, id_tab ASC;
	
	
	DELETE FROM commessa_articoli 
	WHERE id_commessa = job_id 
		AND anno = job_year 
		AND id_sottocommessa = sub_job_id
		AND id_lotto IN (job_lot_source, job_lot_destination); 
		
	INSERT INTO commessa_articoli
		   (`id_commessa`, `anno`, id_sottocommessa, `descrizione`, `quantità`, `codice_articolo`, `codice_fornitore`, `UM`, `id_tab`, `economia`, `id_lotto`,
		`prezzo`, `costo`, `costo_ora`, `tempo`, `sconto`, `prezzo_ora`, `preventivati`, `Lunghezza`, `iva`)
	SELECT 
		`id_commessa`, `anno`, id_sottocommessa, `descrizione`, `quantità`, `codice_articolo`, `codice_fornitore`, `UM`, `id`, `economia`, job_lot_destination,
		`prezzo`, `costo`, `costo_ora`, `tempo`, `sconto`, `prezzo_ora`, `preventivati`, `Lunghezza`, `iva`
	FROM temp_jobs_products_for_union; 


	UPDATE commessa_ddt 
	SET id_lotto = job_lot_destination
	WHERE id_commessa = job_id 
		AND anno_commessa = job_year 
		AND id_lotto = job_lot_source;
	
	UPDATE commessa_fattura 
	SET id_lotto = job_lot_destination
	WHERE id_commessa = job_id 
		AND anno_commessa = job_year 
		AND id_lotto = job_lot_source; 
	
	UPDATE commessa_rapporto 
	SET id_lotto = job_lot_destination
	WHERE id_commessa = job_id 
		AND anno_commessa = job_year 
		AND id_lotto = job_lot_source; 
		
	UPDATE ordine_dettaglio 
	SET com_lotto = job_lot_destination
	WHERE id_commessa = job_id 
		AND anno_commessa = job_year 
		AND com_lotto = job_lot_source; 
	
	UPDATE commessa_preventivo 
	SET lotto = job_lot_destination
	WHERE id_commessa = job_id 
		AND anno = job_year 
		AND lotto = job_lot_source; 
	
	UPDATE commessa_ddtr 
	SET id_lotto = job_lot_destination
	WHERE id_commessa = job_id 
		AND anno_commessa = job_year 
		AND id_lotto = job_lot_source; 
	
	DELETE FROM commessa_lotto 
	WHERE id_commessa = job_id 
		AND anno = job_year 
		AND id_lotto = job_lot_source; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesLogoConfigurationGet
DELIMITER //
CREATE PROCEDURE `sp_ariesLogoConfigurationGet`(
)
BEGIN

	SELECT nome, 
		attivo, 
		tipo
	FROM configurazione_loghi; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesLogoConfigurationGetByNameAndType
DELIMITER //
CREATE PROCEDURE `sp_ariesLogoConfigurationGetByNameAndType`(
	name VARCHAR(30), 
	logo_type VARCHAR(45)
)
BEGIN

	SELECT nome, 
		attivo, 
		tipo
	FROM configurazione_loghi
	WHERE nome = name AND tipo = logo_type; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesMunicipalityDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesMunicipalityDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM Comune 
	WHERE id_comune = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesMunicipalityGet
DELIMITER //
CREATE PROCEDURE `sp_ariesMunicipalityGet`( 
)
BEGIN
	SELECT Id_comune,
	Nome,
	Provincia, 
	Cap, 
	Id_Provincia,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Comune
	ORDER BY Id_comune;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesMunicipalityGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesMunicipalityGetById`( 
	municipality_id INT
)
BEGIN
	SELECT Id_comune,
	Nome,
	Provincia, 
	Cap, 
	Id_Provincia,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Comune
	WHERE Id_Comune = municipality_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesMunicipalityGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesMunicipalityGetByName`( 
	IN `name` VARCHAR(100)
)
BEGIN
	SELECT Id_comune,
	Nome,
	Provincia, 
	Cap, 
	Id_Provincia,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Comune
	WHERE nome = `name`;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesMunicipalityGetByPostalCode
DELIMITER //
CREATE PROCEDURE `sp_ariesMunicipalityGetByPostalCode`( 
	postal_code VARCHAR(30)
)
BEGIN
	SELECT Id_comune,
	Nome,
	Provincia, 
	Cap, 
	Id_Provincia,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Comune
	WHERE Cap = postal_code;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesMunicipalityInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesMunicipalityInsert`( 
	name VARCHAR(30),
	province varchar(15),
	postal_code varchar(10),
	province_id INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Province 
	WHERE sigla = province AND id_provincia = province_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM Comune 
		WHERE Nome = Name AND Cap = postal_code; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Municipality name & postal code already exists
		END IF;
	ELSE
		SET Result = -2; # province not found
	END IF;
	
	IF Result = 0 THEN
		INSERT INTO Comune 
		SET 
			Nome = name,
			Provincia = province , 
			Cap = postal_code, 
			Id_Provincia = province_id,
			Data_ins = NOW(),  
			Data_mod = NOW(),
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesMunicipalityUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesMunicipalityUpdate`( 
	enter_id INTEGER,
	name VARCHAR(30),
	province varchar(15),
	postal_code varchar(10),
	province_id INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Province 
	WHERE sigla = province AND id_provincia = province_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM Comune 
		WHERE Nome = Name AND Cap = postal_code AND id_comune != enter_id;
		
		IF Result > 0 THEN
			 SET Result = -1; # Municipality name & postal code already exists
		END IF;
	ELSE
		SET Result = -2; # province not found
	END IF;
	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM Comune 
			WHERE id_comune = enter_id;
			
			IF Result = 0 THEN
				SET Result = -3; # Municipality ID not found							
			END IF; 
	END IF; 
	
	IF Result >0 THEN
		UPDATE Comune 
		SET 
			Nome = name,
			Provincia = province , 
			Cap = postal_code, 
			Id_Provincia = province_id,
			Utente_mod = @USER_ID
		Where id_comune = enter_id;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesNoteGet
DELIMITER //
CREATE PROCEDURE `sp_ariesNoteGet`(
)
BEGIN

	SELECT 
	`id_nota`,
	`Nome`,
	`note`,
	`prezz`,
	`cost`,
	`temp`,
	`nota_stato`,
	`Data_mod`
	FROM Nota
	ORDER BY Id_nota; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesNoteGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesNoteGetById`(
	note_id INT(11)
)
BEGIN

	SELECT 
	`id_nota`,
	`Nome`,
	`note`,
	`prezz`,
	`cost`,
	`temp`,
	`nota_stato`,
	`Data_mod`
	FROM Nota
	WHERE Id_nota = note_id; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesOrderSupplierMarkAsComplete
DELIMITER //
CREATE PROCEDURE `sp_ariesOrderSupplierMarkAsComplete`( 
	enter_id INT, 
	enter_year INT
)
BEGIN
	DECLARE previous_status INT(11);

	SELECT stato INTO previous_status
	FROM ordine_fornitore
	WHERE id_ordine = enter_id AND Anno = enter_year; 

	IF previous_status = 3 OR previous_status = 1 THEN
		UPDATE ordine_fornitore
		SET segna_come_evaso = 1,
			utente_evasione = @USER_ID,
			stato_pre_evasione = previous_status,
			stato = 4
		WHERE id_ordine = enter_id AND Anno = enter_year; 
	END IF;	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesOrderSupplierRowDeleteByOrderSupplier
DELIMITER //
CREATE PROCEDURE `sp_ariesOrderSupplierRowDeleteByOrderSupplier`( 
	enter_id INT, 
	enter_year INT
)
BEGIN
        
	DELETE FROM ordine_dettaglio
	WHERE id_ordine = enter_id AND Anno = enter_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesOrderSupplierRowGetByOrderSupplier
DELIMITER //
CREATE PROCEDURE `sp_ariesOrderSupplierRowGetByOrderSupplier`( 
	enter_id INT, 
	enter_year INT
)
BEGIN
        
	SELECT 
		`id_ordine`,
		`anno`,
		`numero_tab`,
		`id_Articolo`,
		`desc_breve`,
		`codice_fornitore`,
		`id_cliente`,
		`id_fornitore`,
		`qt`,
		`scadenza`,
		`id_nota`,
		`id_commessa`,
		`anno_commessa`,
		`com_lotto`,
		`tipo`,
		`prez`,
		`iva` 
	FROM ordine_dettaglio
	WHERE id_ordine = enter_id AND Anno = enter_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesOrderSupplierUnmarkAsComplete
DELIMITER //
CREATE PROCEDURE `sp_ariesOrderSupplierUnmarkAsComplete`( 
	enter_id INT, 
	enter_year INT
)
BEGIN
	DECLARE pre_completed_status INT(11);

	SELECT stato_pre_evasione INTO pre_completed_status
	FROM ordine_fornitore
	WHERE id_ordine = enter_id AND Anno = enter_year; 

	IF pre_completed_status IS NOT NULL  THEN
		UPDATE ordine_fornitore
		SET segna_come_evaso = 0,
			utente_evasione = @USER_ID,
			stato_pre_evasione = NULL,
			stato = pre_completed_status
		WHERE id_ordine = enter_id AND Anno = enter_year; 
	END IF;	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesOrderSupplierValidate
DELIMITER //
CREATE PROCEDURE `sp_ariesOrderSupplierValidate`( 
	enter_id INT, 
	enter_year INT,
	use_current_date BIT,
	OUT result INT(11)
)
BEGIN

	DECLARE creation_date DATE;
	DECLARE new_order_year INT;
	DECLARE new_order_id INT;

	DECLARE V_supplier_id INT;

	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE exit_loop BOOLEAN;
	DECLARE order_cursor CURSOR FOR
		SELECT DISTINCT id_fornitore
		FROM ordine_dettaglio
		WHERE id_ordine = enter_id AND anno = enter_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET exit_loop = TRUE;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;


	IF enter_year = 0 THEN
		
		-- init result to success 
		SET result = 1;

		IF use_current_date = 1 THEN
			SET creation_date = CURDATE();
		ELSE
			SELECT data_creazione INTO creation_date
			FROM ordine_fornitore
			WHERE id_ordine = enter_id AND anno = enter_year;
		END IF;

		-- Get new id-year for validated order
		SET new_order_year = YEAR(creation_date);
		SELECT IFNULL(MAX(id_ordine)+1, 1) INTO new_order_id
		FROM ordine_fornitore
		WHERE anno = new_order_year;

		START TRANSACTION;

			-- Delete inconsistent rows
			DELETE FROM ordine_dettaglio
			WHERE id_ordine = enter_id AND anno = enter_year AND qt = 0;
		
			OPEN order_cursor;
			order_loop: LOOP
				FETCH order_cursor INTO V_supplier_id;
				IF exit_loop = 1 THEN 
					LEAVE order_loop;
				END IF;

				INSERT INTO ordine_fornitore (id_ordine, descrizione, data_ordine, data_creazione, nota_interna, nota,
						id_fornitore, condizione_pagamento, id_utente, data_ultima_modifica, anno, destinazione,
						id_cliente, vettore, porto_reso, trasporto_cura, stato, inviato, stampato)
				SELECT new_order_id,
					descrizione,
					data_ordine,
					creation_date,
					nota_interna,
					nota,
					V_supplier_id,
					condizione_pagamento,
					id_utente,
					data_ultima_modifica, 
					new_order_year,
					destinazione,
					id_cliente,
					vettore,
					porto_reso,
					trasporto_cura,
					1,
					0,
					0
				FROM ordine_fornitore
				WHERE id_ordine = enter_id AND anno = enter_year;

				INSERT INTO ordine_dettaglio(id_ordine, anno, numero_tab, id_Articolo, desc_breve,
					codice_fornitore, id_cliente, id_fornitore, qt, scadenza, prez, tipo, iva,
					id_commessa, anno_commessa, id_sottocommessa, com_lotto)
				SELECT new_order_id,
					new_order_year,
					numero_tab,
					id_Articolo,
					desc_breve,
					codice_fornitore,
					id_cliente,
					NULL,
					qt,
					scadenza,
					prez,
					tipo,
					iva,
					id_commessa,
					anno_commessa,
					id_sottocommessa,
					com_lotto
				FROM ordine_dettaglio
				WHERE id_ordine = enter_id
					AND anno = enter_year
					AND id_fornitore = V_supplier_id;

				SET new_order_id = new_order_id + 1;

			END LOOP order_loop;


			-- Remoove previous order	
			DELETE FROM ordine_dettaglio
			WHERE id_ordine = enter_id
				AND anno = enter_year;

			DELETE FROM ordine_fornitore
			WHERE id_ordine = enter_id
				AND anno = enter_year;


			
		IF `_rollback` THEN
			ROLLBACK;
			SET Result = 0; 
		ELSE
			COMMIT; 
		END IF;
	ELSE
		SET Result = -1; -- Input order year is not zero
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPathConfigurationGet
DELIMITER //
CREATE PROCEDURE `sp_ariesPathConfigurationGet`(
)
BEGIN

	SELECT configurazione_percorsi.Tipo_percorso, 
		configurazione_percorsi.Percorso
	FROM configurazione_percorsi;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPaymentConditionDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesPaymentConditionDelete`(
	IN payment_condition_id INT(11), 
	OUT result INT(11)
)
BEGIN
	
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	


	IF result = 1 THEN
		DELETE FROM condizione_pagamento
		WHERE id_condizione = payment_condition_id; 
	END IF; 

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPaymentConditionGet
DELIMITER //
CREATE PROCEDURE `sp_ariesPaymentConditionGet`()
BEGIN
	SELECT 
		id_condizione, 
		Nome, 
		Descrizione, 
		tipo, 
		pagato,
		temporanea,
		mesi, 
		modalitaPA,
		condizioniPA, 
		Chiusura_alla_scadenza, 
		id_utente,
		Timestamp
	FROM condizione_pagamento;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPaymentConditionGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesPaymentConditionGetById`(
	IN payment_condition_id INT(11)
)
BEGIN
	SELECT 
		id_condizione, 
		Nome, 
		Descrizione, 
		tipo, 
		pagato,
		temporanea,
		mesi, 
		modalitaPA,
		condizioniPA, 
		Chiusura_alla_scadenza, 
		id_utente,
		Timestamp
	FROM condizione_pagamento
	WHERE id_condizione = payment_condition_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPaymentConditionInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesPaymentConditionInsert`(
	IN name VARCHAR(30),
	IN description VARCHAR(20), 
	IN type_id INT(11), 
	IN total_months INT(10), 
	IN is_paid BIT(1), 
	IN pa_modality VARCHAR(5), 
	IN pa_condition VARCHAR(5), 
	IN auto_closed BIT(1), 
	OUT result INT(11)
)
BEGIN

	
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	
	START TRANSACTION;

	SELECT Count(Chiusura_alla_scadenza) 
		INTO Result
	FROM condizione_pagamento 
	WHERE nome = name; 

	IF Result != 0 THEN
		SET Result = -1; -- name already used
	END IF; 

	IF Result = 0 THEN
		SELECT Count(Id_tipo) 
			INTO Result
		FROM Tipo_pagamento
		WHERE id_Tipo = type_id; 
	END IF; 

	IF Result = 0 THEN
		SET Result = -2; -- payment type not found
	END IF; 

	IF Result = 1 THEN
		INSERT INTO condizione_pagamento
		SET  
			Nome = name, 
			Descrizione = description, 
			tipo = type_id, 
			pagato = is_paid,
			mesi = total_months, 
			modalitaPA = pa_modality,
			condizioniPA = pa_condition, 
			Chiusura_alla_scadenza = auto_closed, 
			id_utente = @USER_ID;

					
		SET Result = LAST_INSERT_ID();
	END IF;


	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPaymentConditionUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesPaymentConditionUpdate`(
	IN payment_condition_id INT(11), 
	IN name VARCHAR(30),
	IN description VARCHAR(20), 
	IN type_id INT(11), 
	IN total_months INT(10), 
	IN is_paid BIT(1), 
	IN pa_modality VARCHAR(5), 
	IN pa_condition VARCHAR(5), 
	IN auto_closed BIT(1), 
	OUT result INT(11)
)
BEGIN
	
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	SET Result = 1; 
	
	START TRANSACTION;

	SELECT Count(Chiusura_alla_scadenza) 
		INTO Result
	FROM condizione_pagamento 
	WHERE nome = name AND id_condizione != payment_condition_id; 

	IF Result != 0 THEN
		SET Result = -1; -- name already used
	END IF; 

	IF Result = 0 THEN
		SELECT Count(Id_tipo) 
			INTO Result
		FROM Tipo_pagamento
		WHERE id_Tipo = type_id; 
	END IF; 

	IF Result = 0 THEN
		SET Result = -2; -- payment type not found
	END IF; 


	IF result = 1 THEN
		UPDATE condizione_pagamento
		SET 
			Nome = name, 
			Descrizione = description, 
			tipo = type_id, 
			pagato = is_paid,
			mesi = total_months, 
			modalitaPA = pa_modality,
			condizioniPA = pa_condition, 
			Chiusura_alla_scadenza = auto_closed, 
			id_utente = @USER_ID
		WHERE id_condizione = payment_condition_id; 
	END IF; 

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPrinterFormsFormatGetBy
DELIMITER //
CREATE PROCEDURE `sp_ariesPrinterFormsFormatGetBy`(
	IN document_id INT(11), 
	IN form_id INT(11)
)
BEGIN
	SELECT 
		stampante_moduli_formati.Id, 
		stampante_moduli_formati.Id_modulo,
		stampante_moduli_formati.Id_documento, 
		stampante_moduli_formati.Id_formato, 
		stampante_formati.Nome
	FROM stampante_moduli_formati
		INNER JOIN stampante_formati ON 
		stampante_moduli_formati.Id_formato = stampante_formati.Id
	WHERE stampante_moduli_formati.Id_documento = document_id
		AND stampante_moduli_formati.Id_modulo = form_id; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPrinterFormsGet
DELIMITER //
CREATE PROCEDURE `sp_ariesPrinterFormsGet`()
BEGIN
	SELECT 
		`id_documento`,
		`modulo`,
		`Id_modulo`,
		`mail`,
		`pdf`,
		`fax`,
		`stampa`,
		`anteprima`,
		IFNULL(`File_name`, '') AS File_name,
		IFNULL(`Report_name`, '') AS Report_name,
		`Attivo`
	FROM stampante_moduli; 	
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesPrinterFormsGetByDocumentAndForm
DELIMITER //
CREATE PROCEDURE `sp_ariesPrinterFormsGetByDocumentAndForm`(
	IN document_id INT(11), 
	IN form_id INT(11)
)
BEGIN
	SELECT 
		`id_documento`,
		`modulo`,
		`Id_modulo`,
		`mail`,
		`pdf`,
		`fax`,
		`stampa`,
		`anteprima`,
		IFNULL(`File_name`, '') AS File_name,
		IFNULL(`Report_name`, '') AS Report_name,
		`Attivo`
	FROM stampante_moduli
	WHERE Id_documento = document_id
		AND Id_modulo = form_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductCategoryDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesProductCategoryDelete`(
	IN ProductCategoryId INT(11),
	OUT result INT(11)
)
BEGIN

	SELECT COUNT(Codice_articolo)
		INTO Result
	FROM Articolo
	WHERE articolo.Categoria = ProductCategoryId; 
	
	IF Result > 0 THEN
		SET Result := -3; 
	ELSE
		DELETE
		FROM categoria_merciologica
		WHERE categoria_merciologica.Id_categoria = ProductCategoryId; 
		
		SET result = 1;
	END IF; 

	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductCategoryGet
DELIMITER //
CREATE PROCEDURE `sp_ariesProductCategoryGet`(
)
BEGIN

	SELECT `Id_categoria`,
		`Nome` ,
		IFNULL(`Descrizione`, '') Descrizione,
		Movimenta_magazzino, 
		Movimenta_impianto, 
		IFNULL(`Utente_ins` , 0) Utente_ins,
		IFNULL(`Utente_mod`, 0) Utente_mod,
		STR_TO_DATE(IFNULL(`Data_ins`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_ins,
		Data_mod
	FROM categoria_merciologica; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductCategoryGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesProductCategoryGetById`(
	IN ProductCategoryId INT(11)
)
BEGIN

	SELECT `Id_categoria`,
		`Nome` ,
		IFNULL(`Descrizione`, '') Descrizione,
		Movimenta_magazzino, 
		Movimenta_impianto, 
		IFNULL(`Utente_ins` , 0) Utente_ins,
		IFNULL(`Utente_mod`, 0) Utente_mod,
		STR_TO_DATE(IFNULL(`Data_ins`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_ins,
		Data_mod
	FROM categoria_merciologica
	WHERE Id_categoria = ProductCategoryId; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductCategoryInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesProductCategoryInsert`(
	IN Name VARCHAR(50),
	IN Description TEXT,
	IN HasDepositMovement BIT, 
	IN HasSystemMovement BIT,
	OUT Result INT(11)
)
BEGIN

	SET Result = 0;
	
	IF Name = '' THEN
		SET Result = -2; -- name cannot be empty
	 
	ELSE 
	
		SELECT COUNT(categoria_merciologica.Id_categoria) 
			INTO Result
		FROM categoria_merciologica 
		WHERE categoria_merciologica.Nome = Name; 
		
		IF Result > 0 THEN
			SET Result = -1; -- current name is already used
		END IF;
		 
	END IF; 
	
	IF Result >= 0 THEN
	
		INSERT INTO categoria_merciologica 
		SET 
			categoria_merciologica.Nome = Name, 
			categoria_merciologica.Descrizione = Description, 
			categoria_merciologica.Movimenta_magazzino = HasDepositMovement, 
			categoria_merciologica.Movimenta_impianto = HasSystemMovement, 
			categoria_merciologica.Data_ins = NOW(), 
			categoria_merciologica.Utente_ins = @USER_ID, 
			categoria_merciologica.Utente_mod = @USER_ID; 	 
		
		 SET Result  = LAST_INSERT_ID();
		 
	END IF; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductCategorySearchByName
DELIMITER //
CREATE PROCEDURE `sp_ariesProductCategorySearchByName`(
	IN name MEDIUMTEXT
)
BEGIN

	SELECT `Id_categoria`,
		`Nome` ,
		IFNULL(`Descrizione`, '') Descrizione,
		Movimenta_magazzino, 
		Movimenta_impianto, 
		IFNULL(`Utente_ins` , 0) Utente_ins,
		IFNULL(`Utente_mod`, 0) Utente_mod,
		STR_TO_DATE(IFNULL(`Data_ins`, '1970-01-01 00:00:00'), '%Y-%m-%d') data_ins,
		Data_mod
	FROM categoria_merciologica
	WHERE Nome Like CONCAT('%', name, '%'); 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductCategoryUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesProductCategoryUpdate`(
	IN ProductCategoryId INT(11), 
	IN Name VARCHAR(50),
	IN Description TEXT,
	IN HasDepositMovement BIT, 
	IN HasSystemMovement BIT,
	OUT Result INT(11)
)
BEGIN

	SET Result = 0;
	
	IF Name = '' THEN
		SET Result = -2; -- name cannot be empty
	 
	ELSE 
	
		SELECT COUNT(categoria_merciologica.Id_categoria) 
			INTO Result
		FROM categoria_merciologica 
		WHERE categoria_merciologica.Nome = Name AND categoria_merciologica.Id_categoria != ProductCategoryId; 
		
		IF Result > 0 THEN
			SET Result = -1; -- current name is already used
		END IF;
		 
	END IF; 
	
	IF Result >= 0 THEN
	
		UPDATE categoria_merciologica 
		SET 
			categoria_merciologica.Nome = Name, 
			categoria_merciologica.Descrizione = Description, 
			categoria_merciologica.Movimenta_magazzino = HasDepositMovement, 
			categoria_merciologica.Movimenta_impianto = HasSystemMovement, 
			categoria_merciologica.Utente_mod = @USER_ID 	 
		WHERE categoria_merciologica.Id_categoria = ProductCategoryId; 
		 
		SET Result = 1;
	END IF; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductFindByCodesOrDescription
DELIMITER //
CREATE PROCEDURE `sp_ariesProductFindByCodesOrDescription`( 
	codes MEDIUMTEXT,
	description MEDIUMTEXT
)
BEGIN
			
	SELECT DISTINCT
		Codice_articolo, 
		IFNULL(Desc_Brev, "") AS Desc_brev,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		IFNULL(Marca, "") AS MArca, 
		Peso, 
		IFNULL(Altre_Caratteristiche, "") AS Altre_Caratteristiche,
		IFNULL(Scadenza, 0) AS scadenza, 
		IFNULL(Fornitore_priv, 0) AS Fornitore_priv, 
		Tempo_installazione, 
		IFNULL(Categoria, 0) AS Categoria, 
		IFNULL(SottoCategoria, 0) AS Sottocategoria, 
		IFNULL(Sottocategoria2, 0) AS Sottocategoria2, 
		IFNULL(Barcode, "") AS Barcode, 
		Quantita_massima, 
		Quantita_minima, 
		NUmero_confezione, 
		IFNULL(Unità_misura,  "") AS Unità_misura, 
		IFNULL(ult_vendita, 0) AS ult_vendita, 
		IFNULL(garanzia, 0) AS Garanzia, 
		IFNULL(Minuti_Manutenzione, 0) AS Minuti_Manutenzione,
		Stato_articolo, 
		Data_inserimento, 
		id_tipo_costo_produzione,
		IFNULL(umidità, 0) as umidità, 
		IFNULL(min, 0) as min, 
		IFNULL(max, 0) AS max,
		IFNULL(l, 0) AS l, 
		IFNULL(h, 0) AS h, 
		IFNULL(p, 0) AS p,
		modifica, 
		kw, 
		litri, 
		kwp, 
		IFNULL(Color, "") AS Color, 
		moltiplicatore, 
		Is_Kit,
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	FROM articolo
		LEFT JOIN articolo_nota ON articolo.Codice_articolo = articolo_nota.Id_articolo
		LEFT JOIN articolo_codice ON articolo.codice_articolo = articolo_codice.id_articolo
	WHERE FIND_IN_SET(Codice_articolo, codes) > 0
		OR FIND_IN_SET(Codice_fornitore, codes) > 0
		OR FIND_IN_SET(codice, codes) > 0
		OR Desc_Brev = description
		OR Nota = description;
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductGet
DELIMITER //
CREATE PROCEDURE `sp_ariesProductGet`( 
)
BEGIN    
	SELECT
		Codice_articolo, 
		IFNULL(Desc_Brev, "") AS Desc_brev,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		IFNULL(Marca, "") AS MArca, 
		Peso, 
		IFNULL(Altre_Caratteristiche, "") AS Altre_Caratteristiche,
		IFNULL(Scadenza, 0) AS scadenza, 
		IFNULL(Fornitore_priv, 0) AS Fornitore_priv, 
		Tempo_installazione, 
		IFNULL(Categoria, 0) AS Categoria, 
		IFNULL(SottoCategoria, 0) AS Sottocategoria, 
		IFNULL(Sottocategoria2, 0) AS Sottocategoria2, 
		IFNULL(Barcode, "") AS Barcode, 
		Quantita_massima, 
		Quantita_minima, 
		NUmero_confezione, 
		IFNULL(Unità_misura,  "") AS Unità_misura, 
		IFNULL(ult_vendita, 0) AS ult_vendita, 
		IFNULL(garanzia, 0) AS Garanzia, 
		IFNULL(Minuti_Manutenzione, 0) AS Minuti_Manutenzione,
		Stato_articolo, 
		Data_inserimento, 
		id_tipo_costo_produzione,
		IFNULL(umidità, 0) as umidità, 
		IFNULL(min, 0) as min, 
		IFNULL(max, 0) AS max,
		IFNULL(l, 0) AS l, 
		IFNULL(h, 0) AS h, 
		IFNULL(p, 0) AS p,
		modifica, 
		kw, 
		litri, 
		kwp, 
		IFNULL(Color, "") AS Color, 
		moltiplicatore, 
		Is_Kit,
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	FROM articolo; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductGetByBrand
DELIMITER //
CREATE PROCEDURE `sp_ariesProductGetByBrand`( 
	brand VARCHAR(5)
)
BEGIN
  
	SELECT
		Codice_articolo, 
		IFNULL(Desc_Brev, "") AS Desc_brev,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		IFNULL(Marca, "") AS MArca, 
		Peso, 
		IFNULL(Altre_Caratteristiche, "") AS Altre_Caratteristiche,
		IFNULL(Scadenza, 0) AS scadenza, 
		IFNULL(Fornitore_priv, 0) AS Fornitore_priv, 
		Tempo_installazione, 
		IFNULL(Categoria, 0) AS Categoria, 
		IFNULL(SottoCategoria, 0) AS Sottocategoria, 
		IFNULL(Sottocategoria2, 0) AS Sottocategoria2, 
		IFNULL(Barcode, "") AS Barcode, 
		Quantita_massima, 
		Quantita_minima, 
		NUmero_confezione, 
		IFNULL(Unità_misura,  "") AS Unità_misura, 
		IFNULL(ult_vendita, 0) AS ult_vendita, 
		IFNULL(garanzia, 0) AS Garanzia, 
		IFNULL(Minuti_Manutenzione, 0) AS Minuti_Manutenzione,
		Stato_articolo, 
		Data_inserimento, 
		id_tipo_costo_produzione,
		IFNULL(umidità, 0) as umidità, 
		IFNULL(min, 0) as min, 
		IFNULL(max, 0) AS max,
		IFNULL(l, 0) AS l, 
		IFNULL(h, 0) AS h, 
		IFNULL(p, 0) AS p,
		modifica, 
		kw, 
		litri, 
		kwp, 
		IFNULL(Color, "") AS Color, 
		moltiplicatore, 
		Is_Kit,
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	FROM articolo
	WHERE marca  = brand; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductGetByCategoryId
DELIMITER //
CREATE PROCEDURE `sp_ariesProductGetByCategoryId`( 
category_id INT
)
BEGIN
        

	SELECT
		Codice_articolo, 
		IFNULL(Desc_Brev, "") AS Desc_brev,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		IFNULL(Marca, "") AS MArca, 
		Peso, 
		IFNULL(Altre_Caratteristiche, "") AS Altre_Caratteristiche,
		IFNULL(Scadenza, 0) AS scadenza, 
		IFNULL(Fornitore_priv, 0) AS Fornitore_priv, 
		Tempo_installazione, 
		IFNULL(Categoria, 0) AS Categoria, 
		IFNULL(SottoCategoria, 0) AS Sottocategoria, 
		IFNULL(Sottocategoria2, 0) AS Sottocategoria2, 
		IFNULL(Barcode, "") AS Barcode, 
		Quantita_massima, 
		Quantita_minima, 
		NUmero_confezione, 
		IFNULL(Unità_misura,  "") AS Unità_misura, 
		IFNULL(ult_vendita, 0) AS ult_vendita, 
		IFNULL(garanzia, 0) AS Garanzia, 
		IFNULL(Minuti_Manutenzione, 0) AS Minuti_Manutenzione,
		Stato_articolo, 
		Data_inserimento, 
		id_tipo_costo_produzione,
		IFNULL(umidità, 0) as umidità, 
		IFNULL(min, 0) as min, 
		IFNULL(max, 0) AS max,
		IFNULL(l, 0) AS l, 
		IFNULL(h, 0) AS h, 
		IFNULL(p, 0) AS p,
		modifica, 
		kw, 
		litri, 
		kwp, 
		IFNULL(Color, "") AS Color, 
		moltiplicatore, 
		Is_Kit,
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	FROM articolo
	WHERE Caregoria  = category_id; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesProductGetById`( 
product_code VARCHAR(11)
)
BEGIN
    
	SELECT
		Codice_articolo, 
		IFNULL(Desc_Brev, "") AS Desc_brev,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		IFNULL(Marca, "") AS MArca, 
		Peso, 
		IFNULL(Altre_Caratteristiche, "") AS Altre_Caratteristiche,
		IFNULL(Scadenza, 0) AS scadenza, 
		IFNULL(Fornitore_priv, 0) AS Fornitore_priv, 
		Tempo_installazione, 
		IFNULL(Categoria, 0) AS Categoria, 
		IFNULL(SottoCategoria, 0) AS Sottocategoria, 
		IFNULL(Sottocategoria2, 0) AS Sottocategoria2, 
		IFNULL(Barcode, "") AS Barcode, 
		Quantita_massima, 
		Quantita_minima, 
		NUmero_confezione, 
		IFNULL(Unità_misura,  "") AS Unità_misura, 
		IFNULL(ult_vendita, 0) AS ult_vendita, 
		IFNULL(garanzia, 0) AS Garanzia, 
		IFNULL(Minuti_Manutenzione, 0) AS Minuti_Manutenzione,
		Stato_articolo, 
		Data_inserimento, 
		id_tipo_costo_produzione,
		IFNULL(umidità, 0) as umidità, 
		IFNULL(min, 0) as min, 
		IFNULL(max, 0) AS max,
		IFNULL(l, 0) AS l, 
		IFNULL(h, 0) AS h, 
		IFNULL(p, 0) AS p,
		modifica, 
		kw, 
		litri, 
		kwp, 
		IFNULL(Color, "") AS Color, 
		moltiplicatore, 
		Is_Kit,
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	FROM articolo
	WHERE Codice_articolo = product_code; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductNoteGetByCodeAndDescription
DELIMITER //
CREATE PROCEDURE `sp_ariesProductNoteGetByCodeAndDescription`(
	product_code VARCHAR(13), 
	description VARCHAR(40)
)
BEGIN

	SELECT 
		Id_articolo, 
		Descrizione, 
		Nota, 
		data_ult_modifica
	FROM articolo_nota
	WHERE Id_articolo = product_code AND Descrizione = description
	ORDER BY Id_articolo, Descrizione; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductNoteInsertOrUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesProductNoteInsertOrUpdate`(
	product_code VARCHAR(13), 
	description VARCHAR(40), 
	note TEXT
)
BEGIN

	INSERT INTO articolo_nota (Id_articolo, descrizione, nota) VALUES (product_code,description,note)
  		ON DUPLICATE KEY UPDATE nota = note; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductPriceListGetByCode
DELIMITER //
CREATE PROCEDURE `sp_ariesProductPriceListGetByCode`(
	product_code VARCHAR(13)
)
BEGIN

	SELECT 
	`Id_articolo`,
	`Id_listino`,
	`Prezzo`,
	`data_inizio`,
	`Data_mod`
	FROM articolo_listino
	WHERE Id_articolo = product_code 
	ORDER BY Id_articolo, Id_listino; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductRowNumbers
DELIMITER //
CREATE PROCEDURE `sp_ariesProductRowNumbers`( 
)
BEGIN
SELECT
	COUNT(*)
FROM articolo; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductSerchById
DELIMITER //
CREATE PROCEDURE `sp_ariesProductSerchById`( 
product_code VARCHAR(11)
)
BEGIN
        

	SELECT
		Codice_articolo, 
		IFNULL(Desc_Brev, "") AS Desc_brev,
		IFNULL(Codice_fornitore, "") AS Codice_fornitore, 
		IFNULL(Marca, "") AS MArca, 
		Peso, 
		IFNULL(Altre_Caratteristiche, "") AS Altre_Caratteristiche,
		IFNULL(Scadenza, 0) AS scadenza, 
		IFNULL(Fornitore_priv, 0) AS Fornitore_priv, 
		Tempo_installazione, 
		IFNULL(Categoria, 0) AS Categoria, 
		IFNULL(SottoCategoria, 0) AS Sottocategoria, 
		IFNULL(Sottocategoria2, 0) AS Sottocategoria2, 
		IFNULL(Barcode, "") AS Barcode, 
		Quantita_massima, 
		Quantita_minima, 
		NUmero_confezione, 
		IFNULL(Unità_misura,  "") AS Unità_misura, 
		IFNULL(ult_vendita, 0) AS ult_vendita, 
		IFNULL(garanzia, 0) AS Garanzia, 
		IFNULL(Minuti_Manutenzione, 0) AS Minuti_Manutenzione,
		Stato_articolo, 
		Data_inserimento, 
		id_tipo_costo_produzione,
		IFNULL(umidità, 0) as umidità, 
		IFNULL(min, 0) as min, 
		IFNULL(max, 0) AS max,
		IFNULL(l, 0) AS l, 
		IFNULL(h, 0) AS h, 
		IFNULL(p, 0) AS p,
		modifica, 
		kw, 
		litri, 
		kwp, 
		IFNULL(Color, "") AS Color, 
		moltiplicatore, 
		Is_Kit,
		articolo.scaffaliera_magazzino,
		articolo.ripiano_magazzino,
		articolo.descrizione_posizione_magazzino
	FROM articolo
	WHERE Codice_articolo LIKE CONCAT("%", product_code, "%"); 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductSubCategoryGet
DELIMITER //
CREATE PROCEDURE `sp_ariesProductSubCategoryGet`(
	IN level_id INT(11)
)
BEGIN
	SELECT `Id_categoria`,
		`id_sottocategoria`,
		id_sottocategoria_padre,
		`Nome`,
		`Descrizione`,
			livello
	FROM vw_product_sub_categories
	WHERE livello = level_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductSubCategoryGetByCategory
DELIMITER //
CREATE PROCEDURE `sp_ariesProductSubCategoryGetByCategory`(
	IN level_id INT(11),
	IN category_id INT(11)
)
BEGIN
	SELECT `Id_categoria`,
		`id_sottocategoria`,
		id_sottocategoria_padre,
		`Nome`,
		`Descrizione`,
			livello
	FROM vw_product_sub_categories
	WHERE livello = level_id AND id_categoria = category_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductSubCategoryGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesProductSubCategoryGetById`(
	IN subcategory_id INT(11),
	IN level_id INT(11)
)
BEGIN

	SELECT `Id_categoria`,
		`id_sottocategoria`,
		id_sottocategoria_padre,
		`Nome`,
		`Descrizione`,
			livello
	FROM vw_product_sub_categories
	WHERE livello = level_id
		AND id_sottocategoria = subcategory_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductSubCategorySearchByName
DELIMITER //
CREATE PROCEDURE `sp_ariesProductSubCategorySearchByName`(
	IN level_id INT(11),
	IN name MEDIUMTEXT
)
BEGIN

	SELECT `Id_categoria`,
		`id_sottocategoria`,
		id_sottocategoria_padre,
		`Nome`,
		`Descrizione`,
			livello
	FROM vw_product_sub_categories
	WHERE livello = level_id
		AND Nome Like CONCAT('%', name, '%');
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProductUpdateCategories
DELIMITER //
CREATE PROCEDURE `sp_ariesProductUpdateCategories`(
	IN product_code VARCHAR(11),
	IN category_id INT(11),
	IN sub_category_id1 INT(11),
	IN sub_category_id2 INT(11)
)
BEGIN

	UPDATE articolo
	SET Categoria = category_id,
		Sottocategoria = sub_category_id1,
		Sottocategoria2 = sub_category_id2
	WHERE codice_articolo = product_code;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProvinceDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesProvinceDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM province 
	WHERE id_provincia = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProvinceGet
DELIMITER //
CREATE PROCEDURE `sp_ariesProvinceGet`( 
)
BEGIN
	SELECT id_provincia,
	Nome,
	Sigla, 
	Regione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM province
	ORDER BY id_provincia;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProvinceGetByAbbreviation
DELIMITER //
CREATE PROCEDURE `sp_ariesProvinceGetByAbbreviation`( 
	abbreviation INT
)
BEGIN
	SELECT id_provincia,
	Nome,
	Sigla, 
	Regione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM province
	WHERE Sigla = abbreviation;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProvinceGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesProvinceGetById`( 
	Province_id INT
)
BEGIN
	SELECT id_provincia,
	Nome,
	Sigla, 
	Regione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM province
	WHERE id_provincia = Province_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProvinceGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesProvinceGetByName`( 
	name VARCHAR(45)
)
BEGIN
	SELECT id_provincia,
	Nome,
	Sigla, 
	Regione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM province
	WHERE Nome = name;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProvinceInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesProvinceInsert`( 
	name VARCHAR(45),
	region_id INTEGER,
	abbreviation VARCHAR(15),
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Regione 
	WHERE id_regione = region_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM province 
		WHERE Nome = Name; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Province name already exists
		END IF;
	ELSE
		SET Result = -2; # region not found
	END IF;
	
	IF Result = 0 THEN
		INSERT INTO province 
		SET 
			Nome = name,
			Regione = region_id,
			Sigla = abbreviation, 
			Data_ins = NOW(), 
			Data_mod = NOW(),
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProvinceUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesProvinceUpdate`( 
	enter_id INTEGER,
	name VARCHAR(45),
	abbreviation VARCHAR(15),
	region_id INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM regione 
	WHERE id_regione = region_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM province 
		WHERE Nome = Name AND id_provincia != enter_id; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Province name already exists
		END IF;
	ELSE
		SET Result = -2; # region not found
	END IF;
	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM province 
			WHERE id_provincia = enter_id;
			
			IF Result = 0 THEN
				SET Result = -3; # Province ID not found							
			END IF; 
	END IF; 
	
	IF Result >0 THEN
		
		START TRANSACTION;
		
		UPDATE Comune 
		SET Provincia = abbreviation
		WHERE Id_provincia = enter_id; 	
		
		UPDATE province 
		SET 
			Nome = name,
			Regione = region_id, 
			Sigla = abbreviation, 
			Utente_mod = @USER_ID
		Where id_provincia = enter_id;
		
		COMMIT;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesProxiesConfigurationGetByType
DELIMITER //
CREATE PROCEDURE `sp_ariesProxiesConfigurationGetByType`(
	IN in_type INT(11)
)
BEGIN
	SELECT
		`id`,
		`tipo`,
		`base_host`,
		`basic_auth`,
		`timestamp`
	FROM proxies_configurazione
	WHERE tipo = in_type;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteAddDefaultLot
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteAddDefaultLot`(
	quote_id INT(11), 
	quote_year INT(11), 
	review_id INT(11), 
	default_lot_id INT(11), 
	OUT result BIT(1)
)
BEGIN

	DECLARE lot_Id INT(11); 
	DECLARE vat INT(11);
	DECLARE hourly_price DECIMAL(11,2); 
	DECLARE hourly_cost DECIMAL(11,2);
	DECLARE list_id INT(11); 
	DECLARE discount DECIMAL(11,2); 
	DECLARE quote_type_id INT(11);
	DECLARE subscription_id INT(11);
	   
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	
	-- extract next lot id
	SELECT 
		MAX(posizione)+1 
	INTO 
		lot_id
	FROM preventivo_lotto 
	WHERE id_preventivo = quote_id AND anno = quote_year AND ID_revisione = review_id; 
	
	IF lot_id IS NULL THEN 
		SET lot_id = 1; 
	END IF;
	
	
	-- extract vat and others info from Quote review table
	SELECT 
		Prezzo_ora, 
		Costo_ora, 
		Aliquota, 
	    Listino, 
		Sconto_perc, 
		tariffa
	INTO
		hourly_price, 
		hourly_cost, 
		vat, 
		list_id, 
		discount, 
		subscription_id
	FROM revisione_preventivo 
	WHERE id_preventivo = quote_id AND anno = quote_year AND ID_revisione = review_id;  
	
	
	
	IF vat IS NULL THEN 
		SELECT 
			aliquota
		INTO 
			vat
		FROM Tipo_iva
		WHERE normale = 1; 
	ELSE
		SELECT 
			aliquota
		INTO 
			vat
		FROM Tipo_iva
		WHERE Id_iva = vat; 
	END IF;
	
	
	-- extract quote type id
	SELECT 
		tipo_preventivo
	INTO 
		quote_type_id
	FROM preventivo
	WHERE id_preventivo = quote_id AND anno = quote_year;
	
	-- insert new lot
	INSERT INTO preventivo_lotto 
		(id_preventivo, id_lotto,posizione, anno, id_revisione, scon, ora_p, ora_c, iv_lot, id_Abbo) 
	VALUES
		(quote_id, default_lot_id, lot_id, quote_year, review_id, discount, hourly_price, hourly_cost, vat, subscription_id);
		
	
	-- insert products and notes	
	INSERT INTO articolo_preventivo  
	(
		Id_preventivo, 
		Anno,
		Id_revisione,
		Lotto,
		Id_tab,
		id_articolo, 
		quantità,
		Codice_fornitore, 
		Unità_misura,  
		Foto, 
		Prezzo,
		costo, 
		Tempo_installazione,  
		Prezzo_h,
		Costo_h,
		Desc_brev, 
		Listino, 
		Bloccato, 
		Montato, 
		Tipo, 
		Sconto, 
		iva, 
		scontoriga, 
		scontolav, 
		checked, 
		idnota, 
		`Data_ins`,
		`Utente_ins`
	)	

	SELECT 
		quote_id, 
		quote_year,
		review_id,
		lot_id, 
		Id_tab,
		IF(tipo = 'N', NULL, articolo_lotto.Id_articolo), 
		IF(tipo = 'N', NULL, articolo_lotto.quantità), 
		IF(tipo = 'N', NULL, articolo_lotto.codice_fornitore),
		IF(tipo = 'N', NULL, articolo_lotto.Unità_misura),
		'si', 
		IF(tipo = 'N', NULL, listino_prezzi.Prezzo), -- prezzo
		IF(tipo = 'N', NULL, listino_costi.Prezzo), -- costo
		IF(tipo = 'N', NULL, Tempo_installazione),
		IF(tipo = 'N', NULL, hourly_price), -- prezzo ora
		IF(tipo = 'N', NULL, hourly_cost), -- costo ora
		IF(tipo = 'N', desc_brev, IF(articolo_nota.nota IS NOT NULL, articolo_nota.nota, desc_brev)),
		IF(tipo = 'N', NULL, 1), -- listino
		0, -- bloccato
		IF(tipo = 'N', NULL, Montato),
		Tipo, 
		IF(tipo = 'N', NULL, 0), -- product discount
		IF(tipo = 'N', NULL, Vat), 
		discount, 
		0, -- scontolav
		NULL, -- Checked
		IF(tipo = 'N', idnota, NULL), 
		NOW(),
		@USER_ID
		
	FROM articolo_lotto
		LEFT JOIN articolo_nota 
			ON articolo_nota.id_articolo=articolo_lotto.id_articolo AND descrizione="GENERALE"
		LEFT JOIN articolo_listino AS listino_prezzi 
			ON listino_prezzi.id_Articolo=articolo_lotto.id_articolo AND listino_prezzi.id_listino = 2
		LEFT JOIN articolo_listino AS listino_costi 
			ON listino_costi.id_Articolo = articolo_lotto.id_articolo AND listino_costi.id_listino = 1 
	WHERE id_lotto = default_lot_id;
	
	
	
	
	-- insert quote exclusions 
	INSERT INTO lotto_esclusioni 
		(id_lotto, id_revisione, id_preventivo, anno, id_esclusione)
	SELECT 
		lot_id, 
		review_id, 
		quote_id, 
		quote_year,
		esclusioni.id_esclusione
	FROM esclusioni 
		INNER JOIN preventivo_controllo_esclusioni  
		ON preventivo_controllo_esclusioni.id_esclusione = esclusioni.id_esclusione 
			AND preventivo_controllo_esclusioni.tipo = quote_type_id;
	
	
	SET Result = 1;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteClone
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteClone`( 
	IN quote_id INT(11),
	IN quote_year INT(11),
	OUT result INT(11)
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
  	DECLARE new_id INT(11); 
  	DECLARE curr_year INT(11);
  	DECLARE last_review_id INT(11);
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;	
		
	START TRANSACTION;

	SET curr_year = YEAR(CURDATE());
	
	SELECT IFNULL(MAX(id_preventivo) + 1, 1) 
		INTO new_id
	FROM preventivo
	WHERE anno = curr_year; 
	
	SELECT MAX(id_revisione)
		INTO last_review_id
	FROM revisione_preventivo 
	WHERE Id_preventivo = quote_id AND Anno = quote_year;
	
	SET Result = new_id; 
	
	INSERT INTO preventivo(id_preventivo, anno, data_creazione, stato, note, tipo_preventivo, agente, revisione) 
	SELECT new_id,
		curr_year,
		NOW(),
		5, -- Stato preventivo
		CONCAT(note, " DUPLICATO DA ", quote_id, " - ", quote_year),
		tipo_preventivo,
		agente,
		0
	FROM preventivo
	WHERE Id_preventivo = quote_id AND Anno = quote_year;
	
	INSERT INTO revisione_preventivo(id_riferimento, id_cliente, destinazione, id_revisione, id_preventivo, anno, data_creazione, data, listino,sconto_perc,
		prezzo_ora, costo_ora,aliquota,corpo,cortese,oggetto, nota,tariffa,sitoin, corpo_rtf)
	SELECT id_riferimento,
		id_cliente,
		destinazione,
		0,
		new_id,
		curr_year,
		NOW(),
		NOW(),
		listino,sconto_perc,
		prezzo_ora,
		costo_ora,
		aliquota,
		corpo,
		cortese,
		oggetto,
		nota,
		tariffa,
		sitoin,
		corpo_rtf
	FROM revisione_preventivo
	WHERE Id_preventivo = quote_id 
		AND Anno = quote_year
		AND id_revisione = last_review_id;
	
		
	INSERT INTO preventivo_lotto(id_lotto, anno, id_preventivo, id_revisione, posizione, nota, prefazione, id_impianto,
		id_Abbo, scon, ora_p, ora_c, optional, iv_lot, tipo_ricar, perc_ric)
	SELECT id_lotto,
		curr_year,
		new_id,
		0,
		posizione,
		nota,prefazione,
		id_impianto,
		id_Abbo,
		scon,
		ora_p,
		ora_c,
		optional,
		iv_lot,
		tipo_ricar,
		perc_ric
	FROM preventivo_lotto
	WHERE Id_preventivo = quote_id 
		AND Anno = quote_year
		AND id_revisione = last_review_id;
	
	INSERT INTO preventivo_impianto(anno, id_preventivo, revisione, impianto)
	SELECT curr_year,
		new_id,
		0,
		impianto
	FROM preventivo_impianto
	WHERE Id_preventivo = quote_id 
		AND Anno = quote_year
		AND revisione = last_review_id;

	INSERT INTO lotto_esclusioni (id_lotto, id_revisione, id_preventivo, anno, id_esclusione)
	SELECT id_lotto,
		0,
		new_id,
		curr_year,
		id_esclusione
    FROM lotto_esclusioni
	WHERE Id_preventivo = quote_id 
		AND Anno = quote_year
		AND id_revisione = last_review_id;

	INSERT INTO articolo_preventivo (id_preventivo, id_revisione, anno, lotto, id_tab, prezzo, costo, sconto, quantità,
		costo_h, prezzo_h, desc_brev, codice_fornitore, id_articolo, tempo_installazione, listino,
		montato, bloccato, tipo, unità_misura, scontoriga, scontolav, idnota, Utente_ins)
	SELECT
		new_id,
		0,
		curr_year,
		lotto,
		id_tab,
		prezzo,
		costo,
		sconto,
		quantità,
		costo_h,
		prezzo_h, 
		IF(articolo_nota.descrizione IS NULL,desc_brev, nota),
		codice_fornitore,
		articolo_preventivo.id_articolo,
		tempo_installazione,
		listino,
		montato,
		bloccato,
		tipo,
		unità_misura,
		scontoriga,
		scontolav,
		idnota,
		@USER_ID
	FROM articolo_preventivo 
	LEFT JOIN articolo_nota ON articolo_preventivo.id_articolo = articolo_nota.id_Articolo AND descrizione = "Generale"
	WHERE Id_preventivo = quote_id 
		AND Anno = quote_year
		AND id_revisione = last_review_id;


	INSERT INTO preventivo_lotto_pdf (
		Id_preventivo, id_revisione, anno, posizione_lotto, posizione, filepath, filename, utente_mod
	)
	SELECT
		new_id, 0, curr_year, posizione_lotto, posizione, filepath, filename, @USER_ID
	FROM preventivo_lotto_pdf 
	WHERE Id_preventivo = quote_id 
		AND Anno = quote_year
		AND id_revisione = last_review_id;


	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteConvertTempProducts
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteConvertTempProducts`(
	enter_id INT(11),
	enter_year INT(11)
)
BEGIN
	
	UPDATE articolo 
		INNER JOIN articolo_preventivo ON articolo.codice_articolo = articolo_preventivo.Id_articolo
	SET articolo.Stato_articolo = 1
	WHERE articolo.Stato_articolo = 10;
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteLinkToTicket
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteLinkToTicket`( 
	IN quote_id INT(11),
	IN quote_year INT(11),
	IN ticket_id INT(11),
	IN ticket_year INT(11),
	IN internal_note LONGTEXT,
	OUT result INT(11)
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE customer_id INT(11);
	DECLARE review_id INT(11);
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;	
		
	START TRANSACTION;
	
	SET Result = 1; 
	
	SELECT id_cliente
		INTO customer_id
	FROM ticket
	WHERE Id_ticket = ticket_id
		AND anno = ticket_year;
	
	SELECT revisione
		INTO review_id
	FROM preventivo
	WHERE Id_preventivo = quote_id
		AND anno = quote_year;
	
	INSERT INTO preventivo_ticket (id_preventivo, anno_preventivo, id_ticket, anno_ticket)
		VALUES (quote_id, quote_year, ticket_id, ticket_year);
		
	UPDATE preventivo
	SET stato = 6,
		Note = internal_note
	WHERE Id_preventivo = quote_id AND anno = quote_year;
	
	UPDATE revisione_preventivo
	SET id_cliente = customer_id 
	WHERE Id_preventivo = quote_id AND anno = quote_year AND Id_revisione = review_id;
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteLotBodyByLot
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteLotBodyByLot`(
quote_id INT(11), 
quote_year INT(11), 
review_id INT(11), 
lot_id INT(11)
)
BEGIN

	SELECT 
		Id_preventivo, 
		Anno,
		Id_revisione,
		Lotto,
		Id_tab,
		IFNULL(id_articolo, '') AS 'Id_articolo', 
		IFNULL(quantità, 0) AS 'Quantità', 
		IFNULL(Codice_fornitore, '') AS 'Codice_fornitore', 
		IFNULL(Unità_misura, '') AS 'Unità_misura', 
		Foto, 
		IFNULL(Prezzo, 0) AS 'Prezzo',
		IFNULL(costo, 0) AS 'Costo', 
		IFNULL(Tempo_installazione, 0) AS 'Tempo_installazione',  
		IFNULL(Prezzo_h, 0) AS 'Prezzo_h',
		IFNULL(costo_h, 0) AS 'Costo_h',
		IFNULL(Desc_brev, '') AS 'Desc_brev', 
		IFNULL(Listino, 0) AS 'Listino', 
		IFNULL(Bloccato, false) AS 'Bloccato', 
		IFNULL(Montato, false) AS 'Montato', 
		Tipo, 
		IFNULL(Sconto, 0) AS 'Sconto', 
		IFNULL(iva, 0) AS 'Iva', 
		scontoriga, 
		scontolav, 
		IFNULL(checked, false) AS 'Checked', 
		IFNULL(idnota, 0 ) AS 'IdNota', 
		`Data_ins`,
		`Utente_ins`
	FROM articolo_preventivo
	WHERE Id_preventivo = quote_id 
		and anno = quote_year
		and id_revisione = review_id
		and lotto = lot_id
	ORDER BY Id_tab; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteLotBodyDeleteByLot
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteLotBodyDeleteByLot`(
quote_id INT(11), 
quote_year INT(11), 
review_id INT(11), 
lot_id INT(11)
)
BEGIN

	DELETE FROM articolo_preventivo
	WHERE Id_preventivo = quote_id 
		and anno = quote_year
		and id_revisione = review_id
		and lotto = lot_id; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteLotBodyGetByLot
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteLotBodyGetByLot`(
quote_id INT(11), 
quote_year INT(11), 
review_id INT(11), 
lot_id INT(11)
)
BEGIN

	SELECT 
		Id_preventivo, 
		Anno,
		Id_revisione,
		Lotto,
		Id_tab,
		IFNULL(id_articolo, '') AS 'Id_articolo', 
		IFNULL(quantità, 0) AS 'Quantità', 
		IFNULL(Codice_fornitore, '') AS 'Codice_fornitore', 
		IFNULL(Unità_misura, '') AS 'Unità_misura', 
		Foto, 
		IFNULL(Prezzo, 0) AS 'Prezzo',
		IFNULL(costo, 0) AS 'Costo', 
		IFNULL(Tempo_installazione, 0) AS 'Tempo_installazione',  
		IFNULL(Prezzo_h, 0) AS 'Prezzo_h',
		IFNULL(costo_h, 0) AS 'Costo_h',
		IFNULL(Desc_brev, '') AS 'Desc_brev', 
		IFNULL(Listino, 0) AS 'Listino', 
		Bloccato, 
		Montato, 
		Tipo, 
		IFNULL(Sconto, 0) AS 'Sconto', 
		IFNULL(iva, 0) AS 'Iva', 
		scontoriga, 
		scontolav, 
		checked, 
		IFNULL(idnota, 0 ) AS 'IdNota', 
		`Data_ins`,
		`Utente_ins`
	FROM articolo_preventivo
	WHERE Id_preventivo = quote_id 
		and anno = quote_year
		and id_revisione = review_id
		and lotto = lot_id
	ORDER BY Id_tab; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteLotPdfDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteLotPdfDelete`(
	IN `in_id` INT(11)
)
BEGIN

	DELETE FROM preventivo_lotto_pdf
	WHERE Id = in_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteLotPdfGetByQuoteLot
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteLotPdfGetByQuoteLot`(
	IN `quote_id` INT(11),
	IN `quote_year` INT(11),
	IN `quote_review_id` INT(11),
	IN `lot_position` INT(11)
)
BEGIN
	SELECT
		`id`,
		`id_preventivo`,
		`id_revisione`,
		`anno`,
		`posizione_lotto`,
		`posizione`,
		`filepath`,
		`filename`
	FROM preventivo_lotto_pdf
	WHERE id_preventivo = quote_id
		AND id_revisione = quote_review_id
		AND anno = quote_year
		AND posizione_lotto = lot_position;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteLotPdfGetByQuoteReview
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteLotPdfGetByQuoteReview`(
	IN `quote_id` INT(11),
	IN `quote_year` INT(11),
	IN `quote_review_id` INT(11)
)
BEGIN
	SELECT
		`id`,
		`id_preventivo`,
		`id_revisione`,
		`anno`,
		`posizione_lotto`,
		`posizione`,
		`filepath`,
		`filename`
	FROM preventivo_lotto_pdf
	WHERE id_preventivo = quote_id
		AND id_revisione = quote_review_id
		AND anno = quote_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteLotPdfInsertOrUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteLotPdfInsertOrUpdate`(
	IN `quote_id` INT(11),
	IN `quote_year` INT(11),
	IN `quote_review_id` INT(11),
	IN `lot_position` INT(11),
	IN `in_position` INT(11),
	IN `in_filepath` MEDIUMTEXT,
	IN `in_filename` VARCHAR(250),
	OUT result INT(11)
)
BEGIN

	DECLARE current_id INT(11) DEFAULT NULL;
	
	SELECT id
		INTO current_id
	FROM preventivo_lotto_pdf
	WHERE id_preventivo = quote_id
		AND id_revisione = quote_review_id
		AND anno = quote_year
		AND posizione_lotto = lot_position
		AND posizione = in_position;

	IF current_id IS NULL THEN
		INSERT INTO preventivo_lotto_pdf
		SET id_preventivo = quote_id,
			id_revisione = quote_review_id,
			anno = quote_year,
			posizione_lotto = lot_position,
			posizione = in_position,
			filename = in_filename,
			filepath = in_filepath,
			utente_mod = @USER_ID;
			
		SET current_id = LAST_INSERT_ID(); 
	ELSE
		UPDATE preventivo_lotto_pdf
		SET filename = in_filename,
			filepath = in_filepath,
			utente_mod = @USER_ID
		WHERE id = current_id;
	END IF;

	SET result = current_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteNewReview
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteNewReview`(
	quote_id INT(11), 
	quote_year INT(11), 
	OUT result INT(11)
)
BEGIN

  	DECLARE last_review_id INT(11);
  	DECLARE new_review_id INT(11);
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;

	START TRANSACTION;

	SELECT IFNULL(MAX(id_revisione), 0), IFNULL(MAX(id_revisione)+1, 0)
		INTO last_review_id, new_review_id 
	FROM revisione_preventivo 
	WHERE id_preventivo = quote_id AND anno = quote_year;
	
	if last_review_id = new_review_id THEN
		SET Result = -2; 
	ELSE
	
	
		INSERT INTO revisione_preventivo 
			(id_cliente,destinazione, id_revisione, id_preventivo, anno, data_creazione, data,corpo,cortese,oggetto, nota,tariffa,costo_ora, prezzo_ora, listino, CORPO_rtf) 
		SELECT 
			id_cliente,
			destinazione,
			new_review_id, 
			id_preventivo, 
			anno, 
			NOW(), 
			data,
			corpo,
			cortese,
			oggetto,
			nota,
			tariffa, 
			costo_ora, 
			prezzo_ora, 
			listino, 
			corpo_rtf 
		FROM revisione_preventivo 
		WHERE id_revisione = last_review_id AND id_preventivo = quote_id AND anno = quote_year;
	
	  	UPDATE preventivo 
		SET revisione = new_review_id
	   WHERE id_preventivo = quote_id AND anno = quote_year;
	
	  	INSERT INTO preventivo_lotto
			(id_lotto, anno, id_revisione, id_preventivo,posizione, nota, id_impianto, id_abbo,scon,ora_p,ora_c,optional,iv_lot) 
	  	SELECT 
		  id_lotto, 
		  anno,
		  new_review_id,
	     id_preventivo,
		  posizione, 
		  nota, 
		  id_impianto, 
		  id_abbo,
		  scon,
		  ora_p,
		  ora_c,
		  optional,
		  iv_lot  
		FROM preventivo_lotto 
		WHERE id_revisione = last_review_id AND id_preventivo = quote_id AND anno = quote_year;
	
		INSERT INTO lotto_esclusioni
			(id_lotto, id_revisione, id_preventivo, anno, id_esclusione) 
		SELECT 
			id_lotto,
			new_review_id,
			id_preventivo, 
			anno, 
			id_esclusione 
		FROM lotto_esclusioni 
		WHERE id_revisione = last_review_id AND id_preventivo = quote_id AND anno = quote_year;
	
		INSERT INTO articolo_preventivo 
			(id_preventivo, id_revisione, anno,lotto, id_tab, prezzo, costo,sconto, quantità,
			 costo_h, prezzo_h,desc_brev, codice_fornitore, id_articolo, tempo_installazione, listino,
			 montato,bloccato, tipo,unità_misura,scontoriga,scontolav,idnota,iva, Utente_ins) 
		SELECT id_preventivo,
	    	new_review_id, 
			anno,
			lotto,
			id_tab, 
			prezzo, 
			costo,
			sconto,
			quantità,
			costo_h, 
			prezzo_h, 
			desc_brev,
			codice_fornitore,
			articolo_preventivo.id_articolo, 
			tempo_installazione, 
			listino,
			montato,
			bloccato, 
			tipo,
			unità_misura,
			scontoriga,
			scontolav,
			idnota,
			iva, 
			@USER_ID 
		FROM articolo_preventivo 
	    WHERE id_revisione = last_review_id  AND id_preventivo = quote_id AND anno = quote_year;
	
		INSERT INTO preventivo_impianto
			(id_preventivo, anno, revisione, impianto)
		SELECT 
			id_preventivo, 
			anno,
			new_review_id,
			impianto 
		FROM  preventivo_impianto 
		WHERE revisione = last_review_id AND id_preventivo = quote_id  AND anno = quote_year; 

		

		INSERT INTO preventivo_lotto_pdf (
			Id_preventivo, id_revisione, anno, posizione_lotto, posizione, filepath, filename, utente_mod
		)
		SELECT
			Id_preventivo, new_review_id, anno, posizione_lotto, posizione, filepath, filename, @USER_ID
		FROM preventivo_lotto_pdf 
		WHERE Id_preventivo = quote_id 
			AND Anno = quote_year
			AND id_revisione = last_review_id;
		
		UPDATE Preventivo 
		SET stato = 5 
		WHERE id_preventivo = quote_id AND anno = quote_year;
	
		SET Result = new_review_id;
		
	END IF; 
	
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = -1; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteReviewGetByQuote
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteReviewGetByQuote`(
	quote_id INT(11),
	quote_year INT(11)
)
BEGIN
	SELECT `Id_revisione`,
		`Id_preventivo`,
		`Stampato`,
		`Inviato`,
		`data_creazione`,
		`data`,
		`Anno`,
		`Listino`,
		`Sconto_perc`,
		`Prezzo_ora`,
		`costo_ora`,
		`aliquota`,
		`corpo`,
		`cortese`,
		`oggetto`,
		`nota`,
		`tariffa`,
		`sitoin`,
		`Id_riferimento`,
		`id_cliente`,
		`destinazione`,
		`ric_tip`,
		`ric_perc`,
		`corpo_rtf`
	FROM revisione_preventivo
	WHERE id_preventivo = quote_id AND anno = quote_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteSettingsDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteSettingsDelete`()
BEGIN
	DELETE FROM preventivo_impost;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteSettingsGet
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteSettingsGet`()
BEGIN
	SELECT tipo,
		valore
	FROM preventivo_impost;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesQuoteSettingsGetByKey
DELIMITER //
CREATE PROCEDURE `sp_ariesQuoteSettingsGetByKey`(
 IN in_key VARCHAR(100)
)
BEGIN
	SELECT tipo,
		valore
	FROM preventivo_impost
	WHERE tipo = in_key;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReceivedDdtGetByCodeAndDate
DELIMITER //
CREATE PROCEDURE `sp_ariesReceivedDdtGetByCodeAndDate`(
	IN ext_code VARCHAR(20), 
	IN ddt_date DATE
)
BEGIN
	SELECT 	
		`Id_ddt`,
		`anno`,
		`id_cliente`,
		`id_fornitore`,
		`Id_destinazione`,
		`condizione_pagamento`,
		`Porto_resa`,
		`data_documento`,
		`Vettore`,
		`data_ora_ritiro`,
		`data_ora_inizio`,
		`trasport_a_cura`,
		`Causale`,
		`Fattura`,
		`Anno_fattura`,
		`colli`,
		`Peso`,
		`Nota`,
		`Descrizione`,
		`id_principale`,
		`impianto`,
		`scan`,
		`destinazione_forn`,
		`principale_forn`,
		`numero_ddt`,
		`id_utente`
	FROM ddt_ricevuti
	WHERE numero_ddt = ext_code AND data_documento = ddt_date;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesRegionDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesRegionDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM Regione 
	WHERE id_Regione = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesRegionGet
DELIMITER //
CREATE PROCEDURE `sp_ariesRegionGet`( 
)
BEGIN
	SELECT Id_Regione,
	Nome,
	Nazione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Regione
	ORDER BY Id_Regione;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesRegionGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesRegionGetById`( 
	Region_id INT
)
BEGIN
	SELECT Id_Regione,
	Nome,
	Nazione,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Regione
	WHERE Id_Regione = Region_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesRegionGetByName
DELIMITER //
CREATE PROCEDURE `sp_ariesRegionGetByName`( 
	name VARCHAR(30)
)
BEGIN
	SELECT Id_Regione,
	Nome,
	Nazione,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Regione
	WHERE Nome = name;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesRegionInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesRegionInsert`( 
	name VARCHAR(30),
	country INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Nazione 
	WHERE id_nazione = country; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM Regione 
		WHERE Nome = Name; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Region name already exists
		END IF;
	ELSE
		SET Result = -2; # country not found
	END IF;
	
	IF Result = 0 THEN
		INSERT INTO Regione 
		SET 
			Nome = name,
			Nazione = country, 
			Data_ins = NOW(), 
			Data_mod = NOW(),
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesRegionUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesRegionUpdate`( 
	enter_id INTEGER,
	name VARCHAR(30),
	country INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Nazione 
	WHERE id_nazione = country; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM Regione 
		WHERE Nome = Name AND Id_regione != enter_id; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Region name already exists
		END IF;
	ELSE
		SET Result = -2; # country not found
	END IF;
	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM Regione 
			WHERE id_Regione = enter_id;
			
			IF Result = 0 THEN
				SET Result = -3; # Region ID not found							
			END IF; 
	END IF; 
	
	IF Result > 0 THEN
		UPDATE Regione 
		SET 
			Nome = name,
			Nazione = country, 
			Utente_mod = @USER_ID
		Where id_Regione = enter_id;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportAttachmentDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesReportAttachmentDelete`(IN in_id INT(11))
BEGIN
	DECLARE report_id INT(11);
	DECLARE report_year INT(11);

	SELECT id_rapporto, anno_rapporto INTO report_id, report_year
	FROM rapporto_allegati
	WHERE id = in_id;

	UPDATE rapporto
	SET numero_allegati = numero_allegati - 1
	WHERE id_rapporto = report_id AND anno = report_year;

	DELETE FROM rapporto_allegati
	WHERE id = in_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportAttachmentGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesReportAttachmentGetById`(IN in_id INT(11))
BEGIN
	SELECT *
	FROM rapporto_allegati
	WHERE id = in_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportAttachmentGetByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesReportAttachmentGetByReport`(IN report_id INT(11), IN report_year INT(11))
BEGIN
	SELECT *
	FROM rapporto_allegati
	WHERE id_rapporto = report_id AND anno_rapporto = report_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportAttachmentRename
DELIMITER //
CREATE PROCEDURE `sp_ariesReportAttachmentRename`(IN in_id INT(11), IN in_file_name VARCHAR(500), IN in_file_path VARCHAR(500))
BEGIN
	UPDATE rapporto_allegati
	SET file_name = in_file_name,
		file_path = in_file_path
	WHERE id = in_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportChangeScanStatusByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesReportChangeScanStatusByIdAndYear`(
	report_id INT(11),
	report_year INT(11), 
	scan_status BIT(1), 
	OUT result  TINYINT
)
BEGIN
	SET result = 1; 

	UPDATE rapporto 
	SET	
		scan = scan_status
	WHERE id_rapporto = report_id AND anno = report_year;

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportChangeYear
DELIMITER //
CREATE PROCEDURE `sp_ariesReportChangeYear`(
	old_report_id INT(11),
	old_report_year INT(11), 
	new_report_year INT(11), 
	OUT result  INT(11)
)
BEGIN
		
	DECLARE id_rapp INT;
	DECLARE id_rapp_mobile INT;
	
	DECLARE new_report_id INT;
	
	DECLARE job_id INT;
	DECLARE job_year INT; 
	DECLARE job_lot_id INT;

	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;

	START TRANSACTION; 
	SET result = 1; 

	-- check next report id
	SELECT IFNULL(MAX(a.id_rapporto)+1, 1) INTO id_rapp 
	from rapporto as a 
	where anno=new_report_year;
	
	SELECT IFNULL(max(a.id_rapporto)+1, 1) INTO id_rapp_mobile 
	from rapporto_mobile as a 
	where anno=new_report_year;
	
	if id_rapp>id_rapp_mobile then
	 set new_report_id=id_rapp;
	else
	 set new_report_id=id_rapp_mobile;
	end if;
	
	SET result = new_report_id;
	
	SELECT
		Id_commessa, anno_commessa, id_lotto 
		INTO
		job_id, job_year, job_lot_id
	FROM commessa_rapporto 
	WHERE id_rapporto = old_report_id AND anno_rapporto = old_report_year;

	IF job_id IS NOT NULL THEN
		DELETE FROM commessa_rapporto 
		WHERE id_rapporto = old_report_id AND anno_rapporto = old_report_year;
	END IF; 

	UPDATE rapporto 
	SET id_rapporto = new_report_id, 
		anno = new_report_year, 
		numero =  REPLACE(numero, CONCAT(old_report_id, ''), CONCAT(new_report_id, ''))
	WHERE id_rapporto = old_report_id AND anno = old_report_year;

	IF job_id IS NOT NULL THEN
		INSERT INTO commessa_rapporto (Id_commessa, anno_commessa, id_lotto, id_rapporto, anno_rapporto)
		VALUES (job_id, job_year, job_lot_id, new_report_id, new_report_year);
	END IF; 
	
	
	UPDATE rapporto_tecnico 
	SET id_rapporto = new_report_id, 
		anno = new_report_year
	WHERE id_rapporto = old_report_id AND anno = old_report_year;

	UPDATE rapporto_tecnico_lavoro 
	SET id_rapporto = new_report_id, 
		anno = new_report_year
	WHERE id_rapporto = old_report_id AND anno = old_report_year;

	UPDATE rapporto_materiale 
	SET id_rapporto = new_report_id, 
		anno = new_report_year
	WHERE id_rapporto = old_report_id AND anno = old_report_year;

	UPDATE impianto_reperibilita 
	SET id_rapporto = new_report_id, 
		anno = new_report_year
	WHERE id_rapporto = old_report_id AND anno = old_report_year;
	

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyActivityGet
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyActivityGet`(
)
BEGIN

	SELECT `id`,
		`Id_rapporto_giornaliero`,
		`tipo_lavoro`,
		`descrizione_lavoro`,
		`ora_inizio`,
		`ora_fine`,
		`note`,
		`data_ins`,
		 IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_mod,
		`utente_ins`,
		`utente_mod`	
	FROM rapporto_giornaliero_attivita;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyActivityGetByEmployeeAndDate
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyActivityGetByEmployeeAndDate`(
	employee_id INT(11), 
	exec_date DATETIME
)
BEGIN

	SELECT rapporto_giornaliero_attivita.`id`,
		`Id_rapporto_giornaliero`,
		`tipo_lavoro`,
		`descrizione_lavoro`,
		`ora_inizio`,
		`ora_fine`,
		rapporto_giornaliero_attivita.`note`,
		rapporto_giornaliero_attivita.`data_ins`,
		 IFNULL(rapporto_giornaliero_attivita.Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_mod,
		rapporto_giornaliero_attivita.`utente_ins`,
		rapporto_giornaliero_attivita.`utente_mod`	
	FROM rapporto_giornaliero_attivita
		INNER JOIN rapporto_giornaliero 
			ON rapporto_giornaliero_attivita.Id_rapporto_giornaliero = rapporto_giornaliero.Id 
			AND id_operaio = employee_id AND data_rapporto = exec_date
	ORDER BY ora_inizio DESC; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyActivityGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyActivityGetById`(
 enter_id INT(11)
)
BEGIN

	SELECT `id`,
		`Id_rapporto_giornaliero`,
		`tipo_lavoro`,
		`descrizione_lavoro`,
		`ora_inizio`,
		`ora_fine`,
		`note`,
		`data_ins`,
		 IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_mod,
		`utente_ins`,
		`utente_mod`	
	FROM rapporto_giornaliero_attivita
	WHERE id = enter_id;
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyActivityGetByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyActivityGetByReport`(
	report_daily_id INT(11)
)
BEGIN

	SELECT `id`,
		`Id_rapporto_giornaliero`,
		`tipo_lavoro`,
		`descrizione_lavoro`,
		`ora_inizio`,
		`ora_fine`,
		`note`,
		`data_ins`,
		 IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_mod,
		`utente_ins`,
		`utente_mod`	
	FROM rapporto_giornaliero_attivita
	WHERE Id_rapporto_giornaliero = report_daily_id
	ORDER BY ora_inizio DESC; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyActivitySetNote
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyActivitySetNote`(
	enter_id INT(11),
	note TEXT
)
BEGIN

	UPDATE rapporto_giornaliero_attivita
	SET note = note
	WHERE id = enter_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyActivityTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyActivityTypeGetById`(
	activity_type_id INT(11)
)
BEGIN

	SELECT `id`,
		`Nome`	
	FROM rapporto_giornaliero_tipo_attivita
	WHERE id = activity_type_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyCountNotSeen
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyCountNotSeen`(
)
BEGIN

	SELECT COUNT(visionato) 
	FROM rapporto_giornaliero
	WHERE visionato = false; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyDeleteById
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyDeleteById`(
	enter_id INT(11)
)
BEGIN

	DELETE FROM rapporto_giornaliero_attivita
	WHERE Id_rapporto_giornaliero  = enter_id; 

	DELETE FROM rapporto_giornaliero
	WHERE id = enter_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyGet
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyGet`(
)
BEGIN

	SELECT `id`,
		`id_operaio`,
		`data_rapporto`,
		`stampato`,
		`visionato`,
		`note`,
		`data_ins`,
		 IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_mod,
		`utente_ins`,
		`utente_mod`	
	FROM rapporto_giornaliero
	ORDER BY visionato ASC, data_rapporto desc; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailyGetWithFilter
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailyGetWithFilter`(
	start_date DATE, 
	end_date DATE,
	employee_id INT(11)
)
BEGIN

		-- extract reports by filter
	DROP TABLE IF EXISTS tmp_report_daily_get_by_filter;
	CREATE TEMPORARY TABLE tmp_report_daily_get_by_filter
	SELECT `id`,
		`id_operaio`,
		`data_rapporto`,
		`stampato`,
		`visionato`,
		`note`,
		`data_ins`,
		 IFNULL(Data_mod, CAST("1970-01-01 00:00:00" AS DATETIME) ) AS Data_mod,
		`utente_ins`,
		`utente_mod`	
	FROM rapporto_giornaliero
	WHERE (data_rapporto BETWEEN start_date AND end_date)
	ORDER BY visionato ASC, data_rapporto desc; 

	
	IF employee_id IS NOT NULL AND employee_id != 0 THEN
		DELETE FROM tmp_report_daily_get_by_filter 
		WHERE id_operaio != employee_id; 
	END IF; 

	SELECT * 
	FROM tmp_report_daily_get_by_filter;
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailySetNote
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailySetNote`(
	enter_id INT(11),
	note TEXT
)
BEGIN

	UPDATE rapporto_giornaliero
	SET note = note
	WHERE id = enter_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailySetPrintStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailySetPrintStatus`(
	enter_id INT(11),
	status BIT
)
BEGIN

	UPDATE rapporto_giornaliero
	SET stampato = status
	WHERE id = enter_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDailySetSeenStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDailySetSeenStatus`(
	enter_id INT(11),
	status BIT
)
BEGIN

	UPDATE rapporto_giornaliero
	SET visionato = status
	WHERE id = enter_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportDeleteByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesReportDeleteByIdAndYear`(
	report_id INT(11),
	report_year INT(11), 
	OUT result  TINYINT
)
BEGIN

 
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION; 
	
	SET result = 1; 
	
	DELETE FROM rapporto_tecnico 
	WHERE id_rapporto = report_id AND anno = report_year;

	DELETE FROM rapporto_tecnico_lavoro 
	WHERE id_rapporto = report_id AND anno = report_year;

	DELETE FROM commessa_rapporto
	WHERE id_rapporto = report_id AND anno_rapporto = report_year;

	DELETE FROM rapporto_materiale 
	WHERE id_rapporto = report_id AND anno = report_year;

	DELETE FROM impianto_reperibilita 
	WHERE id_rapporto = report_id AND anno = report_year;
	
	DELETE FROM rapporto 
	WHERE id_rapporto = report_id AND anno = report_year;

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGet
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGet`(
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico, 
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc
	LIMIT 1000;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetByCustomerId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetByCustomerId`(
	customer_id INT(11)
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico, 
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	WHERE Id_cliente = customer_id
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetByCustomerIdAndDate
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetByCustomerIdAndDate`(
	customer_id INT(11), 
	exec_date DATE
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico, 
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	WHERE Id_cliente = customer_id AND data_esecuzione = exec_date
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetByIdAndYear`(
	report_id INT(11),
	report_year INT(11)
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico, 
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	WHERE Id_rapporto = report_id AND anno = report_year;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetByInterventionType
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetByInterventionType`( 
	type INT(11)
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico, 
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	WHERE tipo_intervento = type
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetByInvoiceId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetByInvoiceId`( 
enter_id INT, 
enter_year INT
)
BEGIN
        
	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico, 
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	WHERE Fattura = enter_id AND Anno_fattura = enter_year
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetByReportNumber
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetByReportNumber`(
	report_number VARCHAR(45)
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente,
		Id_tipo_rapporto, 
		filename_firma_cliente,
		filename_firma_tecnico,
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	WHERE numero = report_number
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetByStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetByStatus`( 
	status INT(11)
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico,
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	WHERE stato = status
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetBySystemId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetBySystemId`(
	system_id INT(11)
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		filename_firma_cliente,
		filename_firma_tecnico,
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati,
		Id_tipo_rapporto
	FROM rapporto
	WHERE Id_impianto = system_id
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetByYear
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetByYear`(
	report_year INT(11)
)
BEGIN

	SELECT 
		Id, 
		Id_rapporto,
		Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico,
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto
	WHERE anno = report_year
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGetNotInvoicedByJob
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGetNotInvoicedByJob`( 
job_id INT, 
job_year INT,
sub_job_id INT, 
job_lot_id INT
)
BEGIN
         
	SELECT 
		Id, 
		r.Id_rapporto,
		r.Anno,
		IFNULL(Id_impianto, 0) Id_impianto,
		IFNULL(Id_cliente, 0) Id_cliente,
		id_destinazione,
		IFNULL(fattura, 0) Fattura,
		IFNULL(anno_fattura, 0) anno_fattura,
		IFNULL(Id_utente, 0) id_utente,
		Data,
		IFNULL(dest_cli,0) dest_cli,
		IFNULL(Richiesto, "") Richiesto,
		IFNULL(Mansione, "") Mansione,
		IFNULL(Responsabile, "") Responsabile,
		Tipo_intervento,
		Diritto_chiamata,
		tipo_diritto_chiamata,
		relazione,
		Terminato,
		CAST(Funzionante AS UNSIGNED) Funzionante,
		stato,
		Note_generali,
		abbonamento,
		Totale,
		Nr_rapporto,
		Data_esecuzione,
		Costo,
		scan,
		controllo_periodico,
		controllo_periodico_costo,
		controllo_periodico_quantita,
		numero,
		prima,
		cost_lav,
		prez_lav,
		appunti,
		firma1,
		firma2,
		firma3, 
		Id_tipo_sorgente, 
		Id_tipo_rapporto,
		filename_firma_cliente,
		filename_firma_tecnico, 
		usa_firma_su_ddt, 
		filename_firma_per_ddt,
		numero_allegati
	FROM rapporto r
		INNER JOIN commessa_rapporto cr
			ON r.id_rapporto = cr.id_rapporto AND r.anno = cr.anno_rapporto
			AND cr.id_commessa = job_id AND cr.anno_commessa = job_year
			AND cr.id_sottocommessa = sub_job_id AND IF(job_lot_id = -1, True, cr.id_lotto = job_lot_id)
	WHERE Fattura IS NULL OR Fattura = 0;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupConfigsGet
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupConfigsGet`()
BEGIN
	SELECT
		id,
		abbonamento,
		impianto,
		ticket,
		titolo,
		testo,
		ordine,
		lavorazione,
		mail,
		spese,
		stampa_desc_estesa
	FROM configurazione_resoconto
	ORDER BY id Desc
	LIMIT 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupConfigsInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupConfigsInsert`(
	subscription INT(11), 
	system INT(11), 
	ticket INT(11), 
	title TEXT,
	end_text TEXT, 
	order_text TEXT, 
	email_text TEXT,
	manufacture  INT(11), 
	expenses TINYINT(11), 
	print_desc_ext BIT(1), 
	out result INT(11)
)
BEGIN
	INSERT INTO configurazione_resoconto
	SET 
		abbonamento = subscription,
		impianto = system,
		ticket = ticket,
		titolo = title,
		testo = end_text,
		ordine = order_text,
		lavorazione = manufacture,
		mail = email_text,
		spese = expenses,
		stampa_desc_estesa = print_desc_ext;
	
	SET Result = LAST_INSERT_ID(); 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupConfigsUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupConfigsUpdate`(
	enter_id INT(11),
	subscription INT(11), 
	system INT(11), 
	ticket INT(11), 
	title TEXT,
	end_text TEXT, 
	order_text TEXT, 
	email_text TEXT,
	manufacture INT(11), 
	expenses TINYINT(11), 
	print_desc_ext BIT(1), 
	out result INT(11)
)
BEGIN
	UPDATE configurazione_resoconto
	SET 
		abbonamento = subscription,
		impianto = system,
		ticket = ticket,
		titolo = title,
		testo = end_text,
		ordine = order_text,
		lavorazione = manufacture,
		mail = email_text,
		spese = expenses,
		stampa_desc_estesa = print_desc_ext
	WHERE Id = enter_id;
	
	SET Result = 1; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupDeleteByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupDeleteByIdAndYear`(
	enter_id INT(11),
	enter_year INT(11), 
	OUT result  TINYINT
)
BEGIN

	SET result = 0; 
	
	DELETE FROM resoconto 
	WHERE id_resoconto = enter_id AND anno = enter_year;

	SET result = 1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupGetByInvoice`(
	IN invoice_id INT(11), 
	IN invoice_year INT(11)
)
BEGIN

	SELECT `id_resoconto`,
		`anno`,
		`data`,
		`Descrizione`,
		`Numero_ordine`,
		`Id_cliente`,
		`stato`,
		`Nota`,
		`fattura`,
		`anno_fattura`,
		`id_utente`,
		`tipo_resoconto`,
		`inviato`,
		`nota_fine`,
		`stm`,
		`fat_SpeseRap`,
		resoconto.costo_extra,
		resoconto.prezzo_extra
	FROM resoconto
	WHERE fattura = invoice_id
		AND anno_fattura = invoice_year;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupGetForProductsPrint
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupGetForProductsPrint`(
	reportGroupId INTEGER, 
	reportGroupYear INTEGER, 
	orderClauses TINYINT
)
BEGIN


  	IF(orderClauses = 0) THEN -- NONE
  		SELECT vw_reportgroupproducts.id_resoconto, 
		  			vw_reportgroupproducts.anno_reso, 
					vw_reportgroupproducts.Id_rapporto,
					vw_reportgroupproducts.anno, 
					vw_reportgroupproducts.Id_materiale,
					articolo.Codice_fornitore,
					marca.Nome as Marca,
					vw_reportgroupproducts.descrizione descrizione_articolo, 
					vw_reportgroupproducts.`quantità`,
					vw_reportgroupproducts.Prezzo,
					vw_reportgroupproducts.Costo, 
					vw_reportgroupproducts.Sconto,
					(vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) Prezzo_scontato, 
					CAST((vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) * vw_reportgroupproducts.`quantità` AS DECIMAL(11,2)) Prezzo_tot_scontato,
					vw_reportgroupproducts.id_magazzino, 
					vw_reportgroupproducts.id_tab, 
					vw_reportgroupproducts.tipo, 
					vw_reportgroupproducts.qeconomia,
					impianto.id_impianto, 
					impianto.Descrizione Descrizione_impianto,
					vw_reportgroupproducts.unita_misura
  		FROm vw_reportgroupproducts
  			LEFT JOIN articolo 
			  ON vw_reportgroupproducts.id_materiale = articolo.Codice_articolo
			LEFT JOIN marca 
				ON articolo.Marca = marca.Id_marca
			INNER JOIN rapporto 
				ON rapporto.Id_rapporto = vw_reportgroupproducts.Id_rapporto
				AND rapporto.anno = vw_reportgroupproducts.anno
			LEFT JOIN Impianto 
				ON rapporto.Id_Impianto = Impianto.Id_Impianto
		WHERE vw_reportgroupproducts.id_resoconto = reportGroupId 
			AND vw_reportgroupproducts.anno_reso = reportGroupYear;
				
	ELSEIF (orderClauses = 1) THEN -- Product Code
	
  		SELECT vw_reportgroupproducts.id_resoconto, 
		  			vw_reportgroupproducts.anno_reso, 
					vw_reportgroupproducts.Id_rapporto,
					vw_reportgroupproducts.anno, 
					vw_reportgroupproducts.Id_materiale,
					articolo.Codice_fornitore,
					marca.Nome as Marca,
					vw_reportgroupproducts.descrizione descrizione_articolo, 
					vw_reportgroupproducts.`quantità`,
					vw_reportgroupproducts.Prezzo,
					vw_reportgroupproducts.Costo, 
					vw_reportgroupproducts.Sconto,
					(vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) Prezzo_scontato, 
					CAST((vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) * vw_reportgroupproducts.`quantità` AS DECIMAL(11,2)) Prezzo_tot_scontato,
					vw_reportgroupproducts.id_magazzino, 
					vw_reportgroupproducts.id_tab, 
					vw_reportgroupproducts.tipo, 
					vw_reportgroupproducts.qeconomia,
					impianto.id_impianto, 
					impianto.Descrizione Descrizione_impianto,
					vw_reportgroupproducts.unita_misura
					
  		FROm vw_reportgroupproducts
  			LEFT JOIN articolo 
			  ON vw_reportgroupproducts.id_materiale = articolo.Codice_articolo
			LEFT JOIN marca 
				ON articolo.Marca = marca.Id_marca
			INNER JOIN rapporto 
				ON rapporto.Id_rapporto = vw_reportgroupproducts.Id_rapporto
				AND rapporto.anno = vw_reportgroupproducts.anno
			LEFT JOIN Impianto 
				ON rapporto.Id_Impianto = Impianto.Id_Impianto
		WHERE vw_reportgroupproducts.id_resoconto = reportGroupId 
			AND vw_reportgroupproducts.anno_reso = reportGroupYear
		ORDER BY vw_reportgroupproducts.Id_materiale;
		
	ELSEIF (orderClauses = 2) THEN -- Supplier Code
	 
  		SELECT vw_reportgroupproducts.id_resoconto, 
		  			vw_reportgroupproducts.anno_reso, 
					vw_reportgroupproducts.Id_rapporto,
					vw_reportgroupproducts.anno, 
					vw_reportgroupproducts.Id_materiale,
					articolo.Codice_fornitore,
					marca.Nome as Marca,
					vw_reportgroupproducts.descrizione descrizione_articolo, 
					vw_reportgroupproducts.`quantità`,
					vw_reportgroupproducts.Prezzo,
					vw_reportgroupproducts.Costo, 
					vw_reportgroupproducts.Sconto,
					(vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) Prezzo_scontato, 
					CAST((vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) * vw_reportgroupproducts.`quantità` AS DECIMAL(11,2)) Prezzo_tot_scontato,
					vw_reportgroupproducts.id_magazzino, 
					vw_reportgroupproducts.id_tab, 
					vw_reportgroupproducts.tipo, 
					vw_reportgroupproducts.qeconomia,
					impianto.id_impianto, 
					impianto.Descrizione Descrizione_impianto,
					vw_reportgroupproducts.unita_misura
					
  		FROm vw_reportgroupproducts
  			LEFT JOIN articolo 
			  ON vw_reportgroupproducts.id_materiale = articolo.Codice_articolo
			LEFT JOIN marca 
				ON articolo.Marca = marca.Id_marca
			INNER JOIN rapporto 
				ON rapporto.Id_rapporto = vw_reportgroupproducts.Id_rapporto
				AND rapporto.anno = vw_reportgroupproducts.anno
			LEFT JOIN Impianto 
				ON rapporto.Id_Impianto = Impianto.Id_Impianto
		WHERE vw_reportgroupproducts.id_resoconto = reportGroupId 
			AND vw_reportgroupproducts.anno_reso = reportGroupYear
		ORDER BY articolo.Codice_fornitore;
		
	ELSEIF (orderClauses = 3) THEN -- BRAND

  		SELECT vw_reportgroupproducts.id_resoconto, 
		  			vw_reportgroupproducts.anno_reso, 
					vw_reportgroupproducts.Id_rapporto,
					vw_reportgroupproducts.anno, 
					vw_reportgroupproducts.Id_materiale,
					articolo.Codice_fornitore,
					marca.Nome as Marca,
					vw_reportgroupproducts.descrizione descrizione_articolo, 
					vw_reportgroupproducts.`quantità`,
					vw_reportgroupproducts.Prezzo,
					vw_reportgroupproducts.Costo, 
					vw_reportgroupproducts.Sconto,
					(vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) Prezzo_scontato, 
					CAST((vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) * vw_reportgroupproducts.`quantità` AS DECIMAL(11,2)) Prezzo_tot_scontato,
					vw_reportgroupproducts.id_magazzino, 
					vw_reportgroupproducts.id_tab, 
					vw_reportgroupproducts.tipo, 
					vw_reportgroupproducts.qeconomia,
					impianto.id_impianto, 
					impianto.Descrizione Descrizione_impianto,
					vw_reportgroupproducts.unita_misura
					
  		FROm vw_reportgroupproducts
  			LEFT JOIN articolo 
			  ON vw_reportgroupproducts.id_materiale = articolo.Codice_articolo
			LEFT JOIN marca 
				ON articolo.Marca = marca.Id_marca
			INNER JOIN rapporto 
				ON rapporto.Id_rapporto = vw_reportgroupproducts.Id_rapporto
				AND rapporto.anno = vw_reportgroupproducts.anno
			LEFT JOIN Impianto 
				ON rapporto.Id_Impianto = Impianto.Id_Impianto
		WHERE vw_reportgroupproducts.id_resoconto = reportGroupId 
			AND vw_reportgroupproducts.anno_reso = reportGroupYear
		ORDER BY marca.Nome, vw_reportgroupproducts.Id_materiale;

	ELSE -- Description
	
	  		SELECT vw_reportgroupproducts.id_resoconto, 
		  			vw_reportgroupproducts.anno_reso, 
					vw_reportgroupproducts.Id_rapporto,
					vw_reportgroupproducts.anno, 
					vw_reportgroupproducts.Id_materiale,
					articolo.Codice_fornitore,
					marca.Nome as Marca,
					vw_reportgroupproducts.descrizione descrizione_articolo, 
					vw_reportgroupproducts.`quantità`,
					vw_reportgroupproducts.Prezzo,
					vw_reportgroupproducts.Costo, 
					vw_reportgroupproducts.Sconto,
					(vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) Prezzo_scontato, 
					CAST((vw_reportgroupproducts.Prezzo + CAST(vw_reportgroupproducts.Prezzo/100*vw_reportgroupproducts.Sconto AS DECIMAL(11,2))) * vw_reportgroupproducts.`quantità` AS DECIMAL(11,2)) Prezzo_tot_scontato,
					vw_reportgroupproducts.id_magazzino, 
					vw_reportgroupproducts.id_tab, 
					vw_reportgroupproducts.tipo, 
					vw_reportgroupproducts.qeconomia,
					impianto.id_impianto, 
					impianto.Descrizione Descrizione_impianto,
					vw_reportgroupproducts.unita_misura
					
  		FROm vw_reportgroupproducts
  			LEFT JOIN articolo 
			  ON vw_reportgroupproducts.id_materiale = articolo.Codice_articolo
			LEFT JOIN marca 
				ON articolo.Marca = marca.Id_marca
			INNER JOIN rapporto 
				ON rapporto.Id_rapporto = vw_reportgroupproducts.Id_rapporto
				AND rapporto.anno = vw_reportgroupproducts.anno
			LEFT JOIN Impianto 
				ON rapporto.Id_Impianto = Impianto.Id_Impianto
		WHERE vw_reportgroupproducts.id_resoconto = reportGroupId 
			AND vw_reportgroupproducts.anno_reso = reportGroupYear
		ORDER BY vw_reportgroupproducts.descrizione, vw_reportgroupproducts.Id_materiale;
	
  	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupGetSingle
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupGetSingle`(
	IN enter_id INT(11), 
	IN enter_year INT(11)
)
BEGIN

	SELECT `id_resoconto`,
		`anno`,
		`data`,
		`Descrizione`,
		`Numero_ordine`,
		`Id_cliente`,
		`stato`,
		`Nota`,
		`fattura`,
		`anno_fattura`,
		`id_utente`,
		`tipo_resoconto`,
		`inviato`,
		`nota_fine`,
		`stm`,
		`fat_SpeseRap`,
		resoconto.costo_extra,
		resoconto.prezzo_extra
	FROM resoconto
	WHERE id_resoconto = enter_id
		AND anno = enter_year;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupSearch
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupSearch`(
	product_txt VARCHAR(200), 
	customer_name VARCHAR(200), 
	doc_id INT(11), 
	doc_year INT(11), 
	customer_id INT(11), 
	description TEXT,
	notes TEXT, 
	status INT(11), 
	doc_date DATETIME, 
	doc_type INT(11),
	final_note TEXT
)
BEGIN
	DECLARE has_product BIT; 
	SET has_product = product_txt <> '' AND product_txt IS NOT NULL; 	

	DROP TABLE IF EXISTS tmp_resoconto_con_articoli;
	
	CREATE TEMPORARY TABLE tmp_resoconto_con_articoli (
		id_resoconto INT(11),
		anno_reso INT(11)
	);
	
	IF has_product THEN
		INSERT INTO tmp_resoconto_con_articoli 
		SELECT DISTINCT id_resoconto, 
			anno_reso
		FROM resoconto_rapporto
			INNER JOIN rapporto_materiale 
			ON resoconto_rapporto.id_rapporto = rapporto_materiale.Id_rapporto 
				AND resoconto_rapporto.anno = rapporto_materiale.anno
			LEFT JOIN articolo 
				ON articolo.Codice_articolo = rapporto_materiale.Id_materiale
		WHERE rapporto_materiale.Id_materiale LIKE CONCAT('%', product_txt, '%')
			OR rapporto_materiale.descrizione LIKE CONCAT('%', product_txt, '%')
			OR articolo.Codice_fornitore LIKE CONCAT('%', product_txt, '%');
	ELSE
		INSERT INTO tmp_resoconto_con_articoli 
		SELECT id_resoconto, 
			anno
		FROM resoconto;
	END IF; 
	
	SELECT resoconto.id_resoconto AS "ID", 
		data, 
		resoconto.descrizione, 
		clienti.ragione_sociale AS "Cliente", 
		nota, tipo_resoconto, 
		tipo_resoconto.nome AS "tipo", 
		stato AS "Stato", 
		resoconto.anno, anno_fattura, 
		Inviato, 
		nota_fine,
		stm AS "Stampato",
		colore,
		fat_speseRap,
		resoconto_totali.costo_totale,
		resoconto_totali.prezzo_totale
	FROM resoconto 
		INNER JOIN tipo_resoconto ON id_tipo = resoconto.tipo_resoconto 
		INNER JOIN clienti ON resoconto.id_cliente=clienti.id_cliente 
		INNER JOIN stato_resoconto ON stato_resoconto.id_stato = resoconto.stato
		INNER JOIN resoconto_totali
			ON resoconto_totali.id_resoconto = resoconto.id_resoconto 
				AND resoconto_totali.anno = resoconto.anno
		INNER JOIN tmp_resoconto_con_articoli 
			ON tmp_resoconto_con_articoli.id_resoconto = resoconto.id_resoconto 
				AND tmp_resoconto_con_articoli.anno_reso = resoconto.anno
	WHERE
		clienti.ragione_sociale LIKE CONCAT('%', IFNULL(customer_name, ''), '%')
		AND IF(doc_id IS NULL, true, resoconto.id_resoconto) = IFNULL(doc_id, true) 
		AND IF(doc_year IS NULL, true, resoconto.anno) = IFNULL(doc_year, true) 
		AND IF(customer_id IS NULL, true, resoconto.id_cliente) = IFNULL(customer_id, true) 
		AND resoconto.descrizione LIKE CONCAT('%', IFNULL(description, ''), '%')
		AND resoconto.nota LIKE CONCAT('%', IFNULL(notes, ''), '%') 
		AND IF(status IS NULL, true, resoconto.stato) = IFNULL(status, true) 
		AND IF(doc_date IS NULL, true, resoconto.data) = IFNULL(doc_date, true) 
		AND IF(doc_type IS NULL, true, resoconto.tipo_resoconto) = IFNULL(doc_type, true) 
		AND (resoconto.nota_fine LIKE CONCAT('%', IFNULL(final_note, ''), '%') OR final_note IS NULL)
	ORDER BY anno desc,id Desc;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupTotalsGetByReportGroup
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupTotalsGetByReportGroup`(
	IN report_group_id INT(11),
	IN report_group_year INT(11)
)
BEGIN
	SELECT id,
		id_resoconto,
		anno,
		prezzo_manutenzione,
		costo_manutenzione,
		costo_diritto_chiamata,
		prezzo_diritto_chiamata,
		costo_lavoro,
		prezzo_lavoro,
		costo_viaggio,
		prezzo_viaggio,
		costo_materiale,
		prezzo_materiale,
		costo_extra,
		prezzo_extra,
		costo_totale,
		prezzo_totale
	FROM resoconto_totali
	WHERE resoconto_totali.id_resoconto = report_group_id AND resoconto_totali.anno = report_group_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupTotalsRefresh
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupTotalsRefresh`(
	IN report_group_id INT(11),
	IN report_group_year INT(11)
)
BEGIN

	DECLARE total_trip_price DECIMAL(11,2);
	DECLARE total_trip_cost DECIMAL(11,2);
	DECLARE total_work_price DECIMAL(11,2);
	DECLARE total_work_cost DECIMAL(11,2);
	DECLARE total_products_price DECIMAL(11,2);
	DECLARE total_products_cost DECIMAL(11,2);
	DECLARE total_price DECIMAL(11,2);
	DECLARE total_cost DECIMAL(11,2);
	DECLARE total_maintenance_price DECIMAL(11,2);
	DECLARE total_maintenance_cost DECIMAL(11,2);
	DECLARE right_of_call_cost DECIMAL(11,2);
	DECLARE right_of_call_price DECIMAL(11,2);
	DECLARE total_extra_price DECIMAL(11,2);
	DECLARE total_extra_cost DECIMAL(11,2);
	DECLARE include_trips BIT(1);

	
	SELECT
		SUM(prezzo_manutenzione),
		SUM(costo_manutenzione),
		SUM(costo_diritto_chiamata),
		SUM(prezzo_diritto_chiamata),
		SUM(costo_lavoro),
		SUM(prezzo_lavoro),
		SUM(costo_viaggio),
		SUM(prezzo_viaggio),
		SUM(costo_materiale),
		SUM(prezzo_materiale),
		SUM(costo_totale),
		SUM(prezzo_totale)
	INTO
		total_maintenance_price,
		total_maintenance_cost,
		right_of_call_cost,
		right_of_call_price,
		total_work_cost,
		total_work_price,
		total_trip_cost,
		total_trip_price,
		total_products_cost,
		total_products_price,
		total_cost,
		total_price
	FROM resoconto_rapporto
		LEFT JOIN rapporto_totali ON resoconto_rapporto.id_rapporto = rapporto_totali.id_rapporto and resoconto_rapporto.anno = rapporto_totali.anno
	WHERE resoconto_rapporto.id_resoconto = report_group_id AND anno_reso = report_group_year;

	SELECT 
		costo_extra,
		prezzo_extra,
		IF(fat_SpeseRap = 0, 0, 1)
	INTO 
		total_extra_cost,
		total_extra_price,
		include_trips
	FROM resoconto
	WHERE id_resoconto = report_group_id AND anno = report_group_year;



	SET total_maintenance_price = IFNULL(total_maintenance_price, 0);
	SET total_maintenance_cost = IFNULL(total_maintenance_cost, 0);
	SET right_of_call_cost = IFNULL(right_of_call_cost, 0);
	SET right_of_call_price = IFNULL(right_of_call_price, 0);
	SET total_work_cost = IFNULL(total_work_cost, 0);
	SET total_work_price = IFNULL(total_work_price, 0);
	SET total_trip_cost = IFNULL(total_trip_cost, 0);
	SET total_trip_price = IFNULL(total_trip_price, 0);
	SET total_products_cost = IFNULL(total_products_cost, 0);
	SET total_products_price = IFNULL(total_products_price, 0);
	SET total_cost = IFNULL(total_cost, 0);
	SET total_price = IFNULL(total_price, 0);

	UPDATE resoconto_totali
	SET 
		prezzo_manutenzione = total_maintenance_price,
		costo_manutenzione = total_maintenance_cost,
		costo_diritto_chiamata = right_of_call_cost,
		prezzo_diritto_chiamata = right_of_call_price,
		costo_lavoro = total_work_cost,
		prezzo_lavoro = total_work_price,
		costo_viaggio = total_trip_cost,
		prezzo_viaggio = IF(include_trips, total_trip_price, 0),
		costo_materiale = total_products_cost,
		prezzo_materiale = total_products_price,
		costo_extra = total_extra_cost,
		prezzo_extra = total_extra_price,
		costo_totale = total_cost + total_extra_cost,
		prezzo_totale = total_price + total_extra_price - IF(include_trips, 0, total_trip_price)
	WHERE resoconto_totali.id_resoconto = report_group_id AND resoconto_totali.anno = report_group_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupTotalsRefreshByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupTotalsRefreshByReport`(
	IN report_id INT(11),
	IN report_year INT(11)
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE report_group_id INT(11);
	DECLARE report_group_year INT(11);
	DECLARE V_curA CURSOR FOR SELECT id_resoconto, anno_reso
		FROM resoconto_rapporto
		WHERE id_rapporto = report_id
			AND anno = report_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
	
	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO report_group_id, report_group_year;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;
		
		CALL sp_ariesReportGroupTotalsRefresh(report_group_id, report_group_year);
	END LOOP;
	CLOSE V_curA;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportGroupTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesReportGroupTypeGetById`(
	type_id INT(11)
)
BEGIN

	SELECT `id_tipo`,
		`Nome`,
		economia,
		ghost
	FROM tipo_resoconto
	WHERE id_tipo = type_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMabileInterventionById
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMabileInterventionById`( 
	report_id INT,
	report_year INT
)
BEGIN
	 SELECT       
          Id_rapporto,       
          Anno,       
          Id_Impianto,       
          id_destinazione,       
          Id_cliente,       
          Richiesto,       
          Mansione,       
          Responsabile,       
          Tipo_intervento,       
          Diritto_chiamata,       
          tipo_diritto_chiamata,       
          relazione,       
          Terminato,       
          CAST(Funzionante AS UNSIGNED) "Funzionante",       
          Stato,       
          Note_Generali,       
          Data,       
          abbonamento,       
          Data_esecuzione,       
          scan,       
          anno_fattura,       
          controllo_periodico,       
          prima,       
          APPUNTI,       
          CAST(notturno AS UNSIGNED) "notturno",       
          CAST(festivo AS UNSIGNED) "festivo",       
          CAST(su_chiamata AS UNSIGNED) "su_chiamata",       
          CAST(eff_giorn AS UNSIGNED) "eff_giorn",       
          CAST(sost AS UNSIGNED) "sost",       
          CAST(ripar AS UNSIGNED) "ripar",       
          CAST(abbon AS UNSIGNED) "abbon",       
          CAST(garanz AS UNSIGNED) "garanz",       
          CAST(man_ordi AS UNSIGNED) "man_ordi",
			     
          CAST(fuoriabbon AS UNSIGNED) "fuoriabbon",       
          CAST(fuorigaranz AS UNSIGNED) "fuorigaranz",       
          CAST(man_straord AS UNSIGNED) "man_straord",   
			   
          tipo_impianto,       
          ragione_sociale,       
          indirizzo,       
          citta,       
          luogo_lavoro,       
          difetto,       
          id_riferimento,       
          da_reperibilita_telefonica, 
		  usa_altra_firma_su_ddt, 
		  filename_firma_per_ddt, 
		  filename_firma_cliente,
		  filename_firma_tecnico,
			numero_allegati           
    FROM rapporto_mobile       
    WHERE id_rapporto = report_id AND anno = report_year;       

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMabileInterventionDeleteById
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMabileInterventionDeleteById`( 
	report_id INT,
	report_year INT,
	OUT Result INT
)
BEGIN

	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Rapporto_mobile 
	WHERE Id_rapporto = report_id AND anno = report_year;  
	
	IF Result = 0 THEN
		SET Result = -2;  
	END IF; 

	IF Result > 0 THEN
		UPDATE rapporto_mobile    
		SET Visionato = 1  
		WHERE Id_rapporto = report_id AND anno = report_year; 
		
		
		SET Result = 1; 
	END IF;     

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMabileInterventionProductByReportId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMabileInterventionProductByReportId`( 
	report_id INT,
	report_year INT
)
BEGIN
	SELECT Id,       
	      codice_articolo,       
	      descrizione,        
	      quantita,       
	      posizione,      
	      id_rapporto,       
	      anno_rapporto       
	
	FROM rapporto_mobile_materiale       
	WHERE Id_rapporto = report_id AND anno_rapporto = report_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMabileInterventionTechnicianByReportId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMabileInterventionTechnicianByReportId`( 
	report_id INT,
	report_year INT
)
BEGIN
  SELECT Id,       
      id_tecnico,       
      tempo_lavorato,        
      km,       
      tempo_viaggio,      
      id_rapporto,       
      anno_rapporto       
  FROM rapporto_mobile_tecnico       
  WHERE Id_rapporto = report_id AND anno_rapporto = report_year; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMabileInterventionTicketByReportId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMabileInterventionTicketByReportId`( 
	report_id INT,
	report_year INT
)
BEGIN
  SELECT Id,       
      id_rapporto,       
      anno_rapporto,        
      id_ticket,       
      anno_ticket       
  FROM rapporto_mobile_ticket       
  WHERE Id_rapporto = report_id AND anno_rapporto = report_year;      

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMabileInterventionWorkByReportId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMabileInterventionWorkByReportId`( 
	report_id INT,
	report_year INT
)
BEGIN
	SELECT id,       
        id_rapporto,       
        anno_rapporto,       
        controllo_periodico,       
        materiale_uso,       
        diritto_chiamata,       
        viaggio_consuntivo,       
        spese,       
        tecnici,       
        totale_ore,       
        extra_consuntivo,       
        extra_testo,       
        extra       
	FROM rapporto_mobile_lavoro       
	WHERE Id_rapporto = report_id AND anno_rapporto = report_year;     

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileInterventionGet
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileInterventionGet`( 

)
BEGIN
	 SELECT      
		  Id, 
          Id_rapporto,       
          Anno,       
          Id_Impianto,       
          id_destinazione,       
          Id_cliente,       
          Richiesto,       
          Mansione,       
          Responsabile,       
          Tipo_intervento,       
          Diritto_chiamata,       
          tipo_diritto_chiamata,       
          relazione,       
          Terminato,       
          CAST(Funzionante AS UNSIGNED) "Funzionante",       
          Stato,       
          Note_Generali,       
          Data,       
          abbonamento,       
          Data_esecuzione,       
          scan,       
          anno_fattura,       
          controllo_periodico,       
          prima,       
          APPUNTI,   
					inviato,
					visionato,    
          CAST(notturno AS UNSIGNED) "notturno",       
          CAST(festivo AS UNSIGNED) "festivo",       
          CAST(su_chiamata AS UNSIGNED) "su_chiamata",       
          CAST(eff_giorn AS UNSIGNED) "eff_giorn",       
          CAST(sost AS UNSIGNED) "sost",       
          CAST(ripar AS UNSIGNED) "ripar",       
          CAST(abbon AS UNSIGNED) "abbon",       
          CAST(garanz AS UNSIGNED) "garanz",       
          CAST(man_ordi AS UNSIGNED) "man_ordi",
			     
          CAST(fuoriabbon AS UNSIGNED) "fuoriabbon",       
          CAST(fuorigaranz AS UNSIGNED) "fuorigaranz",       
          CAST(man_straord AS UNSIGNED) "man_straord",   
			   
          tipo_impianto,       
          ragione_sociale,       
          indirizzo,       
          citta,       
          luogo_lavoro,       
          difetto,       
          id_riferimento,       
          da_reperibilita_telefonica, 
		  usa_altra_firma_su_ddt,
			IFNULL(tipo_rapporto, 0) AS tipo_rapporto,
		  filename_firma_per_ddt, 
		  filename_firma_cliente,
		  filename_firma_tecnico,
			numero_allegati        
    FROM rapporto_mobile
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileInterventionGetByCustomerId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileInterventionGetByCustomerId`( 
	customer_id INT(11)
)
BEGIN
	 SELECT      
		  Id, 
          Id_rapporto,       
          Anno,       
          Id_Impianto,       
          id_destinazione,       
          Id_cliente,       
          Richiesto,       
          Mansione,       
          Responsabile,       
          Tipo_intervento,       
          Diritto_chiamata,       
          tipo_diritto_chiamata,       
          relazione,       
          Terminato,       
          CAST(Funzionante AS UNSIGNED) "Funzionante",       
          Stato,       
          Note_Generali,       
          Data,       
          abbonamento,       
          Data_esecuzione,       
          scan,       
          anno_fattura,       
          controllo_periodico,       
          prima,       
          APPUNTI,    
					inviato,
					visionato,       
          CAST(notturno AS UNSIGNED) "notturno",       
          CAST(festivo AS UNSIGNED) "festivo",       
          CAST(su_chiamata AS UNSIGNED) "su_chiamata",       
          CAST(eff_giorn AS UNSIGNED) "eff_giorn",       
          CAST(sost AS UNSIGNED) "sost",       
          CAST(ripar AS UNSIGNED) "ripar",       
          CAST(abbon AS UNSIGNED) "abbon",       
          CAST(garanz AS UNSIGNED) "garanz",       
          CAST(man_ordi AS UNSIGNED) "man_ordi",
			     
          CAST(fuoriabbon AS UNSIGNED) "fuoriabbon",       
          CAST(fuorigaranz AS UNSIGNED) "fuorigaranz",       
          CAST(man_straord AS UNSIGNED) "man_straord",   
			   
          tipo_impianto,       
          ragione_sociale,       
          indirizzo,       
          citta,       
          luogo_lavoro,       
          difetto,       
          id_riferimento,       
          da_reperibilita_telefonica, 
		  usa_altra_firma_su_ddt, 
		  filename_firma_per_ddt, 
		  filename_firma_cliente,
		  filename_firma_tecnico,
			IFNULL(tipo_rapporto, 0) AS tipo_rapporto,
			numero_allegati              
    FROM rapporto_mobile
	WHERE Id_cliente = customer_id AND visionato = false
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileInterventionGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileInterventionGetById`( 
	report_id INT,
	report_year INT
)
BEGIN
	 SELECT    
		  Id,
          Id_rapporto,       
          Anno,       
          Id_Impianto,       
          id_destinazione,       
          Id_cliente,       
          Richiesto,       
          Mansione,       
          Responsabile,       
          Tipo_intervento,       
          Diritto_chiamata,       
          tipo_diritto_chiamata,       
          relazione,       
          Terminato,       
          CAST(Funzionante AS UNSIGNED) "Funzionante",       
          Stato,       
          Note_Generali,       
          Data,       
          abbonamento,       
          Data_esecuzione,       
          scan,       
          anno_fattura,       
          controllo_periodico,       
          prima,       
          APPUNTI,     
					inviato,
					visionato,      
          CAST(notturno AS UNSIGNED) "notturno",       
          CAST(festivo AS UNSIGNED) "festivo",       
          CAST(su_chiamata AS UNSIGNED) "su_chiamata",       
          CAST(eff_giorn AS UNSIGNED) "eff_giorn",       
          CAST(sost AS UNSIGNED) "sost",       
          CAST(ripar AS UNSIGNED) "ripar",       
          CAST(abbon AS UNSIGNED) "abbon",       
          CAST(garanz AS UNSIGNED) "garanz",       
          CAST(man_ordi AS UNSIGNED) "man_ordi",
			     
          CAST(fuoriabbon AS UNSIGNED) "fuoriabbon",       
          CAST(fuorigaranz AS UNSIGNED) "fuorigaranz",       
          CAST(man_straord AS UNSIGNED) "man_straord",   
			   
          tipo_impianto,       
          ragione_sociale,       
          indirizzo,       
          citta,       
          luogo_lavoro,       
          difetto,       
          id_riferimento,       
          da_reperibilita_telefonica, 
		  usa_altra_firma_su_ddt, 
			IFNULL(tipo_rapporto, 0) AS tipo_rapporto,
		  filename_firma_per_ddt, 
		  filename_firma_cliente,
		  filename_firma_tecnico,
			numero_allegati             
    FROM rapporto_mobile       
    WHERE id_rapporto = report_id AND anno = report_year;       

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileInterventionGetByInterventionType
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileInterventionGetByInterventionType`( 
	type INT(11)
)
BEGIN
	 SELECT      
		  Id, 
          Id_rapporto,       
          Anno,       
          Id_Impianto,       
          id_destinazione,       
          Id_cliente,       
          Richiesto,       
          Mansione,       
          Responsabile,       
          Tipo_intervento,       
          Diritto_chiamata,       
          tipo_diritto_chiamata,       
          relazione,       
          Terminato,       
          CAST(Funzionante AS UNSIGNED) "Funzionante",       
          Stato,       
          Note_Generali,       
          Data,       
          abbonamento,       
          Data_esecuzione,       
          scan,       
          anno_fattura,       
          controllo_periodico,       
          prima,       
          APPUNTI,   
					inviato,
					visionato,        
          CAST(notturno AS UNSIGNED) "notturno",       
          CAST(festivo AS UNSIGNED) "festivo",       
          CAST(su_chiamata AS UNSIGNED) "su_chiamata",       
          CAST(eff_giorn AS UNSIGNED) "eff_giorn",       
          CAST(sost AS UNSIGNED) "sost",       
          CAST(ripar AS UNSIGNED) "ripar",       
          CAST(abbon AS UNSIGNED) "abbon",       
          CAST(garanz AS UNSIGNED) "garanz",       
          CAST(man_ordi AS UNSIGNED) "man_ordi",
			     
          CAST(fuoriabbon AS UNSIGNED) "fuoriabbon",       
          CAST(fuorigaranz AS UNSIGNED) "fuorigaranz",       
          CAST(man_straord AS UNSIGNED) "man_straord",   
			   
          tipo_impianto,       
          ragione_sociale,       
          indirizzo,       
          citta,       
          luogo_lavoro,       
          difetto,       
          id_riferimento,       
          da_reperibilita_telefonica, 
		  usa_altra_firma_su_ddt, 
			IFNULL(tipo_rapporto, 0) AS tipo_rapporto,
		  filename_firma_per_ddt, 
		  filename_firma_cliente,
		  filename_firma_tecnico,
			numero_allegati              
    FROM rapporto_mobile
	WHERE tipo_intervento = type  AND visionato = false
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileInterventionGetByReportNumber
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileInterventionGetByReportNumber`( 
	report_number VARCHAR(45)
)
BEGIN
	 SELECT      
		  Id, 
          Id_rapporto,       
          Anno,       
          Id_Impianto,       
          id_destinazione,       
          Id_cliente,       
          Richiesto,       
          Mansione,       
          Responsabile,       
          Tipo_intervento,       
          Diritto_chiamata,       
          tipo_diritto_chiamata,       
          relazione,       
          Terminato,       
          CAST(Funzionante AS UNSIGNED) "Funzionante",       
          Stato,       
          Note_Generali,       
          Data,       
          abbonamento,       
          Data_esecuzione,       
          scan,       
          anno_fattura,       
          controllo_periodico,       
          prima,       
          APPUNTI,   
					inviato,
					visionato,        
          CAST(notturno AS UNSIGNED) "notturno",       
          CAST(festivo AS UNSIGNED) "festivo",       
          CAST(su_chiamata AS UNSIGNED) "su_chiamata",       
          CAST(eff_giorn AS UNSIGNED) "eff_giorn",       
          CAST(sost AS UNSIGNED) "sost",       
          CAST(ripar AS UNSIGNED) "ripar",       
          CAST(abbon AS UNSIGNED) "abbon",       
          CAST(garanz AS UNSIGNED) "garanz",       
          CAST(man_ordi AS UNSIGNED) "man_ordi",
			     
          CAST(fuoriabbon AS UNSIGNED) "fuoriabbon",       
          CAST(fuorigaranz AS UNSIGNED) "fuorigaranz",       
          CAST(man_straord AS UNSIGNED) "man_straord",   
			   
          tipo_impianto,       
          ragione_sociale,       
          indirizzo,       
          citta,       
          luogo_lavoro,       
          difetto,       
          id_riferimento,       
          da_reperibilita_telefonica, 
		  usa_altra_firma_su_ddt, 
			IFNULL(tipo_rapporto, 0) AS tipo_rapporto,
		  filename_firma_per_ddt, 
		  filename_firma_cliente,
		  filename_firma_tecnico,
			numero_allegati             
    FROM rapporto_mobile
	WHERE numero = report_number  AND visionato = false
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileInterventionGetBySystemId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileInterventionGetBySystemId`( 
	system_id INT(11)
)
BEGIN
	 SELECT      
		  Id, 
          Id_rapporto,       
          Anno,       
          Id_Impianto,       
          id_destinazione,       
          Id_cliente,       
          Richiesto,       
          Mansione,       
          Responsabile,       
          Tipo_intervento,       
          Diritto_chiamata,       
          tipo_diritto_chiamata,       
          relazione,       
          Terminato,       
          CAST(Funzionante AS UNSIGNED) "Funzionante",       
          Stato,       
          Note_Generali,       
          Data,       
          abbonamento,       
          Data_esecuzione,       
          scan,       
          anno_fattura,       
          controllo_periodico,       
          prima,       
          APPUNTI,   
					inviato,
					visionato,        
          CAST(notturno AS UNSIGNED) "notturno",       
          CAST(festivo AS UNSIGNED) "festivo",       
          CAST(su_chiamata AS UNSIGNED) "su_chiamata",       
          CAST(eff_giorn AS UNSIGNED) "eff_giorn",       
          CAST(sost AS UNSIGNED) "sost",       
          CAST(ripar AS UNSIGNED) "ripar",       
          CAST(abbon AS UNSIGNED) "abbon",       
          CAST(garanz AS UNSIGNED) "garanz",       
          CAST(man_ordi AS UNSIGNED) "man_ordi",
			     
          CAST(fuoriabbon AS UNSIGNED) "fuoriabbon",       
          CAST(fuorigaranz AS UNSIGNED) "fuorigaranz",       
          CAST(man_straord AS UNSIGNED) "man_straord",   
			   
          tipo_impianto,       
          ragione_sociale,       
          indirizzo,       
          citta,       
          luogo_lavoro,       
          difetto,       
          id_riferimento,       
          da_reperibilita_telefonica, 
		  usa_altra_firma_su_ddt, 
			IFNULL(tipo_rapporto, 0) AS tipo_rapporto,
		  filename_firma_per_ddt, 
		  filename_firma_cliente,
		  filename_firma_tecnico,
			numero_allegati              
    FROM rapporto_mobile
	WHERE id_impianto = system_id AND visionato = false
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileInterventionGetByViewedStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileInterventionGetByViewedStatus`( 
	viewed_status BIT
)
BEGIN
	 SELECT      
		  Id,
          Id_rapporto,       
          Anno,       
          Id_Impianto,       
          id_destinazione,       
          Id_cliente,       
          Richiesto,       
          Mansione,       
          Responsabile,       
          Tipo_intervento,       
          Diritto_chiamata,       
          tipo_diritto_chiamata,       
          relazione,       
          Terminato,       
          CAST(Funzionante AS UNSIGNED) "Funzionante",       
          Stato,       
          Note_Generali,       
          Data,       
          abbonamento,       
          Data_esecuzione,       
          scan,       
          anno_fattura,       
          controllo_periodico,       
          prima,       
          APPUNTI,   
					inviato,
					visionato,        
          CAST(notturno AS UNSIGNED) "notturno",       
          CAST(festivo AS UNSIGNED) "festivo",       
          CAST(su_chiamata AS UNSIGNED) "su_chiamata",       
          CAST(eff_giorn AS UNSIGNED) "eff_giorn",       
          CAST(sost AS UNSIGNED) "sost",       
          CAST(ripar AS UNSIGNED) "ripar",       
          CAST(abbon AS UNSIGNED) "abbon",       
          CAST(garanz AS UNSIGNED) "garanz",       
          CAST(man_ordi AS UNSIGNED) "man_ordi",
			     
          CAST(fuoriabbon AS UNSIGNED) "fuoriabbon",       
          CAST(fuorigaranz AS UNSIGNED) "fuorigaranz",       
          CAST(man_straord AS UNSIGNED) "man_straord",   
			   
          tipo_impianto,       
          ragione_sociale,       
          indirizzo,       
          citta,       
          luogo_lavoro,       
          difetto,       
          id_riferimento,       
          da_reperibilita_telefonica, 
		  usa_altra_firma_su_ddt, 
			IFNULL(tipo_rapporto, 0) AS tipo_rapporto,
		  filename_firma_per_ddt, 
		  filename_firma_cliente,
		  filename_firma_tecnico,
			numero_allegati		  
    FROM rapporto_mobile
    WHERE rapporto_mobile.visionato = viewed_status
			AND rapporto_mobile.data IS NOT NULL
	ORDER BY anno desc, data_esecuzione desc, Id_rapporto desc;	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileRecipientGet
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileRecipientGet`( 
)
BEGIN

	SELECT rapporto_mobile_destinatario.id,
		rapporto_mobile_destinatario.id_rapporto,
		rapporto_mobile_destinatario.anno, 
		rapporto_mobile_destinatario.email, 
		rapporto_mobile_destinatario.tipo_email,
		rapporto_mobile_destinatario.id_mail,
		mail.data_invio AS data_invio_email,
		mail_stato.nome AS stato_invio_email
	FROM rapporto_mobile_destinatario
		LEFT JOIN mail ON mail.id = rapporto_mobile_destinatario.id_mail
		LEFT JOIN mail_stato ON mail.id_stato = mail_stato.id_stato;
	                        
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportMobileRecipientGetByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesReportMobileRecipientGetByReport`( 
	 IN report_id INT(11), 
	 IN report_year INT(11)
)
BEGIN

	SELECT rapporto_mobile_destinatario.id,
		rapporto_mobile_destinatario.id_rapporto,
		rapporto_mobile_destinatario.anno, 
		rapporto_mobile_destinatario.email, 
		rapporto_mobile_destinatario.tipo_email,
		rapporto_mobile_destinatario.id_mail,
		mail.data_invio AS data_invio_email,
		mail_stato.nome AS stato_invio_email
	FROM rapporto_mobile_destinatario
		LEFT JOIN mail ON mail.id = rapporto_mobile_destinatario.id_mail
		LEFT JOIN mail_stato ON mail.id_stato = mail_stato.id_stato
	WHERE id_rapporto = report_id AND anno = report_year;
	                        
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportProductDeleteByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesReportProductDeleteByReport`(
report_id INT(11), 
report_year INT(11)
)
BEGIN

	DELETE FROM rapporto_materiale
	WHERE Id_rapporto = report_id 
		and anno = report_year; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportProductGetByReport
DELIMITER //
CREATE PROCEDURE `sp_ariesReportProductGetByReport`(
report_id INT(11), 
report_year INT(11)
)
BEGIN

	SELECT 
		Id_rapporto,
		Id_materiale,
		anno,
		IFNULL(quantità, 0) quantità,
		IFNULL(Prezzo, 0) Prezzo,
		IFNULL(costo, 0) costo,
		descrizione,
		IFNULL(sconto, 0) sconto,
		IFNULL(economia, 0) economia,
		IFNULL(id_magazzino, -1) id_magazzino,
		id_tab,
		tipo,
		IFNULL(qeconomia, 0) qeconomia, 
		unita_misura
	FROM rapporto_materiale
	WHERE Id_rapporto = report_id 
		and anno = report_year
	ORDER BY Id_tab; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportRestoreStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesReportRestoreStatus`(
	IN report_id INT(11),
	IN report_year INT(11)
)
main_proc:BEGIN
	DECLARE is_locked_status BIT(1);
	DECLARE invoice_id INT(11);
	DECLARE invoice_year INT(11);
	DECLARE has_job_link BIT(1);
	DECLARE new_status_id INT(11);
	DECLARE status_id INT(11);

	SELECT stato, Fattura, anno_fattura INTO status_id, invoice_id, invoice_year
	FROM Rapporto
	WHERE id_rapporto = report_id AND anno = report_year;

	SELECT bloccato INTO is_locked_status
	FROM stato_rapporto
	WHERE id_stato = status_id;


	IF is_locked_status THEN
		LEAVE main_proc;
	END IF;

	
	
	SELECT fnc_reportHasJobLink(report_id, report_year) INTO has_job_link;

	IF invoice_id > 0 AND invoice_id IS NOT NULL THEN
		IF invoice_year = 0 THEN
			SELECT id_stato INTO new_status_id 
			FROM stato_rapporto
			WHERE nome LIKE "%PREFATTURA"
			LIMIT 1;
		ELSE
			SELECT id_stato INTO new_status_id 
			FROM stato_rapporto
			WHERE nome LIKE "%FATTURATO%"
			LIMIT 1;
		END IF;
	ELSEIF has_job_link THEN
		SELECT id_stato INTO new_status_id 
		FROM stato_rapporto
		WHERE nome LIKE "%COMMESSA%"
		LIMIT 1;
	END IF;


	IF new_status_id IS NULL THEN
		SET new_status_id = 1;
	END IF;
	
	UPDATE rapporto
	SET stato = new_status_id 
	WHERE id_rapporto = report_id AND anno = report_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportSaveSignaturesByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesReportSaveSignaturesByIdAndYear`(
	IN `report_id` INT(11),
	IN `report_year` INT(11),
	IN `first_signature` BIT(1),
	IN `second_signature` BIT(1),
	IN `third_signature` BIT(1), IN `status` INT(11), OUT `result` TINYINT
)
BEGIN
	SET result = 1; 

	UPDATE rapporto 
	SET	
		Firma1 = first_signature, 
		Firma2 = second_signature, 
		Firma3 = third_signature, 
		stato = status
	WHERE id_rapporto = report_id AND anno = report_year;			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportSetInvoiceData
DELIMITER //
CREATE PROCEDURE `sp_ariesReportSetInvoiceData`(
	IN report_id INT(11),
	IN report_year INT(11), 
	IN invoice_id INT(11),
	IN invoice_year INT(11), 
	OUT result  TINYINT
)
BEGIN
	SET result = 1; 

	UPDATE rapporto 
	SET	
		Fattura = invoice_id,
		Anno_fattura = invoice_year
	WHERE id_rapporto = report_id AND anno = report_year;

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportsGenerateDefaultSessionId
DELIMITER //
CREATE PROCEDURE `sp_ariesReportsGenerateDefaultSessionId`(
	OUT result INT(11)
)
BEGIN

	DECLARE supp_date DATE; 
	SET supp_date = DATE_SUB(DATE(now()), INTERVAL  2 day);
	
  DELETE FROM rapporto_tecnico_app WHERE data <= supp_date;
  DELETE FROM rapporto_tecnico_lavoro_app WHERE data <= supp_date;
  DELETE FROM session_rap WHERE data <= supp_date;

  SELECT IFNULL(MAX(id), 0) + 1
		INTO result
	FROM (
		SELECT MAX(id) AS "id" FROM session_rap
		UNION ALL 
		SELECT MAX(id) AS "id" FROM rapporto_tecnico_lavoro_app
		UNION ALL
		SELECT MAX(id) AS "id" FROM rapporto_tecnico_app
	) AS temp;

	INSERT INTO session_rap SET id = result;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesReportTotalsRefresh
DELIMITER //
CREATE PROCEDURE `sp_ariesReportTotalsRefresh`(
	IN report_id INT(11),
	IN report_year INT(11)
)
BEGIN
	DECLARE total_maintenance_price DECIMAL(11,2);
	DECLARE total_maintenance_cost DECIMAL(11,2);
	DECLARE total_trip_price DECIMAL(11,2);
	DECLARE total_trip_cost DECIMAL(11,2);
	DECLARE total_work_price DECIMAL(11,2);
	DECLARE total_work_cost DECIMAL(11,2);
	DECLARE total_products_price DECIMAL(11,2);
	DECLARE total_products_cost DECIMAL(11,2);
	DECLARE total_price DECIMAL(11,2);
	DECLARE total_cost DECIMAL(11,2);
	DECLARE default_hourly_price DECIMAL(11, 2);
	DECLARE default_hourly_cost DECIMAL(11, 2);
	DECLARE default_hourly_cost_extra DECIMAL(11, 2);
	DECLARE default_km_cost DECIMAL(11,2);
	DECLARE right_of_call_chargeable BIT(1);
	DECLARE right_of_call_cost DECIMAL(11,2);
	DECLARE right_of_call_price DECIMAL(11,2);
	DECLARE is_under_warranty BIT(1);
	DECLARE is_price_predefined BIT(1);

	SELECT costo_h, straordinario_c, costo_km, prezzo
		INTO default_hourly_cost, default_hourly_cost_extra, default_km_cost, default_hourly_price
	FROM tariffario
	ORDER BY normale DESC
	LIMIT 1;

	SELECT fnc_reportIsRightOfCallChargeable(report_id, report_year) INTO right_of_call_chargeable;

	IF right_of_call_chargeable THEN
		SELECT
			CAST(
				IFNULL(IF(rapporto.tipo_diritto_chiamata = 1, abbonamento.diritto_chiamata, abbonamento.diritto_chiamata_straordinario), 0)
			AS DECIMAL(10, 2)),
			CAST(
				ROUND(IFNULL(IF(rapporto.tipo_diritto_chiamata = 1, abbonamento.diritto_chiamata, abbonamento.diritto_chiamata_straordinario), 0) / 2, 2)
			AS DECIMAL(10, 2))
		INTO right_of_call_price,
			right_of_call_cost
		FROM rapporto
			LEFT JOIN abbonamento ON id_abbonamento=abbonamento
		WHERE rapporto.id_rapporto = report_id AND rapporto.anno = report_year ;
	ELSE
		SET right_of_call_cost = 0;
		SET right_of_call_price = 0;
	END IF;

	SELECT
		controllo_periodico * controllo_periodico_quantita,
		controllo_periodico_costo * controllo_periodico_quantita
	INTO
		total_maintenance_price,
		total_maintenance_cost
	FROM rapporto
	WHERE id_rapporto = report_id AND anno = report_year;
	

	SELECT SUM(CAST(ROUND(IFNULL(ora_normale, 0) * (totale / 60), 2) AS DECIMAL(10, 2))) as 'prezzo_lavoro',
		SUM(CAST(ROUND(IF(straordinario = 1, IFNULL(straordinario_c, default_hourly_cost_extra), IFNULL(costo_h, default_hourly_cost)) * (totale / 60), 2) AS DECIMAL(10, 2))) as 'costo_lavoro'
		INTO total_work_price, total_work_cost
	FROM rapporto_tecnico_lavoro
		INNER JOIN operaio ON operaio.Id_operaio = rapporto_tecnico_lavoro.tecnico
		LEFT JOIN tariffario ON operaio.Tariffario = tariffario.Id_tariffario
	WHERE id_rapporto = report_id AND anno = report_year
	GROUP BY id_rapporto, anno;


	SELECT SUM(CAST(ROUND((km * IFNULL(costo_km, default_km_cost)) + autostrada + parcheggio + spesa_trasferta + altro + (CAST(Tempo_viaggio/ 60 AS DECIMAL(11,2)) * IFNULL(costo_h, default_hourly_cost)), 2) AS DECIMAL(11,2))) as costo_viaggio,
		SUM(CAST(ROUND((km * IFNULL(IFNULL(prezzo_strada, costo_km), default_km_cost)) + autostrada + parcheggio + spesa_trasferta + altro + (CAST(Tempo_viaggio/ 60 AS DECIMAL(11,2)) *  IFNULL(IFNULL(abbonamento.ora_normale, prezzo), default_hourly_price)), 2) AS DECIMAL(11,2))) as prezzo_viaggio
		INTO total_trip_cost, total_trip_price
	FROM rapporto_tecnico
		INNER JOIN operaio ON operaio.Id_operaio = rapporto_tecnico.tecnico
		LEFT JOIN tariffario ON operaio.Tariffario = tariffario.Id_tariffario
		INNER JOIN rapporto ON rapporto.id_rapporto=rapporto_tecnico.id_rapporto AND rapporto.anno=rapporto_tecnico.anno
		LEFT JOIN abbonamento ON id_abbonamento=abbonamento
	WHERE rapporto_tecnico.id_rapporto = report_id AND rapporto_tecnico.anno = report_year
	GROUP BY rapporto_tecnico.id_rapporto, rapporto_tecnico.anno;

	SELECT SUM(CAST(ROUND(ROUND(IFNULL(prezzo, 0) * (100 - IFNULL(sconto, 0)) / 100, 2) * IFNULL(quantità, 0), 2)  AS DECIMAL(11, 2))) as Prezzo_materiale,
		SUM(CAST(ROUND(ROUND(IFNULL(costo, 0), 2) * IFNULL(quantità, 0), 2)  AS DECIMAL(11, 2))) as Costo_materiale
		INTO total_products_price,
		total_products_cost
	FROM rapporto_materiale
	WHERE id_rapporto = report_id AND anno = report_year
	GROUP BY id_rapporto, anno;

	SET total_work_cost = IFNULL(total_work_cost, 0);
	SET total_work_price = IFNULL(total_work_price, 0);
	SET total_trip_cost = IFNULL(total_trip_cost, 0);
	SET total_trip_price = IFNULL(total_trip_price, 0);
	SET total_products_cost = IFNULL(total_products_cost, 0);
	SET total_products_price = IFNULL(total_products_price, 0);
	SET right_of_call_cost = IFNULL(right_of_call_cost, 0);
	SET right_of_call_price = IFNULL(right_of_call_price, 0);
	SET total_maintenance_price = IFNULL(total_maintenance_price, 0);
	SET total_maintenance_cost = IFNULL(total_maintenance_cost, 0);
	SET total_cost = total_products_cost  + IF(total_maintenance_cost > 0 AND total_work_cost + total_trip_cost = 0, total_maintenance_cost, total_work_cost + total_trip_cost + right_of_call_cost);
	SET total_price = total_products_price + IF(total_maintenance_price > 0, total_maintenance_price, total_trip_price + total_work_price  + right_of_call_price);

	UPDATE rapporto_totali
	SET 
			prezzo_manutenzione = total_maintenance_price,
			costo_manutenzione = total_maintenance_cost,
			prezzo_diritto_chiamata = right_of_call_price,
			costo_diritto_chiamata = right_of_call_cost,
			costo_lavoro = total_work_cost,
			prezzo_lavoro = total_work_price,
			costo_viaggio = total_trip_cost,
			prezzo_viaggio = total_trip_price,
			costo_materiale = total_products_cost,
			prezzo_materiale = total_products_price,
			costo_totale = total_cost,
			prezzo_totale = total_price
	WHERE id_rapporto = report_id AND anno = report_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertConfigUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertConfigUpdate`( 
	IN service_id INT(11), 
	IN folder_name VARCHAR(100),
	IN interval_type SMALLINT(6), 
	IN interval_value INT(11),
	IN months_number SMALLINT(6),
	IN email_subject VARCHAR(150), 
	IN email_body TEXT,
	OUT result INTEGER
)
BEGIN

	UPDATE servizio_alert_configurazione
	SET
		`Cartella` = folder_name,
		`Tipo_intervallo` = interval_type,
		`Valore` = interval_value,
		`Numero_mesi` = months_number,
		`Oggetto_email` = email_subject,
		`Corpo_email` = email_body
	WHERE Id = service_id;
	
	SET result = 1; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertConfigurationGet
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertConfigurationGet`(
)
BEGIN
	SELECT `Id`,
		`Nome`,
		`Cartella`,
		`Tipo_intervallo`,
		`Valore`,
		Numero_mesi,
		Oggetto_email, 
		Corpo_email,
		Data_ultima_esecuzione,
		`Data_mod`,
		`Utente_mod`
	FROM servizio_alert_configurazione;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertGeneralConfigInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertGeneralConfigInsert`( 
	IN `in_email_host` VARCHAR(50),
	IN `in_email_username` VARCHAR(50),
	IN `in_email_password` VARCHAR(50),
	IN `in_email_port` INT(11),
	IN `in_email_ssl` BIT(1),
	IN `in_email_from` VARCHAR(50),
	OUT result INTEGER
)
BEGIN

	SET result = 0;

	INSERT INTO servizio_alert_configurazione_generale
	SET
		`Email_host` = in_email_host,
		`Email_username` = in_email_username,
		`Email_password` = in_email_password,
		`Email_port` = in_email_port,
		`Email_ssl` = in_email_ssl,
		`Email_from` = in_email_from,
		`Data_ins` = NOW(),  
		Utente_ins = @USER_ID;
	
	SET Result = LAST_INSERT_ID();

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertGeneralConfigUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertGeneralConfigUpdate`( 
	IN `in_email_host` VARCHAR(50),
	IN `in_email_username` VARCHAR(50),
	IN `in_email_password` VARCHAR(50),
	IN `in_email_port` INT(11),
	IN `in_email_ssl` BIT(1),
	IN `in_email_from` VARCHAR(50),
	IN In_id INT(11),
	OUT result INTEGER
)
BEGIN

	UPDATE servizio_alert_configurazione_generale
	SET
		`Email_host` = in_email_host,
		`Email_username` = in_email_username,
		`Email_password` = in_email_password,
		`Email_port` = in_email_port,
		`Email_ssl` = in_email_ssl,
		`Email_from` = in_email_from, 
		`Data_ins` = NOW(),  
		Utente_ins = @USER_ID
	WHERE Id = In_id;
	
	SET result = 1; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertGeneralConfigurationGetLast
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertGeneralConfigurationGetLast`(
)
BEGIN
	SELECT
		`Id`,
		`Email_host`,
		`Email_username`,
		`Email_password`,
		`Email_port`,
		`Email_ssl`,
		Email_from,
		`Data_ins`,
		`Utente_ins`
	FROM servizio_alert_configurazione_generale
	ORDER BY Id DESC
	LIMIT 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertRecipientDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertRecipientDelete`(
	IN in_id INT(11), 
	OUT result INTEGER
)
BEGIN
	DELETE FROM servizio_alert_ricevente
	WHERE Id = in_id;
	
	SET result = 1; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertRecipientGetByService
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertRecipientGetByService`(
	IN service_id INT(11)
)
BEGIN
	SELECT
		`Id`,
		`Id_servizio`,
		`Email`,
		`Data_ins`,
		`Utente_ins` 
	FROM servizio_alert_ricevente
	WHERE Id_servizio = service_id
	ORDER BY Email;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertRecipientInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertRecipientInsert`(
	IN in_email VARCHAR(50), 
	IN service_id INT(11), 
	OUT result INTEGER
)
BEGIN
	SET result = 0;

	SELECT COUNT(Id)
		INTO
		result
	FROM servizio_alert_ricevente
	WHERE Id_servizio = service_id AND Email = in_email;
	
	IF result = 0 THEN
		INSERT INTO servizio_alert_ricevente
		SET Id_servizio = service_id, 
			Email = in_email,
			Data_ins = NOW(), 
			Utente_ins = @USER_ID;
			
		SET Result = LAST_INSERT_ID();
	ELSE
		SET result = -1;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceAlertRecipientUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceAlertRecipientUpdate`(
	IN in_id INT(11),
	IN in_email VARCHAR(50), 
	IN service_id INT(11), 
	OUT result INTEGER
)
BEGIN

	UPDATE servizio_alert_ricevente
	SET Id_servizio = service_id, 
		Email = in_email
	WHERE Id = in_id;
	
	SET result = 1; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesServiceUserGetByAppName
DELIMITER //
CREATE PROCEDURE `sp_ariesServiceUserGetByAppName`(
	record_app_name VARCHAR(60)
)
BEGIN

	SELECT
		`id`,
		`nome`,
		`app_name`,
		`email`,
		`firma`,
		`smtp`,
		`porta`,
		`mssl`,
		`email_username`,
		`email_password`,
		`display_name`
	FROM utente_servizio
	WHERE utente_servizio.app_name = record_app_name; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSubJobDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesSubJobDelete`(
	job_id INT, job_year INT, sub_job_id INT
)
BEGIN
	DELETE FROM commessa_fattura
	WHERE id_commessa = job_id
		AND anno_commessa = job_year
		AND id_sottocommessa = sub_job_id;
	
	DELETE FROM commessa_rapporto
	WHERE id_commessa = job_id
		AND anno_commessa = job_year
		AND id_sottocommessa = sub_job_id;
	
	DELETE FROM commessa_ddt
	WHERE id_commessa = job_id
		AND anno_commessa = job_year
		AND id_sottocommessa = sub_job_id;
	
	DELETE FROM commessa_ddtr
	WHERE id_commessa = job_id
		AND anno_commessa = job_year
		AND id_sottocommessa = sub_job_id;
	
	UPDATE preventivo p
	INNER JOIN commessa_preventivo cp
		ON p.id_preventivo = cp.preventivo AND p.anno = cp.anno_prev
			AND cp.id_commessa = job_id AND cp.anno = job_year
			AND cp.id_sottocommessa = sub_job_id
	SET stato = 1;
	
	DELETE FROM commessa_preventivo
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_sottocommessa = sub_job_id;
	
	DELETE FROM commessa_articoli
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_sottocommessa = sub_job_id;
	
	DELETE FROM commessa_lotto
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_sottocommessa = sub_job_id;

	DELETE FROM commessa_sotto
	WHERE id_commessa = job_id
		AND anno = job_year
		AND id_sotto = sub_job_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSubJobGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesSubJobGetById`(
	IN job_id INT(11),
	IN job_year INT(11),
	IN sub_job_id INT(11)
)
BEGIN
	SELECT
		`id_sotto`,
		`id_commessa`,
		`anno`,
		`destinazione`,
		`descrizione`,
		`scadenza`,
		`inizio`,
		`fine`,
		`numero`,
		`codice`,
		`stato`,
		`nome`
	FROM commessa_sotto
	WHERE id_commessa = job_id AND anno = job_year AND id_sotto = sub_job_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSubJobGetByJob
DELIMITER //
CREATE PROCEDURE `sp_ariesSubJobGetByJob`(
	IN job_id INT(11),
	IN job_year INT(11)
)
BEGIN
	SELECT
		`id_sotto`,
		`id_commessa`,
		`anno`,
		`destinazione`,
		`descrizione`,
		`scadenza`,
		`inizio`,
		`fine`,
		`numero`,
		`codice`,
		`stato`,
		`nome`
	FROM commessa_sotto
	WHERE id_commessa = job_id AND anno = job_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierContactsGet
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierContactsGet`()
BEGIN
	SELECT 
		`Id_fornitore`,
		Id_pubblico,
		`Id_riferimento`,
		`Nome`,
		`figura`,
		`Telefono`,
		`altro_telefono`,
		`telefono2`,
		`fax`,
		`mail`,
		`centralino`,
		`fatturazione`,
		`nota`,
		`titolo`,
		`esterno`,
		`sito`,
		`skype`,
		`rif_esterno`,
		`sito_utente`,
		`sito_passwd`,
		`mail_pec`
	FROM riferimento_fornitore;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierContactsGetByEmailGroupToSend
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierContactsGetByEmailGroupToSend`(
	IN email_group_id INT(11), 
	IN email_id INT(11)
)
BEGIN

	SELECT 
		riferimento_fornitore.Id_fornitore, 
		riferimento_fornitore.Id_riferimento, 
		riferimento_fornitore.Nome, 
		`figura`,
		`Telefono`,
		`altro_telefono`,
		`telefono2`,
		`fax`,
		`mail`,
		`centralino`,
		`fatturazione`,
		`nota`,
		`titolo`,
		`esterno`,
		`sito`,
		`skype`,
		`rif_esterno`,
		`sito_utente`,
		`sito_passwd`,
		`mail_pec`
	FROM mail_gruppo_fornitore
		INNER JOIN riferimento_fornitore ON mail_gruppo_fornitore.id_fornitore = riferimento_fornitore.id_fornitore
			AND mail_gruppo_fornitore.Id_riferimento = riferimento_fornitore.Id_riferimento
			
		LEFT JOIN mail_gruppo_inviate_fornitore ON mail_gruppo_inviate_fornitore.id_mail = email_id
			AND mail_gruppo_fornitore.id_fornitore = mail_gruppo_inviate_fornitore.id_fornitore
			AND mail_gruppo_fornitore.Id_riferimento = mail_gruppo_inviate_fornitore.Id_riferimento	
				
	WHERE mail_gruppo_fornitore.id_gruppo = email_group_id AND mail_gruppo_inviate_fornitore.stato IS NULL; 
		
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierContactsGetBySupplierId
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierContactsGetBySupplierId`(
	IN supplier_id INT
)
BEGIN
	SELECT  
		`Id_fornitore`,
		Id_pubblico,
		`Id_riferimento`,
		`Nome`,
		`figura`,
		`Telefono`,
		`altro_telefono`,
		`telefono2`,
		`fax`,
		`mail`,
		`centralino`,
		`fatturazione`,
		`nota`,
		`titolo`,
		`esterno`,
		`sito`,
		`skype`,
		`rif_esterno`,
		`sito_utente`,
		`sito_passwd`,
		`mail_pec`
	FROM riferimento_fornitore
	WHERE Id_fornitore = supplier_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierContactsGetBySupplierIdAndContactsId
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierContactsGetBySupplierIdAndContactsId`(
	IN supplier_id INT,
	IN contacts_id INT
)
BEGIN
	SELECT  
		`Id_fornitore`,
		Id_pubblico,
		`Id_riferimento`,
		`Nome`,
		`figura`,
		`Telefono`,
		`altro_telefono`,
		`telefono2`,
		`fax`,
		`mail`,
		`centralino`,
		`fatturazione`,
		`nota`,
		`titolo`,
		`esterno`,
		`sito`,
		`skype`,
		`rif_esterno`,
		`sito_utente`,
		`sito_passwd`,
		`mail_pec`
	FROM riferimento_fornitore
	WHERE Id_fornitore = supplier_id AND Id_riferimento = contacts_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierContactsGetBySupplierIds
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierContactsGetBySupplierIds`(
	IN supplier_ids MEDIUMTEXT
)
BEGIN

	SELECT 
		`Id_fornitore`,
		Id_pubblico,
		`Id_riferimento`,
		`Nome`,
		`figura`,
		`Telefono`,
		`altro_telefono`,
		`telefono2`,
		`fax`,
		`mail`,
		`centralino`,
		`fatturazione`,
		`nota`,
		`titolo`,
		`esterno`,
		`sito`,
		`skype`,
		`rif_esterno`,
		`sito_utente`,
		`sito_passwd`,
		`mail_pec`
	FROM riferimento_fornitore
	WHERE FIND_IN_SET(Id_fornitore, supplier_ids) > 0;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierDestinationGet
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierDestinationGet`()
BEGIN
	SELECT 
	`id_fornitore`,
	`Id_destinazione`,
	`Provincia`,
	`Comune`,
	`Frazione`,
	`Indirizzo`,
	`numero_civico`,
	`Descrizione`,
	`scala`,
	`Altro`,
	`attivo`,
	`Note`,
	`Sede_principale`,
	`piano`,
	`interno`,
	`fcap`,
	`id_autostrada`
	FROM destinazione_fornitore;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierDestinationGetBySupplierId
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierDestinationGetBySupplierId`(
	IN supplier_id INT
)
BEGIN
	SELECT 
	`id_fornitore`,
	`Id_destinazione`,
	`Provincia`,
	`Comune`,
	`Frazione`,
	`Indirizzo`,
	`numero_civico`,
	`Descrizione`,
	`scala`,
	`Altro`,
	`attivo`,
	`Note`,
	`Sede_principale`,
	`piano`,
	`interno`,
	`fcap`,
	`id_autostrada`
	FROM destinazione_fornitore
	WHERE Id_fornitore = supplier_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierDestinationGetBySupplierIdAndContactsId
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierDestinationGetBySupplierIdAndContactsId`(
	IN supplier_id INT,
	IN contacts_id INT
)
BEGIN
	SELECT 
	`id_fornitore`,
	`Id_destinazione`,
	`Provincia`,
	`Comune`,
	`Frazione`,
	`Indirizzo`,
	`numero_civico`,
	`Descrizione`,
	`scala`,
	`Altro`,
	`attivo`,
	`Note`,
	`Sede_principale`,
	`piano`,
	`interno`,
	`fcap`,
	`id_autostrada`
	FROM destinazione_fornitore
	WHERE Id_fornitore = supplier_id AND Id_riferimento = contacts_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierDestinationGetBySupplierIds
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierDestinationGetBySupplierIds`(
	IN supplier_ids MEDIUMTEXT
)
BEGIN

	SELECT 
	`id_fornitore`,
	`Id_destinazione`,
	`Provincia`,
	`Comune`,
	`Frazione`,
	`Indirizzo`,
	`numero_civico`,
	`Descrizione`,
	`scala`,
	`Altro`,
	`attivo`,
	`Note`,
	`Sede_principale`,
	`piano`,
	`interno`,
	`fcap`,
	`id_autostrada`
	FROM destinazione_fornitore
	WHERE FIND_IN_SET(Id_fornitore, supplier_ids) > 0;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierGetByCompanyName
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierGetByCompanyName`(
	company_name VARCHAR(100)
)
BEGIN

	SELECT
		`Id_fornitore`,
		`Ragione_Sociale`,
		`Ragione_Sociale2`,
		`Partita_iva`,
		`Codice_Fiscale`,
		`Data_inserimento`,
		`Stato_Fornitore`,
		`stato_economico`,
		`condizione_pagamento`,
		`Sito_internet`,
		`password`,
		`Utente_sito`,
		`iva`,
		`tipo_fornitore`,
		`modi`,
		`id_tiporapp`,
		`id_utente`,
		`costruttore`,
		`id_attività`,
		`cod_fornitore`
	FROM fornitore
	WHERE Ragione_sociale = company_name 
		OR Ragione_sociale2 = company_name;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierGetById`(
	enter_id INT(11)
)
BEGIN

	SELECT
		`Id_fornitore`,
		`Ragione_Sociale`,
		`Ragione_Sociale2`,
		`Partita_iva`,
		`Codice_Fiscale`,
		`Data_inserimento`,
		`Stato_Fornitore`,
		`stato_economico`,
		`condizione_pagamento`,
		`Sito_internet`,
		`password`,
		`Utente_sito`,
		`iva`,
		`tipo_fornitore`,
		`modi`,
		`id_tiporapp`,
		`id_utente`,
		`costruttore`,
		`id_attività`,
		`cod_fornitore`
	FROM fornitore
	WHERE Id_fornitore = enter_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierGetByVatNumber
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierGetByVatNumber`(
	vat_number VARCHAR(50)
)
BEGIN

	SELECT
		`Id_fornitore`,
		`Ragione_Sociale`,
		`Ragione_Sociale2`,
		`Partita_iva`,
		`Codice_Fiscale`,
		`Data_inserimento`,
		`Stato_Fornitore`,
		`stato_economico`,
		`condizione_pagamento`,
		`Sito_internet`,
		`password`,
		`Utente_sito`,
		`iva`,
		`tipo_fornitore`,
		`modi`,
		`id_tiporapp`,
		`id_utente`,
		`costruttore`,
		`id_attività`,
		`cod_fornitore`
	FROM fornitore
	WHERE Partita_iva = vat_number;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierGroupEmailSentGet
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierGroupEmailSentGet`()
BEGIN
	SELECT 
		Id_mail, 
		Id_riferimento, 
		id_fornitore, 
		Stato, 
		IFNULL(Codice_errore, 0) Codice_errore,
		Messaggio_errore, 
		Timestamp
	FROM mail_gruppo_inviate;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierGroupEmailSentGetByEmailId
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierGroupEmailSentGetByEmailId`(
	IN email_id INT(11) 
)
BEGIN
	SELECT 
		Id_mail, 
		Id_riferimento, 
		id_fornitore, 
		Stato, 
		IFNULL(Codice_errore, 0) Codice_errore,
		Messaggio_errore, 
		Timestamp
	FROM mail_gruppo_inviate_fornitore
	WHERE Id_mail = email_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierGroupEmailSentInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierGroupEmailSentInsert`(
	IN email_id INT(11), 
	IN contact_id INT(11), 
	IN supplier_id INT(11), 
	IN is_sent BIT(1), 
	IN error_code INT(11), 
	IN error_message VARCHAR(200), 
	OUT result SMALLINT
)
BEGIN

	
	INSERT INTO mail_gruppo_inviate_fornitore
	SET
		Id_mail = email_id, 
		Id_riferimento = contact_id, 
		id_fornitore = supplier_id, 
		Stato = is_sent, 
		Codice_errore = error_code,
		Messaggio_errore = error_message;
		
	SET result = 1; 	
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoiceAttachsGetByInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoiceAttachsGetByInvoice`(
	IN invoice_id INT(11), 
	IN invoice_year INT(11)
)
BEGIN
	SELECT
		`id`,
		`id_fattura`,
		`Anno_fattura`,
		`Nome` ,
		`Descrizione`,
		`Formato`,
		`Algoritmo`,
		`File_path`,
		`Timestamp`
	FROM fornfattura_allegati
	WHERE id_fattura = invoice_id AND Anno_fattura = invoice_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoiceDeleteByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoiceDeleteByIdAndYear`(
	IN enter_id INT(11), 
	IN enter_year INT(11),
	OUT Result INT(11)
)
BEGIN

	DELETE FROM fornfattura
	WHERE Id_fattura = enter_id AND anno = enter_year;
	
	SET Result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoiceGet
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoiceGet`(

)
BEGIN

	SELECT
		`Id_fattura`,
		`anno`,
		`id_fornitore`,
		`Data_registrazione`,
		`data_modifica`,
		`data`,
		`cond_pagamento`,
		`annotazioni`,
		`Stato`,
		`causale_fattura`,
		`nota_interna`,
		`tipo_fattura`,
		`incasso`,
		`bollo`,
		`trasporto`,
		`ricevuto`,
		`pagato_il`,
		`tramite`,
		`insoluto`,
		`fattura_fornitore`,
		`totale`,
		`totiva`,
		`scan`,
		`modifica`,
		`id_attività`,
		`iva_incasso`,
		`iva_bollo`,
		`aliquota_iva_BTI`,
		`formato_trasmissione`,
		`progressivo_invio`,
		`codice_destinatario`,
		`pec_destinatario`,
		tipo_fattura_elettronica,
		sorgente_documento,
		e_fattura_filename,
		movimenta_magazzino
	FROM fornfattura;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoiceGetByExternalId
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoiceGetByExternalId`(
	IN external_id VARCHAR(150),
	IN invoice_year VARCHAR(150),
	IN supplier_id VARCHAR(150)
)
BEGIN

	SELECT
		`Id_fattura`,
		`anno`,
		`id_fornitore`,
		`Data_registrazione`,
		`data_modifica`,
		`data`,
		`cond_pagamento`,
		`annotazioni`,
		`Stato`,
		`causale_fattura`,
		`nota_interna`,
		`tipo_fattura`,
		`incasso`,
		`bollo`,
		`trasporto`,
		`ricevuto`,
		`pagato_il`,
		`tramite`,
		`insoluto`,
		`fattura_fornitore`,
		`totale`,
		`totiva`,
		`scan`,
		`modifica`,
		`id_attività`,
		`iva_incasso`,
		`iva_bollo`,
		`aliquota_iva_BTI`,
		`formato_trasmissione`,
		`progressivo_invio`,
		`codice_destinatario`,
		`pec_destinatario`,
		tipo_fattura_elettronica,
		sorgente_documento,
		e_fattura_filename,
		movimenta_magazzino
	FROM fornfattura
	WHERE fornfattura.fattura_fornitore = external_id AND fornfattura.anno = invoice_year AND fornfattura.id_fornitore = IF(supplier_id > 0, supplier_id, fornfattura.id_fornitore) ;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoiceGetByIdAndYear
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoiceGetByIdAndYear`(
	IN enter_id INT(11), 
	IN enter_year INT(11)
)
BEGIN

	SELECT
		`Id_fattura`,
		`anno`,
		`id_fornitore`,
		`Data_registrazione`,
		`data_modifica`,
		`data`,
		`cond_pagamento`,
		`annotazioni`,
		`Stato`,
		`causale_fattura`,
		`nota_interna`,
		`tipo_fattura`,
		`incasso`,
		`bollo`,
		`trasporto`,
		`ricevuto`,
		`pagato_il`,
		`tramite`,
		`insoluto`,
		`fattura_fornitore`,
		`totale`,
		`totiva`,
		`scan`,
		`modifica`,
		`id_attività`,
		`iva_incasso`,
		`iva_bollo`,
		`aliquota_iva_BTI`,
		`formato_trasmissione`,
		`progressivo_invio`,
		`codice_destinatario`,
		`pec_destinatario`,
		tipo_fattura_elettronica,
		sorgente_documento,
		e_fattura_filename,
		movimenta_magazzino
	FROM fornfattura
	WHERE fornfattura.Id_fattura = enter_id AND fornfattura.anno = enter_year;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoicePaymentGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoicePaymentGetById`( 
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11),
	IN `payment_id` INT(11)
)
BEGIN


	SELECT 
		IF(fornfattura_pagamenti.id_fattura IS NULL, false, True) AS 'Exists',
		fornfattura.id_fattura,
		fornfattura.anno, 
		fornfattura.id_fornitore,
		ifNULL(id_pagamento, CAST(DATE_FORMAT(LAST_DAY(fornfattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d') AS UNSIGNED)) as id_pagamento_fix,
		fornfattura_pagamenti.nota,
		IFNULL(fornfattura_pagamenti.tipo_pagamento, a.tipo) as 'tipo_pagamento',
		fornfattura_pagamenti.insoluto,
		fornfattura_pagamenti.id_prima_nota,
		fornfattura_pagamenti.anno_prima_nota,
		fornfattura_pagamenti.id_trasferimento_verso,
		fornfattura_pagamenti.anno_trasferimento_verso,
		ROUND(totiva +(((trasporto/100)*(100+IFNULL(tipo_iva_BTI.aliquota, 0))) + ((bollo/100)*(100+if(iva_bollo=0, 0,
			  	IFNULL(tipo_iva_BTI.aliquota, 0)))) + ((incasso/100)*(100+if(iva_incasso=0, 0,
				IFNULL(tipo_iva_BTI.aliquota, 0)))) ), 2)/a.mesi  AS "importo_rata", 
		fornfattura_pagamenti.`data` AS "data",
		LAST_DAY(fornfattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY AS "data_prevista"
		
	FROM fornfattura
		LEFT JOIN Tipo_iva AS tipo_iva_BTI ON tipo_iva_BTI.id_iva = aliquota_iva_BTI
		INNER JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione
		INNER JOIN condizioni_giorno AS g ON g.id_condizione = a.id_condizione
		LEFT JOIN fornfattura_pagamenti ON fornfattura.id_fattura=fornfattura_pagamenti.id_fattura AND fornfattura_pagamenti.anno=fornfattura.anno AND fornfattura_pagamenti.id_pagamento= DATE_FORMAT(LAST_DAY(fornfattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d')
	WHERE fornfattura.id_fattura = invoice_id 
		AND fornfattura.anno = invoice_year 
		AND IfNULL(id_pagamento, CAST(DATE_FORMAT(LAST_DAY(fornfattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY,'%Y%m%d') AS UNSIGNED)) = payment_id
	GROUP BY fornfattura.id_fattura, fornfattura.anno, id_pagamento_fix
	ORDER BY fornfattura.anno desc, fornfattura.id_fattura desc;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoicePaymentInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoicePaymentInsert`( 
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11),
	IN `payment_id` INT(11), 
	IN payment_date DATE, 
	IN notes TEXT, 
	IN payment_type INT(11), 
	IN unsolved BIT(1),
	OUT result INT(11)
)
BEGIN
	INSERT INTO fornfattura_pagamenti
	SET id_fattura = invoice_id, 
		anno = invoice_year, 
		id_pagamento = payment_id, 
		nota = notes, 
		tipo_pagamento = payment_type, 
		insoluto = unsolved,
		data = payment_date; 

	SET result = 1;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoicePaymentUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoicePaymentUpdate`( 
	IN `invoice_id` INT(11),
	IN `invoice_year` INT(11),
	IN `payment_id` INT(11), 
	IN payment_date DATE, 
	IN notes TEXT, 
	IN payment_type INT(11), 
	IN unsolved BIT(1),
	OUT result INT(11)
)
BEGIN
	DECLARE last_payment_date DATE; 
	
	IF (payment_date IS NULL OR (payment_type <> 4 AND payment_type <> 3)) THEN
		CALL sp_ariesFirstNoteDeleteBySupplierInvoice(invoice_id, invoice_year, payment_id, result);
	ELSE 
		SELECT data INTO last_payment_date 
		FROM fornfattura_pagamenti 
		WHERE id_fattura = invoice_id AND 
			anno = invoice_year AND 
			id_pagamento = payment_id;
			
		IF last_payment_date <> payment_date THEN
		
			UPDATE prima_nota
			SET Data = payment_date		
			WHERE id_fornfattura = invoice_id AND 
				anno_fornfattura = invoice_year AND 
				id_pagamento = payment_id;
			
		END IF; 
	END IF;

	UPDATE fornfattura_pagamenti
	SET  nota = notes, 
		tipo_pagamento = payment_type, 
		insoluto = unsolved,
		data = payment_date
	WHERE id_fattura = invoice_id AND 
		anno = invoice_year AND 
		id_pagamento = payment_id; 

	SET result = 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoicePrepaymentGet
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoicePrepaymentGet`( 

)
BEGIN
	SELECT 
		`id_acconto`,
		`id_fattura`,
		`anno`,
		`id_pagamento`,
		`importo`,
		`data`,
		`modo`
	FROM fornfattura_acconto;
 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoicePrepaymentGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoicePrepaymentGetById`( 
	IN prepayment_id INT(11)
)
BEGIN
	SELECT 
		`id_acconto`,
		`id_fattura`,
		`anno`,
		`id_pagamento`,
		`importo`,
		`data`,
		`modo`
	FROM fornfattura_acconto
	WHERE id_acconto = prepayment_id;
 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoicePrepaymentGetByPayment
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoicePrepaymentGetByPayment`( 
	IN invoice_id INT(11), 
	IN invoice_year INT(11), 
	IN payment_id INT(11)
)
BEGIN
	SELECT 
		`id_acconto`,
		`id_fattura`,
		`anno`,
		`id_pagamento`,
		`importo`,
		`data`,
		`modo`
	FROM fornfattura_acconto
	WHERE id_fattura = invoice_id
		AND anno = invoice_year
		AND id_pagamento = payment_id;
 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoiceProductGetBySupplierInvoice
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoiceProductGetBySupplierInvoice`(
	IN invoice_id INT(11), 
	IN invoice_year INT(11)
)
BEGIN
	SELECT
		`id_fattura`,
		`Anno`,
		`n_tab`,
		`Descrizione`,
		`um`,
		`quantità`,
		`prezzo_unitario`,
		`sconto`,
		`costo`,
		`serial_number`,
		`id_materiale`,
		`Iva`,
		`codice_fornitore`,
		`anno_rif`,
		`id_rif`,
		`tipo`L,
		`anomalo`,
		`corretto`,
		`id_nota`,
		`corretto2`,
		`riparazione`
	FROM fornfattura_articoli
	WHERE id_fattura = invoice_id AND Anno = invoice_year;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoiceSetPaymentCondition
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoiceSetPaymentCondition`(
	IN enter_id INT(11), 
	IN enter_year INT(11),
	IN payment_condition_id INT(1),
	OUT Result INT(11)
	
)
BEGIN

	UPDATE fornfattura
	SET cond_pagamento = payment_condition_id
	WHERE Id_fattura = enter_id AND anno = enter_year;
	SET Result = 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierInvoiceSetScan
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierInvoiceSetScan`(
	IN enter_id INT(11), 
	IN enter_year INT(11),
	IN scan_value BIT(1),
	OUT Result INT(11)
	
)
BEGIN

	UPDATE fornfattura
	SET scan = scan_value
	WHERE Id_fattura = enter_id AND anno = enter_year;
	SET Result = 1;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSupplierPriceListGetByProductAndSupplier
DELIMITER //
CREATE PROCEDURE `sp_ariesSupplierPriceListGetByProductAndSupplier`( 
	IN code VARCHAR(11),
	IN supplier_id INT(11)
)
BEGIN
	
  DROP TABLE IF EXISTS  temp_articolo_listino; 
  
	CREATE TABLE temp_articolo_listino (
		`Id_listino` INT(11) NOT NULL,
		`Prezzo` DECIMAL(11,4) NOT NULL,
		PRIMARY KEY (`Id_listino`)
	);
	
	INSERT INTO temp_articolo_listino
	SELECT Id_listino,
		Prezzo
	FROM articolo_listino
	WHERE Id_articolo = code;
	
	
	SELECT DISTINCT
		fornitore_listino.id_listino, 
		id_fornitore, 
		code as Id_articolo, 
		acquisto.prezzo as Prezzo, 
		acquisto.id_listino as Id_prezzo,
		netto.prezzo as Netto, 
		netto.id_listino as Id_netto, 
		speciale.prezzo as Speciale, 
		speciale.id_listino as Id_speciale,
		ultimo.prezzo as Ultimo, 
		ultimo.id_listino as Id_ultimo
	FROM fornitore_listino
		LEFT JOIN temp_articolo_listino AS acquisto ON acquisto.Id_listino = fornitore_listino.acquisto
		LEFT JOIN temp_articolo_listino AS netto ON netto.Id_listino = fornitore_listino.netto
		LEFT JOIN temp_articolo_listino AS speciale ON speciale.Id_listino = fornitore_listino.speciale
		LEFT JOIN temp_articolo_listino AS ultimo ON ultimo.Id_listino = fornitore_listino.ultimo
	WHERE id_fornitore = supplier_id;
	
	DROP TABLE IF EXISTS  temp_articolo_listino; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemCurrentSubscriptionRefresh
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemCurrentSubscriptionRefresh`(
	system_id INT(11)
)
BEGIN

	DECLARE default_subscription_id INT(11);
	DECLARE last_system_subscription_id INT(11);

	SELECT id_abbonamento
	INTO default_subscription_id
	FROM abbonamento
	WHERE generale = 1
	ORDER BY anno DESC
	LIMIT 1;

	SELECT id_abbonamenti
	INTO last_system_subscription_id
	FROM impianto_abbonamenti
	WHERE id_impianto = system_id
	ORDER BY anno DESC
	LIMIT 1;

	UPDATE impianto
	SET abbonamento = IFNULL(last_system_subscription_id, default_subscription_id)
	WHERE id_impianto = system_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemGet
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemGet`( )
BEGIN
        

	SELECT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, '') As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) AS Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemGetById`( 
  systemId INT
)
BEGIN
        

	SELECT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, '') As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) AS Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
	WHERE (Id_impianto = systemId); 
		
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemGetByIds
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemGetByIds`(
	IN idArray MEDIUMTEXT)
BEGIN

SELECT DISTINCT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,"1970-01-01") AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,"1970-01-01") AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,"1970-01-01") AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, "") As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,"1970-01-01") AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,"1970-01-01") AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) AS Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
	  WHERE FIND_IN_SET(Id_impianto, idArray) > 0; 
  
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemGetByManagerId
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemGetByManagerId`( 
  manager_id INT
)
BEGIN
      
	SELECT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, '') As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) AS Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
	WHERE (id_cliente = manager_id); 	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemGetByTicketStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemGetByTicketStatus`( 
	statusTicket INT(11)
)
BEGIN
        

	SELECT DISTINCT impianto.Id_impianto,
		impianto.id_cliente, 
		impianto.id_gestore, 
		impianto.id_occupante, 
		CAST(IFNULL(impianto.Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(impianto.Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(impianto.altro, "") AS altro, 
		IFNULL(impianto.Abbonamento, 0) abbonamento, 
		impianto.Tipo_impianto,  
		IFNULL(impianto.Stato, 0) AS Stato , 
		CAST(IFNULL(impianto.Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(impianto.Descrizione, '') As Descrizione, 
		IFNULL(impianto.Destinazione, 0) AS Destinazione , 
		IFNULL(impianto.Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(impianto.Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(impianto.Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(impianto.Persone, 0) AS Persone, 
		impianto.Data_modifica, 
		impianto.Contr, 
		IFNULL(impianto.sub, 0) AS sub, 
		IFNULL(impianto.orario_prog, 0) AS orario_prog, 
		IFNULL(impianto.id_utente, 0) AS id_utente, 
		IFNULL(impianto.auto, 0) AS Auto, 
		IFNULL(impianto.condizione, 0) AS condizione, 
		IFNULL(impianto.eta, 0) AS eta, 
		IFNULL(impianto.Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(impianto.Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(impianto.Checklist, 0) Checklist,
		IFNULL(impianto.Centrale, "") AS Centrale, 
		IFNULL(impianto.gsm, "") AS gsm, 
		IFNULL(impianto.combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(impianto.flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(impianto.flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
		INNER JOIN Ticket 
		ON Impianto.Id_impianto = Ticket.Id_impianto AND Ticket.Stato_ticket = statusTicket;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemGetCustomerInfoForPrint
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemGetCustomerInfoForPrint`()
BEGIN
	DROP TEMPORARY TABLE IF EXISTS tmpReports; 
	CREATE TEMPORARY TABLE tmpReports
	(
		id_rapporto BIGINT, 
		anno INT, 
		id_impianto INT,
		Relazione TEXT,
		data_esecuzione DATE
		
	);
	
	INSERT INTO tmpReports
	SELECT * 
	FROM 
		(SELECT
			Rapporto.id_rapporto,
			Rapporto.anno,
			Rapporto.id_impianto, 
			rapporto.relazione,
			Rapporto.data_esecuzione
		FROM Rapporto 
		WHERE ID_impianto IS NOT NULL
		ORDER BY Rapporto.data_esecuzione DESC) as tmp
	GROUP BY id_impianto;

	DROP TEMPORARY TABLE IF EXISTS tmpSystemSubscription; 
	CREATE TEMPORARY TABLE tmpSystemSubscription
	(
		Id_impianto INT, 
		id_abbonamento INT, 
		descrizione_abbonamento VARCHAR(150),
		Anno INT		
	);
	
	INSERT INTO tmpSystemSubscription
	SELECT * 
	FROM 
		(SELECT
			impianto_abbonamenti_mesi.impianto id_impianto,
			impianto_abbonamenti_mesi.abbonamenti id_abbonemnto,
			abbonamento.Nome, 
			impianto_abbonamenti_mesi.anno
		FROM impianto_abbonamenti_mesi
			INNER JOIN impianto
				ON impianto.Id_impianto = impianto_abbonamenti_mesi.impianto
			INNER JOIN Abbonamento 
				ON abbonamento.Id_abbonamento = impianto_abbonamenti_mesi.abbonamenti  
		WHERE ID_impianto IS NOT NULL
		ORDER BY impianto_abbonamenti_mesi.anno DESC,
			impianto_abbonamenti_mesi.mese DESC) As tmp
	GROUP BY id_impianto;


	DROP TEMPORARY TABLE IF EXISTS tmpCustomersInfo; 
	CREATE TEMPORARY TABLE tmpCustomersInfo
	(
		id_cliente INT, 
		Ragione_sociale VARCHAR(100), 
		Indirizzo VARCHAR(250),  
		teleono VARCHAR(20), 
		cellulare VARCHAR(20), 
		email VARCHAR(100),
		partita_iva VARCHAR(11), 
		codice_fiscale VARCHAR(20)
	);
	
	INSERT INTO tmpCustomersInfo 
	SELECT Clienti.Id_CLiente, 
		Clienti.ragione_sociale,
		CONCAT(destinazione_cliente.Indirizzo, ", ", destinazione_cliente.numero_civico, " - ", 
			comune.cap," ", 
			IF(Frazione.nome IS NULL, "", Concat(Frazione.nome , " di ")), 
			IFNULL(comune.Nome, "")) AS Indirizzo, 
		riferimento_clienti.Telefono, 
		riferimento_clienti.altro_telefono, 
		riferimento_clienti.mail,
		clienti.Partita_iva, 
		clienti.Codice_Fiscale
	FROM Clienti
		INNER JOIN destinazione_cliente 
			ON Clienti.Id_Cliente = destinazione_cliente.Id_Cliente AND Sede_principale = 1
		INNER JOIN riferimento_clienti
			ON Clienti.id_Cliente = riferimento_clienti.Id_Cliente and riferimento_clienti.Id_riferimento = 1
		LEFT JOIN Comune ON
			destinazione_cliente.Comune = comune.Id_comune
		LEFT JOIN frazione ON
			destinazione_cliente.Frazione = frazione.Id_frazione 
	WHERE clienti.Stato_cliente NOT IN ('clGray', 'clBlack','$004A4AFF');

	select * from tmpCustomersInfo;
	select * from tmpReports;
	select * from tmpSystemSubscription; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemGetOrderByDescription
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemGetOrderByDescription`( )
BEGIN
        

	SELECT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, '') As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) AS Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
	ORDER BY Descrizione ASC;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemPeriodicMonitoringDeleteById
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemPeriodicMonitoringDeleteById`(
	enter_id INT,
	OUT Result INT
)
BEGIN

	SELECT Id
		INTO
		Result 
	FROM Impianto_abbonamenti_mesi
	WHERE id = enter_id;

	
	IF Result THEN
		DELETE FROM  impianto_abbonamenti_mesi 
		WHERE Id = enter_id;  
		
		DELETE FROM Evento 
		WHERE Id_tipo_evento = 1
			AND Id_riferimento = enter_id; 
				
		SET Result = 1; 
	
	ELSE
		SET Result = -5; -- record not found
			
	END IF; 
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemPeriodicMonitoringGet
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemPeriodicMonitoringGet`()
BEGIN
	SELECT Id,
		impianto AS Id_impianto,
		anno, 
		abbonamenti AS id_abbonamento, 
		mese, 
		Eseguito_il, 
		IFNULL(Id_rapp, 0) AS id_rapporto, 
		IFNULL(anno_rapp, 0) AS anno_rapporto, 
		da_eseguire,
		IFNULL(prezzo, 0 ) AS prezzo, 
		IFNULL(nota_mese, "") AS note,
		IFNULL(modifica_mese, 0) AS modifica_mese,
		IFNULL(modifica_anno, 0) AS modifica_anno
	FROM Impianto_abbonamenti_mesi; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemPeriodicMonitoringGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemPeriodicMonitoringGetById`(
	enter_id INT
)
BEGIN
	SELECT Id,
		impianto AS Id_impianto,
		anno, 
		abbonamenti AS id_abbonamento, 
		mese, 
		Eseguito_il, 
		IFNULL(Id_rapp, 0) AS id_rapporto, 
		IFNULL(anno_rapp, 0) AS anno_rapporto, 
		da_eseguire,
		IFNULL(prezzo, 0 ) AS prezzo, 
		IFNULL(nota_mese, "") AS note,
		IFNULL(modifica_mese, 0) AS modifica_mese,
		IFNULL(modifica_anno, 0) AS modifica_anno
	FROM Impianto_abbonamenti_mesi
	WHERE Id = enter_id; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemPeriodicMonitoringGetNextToExecutedForEachSystem
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemPeriodicMonitoringGetNextToExecutedForEachSystem`(
)
BEGIN
	SELECT Impianto_abbonamenti_mesi.Id,
		Impianto_abbonamenti_mesi.impianto AS Id_impianto,
		Impianto_abbonamenti_mesi.anno, 
		Impianto_abbonamenti_mesi.abbonamenti AS id_abbonamento, 
		Impianto_abbonamenti_mesi.mese, 
		Impianto_abbonamenti_mesi.Eseguito_il, 
		IFNULL(Impianto_abbonamenti_mesi.Id_rapp, 0) AS id_rapporto, 
		IFNULL(Impianto_abbonamenti_mesi.anno_rapp, 0) AS anno_rapporto, 
		Impianto_abbonamenti_mesi.da_eseguire,
		IFNULL(Impianto_abbonamenti_mesi.prezzo, 0 ) AS prezzo, 
		IFNULL(Impianto_abbonamenti_mesi.nota_mese, "") AS note,
		IFNULL(Impianto_abbonamenti_mesi.modifica_mese, 0) AS modifica_mese,
		IFNULL(Impianto_abbonamenti_mesi.modifica_anno, 0) AS modifica_anno
	FROM Impianto_abbonamenti_mesi
	WHERE  Eseguito_il IS NULL 
		AND CONCAT(Anno, "-", mese, "-01") >= DATE_FORMAT(NOW() - INTERVAL 1 YEAR, '%Y-%m-%d')
	GROUP BY Id_impianto
	ORDER BY Impianto_abbonamenti_mesi.Anno ASC, Impianto_abbonamenti_mesi.mese ASC ;  
	 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemPeriodicMonitoringGetToScheduled
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemPeriodicMonitoringGetToScheduled`(
	IN group_id INT(11)
)
BEGIN

	DROP TABLE IF EXISTS tmp_events_period;
	CREATE TEMPORARY TABLE tmp_events_period
	SELECT Evento.* 
	FROM Evento
		INNER JOIN Evento_gruppo_evento ON Evento_gruppo_evento.Id_evento = Evento.Id AND Evento_gruppo_evento.Id_gruppo_evento != group_id
	WHERE evento.Id_tipo_evento = 1; 			

	SELECT Impianto_abbonamenti_mesi.Id,
		Impianto_abbonamenti_mesi.impianto AS Id_impianto,
		Impianto_abbonamenti_mesi.anno, 
		Impianto_abbonamenti_mesi.abbonamenti AS id_abbonamento, 
		Impianto_abbonamenti_mesi.mese, 
		Impianto_abbonamenti_mesi.Eseguito_il, 
		IFNULL(Impianto_abbonamenti_mesi.Id_rapp, 0) AS id_rapporto, 
		IFNULL(Impianto_abbonamenti_mesi.anno_rapp, 0) AS anno_rapporto, 
		Impianto_abbonamenti_mesi.da_eseguire,
		IFNULL(Impianto_abbonamenti_mesi.prezzo, 0 ) AS prezzo, 
		IFNULL(Impianto_abbonamenti_mesi.nota_mese, "") AS note,
		IFNULL(Impianto_abbonamenti_mesi.modifica_mese, 0) AS modifica_mese,
		IFNULL(Impianto_abbonamenti_mesi.modifica_anno, 0) AS modifica_anno
	FROM Impianto_abbonamenti_mesi
	LEFT JOIN 
		tmp_events_period as evento
	  ON evento.Id_tipo_evento = 1 AND Impianto_abbonamenti_mesi.Id = evento.Id_riferimento 
	WHERE  Impianto_abbonamenti_mesi.Eseguito_il IS NULL AND (evento.Id IS NULL OR Evento.eliminato)
	 ORDER BY Impianto_abbonamenti_mesi.Anno ASC, Impianto_abbonamenti_mesi.mese ASC ;  
	 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemPeriodicMonitoringInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemPeriodicMonitoringInsert`(
	system_id INT, 
	enter_year INT, 
	subscription_id INT,
	enter_month INT, 
	real_execution_date DATETIME, 
	theorical_execution_date DATETIME, 
	report_id INT, 
	report_year INT, 
	price DECIMAL(11,2), 
	notes TEXT,
	OUT insertId INT, 
	OUT Result INT
)
BEGIN

	SELECT Id_Impianto
		INTO
		Result 
	FROM Impianto 
	WHERE Id_impianto = system_id;
	
	

	IF Result THEN  
		
		SELECT Id_Impianto
			INTO
				Result 
		FROM Impianto_abbonamenti 
		WHERE Id_impianto = system_id AND Anno = enter_year 
			AND Id_abbonamenti = subscription_id;
		
	ELSE
	
		SET Result = -2; -- System Id Not found 
				
	END IF; 
	
	
	
	IF Result THEN  
		
		SELECT Id_Impianto
			INTO
				Result 
		FROM Impianto_abbonamenti_mesi
		WHERE  impianto = system_id AND Anno = enter_year 
			AND mesi = enter_month ;
		
	ELSE
		SET Result = -3; -- Subscription not found in enter year		
	END IF; 
	
	
	IF Result THEN
	
		SET Result = -1; -- Periodic Monitoring already exists
	
	ELSE
		SET Result = 1; 
	 
	END IF; 
	
	IF Result THEN 
		IF report_year <> 0 AND report_id <> 0  THEN  
			
			SELECT Id_Rapporto
				INTO
					Result 
			FROM rapporto 
			WHERE Id_rapporto = report_id AND anno_Rapporto = report_id;
			
				
			IF NOT Result THEN
				SET Result = -4; -- Report id not found 
			END IF; 
				
		END IF; 
	END IF; 	

	

	
	
	IF Result THEN
	
		INSERT INTO impianto_abbonamenti_mesi 
		SET 	impianto = system_id, 
				anno = enter_year,
				mese = enter_month,
				abbonamenti = subscription_id,
				eseguito_il = real_execution_date, 
				da_eseguire = theorical_execution_date, 
				id_rapp = report_id, 
				anno_rapp = report_year, 
				prezzo = price, 
				nota_mese = notes,
				modifica_mese = 0, 
				modifica_anno = 0; 
		
				
		SET InsertId = LAST_INSERT_ID();
		
		
		IF InsertId THEN
			SET Result = 1;
			
		ELSE
			SET Result = 0; 
		END IF; 
		
	END IF; 
	
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemPeriodicMonitoringUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemPeriodicMonitoringUpdate`(
	system_id INT,
	enter_year INT, 
	subscription_id INT,
	enter_month INT, 
	real_execution_date DATETIME, 
	theorical_execution_date DATETIME, 
	report_id INT, 
	report_year INT, 
	price DECIMAL(11,2), 
	notes TEXT,
	enter_id INT, 
	OUT Result INT
)
BEGIN

	SELECT Id_Impianto
		INTO
		Result 
	FROM Impianto 
	WHERE Id_impianto = system_id;
	
	

	IF Result THEN  
		
		SELECT Id_Impianto
			INTO
				Result 
		FROM Impianto_abbonamenti 
		WHERE Id_impianto = system_id AND Anno = enter_year 
			AND Id_abbonamenti = subscription_id;
		
	ELSE
		SET Result = -2; -- System Id Not found 		
	END IF; 
	
	
	
	IF Result THEN  
		
		SELECT Id
			INTO
				Result 
		FROM Impianto_abbonamenti_mesi
		WHERE  Id = enter_id ;
	ELSE
		SET Result = -3; -- Subscription not found in enter year		
	END IF; 
	
	
	IF Result THEN
		IF report_year <> 0 AND report_id <> 0 THEN  
			
			SELECT Id_Rapporto
				INTO
					Result 
			FROM rapporto 
			WHERE Id_rapporto = report_id AND anno_Rapporto = report_id;

		END IF; 
		
		IF NOT Result THEN
			SET Result = -4; -- Report id not found 
		END IF; 
				
				
	ELSE
		SET Result = -5; -- Periodic Monitoring not found
	END IF;  

	
	IF Result THEN
	
		UPDATE impianto_abbonamenti_mesi 
		SET 	impianto = system_id, 
				anno = enter_year,
				mese = enter_month,
				abbonamenti = subscription_id,
				eseguito_il = real_execution_date, 
				da_eseguire = theorical_execution_date, 
				id_rapp = report_id, 
				anno_rapp = report_year, 
				prezzo = price, 
				nota_mese = notes,
				modifica_mese = 0, 
				modifica_anno = 0
		WHERE Id = Enter_id;
		
		
				
		
		IF InsertId THEN
			SET Result = 1;
			
		ELSE
			SET Result = 0; 
		END IF;  
		
	END IF; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemsDdtProductDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemsDdtProductDelete`(
	in ddt_id int,
	in ddt_year int,
	in product_code varchar(14),
	IN tab_id INT(11)
)
BEGIN
	DELETE 	impianto_componenti 
	FROM 		impianto_componenti 
				INNER JOIN impianto_componenti_ddt ON
					 impianto_componenti.id_articolo=impianto_componenti_ddt.id_articolo
					 AND impianto_componenti_ddt.id_impianto=impianto_componenti.id_impianto
					 AND id=codice
					 AND anno=ddt_year
					 AND id_ddt=ddt_id
					 AND id_tab=tab_id
	WHERE impianto_componenti.id_articolo=product_code; 

	-- Delete system components - ddt associations
	DELETE FROM impianto_componenti_ddt 
	WHERE id_ddt=ddt_id and anno=ddt_year and id_tab=tab_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemsDdtProductInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemsDdtProductInsert`(
	in ddt_id int,
	in ddt_year int,
	in product_code varchar(14),
	IN qt DECIMAL(11,2),
	IN tab_id INT(11),
	IN serial_number VARCHAR(150)
)
BEGIN

	DECLARE int_quantity INT;
	DECLARE system_id INT;
	DECLARE next_component_id INT;
	DECLARE ddt_date DATE;
	DECLARE product_expiration_months INT;
	DECLARE product_warranty_months INT;
	DECLARE customer_type_id INT;

	-- Get ddt informations such as system id, customer type, etc
	SELECT data_documento,
		impianto,
		tipo_cliente
	INTO
		ddt_date,
		system_id,
		customer_type_id
	FROM ddt
		INNER JOIN clienti ON clienti.id_cliente=ddt.id_cliente
	WHERE id_ddt=ddt_id and anno=ddt_year;

	-- set a new quantity var to iterate on
	SET int_quantity = ROUND(qt);

	IF (system_id IS NOT NULL) AND (product_code IS NOT NULL) THEN
		
		-- Get product data that we need to use n the next while
		SELECT IFNULL(scadenza, 0),
				IFNULL(garanzia, 0)
			INTO product_expiration_months,
				product_warranty_months
		FROM articolo
		WHERE codice_articolo = product_code;

		WHILE int_quantity > 0 DO
			SELECT
				IF(max(id) IS NOT NULL, max(id+1), 0)
			INTO
				next_component_id
			FROM impianto_componenti
			WHERE id_impianto = system_id
				AND impianto_componenti.id_articolo=product_code;

			INSERT INTO impianto_componenti
			SET id = next_component_id,
				id_impianto = system_id,
				id_articolo = product_code,
				data_scadenza = IF(product_expiration_months = 0, NULL,  ddt_date + INTERVAL product_expiration_months month),
				data_installazione = ddt_date,
				fine_garanzia = ddt_date + INTERVAL if(customer_type_id=1, 1, 2) year,
				checked = 2,
				garanzia_fornitore =  IF(product_warranty_months = 0, NULL,  ddt_date + INTERVAL product_warranty_months month);


			IF (serial_number IS NOT NULL AND serial_number <> "") THEN
				INSERT INTO impianto_componenti_codice
				SET 
					id_impianto = system_id,
					id_articolo = product_code,
					codice = next_component_id,
					seriale = serial_number,
					tipo = 4;
			END IF;


			INSERT INTO impianto_componenti_ddt
			SET id_impianto = system_id,
				id_articolo = product_code,
				codice = next_component_id,
				id_ddt = ddt_id,
				anno = ddt_year,
				id_tab = tab_id;

			SET int_quantity = int_quantity - 1;


		END WHILE;
	END IF;		

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemsExpirationsCounter
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemsExpirationsCounter`(
	IN start_date DATE,
	IN end_date DATE,
	IN system_id INT,
	IN customer_id INT,
	IN entity_type VARCHAR(100),
	IN reminder_status VARCHAR(200) -- sent, to_be_sent, to_handle
)
BEGIN
	SELECT COUNT(*)
	FROM vw_systems_expirations_summary
	WHERE
		data_scadenza >= iFNULL(start_date, '1970-01-01') 
		AND data_scadenza <= iFNULL(end_date, '2100-01-01') 
		AND id_impianto = iFNULL(system_id, id_impianto) 
		AND id_cliente = iFNULL(customer_id, id_cliente)
		AND tipo_entita = iFNULL(entity_type, tipo_entita)
		AND (FIND_IN_SET(stato_promemoria_cliente.rif_applicazioni, reminder_status) OR reminder_status IS NULL);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemsExpirationsEntityTypes
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemsExpirationsEntityTypes`()
BEGIN
	SELECT 
		tipo_entita,
		tipo_scadenza AS descrizione
	FROM vw_systems_expirations_summary AS ses
	GROUP BY tipo_entita
	ORDER BY tipo_scadenza DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemsExpirationsExport
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemsExpirationsExport`(
	IN start_date DATE,
	IN end_date DATE,
	IN system_id INT,
	IN customer_id INT,
	IN entity_type VARCHAR(100)
)
BEGIN
	SELECT 
		ses.id_riferimento AS "ID riferimento",
		tipo_entita AS "Tipo entita",
		tipo_scadenza AS "Tipo scadenza",
		ses.id_cliente AS "ID Cliente",
		clienti.ragione_sociale AS "Cliente",
		Stato_clienti.Nome AS "Stato Cliente",
		tipo_rapclie.Nome AS "Rapporto Cliente",
		ses.id_impianto AS "ID impianto",
		Tipo_impianto.nome AS "Tipo Impianto",
		stato_impianto.Nome AS "Stato Impianto",
		abbonamento.Nome AS "Abbonamento",
		impianto.Costo_Manutenzione AS "Costo Manutenzione",
		ses.descrizione AS "Descrizione Impianto",
		data_scadenza AS "Data scadenza",
		IF(stato_promemoria_cliente.rif_applicazioni = "to_send", 1, 0) AS "Richiedi invio promemoria",
		data_promemoria AS "Data promemoria",
		data_ultimo_promemoria AS "Data ultimo promemora",
		quantita AS "Quantita",
		CONCAT(CONCAT(dc.indirizzo,' n.',dc.numero_civico, dc.altro),' - ',concat(IF(f.nome IS NOT NULL AND f.nome <> '', concat(f.nome,' di '), ''), c.nome,' (',c.provincia,')')) AS 'Indirizzo',
		dc.Km_sede AS "KM Viaggio",
		dc.Tempo_strada AS "Tempo viaggio",
		IFNULL(riferimento_principale.mail, '') AS "Email Cliente",
		IFNULL(riferimento_principale.altro_telefono, "") AS "Telefono Cliente",
		rc.id_riferimento AS "ID contatto Promemoria",
		IFNULL(rc.mail, '') AS "Email Promemoria",
		IFNULL(rc.altro_telefono, "") AS "Telefono Promemoria",
		stato_promemoria_cliente.nome AS "Stato Promemoria"
	FROM vw_systems_expirations_summary AS ses
		INNER JOIN impianto ON ses.id_impianto = impianto.Id_impianto
		INNER JOIN clienti ON ses.Id_cliente = clienti.Id_cliente
		INNER JOIN stato_impianto ON impianto.Stato = stato_impianto.Id_stato
		INNER JOIN tipo_impianto ON impianto.Tipo_impianto = tipo_impianto.Id_tipo
		LEFT JOIN abbonamento ON impianto.Abbonamento = abbonamento.Id_abbonamento
		INNER JOIN stato_clienti ON clienti.Stato_cliente = stato_clienti.Id_stato
		INNER JOIN destinazione_cliente AS dc ON dc.id_cliente = ses.id_cliente
			AND impianto.destinazione = dc.Id_destinazione
		INNER JOIN tipo_rapclie ON tipo_rapclie.id_tipo = clienti.tipo_rapporto
		INNER JOIN comune AS c ON c.id_comune=dc.Comune
		INNER JOIN stato_promemoria_cliente ON stato_promemoria_cliente.id = ses.id_stato_promemoria
		LEFT JOIN frazione AS f ON f.id_frazione=dc.frazione
		LEFT JOIN riferimento_clienti AS rc ON rc.id_cliente=ses.id_cliente AND rc.Promemoria_cliente=1
		LEFT JOIN riferimento_clienti AS riferimento_principale ON riferimento_principale.id_cliente=ses.id_cliente AND riferimento_principale.id_riferimento = 1
	WHERE
		ses.data_scadenza >= iFNULL(start_date, CAST('1970-01-01' AS DATE)) 
		AND ses.data_scadenza <= iFNULL(end_date, CAST('2100-01-01' AS DATE)) 
		AND ses.id_impianto = iFNULL(system_id, ses.id_impianto) 
		AND ses.id_cliente = iFNULL(customer_id, ses.id_cliente)
		AND ses.tipo_entita = iFNULL(entity_type, CAST(ses.tipo_entita AS CHAR(100)))
	ORDER BY data_scadenza DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemsExpirationsSearch
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemsExpirationsSearch`(
	IN start_date DATE,
	IN end_date DATE,
	IN system_id INT,
	IN customer_id INT,
	IN entity_type VARCHAR(100),
	IN reminder_status VARCHAR(200) -- sent, to_be_sent, handled, to_handle
)
BEGIN
	SELECT 
		ses.id_riferimento,
		tipo_entita,
		tipo_scadenza,
		ses.id_impianto,
		ses.id_cliente,
		clienti.ragione_sociale,
		Stato_clienti.Nome AS "stato_cliente",
		Tipo_impianto.nome AS "tipo_impianto",
		stato_impianto.Nome AS "stato_impianto",
		ses.descrizione,
		data_scadenza,
		IF(stato_promemoria_cliente.rif_applicazioni = "to_send", 1, 0) as richiedi_invio_promemoria,
		data_promemoria,
		data_ultimo_promemoria,
		quantita,
		CONCAT(CONCAT(dc.indirizzo,' n.',dc.numero_civico, dc.altro),' - ',concat(IF(f.nome IS NOT NULL AND f.nome <> '', concat(f.nome,' di '), ''), c.nome,' (',c.provincia,')')) AS 'Indirizzo',
		CONCAT(c.nome,' (',c.provincia,')') AS 'citta',
		dc.Km_sede AS "km_viaggio",
		dc.Tempo_strada AS tempo_viaggio,
		rc.id_riferimento AS id_riferimento_promemoria,
		CONCAT(rc.nome, ' - ', rc.mail, '/', rc.altro_telefono) AS riferimento_promemoria,
		ses.id_stato_promemoria,
		stato_promemoria_cliente.nome as stato_promemoria,
		stato_promemoria_cliente.colore as colore_stato_promemoria
	FROM vw_systems_expirations_summary AS ses
		INNER JOIN impianto ON ses.id_impianto = impianto.Id_impianto
		INNER JOIN clienti ON ses.Id_cliente = clienti.Id_cliente
		INNER JOIN stato_impianto ON impianto.Stato = stato_impianto.Id_stato
		INNER JOIN tipo_impianto ON impianto.Tipo_impianto = tipo_impianto.Id_tipo
		INNER JOIN stato_clienti ON clienti.Stato_cliente = stato_clienti.Id_stato
		INNER JOIN destinazione_cliente AS dc ON dc.id_cliente = ses.id_cliente
			AND impianto.destinazione = dc.Id_destinazione
		INNER JOIN comune AS c ON c.id_comune=dc.Comune
		INNER JOIN stato_promemoria_cliente ON stato_promemoria_cliente.id = ses.id_stato_promemoria
		LEFT JOIN frazione AS f ON f.id_frazione=dc.frazione
		LEFT JOIN riferimento_clienti AS rc ON rc.id_cliente=ses.id_cliente AND Promemoria_cliente=1
	WHERE
		ses.data_scadenza >= iFNULL(start_date, CAST('1970-01-01' AS DATE)) 
		AND ses.data_scadenza <= iFNULL(end_date, CAST('2100-01-01' AS DATE)) 
		AND ses.id_impianto = iFNULL(system_id, ses.id_impianto) 
		AND ses.id_cliente = iFNULL(customer_id, ses.id_cliente)
		AND ses.tipo_entita = iFNULL(entity_type, CAST(ses.tipo_entita AS CHAR(100)))
		AND (FIND_IN_SET(stato_promemoria_cliente.rif_applicazioni, reminder_status) OR reminder_status IS NULL)
	ORDER BY data_scadenza DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemsExpirationsSetReminderInfo
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemsExpirationsSetReminderInfo`(
	IN reference_id INT,
	IN entity_type VARCHAR(100),
	IN system_id INT,
	IN reminder_status_ref VARCHAR(50),
	IN reminder_send_date DATETIME,
	IN contact_id INT
)
BEGIN
	DECLARE product_code VARCHAR(100);
	DECLARE expiration_date DATE;
	DECLARE new_status_id INT;

	UPDATE riferimento_clienti
	SET promemoria_cliente = 1
	WHERE id = contact_id;

	SELECT id
	INTO new_status_id
	FROM stato_promemoria_cliente
	WHERE rif_applicazioni = reminder_status_ref;

	if entity_type = 'ticket_expiration' THEN
		
		UPDATE Ticket
		SET id_stato_promemoria = new_status_id,
			data_promemoria = CAST(reminder_send_date AS DATE)
		WHERE Id = reference_id;

	ELSEIF entity_type = 'system_sim_expiration' THEN
		
		UPDATE impianto_ricarica_tipo
		SET id_stato_promemoria = new_status_id,
			data_promemoria = reminder_send_date
		WHERE id = reference_id;

	ELSEIF entity_type = 'system_sim_renew' THEN
			
		UPDATE impianto_ricarica_tipo
		SET id_stato_promemoria = new_status_id,
			data_promemoria = reminder_send_date
		WHERE id = reference_id;

	ELSEIF entity_type = 'system_maintenance_month' THEN
			
		UPDATE impianto_abbonamenti_mesi
		SET id_stato_promemoria = new_status_id,
			data_promemoria = reminder_send_date
		WHERE id = reference_id;

	ELSEIF entity_type = 'system_warrantzy' THEN
			
		UPDATE impianto
		SET id_stato_promemoria_garanzia = new_status_id,
			data_promemoria_garanzia = reminder_send_date
		WHERE id_impianto = reference_id;

	ELSEIF entity_type = 'systems_components' THEN	
		
		SELECT Id_articolo, Data_scadenza
			INTO product_code, expiration_date
		FROM impianto_componenti
		WHERE id_impianto = system_id
			AND id_impianto_componenti = reference_id;

		UPDATE impianto_componenti
		SET id_stato_promemoria = new_status_id,
			data_promemoria = reminder_send_date
		WHERE id_impianto = system_id
			AND Id_articolo = product_code
			AND Data_scadenza = expiration_date;

	END IF;


END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemsExpirationsUpdateStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemsExpirationsUpdateStatus`(
	IN reference_id INT,
	IN entity_type VARCHAR(100),
	IN system_id INT,
	IN reminder_status_ref VARCHAR(50)
)
BEGIN
	DECLARE product_code VARCHAR(100);
	DECLARE expiration_date DATE;
	DECLARE new_status_id INT;

	SELECT id
	INTO new_status_id
	FROM stato_promemoria_cliente
	WHERE rif_applicazioni = reminder_status_ref;

	if entity_type = 'ticket_expiration' THEN
		
		UPDATE Ticket
		SET id_stato_promemoria = new_status_id
		WHERE Id = reference_id;

	ELSEIF entity_type = 'system_sim_expiration' THEN
		
		UPDATE impianto_ricarica_tipo
		SET id_stato_promemoria = new_status_id
		WHERE id = reference_id;

	ELSEIF entity_type = 'system_sim_renew' THEN
			
		UPDATE impianto_ricarica_tipo
		SET id_stato_promemoria = new_status_id
		WHERE id = reference_id;

	ELSEIF entity_type = 'system_maintenance_month' THEN
			
		UPDATE impianto_abbonamenti_mesi
		SET id_stato_promemoria = new_status_id
		WHERE id = reference_id;

	ELSEIF entity_type = 'system_warrantzy' THEN
			
		UPDATE impianto
		SET id_stato_promemoria_garanzia = new_status_id,
			data_promemoria_garanzia = reminder_send_date
		WHERE id_impianto = reference_id;

	ELSEIF entity_type = 'systems_components' THEN	
		
		SELECT Id_articolo, Data_scadenza
			INTO product_code, expiration_date
		FROM impianto_componenti
		WHERE id_impianto = system_id
			AND id_impianto_componenti = reference_id;

		UPDATE impianto_componenti
		SET id_stato_promemoria = new_status_id
		WHERE id_impianto = system_id
			AND Id_articolo = product_code
			AND Data_scadenza = expiration_date;

	END IF;


END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesSystemTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesSystemTypeGetById`(
type_id INT(11)
)
BEGIN

	SELECT Id_tipo, 
		Nome, 
		Descrizione,
		Utente_mod, 
		Data_mod
	FROM Tipo_impianto
	WHERE Id_tipo = type_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTabletConfigurationGetLastInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesTabletConfigurationGetLastInsert`( 
)
BEGIN
      
SELECT
	Id_tablet, 
	IFNULL(mail, "") AS mail, 
	IFNULL(testo_mail, "") AS testo_mail, 
	IFNULL(Host, "") AS host, 
	IFNULL(Password, "") AS Password, 
	IFNULL(porta, 0) AS Porta, 
	IFNULL(Username, "") AS Username, 
	IFNULL(DIsplay_name, "") AS Display_name, 
	messaggio_non_abbonato,
	admin_password,
	email_ufficio,
	IFNULL(Data_ins, Data_Mod) AS Data_ins,
	Data_Mod
FROM tablet_configurazione ORDER BY id_tablet DESC LIMIT 1; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTabletConfigurationInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesTabletConfigurationInsert`( 
	email_sender VARCHAR(100),
	email_body TEXT,
	email_host VARCHAR(50), 
	email_port INT, 
	email_display_name VARCHAR(30), 
	email_username VARCHAR(45), 
	email_password VARCHAR(45),
	no_subscriber_message TEXT,
	admin_password VARCHAR(20), 
	office_email VARCHAR(100), 
	OUT result BIT
)
BEGIN

	SET result = 1; 
	
   INSERT INTO tablet_configurazione 
   	SET mail = email_sender, 
   	username = email_username,
   	password = email_password, 
   	host = email_host, 
   	porta = email_port, 
   	testo_mail = email_body, 
   	display_name =  email_display_name, 
		messaggio_non_abbonato = no_subscriber_message, 
		admin_password = admin_password, 
		email_ufficio = office_email,
   	Data_ins = CURDATE(); 
   
   SELECT ROW_COUNT() INTO result; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTagDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesTagDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM tag 
	WHERE id_tag = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTagGet
DELIMITER //
CREATE PROCEDURE `sp_ariesTagGet`(
)
BEGIN

	SELECT 
		`id_tag`,
		`tag`,
		`tipo_documento`,
		`utente_ins`,
		`utente_mod`,
		`data_ins`,
		`data_mod`
	FROM tag;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTagGetByDocumentType
DELIMITER //
CREATE PROCEDURE `sp_ariesTagGetByDocumentType`(
	IN document_type INT
)
BEGIN

	SELECT 
		`id_tag`,
		`tag`,
		`tipo_documento`,
		`utente_ins`,
		`utente_mod`,
		`data_ins`,
		`data_mod`
	FROM tag
	WHERE tipo_documento = document_type;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTagInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesTagInsert`(
	IN tag_value VARCHAR(50),
	IN document_type INT(11),
	IN user_id INT(11),
	OUT result INT(11)
)
BEGIN

	INSERT INTO tag
	SET 
		`tag` = tag_value,
		`tipo_documento` = document_type,
		`utente_ins` = user_id,
		`utente_mod` = user_id,
		`data_ins` = NOW(),
		`data_mod` = NOW();


	SET Result = LAST_INSERT_ID(); 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTagSearch
DELIMITER //
CREATE PROCEDURE `sp_ariesTagSearch`(
	IN tag_value VARCHAR(250),
	IN document_type INT
)
BEGIN

	SELECT 
		`id_tag`,
		`tag`,
		`tipo_documento`,
		`utente_ins`,
		`utente_mod`,
		`data_ins`,
		`data_mod`
	FROM tag
	WHERE tipo_documento = document_type
		AND tag LIKE CONCAT("%", tag_value, "%")
	ORDER BY tag;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTagUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesTagUpdate`(
	IN enter_id INT(11),
	IN tag_value VARCHAR(50),
	IN user_id INT(11),
	OUT result INT(11)
)
BEGIN

	UPDATE tag
	SET `tag` = tag_value,
		`utente_mod` = user_id,
		`data_mod` = NOW()
	WHERE id_tag = enter_id;


	SET Result = 1; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketAttachmentDelete
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketAttachmentDelete`(IN in_id INT(11))
BEGIN
	DELETE FROM ticket_allegati
	WHERE id = in_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketAttachmentGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketAttachmentGetById`(IN in_id INT(11))
BEGIN
	SELECT *
	FROM ticket_allegati
	WHERE id = in_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketAttachmentGetByTicket
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketAttachmentGetByTicket`(IN ticket_id INT(11), IN ticket_year INT(11))
BEGIN
	SELECT *
	FROM ticket_allegati
	WHERE id_ticket = ticket_id AND anno_ticket = ticket_year;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketAttachmentInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketAttachmentInsert`(IN in_ticket_id INT(11), IN in_ticket_year INT(11), IN in_file_name VARCHAR(500), IN in_file_path VARCHAR(500))
BEGIN
	INSERT INTO ticket_allegati
	SET 
		id_ticket = in_ticket_id,
		anno_ticket = in_ticket_year,
		file_name = in_file_name,
		file_path = in_file_path,
		utente_ins = @USER_ID;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketAttachmentRename
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketAttachmentRename`(IN in_id INT(11), IN in_file_name VARCHAR(500), IN in_file_path VARCHAR(500))
BEGIN
	UPDATE ticket_allegati
	SET file_name = in_file_name,
		file_path = in_file_path
	WHERE id = in_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketDeleteExpirationEvent
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketDeleteExpirationEvent`(
	IN ticket_id INT,
	IN ticket_year INT,
	IN user_id INT
)
BEGIN
	DECLARE reminder_event_id INT(11);
	DECLARE expiration_event_id INT(11);
	DECLARE event_group_id INT(11);

	SELECT id_evento_promemoria, id_evento_scadenza
		INTO reminder_event_id, expiration_event_id
	FROM ticket
	WHERE id_ticket = ticket_id AND anno = ticket_year;
	

	IF expiration_event_id IS NOT NULL THEN
		SELECT id_gruppo_evento
			INTO event_group_id
		FROM evento_gruppo_evento 
		WHERE id_evento = expiration_event_id;

		UPDATE evento
		SET Eliminato = 1,
			Utente_mod = user_id
		WHERE id = expiration_event_id;

		IF reminder_event_id IS NULL THEN
			
			UPDATE evento_gruppo
			SET Eliminato = 1,
				Utente_mod = user_id
			WHERE id = event_group_id;

		END IF;
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketDeleteReminderEvent
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketDeleteReminderEvent`(
	IN ticket_id INT,
	IN ticket_year INT,
	IN user_id INT
)
BEGIN
	DECLARE reminder_event_id INT(11);
	DECLARE expiration_event_id INT(11);
	DECLARE event_group_id INT(11);

	SELECT id_evento_promemoria, id_evento_scadenza
		INTO reminder_event_id, expiration_event_id
	FROM ticket
	WHERE id_ticket = ticket_id AND anno = ticket_year;


	IF reminder_event_id IS NOT NULL THEN
		SELECT id_gruppo_evento
			INTO event_group_id
		FROM evento_gruppo_evento 
		WHERE id_evento = reminder_event_id;

		UPDATE evento
		SET Eliminato = 1,
			Utente_mod = user_id
		WHERE id = reminder_event_id;

		IF expiration_event_id IS NULL THEN
			UPDATE evento_gruppo
			SET Eliminato = 1,
				Utente_mod = user_id
			WHERE id = event_group_id;
		END IF;
	END IF;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketEnsureExpirationEvent
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketEnsureExpirationEvent`(
	IN ticket_id INT,
	IN ticket_year INT,
	IN system_id INT,
	IN customer_id INT,
	IN urgency_id INT,
	IN reminder_date DATE,
	IN reminder_event_id INT,
	IN expiration_date DATE,
	IN expiration_event_id INT,
	IN ticket_description TEXT,
	IN user_id INT,
	OUT event_id INT(11)
)
BEGIN
	DECLARE event_group_id INT(11);
	DECLARE urgency VARCHAR(50);
	DECLARE customer_name VARCHAR(250);
	DECLARE phone_number VARCHAR(250);
	DECLARE email VARCHAR(250);
	DECLARE system_description TEXT;
	DECLARE event_description TEXT;
	DECLARE event_subject TEXT;

	SET event_id = expiration_event_id;

	SELECT
		ragione_sociale,
		IFNULL(telefono, altro_telefono),
		mail
	INTO
		customer_name,
		phone_number,
		email
	FROM clienti 
		INNER JOIN riferimento_clienti
			ON clienti.id_cliente = riferimento_clienti.id_cliente AND id_riferimento = 1
	WHERE clienti.id_cliente = customer_id;

	SELECT
		impianto.descrizione
	INTO
		system_description
	FROM impianto
	WHERE id_impianto = system_id;

	SELECT
		IFNULL(urgenza.nome, 'NESSUNA')
	INTO
		urgency
	FROM urgenza
	WHERE id_urgenza = urgency_id;


	SELECT 
		evento_gruppo.id
	INTO
		event_group_id
	FROM evento_gruppo
		LEFT JOIN evento_gruppo_evento as evento_gruppo_evento_promemoria ON evento_gruppo_evento_promemoria.id_evento = reminder_event_id
		LEFT JOIN evento_gruppo_evento as evento_gruppo_evento_scadenza ON evento_gruppo_evento_scadenza.id_evento = expiration_event_id
	WHERE evento_gruppo.id IN (evento_gruppo_evento_promemoria.id_gruppo_evento, evento_gruppo_evento_scadenza.id_gruppo_evento);


	IF event_group_id IS NULL THEN
		INSERT INTO evento_gruppo
		SET
			oggetto = CONCAT('PROMEMORIA/SCADENZA TICKET ', ticket_id, '/', ticket_year),
			descrizione = CONCAT(
				'TICKET: ', ticket_description, '\n',
				'CLIENTE: ', IFNULL(customer_name, ''), '\n',
				'IMPIANTO: ', IFNULL(system_description, ''), '\n'
			),
			data_ora_inizio = CONCAT(LEAST(reminder_date, expiration_date), ' ', '08:00:00'),
			data_ora_fine = CONCAT(GREATEST(reminder_date, expiration_date), ' ', '20:00:00'),
			Data_ins = NOW(),
			Data_mod = NOW(),
			Utente_ins = user_id,
			Utente_mod = user_id;
		
 		SELECT LAST_INSERT_ID() INTO event_group_id;

	ELSE
		UPDATE evento_gruppo
		SET
			oggetto = CONCAT('PROMEMORIA/SCADENZA TICKET ', ticket_id, '/', ticket_year),
			descrizione = CONCAT(
				'TICKET: ', ticket_description, '\n',
				'CLIENTE: ', IFNULL(customer_name, ''), '\n',
				'IMPIANTO: ', IFNULL(system_description, ''), '\n'
			),
			data_ora_inizio = CONCAT(LEAST(reminder_date, expiration_date), ' ', '08:00:00'),
			Data_mod = NOW(),
			Utente_mod = user_id
		WHERE id = event_group_id;

	END IF;
	
	SET event_subject = CONCAT('SCADENZA TICKET ', ticket_id, '/', ticket_year);
	SET event_description = CONCAT(
		'TICKET: ', ticket_description, '\n',
		'CLIENTE: ', IFNULL(customer_name, ''), '\n',
		'IMPIANTO: ', IFNULL(system_description, ''), '\n',
		'URGENZA: ', IFNULL(urgency, ''), '\n',
		'TELEFONO: ', IFNULL(phone_number, ''), '\n',
		'EMAIL: ', IFNULL(email, ''), '\n'
	);


	IF event_id IS NULL THEN
		INSERT INTO Evento
		SET 
			Oggetto = event_subject, 
			Descrizione = event_description, 
			Id_riferimento = NULL, 
			id_tipo_evento = 60, 
			Eseguito = 0, 
			Ricorrente = 0,
			giorni_ricorrenza = 0,
			Data_esecuzione = expiration_date, 
			Sveglia = 0, 
			Data_sveglia = '1970-01-01 00:00:00',
			Ora_inizio_esecuzione = '09:00:00',
			ora_fine_esecuzione = '10:00:00',
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_ins = user_id;
			
 		SELECT LAST_INSERT_ID() INTO event_id;
		
		INSERT INTO Evento_gruppo_evento (Id_evento, Id_gruppo_evento, Tipo_associazione, Timestamp)
			VALUES (event_id, event_group_id, 1, CURRENT_TIMESTAMP);
	ELSE
		UPDATE Evento
		SET 
			Oggetto = event_subject, 
			Descrizione = event_description, 
			Data_esecuzione = expiration_date, 
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_mod = user_id
		WHERE Id = event_id; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketEnsureReminderEvent
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketEnsureReminderEvent`(
	IN ticket_id INT,
	IN ticket_year INT,
	IN system_id INT,
	IN customer_id INT,
	IN urgency_id INT,
	IN reminder_date DATE,
	IN reminder_event_id INT,
	IN expiration_date DATE,
	IN expiration_event_id INT,
	IN ticket_description TEXT,
	IN user_id INT,
	OUT event_id INT(11)
)
BEGIN
	DECLARE event_group_id INT(11);
	DECLARE urgency VARCHAR(50);
	DECLARE customer_name VARCHAR(250);
	DECLARE phone_number VARCHAR(250);
	DECLARE email VARCHAR(250);
	DECLARE system_description TEXT;
	DECLARE event_description TEXT;
	DECLARE event_subject TEXT;

	SET event_id = reminder_event_id;

	SELECT
		ragione_sociale,
		IFNULL(telefono, altro_telefono),
		mail
	INTO
		customer_name,
		phone_number,
		email
	FROM clienti 
		INNER JOIN riferimento_clienti
			ON clienti.id_cliente = riferimento_clienti.id_cliente AND id_riferimento = 1
	WHERE clienti.id_cliente = customer_id;

	SELECT
		impianto.descrizione
	INTO
		system_description
	FROM impianto
	WHERE id_impianto = system_id;

	SELECT
		IFNULL(urgenza.nome, 'NESSUNA')
	INTO
		urgency
	FROM urgenza
	WHERE id_urgenza = urgency_id;


	SELECT 
		evento_gruppo.id
	INTO
		event_group_id
	FROM evento_gruppo
		LEFT JOIN evento_gruppo_evento as evento_gruppo_evento_promemoria ON evento_gruppo_evento_promemoria.id_evento = reminder_event_id
		LEFT JOIN evento_gruppo_evento as evento_gruppo_evento_scadenza ON evento_gruppo_evento_scadenza.id_evento = expiration_event_id
	WHERE evento_gruppo.id IN (evento_gruppo_evento_promemoria.id_gruppo_evento, evento_gruppo_evento_scadenza.id_gruppo_evento);


	IF event_group_id IS NULL THEN
		INSERT INTO evento_gruppo
		SET
			oggetto = CONCAT('PROMEMORIA/SCADENZA TICKET ', ticket_id, '/', ticket_year),
			descrizione = CONCAT(
				'TICKET: ', ticket_description, '\n',
				'CLIENTE: ', IFNULL(customer_name, ''), '\n',
				'IMPIANTO: ', IFNULL(system_description, ''), '\n'
			),
			data_ora_inizio = CONCAT(LEAST(reminder_date, expiration_date), ' ', '08:00:00'),
			data_ora_fine = CONCAT(GREATEST(reminder_date, expiration_date), ' ', '20:00:00'),
			Data_ins = NOW(),
			Data_mod = NOW(),
			Utente_ins = user_id,
			Utente_mod = user_id;
		
 		SELECT LAST_INSERT_ID() INTO event_group_id;

	ELSE
		UPDATE evento_gruppo
		SET
			oggetto = CONCAT('PROMEMORIA/SCADENZA TICKET ', ticket_id, '/', ticket_year),
			descrizione = CONCAT(
				'TICKET: ', ticket_description, '\n',
				'CLIENTE: ', IFNULL(customer_name, ''), '\n',
				'IMPIANTO: ', IFNULL(system_description, ''), '\n'
			),
			data_ora_inizio = CONCAT(LEAST(reminder_date, expiration_date), ' ', '08:00:00'),
			Data_mod = NOW(),
			Utente_mod = user_id
		WHERE id = event_group_id;

	END IF;

	
	SET event_subject = CONCAT('PROMEMORIA TICKET ', ticket_id, '/', ticket_year);
	SET event_description = CONCAT(
		'TICKET: ', ticket_description, '\n',
		'CLIENTE: ', IFNULL(customer_name, ''), '\n',
		'IMPIANTO: ', IFNULL(system_description, ''), '\n',
		'URGENZA: ', IFNULL(urgency, ''), '\n',
		'TELEFONO: ', IFNULL(phone_number, ''), '\n',
		'EMAIL: ', IFNULL(email, ''), '\n'
	);

	IF event_id IS NULL THEN
		INSERT INTO Evento
		SET 
			Oggetto = event_subject, 
			Descrizione = event_description, 
			Id_riferimento = NULL, 
			id_tipo_evento = 60, 
			Eseguito = 0, 
			Ricorrente = 0,
			giorni_ricorrenza = 0,
			Data_esecuzione = reminder_date, 
			Sveglia = 0, 
			Data_sveglia = '1970-01-01 00:00:00',
			Ora_inizio_esecuzione = '09:00:00',
			ora_fine_esecuzione = '10:00:00',
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_ins = user_id;
			
 		SELECT LAST_INSERT_ID() INTO event_id;
		
		INSERT INTO Evento_gruppo_evento (Id_evento, Id_gruppo_evento, Tipo_associazione, Timestamp)
			VALUES (event_id, event_group_id, 1, CURRENT_TIMESTAMP);
	ELSE
		UPDATE Evento
		SET 
			Oggetto = event_subject, 
			Descrizione = event_description, 
			Data_esecuzione = reminder_date, 
			Data_mod = CURRENT_TIMESTAMP, 
			Utente_mod = user_id
		WHERE Id = event_id; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketGet
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketGet`( )
BEGIN
        

	SELECT 
		Id,
		Id_ticket, 
		Anno,
		IFNULL(Id_impianto, 0) AS id_impianto, 
		CAST(IFNULL(data_ora, '1970-01-01') AS DATETIME) As data_ora,
		IFNULL(Id_cliente, 0) AS Id_cliente, 
		IFNULL(Descrizione, "") AS Descrizione, 
		IFNULL(Causale, 0) As Causale, 
		IFNULL(Urgenza, 0) AS Urgenza, 
		IFNULL(intervento, 0) As Intervento, 
		IFNULL(comunicazione, 0) AS comunicazione, 
		IFNULL(id_destinazione, 0) AS Id_destinazione,  
		IFNULL(sede_principale, 0) AS sede_principale, 
		IFNULL(stato_ticket, 0) AS stato_ticket, 
		IFNULL(tempo, 0) As Tempo, 
		CAST(IFNULL(scadenza, '1970-01-01') AS DATETIME) AS scadenza,
		IFNULL(id_utente, 0) AS Id_utente, 
		IFNULL(stampato, 0) As Stampato, 
		CAST(IFNULL(data_ticket, '1970-01-01') AS DATETIME) AS data_ticket,
		IFNULL(num_tick, 0) As num_tick,
		IFNULL(inviato, 0) As inviato,
		CAST(IFNULL(data_promemoria, '1970-01-01') AS DATETIME) AS data_promemoria		
	FROM Ticket;  
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketGetByCustomerId
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketGetByCustomerId`( 
  CustomerId INT
)
BEGIN
        

	SELECT 
		Id,
		Id_ticket, 
		Anno,
		IFNULL(Id_impianto, 0) AS id_impianto, 
		CAST(IFNULL(data_ora, '1970-01-01') AS DATETIME) As data_ora,
		IFNULL(Id_cliente, 0) AS Id_cliente, 
		IFNULL(Descrizione, "") AS Descrizione, 
		IFNULL(Causale, 0) As Causale, 
		IFNULL(Urgenza, 0) AS Urgenza, 
		IFNULL(intervento, 0) As Intervento, 
		IFNULL(comunicazione, 0) AS comunicazione, 
		IFNULL(id_destinazione, 0) AS Id_destinazione,  
		IFNULL(sede_principale, 0) AS sede_principale, 
		IFNULL(stato_ticket, 0) AS stato_ticket, 
		IFNULL(tempo, 0) As Tempo, 
		CAST(IFNULL(scadenza, '1970-01-01') AS DATETIME) AS scadenza,
		IFNULL(id_utente, 0) AS Id_utente, 
		IFNULL(stampato, 0) As Stampato, 
		CAST(IFNULL(data_ticket, '1970-01-01') AS DATETIME) AS data_ticket,
		IFNULL(num_tick, 0) As num_tick,
		IFNULL(inviato, 0) As inviato,
		CAST(IFNULL(data_promemoria, '1970-01-01') AS DATETIME) AS data_promemoria		
	FROM Ticket
	WHERE (Id_cliente = customerid); 
		
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketGetById`( 
  ticketid INT
)
BEGIN
        

	SELECT 
		Id,
		Id_ticket, 
		Anno,
		IFNULL(Id_impianto, 0) AS id_impianto, 
		CAST(IFNULL(data_ora, '1970-01-01') AS DATETIME) As data_ora,
		IFNULL(Id_cliente, 0) AS Id_cliente, 
		IFNULL(Descrizione, "") AS Descrizione, 
		IFNULL(Causale, 0) As Causale, 
		IFNULL(Urgenza, 0) AS Urgenza, 
		IFNULL(intervento, 0) As Intervento, 
		IFNULL(comunicazione, 0) AS comunicazione, 
		IFNULL(id_destinazione, 0) AS Id_destinazione,  
		IFNULL(sede_principale, 0) AS sede_principale, 
		IFNULL(stato_ticket, 0) AS stato_ticket, 
		IFNULL(tempo, 0) As Tempo, 
		CAST(IFNULL(scadenza, '1970-01-01') AS DATETIME) AS scadenza,
		IFNULL(id_utente, 0) AS Id_utente, 
		IFNULL(stampato, 0) As Stampato, 
		CAST(IFNULL(data_ticket, '1970-01-01') AS DATETIME) AS data_ticket,
		IFNULL(num_tick, 0) As num_tick,
		IFNULL(inviato, 0) As inviato,
		CAST(IFNULL(data_promemoria, '1970-01-01') AS DATETIME) AS data_promemoria		
	FROM Ticket
	WHERE (Id = ticketid); 
		
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketGetByStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketGetByStatus`( 
	ticketsStatus MEDIUMTEXT
)
BEGIN

  SELECT DISTINCT Ticket.Id,
		Ticket.Id_ticket, 
		Ticket.Anno,
		IFNULL(Ticket.Id_impianto, 0) AS id_impianto, 
		CAST(IFNULL(Ticket.data_ora, "1970-01-01") AS DATETIME) As data_ora,
		IFNULL(Ticket.Id_cliente, 0) AS Id_cliente, 
		IFNULL(Ticket.Descrizione, "") AS Descrizione, 
		IFNULL(Ticket.Causale, 0) As Causale, 
		IFNULL(Ticket.Urgenza, 0) AS Urgenza, 
		IFNULL(Ticket.intervento, 0) As Intervento, 
		IFNULL(Ticket.comunicazione, 0) AS comunicazione, 
		IFNULL(Ticket.id_destinazione, 0) AS Id_destinazione,  
		IFNULL(Ticket.sede_principale, 0) AS sede_principale, 
		IFNULL(Ticket.stato_ticket, 0) AS stato_ticket, 
		IFNULL(Ticket.tempo, 0) As Tempo, 
		CAST(IFNULL(Ticket.scadenza, "1970-01-01") AS DATETIME) AS scadenza,
		IFNULL(Ticket.id_utente, 0) AS Id_utente, 
		IFNULL(Ticket.stampato, 0) As Stampato, 
		CAST(IFNULL(Ticket.data_ticket, "1970-01-01") AS DATETIME) AS data_ticket,
		IFNULL(Ticket.num_tick, 0) As num_tick,
		IFNULL(Ticket.inviato, 0) As inviato,
		CAST(IFNULL(Ticket.data_promemoria, "1970-01-01") AS DATETIME) AS data_promemoria		 
	 FROM Ticket
	 WHERE  FIND_IN_SET(ticket.Stato_ticket ,ticketsStatus) > 0;  
  
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketGetBySystemId
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketGetBySystemId`( 
  SystemId INT
)
BEGIN
        

	SELECT 
		Id,
		Id_ticket, 
		Anno,
		IFNULL(Id_impianto, 0) AS id_impianto, 
		CAST(IFNULL(data_ora, '1970-01-01') AS DATETIME) As data_ora,
		IFNULL(Id_cliente, 0) AS Id_cliente, 
		IFNULL(Descrizione, "") AS Descrizione, 
		IFNULL(Causale, 0) As Causale, 
		IFNULL(Urgenza, 0) AS Urgenza, 
		IFNULL(intervento, 0) As Intervento, 
		IFNULL(comunicazione, 0) AS comunicazione, 
		IFNULL(id_destinazione, 0) AS Id_destinazione,  
		IFNULL(sede_principale, 0) AS sede_principale, 
		IFNULL(stato_ticket, 0) AS stato_ticket, 
		IFNULL(tempo, 0) As Tempo, 
		CAST(IFNULL(scadenza, '1970-01-01') AS DATETIME) AS scadenza,
		IFNULL(id_utente, 0) AS Id_utente, 
		IFNULL(stampato, 0) As Stampato, 
		CAST(IFNULL(data_ticket, '1970-01-01') AS DATETIME) AS data_ticket,
		IFNULL(num_tick, 0) As num_tick,
		IFNULL(inviato, 0) As inviato,
		CAST(IFNULL(data_promemoria, '1970-01-01') AS DATETIME) AS data_promemoria		
	FROM Ticket
	WHERE (id_impianto = systemid); 
		
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketGetByTagId
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketGetByTagId`( 
  tag_id INT
)
BEGIN
        

	SELECT 
		Id,
		Ticket.Id_ticket, 
		Anno,
		IFNULL(Id_impianto, 0) AS id_impianto, 
		CAST(IFNULL(data_ora, '1970-01-01') AS DATETIME) As data_ora,
		IFNULL(Id_cliente, 0) AS Id_cliente, 
		IFNULL(Descrizione, "") AS Descrizione, 
		IFNULL(Causale, 0) As Causale, 
		IFNULL(Urgenza, 0) AS Urgenza, 
		IFNULL(intervento, 0) As Intervento, 
		IFNULL(comunicazione, 0) AS comunicazione, 
		IFNULL(id_destinazione, 0) AS Id_destinazione,  
		IFNULL(sede_principale, 0) AS sede_principale, 
		IFNULL(stato_ticket, 0) AS stato_ticket, 
		IFNULL(tempo, 0) As Tempo, 
		CAST(IFNULL(scadenza, '1970-01-01') AS DATETIME) AS scadenza,
		IFNULL(id_utente, 0) AS Id_utente, 
		IFNULL(stampato, 0) As Stampato, 
		CAST(IFNULL(data_ticket, '1970-01-01') AS DATETIME) AS data_ticket,
		IFNULL(num_tick, 0) As num_tick,
		IFNULL(inviato, 0) As inviato,
		CAST(IFNULL(data_promemoria, '1970-01-01') AS DATETIME) AS data_promemoria		
	FROM Ticket
		INNER JOIN ticket_tag ON Ticket.id_ticket = ticket_tag.id_ticket AND Ticket.anno = ticket_tag.anno_ticket
	WHERE ticket_tag.id_tag = tag_id; 
		
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketGetByUrgencyStatus
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketGetByUrgencyStatus`( 
	urgencyStatus MEDIUMTEXT
)
BEGIN

  SELECT DISTINCT Ticket.Id,
		Ticket.Id_ticket, 
		Ticket.Anno,
		IFNULL(Ticket.Id_impianto, 0) AS id_impianto, 
		CAST(IFNULL(Ticket.data_ora, "1970-01-01") AS DATETIME) As data_ora,
		IFNULL(Ticket.Id_cliente, 0) AS Id_cliente, 
		IFNULL(Ticket.Descrizione, "") AS Descrizione, 
		IFNULL(Ticket.Causale, 0) As Causale, 
		IFNULL(Ticket.Urgenza, 0) AS Urgenza, 
		IFNULL(Ticket.intervento, 0) As Intervento, 
		IFNULL(Ticket.comunicazione, 0) AS comunicazione, 
		IFNULL(Ticket.id_destinazione, 0) AS Id_destinazione,  
		IFNULL(Ticket.sede_principale, 0) AS sede_principale, 
		IFNULL(Ticket.stato_ticket, 0) AS stato_ticket, 
		IFNULL(Ticket.tempo, 0) As Tempo, 
		CAST(IFNULL(Ticket.scadenza, "1970-01-01") AS DATETIME) AS scadenza,
		IFNULL(Ticket.id_utente, 0) AS Id_utente, 
		IFNULL(Ticket.stampato, 0) As Stampato, 
		CAST(IFNULL(Ticket.data_ticket, "1970-01-01") AS DATETIME) AS data_ticket,
		IFNULL(Ticket.num_tick, 0) As num_tick,
		IFNULL(Ticket.inviato, 0) As inviato,
		CAST(IFNULL(Ticket.data_promemoria, "1970-01-01") AS DATETIME) AS data_promemoria		 
	 FROM Ticket
	 WHERE  FIND_IN_SET(ticket.Urgenza, urgencyStatus) > 0;  
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketGetToScheduled
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketGetToScheduled`( 
	IN group_id INT(11)
)
BEGIN

	DROP TABLE IF EXISTS tmp_events_ticket;
	CREATE TEMPORARY TABLE tmp_events_ticket
	SELECT Evento.* 
	FROM Evento
		INNER JOIN Evento_gruppo_evento ON Evento_gruppo_evento.Id_evento = Evento.Id AND Evento_gruppo_evento.Id_gruppo_evento != group_id
	WHERE evento.Id_tipo_evento = 2; 
				


	SELECT DISTINCT Ticket.Id,
		Ticket.Id_ticket, 
		Ticket.Anno,
		IFNULL(Ticket.Id_impianto, 0) AS id_impianto, 
		CAST(IFNULL(Ticket.data_ora, '1970-01-01') AS DATETIME) As data_ora,
		IFNULL(Ticket.Id_cliente, 0) AS Id_cliente, 
		IFNULL(Ticket.Descrizione, "") AS Descrizione, 
		IFNULL(Ticket.Causale, 0) As Causale, 
		IFNULL(Ticket.Urgenza, 0) AS Urgenza, 
		IFNULL(Ticket.intervento, 0) As Intervento, 
		IFNULL(Ticket.comunicazione, 0) AS comunicazione, 
		IFNULL(Ticket.id_destinazione, 0) AS Id_destinazione,  
		IFNULL(Ticket.sede_principale, 0) AS sede_principale, 
		IFNULL(Ticket.stato_ticket, 0) AS stato_ticket, 
		IFNULL(Ticket.tempo, 0) As Tempo, 
		CAST(IFNULL(Ticket.scadenza, '1970-01-01') AS DATETIME) AS scadenza,
		IFNULL(Ticket.id_utente, 0) AS Id_utente, 
		IFNULL(Ticket.stampato, 0) As Stampato, 
		CAST(IFNULL(Ticket.data_ticket, '1970-01-01') AS DATETIME) AS data_ticket,
		IFNULL(Ticket.num_tick, 0) As num_tick,
		IFNULL(Ticket.inviato, 0) As inviato,
		CAST(IFNULL(Ticket.data_promemoria, '1970-01-01') AS DATETIME) AS data_promemoria		 
	 FROM Ticket
		LEFT JOIN tmp_events_ticket as evento 
		  ON evento.Id_tipo_evento = 2 AND ticket.Id = evento.Id_riferimento 
	 WHERE  ticket.Stato_ticket IN (1,2) AND (evento.Id IS NULL OR Evento.eliminato)
	 ORDER BY Ticket.data_ora ;  
 
 END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketTagDeleteByTicket
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketTagDeleteByTicket`( 
	IN ticket_id INT(11),
	IN ticket_year INT(11)
)
BEGIN

	DELETE FROM ticket_tag 
	WHERE id_ticket = ticket_id
		AND anno_ticket = ticket_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesTicketTagGetByTicket
DELIMITER //
CREATE PROCEDURE `sp_ariesTicketTagGetByTicket`(
	IN ticket_id INT,
	IN ticket_year INT
)
BEGIN
	SELECT 
		`id_ticket`,
		anno_ticket,
		ticket_tag.id_tag,
		tag.tag
	FROM ticket_tag
		INNER JOIN tag ON tag.id_tag = ticket_tag.id_tag
	WHERE id_ticket = ticket_id
		AND anno_ticket = ticket_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesUnitsOfMeasureGet
DELIMITER //
CREATE PROCEDURE `sp_ariesUnitsOfMeasureGet`()
BEGIN

	SELECT 
		Id, 
		Sigla, 
		nome
	FROM unita_misura
	ORDER BY Nome; 
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesUserCheckAdminPassword
DELIMITER //
CREATE PROCEDURE `sp_ariesUserCheckAdminPassword`(IN `pass` VARCHAR(50), OUT `result` BIT(1))
BEGIN
	
	SELECT COUNT(id_utente) > 0
	INTO result
	FROM utente
	WHERE nome = 'admin' AND password = CONVERT(SHA1(CONCAT(pass, salt)) USING latin1);
		
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesUserGet
DELIMITER //
CREATE PROCEDURE `sp_ariesUserGet`()
BEGIN
SELECT 

		id_utente, 
		Nome, 
		password,
		IFNULL(Descrizione,"") as descrizione,
		IFNULL(mail, "") AS mail, 
		IFNULL(Firma,"") as firma, 
		calendario,  
		IFNULL(smtp, "") as smtp, 
		IFNULL(porta, "0") as porta, 
		IFNULL(mssl, 0) as mssl,
		IFNULL(nome_utente_mail, "") as nome_utente_mail,
		IFNULL(password_mail, "") as password_mail, 
		tipo_utente, 
		conferma, 
		salt
		
	  
		FROM utente;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesUserGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesUserGetById`(
user_id INT)
BEGIN
SELECT 

		id_utente, 
		Nome, 
		password,
		IFNULL(Descrizione,"") as descrizione,
		IFNULL(mail, "") as mail, 
		IFNULL(Firma,"") as firma, 
		calendario,  
		IFNULL(smtp, "") as smtp, 
		IFNULL(porta, "0") as porta, 
		IFNULL(mssl, 0) as mssl,
		IFNULL(nome_utente_mail, "") as nome_utente_mail,
		IFNULL(password_mail, "") as password_mail, 
		tipo_utente, 
		conferma, 
		salt
		
	  
		FROM utente
		WHERE id_utente = user_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesUserLogin
DELIMITER //
CREATE PROCEDURE `sp_ariesUserLogin`(IN `username` VARCHAR(50), IN `pass` VARCHAR(50), OUT `userId` INT)
BEGIN
	DECLARE company_id INT; 
	
	SELECT id_utente 
	INTO userId 
	FROM utente
	WHERE nome = username 
		AND password = CONVERT(SHA1(CONCAT(pass, salt)) USING latin1);
		
	SET userId = IFNULL(userId, 0);
	
	SELECT Id_azienda INTO company_id
	FROM azienda  
	ORDER BY id_azienda DESC
	LIMIT 1;
	
	
	SET @USER_ID = userId; 
	SET @COMPANY_ID = IFNULL(company_id, 0);
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesUserRolesGet
DELIMITER //
CREATE PROCEDURE `sp_ariesUserRolesGet`(
)
BEGIN
	SELECT 
		id,
		nome, 
		descrizione,
		app_name
	FROM utente_roles;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesUserRolesGetUserId
DELIMITER //
CREATE PROCEDURE `sp_ariesUserRolesGetUserId`(
	IN user_id INT(11)
)
BEGIN
	SELECT 
		utente_roles.id, 
		utente_utente_roles.id_utente,
		nome, 
		descrizione,
		app_name
	FROM utente_roles
		INNER JOIN utente_utente_roles ON utente_utente_roles.id_utente_roles = utente_roles.id
	WHERE id_utente = user_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesVatNatureTypeGet
DELIMITER //
CREATE PROCEDURE `sp_ariesVatNatureTypeGet`(
		IN `in_include_disabled` BIT(1)
)
BEGIN

	SELECT `id_tipo_natura_iva`,
		`nome`,
		`descrizione`,
		nota_fattura,
		`tipo_PA`,
		`abilitato`,
		`data_mod`
	FROM tipo_natura_iva
	WHERE abilitato = true or (abilitato = false and in_include_disabled = true);

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesVatNatureTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesVatNatureTypeGetById`(
		IN `in_id` INT(11)
)
BEGIN

	SELECT `id_tipo_natura_iva`,
		`nome`,
		`descrizione`,
		nota_fattura,
		`tipo_PA`,
		`abilitato`,
		`data_mod`
	FROM tipo_natura_iva
	WHERE id_tipo_natura_iva = in_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesVatNatureTypeInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesVatNatureTypeInsert`(
	IN in_name VARCHAR(100),
	IN in_description VARCHAR(350),
	IN in_nature_type VARCHAR(10),
	IN in_invoice_note TEXT,
	IN in_enabled BIT(1),
	OUT result INT(11)
)
BEGIN
	INSERT INTO tipo_natura_iva
	(
		`nome`,
		`descrizione`,
		`tipo_PA`,
		nota_fattura,
		`abilitato`
	)
	VALUES
	(
		in_name,
		in_description,
		in_nature_type,
		in_invoice_note,
		in_enabled
	);

	
	SET result = LAST_INSERT_ID();
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesVatNatureTypeUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesVatNatureTypeUpdate`(
	IN in_vat_nature_type_id INT(11),
	IN in_name VARCHAR(100),
	IN in_description VARCHAR(350),
	IN in_nature_type VARCHAR(10),
	IN in_invoice_note TEXT,
	IN in_enabled BIT(1),
	OUT result INT(11)
)
BEGIN

	UPDATE tipo_natura_iva
	SET
		`nome` = in_name,
		`descrizione` = in_description,
		nota_fattura = in_invoice_note,
		`tipo_PA` = in_nature_type,
		`abilitato` = in_enabled
	WHERE id_tipo_natura_iva = in_vat_nature_type_id;

	
	SET result = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesVatTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesVatTypeGetById`(
	vat_id INT(11)
)
BEGIN

	SELECT
		`Id_iva`,
		`Nome`,
		`Descrizione`,
		`aliquota`,
		`MESSAGGIO`,
		`normale`,
		`esigibilita`,
		`in_uso`
	FROM tipo_iva
	WHERE Id_iva = vat_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesVatTypeGetByValue
DELIMITER //
CREATE PROCEDURE `sp_ariesVatTypeGetByValue`(
	vat_value INT(11)
)
BEGIN

	SELECT
		`Id_iva`,
		`Nome`,
		`Descrizione`,
		`aliquota`,
		`MESSAGGIO`,
		`normale`,
		`esigibilita`,
		`in_uso`
	FROM tipo_iva
	WHERE aliquota = vat_value
	ORDER BY in_uso desc;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesVatTypeGetDefault
DELIMITER //
CREATE PROCEDURE `sp_ariesVatTypeGetDefault`(
)
BEGIN

	SELECT
		`Id_iva`,
		`Nome`,
		`Descrizione`,
		`aliquota`,
		`MESSAGGIO`,
		`normale`,
		`esigibilita`,
		`in_uso`
	FROM tipo_iva
	WHERE normale = 1;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesWithdrawalGetById
DELIMITER //
CREATE PROCEDURE `sp_ariesWithdrawalGetById`( 
enter_id INT, 
enter_year INT
)
BEGIN
        
	SELECT 
		`Id_lista`,
		`Anno`,
		cliente,
		`id_destinazione`,
		`Id_operaio`,
		`rientro`,
		`causale`,
		`Data`,
		`Tipo_materiale`,
		`Nota`,
		`colli`,
		`id_principale`,
		`Id_ddt`,
		`id_anno`,
		`id_utente`,
		`timestamp`
	FROM lista_prelievo
	WHERE Id_lista = enter_id AND Anno = enter_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesWithdrawalInsert
DELIMITER //
CREATE PROCEDURE `sp_ariesWithdrawalInsert`(
	enter_year INT(11),
	customer_id INT(11),
	destination_id INT(11),
	employee_id INT(11),
	is_return BIT, 
	causal_id INT(11),
	exec_date DATE, 
	material_type INT(11), 
	notes TEXT, 
	packages INT(11), 
	main_id INT(11), 
	ddt_id INT(11), 
	ddt_year INT(11), 
	OUT result INTEGER
)
MainLabel:BEGIN


	DECLARE new_id INT(11); 
	SET Result = 1; 

	SELECT IFNULL(MAX(id_lista) + 1, 1) 
	INTO new_id
	FROM lista_prelievo 
	WHERE Anno = enter_year; 
	
	IF Result 
	THEN

		INSERT INTO lista_prelievo
		SET 
			Id_lista = new_id,
			Anno = enter_year,
			cliente = customer_id,
			id_destinazione = destination_id,
			Id_operaio = employee_id,
			rientro = is_return,
			causale = causal_id,
			Data = exec_date,
			Tipo_materiale = material_type,
			Nota = notes,
			colli = packages,
			id_principale = main_id,
			id_ddt = ddt_id,
			id_anno = ddt_year,
			id_utente = @USER_ID;

		SET Result = new_id; 
	END IF;  
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesWithdrawalLookDeleteByWithdrawal
DELIMITER //
CREATE PROCEDURE `sp_ariesWithdrawalLookDeleteByWithdrawal`( 
	enter_id INT, 
	enter_year INT
)
BEGIN
        
	DELETE FROM lista_aspetto
	WHERE Id_lista = enter_id AND Anno = enter_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesWithdrawalLookGetByWithdrawal
DELIMITER //
CREATE PROCEDURE `sp_ariesWithdrawalLookGetByWithdrawal`( 
	enter_id INT, 
	enter_year INT
)
BEGIN
        
	SELECT 
		`id_lista`,
		`anno`,
		vista
	FROM lista_aspetto
	WHERE Id_lista = enter_id AND Anno = enter_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesWithdrawalRowDeleteByWithdrawal
DELIMITER //
CREATE PROCEDURE `sp_ariesWithdrawalRowDeleteByWithdrawal`( 
	enter_id INT, 
	enter_year INT
)
BEGIN
        
	DELETE FROM lista_articoli
	WHERE Id_lista = enter_id AND Anno = enter_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesWithdrawalRowGetByWithdrawal
DELIMITER //
CREATE PROCEDURE `sp_ariesWithdrawalRowGetByWithdrawal`( 
	enter_id INT, 
	enter_year INT
)
BEGIN
        
	SELECT 
		`id_articolo`,
		`id_lista`,
		`Desc_breve`,
		`anno`,
		`codice_fornitore`,
		`numero_tab`,
		`quantità`,
		`Unità_misura`,
		`Serial_number`,
		`non_consegnati`,
		`data_consegna`,
		`causale_scarico`, 
		foto_filename
	FROM lista_articoli
	WHERE Id_lista = enter_id AND Anno = enter_year; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesWithdrawalUpdate
DELIMITER //
CREATE PROCEDURE `sp_ariesWithdrawalUpdate`(
	enter_id INT(11),
	enter_year INT(11),
	customer_id INT(11),
	destination_id INT(11),
	employee_id INT(11),
	is_return BIT, 
	causal_id INT(11),
	exec_date DATE, 
	material_type INT(11), 
	notes TEXT, 
	packages INT(11), 
	main_id INT(11), 
	ddt_id INT(11), 
	ddt_year INT(11), 
	OUT result INTEGER
)
MainLabel:BEGIN
	SET Result = 1; 
	
	IF Result 
	THEN
		UPDATE lista_prelievo
		SET 
			cliente = customer_id,
			id_destinazione = destination_id,
			Id_operaio = employee_id,
			rientro = is_return,
			causale = causal_id,
			Data = exec_date,
			Tipo_materiale = material_type,
			Nota = notes,
			colli = packages,
			id_principale = main_id,
			id_ddt = ddt_id,
			id_anno = ddt_year

		WHERE Id_lista = enter_id AND Anno = enter_year; 
		
		SET Result = 1; 
			
	END IF;  
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ariesXmlSpecialCharsReplaceGet
DELIMITER //
CREATE PROCEDURE `sp_ariesXmlSpecialCharsReplaceGet`( 
)
BEGIN
	SELECT `Id`,
		`search_string`,
		`replace_string`,
		`is_regexp`,
		`enabled`
	FROM xml_caratteri_speciali_replacement
	WHERE enabled = 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ddtAssociate
DELIMITER //
CREATE PROCEDURE `sp_ddtAssociate`(
	ddtId INT, ddtYear INT, docId INT, docYear INT, docType VARCHAR(20),
	OUT ddtAssociateResult INT
)
BEGIN

	DECLARE res TINYINT;
	DECLARE ddtStatusResult INT;

	IF docId < 0 OR docYear < 0 THEN
		SET docId = NULL;
		SET docYear = NULL;
	END IF;
	IF docType = 'INVOICE' THEN
		UPDATE ddt SET
			fattura = docId,
			anno_fattura = docYear
		WHERE id_ddt = ddtId
			AND anno = ddtYear;
	END IF;

	IF docType = 'SUPPLIERINVOICE' THEN
		UPDATE ddt SET 
			fatturaf = docId,
			anno_fatturaf = docYear
		WHERE id_ddt = ddtId
			AND anno = ddtYear;
	END IF;
	
	IF docType = 'RECEIVED_DDT' THEN
		IF NOT ISNULL(docId) THEN
			INSERT INTO ddt_ricevuti_emessi SET 
				id_r = docId, 
				anno_r = docYear, 
				anno_e = ddtYear, 
				id_e = ddtId, 
				tipo = "1";
		END IF;
	END IF;
	
	
	CALL sp_onDdtDeterminingStatus(ddtId, ddtYear, CONCAT('ASSOC ', docType), ddtStatusResult);
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ddtDissociate
DELIMITER //
CREATE PROCEDURE `sp_ddtDissociate`(
	ddtId INT, ddtYear INT, docId INT, docYear INT, docType VARCHAR(20),
	OUT ddtDissociateResult INT
)
BEGIN

	DECLARE ddtStatusResult INT;

	IF docId < 0 OR docYear < 0 THEN
		SET docId = NULL;
		SET docYear = NULL;
	END IF;

	IF docType = 'INVOICE' THEN
		UPDATE ddt SET
			fattura = NULL,
			anno_fattura = NULL
		WHERE id_ddt = ddtId
			AND anno = ddtYear;
	END IF;

	IF docType = 'SUPPLIERINVOICE' THEN
		UPDATE ddt SET 
			fatturaf = NULL,
			anno_fatturaf = NULL
		WHERE id_ddt = ddtId
			AND anno = ddtYear;
	END IF;
	
	IF docType = 'RECEIVED_DDT' THEN
		DELETE FROM ddt_ricevuti_emessi
		WHERE id_r = docId
			AND anno_r = docYear 
			AND anno_e = ddtYear 
			AND id_e = ddtId;
	END IF;

	CALL sp_onDdtDeterminingStatus(ddtId, ddtYear, CONCAT('DISSOC ', docType), ddtStatusResult);
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ddtGetPrintInformationsToBeBilled
DELIMITER //
CREATE PROCEDURE `sp_ddtGetPrintInformationsToBeBilled`(
	ddtYear SMALLINT, OUT ddtsNumbers MEDIUMINT, OUT ddtsTotalPrice DECIMAL(11,2), OUT ddtsTotalCost DECIMAL(11,2))
BEGIN

	SELECT * 
	FROM
	(
		
		SELECT 
			ddt.id_ddt AS "DdtId", 
			data_documento AS "Date", 
			clienti.ragione_sociale AS "CompanyName",
			causale_trasporto.causale AS "CausalTransport", 
			IFNULL(CONCAT(b1.cap," - ",b1.nome,"(", b.provincia,")"), "") AS "Municipality",  
			IFNULL(ddt.fattura, "") AS "InvoiceId",
			IFNULL(impianto.descrizione, "") AS "SystemDescription", 
			CAST(IFNULL(SUM(prezzo*quantità-(prezzo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS TotalPrice, 
			CAST(IFNULL(SUM(costo*quantità-(costo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS TotalCost,
			IF(commessa_ddt.Id_commessa IS NOT NULL, "in_job", "open") AS "Status"
		FROM ddt
			LEFT JOIN causale_trasporto ON ddt.causale=id_causale
			INNER JOIN clienti ON clienti.id_cliente=ddt.id_cliente
			LEFT JOIN destinazione_cliente AS b ON b.id_cliente=ddt.id_cliente AND b.id_destinazione=ddt.id_destinazione
			LEFT JOIN comune AS b1 ON b1.id_comune=b.comune
			LEFT JOIN impianto ON id_impianto=impianto
			LEFT JOIN articoli_ddt ON articoli_ddt.id_ddt=ddt.id_ddt AND articoli_ddt.anno=ddt.anno
			LEFT JOIN commessa_ddt ON commessa_ddt.Id_ddt=ddt.id_ddt AND commessa_ddt.Anno_ddt=ddt.anno 
		WHERE ddt.Stato IN (1,2)  AND ddt.anno = IF(ddtYear, ddtYear, ddt.anno)
		GROUP BY ddt.Id_ddt, ddt.anno
		
		UNION 
		
		
		SELECT
			ddt.id_ddt AS "DdtId", 
			data_documento AS "Date", 
			clienti.ragione_sociale AS "CompanyName",
			causale_trasporto.causale AS "CausalTransport", 
			IFNULL(CONCAT(b1.cap," - ",b1.nome,"(", b.provincia,")"), "") AS "Municipality",  
			IFNULL(ddt.fattura, "") AS "InvoiceId",
			IFNULL(impianto.descrizione, "") AS "SystemDescription", 
			CAST(IFNULL(SUM(prezzo*quantità-(prezzo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS TotalPrice, 
			CAST(IFNULL(SUM(costo*quantità-(costo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS TotalCost,
			"in_pre_invoice" AS "Status"
		FROM ddt
			LEFT JOIN causale_trasporto ON ddt.causale=id_causale
			INNER JOIN clienti ON clienti.id_cliente=ddt.id_cliente
			LEFT JOIN destinazione_cliente AS b ON b.id_cliente=ddt.id_cliente AND b.id_destinazione=ddt.id_destinazione
			LEFT JOIN comune AS b1 ON b1.id_comune=b.comune
			LEFT JOIN impianto ON id_impianto=impianto
			LEFT JOIN articoli_ddt ON articoli_ddt.id_ddt=ddt.id_ddt AND articoli_ddt.anno=ddt.anno
			INNER JOIN fattura ON fattura.Id_fattura = ddt.fattura AND fattura.anno = ddt.anno_fattura AND fattura.anno = 0
		WHERE ddt.anno = IF(ddtYear, ddtYear, ddt.anno) 
		GROUP BY ddt.Id_ddt, ddt.anno
	) AS a	
	ORDER BY YEAR(Date) DESC, DdtId;
	
	SELECT COUNT(ddt.id_ddt),
		CAST(IFNULL(SUM(prezzo*quantità-(prezzo*quantità/100*sconto)),2) AS DECIMAL(11,2)), 
		CAST(IFNULL(SUM(costo*quantità-(costo*quantità/100*sconto)),2) AS DECIMAL(11,2))
		INTO 
		ddtsNumbers,
		ddtsTotalPrice,
		ddtsTotalCost
	FROM ddt
		LEFT JOIN articoli_ddt ON articoli_ddt.id_ddt=ddt.id_ddt AND articoli_ddt.anno=ddt.anno
	WHERE (ddt.Stato = 1 OR (ddt.Stato=3 AND ddt.fattura IS NULL)) AND ddt.anno = IF(ddtYear, ddtYear, ddt.anno);
			

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ddtInsert
DELIMITER //
CREATE PROCEDURE `sp_ddtInsert`(
	ddtId INT, ddtYear INT, ddtDate DATE, aspect SMALLINT, personId INT, isCustomer BOOL, 
	destinationId INT, paymentCondition INT, deliveryCare INT, deliveryCompany INT, 
	deliveryMethod INT, timestampStart TIMESTAMP, timestampEnd TIMESTAMP, causalId VARCHAR(10),
	amount INT, note TEXT, description TEXT, mainId INT, systemId INT, 
	weight DECIMAL(11,2), printHours BIT(1), printTimestampEnd BIT(1),
	recipient_signature_filename VARCHAR(50),
	driver_signature_filename VARCHAR(50),	
	OUT ddtInsertResult INT)
BEGIN
	
	DECLARE ddtStatusResult INT DEFAULT 0;
	SET ddtInsertResult = -1;
	
	IF IFNULL(ddtId, 0) <= 0 THEN
		SELECT IFNULL(MAX(id_ddt), 0) + 1
		INTO ddtId
		FROM ddt
		WHERE ddt.anno = ddtYear;
	END IF;
	
	IF (SELECT COUNT(*) FROM ddt WHERE id_ddt = ddtId AND anno = ddtYear) <= 0 THEN
	
		SET ddtYear = IFNULL(ddtYear, YEAR(CURRENT_DATE));
		SET timestampStart = IFNULL(timestampStart, CURRENT_TIMESTAMP);
		SET ddtDate = IFNULL(ddtDate, CURRENT_DATE);
		SET amount = IFNULL(amount, 0);
		
		INSERT INTO ddt SET
			id_utente = @USER_ID,
			id_ddt = ddtId,
			anno = ddtYear,
			condizione_pagamento = paymentCondition,
			trasport_a_cura = deliveryCare,
			vettore = deliveryCompany,
			data_ora_ritiro = timestampEnd,
			data_ora_inizio = timestampStart,
			porto_resa = deliveryMethod,
			data_documento = ddtDate,
			causale = causalId,
			colli = amount,
			nota = note,
			descrizione = description,
			impianto = systemId,
			peso = weight,
			stampa_ora = printHours,
			stato = 1, -- set as open by default
			stampa_data_ora_ritiro = printTimestampEnd,
			filename_firma_conducente = driver_signature_filename,
			filename_firma_destinatario = recipient_signature_filename;
			
		IF isCustomer THEN
			UPDATE ddt SET 
				id_cliente = personId,
				id_destinazione = destinationId,
				id_principale = mainId
			WHERE id_ddt = ddtId
				AND anno = ddtYear;
		ELSE
			UPDATE ddt SET
				id_fornitore = personId,
				principale_forn = mainId , 
				destinazione_forn = destinationId
			WHERE id_ddt = ddtId
				AND anno = ddtYear;
		END IF;
		
		-- Inserimento aspetto merce 
		
		IF aspect & 1 THEN -- Alla Rinfusa [1]
			INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES(ddtId, ddtYear, "ar");
		END IF;
		IF aspect & 2 THEN -- A Vista [2]
			INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES(ddtId, ddtYear, "av");
		END IF;
		IF aspect & 4 THEN -- Matasse [4]
			INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES(ddtId, ddtYear, "ma");
		END IF;
		IF aspect & 8 THEN -- Scatole [8]
			INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES(ddtId, ddtYear, "sc");
		END IF;
		IF aspect & 16 THEN -- Sacco [16]
			INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES(ddtId, ddtYear, "sn");
		END IF;
		IF aspect & 32 THEN -- Busta [32]
			INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES(ddtId, ddtYear, "bu");
		END IF;
		
		-- Returning Result
		SET ddtInsertResult = ddtId;
	
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_ddtUpdate
DELIMITER //
CREATE PROCEDURE `sp_ddtUpdate`(
	newDdtId INT, newDdtYear INT, oldDdtId INT, oldDdtYear INT,ddtDate DATE, aspect SMALLINT, personId INT, isCustomer BOOL, 
	destinationId INT, paymentCondition INT, deliveryCare INT, deliveryCompany INT, 
	deliveryMethod INT, timestampStart TIMESTAMP, timestampEnd TIMESTAMP, causalId VARCHAR(10),
	amount INT, note TEXT, description TEXT, mainId INT, systemId INT, 
	weight DECIMAL(11,2), printHours BIT(1), IN printTimestampEnd BIT(1), OUT ddtUpdateResult INT)
BEGIN
	
	DECLARE ddtStatusResult INT DEFAULT 0;
	SET ddtUpdateResult = -1;
	
	SET newDdtYear = IFNULL(newDdtYear, YEAR(CURRENT_DATE));
	SET timestampStart = IFNULL(timestampStart, CURRENT_TIMESTAMP);
	SET ddtDate = IFNULL(ddtDate, CURRENT_DATE);
	SET amount = IFNULL(amount, 0);
	
	UPDATE ddt SET
		id_ddt = newDdtId,
		anno = newDdtYear,
		id_cliente = NULL,
		id_destinazione = NULL,
		id_principale = NULL,
		id_fornitore = NULL,
		principale_forn = NULL, 
		destinazione_forn = NULL, 
		condizione_pagamento = paymentCondition,
		trasport_a_cura = deliveryCare,
		vettore = deliveryCompany,
		data_ora_ritiro = timestampEnd,
		data_ora_inizio = timestampStart,
		porto_resa = deliveryMethod,
		data_documento = ddtDate,
		causale = causalId,
		colli = amount,
		nota = note,
		descrizione = description,
		impianto = systemId,
		peso = weight,
		stampa_ora = printHours,
		stampa_data_ora_ritiro = printTimestampEnd
	WHERE id_ddt = oldDdtId 
		AND anno = oldDdtYear;
		
	IF ROW_COUNT() > 0 THEN
		SET ddtUpdateResult = newDdtId;
	END IF;

	IF isCustomer THEN
		UPDATE ddt SET 
			id_cliente = personId,
			id_destinazione = destinationId,
			id_principale = mainId
		WHERE id_ddt = newDdtId
			AND anno = newDdtYear;
	ELSE
		UPDATE ddt SET
			id_fornitore = personId,
				principale_forn = mainId , 
				destinazione_forn = destinationId
		WHERE id_ddt = newDdtId
			AND anno = newDdtYear;
	END IF;
	
	-- Insert Product Aspect
	
	DELETE FROM ddt_aspetto 
	WHERE id_ddt = oldDdtId
		AND anno = oldDdtYear;
	
	IF aspect & 1 THEN -- Alla Rinfusa [1]
		INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES (newDdtId, newDdtYear, "ar");
	END IF;
	IF aspect & 2 THEN -- A Vista [2]
		INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES (newDdtId, newDdtYear, "av");
	END IF;
	IF aspect & 4 THEN -- Matasse [4]
		INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES (newDdtId, newDdtYear, "ma");
	END IF;
	IF aspect & 8 THEN -- Scatole [8]
		INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES (newDdtId, newDdtYear, "sc");
	END IF;
	IF aspect & 16 THEN -- Sacco [16]
		INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES (newDdtId, newDdtYear, "sn");
	END IF;
	IF aspect & 32 THEN -- Busta [32]
		INSERT INTO ddt_aspetto(id_ddt, anno, vista) VALUES(newDdtId, newDdtYear, "bu");
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_getDdtProductsRemaining
DELIMITER //
CREATE PROCEDURE `sp_getDdtProductsRemaining`(
	ddtId INT, ddtYear INT)
BEGIN

	
	DROP TEMPORARY TABLE IF EXISTS tmpTblDdtProductsRiceived;
	CREATE TEMPORARY TABLE tmpTblDdtProductsRiceived (
			product_id VARCHAR(11) NOT NULL PRIMARY KEY,
			quantity DECIMAL(11,2)
	) ENGINE = innoDB;

	INSERT INTO tmpTblDdtProductsRiceived 
	SELECT Id_articolo AS product_id, SUM(Quantita) AS quantity
	FROM (
			SELECT ff.id_materiale AS Id_articolo, ff.`quantità` AS Quantita
			FROM articoli_ddt de
				INNER JOIN fornfattura_articoli ff 
					ON de.id_ddt = ff.id_rif
					AND de.anno = ff.anno_rif
					AND de.Id_articolo = ff.id_materiale
					AND ff.tipo = '+'
			WHERE de.id_ddt = ddtId
			AND de.anno = ddtYear
			UNION ALL 
			SELECT dr.id_articolo, dr.`quantità`
			FROM articoli_ddt de
				INNER JOIN articoli_ddt_ricevuti dr 
					ON de.id_ddt = dr.id_rif
					AND de.anno = dr.anno_rif
					AND de.Id_articolo = dr.id_articolo
					AND dr.tipo = '+'
			WHERE de.id_ddt = ddtId
			AND de.anno = ddtYear
			) AS DdtProductsRiceived
	GROUP BY Id_articolo;

	SELECT id_articolo, desc_breve, codice_fornitore, serial_number, if(quantity IS NULL, quantità, quantità-quantity) as quantità ,unità_misura, prezzo, costo, id_Ddt, anno, idnota, 
	causale_scarico,sconto
	FROM articoli_ddt de
		LEFT JOIN tmpTblDdtProductsRiceived 
			ON de.Id_articolo = tmpTblDdtProductsRiceived.product_id
	WHERE de.id_ddt = ddtId
	AND de.anno = ddtYear
	AND (tmpTblDdtProductsRiceived.product_id IS NULL
	OR de.`quantità`>tmpTblDdtProductsRiceived.quantity)
	ORDER BY numero_tab;

		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_getInvoicePeriodicTotals
DELIMITER //
CREATE PROCEDURE `sp_getInvoicePeriodicTotals`(IN `AnnoFatture` INT, IN `MeseFatture` INT, OUT `FatturaPrezzoNetto` DECIMAL(11,2), OUT `FatturaPrezzoLordo` DECIMAL(11,2), OUT `FatturaPrezzoIva` DECIMAL(11,2), OUT `FatturaCosto` DECIMAL(11,2), OUT `PrefatturaPrezzoLordo` DECIMAL(11,2), OUT `PrefatturaCosto` DECIMAL(11,2), OUT `TotalePrezzoLordo` DECIMAL(11,2), OUT `TotaleCosto` DECIMAL(11,2)
)
BEGIN

	SELECT
		SUM(importo_imponibile), 
		SUM(costo_totale), 
		SUM(importo_iva), 
		SUM(importo_totale)
	INTO
		FatturaPrezzoNetto,
		FatturaCosto,
		FatturaPrezzoIva,
		FatturaPrezzoLordo
	FROM fattura f 
	WHERE f.anno = AnnoFatture
		AND IF(MeseFatture > 0, MONTH(f.data) = MeseFatture, TRUE);
		
	SELECT SUM(costo_totale), 
		SUM(importo_totale)
	INTO
		PrefatturaCosto,
		PrefatturaPrezzoLordo
	FROM fattura f
	WHERE f.anno = 0
		AND YEAR(f.data) = AnnoFatture
		AND IF(MeseFatture > 0, MONTH(f.data) = MeseFatture, TRUE);
		
		
	SET FatturaPrezzoNetto = IFNULL(FatturaPrezzoNetto, 0);
	SET FatturaPrezzoLordo = IFNULL(FatturaPrezzoLordo, 0);
	SET FatturaPrezzoIva = IFNULL(FatturaPrezzoIva, 0);
	SET FatturaCosto = IFNULL(FatturaCosto, 0);
	
	SET PrefatturaPrezzoLordo = IFNULL(PrefatturaPrezzoLordo, 0);
	SET PrefatturaCosto = IFNULL(PrefatturaCosto, 0);

	SET TotalePrezzoLordo = FatturaPrezzoLordo + PrefatturaPrezzoLordo;
	SET TotaleCosto = FatturaCosto + PrefatturaCosto;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_getJobTotals
DELIMITER //
CREATE PROCEDURE `sp_getJobTotals`(
	IN `id_job` INT,
	IN `year_job` INT,
	IN `sub_job_id` INT,
	IN `id_lot` INT,
	OUT `total_cost_quote` Decimal(11,2),
	OUT `total_price_quote` Decimal(11,2),
	OUT `total_cost` Decimal(11,2),
	OUT `total_hours_worked_economy` Decimal(11,2),
	OUT `total_hours_worked` Decimal(11,2),
	OUT `Total_hours_quote` Decimal(11,2),
	OUT `total_hours_travel` Decimal(11,2),
	OUT `Total_hours` Decimal(11,2),
	OUT `total_cost_quote_body_products` Decimal(11,2),
	OUT `total_price_quote_body_products` Decimal(11,2),
	OUT `total_cost_body_products_economy` Decimal(11,2),
	OUT `total_cost_worked_economy` Decimal(11,2),
	OUT `total_cost_body_products` Decimal(11,2),
	OUT `total_cost_worked` Decimal(11,2),
	OUT `total_km` Decimal(11,2),
	OUT `total_cost_hours_travel` Decimal(11,2),
	OUT `total_cost_km` Decimal(11,2),
	OUT `total_cost_transfert` Decimal(11,2),
	OUT `total_cost_extra` Decimal(11,2),
	OUT `total_cost_parking` Decimal(11.2),
	OUT `total_cost_speedway` Decimal(11,2),
	OUT `total_price_body_products` Decimal(11,2),
	OUT `total_price_worked` Decimal(11,2),
	OUT `total_price_hours_travel` Decimal(11,2),
	OUT `total_price_km` Decimal(11,2),
	OUT `total_price_transfert` Decimal(11,2),
	OUT `total_price_extra` Decimal(11,2),
	OUT `total_price_parking` Decimal(11.2),
	OUT `total_price_speedway` Decimal(11,2),
	OUT `total_price_body_products_economy` Decimal(11,2),
	OUT `total_price_worked_economy` Decimal(11,2),
	OUT `total_price` Decimal(11,2),
	OUT `total_cost_quote_worked` Decimal(11,2),
	OUT `total_price_quote_worked` Decimal(11,2)
)
BEGIN

	SELECT 
		SUM(CAST((jb.costo * jb.Qta_economia) AS DECIMAL(11,2))),
		SUM(CAST((jb.costo * jb.Qta_utilizzata) AS DECIMAL(11,2))),
		SUM(CAST((jb.prezzo * jb.Qta_economia)* (100 - jb.Sconto) / 100 AS DECIMAL(11,2))),
		SUM(CAST((jb.prezzo * jb.Qta_utilizzata)* (100 - jb.Sconto) / 100 AS DECIMAL(11,2)))
	INTO 
		total_cost_body_products_economy,
		total_cost_body_products,
		total_price_body_products_economy,
		total_price_body_products
		
	FROM vw_jobbody jb
	WHERE jb.id_commessa = id_job
		AND jb.anno = year_job
		AND IF(sub_job_id > 0, jb.id_sottocommessa = sub_job_id, TRUE)
		AND IF(id_lot > 0, jb.lotto = id_lot, TRUE);

	
	SELECT 
		SUM(preventivo_totale_ore),
		SUM(preventivo_costo_materiale) + SUM(preventivo_costo_lavoro),
		SUM(preventivo_costo_materiale),
		SUM(preventivo_costo_lavoro),
		SUM(preventivo_prezzo_materiale) + SUM(preventivo_prezzo_lavoro),
		SUM(preventivo_prezzo_materiale),
		SUM(preventivo_prezzo_lavoro)
	INTO 
		total_hours_quote,
		total_cost_quote,
		total_cost_quote_body_products,
		total_cost_quote_worked,
		total_price_quote,
		total_price_quote_body_products,
		total_price_quote_worked
	FROM commessa_preventivo cp
	WHERE cp.id_commessa = id_job
		AND cp.anno = year_job
		AND IF(sub_job_id > 0, cp.id_sottocommessa = sub_job_id, TRUE)
		AND IF(id_lot > 0, cp.lotto = id_lot, TRUE);

	SELECT 
		CAST(IF(SUM(twi.totale_ore_lavorate) IS NULL, 0 , SUM(twi.totale_ore_lavorate))AS DECIMAL(11,2)),
		CAST(IF(SUM(twi.totale_costo_lavoro) IS NULL, 0 , SUM(twi.totale_costo_lavoro))AS DECIMAL(11,2)),
	    CAST(IF(SUM(twi.totale_prezzo_lavoro) IS NULL, 0 , SUM(twi.totale_prezzo_lavoro))AS DECIMAL(11,2))
	INTO
		total_hours_worked,
		Total_cost_worked,
		Total_price_worked
	FROM vw_jobtotalworkinterventions twi 
	WHERE twi.Economia = 0 
		AND twi.id_commessa = id_job
		AND twi.anno_commessa = year_job
		AND IF(sub_job_id > 0, twi.id_sottocommessa = sub_job_id, TRUE)
		AND IF(id_lot > 0, twi.id_lotto = id_lot, TRUE);
		
	SELECT 
		CAST(if(SUM(twi.totale_ore_lavorate) IS NULL, 0,SUM(twi.totale_ore_lavorate))  AS DECIMAL(11,2)),
		CAST(if(SUM(twi.totale_costo_lavoro) IS NULL, 0,SUM(twi.totale_costo_lavoro)) AS DECIMAL(11,2)), 
		CAST(if(SUM(twi.totale_prezzo_lavoro) IS NULL,0, SUM(twi.totale_prezzo_lavoro)) AS DECIMAL(11,2)) 
	INTO 
		total_hours_worked_economy,
		total_cost_worked_economy,
		total_price_worked_economy
	FROM vw_jobtotalworkinterventions twi 
	WHERE twi.Economia = 1
		AND twi.id_commessa = id_job
		AND twi.anno_commessa = year_job
		AND IF(sub_job_id > 0, twi.id_sottocommessa = sub_job_id, TRUE)
		AND IF(id_lot > 0, twi.id_lotto = id_lot, TRUE);
	
	SELECT 
		CAST(IF(SUM(tti.Totale_tempo_viaggio) IS NULL, 0, SUM(tti.Totale_tempo_viaggio)) AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_KM) IS NULL, 0,SUM(tti.Totale_KM)) AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_costo_KM) IS NULL, 0,SUM(tti.Totale_costo_KM)) AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_costo_tempo_viaggio) IS NULL, 0, SUM(tti.Totale_costo_tempo_viaggio))AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_spese_trasferta) IS NULL, 0, SUM(tti.Totale_spese_trasferta)) AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_autostrada) IS NULL, 0,SUM(tti.Totale_autostrada)) AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_parcheggio) IS NULL, 0, SUM(tti.Totale_parcheggio)) AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_altro) IS NULL, 0,SUM(tti.Totale_altro)) AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_prezzo_tempo_viaggio) IS NULL, 0,SUM(tti.Totale_prezzo_tempo_viaggio)) AS DECIMAL(11,2)),
		CAST(IF(SUM(tti.Totale_prezzo_KM) IS NULL, 0, SUM(tti.Totale_prezzo_KM)) AS DECIMAL(11,2))
	INTO 
		total_hours_travel,
		total_km,
		total_cost_km,
		total_cost_hours_travel,
		total_cost_transfert,
		total_cost_speedway,
		total_cost_parking,
		total_cost_extra,
		total_price_km,
		total_price_hours_travel
	FROM vw_jobtotaltravelinterventions tti
	WHERE tti.id_commessa = id_job
		AND tti.anno_commessa = year_job
		AND IF(sub_job_id > 0, tti.id_sottocommessa = sub_job_id, TRUE)
		AND IF(id_lot > 0, tti.id_lotto = id_lot, TRUE);
		
	SET total_price_parking = total_cost_parking;
	SET total_price_extra = total_cost_extra;	
	SET total_price_speedway = total_cost_speedway;
	SET total_price_transfert = total_cost_transfert;
		
	SET total_price_quote = IFNULL(total_price_quote, 0); 
	SET total_cost_quote = IFNULL(total_cost_quote, 0); 
	SET total_cost = IFNULL(total_cost, 0); 
	SET total_hours_worked_economy = IFNULL(total_hours_worked_economy, 0); 
	SET total_hours_worked = IFNULL(total_hours_worked, 0); 
	SET Total_hours_quote = IFNULL(Total_hours_quote, 0); 
	SET total_hours_travel = IFNULL(total_hours_travel, 0); 
	SET total_price_quote_body_products = IFNULL(total_price_quote_body_products, 0); 
	SET total_cost_body_products_economy = IFNULL(total_cost_body_products_economy, 0); 
	SET total_cost_worked_economy = IFNULL(total_cost_worked_economy, 0); 
	SET total_cost_body_products = IFNULL(total_cost_body_products, 0); 
	SET total_cost_worked = IFNULL(total_cost_worked, 0); 
	SET total_km = IFNULL(total_km, 0); 
	SET total_cost_hours_travel = IFNULL(total_cost_hours_travel, 0); 
	SET total_cost_km = IFNULL(total_cost_km, 0); 
	SET total_cost_transfert = IFNULL(total_cost_transfert, 0); 
	SET total_cost_extra = IFNULL(total_cost_extra, 0); 
	SET total_cost_parking  = IFNULL(total_cost_parking , 0); 
	SET total_cost_speedway = IFNULL(total_cost_speedway, 0); 
	SET total_cost_quote_body_products = IFNULL(total_cost_quote_body_products, 0); 
	SET total_cost_quote_worked = IFNULL(total_cost_quote_worked, 0); 
	SET total_price_body_products = IFNULL(total_price_body_products, 0); 
	SET total_price_worked = IFNULL(total_price_worked, 0); 
	SET total_price_hours_travel = IFNULL(total_price_hours_travel, 0); 
	SET total_price_km = IFNULL(total_price_km, 0); 
	SET total_price_transfert = IFNULL(total_price_transfert, 0); 
	SET total_price_extra = IFNULL(total_price_extra, 0); 
	SET total_price_parking  = IFNULL(total_price_parking , 0); 
	SET total_price_speedway = IFNULL(total_price_speedway, 0); 
	SET total_price_body_products_economy = IFNULL(total_price_body_products_economy, 0); 
	SET total_price_worked_economy = IFNULL(total_price_worked_economy, 0); 
	SET total_price = IFNULL(total_price, 0);	
	SET total_price_quote_worked = IFNULL(total_price_quote_worked, 0);
		
		
	SET total_cost = total_cost_body_products_economy
				+ total_cost_worked_economy
				+ total_cost_body_products
				+ total_cost_worked
				+ total_cost_hours_travel
				+ total_cost_km
				+ total_cost_transfert
				+ total_cost_extra
				+ total_cost_parking
				+ total_cost_speedway ;
			
	SET total_price = total_price_body_products_economy
				+ total_price_worked_economy
				+ total_price_body_products
				+ total_price_worked
				+ total_price_hours_travel
				+ total_price_km
				+ total_cost_transfert
				+ total_cost_extra
				+ total_cost_parking
				+ total_cost_speedway ;
				
							
	SET total_hours = total_hours_travel
				+ total_hours_worked
				+ total_hours_worked_economy;
				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_getQuoteTotals
DELIMITER //
CREATE PROCEDURE `sp_getQuoteTotals`(IN `quote_id` INT, IN `quote_year` INT, IN `quote_revision_id` INT, IN `quote_lot_id` INT,  OUT `total_price_material` DECIMAL(11,2), OUT `total_cost_material` DECIMAL(11,2), OUT `total_profit_material` DECIMAL(11, 2), OUT `total_price_work` DECIMAL(11, 2), OUT `total_cost_work` DECIMAL(11, 2), OUT `total_profit_work` DECIMAL(11, 2), OUT `total_hours` DECIMAL(11, 2), OUT `total_price` DECIMAL(11, 2), OUT `total_cost` DECIMAL(11, 2), OUT `total_profit` DECIMAL(11, 2), OUT `total_sale` DECIMAL(11, 2)
)
BEGIN

	SELECT SUM(CAST(ROUND(prezzo * (100 - IF(preventivo_lotto.tipo_ricar = 1, 0, sconto)) / 100, 2) * (100 - IFNULL(NULLIF(scontoriga, ""), 0)) / 100 AS DECIMAL(11, 2)) * quantità)
		INTO total_price_material
	FROM articolo_preventivo 
		LEFT JOIN preventivo_lotto ON preventivo_lotto.id_preventivo = articolo_preventivo.id_preventivo 
			AND preventivo_lotto.anno = articolo_preventivo.anno 
			AND preventivo_lotto.id_revisione = articolo_preventivo.id_revisione 
			AND articolo_preventivo.lotto = preventivo_lotto.posizione 
	WHERE articolo_preventivo.id_preventivo = quote_id
		AND articolo_preventivo.anno = quote_year
		AND articolo_preventivo.id_revisione = quote_revision_id
		AND IF (quote_lot_id IS NOT NULL AND quote_lot_id >= 0, quote_lot_id, articolo_preventivo.lotto) = articolo_preventivo.lotto;

	SELECT SUM(costo * quantità)
		INTO total_cost_material
	FROM articolo_preventivo 
	WHERE id_preventivo = quote_id
		AND anno = quote_year
		AND id_revisione = quote_revision_id
		AND IF (quote_lot_id IS NOT NULL AND quote_lot_id >= 0, quote_lot_id, articolo_preventivo.lotto) = articolo_preventivo.lotto;

	SELECT SUM(CAST((IF(montato = "0", 0, ap.tempo_installazione / 60 * prezzo_h * (100 - scontolav) / 100) * ((100 - IFNULL(scontoriga, 0)) / 100)) AS DECIMAL(11, 2)) * quantità)
		INTO total_price_work
	FROM articolo_preventivo ap
		LEFT JOIN preventivo_lotto pl ON pl.id_preventivo = ap.id_preventivo
			AND pl.anno = ap.anno 
			AND pl.id_revisione = ap.id_revisione 
			AND ap.lotto = pl.posizione 
	WHERE ap.id_preventivo = quote_id
		AND ap.anno = quote_year
		AND ap.id_revisione = quote_revision_id
		AND IF (quote_lot_id IS NOT NULL AND quote_lot_id >= 0, quote_lot_id, ap.lotto) = ap.lotto;

	SELECT SUM(IF(montato = "0", 0, quantità * (tempo_installazione / 60 * costo_h)))
		INTO total_cost_work
	FROM articolo_preventivo 
	WHERE id_preventivo = quote_id
		AND anno = quote_year
		AND id_revisione = quote_revision_id
		AND IF (quote_lot_id IS NOT NULL AND quote_lot_id >= 0, quote_lot_id, articolo_preventivo.lotto) = articolo_preventivo.lotto;

	SELECT SUM(IF(montato = "0", 0, quantità) * tempo_installazione / 60)
		INTO total_hours
	FROM articolo_preventivo 
	WHERE id_preventivo = quote_id
		AND anno = quote_year
		AND id_revisione = quote_revision_id
		AND IF (quote_lot_id IS NOT NULL AND quote_lot_id >= 0, quote_lot_id, articolo_preventivo.lotto) = articolo_preventivo.lotto;

	SELECT SUM(((ROUND(ROUND((prezzo-(sconto/100*prezzo)),2)*scontoriga/100,2)*quantità)+((IF(montato="0",0,quantità*((tempo_installazione/60*prezzo_h) - ((tempo_installazione/60*prezzo_h)*scontolav/100)))))*scontoriga/100))
		INTO total_sale
	FROM articolo_preventivo 
	WHERE id_preventivo = quote_id
		AND anno = quote_year
		AND id_revisione = quote_revision_id
		AND IF (quote_lot_id IS NOT NULL AND quote_lot_id >= 0, quote_lot_id, articolo_preventivo.lotto) = articolo_preventivo.lotto;
	
	SET total_price_material = IFNULL(total_price_material, 0);
	SET total_cost_material = IFNULL(total_cost_material, 0);
	SET total_price_work = IFNULL(total_price_work, 0);
	SET total_cost_work = IFNULL(total_cost_work, 0);
	SET total_sale = IFNULL(total_sale, 0);
	SET total_hours = IFNULL(total_hours, 0);
	SET total_cost = IFNULL(total_cost_material, 0) + IFNULL(total_cost_work, 0);
	SET total_price = IFNULL(total_price_material, 0) + IFNULL(total_price_work, 0);
	SET total_profit_material = IFNULL(total_price_material, 0) - IFNULL(total_cost_material, 0);
	SET total_profit_work = IFNULL(total_price_work, 0) - IFNULL(total_cost_work, 0);
	SET total_profit = total_profit_material + total_profit_work;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_onDdtDeterminingStatus
DELIMITER //
CREATE PROCEDURE `sp_onDdtDeterminingStatus`(
	ddtId INT, ddtYear INT, source VARCHAR(20), OUT status INT)
BEGIN

	DECLARE DDT_STATUS_OPEN INT DEFAULT 1; 
	DECLARE DDT_STATUS_PARTIAL INT DEFAULT 2;
	DECLARE DDT_STATUS_CLOSED INT DEFAULT 3;
	DECLARE DDT_STATUS_IN_JOB INT DEFAULT 4; 
	DECLARE res INT;

	
	SET status = NULL;
	

	IF source = 'INSERT' THEN
		SET status = DDT_STATUS_OPEN;
	END IF;
	
	IF source = 'UPDATE' THEN 
	
		SELECT id_cliente IS NOT NULL 
		INTO res
		FROM ddt
		WHERE id_ddt = ddtId
			AND anno = ddtYear;
			
		if res THEN
		
			SELECT DDT_STATUS_CLOSED
			INTO status
			FROM DDT 
			WHERE id_ddt = ddtId
				AND anno = ddtYear 
				AND Fattura IS NOT NULL;
			
		END IF; 
		
	END IF; 
	

	
	-- When associating with an Invoice or a Supplier Invoice, CLOSE
	-- When dissociating from them, re-OPEN it
	IF source LIKE '%INVOICE' AND NOT source LIKE '%SUPPLIER%' THEN
		IF source LIKE 'ASSOC%' THEN
			SET status = DDT_STATUS_CLOSED;
		ELSEIF source LIKE 'DISSOC%' THEN
			SET status = DDT_STATUS_OPEN;
		END IF;
	END IF;
	
	
	IF source LIKE '%JOB' THEN
		IF source LIKE 'ASSOC%' THEN
			SET status = DDT_STATUS_IN_JOB;
		ELSEIF source LIKE 'DISSOC%' THEN
			SET status = DDT_STATUS_OPEN;
		END IF;
	END IF;

	
	-- If "Autoconvalidazione" is checked, automatically CLOSE
	SELECT (causale_trasporto.garanzia = 2)
	INTO res
	FROM ddt
		LEFT JOIN causale_trasporto ON causale_trasporto.Id_causale = ddt.Causale
	WHERE ddt.id_ddt = ddtId
		AND ddt.anno = ddtYear;
	
	IF res THEN
		SET status = DDT_STATUS_CLOSED;
	END IF;

	-- If the document is opened to a supplier
	-- If there is also a received document, and some products are given back
	-- set it as PARTIAL, if nothing has been given back, set it as OPEN, if everything has been given back set CLOSE
	
	SELECT id_fornitore IS NOT NULL 
	INTO res
	FROM ddt
	WHERE id_ddt = ddtId
		AND anno = ddtYear;
	
	IF res THEN -- The document refers a supplier

		DROP TABLE IF EXISTS tmp_ddt_det_status;
		CREATE TEMPORARY TABLE tmp_ddt_det_status
		(
			id_articolo VARCHAR(11) PRIMARY KEY, 
			ddt_quantity DECIMAL(11,2), 
			supplier_quantity DECIMAL(11,2)
		);  
				
		INSERT INTO tmp_ddt_det_status	
		SELECT  de.Id_articolo, 
		  de.quantità, 
		  SUM(IFNULL(dr.quantità, 0))
		-- INTO res
		FROM articoli_ddt de
			LEFT JOIN articoli_ddt_ricevuti dr 
				ON de.id_ddt = dr.id_rif
				AND de.anno = dr.anno_rif
				AND de.Id_articolo = dr.id_articolo
				AND dr.tipo = '+'
		WHERE de.id_articolo IS NOT NULL
			AND de.id_ddt = ddtId
			AND de.anno = ddtYear
		GROUP BY de.Id_articolo;
		
		
		INSERT INTO tmp_ddt_det_status
		SELECT de.Id_articolo, 
		  de.quantità, 
		  SUM(IFNULL(ff.quantità, 0)) as "ff_sum"
		FROM articoli_ddt de
			LEFT JOIN fornfattura_articoli ff 
				ON de.id_ddt = ff.id_rif
				AND de.anno = ff.anno_rif
				AND de.Id_articolo = ff.id_materiale
				AND ff.tipo = '+'
		WHERE de.id_articolo IS NOT NULL
			AND de.id_ddt = ddtId
			AND de.anno = ddtYear
		GROUP BY de.Id_articolo
		ON DUPLICATE KEY UPDATE 
			supplier_quantity=supplier_quantity + VALUES(supplier_quantity);
			
				
		SELECT COUNT(*) 
		INTO res
		FROM tmp_ddt_det_status
		WHERE supplier_quantity<ddt_quantity; 
		
		
		IF IFNULL(res , 0) = 0  THEN 
		
			SET status = DDT_STATUS_CLOSED; 
	
		ELSE 
			SELECT 
			IF(COUNT(*) = 0, 
				DDT_STATUS_OPEN,  -- I have received all the products, CLOSE document
				DDT_STATUS_PARTIAL  -- I haven't received all the products, set it PARTIAL
			) 
			INTO status 
			FROM tmp_ddt_det_status
			WHERE supplier_quantity != 0; 
		END IF;
	END IF;
	
	IF status IS NOT NULL THEN
		UPDATE ddt	
			SET stato = status
		WHERE id_ddt = ddtId
			AND anno = ddtYear;
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printChecklistGetById
DELIMITER //
CREATE PROCEDURE `sp_printChecklistGetById`(IN checklist_id INT(11))
BEGIN
	SELECT 	
		`id`,
		`id_mobile`,
		`data_esecuzione`,
		`id_checklist_model`
		`id_operaio`,
		`id_cliente`,
		`id_responsabile`,
		`id_impianto`,
		`ragione_sociale`,
		`indirizzo`,
		`citta`,
		`responsabile`,
		`impianto_luogo_installazione`,
		`impianto_centrale`,
		`impianto_data_installazione`,
		`impianto_dipartimento`,
		`timestamp_creazione`,
		`utente_ins`,
		`utente_mod`,
		`data_ins`,
		`data_mod` 
	FROM CHECKlist
	WHERE Id = checklist_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printChecklistParagraphGetByChecklist
DELIMITER //
CREATE PROCEDURE `sp_printChecklistParagraphGetByChecklist`(
	IN checklist_id INT(11) 
)
BEGIN
	SELECT 	
		`id`,
		`id_checklist`,
		`id_checklist_model_paragrafo`,
		`nome`,
		`descrizione`,
		`ordine`,
		`utente_mod`,
		`data_mod`
	FROM checklist_paragrafo
	WHERE id_Checklist = checklist_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printChecklistRowGetByChecklist
DELIMITER //
CREATE PROCEDURE `sp_printChecklistRowGetByChecklist`(
	IN checklist_id INT(11) 
)
BEGIN
	SELECT 	
		`id`,
		`id_checklist`,
		`id_paragrafo`,
		`json_data`,
		`tipo_riga`,
		`id_checklist_model_elemento`,
		`id_checklist_model_paragrafo`,
		`id_checklist_model`,
		`ordine`,
		`nome`,
		`descrizione`,
		`indicazioni_tecnico`
	FROM checklist_paragrafo_riga
	WHERE id_Checklist = checklist_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardCounters
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardCounters`(
	customer_id INT, 
	system_id INT,
	OUT quotes_counter INTEGER,
	OUT reports_groups_counter INTEGER,
	OUT reports_counter INTEGER,
	OUT jobs_counter INTEGER,
	OUT ddts_counter INTEGER,
	OUT systems_counter INTEGER,
	OUT invoices_counter INTEGER,
	OUT system_sims_counter INTEGER,
	OUT system_components_counter INTEGER,
	OUT tickets_counter INTEGER
)
BEGIN
	SELECT COUNT(*) INTO quotes_counter
	FROM (
		SELECT preventivo.id_preventivo
		FROM preventivo 
			INNER JOIN revisione_preventivo ON revisione_preventivo.Id_revisione = preventivo.revisione
				AND preventivo.id_preventivo = revisione_Preventivo.id_preventivo
				AND preventivo.anno = revisione_preventivo.Anno
		WHERE revisione_preventivo.id_cliente = customer_id
		GROUP BY preventivo.id_preventivo, preventivo.anno
	) as quotes;

	SELECT COUNT(Id_resoconto) INTO reports_groups_counter
	FROM resoconto
	WHERE resoconto.id_cliente = customer_id;

	SELECT COUNT(Id_rapporto) INTO reports_counter
	FROM rapporto
	WHERE rapporto.id_cliente = customer_id AND IF(system_id > 0, rapporto.Id_Impianto, system_id) = system_id;

	SELECT COUNT(*) INTO jobs_counter 
	FROM (
		SELECT commessa.Id_commessa
		FROM commessa
			INNER JOIN commessa_sotto ON commessa_sotto.id_commessa = commessa.id_commessa
				AND commessa_sotto.anno = commessa.anno
			INNER JOIN commessa_lotto ON commessa_lotto.id_commessa = commessa.id_commessa
				AND commessa_lotto.anno = commessa.anno
				AND commessa_lotto.id_sottocommessa = commessa_sotto.id_sotto
		WHERE IF(system_id > 0, commessa_lotto.impianto, system_id) = system_id AND commessa.id_cliente = customer_id
		GROUP BY commessa.id_commessa, commessa.anno, commessa_sotto.id_sotto
	) as jobs;

	SELECT COUNT(Id_ddt) INTO ddts_counter
	FROM Ddt
	WHERE ddt.id_cliente = customer_id AND IF(system_id > 0, ddt.impianto, system_id) = system_id;

	SELECT COUNT(Id_impianto) INTO systems_counter
	FROM impianto
	WHERE IF(system_id > 0, impianto.Id_Impianto, system_id) = system_id AND impianto.id_cliente = customer_id;

	SELECT COUNT(Id_fattura) INTO invoices_counter
	FROM fattura
	WHERE fattura.id_cliente = customer_id;
	
	SELECT COUNT(*) INTO system_components_counter
	FROM impianto_componenti
		INNER JOIN impianto ON impianto_componenti.Id_impianto = impianto.Id_impianto
	WHERE (impianto_componenti.data_dismesso IS NULL OR impianto_componenti.data_dismesso > NOW())
		AND (impianto_componenti.data_fine IS NULL OR impianto_componenti.data_fine > NOW())
		AND impianto.id_cliente = customer_id
		AND IF(system_id > 0, impianto.Id_Impianto, system_id) = system_id;

	SELECT COUNT(*) INTO system_sims_counter
	FROM impianto_ricarica_tipo
		INNER JOIN impianto ON impianto.Id_impianto = impianto_ricarica_tipo.id_impianto
	WHERE IF(system_id > 0, impianto.Id_Impianto, system_id) = system_id AND impianto.id_cliente = customer_id;


	SELECT COUNT(id_ticket) INTO tickets_counter
	FROM ticket
	WHERE ticket.id_cliente = customer_id AND IF(system_id > 0, ticket.Id_Impianto, system_id) = system_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardDdts
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardDdts`(
	IN customer_id INT(11),
	IN system_id INT(11)
)
BEGIN
	SELECT ddt.Id_ddt,
		ddt.anno,
		ddt.data_documento AS 'data',
		stato_ddt.Nome AS 'stato',
		stato_ddt.Colore AS 'stato_colore',
		causale_trasporto.causale as 'causale',
		IFNULL(impianto.Descrizione, '') as 'impianto',
		CAST(SUM(CAST(ROUND(prezzo * (100 - sconto) / 100, 2) AS DECIMAL(11, 2)) * quantità) AS DECIMAL(11, 2)) as 'prezzo_totale',
		CAST(SUM(CAST(ROUND(costo * (100 - sconto) / 100, 2) AS DECIMAL(11, 2)) * quantità) AS DECIMAL(11, 2)) as 'costo_totale'
	FROM ddt
		INNER JOIN stato_ddt ON stato_ddt.Id_stato = ddt.stato
		INNER JOIN causale_trasporto ON ddt.Causale = causale_trasporto.Id_causale
		LEFT JOIN impianto ON impianto.Id_impianto = ddt.impianto
		INNER JOIN articoli_ddt ON articoli_ddt.anno = ddt.anno AND articoli_ddt.id_ddt = ddt.Id_ddt
	WHERE ddt.id_cliente = customer_id AND IF(system_id > 0, ddt.impianto, system_id) = system_id
	GROUP BY ddt.anno, ddt.Id_ddt
	ORDER BY FIELD(stato_ddt.id_stato, 2, 4, 1) DESC, anno DESC, id_ddt DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardInvoices
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardInvoices`(
	IN customer_id INT(11)
)
BEGIN
	SELECT fattura.id_fattura,
		fattura.anno,
		fattura.`data` AS 'data_fattura',
		stato_fattura.Nome AS 'stato',
		stato_fattura.Colore AS 'stato_colore',
		tipo_fattura.nome AS 'tipo',
		condizione_pagamento.nome as 'condizione_pagamento',
		SUBSTRING(fattura.nota_interna, 1, 40) AS nota_interna,
		causale_fattura.Nome as 'causale_fattura',
		fattura.importo_totale as prezzo_totale,
		IFNULL(fattura.inviato, 0) > 0 as inviato
	FROM fattura
		INNER JOIN stato_fattura ON stato_fattura.Id_stato = fattura.stato
		INNER JOIN tipo_fattura ON tipo_fattura.id_tipo = fattura.tipo_fattura
		INNER JOIN causale_fattura ON fattura.causale_fattura = causale_fattura.id_causale
		INNER JOIN condizione_pagamento ON condizione_pagamento.Id_condizione = fattura.cond_pagamento
	WHERE fattura.id_cliente = customer_id
	ORDER BY FIELD(stato_fattura.id_stato, 5, 1, 4) DESC, anno DESC, id_fattura DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardJobs
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardJobs`(
	IN customer_id INT(11),
	IN system_id INT(11)
)
BEGIN
	SELECT commessa.id_commessa,
		commessa.anno,
		commessa_sotto.id_sotto AS 'id_sottocommessa',
		IFNULL(commessa.data_inizio, inizio) AS 'data_inizio',
		stato_commessa.colore AS 'Stato_colore',
		commessa.descrizione AS 'descrizione',
		commessa_sotto.nome AS 'sottocommessa',
		IFNULL(commessa.inv_com, 0) > 0 as inviato
	FROM commessa
		INNER JOIN stato_commessa ON stato_commessa.Id_stato = commessa.stato_commessa
		INNER JOIN commessa_sotto ON commessa_sotto.id_commessa = commessa.id_commessa
			AND commessa_sotto.anno = commessa.anno
		INNER JOIN commessa_lotto ON commessa_lotto.id_commessa = commessa.id_commessa
			AND commessa_lotto.anno = commessa.anno
			AND commessa_lotto.id_sottocommessa = commessa_sotto.id_sotto
	WHERE IF(system_id > 0, commessa_lotto.impianto, system_id) = system_id AND commessa.id_cliente = customer_id
	GROUP BY commessa.id_commessa, commessa.anno, commessa_sotto.id_sotto
	ORDER BY FIELD(stato_commessa.id_stato, 1, 3, 4) DESC, id_stato DESC, data_inizio ASC;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardQuotes
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardQuotes`(
	IN customer_id INT(11)
)
BEGIN
	SELECT 
		preventivo.Id_preventivo,
		preventivo.anno,
		preventivo.revisione,
		preventivo.Note as Descrizione,
		revisione_preventivo.data as data,
		tipo_preventivo.nome as Tipo,
		stato_preventivo.Nome as Stato,
		stato_preventivo.Colore as Stato_colore,
		SUM(CAST(ROUND(prezzo * (100 - IF(preventivo_lotto.tipo_ricar = 1, 0, sconto)) / 100, 2) * (100 - IFNULL(NULLIF(scontoriga, ""), 0)) / 100 AS DECIMAL(11, 2)) * quantità) 
		+ SUM(CAST((IF(montato = "0", 0, articolo_preventivo.tempo_installazione / 60 * prezzo_h * (100 - scontolav) / 100) * ((100 - IFNULL(scontoriga, 0)) / 100)) AS DECIMAL(11, 2)) * quantità) as prezzo,
		IFNULL(revisione_preventivo.inviato, 0) > 0 as inviato
	FROM preventivo
		INNER JOIN revisione_preventivo ON revisione_preventivo.Id_revisione = preventivo.revisione
			AND preventivo.id_preventivo = revisione_Preventivo.id_preventivo
			AND preventivo.anno = revisione_preventivo.Anno
		INNER JOIN articolo_preventivo ON revisione_preventivo.Id_revisione = articolo_preventivo.Id_revisione
			AND articolo_preventivo.id_preventivo = revisione_Preventivo.id_preventivo
			AND articolo_preventivo.anno = revisione_preventivo.Anno
		INNER JOIN preventivo_lotto ON preventivo_lotto.id_preventivo = articolo_preventivo.id_preventivo 
			AND preventivo_lotto.anno = articolo_preventivo.anno 
			AND preventivo_lotto.id_revisione = articolo_preventivo.id_revisione 
			AND articolo_preventivo.lotto = preventivo_lotto.posizione 
		INNER JOIN tipo_preventivo ON preventivo.tipo_preventivo = tipo_preventivo.id_tipo
		INNER JOIN stato_preventivo ON preventivo.Stato = stato_preventivo.Id_stato
	WHERE revisione_preventivo.id_cliente = customer_id
	GROUP BY id_preventivo, anno
	ORDER BY FIELD(stato_preventivo.id_stato, 3, 5) DESC, anno DESC, id_preventivo DESC;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardReportGroups
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardReportGroups`(
	IN customer_id INT(11)
)
BEGIN
	SELECT resoconto.id_resoconto,
		resoconto.anno,
		resoconto.data AS 'data_resoconto',
		stato_resoconto.Nome AS 'stato',
		stato_resoconto.colore AS 'stato_colore',
		tipo_resoconto.nome AS 'tipo',
		resoconto.descrizione,
		resoconto_totali.prezzo_totale,
		IFNULL(resoconto.inviato, 0) > 0 as inviato
	FROM resoconto
		INNER JOIN stato_resoconto ON stato_resoconto.Id_stato = resoconto.stato
		INNER JOIN tipo_resoconto ON tipo_resoconto.id_tipo = resoconto.tipo_resoconto
		INNER JOIN resoconto_totali ON resoconto.id_resoconto = resoconto_totali.id_resoconto AND resoconto.anno = resoconto_totali.anno
	WHERE resoconto.id_cliente = customer_id
	ORDER BY FIELD(stato_resoconto.id_stato, 7, 4, 1) DESC, anno DESC, id_resoconto DESC;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardReports
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardReports`(
	IN customer_id INT(11),
	IN system_id INT(11)
)
BEGIN

	SELECT rapporto.Id_rapporto,
		rapporto.anno,
		rapporto.Data_esecuzione AS 'data',
		stato_rapporto.Nome AS 'stato',
		stato_rapporto.Colore AS 'stato_colore',
		tipo_intervento.Nome AS 'tipo_intervento',
		SUBSTRING(rapporto.relazione, 1, 85) as 'relazione',
		IFNULL(impianto.Descrizione, '') as 'impianto',
		rapporto_totali.costo_totale,
		rapporto_totali.prezzo_totale,
		tr.nome as 'tipo_rapporto'
	FROM rapporto
		INNER JOIN stato_rapporto ON stato_rapporto.Id_stato = rapporto.stato
		INNER JOIN tipo_intervento ON tipo_intervento.Id_tipo = rapporto.Tipo_intervento
		INNER JOIN impianto ON impianto.Id_impianto = rapporto.Id_Impianto
		LEFT JOIN tipo_rapporto tr ON rapporto.id_tipo_rapporto = tr.id
		INNER JOIN rapporto_totali ON rapporto_totali.id_rapporto = rapporto.Id_rapporto and rapporto_totali.anno = rapporto.Anno
	WHERE rapporto.id_cliente = customer_id AND IF(system_id > 0, rapporto.Id_Impianto, system_id) = system_id
	GROUP BY rapporto.anno, rapporto.Id_rapporto
	ORDER BY FIELD(stato_rapporto.id_stato, 7, 4, 1, 10) DESC, anno DESC, id_rapporto DESC;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardSystemComponents
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardSystemComponents`(
	IN customer_id INT(11),
	IN system_id INT(11)
)
BEGIN
	SELECT
		impianto_componenti.Id_articolo,
		articolo.Desc_brev AS descrizione,
		impianto.Descrizione AS impianto,
		impianto_componenti.Data_scadenza,
		IF(impianto_componenti.data_scadenza IS NOT NULL AND impianto_componenti.data_scadenza < NOW(), 1, 0) AS scaduti,
		COUNT(impianto_componenti.Id_articolo) as quantita 
	FROM impianto_componenti
		INNER JOIN impianto ON impianto_componenti.Id_impianto = impianto.Id_impianto
		INNER JOIN articolo ON articolo.Codice_articolo = impianto_componenti.Id_articolo
	WHERE (impianto_componenti.data_dismesso IS NULL OR impianto_componenti.data_dismesso > NOW())
		AND (impianto_componenti.data_fine IS NULL OR impianto_componenti.data_fine > NOW())
		AND impianto.id_cliente = customer_id
		AND IF(system_id > 0, impianto.Id_Impianto, system_id) = system_id
	GROUP BY impianto_componenti.id_impianto, id_articolo, data_scadenza
	ORDER BY Data_scadenza IS NULL ASC, Data_scadenza ASC;	

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardSystems
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardSystems`(
	IN `customer_id` INT(11)
)
BEGIN
	SET customer_id = IFNULL(customer_id, -1);
	
	SELECT Id_impianto,
		impianto.Id_cliente,
		tipo_impianto.nome as Tipo_impianto,
		stato_impianto.nome as Stato_impianto,
		stato_impianto.colore as Stato_impianto_colore,
		impianto.Descrizione,
		CONCAT(dc.indirizzo,' n.',dc.numero_civico, dc.altro,' - ', com.nome,' (',com.provincia,')') AS 'Indirizzo'
	FROM impianto
		INNER JOIN tipo_impianto ON tipo_impianto = id_tipo
		INNER JOIN stato_impianto ON Stato = id_stato
		LEFT JOIN destinazione_cliente AS dc ON a.id_cliente=impianto.id_cliente	AND a.id_destinazione = impianto.destinazione
		LEFT JOIN comune AS Com ON comune.id_comune=comune
	WHERE customer_id = IF(customer_id = -1, -1, impianto.id_cliente) 
	GROUP BY impianto.id_impianto  
	ORDER BY impianto.descrizione;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardSystemSims
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardSystemSims`(
	IN customer_id INT(11),
	IN system_id INT(11)
)
BEGIN
	SELECT
		IF(data_scadenza IS NOT NULL AND data_scadenza < NOW(), 2, 1) AS stato,
		tipo_ricarica.nome AS tipo_ricarica,
		impianto_ricarica_tipo.intestatario,
		impianto_ricarica_tipo.numero,
		impianto_ricarica_tipo.importo,
		impianto_ricarica_tipo.data_attivazione,
		impianto_ricarica_tipo.data_rinnovo,
		impianto_ricarica_tipo.data_scadenza
	FROM impianto_ricarica_tipo
		INNER JOIN tipo_ricarica ON tipo_ricarica.id_tipo = impianto_ricarica_tipo.tipo_ricarica
		INNER JOIN impianto ON impianto.Id_impianto = impianto_ricarica_tipo.id_impianto
	WHERE IF(system_id > 0, impianto.Id_Impianto, system_id) = system_id AND impianto.id_cliente = customer_id
	ORDER BY data_scadenza IS NULL ASC, data_scadenza ASC;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardTickets
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardTickets`(
	IN customer_id INT(11),
	IN system_id INT(11)
)
BEGIN
	SELECT ticket.Id_ticket,
		ticket.anno,
		ticket.Data_ticket AS 'data',
		stato_ticket.Nome AS 'stato',
		stato_ticket.Colore AS 'stato_colore',
		ticket.scadenza AS 'data_scadenza',
		SUBSTRING(ticket.Descrizione, 1, 50) as 'descrizione',
		IFNULL(impianto.Descrizione, '') as 'impianto'
	FROM ticket
		INNER JOIN stato_ticket ON stato_ticket.Id_stato = ticket.Stato_ticket
		INNER JOIN causale_ticket ON causale_ticket.Id_causale = ticket.Causale
		INNER JOIN impianto ON impianto.Id_impianto = ticket.Id_Impianto
	WHERE ticket.id_cliente = customer_id AND IF(system_id > 0, ticket.Id_Impianto, system_id) = system_id
	GROUP BY ticket.anno, ticket.Id_ticket
	ORDER BY FIELD(stato_ticket.id_stato, 1, 2) DESC, anno DESC, id_ticket DESC;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerDashboardTotals
DELIMITER //
CREATE PROCEDURE `sp_printCustomerDashboardTotals`(
	customer_id INT, 
	system_id INT,
	OUT total_reports_price DECIMAL(11,2),
	OUT total_reports_cost DECIMAL(11,2),
	OUT total_report_groups_price DECIMAL(11,2),
	OUT total_report_groups_cost DECIMAL(11,2),
	OUT total_ddts_price DECIMAL(11,2),
	OUT total_ddts_cost DECIMAL(11,2),
	OUT total_invoices_price DECIMAL(11,2),
	OUT total_invoices_cost DECIMAL(11,2)
)
BEGIN

	SELECT 
		SUM(resoconto_totali.prezzo_totale),
		SUM(resoconto_totali.costo_totale)
	INTO
		total_report_groups_price,
		total_report_groups_cost
	FROM resoconto
		INNER JOIN resoconto_totali ON resoconto.id_resoconto = resoconto_totali.id_resoconto AND resoconto.anno = resoconto_totali.anno
	WHERE resoconto.id_cliente = customer_id AND stato in (1, 4, 7);
	
	
	SELECT 
		SUM(rapporto_totali.prezzo_totale),
		SUM(rapporto_totali.costo_totale)
	INTO
		total_reports_price,
		total_reports_cost
	FROM rapporto
		INNER JOIN rapporto_totali ON rapporto_totali.id_rapporto = rapporto.Id_rapporto and rapporto_totali.anno = rapporto.Anno
	WHERE rapporto.id_cliente = customer_id
		AND IF(system_id > 0, rapporto.Id_Impianto, system_id) = system_id
		AND rapporto.Stato IN (7, 4, 1, 10);
	
	SELECT
		CAST(SUM(CAST(ROUND(prezzo * (100 - sconto) / 100, 2) AS DECIMAL(11, 2)) * quantità) AS DECIMAL(11, 2)) as 'prezzo_totale',
		CAST(SUM(CAST(ROUND(costo * (100 - sconto) / 100, 2) AS DECIMAL(11, 2)) * quantità) AS DECIMAL(11, 2)) as 'costo_totale'
	INTO
		total_ddts_price,
		total_ddts_cost
	FROM ddt
		INNER JOIN articoli_ddt ON articoli_ddt.anno = ddt.anno AND articoli_ddt.id_ddt = ddt.Id_ddt
	WHERE ddt.id_cliente = customer_id
		AND IF(system_id > 0, ddt.impianto, system_id) = system_id
		AND ddt.stato IN (2, 4, 1);


	SELECT 
		SUM(CAST(ROUND(fattura.importo_totale, 2) AS DECIMAL(11, 2))),
		SUM(CAST(ROUND(fattura.costo_totale, 2) AS DECIMAL(11, 2)))
	INTO
		total_invoices_price,
		total_invoices_cost
	FROM fattura
	WHERE fattura.id_cliente = customer_id
		AND fattura.stato IN (5, 1, 4);

	SET total_reports_price = IFNULL(total_reports_price, 0);
	SET total_reports_cost = IFNULL(total_reports_cost, 0);
	SET total_report_groups_price = IFNULL(total_report_groups_price, 0);
	SET total_report_groups_cost = IFNULL(total_report_groups_cost, 0);
	SET total_ddts_price = IFNULL(total_ddts_price, 0);
	SET total_ddts_cost = IFNULL(total_ddts_cost, 0);
	SET total_invoices_price = IFNULL(total_invoices_price, 0);
	SET total_invoices_cost = IFNULL(total_invoices_cost, 0);
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printCustomerListExport
DELIMITER //
CREATE PROCEDURE `sp_printCustomerListExport`(
	IN order_by VARCHAR(100)
)
BEGIN
	SELECT clienti.id_cliente AS "ID Cliente", 
      clienti.ragione_sociale as "Ragione sociale", 
      IFNULL(clienti.partita_iva, "") as "Partita IVA", 
      IFNULL(clienti.codice_fiscale, "") as "Codice Fiscale", 
      Stato_clienti.Nome as "Stato cliente", 
      Tipo_cliente.Nome as "Tipo cliente", 
      Tipo_rapclie.Nome as "Tipo rapporto", 
      Tipo_attivita.Nome as "Tipo Attività", 
      IF(id_riferimento = 1, "Principale", "Secondario") AS "Tipo contatto", 
      riferimento_clienti.telefono as "Telefono", 
      riferimento_clienti.altro_telefono as "Cellulare", 
      riferimento_clienti.mail as "Email", 
      riferimento_clienti.titolo as "Titolo", 
      CONCAT(IF(indirizzo IS NOT NULL, indirizzo,""),
         IF((numero_civico IS NOT NULL), CONCAT(", ", numero_civico),""), 
         IF((destinazione_cliente.altro IS NOT NULL AND destinazione_cliente.altro<>""), CONCAT("/", destinazione_cliente.altro),""), 
         IF((piano IS NOT NULL), CONCAT(" piano ",piano," "),""), 
         IF((scala IS NOT NULL AND scala<>"0"), CONCAT(" scala ", scala),""), 
         IF((interno IS NOT NULL), CONCAT(" interno ",interno),"")) AS "Indirizzo", 
      IFNULL(comune.cap, "") AS "CAP", 
      IFNULL(comune.nome, "") AS "Comune", 
      IFNULL(frazione.nome, "") AS "Frazione", 
      IFNULL(destinazione_cliente.Provincia, "") AS "Provincia" 
    FROM clienti 
    	INNER JOIN Tipo_cliente ON clienti.tipo_cliente = Tipo_cliente.id_tipo 
    	LEFT JOIN Tipo_attivita ON clienti.id_attività = Tipo_attivita.id_tipo 
    	INNER JOIN Stato_clienti ON clienti.stato_cliente = Stato_clienti.id_stato 
    	INNER JOIN Tipo_rapclie ON clienti.tipo_rapporto = Tipo_rapclie.id_tipo 
    	LEFT JOIN riferimento_clienti ON riferimento_clienti.id_cliente = clienti.id_cliente 
    	LEFT JOIN destinazione_cliente ON destinazione_cliente.id_cliente = clienti.id_cliente
    	  AND destinazione_cliente.id_destinazione = "1" 
    	LEFT JOIN comune ON comune.id_comune = destinazione_cliente.comune 
    	LEFT JOIN province ON province.id_provincia = comune.id_provincia 
    	  AND province.sigla = comune.provincia 
    	LEFT JOIN frazione ON frazione.id_frazione = destinazione_cliente.frazione
	ORDER BY CASE
			WHEN order_by = 'company_name' THEN clienti.ragione_sociale
			WHEN order_by = 'city' THEN comune.nome
			ELSE clienti.Id_cliente
		end;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printDdtNotInvoiced
DELIMITER //
CREATE PROCEDURE `sp_printDdtNotInvoiced`(
	ddtYear SMALLINT, OUT ddtsNumbers MEDIUMINT, OUT ddtsTotalPrice DECIMAL(11,2), OUT ddtsTotalCost DECIMAL(11,2))
BEGIN

	SELECT * 
	FROM
	(
		-- ddt not closed
		SELECT 
			ddt.id_ddt AS "DdtId", 
			data_documento AS "Date", 
			clienti.ragione_sociale AS "CompanyName",
			causale_trasporto.causale AS "CausalTransport", 
			IFNULL(CONCAT(b1.cap," - ",b1.nome,"(", b.provincia,")"), "") AS "Municipality",  
			IFNULL(ddt.fattura, "") AS "InvoiceId",
			IFNULL(impianto.descrizione, "") AS "SystemDescription", 
			CAST(IFNULL(SUM(prezzo*quantità-(prezzo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS TotalPrice, 
			CAST(IFNULL(SUM(costo*quantità-(costo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS TotalCost,
			IF(commessa_ddt.Id_commessa IS NOT NULL, "in_job", "open") AS "Status"
		FROM ddt
			LEFT JOIN causale_trasporto ON ddt.causale=id_causale
			INNER JOIN clienti ON clienti.id_cliente=ddt.id_cliente
			LEFT JOIN destinazione_cliente AS b ON b.id_cliente=ddt.id_cliente AND b.id_destinazione=ddt.id_destinazione
			LEFT JOIN comune AS b1 ON b1.id_comune=b.comune
			LEFT JOIN impianto ON id_impianto=impianto
			LEFT JOIN articoli_ddt ON articoli_ddt.id_ddt=ddt.id_ddt AND articoli_ddt.anno=ddt.anno
			LEFT JOIN commessa_ddt ON commessa_ddt.Id_ddt=ddt.id_ddt AND commessa_ddt.Anno_ddt=ddt.anno 
		WHERE ddt.Stato IN (1,2,4)  AND ddt.anno = IF(ddtYear, ddtYear, ddt.anno)
		GROUP BY ddt.Id_ddt, ddt.anno
		
		UNION 
		
		-- ddt in pre-invoiced
		SELECT
			ddt.id_ddt AS "DdtId", 
			data_documento AS "Date", 
			clienti.ragione_sociale AS "CompanyName",
			causale_trasporto.causale AS "CausalTransport", 
			IFNULL(CONCAT(b1.cap," - ",b1.nome,"(", b.provincia,")"), "") AS "Municipality",  
			IFNULL(ddt.fattura, "") AS "InvoiceId",
			IFNULL(impianto.descrizione, "") AS "SystemDescription", 
			CAST(IFNULL(SUM(prezzo*quantità-(prezzo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS TotalPrice, 
			CAST(IFNULL(SUM(costo*quantità-(costo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS TotalCost,
			"in_pre_invoice" AS "Status"
		FROM ddt
			LEFT JOIN causale_trasporto ON ddt.causale=id_causale
			INNER JOIN clienti ON clienti.id_cliente=ddt.id_cliente
			LEFT JOIN destinazione_cliente AS b ON b.id_cliente=ddt.id_cliente AND b.id_destinazione=ddt.id_destinazione
			LEFT JOIN comune AS b1 ON b1.id_comune=b.comune
			LEFT JOIN impianto ON id_impianto=impianto
			LEFT JOIN articoli_ddt ON articoli_ddt.id_ddt=ddt.id_ddt AND articoli_ddt.anno=ddt.anno
			INNER JOIN fattura ON fattura.Id_fattura = ddt.fattura AND fattura.anno = ddt.anno_fattura AND fattura.anno = 0
		WHERE ddt.anno = IF(ddtYear, ddtYear, ddt.anno) 
		GROUP BY ddt.Id_ddt, ddt.anno
	) AS a	
	ORDER BY YEAR(Date) DESC, DdtId;
	
	SELECT COUNT(ddt.id_ddt),
		CAST(IFNULL(SUM(prezzo*quantità-(prezzo*quantità/100*sconto)),2) AS DECIMAL(11,2)), 
		CAST(IFNULL(SUM(costo*quantità-(costo*quantità/100*sconto)),2) AS DECIMAL(11,2))
		INTO 
		ddtsNumbers,
		ddtsTotalPrice,
		ddtsTotalCost
	FROM ddt
		LEFT JOIN articoli_ddt ON articoli_ddt.id_ddt=ddt.id_ddt AND articoli_ddt.anno=ddt.anno
	WHERE (ddt.Stato = 1 OR (ddt.Stato=3 AND ddt.fattura IS NULL)) AND ddt.anno = IF(ddtYear, ddtYear, ddt.anno);
			

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printDdtsListByInvoiceBody
DELIMITER //
CREATE PROCEDURE `sp_printDdtsListByInvoiceBody`(
	IN start_date DATE, 
	IN end_date DATE, 
	IN customer_id INT(11), 
	IN system_id INT(11),
	IN invoiced_status INT(11)
)
BEGIN

	DROP TABLE IF EXISTS tmp_ddtsList;

	CREATE TEMPORARY TABLE tmp_ddtsList
	SELECT 
		ddt.id_ddt,
		ddt.anno, 
		ddt.id_cliente, 
		ddt.Impianto,
		ddt.stato,
		fattura,
		anno_fattura
	FROM ddt 
	WHERE id_cliente IS NOT NULL AND data_documento >= start_date AND data_documento <= end_date;
	
	IF customer_id IS NOT NULL AND customer_id > 0 THEN
		DELETE FROM tmp_ddtsList
		WHERE id_cliente <> customer_id; 
	END IF; 

	IF system_id IS NOT NULL AND system_id > 0 THEN
		DELETE FROM tmp_ddtsList
		WHERE impianto <> system_id; 
	END IF;
	
	IF invoiced_status IS NOT NULL AND invoiced_status = 2 THEN -- NON FATTURATI
		DELETE FROM tmp_ddtsList
		WHERE fattura IS NOT NULL and anno_fattura IS NOT NULL AND anno_fattura <> 0;
	END IF; 

	IF invoiced_status IS NOT NULL AND invoiced_status = 1 THEN -- FATTURATI
		DELETE FROM tmp_ddtsList
		WHERE fattura IS NULL OR anno_fattura IS NULL OR anno_fattura = 0;
	END IF; 
	
	SELECT DISTINCT ddt.id_ddt AS "ID", 
		ddt.data_documento AS "data", 
		clienti.ragione_sociale, 
		impianto.descrizione, 
		ddt.fattura, 
		ddt.anno_fattura, 
		stato_ddt.Nome AS stato,
		DATE_FORMAT(data_documento, '%m %Y') AS titolo_gruppo,
		DATE_FORMAT(data_documento, '%Y-%m') AS id_gruppo,
		causale_trasporto.causale AS "causale_trasporto", 
		CAST(IFNULL(SUM(prezzo*quantità-(prezzo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS prezzo_totale, 
		CAST(IFNULL(SUM(costo*quantità-(costo*quantità/100*sconto)),2) AS DECIMAL(11,2)) AS costo_totale,
		CONCAT(CONCAT(dc.indirizzo,' n.',dc.numero_civico, dc.altro),' - ',concat(IF(f.nome IS NOT NULL AND f.nome <> '', concat(f.nome,' di '), ''), c.nome,' (',c.provincia,')')) AS 'indirizzo',
		IFNULL(CONCAT(c.cap," - ",c.nome,"(", dc.provincia,")"), "") AS "comune",  
		dc.Km_sede AS "km_viaggio",
		dc.Tempo_strada AS "tempo_viaggio",
		IFNULL(riferimento_principale.mail, '') AS "email_cliente",
		IFNULL(riferimento_principale.altro_telefono, "") AS "telefono_cliente", 
		stato_clienti.nome AS "stato_cliente",
		tipo_cliente.nome AS "tipo_cliente"
	FROM tmp_ddtsList AS tmp_ddts
		INNER jOIN Ddt 
			ON Ddt.Id_ddt = tmp_ddts.Id_ddt AND Ddt.Anno = tmp_ddts.Anno
		LEFT JOIN causale_trasporto ON ddt.causale=id_causale
		INNER JOIN clienti ON clienti.id_cliente = ddt.id_cliente
		INNER JOIN stato_clienti ON stato_clienti.Id_stato = clienti.Stato_cliente
		INNER JOIN tipo_cliente ON tipo_cliente.Id_tipo = clienti.Tipo_Cliente
		LEFT JOIN destinazione_cliente AS dc ON dc.id_cliente=ddt.id_cliente AND dc.id_destinazione=ddt.id_destinazione
		LEFT JOIN comune AS c ON c.id_comune=dc.comune
		LEFT JOIN impianto ON id_impianto = ddt.impianto
		LEFT JOIN articoli_ddt ON articoli_ddt.id_ddt=ddt.id_ddt AND articoli_ddt.anno=ddt.anno
		LEFT JOIN commessa_ddt ON commessa_ddt.Id_ddt=ddt.id_ddt AND commessa_ddt.Anno_ddt=ddt.anno 
		LEFT JOIN stato_ddt ON ddt.stato = stato_ddt.id_stato 
		LEFT JOIN frazione AS f ON f.id_frazione=dc.frazione
		LEFT JOIN riferimento_clienti AS riferimento_principale ON riferimento_principale.id_cliente=clienti.id_cliente AND riferimento_principale.id_riferimento = 1
	GROUP BY ddt.id_ddt, ddt.anno
	ORDER BY  data_documento DESC, ragione_sociale ASC;	

		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printDepotOperations
DELIMITER //
CREATE PROCEDURE `sp_printDepotOperations`(
	IN date_from DATE,
	IN date_to DATE,
	IN product_code VARCHAR(50)
)
BEGIN
	SELECT
		Id_operazione AS "ID Operazione",
		mo.`Data` AS "Data Operazione",
		mos.nome AS 'Sorgente',
		mo.Articolo AS "Codice Interno",
		articolo.Codice_fornitore AS "Codice Fornitore",
		articolo.Desc_brev AS "Descrizione",
		articolo_stato.Nome AS "Stato Articolo",
		marca.Nome as 'Marca',
		categoria_merciologica.Nome as 'Categoria Merceologica',
		sottocategoria.Nome as 'Sottocategoria Merceologica',
		articolo.tempo_installazione as 'Tempo Installazione (Minuti)',
		articolo.scadenza as 'Scadenza (Mesi)',
		IFNULL(listino_prezzo.Prezzo, 0) AS Prezzo,
		IFNULL(listino_costo.Prezzo, 0) AS Costo,
		mo.`quantità` AS "Quantità Movimentata",
		tm.nome AS "Magazzino",
		m.giacenza AS "Giacenza Magazzino Oggi"
	FROM magazzino_operazione mo
		INNER JOIN tipo_magazzino tm ON tm.Id_tipo = mo.id_magazzino
		INNER JOIN magazzino_operazione_sorgente mos ON mo.sorgente = mos.id
		INNER JOIN articolo ON articolo.Codice_articolo = mo.Articolo
		INNER JOIN articolo_stato ON articolo.Stato_articolo = articolo_stato.Id_stato
		INNER JOIN magazzino m ON m.tipo_magazzino = mo.id_magazzino AND m.Id_articolo = mo.Articolo
		LEFT JOIN marca ON articolo.Marca = marca.Id_marca
		LEFT JOIN categoria_merciologica ON categoria_merciologica.Id_categoria = articolo.categoria
		LEFT JOIN sottocategoria ON sottocategoria.Id_sottocategoria = articolo.sottocategoria AND sottocategoria.Id_categoria = articolo.categoria
		LEFT JOIN articolo_listino AS listino_prezzo ON listino_prezzo.Id_articolo = articolo.Codice_articolo AND listino_prezzo.id_listino = fnc_productInternalPriceId()
		LEFT JOIN articolo_listino AS listino_costo ON listino_costo.Id_articolo = articolo.Codice_articolo AND listino_costo.id_listino = fnc_productInternalCostId()
	WHERE mo.Articolo = IFNULL(product_code, mo.Articolo) AND mo.`Data` <= IFNULL(date_to, mo.`Data`) AND mo.`Data` >= IFNULL(date_from, mo.`Data`)
	ORDER BY mo.`Data` DESC, id_operazione DESC;	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printInvoicesPayments
DELIMITER //
CREATE PROCEDURE `sp_printInvoicesPayments`(
	IN start_date DATE, 
	IN end_date DATE,
	IN company_name VARCHAR(100), 
	IN payment_status TINYINT,
	IN group_by VARCHAR(100) 
)
BEGIN
	DECLARE all_payments TINYINT DEFAULT 0;
	DECLARE paid_payments TINYINT DEFAULT 1;
	DECLARE not_paid_payments TINYINT DEFAULT 2;

	-- extract invoices by filter
	DROP TABLE IF EXISTS tmp_print_invoices_payments;
	CREATE TEMPORARY TABLE tmp_print_invoices_payments
	SELECT 
		ragione_sociale, 
		fattura.id_fattura AS "id_fattura", 
		fattura.anno AS "anno", 
		(SUM(CAST(((IF(c.tipo<>"S", prezzo_unitario,0) -   (sconto /100 * if(c.tipo<>"S", prezzo_unitario,0))) * quantità) +((IF(c.tipo<>"S", prezzo_unitario,0) - (sconto/100*if(c.tipo<>"S", prezzo_unitario,0)))*quantità)* (IF(tipo_fattura="4","0", IF(c.iva="" or c.iva IS NULL, "0", c.iva))/100) as decimal(11,2))))+SUM(IF(c.tipo="S", prezzo_unitario,0)) AS "totale_fattura", 
		CAST(0 AS DECIMAL(11,2)) AS "da_pagare", 
		CAST(0 AS DECIMAL(11,2)) AS "importo_rata", 
		fattura.data AS "data", 
		condizione_pagamento.nome, 
		condizione_pagamento.tipo AS "n_tipo",
		tipo_pagamento.nome AS "tipo_pagamento", 
		fattura.stato, 
		condizione_pagamento.mesi as "quantita_rate"
		
	FROM fattura 
		INNER JOIN condizione_pagamento AS condizione_pagamento 
			ON cond_pagamento = condizione_pagamento.id_condizione 
		LEFT JOIN fattura_articoli AS c 
			ON c.id_fattura = fattura.id_fattura AND c.anno=fattura.anno 
		INNER JOIN clienti 
			ON fattura.id_cliente=clienti.id_cliente
		LEFT JOIN tipo_pagamento 
			ON condizione_pagamento.tipo=tipo_pagamento.id_tipo

	WHERE 
		fattura.DATA >= start_date
		AND fattura.DATA <= end_date
		AND fattura.anno<>"0"
	GROUP BY fattura.id_fattura, anno 
	ORDER BY n_tipo, anno DESC, fattura.id_fattura DESC;
	 
	IF IFNULL(company_name, '') <> '' THEN
		DELETE FROM tmp_print_invoices_payments 
		WHERE ragione_sociale NOT LIKE CONCAT('%',company_name,'%');
	END IF;
	
	IF payment_status = paid_payments THEN
		DELETE FROM tmp_print_invoices_payments 
		WHERE stato NOT IN (3);
	END IF; 
	
	IF payment_status = not_paid_payments THEN
		DELETE FROM tmp_print_invoices_payments 
		WHERE stato NOT IN (1,4);
	END IF;
	
	
	-- fill to pay and payments ampunt column
	UPDATE tmp_print_invoices_payments
	SET da_pagare = IFNULL(totale_fattura, 0), 
		importo_rata = IFNULL(totale_fattura, 0)/quantita_rate; 
		
		
	-- extract down payment
	DROP TABLE IF EXISTS tmp_down_payment;
	CREATE TEMPORARY TABLE tmp_down_payment
	SELECT	
		tmp_print_invoices_payments.id_fattura, 
		tmp_print_invoices_payments.anno, 
		IFNULL(SUM(fattura_acconto.importo), 0) totale_acconti
	FROM tmp_print_invoices_payments
		LEFT JOIN fattura_pagamenti 
			ON fattura_pagamenti.id_fattura = tmp_print_invoices_payments.id_fattura
				AND fattura_pagamenti.anno = tmp_print_invoices_payments.anno
				AND fattura_pagamenti.`data` IS NULL
		LEFT JOIN fattura_acconto 
		 	ON fattura_acconto.id_pagamento = fattura_pagamenti.id_pagamento 
			   AND fattura_pagamenti.id_fattura = fattura_acconto.id_fattura
				AND fattura_pagamenti.anno = fattura_acconto.anno			
	GROUP BY tmp_print_invoices_payments.id_fattura, tmp_print_invoices_payments.anno;	

	IF group_by = "payment_type" THEN
		-- extract invoices by filter	
		SELECT 		
			tmp_print_invoices_payments.ragione_sociale, 
			tmp_print_invoices_payments.id_fattura, 
			tmp_print_invoices_payments.anno, 
			tmp_print_invoices_payments.totale_fattura, 
			IF(da_pagare < ((COUNT(fattura_pagamenti.`data`) * importo_rata) + tmp_down_payment.totale_acconti), 
				0.00,
				(da_pagare - (COUNT(fattura_pagamenti.`data`) * importo_rata) - tmp_down_payment.totale_acconti)
			) as da_pagare, 
			tmp_print_invoices_payments.importo_rata, 
			tmp_print_invoices_payments.data, 
			tmp_print_invoices_payments.nome, 
			tmp_print_invoices_payments.n_tipo,
			tmp_print_invoices_payments.tipo_pagamento AS tipo_pagamento,
			mese.Nome AS mese,
			tmp_print_invoices_payments.stato,
			CONVERT(tmp_print_invoices_payments.tipo_pagamento USING utf8) AS group_by
		FROM tmp_print_invoices_payments
			LEFT JOIN fattura_pagamenti 
				ON fattura_pagamenti.id_fattura = tmp_print_invoices_payments.id_fattura
					AND fattura_pagamenti.anno = tmp_print_invoices_payments.anno
					AND fattura_pagamenti.`data` IS NOT NULL
			INNER JOIN tmp_down_payment	
				ON tmp_down_payment.id_fattura = tmp_print_invoices_payments.id_fattura
					AND tmp_down_payment.anno = tmp_print_invoices_payments.anno
					AND tmp_down_payment.anno = tmp_print_invoices_payments.anno
			INNER JOIN mese
				ON mese.Id_mese = MONTH(tmp_print_invoices_payments.data)
		GROUP BY tmp_print_invoices_payments.id_fattura, tmp_print_invoices_payments.anno
		ORDER BY tipo_pagamento, tmp_print_invoices_payments.anno DESC, tmp_print_invoices_payments.id_fattura DESC;
	
	END IF;

	IF group_by = "month" THEN		
		SELECT 		
			tmp_print_invoices_payments.ragione_sociale, 
			tmp_print_invoices_payments.id_fattura, 
			tmp_print_invoices_payments.anno, 
			tmp_print_invoices_payments.totale_fattura, 
			IF(da_pagare < ((COUNT(fattura_pagamenti.`data`) * importo_rata) + tmp_down_payment.totale_acconti), 
				0.00,
				(da_pagare - (COUNT(fattura_pagamenti.`data`) * importo_rata) - tmp_down_payment.totale_acconti)
			) as da_pagare, 
			tmp_print_invoices_payments.importo_rata, 
			tmp_print_invoices_payments.data, 
			tmp_print_invoices_payments.nome, 
			tmp_print_invoices_payments.n_tipo,
			tmp_print_invoices_payments.tipo_pagamento AS tipo_pagamento,
			mese.Nome AS mese,
			tmp_print_invoices_payments.stato,
			CONVERT(CONCAT(mese.Nome, ' ', tmp_print_invoices_payments.anno) USING utf8) AS group_by
		FROM tmp_print_invoices_payments
			LEFT JOIN fattura_pagamenti 
				ON fattura_pagamenti.id_fattura = tmp_print_invoices_payments.id_fattura
					AND fattura_pagamenti.anno = tmp_print_invoices_payments.anno
					AND fattura_pagamenti.`data` IS NOT NULL
			INNER JOIN tmp_down_payment	
				ON tmp_down_payment.id_fattura = tmp_print_invoices_payments.id_fattura
					AND tmp_down_payment.anno = tmp_print_invoices_payments.anno
					AND tmp_down_payment.anno = tmp_print_invoices_payments.anno
			INNER JOIN mese
				ON mese.Id_mese = MONTH(tmp_print_invoices_payments.data)
		GROUP BY tmp_print_invoices_payments.id_fattura, tmp_print_invoices_payments.anno
		ORDER BY tmp_print_invoices_payments.anno DESC, mese.id_mese DESC, tmp_print_invoices_payments.id_fattura DESC;
	 
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printInvoicesStatementCustomer
DELIMITER //
CREATE PROCEDURE `sp_printInvoicesStatementCustomer`(
	IN `customer_id` INT(11)
)
BEGIN
	SELECT ragione_sociale,
		CONCAT(indirizzo, ", ", numero_civico) as "indirizzo",
		IF(frazione.nome IS NULL OR frazione.nome='', CONCAT(comune.cap," - ", comune.nome, " (", comune.provincia,")"), CONCAT(comune.cap," - ", frazione.nome," di ", comune.nome, " (", comune.provincia,")")) AS "comune"
	FROM clienti
	INNER JOIN destinazione_cliente ON destinazione_cliente.id_cliente=clienti.id_cliente
	LEFT JOIN comune ON id_comune=destinazione_cliente.comune
	LEFT JOIN frazione ON id_frazione=destinazione_cliente.frazione
	WHERE clienti.id_cliente = customer_id
	ORDER BY destinazione_cliente.Sede_principale DESC, destinazione_cliente.id_destinazione ASC
	LIMIT 1;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printInvoicesStatementExpiredDeposit
DELIMITER //
CREATE PROCEDURE `sp_printInvoicesStatementExpiredDeposit`(
	IN `customer_id` INT(11)
)
BEGIN
	SELECT fattura_acconto.id_fattura,
		fattura_acconto.anno,
		CONCAT(fattura_acconto.id_pagamento,"") AS "id_pagamento",
		fattura_acconto.data,
		fattura_acconto.importo
	FROM fattura_acconto
	INNER JOIN vw_invoices_payments_details pagamenti
		ON fattura_acconto.id_fattura = pagamenti.id_fattura
		AND fattura_acconto.anno = pagamenti.anno 
		AND fattura_acconto.id_pagamento = pagamenti.id_pagamento 
	WHERE fattura_acconto.anno <> 0 AND id_cliente = customer_id AND  pagato = 0 AND data_pagamento_prevista < CURRENT_DATE;	
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printInvoicesStatementExpiredPayments
DELIMITER //
CREATE PROCEDURE `sp_printInvoicesStatementExpiredPayments`(
	IN `customer_id` INT(11)
)
BEGIN
	SELECT id_fattura,
		anno,
		id_pagamento,
		data_pagamento_prevista,
		DATE_FORMAT(data_pagamento_prevista, '%d/%m/%Y') as data_pagamento_prevista_str,
		(importo_pagamento - totale_acconti) as importo_pagamento,
		DATEDIFF(CURRENT_DATE, data_pagamento_prevista) AS "giorni",
		tipo_pagamento,
		condizione_pagamento,
		data_fattura
	FROM vw_invoices_payments_details 
	WHERE id_cliente = customer_id AND pagato = 0 AND data_pagamento_prevista < CURRENT_DATE AND anno != 0
	ORDER BY data_pagamento_prevista ASC, anno ASC, id_fattura ASC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printInvoicesStatementExpiringDeposit
DELIMITER //
CREATE PROCEDURE `sp_printInvoicesStatementExpiringDeposit`(
	IN `customer_id` INT(11)
)
BEGIN
	SELECT fattura_acconto.id_fattura,
		fattura_acconto.anno,
		CONCAT(fattura_acconto.id_pagamento,"") AS "id_pagamento",
		fattura_acconto.data,
		fattura_acconto.importo
	FROM fattura_acconto
	INNER JOIN vw_invoices_payments_details pagamenti
		ON fattura_acconto.id_fattura = pagamenti.id_fattura
		AND fattura_acconto.anno = pagamenti.anno 
		AND fattura_acconto.id_pagamento = pagamenti.id_pagamento 
	WHERE fattura_acconto.anno <> 0 AND id_cliente = customer_id AND pagato = 0 AND data_pagamento_prevista >= CURRENT_DATE;	
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printInvoicesStatementExpiringPayments
DELIMITER //
CREATE PROCEDURE `sp_printInvoicesStatementExpiringPayments`(
	IN `customer_id` INT(11)
)
BEGIN
	SELECT id_fattura,
		anno,
		id_pagamento,
		data_pagamento_prevista,
		DATE_FORMAT(data_pagamento_prevista, '%d/%m/%Y') as data_pagamento_prevista_str,
		(importo_pagamento - totale_acconti) as importo_pagamento,
		DATEDIFF(CURRENT_DATE, data_pagamento_prevista) AS "giorni",
		tipo_pagamento,
		condizione_pagamento,
		data_fattura
	FROM vw_invoices_payments_details 
	WHERE id_cliente = customer_id AND pagato = 0 AND data_pagamento_prevista >= CURRENT_DATE AND anno != 0
	ORDER BY data_pagamento_prevista ASC, anno ASC, id_fattura ASC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printInvoicesStatementSplit
DELIMITER //
CREATE PROCEDURE `sp_printInvoicesStatementSplit`(
	IN `customer_id` INT(11)
)
BEGIN
	SELECT DATE_FORMAT(data_pagamento_prevista, '%d/%m/%Y') as data_pagamento_prevista_str 
	FROM vw_invoices_payments_details
	WHERE anno <> 0 and id_cliente = customer_id AND pagato = 0
	GROUP BY data_pagamento_prevista
	ORDER BY data_pagamento_prevista ASC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printInvoicesStatementTotals
DELIMITER //
CREATE PROCEDURE `sp_printInvoicesStatementTotals`(
	IN `customer_id` INT(11)
)
BEGIN
	SELECT SUM(importo_pagamento - totale_acconti) as importo,
		data_pagamento_prevista,
		DATE_FORMAT(data_pagamento_prevista, '%d/%m/%Y') as data_pagamento_prevista_str 
	FROM vw_invoices_payments_details
	WHERE anno <> 0 and id_cliente = customer_id AND pagato = 0
	GROUP BY data_pagamento_prevista
	ORDER BY data_pagamento_prevista ASC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printJobAssociatesDocuments
DELIMITER //
CREATE PROCEDURE `sp_printJobAssociatesDocuments`(
	IN job_id INT(11),
	IN job_year INT(11), 	
	IN sub_job_id INT(11),
	IN job_lot_id INT(11)
)
BEGIN
	DROP TABLE IF EXISTS tmp_job_associates_documents;

	CREATE TEMPORARY TABLE tmp_job_associates_documents
   	SELECT 
   		ddt.id_ddt AS "ID", 
	    anno AS "anno", 
	    data_documento AS "Data", 
  		causale_trasporto.causale AS "Causale",
		"DDT" AS "Documento", 
		id_lotto, 
		id_sottocommessa,
		CONCAT(fattura," / ", anno_fattura) AS "fattura"
	FROM ddt 
		INNER JOIN causale_trasporto 
			ON ddt.causale=id_causale 
		INNER JOIN destinazione_cliente AS b 
			ON b.id_cliente=ddt.id_cliente AND b.id_destinazione=ddt.id_destinazione 
  		LEFT JOIN comune AS b1 
		  	ON b1.id_comune=b.comune  
   		INNER JOIN commessa_ddt AS A 
		   ON a.id_ddt=ddt.ID_DDT AND ddt.anno=anno_ddt 
	WHERE id_commessa = job_id AND anno_commessa = job_year

   	UNION ALL 
	SELECT 
		rapporto.numero AS "ID",
		rapporto.anno AS "anno", 
		data_esecuzione AS "Data", 
		tipo_intervento.nome AS "Causale",
		"RAPPORTO" AS "Documento", 
		id_lotto,
		id_sottocommessa,
		CONCAT(fattura," / ", anno_fattura) AS "fattura"
	FROM rapporto 
		INNER JOIN tipo_intervento 
			ON id_tipo=tipo_intervento 
   		LEFT JOIN resoconto_rapporto 
		   	ON rapporto.id_rapporto=resoconto_rapporto.id_rapporto AND rapporto.anno=resoconto_rapporto.anno
    	INNER JOIN destinazione_cliente AS b 
   			ON b.id_cliente=rapporto.id_cliente AND b.id_destinazione=rapporto.id_destinazione 
		LEFT JOIN comune AS b1 
			ON b.comune=b1.id_comune 
		INNER JOIN commessa_rapporto AS A 
			ON a.id_rapporto=rapporto.ID_rapporto AND rapporto.anno=anno_rapporto 
	WHERE id_commessa = job_id AND anno_commessa = job_year
	
   	UNION ALL 
  	SELECT 
	  fattura.id_fattura AS "ID", 
	  fattura.anno AS "anno", 
	  data AS "data", 
	  tipo_com_fat.nome AS "Causale",
	  "FATTURA" AS "Documento", 
	  id_lotto,
	  id_sottocommessa,
	  "" AS "fattura" 
	FROM commessa_fattura 
		INNER JOIN FATTURA  
   			ON fattura.id_fattura=commessa_fattura.id_fattura AND anno=anno_fattura 
   		INNER JOIN tipo_com_fat 
			ON id_tipo=tipo 
   	WHERE id_commessa = job_id AND anno_commessa = job_year

   	UNION ALL 
	SELECT 
		CONCAT(preventivo.id_preventivo,"R.", id_revisione),
		preventivo_lotto.anno, 
		data_creazione,
		lotto.nome,
		"PREVENTIVO", 
		commessa_preventivo.lotto,
		commessa_preventivo.id_sottocommessa,
		"" 
   	FROM commessa_preventivo 
   		INNER JOIN preventivo_lotto 
	   		ON id_preventivo=preventivo AND preventivo_lotto.anno=anno_prev AND posizione=pidlotto AND preventivo_lotto.id_revisione=rev 
		INNER JOIN lotto 
			ON lotto.id_lotto=preventivo_lotto.id_lotto 
   		INNER JOIN preventivo 
		   	ON preventivo.id_preventivo=preventivo_lotto.id_preventivo AND preventivo.anno=preventivo_lotto.anno 

	WHERE id_commessa = job_id AND commessa_preventivo.anno = job_year
	 
	UNION ALL
	SELECT DISTINCT
		ordine_fornitore.Id_ordine, 
		ordine_fornitore.anno, 
		data_creazione, 
		"", 
		"ORDINE" AS "Documento", 
		com_lotto,
		id_sottocommessa,
		"" AS "fattura" 	
	FROM ordine_dettaglio
		INNER JOIN ordine_fornitore
			ON ordine_fornitore.id_ordine = ordine_dettaglio.id_ordine AND ordine_fornitore.anno = ordine_dettaglio.anno
	WHERE id_commessa = job_id AND anno_commessa = job_year; 

   IF (sub_job_id <> -1) THEN

		DELETE 
		FROM tmp_job_associates_documents
		WHERE id_sottocommessa = sub_job_id;

	END IF;

	   		
   IF (job_lot_id <> -1) THEN

		DELETE 
		FROM tmp_job_associates_documents
		WHERE id_lotto <> job_lot_id;

	END IF;

	SELECT * 
	FROM tmp_job_associates_documents
	ORDER BY id_sottocommessa, id_lotto, Data; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printJobBodyInfo
DELIMITER //
CREATE PROCEDURE `sp_printJobBodyInfo`(
	IN `job_id` INT(11),
	IN `job_year` INT(11), 	
	IN `sub_job_id` INT(11),
	IN `job_lot_id` INT(11)
)
BEGIN
	
	DROP TABLE IF EXISTS tmp_job_body; 
	   		
	 CREATE TEMPORARY TABLE tmp_job_body
	SELECT `Id_commessa`
		,`Anno`
		,`id_sottocommessa`
		,`Lotto`
		,`Posizionamento`
		,`Codice_articolo`
		,`Codice_fornitore`
		,`Descrizione`
		,`Qta_utilizzata`
		,`Qta_commessa`
		,`Qta_preventivati`
		,`UM`
		,Prezzo
		,`Costo`
		,`Prezzo_ora`
		,`Costo_ora`
		,`Sconto`
		,CAST(Tempo_installazione / 60 AS DECIMAL(11,2)) AS `Tempo_installazione`
		,`Qta_economia`
		,CAST((Prezzo * Qta_utilizzata)* (100 - `Sconto`) / 100 AS DECIMAL(11,2)) As Prezzo_finale
		,CAST((Prezzo * Qta_economia)* (100 - `Sconto`) / 100 AS DECIMAL(11,2)) As Prezzo_finale_Eco
	FROM vw_jobbody
	WHERE
	id_commessa = job_id 
		AND anno = job_year
	ORDER BY Lotto, Posizionamento;
	
   		
   ALTER TABLE tmp_job_body ADD COLUMN Id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT, ADD PRIMARY KEY (`Id`);
	
	IF (sub_job_id <> -1) THEN

		DELETE 
		FROM tmp_job_body
		WHERE id_sottocommessa <> sub_job_id;

	END IF;

   IF (job_lot_id <> -1) THEN

		DELETE 
		FROM tmp_job_body
		WHERE Lotto <> job_lot_id;

	END IF;
   		
	SELECT 
		Id
		,`Id_commessa`
		,`Anno`
		,`Lotto`
		,`Posizionamento`
		,`Codice_articolo`
		,`Codice_fornitore`
		,`Descrizione`
		,`Qta_utilizzata`
		,`Qta_commessa`
		,`Qta_preventivati`
		,`UM`
		,CAST(IFNULL(`Prezzo`, 0) AS DECIMAL(11,2)) Prezzo
		,`Costo`
		,`Prezzo_ora`
		,`Costo_ora`
		,`Sconto`
		,`Tempo_installazione`
		,`Qta_economia`
		,Prezzo_finale
	FROM tmp_job_body; 
	
	   
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printJobHeaderInfo
DELIMITER //
CREATE PROCEDURE `sp_printJobHeaderInfo`(
	IN `job_id` INT(11),
	IN `job_year` INT(11),
	IN `sub_job_id` INT(11)
)
BEGIN

	DECLARE agent_name VARCHAR(50);

	SELECT DISTINCT 
		operaio.Ragione_sociale	
	INTO 
		agent_name
	FROM commessa_preventivo
		INNER JOIN preventivo 
			ON commessa_preventivo.preventivo = preventivo.Id_preventivo
				AND commessa_preventivo.anno_prev = preventivo.anno
				AND commessa_preventivo.rev = preventivo.revisione
		INNER JOIN operaio 
			ON preventivo.agente = operaio.id_operaio
	WHERE commessa_preventivo.Id_commessa = job_id 
		AND commessa_preventivo.anno = job_year
		AND id_sottocommessa = sub_job_id
	LIMIT 1; 

	SELECT
	   clienti.id_cliente,
	   ragione_sociale,
	   ragione_sociale2,
	   Id_commessa,
	   anno,
	   agent_name AS "agente",
	   data_inizio,
	   data_scadenza,
	   fax,
	   altro_telefono,
	   telefono,
	   mail,
	   partita_iva,
	   codice_fiscale,
	   CONCAT(a1.cap,
	   " - ",
	   IF(frazione.nome IS NOT NULL,
	   CONCAT(frazione.nome,
	   " di "),
	   ""),
	   a1.nome,
	   " (",
	   a.provincia,
	   ")") AS "Provincia princ",
	   CONCAT(    if((a.indirizzo IS NOT NULL),
	   CONCAT(a.indirizzo),
	   ""),
	   if((a.numero_civico IS NOT NULL),
	   CONCAT(",",
	   a.numero_civico),
	   ""),
	   if((a.altro IS NOT NULL) 
	   AND (a.altro<>" "),
	   CONCAT("/",
	   a.altro),
	   ""))      AS "Indirizzo princ"            
	FROM commessa 
		LEFT JOIN destinazione_cliente AS a     
		   on a.id_cliente=commessa.id_cliente 
		   AND a.sede_principale="1" 
		   AND a.attivo="1"     
		LEFT JOIN comune AS a1 
		   ON a1.id_comune=a.comune 
		LEFT JOIN frazione 
		   ON id_Frazione=frazione 
		LEFT JOIN clienti 
		   ON clienti.id_cliente = commessa.id_cliente 
		LEFT JOIN riferimento_clienti 
		   ON        riferimento_clienti.id_cliente = clienti.id_cliente 
		   AND id_riferimento = 1
	WHERE
	   id_commessa = job_id 
	   AND anno = job_year;
	   
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printJobHoursDetails
DELIMITER //
CREATE PROCEDURE `sp_printJobHoursDetails`(
	IN job_id INT(11),
	IN job_year INT(11),
	IN sub_job_id INT(11),
	IN job_lot_id INT(11)
)
BEGIN

	DROP TABLE IF EXISTS tmp_job_hours_details; 

	CREATE TEMPORARY TABLE tmp_job_hours_details   		
	SELECT 
		Id_commessa, 
		anno_commessa, 
		id_sottocommessa,
		id_lotto, 
		ROUND(SUM(totale/60), 2) Ore_totali, 
		causale_lavoro.Nome
	
	FROM commessa_rapporto 
		INNER JOIN rapporto_tecnico_lavoro
		 	ON Commessa_rapporto.id_rapporto = rapporto_tecnico_lavoro.id_rapporto AND commessa_rapporto.anno_rapporto = rapporto_tecnico_lavoro.anno 	
		INNER JOIN causale_lavoro
			ON rapporto_tecnico_lavoro.Id_lavoro = causale_lavoro.Id_causale
	WHERE  id_commessa = job_id 
   		AND anno_commessa = job_year
	GROUP BY Id_commessa, anno_commessa, id_sottocommessa, id_lotto
	ORDER BY Id_lotto;

   IF (sub_job_id <> -1) THEN

		DELETE 
		FROM tmp_job_hours_details
		WHERE id_sottocommessa <> sub_job_id;

	END IF;

   IF (job_lot_id <> -1) THEN

		DELETE 
		FROM tmp_job_hours_details
		WHERE id_lotto <> job_lot_id;

	END IF;

	SELECT * 
	FROM tmp_job_hours_details; 
	   
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printJobLotsHoursWorked
DELIMITER //
CREATE PROCEDURE `sp_printJobLotsHoursWorked`(
	IN `job_id` INT(11),
	IN `job_year` INT(11),
	IN `sub_job_id` INT(11),
	IN `job_lot_id` INT(11), 
	IN `considers_trip_hours` BIT 
)
BEGIN

	DROP TABLE IF EXISTS tmp_Job_hours_worked; 
	CREATE TABLE tmp_Job_hours_worked(
		svolte DECIMAL(11,2), 
		Id_sottocommessa INT(11),
		Id_lotto INT(11)
	);

	INSERT INTO tmp_Job_hours_worked (svolte, id_sottocommessa, Id_lotto)
	SELECT 
		IFNULL(SUM(rapporto_tecnico_lavoro.totale)/60, 0) AS "svolte", 
		commessa_rapporto.id_sottocommessa,
		commessa_rapporto.id_lotto 
	FROM commessa_rapporto 
		INNER JOIN rapporto_tecnico_lavoro 
			ON commessa_rapporto.id_rapporto=rapporto_tecnico_lavoro.id_rapporto 
			AND commessa_rapporto.anno_rapporto=rapporto_tecnico_lavoro.anno AND straordinario < 3
	WHERE id_commessa = job_id AND anno_commessa = job_year
	GROUP BY commessa_rapporto.id_lotto;
	
	IF considers_trip_hours THEN

		INSERT INTO tmp_Job_hours_worked (svolte, id_sottocommessa, Id_lotto)
		SELECT 
			IFNULL(SUM(tempo_viaggio)/60, 0) AS "svolte", 
			commessa_rapporto.id_sottocommessa,
			commessa_rapporto.id_lotto 
		FROM commessa_rapporto 
			INNER JOIN rapporto_tecnico AS a 
				ON commessa_rapporto.id_rapporto=a.id_rapporto AND commessa_rapporto.anno_rapporto=a.anno 
		WHERE id_commessa = job_id AND anno_commessa = job_year
		GROUP BY commessa_rapporto.id_lotto;
		
	END IF;

	
	IF (sub_job_id <> -1) THEN

		DELETE 
		FROM tmp_Job_hours_worked
		WHERE id_sottocommessa = sub_job_id;

	END IF;	
	
	IF (job_lot_id <> -1) THEN

		DELETE 
		FROM tmp_Job_hours_worked
		WHERE Id_lotto <> job_lot_id;

	END IF;
	
	
	SELECT 
		SUM(svolte) AS svolte, 
		Id_lotto
	FROM tmp_Job_hours_worked
	GROUP BY Id_lotto
	ORDER BY Id_lotto;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printJobLotsInfo
DELIMITER //
CREATE PROCEDURE `sp_printJobLotsInfo`(
	IN `job_id` INT(11),
	IN `job_year` INT(11),
	IN `sub_job_id` INT(11),
	IN `job_lot_id` INT(11)
)
BEGIN
 	SELECT
		commessa_lotto.id_commessa,
		commessa_lotto.anno,
		commessa_lotto.id_sottocommessa,
		commessa_lotto.id_lotto,
		commessa_lotto.Descrizione,
		commessa_lotto.impianto as id_impianto,
		impianto.Descrizione as impianto,
		CONCAT(destinazione_cliente.Indirizzo, ", ", destinazione_cliente.numero_civico, " - ", 
			comune.cap," ", 
			IF(Frazione.nome IS NULL, "", Concat(Frazione.nome , " di ")), 
			IFNULL(comune.Nome, "")) AS indirizzo_impianto, 
		IFNULL(SUM(Qta_preventivati*(Tempo_Installazione/60)), 0) AS "Da_fare",
		IFNULL(SUM(Qta_preventivati*(Tempo_Installazione/60)*(prezzo_ora-prezzo_ora/100*sconto)), 0) AS "prezzo_lav_tot",
		IFNULL(SUM(Qta_preventivati*(prezzo - prezzo/100*sconto)),0) AS "prezzo_mat_tot",
		IFNULL(SUM(Qta_preventivati*(Tempo_Installazione/60)*costo_ora), 0) AS "costo_lav_tot",
		IFNULL(SUM(Qta_preventivati*costo), 0) AS "costo_mat_tot",
		COUNT(a.id_commessa) = 0 AS lotto_vuoto
	FROM
		commessa_lotto 
		LEFT JOIN
			vw_jobbody AS a 
				ON a.id_commessa=commessa_lotto.id_commessa 
				AND a.anno=commessa_lotto.anno 
				AND a.id_sottocommessa = commessa_lotto.id_sottocommessa
				AND a.lotto=commessa_lotto.id_lotto  
		LEFT JOIN impianto ON impianto.id_impianto = commessa_lotto.impianto
		LEFT JOIN destinazione_cliente ON destinazione_cliente.id_cliente = impianto.id_cliente and destinazione = id_destinazione
		LEFT JOIN Comune ON
			destinazione_cliente.Comune = comune.Id_comune
		LEFT JOIN frazione ON
			destinazione_cliente.Frazione = frazione.Id_frazione 
	WHERE
		commessa_lotto.id_commessa = job_id
		AND commessa_lotto.anno = job_year
		AND IF(sub_job_id = -1, -1, commessa_lotto.id_sottocommessa) = sub_job_id
		AND IF(job_lot_id = -1, -1, commessa_lotto.id_lotto) = job_lot_id
	
	GROUP BY
		commessa_lotto.id_sottocommessa,
		commessa_lotto.id_lotto
	HAVING COUNT(*) > 0;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printJobRequirementsBody
DELIMITER //
CREATE PROCEDURE `sp_printJobRequirementsBody`(
	IN job_id INT(11),
	IN job_year INT(11),
	IN sub_job_id INT(11)
)
BEGIN
	DROP TABLE IF EXISTS tmp_print_job_requirements;
	CREATE TEMPORARY TABLE tmp_print_job_requirements
	SELECT *
	FROM (
		SELECT IF(is_kit=1,2,0) AS "is_kit",
			" " AS "cod_art_3",
			IF(is_kit=1, commessa_articoli.codice_articolo," ") AS "codice_articolo2",
			IF(is_kit=0, commessa_articoli.codice_articolo," ") AS "codice_articolo",
			" " AS cod_forn2,
			commessa_articoli.codice_fornitore,
			" " AS "Descrizione3",
			IF(is_kit=1, CONCAT(commessa_Articoli.descrizione, " composto da:")," ") AS "Descrizione2",
			IF(is_kit=0, commessa_Articoli.descrizione," ") AS "Descrizione",
			IF(is_kit=0, REPLACE(REPLACE(REPLACE(FORMAT(IFNULL(quantità,"0")+ IFNULL(commessa_articoli.economia, "0"), 2), ".", "@"), ",", "."), "@", ","), " ") AS "quantità",
			" " AS "q2",
			commessa_lotto.id_sottocommessa AS "id_sottocommessa",
			commessa_LOTTO.id_lotto AS "id_lotto",
			commessa_lotto.descrizione AS "lotto",
			id_tab
		FROM commessa_articoli
			LEFT JOIN commessa_lotto ON commessa_articoli.id_lotto=commessa_lotto.id_lotto
				AND commessa_articoli.anno=commessa_lotto.anno
				AND commessa_Articoli.id_commessa=commessa_lotto.id_commessa
				AND commessa_Articoli.id_sottocommessa = commessa_lotto.id_sottocommessa
			LEFT JOIN articolo ON articolo.codice_articolo=commessa_articoli.codice_articolo
		WHERE commessa_articoli.codice_articolo IS NOT NULL
			AND commessa_articoli.codice_articolo<>""
			AND commessa_lotto.id_commessa = job_id
			AND commessa_lotto.anno = job_year
			AND IF(sub_job_id > 0, commessa_lotto.id_sottocommessa = sub_job_id, True)
		
		UNION ALL
		SELECT IF(is_kit=1,2,0) AS "is_kit",
			" " AS "cod_art_3",
			IF(is_kit=1, commessa_articoli.codice_articolo," ") AS "codice_articolo2",
			" " AS "codice_articolo",
			" " AS cod_forn2,
			commessa_articoli.codice_fornitore,
			" " AS "Descrizione3",
			" " AS "Descrizione2",
			commessa_Articoli.descrizione AS "Descrizione",
			IF(is_kit=0, REPLACE(REPLACE(REPLACE(FORMAT(IFNULL(quantità,"0")+ IFNULL(commessa_articoli.economia,"0"), 2), ".", "@"), ",", "."), "@", ","), " ") AS "quantità",
			" " AS "q2",
			commessa_lotto.id_sottocommessa AS "id_sottocommessa",
			commessa_lotto.id_lotto AS "id_lotto",
			commessa_lotto.descrizione AS "lotto",
			id_tab
		FROM commessa_articoli
			LEFT JOIN commessa_lotto ON commessa_articoli.id_lotto=commessa_lotto.id_lotto
				AND commessa_articoli.anno=commessa_lotto.anno
				AND commessa_Articoli.id_commessa=commessa_lotto.id_commessa
				AND commessa_Articoli.id_sottocommessa = commessa_lotto.id_sottocommessa
			LEFT JOIN articolo ON articolo.codice_articolo=commessa_articoli.codice_articolo
		WHERE (commessa_articoli.codice_articolo IS NULL OR commessa_articoli.codice_articolo="")
			AND commessa_lotto.id_commessa = job_id
			AND commessa_lotto.anno = job_year
			AND IF(sub_job_id > 0, commessa_lotto.id_sottocommessa = sub_job_id, True)
		
		UNION ALL
		SELECT articolo.is_kit,
			riferimento_kit_articoli.id_articolo AS "cod_art_3",
			" " AS "codice_articolo2",
			" " AS "codice_articolo",
			articolo_kit.codice_fornitore,
			" " AS "codice_fornitore",
			articolo_kit.desc_brev AS "Descrizione3",
			" " AS "Descrizione2",
			" " AS "Descrizione",
			"  " AS "quantità",
			REPLACE(REPLACE(REPLACE(FORMAT((IFNULL(quantità, "0")+ IFNULL(commessa_articoli.economia,"0"))*riferimento_kit_articoli.quantita, 2), ".", "@"), ",", "."), "@", ",") AS "q2",
			commessa_lotto.id_sottocommessa AS "id_sottocommessa",
			commessa_lotto.id_lotto AS "id_lotto",
			commessa_lotto.descrizione AS "lotto",
			id_tab
		FROM commessa_articoli
			LEFT JOIN commessa_lotto ON commessa_articoli.id_lotto=commessa_lotto.id_lotto
				AND commessa_articoli.anno=commessa_lotto.anno
				AND commessa_Articoli.id_commessa=commessa_lotto.id_commessa
				AND commessa_Articoli.id_sottocommessa = commessa_lotto.id_sottocommessa
			LEFT JOIN riferimento_kit_articoli ON id_kit=commessa_articoli.codice_articolo
			LEFT JOIN articolo ON articolo.codice_articolo=commessa_articoli.codice_articolo
			LEFT JOIN articolo AS articolo_kit ON articolo_kit.codice_articolo=riferimento_kit_articoli.id_articolo
		WHERE articolo.is_kit=1
			AND commessa_lotto.id_commessa = job_id
			AND commessa_lotto.anno = job_year
			AND IF(sub_job_id > 0, commessa_lotto.id_sottocommessa = sub_job_id, True)
	) AS temp_job_print_requirements
	ORDER BY id_sottocommessa, id_lotto, id_tab;

	ALTER TABLE tmp_print_job_requirements ADD id INT PRIMARY KEY AUTO_INCREMENT;

	SELECT * FROM tmp_print_job_requirements;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printQuoteBody
DELIMITER //
CREATE PROCEDURE `sp_printQuoteBody`(
	IN quote_id INT(11), 
	IN quote_year INT(11),
	IN quote_rev_id INT(11), 
	IN product_code_type SMALLINT, 
	IN show_price BIT(1)
)
BEGIN

	DECLARE decription_type INT(11);
	DECLARE discount_zero INT(11);
	DECLARE mounted INT(11); 

	SELECT valore
		INTO decription_type
	FROM preventivo_impost 
	WHERE tipo="desc";

	SELECT valore
		INTO discount_zero
	FROM preventivo_impost 
	WHERE tipo="sconto_0";

	SELECT valore
		INTO mounted
	FROM preventivo_impost 
	WHERE tipo="stampa_imoco";


	SELECT 
		articolo_preventivo.Id_preventivo,
		articolo_preventivo.Anno,
		articolo_preventivo.Id_revisione, 
		articolo_preventivo.Lotto,
		lotto.Nome AS nome_lotto,
		IF(product_code_type = 0, id_articolo, 
			IF(product_code_type = 1, articolo_preventivo.codice_fornitore, ""))
		AS "id_articolo",
		articolo_preventivo.idNota,
		articolo_preventivo.id_tab, 
		IF(id_articolo LIKE "--%" AND quantità="0","N", tipo) AS "tipo",
		IF(decription_type = 1, 
			IF(articolo.desc_brev IS NOT NULL,articolo.desc_brev,articolo_preventivo.desc_brev), 
			articolo_preventivo.desc_brev) 
		AS "desc_brev",
		CONCAT(" ", IF(l<>0 or h<>0 or p<>0 or litri<>0, 
			CONCAT("Dimensioni mm L/ø ",l," H ",h," P ",p," Litri ",litri,"l"),""), 
			IF(peso IS NOT NULL AND peso<>0, CONCAT(" Peso ", peso,"Kg"),""),
			IF(min<>0 AND max<>0, CONCAT(" Temperatura ",min,"...",max," °C "),""), 
			IF(umidità<>0, CONCAT("Umidità ",umidità,"ur% "),""),
			IF(kw<>0, CONCAT(" Ass. a ri. ",kw,"mA "),""), 
			IF(kwp<>0, CONCAT(" As. in all. ",kwp,"mA"),"")) AS "altre", 

		IF(tipo="n" AND prezzo=0, NULL, quantità) AS "quantita", 
		articolo_preventivo.unità_misura, 

		IF(show_price = 1, 
			IF(scontoriga>=0,(ROUND((prezzo-(IF(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)+(IF(montato="0",0,((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100))))),(ROUND((prezzo-(if(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)*1+(IF(montato="0",0,1*((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100))))) - ((ROUND(round((prezzo-(if(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)*scontoriga/100,2)*1)+((IF(montato="0",0,1*((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100)))))*scontoriga/100)),
			articolo_preventivo.costo) 
		AS "prezzo", 

		IF(show_price = 1,
			IF(discount_zero = 1,
				IF(scontoriga<=0, NULL, ROUND(scontoriga,2)),
				IF(scontoriga<0, ROUND(scontoriga-scontoriga,2), ROUND(scontoriga,2))), 
			CAST(IF(montato=0,0,articolo_preventivo.tempo_installazione) AS signed)) 
		AS "sconto",

		IF(show_price = 1, 
			CAST(iva AS decimal), 
			CAST(IF(montato=0,0,articolo_preventivo.tempo_installazione/60*articolo_preventivo.quantità) AS DECIMAL(11,2))) 
		AS "iva", 

		IF(show_price = 1, 
			CAST((
				(ROUND((prezzo-(if(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)+(IF(montato="0",0,((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100)))))
				*(IF(scontoriga=0 or scontoriga IS NULL OR scontoriga="",1, (100-scontoriga)/100))) AS DECIMAL(11,2))*quantità, 
			articolo_preventivo.quantità*articolo_preventivo.costo)
		AS "tot", 

		CONCAT(percorso, "temp.bmp") AS "foto", 

		IF(mounted = 0, 
			"", 
			IF(montato="1" AND prezzo>0 AND id_articolo IS NOT NULL,"!! N.B. IL PREZZO DELL''ARTICOLO E'' COMPRESIVO DI INSTALLAZIONE E COLLAUDO", IF(id_articolo IS NOT NULL, "!! N.B. IL PREZZO DELL''ARTICOLO E'' PER SOLA FORNITURA",""))) 
		AS "mont",

		(ROUND(((ROUND((prezzo-(IF(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)+(IF(montato="0",0,((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100))))))*scontoriga/100,2)*quantità) AS "totscont", 
		
		marca.nome AS "marca",
      	articolo_preventivo.foto AS "foto2"

    FROM articolo_preventivo 
		LEFT JOIN articolo ON id_articolo=codice_articolo 
		JOIN configurazione_percorsi ON tipo_percorso="temp"   
    	LEFT JOIN marca ON id_marca=marca 
		LEFT JOIN preventivo_lotto 
			ON preventivo_lotto.id_preventivo=articolo_preventivo.id_preventivo 
			AND preventivo_lotto.anno=articolo_preventivo.anno 
			AND preventivo_lotto.posizione=articolo_preventivo.lotto  
			AND preventivo_lotto.id_revisione= quote_rev_id 
		LEFT JOIN Lotto 
			ON lotto.Id_lotto = preventivo_lotto.id_lotto
	WHERE articolo_preventivo.id_preventivo = quote_id 
    	AND articolo_preventivo.anno = quote_year
		AND articolo_preventivo.id_revisione =  quote_rev_id 
	ORDER BY articolo_preventivo.lotto, id_tab; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printQuoteBodyTotals
DELIMITER //
CREATE PROCEDURE `sp_printQuoteBodyTotals`(
	IN quote_id INT(11), 
	IN quote_year INT(11),
	IN quote_rev_id INT(11), 
	IN product_code_type SMALLINT, 
	IN show_price BIT(1)
)
BEGIN

	DECLARE decription_type INT(11);
	DECLARE discount_zero INT(11);
	DECLARE mounted INT(11); 

	SELECT valore
		INTO decription_type
	FROM preventivo_impost 
	WHERE tipo="desc";

	SELECT valore
		INTO discount_zero
	FROM preventivo_impost 
	WHERE tipo="sconto_0";

	SELECT valore
		INTO mounted
	FROM preventivo_impost 
	WHERE tipo="stampa_imoco";


	SELECT 
		articolo_preventivo.Id_preventivo,
		articolo_preventivo.Anno,
		articolo_preventivo.Id_revisione, 
		articolo_preventivo.Lotto,
		lotto.Nome AS nome_lotto,

		SUM(IF(show_price = 1, 
			IF(scontoriga>=0,(ROUND((prezzo-(IF(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)+(IF(montato="0",0,((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100))))),(ROUND((prezzo-(if(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)*1+(IF(montato="0",0,1*((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100))))) - ((ROUND(round((prezzo-(if(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)*scontoriga/100,2)*1)+((IF(montato="0",0,1*((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100)))))*scontoriga/100)),
			articolo_preventivo.costo))
		AS "prezzo", 

		SUM(IF(show_price = 1, 
			CAST((
				(ROUND((prezzo-(if(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)+(IF(montato="0",0,((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100)))))
				*(IF(scontoriga=0 or scontoriga IS NULL OR scontoriga="",1, (100-scontoriga)/100))) AS DECIMAL(11,2))*quantità, 
			articolo_preventivo.quantità*articolo_preventivo.costo))
		AS "tot", 
		SUM((ROUND(((ROUND((prezzo-(IF(preventivo_lotto.tipo_ricar=1,0,sconto)/100*prezzo)),2)+(IF(montato="0",0,((articolo_preventivo.tempo_installazione/60*prezzo_h) - ((articolo_preventivo.tempo_installazione/60*prezzo_h)*scontolav/100))))))*scontoriga/100,2)*quantità)) AS "totscont"
	
    FROM articolo_preventivo 
		LEFT JOIN articolo ON id_articolo=codice_articolo 
		LEFT JOIN preventivo_lotto 
			ON preventivo_lotto.id_preventivo=articolo_preventivo.id_preventivo 
			AND preventivo_lotto.anno=articolo_preventivo.anno 
			AND preventivo_lotto.posizione=articolo_preventivo.lotto  
			AND preventivo_lotto.id_revisione= quote_rev_id 
		LEFT JOIN Lotto 
			ON lotto.Id_lotto = preventivo_lotto.id_lotto
	WHERE articolo_preventivo.id_preventivo = quote_id 
    	AND articolo_preventivo.anno = quote_year
		AND articolo_preventivo.id_revisione =  quote_rev_id
	GROUP BY articolo_preventivo.lotto
	ORDER BY articolo_preventivo.lotto; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printQuoteClauses
DELIMITER //
CREATE PROCEDURE `sp_printQuoteClauses`(
	IN quote_id INT(11), 
	IN quote_year INT(11),
	IN quote_rev_id INT(11)
)
BEGIN

	DECLARE quote_date DATE; 
	DECLARE quote_type INT(11); 
	
	DECLARE payment_condition INT(11);
	DECLARE payment_condition_str VARCHAR(50); 
	
	DECLARE company_name VARCHAR(150); 
	DECLARE company_holder VARCHAR(150);
	
	DECLARE extra_hour_price VARCHAR(50); 
	DECLARE hour_price VARCHAR(50);  
	
	-- extract payment condition
	SELECT condizione_pagamento, revisione_preventivo.data 
		INTO payment_condition, quote_date
	FROM revisione_preventivo
		INNER JOIN clienti ON clienti.Id_cliente = revisione_preventivo.id_cliente 
	WHERE revisione_preventivo.Id_preventivo = quote_id 
		AND revisione_preventivo.Anno = quote_year 
		AND revisione_preventivo.Id_revisione = quote_rev_id; 

  IF payment_condition IS NOT NULL then
  	SELECT nome INTO payment_condition_str 
  	FROM condizione_pagamento
  	WHERE id_condizione = payment_condition; 
  ELSE
	 SELECT valore INTO payment_condition_str 
	 FROM preventivo_impost 
	 WHERE tipo = "cond_def";
  END IF;
  
  
	SELECT tipo 
		INTO quote_type
	FROM preventivo 
	WHERE Id_preventivo = quote_id 
		AND Anno = quote_year; 
	
	-- exctract company info
	SELECT ragione_sociale 
	 INTO company_name 
	FROM azienda 
	WHERE azienda.data <= quote_date
	ORDER BY azienda.data desc 
	LIMIT 1; 
	
	SELECT operaio.Ragione_sociale
		INTO company_holder
	FROM operaio 
		INNER JOIN azienda_inizio
		ON operaio.Id_operaio = azienda_inizio.titolare;
		
	-- extract subscription info
	SELECT 
		CONCAT(ROUND(ora_straordinaria,2), ""), 
		CONCAT(ROUND(ora_normale,2) , "")
	INTO 
		extra_hour_price, 
		hour_price	
	FROM revisione_preventivo 
		LEFT JOIN abbonamento ON id_abbonamento=tariffa 
	WHERE revisione_preventivo.id_preventivo = quote_id 
		AND revisione_preventivo.anno = quote_year
      AND id_revisione = quote_rev_id;
   
   
   IF extra_hour_price IS NULL THEN
   	SET extra_hour_price = 'NESSUN ABBONAMENTO ASSOCIATO'; 
   END IF;
   
   IF hour_price IS NULL THEN
   	SET hour_price = 'NESSUN ABBONAMENTO ASSOCIATO'; 
   END IF; 

	SELECT titolo,
		REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(testo, 
		"%azienda",  IFNULL(company_name,"")),
		"%titolare", IFNULL(company_holder, "")),
		"%annop", IFNULL(quote_year, "")), 
		"%condi", IFNULL(payment_condition_str, "")),
		"%prezzo_eco",IFNULL(extra_hour_price, "")), 
		"%prezzo_norm", IFNULL(hour_price, ""))	
	AS testo, 
	Id_tipo
   FROM preventivo_fine 
	WHERE id_tipo = 1 AND tipo_preventivo = quote_type
	ORDER BY posizione; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printQuoteHeader
DELIMITER //
CREATE PROCEDURE `sp_printQuoteHeader`(
	IN quote_id INT(11), 
	IN quote_year INT(11),
	IN quote_rev_id INT(11)
)
BEGIN

	DECLARE supp INT(11);

	SELECT valore
		INTO supp
	FROM preventivo_impost 
	WHERE tipo="tip_REP";


	SELECT
		IFNULL(rcl.titolo, "Spett.le") as titolo_cliente,
		cl.codice_fiscale, 
		condizione_pagamento,
		ragione_sociale2, 
		cl.partita_iva,
		CONCAT(LPAD(p.id_preventivo, 4, "0"), CONCAT(" rev. ", quote_rev_id)) AS id_fattura,
		data, 
		rp.id_cliente, 
		cl.ragione_sociale,
		CONCAT(c.cap, " - ", c.nome, " (", dcl.provincia, ")") AS "Provincia princ",
		CONCAT(
			IFNULL(CONCAT(dcl.indirizzo), ""),
			IFNULL(CONCAT(",", dcl.numero_civico), ""),
			IFNULL(CONCAT("/", NULLIF(dcl.altro, " ")), ""))
		AS "Indirizzo princ",
		
		IF(supp = 1, tp.nome, 'PREVENTIVO') AS "tipo_preve", 
		rcl.telefono, 
		rcl.fax, 
		rcl.mail,
		corpo, 
		corpo_rtf, 
		oggetto, 
		rcl2.fax,
		rcl2.altro_telefono,
		rcl2.telefono, 
		rcl2.mail,
		rcl.altro_telefono, 
		rcl2.titolo, 
		rcl2.nome,
		IFNULL(CONCAT(rcl2.titolo, " ", NULLIF(rcl2.nome, "")), " ") AS "titolo2", 
		sitoin,
		IFNULL(CONCAT("CORTESE ATTENZIONE ", NULLIF(cortese, "")), " ") AS "cortese", 
		nota
	FROM preventivo p
		LEFT JOIN revisione_preventivo rp ON p.id_preventivo = rp.id_preventivo
			AND p.anno = rp.anno
		LEFT JOIN tipo_preventivo tp ON tipo = id_tipo
		INNER JOIN clienti cl ON cl.id_cliente = rp.id_cliente
		INNER JOIN destinazione_cliente dcl ON dcl.id_cliente = rp.id_cliente
			AND dcl.id_destinazione = rp.destinazione
		LEFT JOIN comune c ON c.id_comune = dcl.comune
		LEFT JOIN riferimento_clienti rcl ON rcl.id_cliente = cl.id_cliente
			AND rcl.id_riferimento = "1"
		LEFT JOIN riferimento_clienti rcl2 ON rcl2.id_cliente = rp.id_cliente
			AND rp.id_riferimento = rcl2.id_riferimento
	WHERE p.id_preventivo = quote_id
		AND p.anno = quote_year
		AND id_revisione = quote_rev_id; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printQuoteListExport
DELIMITER //
CREATE PROCEDURE `sp_printQuoteListExport`(
	IN start_date DATE,
	IN end_date DATE,
	IN customer_id INT
)
BEGIN
	SELECT
		preventivo.id_preventivo AS 'ID',
		preventivo.anno AS 'Anno',
		preventivo.revisione AS 'Revisione',
		preventivo.data_creazione AS 'Data',
		clienti.Ragione_Sociale AS 'Cliente',
		Stato_clienti.Nome AS "Stato Cliente",
		tipo_rapclie.Nome AS "Rapporto Cliente",
		tipo_preventivo.nome AS 'Tipo',
		stato_preventivo.nome AS 'Stato',
		tipo_intprev.nome AS 'Tipo Intervento',
		preventivo.note AS 'Descrizione',
		IF(stampato, 'SI', 'NO') AS 'Stampato',
		IF(inviato, 'SI', 'NO') AS 'Inviato',
		IFNULL(data_invio, '') AS 'Data Invio',
		SUM(
			IFNULL(CAST(
				(
					costo
					+
					IF(montato = 0, 0, (b.tempo_installazione/60*prezzo_h))
				) AS DECIMAL(11,2)
			) * quantità
			, 0)
		) AS "Costo",
		SUM(
			IFNULL(CAST(
				(
					ROUND(prezzo - (IF(preventivo_lotto.tipo_ricar=1,0,sconto) / 100 * prezzo),2)
					+
					IF(montato = 0, 0, (b.tempo_installazione/60*prezzo_h) * ((100 - scontolav)/100))
				) * ((100 - IFNULL(scontoriga, 0))/100) AS DECIMAL(11,2)
			) * quantità
			, 0)
		) AS "Prezzo",
		CONCAT(CONCAT(dc.indirizzo,' n.',dc.numero_civico, dc.altro),' - ',concat(IF(f.nome IS NOT NULL AND f.nome <> '', concat(f.nome,' di '), ''), c.nome,' (',c.provincia,')')) AS 'Indirizzo',
		dc.Km_sede AS "KM Viaggio",
		dc.Tempo_strada AS "Tempo viaggio",
		IFNULL(riferimento_principale.mail, '') AS "Email Cliente",
		IFNULL(riferimento_principale.altro_telefono, "") AS "Telefono Cliente"
	FROM preventivo
		LEFT JOIN revisione_preventivo ON revisione=id_revisione AND preventivo.id_preventivo=revisione_preventivo.id_preventivo AND revisione_preventivo.anno=preventivo.anno
		LEFT JOIN clienti ON clienti.id_cliente=revisione_preventivo.id_cliente
		LEFT JOIN destinazione_cliente dc ON dc.id_cliente=revisione_preventivo.id_cliente AND dc.id_destinazione=revisione_preventivo.destinazione
		LEFT JOIN stato_clienti ON clienti.Stato_cliente = stato_clienti.Id_stato
		LEFT JOIN tipo_rapclie ON tipo_rapclie.id_tipo = clienti.tipo_rapporto
		LEFT JOIN comune AS c ON c.id_comune=dc.Comune
		LEFT JOIN frazione AS f ON f.id_frazione=dc.frazione
		LEFT JOIN riferimento_clienti AS riferimento_principale ON riferimento_principale.id_cliente=clienti.id_cliente AND riferimento_principale.id_riferimento = 1
		LEFT JOIN articolo_preventivo AS b ON preventivo.id_preventivo=b.id_preventivo AND preventivo.anno=b.anno AND b.id_revisione=revisione 
		LEFT JOIN preventivo_lotto ON preventivo_lotto.id_preventivo=revisione_preventivo.id_preventivo AND revisione_preventivo.anno=preventivo_lotto.anno AND revisione_preventivo.id_revisione=preventivo_lotto.id_revisione AND preventivo_lotto.posizione=b.lotto  
		INNER JOIN stato_preventivo ON preventivo.stato = stato_preventivo.id_stato
		INNER JOIN tipo_preventivo ON preventivo.tipo = tipo_preventivo.id_tipo
		INNER JOIN tipo_intprev ON preventivo.tipo = tipo_intprev.id_tipo
	WHERE 
		preventivo.data_creazione >= iFNULL(start_date, CAST('1970-01-01' AS DATE)) 
		AND preventivo.data_creazione <= iFNULL(end_date, CAST('2100-01-01' AS DATE))
		AND revisione_preventivo.id_cliente = iFNULL(customer_id, revisione_preventivo.id_cliente)
	GROUP BY preventivo.anno, preventivo.id_preventivo 
	ORDER BY preventivo.data_creazione DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printQuotePrivacy
DELIMITER //
CREATE PROCEDURE `sp_printQuotePrivacy`(
	IN quote_id INT(11), 
	IN quote_year INT(11),
	IN quote_rev_id INT(11)
)
BEGIN

	DECLARE quote_date DATE; 
	DECLARE quote_type INT(11); 
	
	DECLARE payment_condition INT(11);
	DECLARE payment_condition_str VARCHAR(50); 
	
	DECLARE company_name VARCHAR(150); 
	DECLARE company_holder VARCHAR(150);
	
	DECLARE extra_hour_price VARCHAR(50); 
	DECLARE hour_price VARCHAR(50);  
	
	-- extract payment condition
	SELECT condizione_pagamento, revisione_preventivo.data 
		INTO payment_condition, quote_date
	FROM revisione_preventivo
		INNER JOIN clienti ON clienti.Id_cliente = revisione_preventivo.id_cliente 
	WHERE revisione_preventivo.Id_preventivo = quote_id 
		AND revisione_preventivo.Anno = quote_year 
		AND revisione_preventivo.Id_revisione = quote_rev_id; 

  IF payment_condition IS NOT NULL then
  	SELECT nome INTO payment_condition_str 
  	FROM condizione_pagamento
  	WHERE id_condizione = payment_condition; 
  ELSE
	 SELECT valore INTO payment_condition_str 
	 FROM preventivo_impost 
	 WHERE tipo = "cond_def";
  END IF;
  
  
	SELECT tipo 
		INTO quote_type
	FROM preventivo 
	WHERE Id_preventivo = quote_id 
		AND Anno = quote_year; 
	
	-- exctract company info
	SELECT ragione_sociale 
	 INTO company_name 
	FROM azienda 
	WHERE azienda.data <= quote_date
	ORDER BY azienda.data desc 
	LIMIT 1; 
	
	SELECT operaio.Ragione_sociale
		INTO company_holder
	FROM operaio 
		INNER JOIN azienda_inizio
		ON operaio.Id_operaio = azienda_inizio.titolare;
		
	-- extract subscription info
	SELECT 
		CONCAT(ROUND(ora_straordinaria,2), ""), 
		CONCAT(ROUND(ora_normale,2) , "")
	INTO 
		extra_hour_price, 
		hour_price	
	FROM revisione_preventivo 
		LEFT JOIN abbonamento ON id_abbonamento=tariffa 
	WHERE revisione_preventivo.id_preventivo = quote_id 
		AND revisione_preventivo.anno = quote_year
      AND id_revisione = quote_rev_id;
   
   
   IF extra_hour_price IS NULL THEN
   	SET extra_hour_price = 'NESSUN ABBONAMENTO ASSOCIATO'; 
   END IF;
   
   IF hour_price IS NULL THEN
   	SET hour_price = 'NESSUN ABBONAMENTO ASSOCIATO'; 
   END IF; 

	SELECT titolo,
		REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(testo, 
		"%azienda",  IFNULL(company_name,"")),
		"%titolare", IFNULL(company_holder, "")),
		"%annop", IFNULL(quote_year, "")), 
		"%condi", IFNULL(payment_condition_str, "")),
		"%prezzo_eco",IFNULL(extra_hour_price, "")), 
		"%prezzo_norm", IFNULL(hour_price, ""))	
	AS testo, 
	Id_tipo
   FROM preventivo_fine 
	WHERE id_tipo = 2 AND tipo_preventivo = quote_type
	ORDER BY posizione; 

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printReportAttachments
DELIMITER //
CREATE PROCEDURE `sp_printReportAttachments`(
	IN `report_id` INT(11),
	IN `report_year` INT(11)
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE prev_file_name VARCHAR(500) DEFAULT NULL;
	DECLARE prev_file_path VARCHAR(500) DEFAULT NULL;
	DECLARE row_file_name VARCHAR(500) DEFAULT NULL;
	DECLARE row_file_path VARCHAR(500) DEFAULT NULL;

	DECLARE V_curA CURSOR FOR
		SELECT file_path,
			file_name
		FROM rapporto_allegati
		WHERE (file_name LIKE '%.jpg' OR file_name LIKE '%.bmp' OR file_name LIKE '%.jpeg')
			AND id_rapporto = report_id AND anno_rapporto = report_year;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;


	
	DROP TEMPORARY TABLE IF EXISTS report_attachments_for_print;
	CREATE TEMPORARY TABLE report_attachments_for_print (
		`id_rapporto` BIGINT(20) NOT NULL,
		`anno_rapporto` INT(11) NOT NULL,
		`file_name_primo` VARCHAR(250) NOT NULL,
		`file_path_primo` VARCHAR(500) NOT NULL,
		`file_name_secondo` VARCHAR(250) NOT NULL,
		`file_path_secondo` VARCHAR(500) NOT NULL
	);


	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO row_file_path, row_file_name;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;

		IF prev_file_path IS NULL THEN
			SET prev_file_name = row_file_name;
			SET prev_file_path = row_file_path;
		ELSE
			INSERT INTO report_attachments_for_print VALUES (
				report_id,
				report_year,
				prev_file_name,
				prev_file_path,
				row_file_name,
				row_file_path
			);
			SET prev_file_path = NULL;
			SET prev_file_name = NULL;
		END IF;
	END LOOP;
	CLOSE V_curA;


	IF prev_file_path IS NOT NULL THEN
		INSERT INTO report_attachments_for_print VALUES (
			report_id,
			report_year,
			prev_file_name,
			prev_file_path,
			'',
			''
		);
	END IF;

   		
	SELECT *
	FROM report_attachments_for_print;
	   
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printReportDailyList
DELIMITER //
CREATE PROCEDURE `sp_printReportDailyList`(
	IN start_date DATE, 
	IN end_date DATE,
	IN employee_id INT(11)
)
BEGIN

	-- extract reports by filter
	DROP TABLE IF EXISTS tmp_print_report_daily_list;
	CREATE TEMPORARY TABLE tmp_print_report_daily_list
	SELECT 
		operaio.id_operaio,
		operaio.ragione_sociale, 
		rapporto_giornaliero.data_rapporto, 
		rapporto_giornaliero_tipo_attivita.nome,
		rapporto_giornaliero_tipo_attivita.id, 
		rapporto_giornaliero_attivita.descrizione_lavoro,
		rapporto_giornaliero_attivita.note as note_attivita, 
		CAST(TIME_FORMAT(`ora_inizio`, '%H:%i:00') AS TIME) AS ora_inizio,
		CAST(TIME_FORMAT(`ora_fine`, '%H:%i:00') AS TIME) AS ora_fine,
		rapporto_giornaliero.note, 
		TIME_TO_SEC(TIMEDIFF(rapporto_giornaliero_attivita.ora_fine, rapporto_giornaliero_attivita.ora_inizio)) as "totale_secondi", 
		CONCAT(operaio.id_operaio, '|', rapporto_giornaliero.data_rapporto) group_key
	FROM rapporto_giornaliero 
		INNER JOIN operaio 
			ON operaio.id_operaio = rapporto_giornaliero.id_operaio 
		INNER JOIN rapporto_giornaliero_attivita
			ON rapporto_giornaliero.id = rapporto_giornaliero_attivita.id_rapporto_giornaliero
		LEFT JOIN rapporto_giornaliero_tipo_attivita 
			ON rapporto_giornaliero_attivita.tipo_lavoro = rapporto_giornaliero_tipo_attivita.id
	WHERE 
		rapporto_giornaliero.data_rapporto >= start_date
		AND rapporto_giornaliero.data_rapporto <= end_date
	ORDER BY data_rapporto, rapporto_giornaliero_attivita.ora_inizio;
	 
	IF employee_id IS NOT NULL AND employee_id != 0 THEN
		DELETE FROM tmp_print_report_daily_list 
		WHERE id_operaio != employee_id; 
	END IF; 

	SELECT * 
	FROM tmp_print_report_daily_list; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printReportGroupListExport
DELIMITER //
CREATE PROCEDURE `sp_printReportGroupListExport`(
	IN start_date DATE,
	IN end_date DATE,
	IN customer_id INT
)
BEGIN
	SELECT
		resoconto.id_resoconto AS 'ID',
		resoconto.anno AS 'Anno',
		data AS 'Data',
		clienti.Ragione_Sociale AS 'Cliente',
		Stato_clienti.Nome AS "Stato Cliente",
		tipo_rapclie.Nome AS "Rapporto Cliente",
		tipo_resoconto.nome AS 'Tipo',
		stato_resoconto.nome AS 'Stato',
		resoconto.descrizione AS 'Descrizione',
		resoconto_totali.costo_totale AS 'Costo',
		resoconto_totali.prezzo_totale AS 'Prezzo',
		CONCAT(CONCAT(dc.indirizzo,' n.',dc.numero_civico, dc.altro),' - ',concat(IF(f.nome IS NOT NULL AND f.nome <> '', concat(f.nome,' di '), ''), c.nome,' (',c.provincia,')')) AS 'Indirizzo',
		dc.Km_sede AS "KM Viaggio",
		dc.Tempo_strada AS "Tempo viaggio",
		IFNULL(riferimento_principale.mail, '') AS "Email Cliente",
		IFNULL(riferimento_principale.altro_telefono, "") AS "Telefono Cliente"
	FROM resoconto
		INNER JOIN resoconto_totali ON resoconto.id_resoconto = resoconto_totali.id_resoconto AND resoconto.anno = resoconto_totali.anno
		INNER JOIN clienti ON clienti.id_cliente = resoconto.id_cliente
		INNER JOIN tipo_resoconto ON resoconto.tipo_resoconto = tipo_resoconto.id_tipo
		INNER JOIN stato_resoconto ON resoconto.stato = stato_resoconto.Id_stato
		INNER JOIN stato_clienti ON clienti.Stato_cliente = stato_clienti.Id_stato
		INNER JOIN destinazione_cliente AS dc ON dc.id_cliente = resoconto.id_cliente
			AND sede_principale = 1
		INNER JOIN tipo_rapclie ON tipo_rapclie.id_tipo = clienti.tipo_rapporto
		INNER JOIN comune AS c ON c.id_comune=dc.Comune
		LEFT JOIN frazione AS f ON f.id_frazione=dc.frazione
		LEFT JOIN riferimento_clienti AS rc ON rc.id_cliente=resoconto.id_cliente AND rc.Promemoria_cliente=1
		LEFT JOIN riferimento_clienti AS riferimento_principale ON riferimento_principale.id_cliente=resoconto.id_cliente AND riferimento_principale.id_riferimento = 1
	WHERE
		resoconto.data >= iFNULL(start_date, CAST('1970-01-01' AS DATE)) 
		AND resoconto.data <= iFNULL(end_date, CAST('2100-01-01' AS DATE))
		AND resoconto.id_cliente = iFNULL(customer_id, resoconto.id_cliente)
	GROUP BY resoconto.id_resoconto, resoconto.anno
	ORDER BY data DESC;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printReportOpenedTickets
DELIMITER //
CREATE PROCEDURE `sp_printReportOpenedTickets`(
	IN `system_id` INT(11)
)
BEGIN
	SELECT id_ticket,
		anno,
		stato_ticket,
		colore_stato_ticket,
		causale, urgenza,
		tipo_intervento,
		data_ticket,
		scadenza,
		descrizione,
		tempo_minuti
	FROM vw_ticket_details
	WHERE stato_ticket_aperto = 1 AND id_impianto = system_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printReportsListBody
DELIMITER //
CREATE PROCEDURE `sp_printReportsListBody`(
	IN start_date DATE, 
	IN end_date DATE, 
	IN employee_id INT(11), 
	IN customer_id INT(11), 
	IN system_id INT(11)
)
BEGIN

	DROP TABLE IF EXISTS tmp_reportsList;

	CREATE TEMPORARY TABLE tmp_reportsList
	SELECT 
		rapporto.id_rapporto,
		rapporto.anno, 
		rapporto.id_cliente, 
		rapporto.Id_Impianto,
		rapporto_tecnico.Tecnico as Id_operaio		
	FROM rapporto 
		LEFT JOIN rapporto_tecnico
			ON rapporto_tecnico.id_rapporto=rapporto.id_rapporto AND rapporto_tecnico.anno=rapporto.anno
	WHERE data_esecuzione >= start_date AND data_esecuzione <= end_date;

	IF employee_id IS NOT NULL AND employee_id > 0 THEN
		DELETE FROM tmp_reportsList
		WHERE id_operaio <> employee_id; 
	END IF; 

	IF customer_id IS NOT NULL AND customer_id > 0 THEN
		DELETE FROM tmp_reportsList
		WHERE id_cliente <> customer_id; 
	END IF; 

	IF system_id IS NOT NULL AND system_id > 0 THEN
		DELETE FROM tmp_reportsList
		WHERE id_impianto <> system_id; 
	END IF; 
 
	SELECT DISTINCT rapporto.numero AS "ID", 
		op.ragione_sociale AS "oper", 
		data_esecuzione AS "data", 
		a.ragione_sociale, 
		b.descrizione, 
		tipo_intervento.nome,
		rapporto.relazione,
		IFNULL(SUM(IFNULL(rapporto_tecnico_lavoro.totale,0)), 0) AS "Tempo_lavoro",
		Tempo_viaggio,
		IFNULL(SUM(IFNULL(rapporto_tecnico_lavoro.totale,0)), 0) + IFNULL(Tempo_viaggio, 0) AS "Tempo_totale"
	FROM tmp_reportsList AS tmp_reports 
		INNER jOIN Rapporto 
			ON Rapporto.Id_rapporto = tmp_reports.Id_Rapporto AND Rapporto.Anno = tmp_reports.Anno
		INNER JOIN tipo_intervento ON id_tipo=tipo_intervento 
		INNER JOIN clienti AS a ON a.id_cliente=rapporto.id_cliente 
		LEFT JOIN impianto AS b ON b.id_impianto=rapporto.id_impianto 
		LEFT JOIN stato_rapporto ON rapporto.stato = stato_rapporto.id_stato 
		LEFT JOIN rapporto_tecnico AS t 
			ON t.id_rapporto=rapporto.id_rapporto AND t.anno=rapporto.anno 
			AND tmp_reports.Id_operaio = t.Tecnico

		LEFT JOIN rapporto_tecnico_lavoro  
			ON rapporto_tecnico_lavoro.id_rapporto=rapporto.id_rapporto 
			AND rapporto_tecnico_lavoro.anno=rapporto.anno 
			AND tmp_reports.Id_operaio = rapporto_tecnico_lavoro.Tecnico

		INNER JOIN operaio AS op 
			ON op.id_operaio = tmp_reports.id_operaio 

	GROUP BY tmp_reports.id_rapporto, tmp_reports.anno, tmp_reports.Id_operaio
	ORDER BY  data_esecuzione DESC, a.ragione_sociale ASC;	

		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printReportsListByInvoiceBody
DELIMITER //
CREATE PROCEDURE `sp_printReportsListByInvoiceBody`(
	IN start_date DATE, 
	IN end_date DATE, 
	IN employee_id INT(11), 
	IN customer_id INT(11), 
	IN system_id INT(11),
	IN invoiced_status INT(11)
)
BEGIN

	DROP TABLE IF EXISTS tmp_reportsList;

	CREATE TEMPORARY TABLE tmp_reportsList
	SELECT 
		rapporto.id_rapporto,
		rapporto.anno, 
		rapporto.id_cliente, 
		rapporto.Id_Impianto,
		rapporto.stato,
		fattura,
		anno_fattura
	FROM rapporto 
	WHERE data_esecuzione >= start_date AND data_esecuzione <= end_date;

	IF employee_id IS NOT NULL AND employee_id > 0 THEN
		DELETE FROM tmp_reportsList
		WHERE id_operaio <> employee_id; 
	END IF; 

	IF customer_id IS NOT NULL AND customer_id > 0 THEN
		DELETE FROM tmp_reportsList
		WHERE id_cliente <> customer_id; 
	END IF; 

	IF system_id IS NOT NULL AND system_id > 0 THEN
		DELETE FROM tmp_reportsList
		WHERE id_impianto <> system_id; 
	END IF;
	
	IF invoiced_status IS NOT NULL AND invoiced_status = 2 THEN -- NON FATTURATI
		DELETE FROM tmp_reportsList
		WHERE stato IN (2, 6, 8, 11)
			OR (fattura IS NOT NULL OR (anno_fattura IS NOT NULL AND anno_fattura <> 0));
	END IF; 

	IF invoiced_status IS NOT NULL AND invoiced_status = 1 THEN -- FATTURATI
		DELETE FROM tmp_reportsList
		WHERE stato NOT IN (2, 6, 8, 11)
			AND (
				fattura IS NULL
				OR anno_fattura IS NULL
				OR anno_fattura = 0
			);
	END IF; 
	
	SELECT DISTINCT rapporto.numero AS "ID", 
		data_esecuzione AS "data", 
		a.ragione_sociale, 
		b.descrizione, 
		tipo_intervento.nome,
		rapporto.relazione,
		rapporto.fattura, 
		rapporto.anno_fattura, 
		stato_rapporto.Nome AS stato,
		IFNULL(SUM(IFNULL(rapporto_tecnico_lavoro.totale,0)), 0) AS "Tempo_lavoro",
		Tempo_viaggio,
		IFNULL(SUM(IFNULL(rapporto_tecnico_lavoro.totale,0)), 0) + IFNULL(Tempo_viaggio, 0) AS "Tempo_totale",
		rapporto.cost_lav,
		rapporto.prez_lav,
		IFNULL(rapporto.Costo, 0) - IFNULL(rapporto.cost_lav, 0) AS costo_materiale,
		IFNULL(rapporto.Totale, 0) - IFNULL(rapporto.prez_lav, 0) AS prezzo_materiale,
		rapporto.Costo,
		rapporto.Totale,
		DATE_FORMAT(data_esecuzione, '%m %Y') AS titolo_gruppo,
		DATE_FORMAT(data_esecuzione, '%Y-%m') AS id_gruppo,
		GROUP_CONCAT(CONCAT(rm.`quantità`, ' x ', rm.descrizione) SEPARATOR '|') AS Materiale
	FROM tmp_reportsList AS tmp_reports 
		INNER jOIN Rapporto 
			ON Rapporto.Id_rapporto = tmp_reports.Id_Rapporto AND Rapporto.Anno = tmp_reports.Anno
		INNER JOIN tipo_intervento ON id_tipo=tipo_intervento 
		INNER JOIN clienti AS a ON a.id_cliente=rapporto.id_cliente 
		LEFT JOIN impianto AS b ON b.id_impianto=rapporto.id_impianto 
		LEFT JOIN stato_rapporto ON rapporto.stato = stato_rapporto.id_stato 
		LEFT JOIN rapporto_tecnico AS t 
			ON t.id_rapporto=rapporto.id_rapporto AND t.anno=rapporto.anno 
		LEFT JOIN rapporto_tecnico_lavoro  
			ON rapporto_tecnico_lavoro.id_rapporto=rapporto.id_rapporto 
			AND rapporto_tecnico_lavoro.anno=rapporto.anno 
		LEFT JOIN rapporto_materiale rm ON rapporto.id_rapporto = rm.id_rapporto AND rapporto.Anno = rm.Anno
	GROUP BY tmp_reports.id_rapporto, tmp_reports.anno
	ORDER BY  data_esecuzione DESC, a.ragione_sociale ASC;	

		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printSoldProdutsList
DELIMITER //
CREATE PROCEDURE `sp_printSoldProdutsList`(
	IN `from_date` DATE,
	IN `to_date` DATE,
	IN `customer_id` INT(11)
)
BEGIN 

	SELECT id_materiale AS codice_articolo,
		articolo.Codice_fornitore,
		articolo.Desc_brev AS "descrizione",
		SUM(quantità) quantita,
		magazzino.giacenza as giacenza_magazzino,
		IF (fattura.anno = 0, 'PREFATTURA', 'FATTURA') AS tipo_entita,
		articolo_stato.Nome AS stato_articolo,
		marca.Nome as marca,
		categoria_merciologica.Nome as categoria_merciologica,
		sottocategoria.Nome as sottocategoria_merciologica,
		articolo.tempo_installazione as tempo_installazione,
		articolo.scadenza as scadenza_mesi,
		IFNULL(listino_prezzo.Prezzo, 0) AS prezzo_listino,
		IFNULL(listino_costo.Prezzo, 0) AS costo_listino
	FROM fattura_articoli
		INNER JOIN fattura ON fattura.id_fattura = fattura_articoli.id_fattura AND fattura.anno = fattura_articoli.anno
		INNER JOIN magazzino ON tipo_magazzino = 1 AND id_articolo = id_materiale
		INNER JOIN articolo ON articolo.Codice_articolo = id_materiale
		INNER JOIN articolo_stato ON articolo.Stato_articolo = articolo_stato.Id_stato
		LEFT JOIN marca ON articolo.Marca = marca.Id_marca
		LEFT JOIN categoria_merciologica ON categoria_merciologica.Id_categoria = articolo.categoria
		LEFT JOIN sottocategoria ON sottocategoria.Id_sottocategoria = articolo.sottocategoria AND sottocategoria.Id_categoria = articolo.categoria
		LEFT JOIN articolo_listino AS listino_prezzo ON listino_prezzo.Id_articolo = articolo.Codice_articolo AND listino_prezzo.id_listino = fnc_productInternalPriceId()
		LEFT JOIN articolo_listino AS listino_costo ON listino_costo.Id_articolo = articolo.Codice_articolo AND listino_costo.id_listino = fnc_productInternalCostId()
	WHERE id_materiale IS NOT NULL AND fattura.data BETWEEN from_date AND to_date AND IFNULL(customer_id, fattura.id_cliente) = id_cliente
	GROUP BY id_materiale, fattura.anno = 0

	UNION ALL
	SELECT articoli_ddt.id_articolo,
		articolo.Codice_fornitore,
		desc_breve,
		SUM(quantità),
		magazzino.giacenza as giacenza_magazzino,
		'DDT',
		articolo_stato.Nome AS stato_articolo,
		marca.Nome as marca,
		categoria_merciologica.Nome as categoria_merciologica,
		sottocategoria.Nome as sottocategoria_merciologica,
		articolo.tempo_installazione as tempo_installazione,
		articolo.scadenza as scadenza_mesi,
		IFNULL(listino_prezzo.Prezzo, 0) AS prezzo_listino,
		IFNULL(listino_costo.Prezzo, 0) AS costo_listino
	FROM articoli_ddt
		INNER JOIN ddt ON ddt.Id_ddt = articoli_ddt.id_ddt AND ddt.anno = articoli_ddt.anno AND ddt.Fattura IS NULL
		INNER JOIN magazzino ON tipo_magazzino = 1 AND magazzino.id_articolo = articoli_ddt.id_articolo
		INNER JOIN articolo ON articolo.Codice_articolo = articoli_ddt.id_articolo
		INNER JOIN articolo_stato ON articolo.Stato_articolo = articolo_stato.Id_stato
		LEFT JOIN marca ON articolo.Marca = marca.Id_marca
		LEFT JOIN categoria_merciologica ON categoria_merciologica.Id_categoria = articolo.categoria
		LEFT JOIN sottocategoria ON sottocategoria.Id_sottocategoria = articolo.sottocategoria AND sottocategoria.Id_categoria = articolo.categoria
		LEFT JOIN articolo_listino AS listino_prezzo ON listino_prezzo.Id_articolo = articolo.Codice_articolo AND listino_prezzo.id_listino = fnc_productInternalPriceId()
		LEFT JOIN articolo_listino AS listino_costo ON listino_costo.Id_articolo = articolo.Codice_articolo AND listino_costo.id_listino = fnc_productInternalCostId()
	WHERE articoli_ddt.id_articolo IS NOT NULL AND ddt.data_documento BETWEEN from_date AND to_date AND IFNULL(customer_id, ddt.id_cliente) = id_cliente
	GROUP BY id_articolo
	ORDER BY codice_articolo;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printSupplierInvoices
DELIMITER //
CREATE PROCEDURE `sp_printSupplierInvoices`(
	IN `supplier_id` INT(11),
	IN `from_date` DATE,
	IN `to_date` DATE
)
BEGIN

	SELECT fornfattura.id_fattura AS 'rif_prot',
		fornfattura.fattura_fornitore AS 'id_fattura',
		fornfattura.anno AS 'anno',
		fornitore.Id_fornitore AS 'Id_fornitore',
		fornitore.ragione_sociale AS 'ragione_sociale',
		a.nome AS 'nome_condizione_pagamento',
		a.tipo AS 'id_tipo_pagamento',
		tipo_pagamento.nome AS 'nome_tipo_pagamento',
		fornfattura.data AS 'data_documento',
		tipo_attivita.nome AS 'attivita_fornitore',
		tipo_iva_BTI.aliquota AS 'iva',
		( totale +(((trasporto/100)*(100+IFNULL(tipo_iva_BTI.aliquota, 0))) + ((bollo/100)*(100+if(iva_bollo=0,
		0,
		IFNULL(tipo_iva_BTI.aliquota, 0)))) + ((incasso/100)*(100+if(iva_incasso=0,
		0,
		IFNULL(tipo_iva_BTI.aliquota, 0)))) )) AS 'totale_imponibile',
		(totiva +(((trasporto/100)*(100+IFNULL(tipo_iva_BTI.aliquota, 0))) + ((bollo/100)*(100+if(iva_bollo=0,
		0,
		IFNULL(tipo_iva_BTI.aliquota, 0)))) + ((incasso/100)*(100+if(iva_incasso=0,
		0,
		IFNULL(tipo_iva_BTI.aliquota, 0)))) )) AS 'totale_ivato'
	FROM fornfattura
		INNER JOIN condizione_pagamento AS a
		      ON cond_pagamento = a.id_condizione
		LEFT JOIN condizioni_giorno AS g 
		      ON g.id_condizione = a.id_condizione 
		INNER JOIN fornitore
		      ON fornfattura.id_fornitore=fornitore.id_fornitore
		LEFT JOIN tipo_attivita
			  ON fornfattura.id_attività = tipo_attivita.id_tipo
		LEFT JOIN tipo_pagamento
		      ON a.tipo=tipo_pagamento.id_tipo
		LEFT JOIN Tipo_iva AS tipo_iva_BTI
				ON tipo_iva_BTI.id_iva = aliquota_iva_BTI
	WHERE (fornfattura.`data` BETWEEN from_date AND to_date) AND fornitore.id_fornitore = IF(supplier_id > 0, supplier_id, fornitore.id_fornitore)
	GROUP BY fornfattura.id_fattura, fornfattura.anno 
	ORDER BY nome_condizione_pagamento, fornfattura.data;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printSystemsComponents
DELIMITER //
CREATE PROCEDURE `sp_printSystemsComponents`()
BEGIN
	SELECT 
		vw_systems_components_detail.id_impianto AS "ID Impianto",
		impianto.id_cliente AS "ID Cliente",
		clienti.Ragione_Sociale AS "Cliente",
		Stato_clienti.Nome AS "Stato Cliente",
		tipo_rapclie.Nome AS "Rapporto Cliente",
		impianto.Descrizione AS "Impianto",
		Tipo_impianto.nome AS "Tipo Impianto",
		stato_impianto.Nome AS "Stato Impianto",
		abbonamento.Nome AS "Abbonamento",
		impianto.Costo_Manutenzione AS "Costo Manutenzione",
		CONCAT(CONCAT(d2.indirizzo,' n.',d2.numero_civico, d2.altro),' - ',concat(IF(f2.nome IS NOT NULL AND f2.nome <> '', concat(f2.nome,' di '), ''), c2.nome,' (',c2.provincia,')')) AS 'Destinazione Impianto',
		d2.Km_sede AS "KM Destinazione Impianto",
		ordine AS "Ordine",
		vw_systems_components_detail.id_articolo AS "ID Articolo",
		articolo.codice_fornitore AS "Codice Fornitore",
		articolo.Desc_brev AS "Articolo",
		articolo_stato.nome AS "Stato Articolo",
		listino_costo.prezzo AS "Costo Interno",
		listino_prezzo.prezzo AS "Prezzo Interno",
		stato_scadenza AS "Stato Scadenza",
		fine_garanzia AS "Fine Garanzia",
		data_installazione AS "Data Installazione",
		data_dismesso AS "Data Dismesso",
		data_scadenza AS "Data Scadenza",
		mail AS "Email",
		telefono AS "Telefono",
		altro_telefono AS "Cellulare"
	FROM vw_systems_components_detail
		INNER JOIN impianto ON vw_systems_components_detail.id_impianto = impianto.Id_impianto
		INNER JOIN stato_impianto ON impianto.Stato = stato_impianto.Id_stato
		INNER JOIN tipo_impianto ON impianto.Tipo_impianto = tipo_impianto.Id_tipo
		LEFT JOIN abbonamento ON impianto.Abbonamento = abbonamento.Id_abbonamento
		INNER JOIN articolo ON articolo.Codice_articolo = vw_systems_components_detail.id_articolo
		INNER JOIN articolo_stato ON articolo.Stato_articolo = articolo_stato.Id_stato
		INNER JOIN articolo_listino AS listino_prezzo ON listino_prezzo.id_articolo = vw_systems_components_detail.id_articolo AND listino_prezzo.id_listino = fnc_productInternalPriceId()
		INNER JOIN articolo_listino AS listino_costo ON listino_costo.id_articolo = vw_systems_components_detail.id_articolo AND listino_costo.id_listino = fnc_productInternalCostId()
		INNER JOIN clienti ON impianto.Id_cliente = clienti.Id_cliente
		INNER JOIN stato_clienti ON clienti.Stato_cliente = stato_clienti.Id_stato
		INNER JOIN tipo_rapclie ON tipo_rapclie.id_tipo = clienti.tipo_rapporto
		LEFT JOIN destinazione_cliente AS d2 ON d2.id_cliente=clienti.id_cliente AND d2.id_destinazione=impianto.destinazione
		INNER JOIN comune AS c2 ON c2.id_comune=d2.Comune
		LEFT JOIN frazione AS f2 ON f2.id_frazione=d2.frazione
		LEFT JOIN riferimento_clienti AS r1 ON r1.id_cliente=clienti.id_cliente AND id_riferimento='1';
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_printTicketGetBetweenExpirationDates
DELIMITER //
CREATE PROCEDURE `sp_printTicketGetBetweenExpirationDates`( 
	fromDate DATE,
	toDate DATE,
	includeWithoutDate BIT(1)
)
BEGIN
	SELECT *
	FROM vw_ticket_details
	WHERE id_stato_ticket IN (1, 2) AND (scadenza BETWEEN fromDate AND toDate 
		OR IF(includeWithoutDate,  scadenza IS NULL, False));
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_quoteAddToSubJob
DELIMITER //
CREATE PROCEDURE `sp_quoteAddToSubJob`(
	QuoteId INT, QuoteYear INT, QuoteRevision INT,
	JobId INT, JobYear INT, SubJobId INT
)
BEGIN
	DECLARE done INT DEFAULT 0;
	DECLARE V_lot_id INT;
	DECLARE V_curA CURSOR FOR SELECT posizione
		FROM preventivo_lotto
		WHERE id_preventivo = QuoteId 
			AND anno = QuoteYear 
			AND id_revisione = QuoteRevision;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

	INSERT INTO commessa_lotto(id_commessa, anno, id_sottocommessa, stato, descrizione, data_inizio, id_lotto, impianto, csora, prora, sc) 
	SELECT JobId, JobYear, SubJobId, 1, l.nome, CURRENT_DATE, posizione, id_impianto, ora_p, ora_c, scon 
	FROM preventivo_lotto pl
		INNER JOIN lotto l ON l.id_lotto = pl.id_lotto 
	WHERE pl.id_preventivo = QuoteId 
		AND pl.anno = QuoteYear 
		AND id_revisione = QuoteRevision;

	INSERT INTO commessa_articoli(preventivati, id_commessa, anno, id_sottocommessa, descrizione, id_lotto, quantità, codice_articolo, codice_fornitore, 
		um, id_tab, prezzo, tempo, costo_ora, costo, prezzo_ora, sconto, iva) 
	SELECT SUM(ap.quantità),
		JobId,
		JobYear,
		SubJobId,
		IFNULL(a.desc_brev, ap.desc_brev), 
		lotto,
		SUM(quantità),
		id_articolo,
		ap.codice_fornitore,
		ap.unità_misura,
		id_tab, 
		ROUND(prezzo-prezzo * IF(pl.tipo_ricar = 1, 0, sconto)/100, 2), IF(montato, ap.tempo_installazione, "0"), 
		costo_h, costo, (prezzo_h-prezzo_h * scontolav/100), scontoriga, iva 
	FROM articolo_preventivo ap
		LEFT JOIN articolo a ON id_articolo = codice_articolo 
		LEFT JOIN preventivo_lotto pl ON pl.posizione = ap.lotto 
			AND pl.anno = ap.anno 
			AND pl.id_revisione = ap.id_revisione 
			AND pl.id_preventivo = ap.id_preventivo 
	WHERE ap.id_preventivo = QuoteId 
		AND ap.anno = QuoteYear 
		AND ap.id_revisione = QuoteRevision 
		AND tipo IN("A", "AL") 
		AND id_articolo IS NOT NULL 
	GROUP BY id_articolo, lotto 
	UNION ALL 
	SELECT ap.quantità,
		JobId,
		JobYear,
		SubJobId,
		ap.desc_brev,
		lotto, 
		quantità, id_articolo, ap.codice_fornitore, ap.unità_misura, id_tab, 
		ROUND(prezzo-prezzo * IF(pl.tipo_ricar = 1, 0, sconto)/100, 2), IF(montato, ap.tempo_installazione, "0"), 
		costo_h, costo, (prezzo_h-prezzo_h * scontolav/100), scontoriga, iva 
	FROM articolo_preventivo ap 
		LEFT JOIN preventivo_lotto pl ON pl.posizione = ap.lotto 
			AND pl.anno = ap.anno 
			AND pl.id_revisione = ap.id_revisione 
			AND pl.id_preventivo = ap.id_preventivo 
	WHERE ap.id_preventivo = QuoteId 
		AND ap.anno = QuoteYear 
		AND ap.id_revisione = QuoteRevision 
		AND tipo IN("A", "AL") 
		AND id_articolo IS NULL
	HAVING id_tab IS NOT NULL; -- for some reason we get one row with all null result, this having is a workaround to avoid it

	OPEN V_curA;
	loopA: LOOP
		FETCH V_curA INTO V_lot_id;
		IF done = 1 THEN 
			LEAVE loopA;
		END IF;

		CALL sp_getQuoteTotals(QuoteId, QuoteYear, QuoteRevision, v_lot_id, @total_price_material, @total_cost_material, @total_profit_material, @total_price_work, @total_cost_work, @total_profit_work, @total_hours, @total_price, @total_cost, @total_profit, @total_sale);

		INSERT INTO commessa_preventivo(id_commessa, anno, id_sottocommessa,
			preventivo, anno_prev, rev, lotto, pidlotto,
			preventivo_prezzo_materiale,
			preventivo_costo_materiale,
			preventivo_prezzo_lavoro,
			preventivo_costo_lavoro,
			preventivo_totale_ore,
			preventivo_sconto
		) 
		SELECT JobId,
			JobYear,
			SubJobId,
			id_preventivo,
			anno,
			id_revisione,
			posizione AS "lotto_commessa",
			posizione AS "1otto_preventivo",
			@total_price_material,
			@total_cost_material,
			@total_price_work,
			@total_cost_work,
			@total_hours,
			@total_sale
		FROM preventivo_lotto pl
		WHERE id_preventivo = QuoteId 
			AND anno = QuoteYear 
			AND id_revisione = QuoteRevision
			AND posizione = V_lot_id;

	END LOOP;
	CLOSE V_curA;

	UPDATE preventivo SET 
		stato = 7 
	WHERE anno = QuoteYear 
		AND id_preventivo = QuoteId;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_quoteAssociateToJob
DELIMITER //
CREATE PROCEDURE `sp_quoteAssociateToJob`(
	QuoteId INT, QuoteYear INT, QuoteRevision INT,
	JobId INT, JobYear INT, OUT SubJobId INT
)
BEGIN
	SELECT IFNULL(MAX(id_sotto), 0) + 1
			INTO SubJobId
	FROM commessa_sotto
	WHERE id_commessa = JobId AND anno = JobYear;

		
	INSERT INTO commessa_sotto(id_commessa, anno, id_sotto, stato, nome, destinazione, inizio) 
	SELECT JobId, JobYear, SubJobId, 1, CONCAT("SOTTOCOMMESSA PREVENTIVO ", QuoteId, "/", QuoteYear), destinazione, CURRENT_DATE 
	FROM preventivo p
		LEFT JOIN revisione_preventivo rp ON p.id_preventivo = rp.id_preventivo
			AND p.anno = rp.anno 
			AND p.revisione = rp.id_revisione 
	WHERE p.id_preventivo = QuoteId
		AND p.anno = QuoteYear;


	CALL sp_quoteAddToSubJob(QuoteId, QuoteYear, 
		QuoteRevision, JobId, JobYear, SubJobId);	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_quoteCreateJob
DELIMITER //
CREATE PROCEDURE `sp_quoteCreateJob`(
	QuoteId INT, QuoteYear INT, QuoteRevision INT,
	OUT JobId INT, OUT JobYear INT
)
BEGIN
	DECLARE CurrentYear INT DEFAULT YEAR(CURRENT_DATE);
	
	SET JobYear = CurrentYear;
	
	SELECT IFNULL(MAX(id_commessa), 0) + 1
	INTO JobId
	FROM commessa 
	WHERE anno = CurrentYear;

	INSERT INTO commessa(id_utente, id_commessa, anno, id_cliente, data_inizio, stato_commessa, tipo_commessa, descrizione, Data_ins, Utente_ins) 
	SELECT @USER_ID, JobId, JobYear, rp.id_cliente, CURRENT_DATE, 1, 1, note, NOW(), @USER_ID
	FROM preventivo p
		LEFT JOIN revisione_preventivo rp ON p.id_preventivo = rp.id_preventivo 
			AND rp.anno = p.anno 
			AND rp.id_revisione = p.revisione 
	WHERE p.id_preventivo = QuoteId 
		AND p.anno = QuoteYear;
		
	INSERT INTO commessa_sotto(id_commessa, anno, id_sotto, stato, nome, destinazione, inizio) 
	SELECT JobId, JobYear, 1, 1, "SOTTOCOMMESSA PRINCIPALE", destinazione, CURRENT_DATE 
	FROM preventivo p
		LEFT JOIN revisione_preventivo rp ON p.id_preventivo = rp.id_preventivo
			AND p.anno = rp.anno 
			AND p.revisione = rp.id_revisione 
	WHERE p.id_preventivo = QuoteId
		AND p.anno = QuoteYear;

	CALL sp_quoteAddToSubJob(QuoteId, QuoteYear, 
		QuoteRevision, JobId, JobYear, 1);
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_searchCustomersLight
DELIMITER //
CREATE PROCEDURE `sp_searchCustomersLight`(
	IN `company_name` VARCHAR(100),
	IN `customer_id` INT(11)
)
BEGIN
	
	SELECT 
		clienti.id_cliente, 
		ragione_sociale, 
		a.provincia, 
		stato_cliente AS "Stato", 
		CONCAT(comune.nome," ", indirizzo) AS indirizzo, 
		CONCAT(comune.nome," (", a.provincia,")") AS "comune", 
		CONCAT(indirizzo,", ", numero_civico) AS "indirizzo2"    
	FROM clienti 
		LEFT JOIN destinazione_cliente AS a ON a.id_cliente=clienti.id_cliente	AND a.attivo="1"  AND a.sede_principale="1" 
		LEFT JOIN comune ON comune.id_comune=comune  
	WHERE (ragione_sociale LIKE CONCAT('%', company_name, '%') or (clienti.id_cliente = IFNULL(customer_id, -1)))   
	GROUP BY clienti.id_cliente  
	ORDER BY ragione_sociale LIKE CONCAT(company_name, '%') desc, ragione_sociale   
	LIMIT 200;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_searchDepotsTotals
DELIMITER //
CREATE PROCEDURE `sp_searchDepotsTotals`(
	IN `allow_disabled` BIT(1),
	IN allow_zero_stock BIT(1)
)
BEGIN 
	SELECT tipo_magazzino.*,
		IFNULL(SUM(giacenza), 0) AS totale_articoli,
		IFNULL(SUM(prezzo*giacenza), 0) AS totale
	FROM tipo_magazzino
		LEFT JOIN magazzino ON id_tipo=tipo_Magazzino
		INNER JOIN articolo_listino ON id_listino=1 AND magazzino.id_articolo=articolo_listino.id_articolo
	WHERE IF(allow_disabled, TRUE, tipo_Magazzino.disabilitato = 0)
	GROUP BY id_tipo
	HAVING IF(allow_zero_stock, TRUE, totale_articoli <> 0)
	ORDER BY prior desc;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_searchInvoicesLight
DELIMITER //
CREATE PROCEDURE `sp_searchInvoicesLight`(
	IN `search_text` TEXT,
	IN customer_id INT(11)
)
BEGIN
	
	SELECT 
		fattura.id_fattura, 
		fattura.anno,
		ragione_sociale,
		fattura.nota_interna as Descrizione, 
		fattura.Stato AS "Stato",
		stato_fattura.colore,
		fattura.data AS "data"
	FROM fattura
		INNER JOIN clienti ON clienti.id_cliente = fattura.id_cliente
		INNER JOIN stato_fattura ON stato_fattura.id_stato = fattura.stato
	WHERE (ragione_sociale LIKE CONCAT('%', search_text, '%') 
		OR fattura.id_fattura LIKE CONCAT('%', search_text, '%')
		OR fattura.anno LIKE CONCAT('%', search_text, '%')
		OR fattura.nota_interna LIKE CONCAT('%', search_text, '%'))
		AND IF(customer_id = -1, True, fattura.id_cliente = customer_id)
	ORDER BY fattura.data desc, id_fattura desc 
	LIMIT 100;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_searchJobsLight
DELIMITER //
CREATE PROCEDURE `sp_searchJobsLight`(
	IN `search_text` TEXT,
	IN customer_id INT(11)
)
BEGIN
	
	SELECT DISTINCT
		commessa.id_commessa, 
		commessa.anno,
		commessa.codice_commessa,
		clienti.ragione_sociale,
		commessa.Descrizione, 
		commessa.stato_commessa,
		stato_commessa.colore,
		commessa.data_inizio
	FROM commessa
		INNER JOIN clienti ON clienti.id_cliente = commessa.id_cliente
		INNER JOIN stato_commessa ON stato_commessa.id_stato = commessa.stato_commessa
	WHERE (ragione_sociale LIKE CONCAT('%', search_text, '%') 
		OR commessa.id_commessa LIKE CONCAT('%', search_text, '%')
		OR commessa.anno LIKE CONCAT('%', search_text, '%')
		OR commessa.Descrizione LIKE CONCAT('%', search_text, '%'))
			AND IF(customer_id = -1, True, commessa.id_cliente = customer_id)
	ORDER BY commessa.anno desc, commessa.id_commessa
	LIMIT 100;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_searchPaymentConditionsLight
DELIMITER //
CREATE PROCEDURE `sp_searchPaymentConditionsLight`(
	IN `search_text` TEXT
)
BEGIN
	
	SELECT DISTINCT
		id_condizione,
		condizione_pagamento.nome,
		condizione_pagamento.descrizione,
		tipo_pagamento.nome as tipo_pagamento,
		modalitaPA,
		condizioniPA,
		temporanea
	FROM condizione_pagamento
		INNER JOIN tipo_pagamento ON condizione_pagamento.tipo = tipo_pagamento.id_tipo
	WHERE (condizione_pagamento.nome LIKE CONCAT('%', search_text, '%') 
		OR condizione_pagamento.descrizione LIKE CONCAT('%', search_text, '%')
		OR tipo_pagamento.nome LIKE CONCAT('%', search_text, '%')
		OR modalitaPA LIKE CONCAT('%', search_text, '%')
		OR condizioniPA LIKE CONCAT('%', search_text, '%'))
	ORDER BY nome
	LIMIT 100;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_searchQuotesLight
DELIMITER //
CREATE PROCEDURE `sp_searchQuotesLight`(
	IN `search_text` TEXT
)
BEGIN
	
	SELECT 
		preventivo.id_preventivo, 
		preventivo.anno,
		ragione_sociale,
		preventivo.Note as Descrizione, 
		preventivo.Stato AS "Stato",
		stato_preventivo.colore,
		revisione_preventivo.data AS "data"
	FROM preventivo 
		INNER JOIN revisione_preventivo
			ON revisione_preventivo.id_preventivo = preventivo.id_preventivo
			AND revisione_preventivo.anno = preventivo.anno
			AND revisione_preventivo.id_revisione = preventivo.revisione
		INNER JOIN clienti ON clienti.id_cliente = revisione_preventivo.id_cliente
		INNER JOIN stato_preventivo ON stato_preventivo.id_stato = preventivo.stato
	WHERE (ragione_sociale LIKE CONCAT('%', search_text, '%') 
		OR preventivo.id_preventivo LIKE CONCAT('%', search_text, '%')
		OR preventivo.anno LIKE CONCAT('%', search_text, '%')
		OR preventivo.Note LIKE CONCAT('%', search_text, '%'))
	ORDER BY stato_preventivo.prior desc, revisione_preventivo.data_creazione desc, id_preventivo desc 
	LIMIT 100;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_searchReportsLight
DELIMITER //
CREATE PROCEDURE `sp_searchReportsLight`(
	IN `search_text` TEXT,
	IN customer_id INT(11),
	IN has_customer_signature BIT(1)
)
BEGIN
	
	SELECT DISTINCT
		rapporto.id_rapporto, 
		rapporto.anno,
		rapporto.relazione,
		clienti.ragione_sociale, 
		rapporto.id_impianto,
		stato_rapporto.colore,
		rapporto.data_esecuzione,
		IFNULL(tipo_rapporto.nome, 'Cartaceo') AS tipo_rapporto,
		rapporto.responsabile,
		IF(rapporto.filename_firma_cliente IS NOT NULL, True, False)  AS firma_cliente
	FROM rapporto
		INNER JOIN clienti ON clienti.id_cliente = rapporto.id_cliente
		INNER JOIN stato_rapporto ON stato_rapporto.id_stato = rapporto.Stato
		INNER JOIN tipo_rapporto ON tipo_rapporto.id = rapporto.id_tipo_rapporto
	WHERE (ragione_sociale LIKE CONCAT('%', search_text, '%') 
			OR rapporto.id_rapporto LIKE CONCAT('%', search_text, '%')
			OR rapporto.anno LIKE CONCAT('%', search_text, '%')
			OR rapporto.relazione LIKE CONCAT('%', search_text, '%')
			OR rapporto.responsabile LIKE CONCAT('%', search_text, '%')
		)
		AND IF(customer_id = -1, True, rapporto.id_cliente = customer_id)
		AND IF(has_customer_signature IS NULL, True, has_customer_signature = IF(rapporto.filename_firma_cliente IS NOT NULL, True, False))
	ORDER BY rapporto.anno desc, rapporto.id_rapporto desc
	LIMIT 100;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_searchSystemsLight
DELIMITER //
CREATE PROCEDURE `sp_searchSystemsLight`(
	IN `search_text` VARCHAR(100),
	IN `system_id` INT(11),
	IN `customer_id` INT(11)
)
BEGIN
	SET customer_id = IFNULL(customer_id, -1);
	
	SELECT Id_impianto,
		impianto.Id_cliente,
		tipo_impianto.nome as Tipo_impianto,
		stato_impianto.nome as Stato_impianto,
		stato_impianto.colore as Stato_impianto_colore,
		impianto.Descrizione,
		CONCAT(comune.nome," ", indirizzo) AS indirizzo
	FROM impianto
		INNER JOIN tipo_impianto ON tipo_impianto = id_tipo
		INNER JOIN stato_impianto ON Stato = id_stato
		LEFT JOIN destinazione_cliente AS a ON a.id_cliente=impianto.id_cliente	AND a.id_destinazione = impianto.destinazione
		LEFT JOIN comune ON comune.id_comune=comune
	WHERE (impianto.descrizione LIKE CONCAT('%', search_text, '%') or (impianto.id_impianto = IFNULL(system_id, -1)))
		AND customer_id = IF(customer_id = -1, -1, impianto.id_cliente) 
	GROUP BY impianto.id_impianto  
	ORDER BY impianto.Descrizione LIKE CONCAT(search_text, '%') desc, impianto.descrizione   
	LIMIT 200;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverBackupSettingsGet
DELIMITER //
CREATE PROCEDURE `sp_serverBackupSettingsGet`(
)
BEGIN
	
    SELECT id_impostazioni, 
	 	valore 
    FROM impostazioni_backup; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverChecklistEmployeeGetByChecklist
DELIMITER //
CREATE PROCEDURE `sp_serverChecklistEmployeeGetByChecklist`(
	IN checklist_id INT(11) 
)
BEGIN
	SELECT 	
		`id`,
		`id_checklist`,
		`id_tecnico`,
		`ragione_sociale`
	FROM checklist_tecnico
		INNER JOIN operaio ON id_tecnico = id_operaio
	WHERE id_checklist = checklist_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverChecklistGetForPrint
DELIMITER //
CREATE PROCEDURE `sp_serverChecklistGetForPrint`()
BEGIN
	SELECT 	
		`id`,
		`id_mobile`,
		`data_esecuzione`,
		`id_checklist_model`
		`id_operaio`,
		`id_cliente`,
		`id_responsabile`,
		`id_impianto`,
		`ragione_sociale`,
		`indirizzo`,
		`citta`,
		`responsabile`,
		`impianto_luogo_installazione`,
		`impianto_centrale`,
		`impianto_data_installazione`,
		`impianto_dipartimento`,
		`timestamp_creazione`,
		altro, 
		appunti, 
		responsabile_lavoro, 
		numero_visita, 
		controllo_periodico,
		id_checklist_model,
		filename_firma_cliente, 
		filename_firma_tecnico,
		`utente_ins`,
		`utente_mod`,
		`data_ins`,
		`data_mod` 
	FROM CHECKlist
	WHERE stampata = 0; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverChecklistParagraphGetByChecklist
DELIMITER //
CREATE PROCEDURE `sp_serverChecklistParagraphGetByChecklist`(
	IN checklist_id INT(11) 
)
BEGIN
	SELECT 	
		`id`,
		`id_checklist`,
		`id_checklist_model_paragrafo`,
		`nome`,
		`descrizione`,
		`ordine`,
		`utente_mod`,
		`data_mod`
	FROM checklist_paragrafo
	WHERE id_Checklist = checklist_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverChecklistReportGetByChecklist
DELIMITER //
CREATE PROCEDURE `sp_serverChecklistReportGetByChecklist`(
	IN checklist_id INT(11) 
)
BEGIN
	SELECT 	
		`id`,
		`id_checklist`,
		`id_rapporto`,
		`anno_rapporto`
	FROM checklist_rapporto
	WHERE id_Checklist = checklist_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverChecklistRowGetByParagraph
DELIMITER //
CREATE PROCEDURE `sp_serverChecklistRowGetByParagraph`(
	IN paragraph_id INT(11) 
)
BEGIN
	SELECT 	
		`id`,
		`id_checklist`,
		`id_paragrafo`,
		`json_data`,
		`tipo_riga`,
		`id_checklist_model_elemento`,
		`id_checklist_model_paragrafo`,
		`id_checklist_model`,
		`ordine`,
		`nome`,
		`descrizione`,
		`indicazioni_tecnico`
	FROM checklist_paragrafo_riga
	WHERE id_paragrafo = paragraph_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverChecklistSetAsPrinted
DELIMITER //
CREATE PROCEDURE `sp_serverChecklistSetAsPrinted`(
	IN checklist_id INT(11) 
)
BEGIN
	UPDATE checklist
	SET stampata = 1
	WHERE id = checklist_id; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCountryDelete
DELIMITER //
CREATE PROCEDURE `sp_serverCountryDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM Nazione 
	WHERE id_Nazione = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCountryGet
DELIMITER //
CREATE PROCEDURE `sp_serverCountryGet`( 
)
BEGIN
	SELECT Id_nazione,
	Nome,
	sigla,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Nazione
	ORDER BY Id_nazione;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCountryGetById
DELIMITER //
CREATE PROCEDURE `sp_serverCountryGetById`( 
	Country_id INT
)
BEGIN
	SELECT Id_nazione,
	Nome,
	sigla,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Nazione
	WHERE Id_nazione = Country_id
	ORDER BY Id_nazione;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCountryGetByMunicipality
DELIMITER //
CREATE PROCEDURE `sp_serverCountryGetByMunicipality`( 
	municipality_id INT
)
BEGIN


	DECLARE countryId INT(11); 
	
	SELECT Nazione.Id_nazione 
		into countryId 
	FROM comune
		INNER JOIN province ON comune.id_provincia = province.id_provincia 
		INNER JOIN regione ON Regione.id_regione = province.Regione 
		INNER JOIN Nazione on id_nazione = regione.nazione
	WHERE comune.Id_comune = municipality_id; 

	CALL sp_serverCountryGetById(countryId);

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCountryGetByName
DELIMITER //
CREATE PROCEDURE `sp_serverCountryGetByName`( 
	name VARCHAR(30)
)
BEGIN
	SELECT Id_nazione,
	Nome,
	sigla,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Nazione
	WHERE Nome = name
	ORDER BY Id_nazione;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCountryInsert
DELIMITER //
CREATE PROCEDURE `sp_serverCountryInsert`( 
	name VARCHAR(45),
	abbreviation varchar(10),
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT Count(id_nazione) INTO Result
	FROM Nazione 
	WHERE Nome = Name; 
	
	IF Result > 0 THEN
		 SET Result = -1; # Country name already exists
	END IF;

	
	IF Result = 0 THEN
		INSERT INTO Nazione 
		SET 
			Nome = name,
			sigla = Abbreviation, 
			Data_ins = NOW(), 
			Data_mod = NOW(), 
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCountryUpdate
DELIMITER //
CREATE PROCEDURE `sp_serverCountryUpdate`( 
	enter_id INTEGER,
	name VARCHAR(45),
	abbreviation varchar(10),
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT Count(Id_nazione) INTO Result
	FROM Nazione 
	WHERE Nome = Name AND Id_nazione != enter_id; 
	
	IF Result > 0 THEN
		 SET Result = -1; # Country name already exists
	END IF;

	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM Nazione 
			WHERE id_Nazione = enter_id;
			
			IF Result = 0 THEN
				SET Result = -2; # Country ID not found							
			END IF; 
	END IF; 
	
	IF Result >0 THEN
		UPDATE Nazione 
		SET 
			Nome = name,
			sigla = Abbreviation, 
			Utente_mod = @USER_ID
		Where id_Nazione = enter_id;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCustomerDestinationGet
DELIMITER //
CREATE PROCEDURE `sp_serverCustomerDestinationGet`()
BEGIN
	SELECT 
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE('1970-01-01 00:00:00', '%y-%m-&d %h:%i:%s')) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCustomerDestinationGetByCustomerId
DELIMITER //
CREATE PROCEDURE `sp_serverCustomerDestinationGetByCustomerId`(
	IN customer_id INT
)
BEGIN
	SELECT 
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE('1970-01-01 00:00:00', '%y-%m-&d %h:%i:%s')) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente
	WHERE Id_cliente = customer_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCustomerDestinationGetByCustomerIdAndDestinationId
DELIMITER //
CREATE PROCEDURE `sp_serverCustomerDestinationGetByCustomerIdAndDestinationId`(
	IN customer_id INT,
	IN destination_id INT
)
BEGIN
	SELECT 
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE('1970-01-01 00:00:00', '%y-%m-&d %h:%i:%s')) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente
	WHERE Id_cliente = customer_id AND Id_destinazione = destination_id;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCustomerDestinationGetByCustomerIds
DELIMITER //
CREATE PROCEDURE `sp_serverCustomerDestinationGetByCustomerIds`(
	IN customer_ids MEDIUMTEXT
)
BEGIN

	SELECT DISTINCT
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE("1970-01-01 00:00:00", "%y-%m-&d %h:%i:%s")) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente
	WHERE FIND_IN_SET(Id_cliente,customer_ids) > 0;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCustomerDestinationGetWithoutDistanceAndTime
DELIMITER //
CREATE PROCEDURE `sp_serverCustomerDestinationGetWithoutDistanceAndTime`()
BEGIN
	SELECT 
		Id, 
		Id_cliente, 
		Id_destinazione, 
		IFNULL(Provincia, "") Provincia, 
		IFNULL(Comune, 0) Comune, 
		IFNULL(Frazione, 0) Frazione,
		IFNULL(Indirizzo, "") Indirizzo, 
		IFNULL(numero_civico, 0) Numero_civico, 
		Descrizione, 
		IFNULL(Scala, "") Scala, 
		IFNULL(Altro, "") Altro, 
		IFNULL(Km_sede, 0) Km_sede, 
		IFNULL(Pedaggio, 0) Pedaggio, 
		IFNULL(Tempo_strada, 0) Tempo_strada,
		IFNULL(Attivo, 0) Attivo, 
		ztl, 
		IFNULL(Note, "") Note, 
	   Autostrada, 
		Sede_principale,
		Dalle1,
		Alle1,
		Dalle2,
		Alle2,
		IFNULL(Piano, 0) Piano, 
		IFNULL(Interno, 0) Interno, 
		IFNULL(Id_autostrada, 0) Id_autostrada,
		IFNULL(Longitudine, 0) Longitudine,
		IFNULL(Latitudine, 0) Latitudine, 
		IFNULL(Data_ins, STR_TO_DATE('1970-01-01 00:00:00', '%y-%m-&d %h:%i:%s')) Data_ins,
		Data_mod,
		IFNULL(Utente_ins, 0) Utente_ins,
		IFNULL(Utente_mod, 0) Utente_mod
	FROM destinazione_cliente
	WHERE (Km_sede = 0 
		and Tempo_strada = 0 
		and comune IS NOT NULL 
		and indirizzo IS NOT NULL 
		and indirizzo <> "");
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCustomerDestinationInsert
DELIMITER //
CREATE PROCEDURE `sp_serverCustomerDestinationInsert`(
  IN customer_id INT(11),
  IN province VARCHAR(5),
  IN municipality_id INT(11),
  IN district_id INT(11),
  IN street VARCHAR(50),
  IN street_number SMALLINT(6),
  IN description VARCHAR(105),
  IN stair VARCHAR(6),
  IN other VARCHAR(9),
  IN distance SMALLINT(6),
  IN toll DECIMAL(11,2),
  IN trip_time SMALLINT(6),
  IN is_active BIT,
  IN is_limited_traffic_zone BIT,
  IN notes TEXT,
  IN has_speedway BIT,
  IN is_main_destination BIT,
  IN from_morning TIME,
  IN to_morning TIME,
  IN from_afternoon TIME,
  IN to_afternoon TIME,
  IN floor TINYINT,
  IN intern TINYINT,
  IN speedway_id INT,
  IN latitude DECIMAL (11,8),
  IN longitude DECIMAL (11,8),
  OUT result INT,
  OUT destination_id INT
)
BEGIN
	
	DECLARE tmp_province VARCHAR(5) DEFAULT NULL;
	DECLARE tmp_municipality_id INT(11) DEFAULT NULL;
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SELECT COUNT(Id_cliente)
		INTO result 
	FROM clienti 
	WHERE Id_cliente = customer_id; 
	
	IF result = 0 THEN
		SET result = -1; -- customer not found
	ELSE
	
		IF province IS NOT NULL THEN
		
		  SELECT COUNT(province.Sigla)
		 	INTO result
		  FROM province 
		  WHERE province.Sigla = province;
		    
		END IF; 
		
		IF result = 0 THEN
			SET result = -7; -- province not found
		ELSE
			IF municipality_id IS NOT NULL THEN
			
				SELECT COUNT(Id_comune), comune.provincia
					INTO result, tmp_province 
				FROM comune 
				WHERE comune.Id_comune = municipality_id; 
				
				IF result = 0 THEN
					SET result = -2; -- municipality not found
				ELSE
					IF province <> tmp_province THEN
						SET result = -3; -- invalid province by municipality id
					END IF;			
				END IF; 
				
				IF result > 0 AND district_id IS NOT NULL THEN
				
					SELECT COUNT(Id_frazione), frazione.Id_comune
						INTO result, tmp_municipality_id 
					FROM frazione 
					WHERE frazione.Id_frazione = district_id; 
					
					IF result = 0 THEN
						SET result = -4; -- distirct not found
					ELSE
						IF municipality_id <> tmp_municipality_id THEN
							SET result = -5; -- invalid municipality id by destrict id
						END IF;			
					END IF; 
				
				END IF; 
				
				IF result > 0 AND speedway_id IS NOT NULL THEN
					
					SELECT id_autostrada
						INTO result
					FROM tipo_autostrada 
					WHERE tipo_autostrada.Id_tipo = speedway_id; 
	
					IF result = 0 THEN
						SET result = -6; -- speedway not found
					END IF; 
				END IF; 						
			END IF;
		END IF; 
	END IF;   		
	

	IF result > 0 THEN
	
		SELECT IFNULL(id_destinazione + 1, 1)
			INTO destination_id
		FROM destinazione_cliente 
		WHERE id_cliente = customer_id; 
		
		INSERT INTO destinazione_cliente
		SET  
			Id_cliente = customer_id, 
			Id_destinazione = destination_id, 
			Provincia = province, 
			Comune = municipality_id, 
			Frazione = district_id,
			Indirizzo = street, 
			Numero_civico = street_number, 
			Descrizione = description, 
			Scala = stair, 
			Altro = other, 
			Km_sede = distance, 
			Pedaggio = toll,
			Tempo_strada = trip_time, 
			Attivo = is_active, 
			ztl = is_limited_traffic_zone, 
			Note = notes, 
			Autostrada = has_speedway, 
			Sede_principale = is_main_destination,
			Dalle1 = from_morning,
			Alle1 = to_morning,
			Dalle2 = from_afternoon,
			Alle2 = to_afternoon,
			Piano = stair, 
			Interno = intern, 
			Id_autostrada = speedway_id,
			Longitudine = longitude,
			Latitudine = latitude, 
			Data_ins = NOW(),
			Utente_ins = @USER_ID,
			Utente_mod = @USER_ID;
			
			IF is_main_destination THEN
				CALL sp_serverCustomerDestinationSetAsMainDestination(customer_id, destination_id, @Result);
			END IF; 
		 
		SET Result = LAST_INSERT_ID(); 
			
	END IF; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCustomerDestinationResetAllDistance
DELIMITER //
CREATE PROCEDURE `sp_serverCustomerDestinationResetAllDistance`(
)
BEGIN
	UPDATE destinazione_cliente 
	SET tempo_strada = 0,
		km_sede = 0;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverCustomerDestinationSetAsMainDestination
DELIMITER //
CREATE PROCEDURE `sp_serverCustomerDestinationSetAsMainDestination`(
	IN customer_id INT,
	IN destination_id INT, 
	OUT result INT
)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	UPDATE destinazione_cliente 
	SET Sede_principale = True, 
		Utente_mod = @USER_ID
	WHERE Id_cliente = customer_id AND
			Id_destinazione = destination_id; 
	
	UPDATE destinazione_cliente 
	SET Sede_principale = False, 
		Utente_mod = @USER_ID
	WHERE Id_cliente = customer_id AND
			Id_destinazione <> destination_id;
			
	SET Result = 1; 
	

	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
		COMMIT; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverInvoicePaymentsGetAutoClosingExpired
DELIMITER //
CREATE PROCEDURE `sp_serverInvoicePaymentsGetAutoClosingExpired`( )
BEGIN

	SELECT 
		Id_fattura, 
		anno, 
		data_pagamento, 
		id_pagamento, 
		id_tipo_pagamento
	FROM
	(
		SELECT 
			
			fattura.id_fattura,
			fattura.anno, 
			fattura_pagamenti.nota, 
			IFNULL(fattura_pagamenti.`data`, LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY) AS "data_pagamento", 
			IFNULL(fattura_pagamenti.id_pagamento, CAST(DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ INTERVAL g.giorni DAY, '%Y%m%d') AS UNSIGNED)) AS "id_pagamento", 
			IF(fattura_pagamenti.tipo_pagamento IS NOT NULL, tipopag_pagamento1.Id_tipo, tipopag_pagamento.Id_tipo) AS "id_tipo_pagamento", 
			fattura_pagamenti.insoluto
		FROM fattura
			INNER JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione AND a.Chiusura_alla_scadenza = TRUE
			INNER JOIN condizioni_giorno AS g ON g.id_condizione = a.id_condizione
			LEFT JOIN fattura_pagamenti ON fattura.id_fattura=fattura_pagamenti.id_fattura AND fattura_pagamenti.anno=fattura.anno AND fattura_pagamenti.id_pagamento= DATE_FORMAT(LAST_DAY(fattura.DATA + INTERVAL g.mesi MONTH)+ 		INTERVAL g.giorni DAY,'%Y%m%d')
			LEFT JOIN tipo_pagamento AS tipopag_pagamento ON a.tipo = tipopag_pagamento.id_tipo
			LEFT JOIN tipo_pagamento AS tipopag_pagamento1 ON fattura_pagamenti.tipo_pagamento = tipopag_pagamento1.id_tipo
		WHERE fattura_pagamenti.id_pagamento IS NULL OR fattura_pagamenti.`data` IS NULL AND fattura_pagamenti.anno > 0

	) AS tmp
	WHERE data_pagamento < NOW() 
	GROUP BY id_fattura, anno, id_pagamento;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverInvoicePaymentsInsertOrUpdate
DELIMITER //
CREATE PROCEDURE `sp_serverInvoicePaymentsInsertOrUpdate`( 
	 IN InvoiceId INT(11), 
	 IN InvoiceYear INT(11), 
	 IN Note TEXT, 
	 IN PaymentDate Date, 
	 IN PaymentId INT(11), 
	 IN PaymentTypeId INT(11), 
	 IN Unsolved TINYINT(4)
)
BEGIN

	INSERT INTO fattura_pagamenti
		(id_fattura,anno,nota,data,id_pagamento,tipo_pagamento,insoluto)
	VALUES
		(InvoiceId,InvoiceYear,Note,PaymentDate,PaymentId,PaymentTypeId,Unsolved) 
	ON DUPLICATE KEY UPDATE 
		nota = Note, 
		data = PaymentDate, 
	 	tipo_pagamento = PaymentTypeId,
		insoluto = Unsolved; 
		
	CALL sp_ariesInvoiceEvaluateStatus(InvoiceId, InvoiceYear); 
	                        
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverMunicipalityDelete
DELIMITER //
CREATE PROCEDURE `sp_serverMunicipalityDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM Comune 
	WHERE id_comune = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverMunicipalityGet
DELIMITER //
CREATE PROCEDURE `sp_serverMunicipalityGet`( 
)
BEGIN
	SELECT Id_comune,
	Nome,
	Provincia, 
	Cap, 
	Id_Provincia,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Comune
	ORDER BY Id_comune;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverMunicipalityGetById
DELIMITER //
CREATE PROCEDURE `sp_serverMunicipalityGetById`( 
	municipality_id INT
)
BEGIN
	SELECT Id_comune,
	Nome,
	Provincia, 
	Cap, 
	Id_Provincia,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Comune
	WHERE Id_Comune = municipality_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverMunicipalityGetByPostalCode
DELIMITER //
CREATE PROCEDURE `sp_serverMunicipalityGetByPostalCode`( 
	postal_code VARCHAR(30)
)
BEGIN
	SELECT Id_comune,
	Nome,
	Provincia, 
	Cap, 
	Id_Provincia,
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM Comune
	WHERE Cap = postal_code;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverMunicipalityInsert
DELIMITER //
CREATE PROCEDURE `sp_serverMunicipalityInsert`( 
	name VARCHAR(30),
	province varchar(15),
	postal_code varchar(10),
	province_id INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Province 
	WHERE sigla = province AND id_provincia = province_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM Comune 
		WHERE Nome = Name AND Cap = postal_code; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Municipality name & postal code already exists
		END IF;
	ELSE
		SET Result = -2; # province not found
	END IF;
	
	IF Result = 0 THEN
		INSERT INTO Comune 
		SET 
			Nome = name,
			Provincia = province , 
			Cap = postal_code, 
			Id_Provincia = province_id,
			Data_ins = NOW(),  
			Data_mod = NOW(),
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverMunicipalityUpdate
DELIMITER //
CREATE PROCEDURE `sp_serverMunicipalityUpdate`( 
	enter_id INTEGER,
	name VARCHAR(30),
	province varchar(15),
	postal_code varchar(10),
	province_id INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Province 
	WHERE sigla = province AND id_provincia = province_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM Comune 
		WHERE Nome = Name AND Cap = postal_code AND id_comune != enter_id;
		
		IF Result > 0 THEN
			 SET Result = -1; # Municipality name & postal code already exists
		END IF;
	ELSE
		SET Result = -2; # province not found
	END IF;
	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM Comune 
			WHERE id_comune = enter_id;
			
			IF Result = 0 THEN
				SET Result = -3; # Municipality ID not found							
			END IF; 
	END IF; 
	
	IF Result >0 THEN
		UPDATE Comune 
		SET 
			Nome = name,
			Provincia = province , 
			Cap = postal_code, 
			Id_Provincia = province_id,
			Utente_mod = @USER_ID
		Where id_comune = enter_id;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverPathConfigurationGet
DELIMITER //
CREATE PROCEDURE `sp_serverPathConfigurationGet`(
)
BEGIN
	
    SELECT tipo_percorso, 
	 	Percorso 
    FROM configurazione_percorsi; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverPathConfigurationGetByKey
DELIMITER //
CREATE PROCEDURE `sp_serverPathConfigurationGetByKey`(
	path_type VARCHAR(50)
)
BEGIN
	
    SELECT tipo_percorso, 
	 	Percorso 
    FROM configurazione_percorsi
	 WHERE tipo_percorso = path_type; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverProvinceDelete
DELIMITER //
CREATE PROCEDURE `sp_serverProvinceDelete`( 
	enter_id INTEGER
)
BEGIN

	DELETE FROM province 
	WHERE id_provincia = enter_id;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverProvinceGet
DELIMITER //
CREATE PROCEDURE `sp_serverProvinceGet`( 
)
BEGIN
	SELECT id_provincia,
	Nome,
	Sigla, 
	Regione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM province
	ORDER BY id_provincia;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverProvinceGetByAbbreviation
DELIMITER //
CREATE PROCEDURE `sp_serverProvinceGetByAbbreviation`( 
	abbreviation INT
)
BEGIN
	SELECT id_provincia,
	Nome,
	Sigla, 
	Regione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM province
	WHERE Sigla = abbreviation;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverProvinceGetById
DELIMITER //
CREATE PROCEDURE `sp_serverProvinceGetById`( 
	Province_id INT
)
BEGIN
	SELECT id_provincia,
	Nome,
	Sigla, 
	Regione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM province
	WHERE id_provincia = Province_id;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverProvinceGetByName
DELIMITER //
CREATE PROCEDURE `sp_serverProvinceGetByName`( 
	name VARCHAR(45)
)
BEGIN
	SELECT id_provincia,
	Nome,
	Sigla, 
	Regione, 
	Data_ins, 
	Data_mod,
	Utente_ins, 
	Utente_mod	
	FROM province
	WHERE Nome = name;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverProvinceInsert
DELIMITER //
CREATE PROCEDURE `sp_serverProvinceInsert`( 
	name VARCHAR(45),
	region_id INTEGER,
	abbreviation VARCHAR(15),
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM Regione 
	WHERE id_regione = region_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM province 
		WHERE Nome = Name; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Province name already exists
		END IF;
	ELSE
		SET Result = -2; # region not found
	END IF;
	
	IF Result = 0 THEN
		INSERT INTO province 
		SET 
			Nome = name,
			Regione = region_id,
			Sigla = abbreviation, 
			Data_ins = NOW(), 
			Data_mod = NOW(),
			Utente_ins = @USER_ID, 
			Utente_mod = @USER_ID;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverProvinceUpdate
DELIMITER //
CREATE PROCEDURE `sp_serverProvinceUpdate`( 
	enter_id INTEGER,
	name VARCHAR(45),
	abbreviation VARCHAR(15),
	region_id INTEGER,
	OUT Result INT
)
BEGIN
	
	SET Result = 1; 
	
	SELECT COUNT(*) INTO Result
	FROM regione 
	WHERE id_regione = region_id; 
	
	IF Result>0 THEN
	
		SELECT Count(Nome) INTO Result
		FROM province 
		WHERE Nome = Name AND id_provincia != enter_id; 
		
		IF Result > 0 THEN
			 SET Result = -1; # Province name already exists
		END IF;
	ELSE
		SET Result = -2; # region not found
	END IF;
	
	IF Result = 0 THEN 
			SELECT Count(*) INTO Result
			FROM province 
			WHERE id_provincia = enter_id;
			
			IF Result = 0 THEN
				SET Result = -3; # Province ID not found							
			END IF; 
	END IF; 
	
	IF Result >0 THEN
		
		START TRANSACTION;
		
		UPDATE Comune 
		SET Provincia = abbreviation
		WHERE Id_provincia = enter_id; 	
		
		UPDATE province 
		SET 
			Nome = name,
			Regione = region_id, 
			Sigla = abbreviation, 
			Utente_mod = @USER_ID
		Where id_provincia = enter_id;
		
		COMMIT;
			
		SET Result = 1; 
	END IF; 
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverReportAttachmentGetByReport
DELIMITER //
CREATE PROCEDURE `sp_serverReportAttachmentGetByReport`(
	IN report_id INT,
	IN report_year INT
)
BEGIN

	SELECT
		`id`,
		`id_rapporto`,
		`anno_rapporto`,
		`file_path`,
		`file_name`,
		`invia_a_cliente`,
		`timestamp`,
		`utente_ins`
	FROM rapporto_allegati
	WHERE id_rapporto = report_id
		AND anno_rapporto = report_year;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverReportMobileInterventionGetForPrint
DELIMITER //
CREATE PROCEDURE `sp_serverReportMobileInterventionGetForPrint`()
BEGIN
	
	SELECT IF(rapporto_mobile_intervento_rif_tipo_intervento.Posizione=0, "X", " ") AS inst, 
	IF(rapporto_mobile_intervento_rif_tipo_intervento.Posizione=1, "X", " ") AS inter, 
	IF(rapporto_mobile_intervento_rif_tipo_intervento.Posizione=2, "X", " ") AS spost, 
	IF(rapporto_mobile_intervento_rif_tipo_intervento.Posizione=3, "X", " ") AS ampl, 
	IF(rapporto_mobile_intervento_rif_tipo_intervento.Posizione=4, "X", " ") AS cont_p, 
	IF(rapporto_mobile_intervento_rif_tipo_intervento.Posizione=5, "X", " ") AS coll, 
	IF(funzionante="0", "X", " ") AS funz, 
	IF(funzionante="1", "X", " ") AS non_funz, 
	IF(funzionante="2", "X", " ") AS parz, 
	IF(notturno="1", "X", " ") AS nott, 
	IF(festivo="1", "X", " ") AS fest, 
	IF(terminato="1", "X", " ") AS term, 
	IF(terminato="0", "X", " ") AS non_term, 
	IF(su_chiamata="1", "X", " ") AS su_chiam, 
	IF(eff_giorn="1", "X", " ") AS eff_giornata, 
	IF(sost="1", "X", " ") AS sosti, 
	IF(ripar="1", "X", " ") AS rip, 
	IF(c_not="1", "X", " ") AS c_note, 
	IF(abbon="1", "X", " ") AS abbonam, 
	IF(garanz="1", "X", " ") AS garanzia, 
	IF(man_ordi="1", "X", " ") AS ordinaria, 
	IF(fuoriabbon="1", "X", " ") AS fuoriabbonam, 
	IF(fuorigaranz="1", "X", " ") AS fuorigaranzia, 
	IF(man_straord="1", "X", " ") AS straordinaria, 
	IF(tipo_impianto="6", "X", " ") AS incendio, 
	IF(tipo_impianto="7" OR tipo_impianto="12", "X", " ") AS rilevazione, 
	IF(tipo_impianto="11", "X", " ") AS spegnimento, 
	IF(tipo_impianto="16", "X", " ") AS telefonico,
	IF(tipo_impianto="5", "X", " ") AS furto, 
	IF(tipo_impianto="8", "X", " ") AS tvcc, 
	IF(tipo_impianto="13", "X", " ") AS automazione, 
	IF(tipo_impianto NOT IN ("6", "7", "11", "12","16", "5", "8", "13"), "X", " ") as c_altroo , 
	IF(tipo_impianto NOT IN ("6", "7", "11", "12","16", "5", "8", "13"), IFNULL(Tipo_impianto.Nome, " "), " ") as altroo , 
	rapporto_mobile.not,
	rapporto_mobile.ragione_sociale, 
	citta, 
	indirizzo, 
	difetto, 
	luogo_lavoro , 
	note_generali,
	email_invio,
	id_impianto,
	richiesto, 
	mansione, 
	responsabile, 
	tecnici, 
	id_rapporto, 
	relazione, 
	id_cliente, 
	data_esecuzione as "data", 
	anno, 
	SUBSTRING(cast(anno as char(4)),3) as anno2, 
	id_utente, 
	mail_responsabile ,
	rapporto_mobile.da_reperibilita_telefonica, 
	IFNULL(tipo_rapporto, 0) AS tipo_rapporto,
	filename_firma_cliente, 
	filename_firma_tecnico
	FROM rapporto_mobile 
		LEFT JOIN Tipo_impianto ON Tipo_impianto.Id_tipo = tipo_impianto
		LEFT JOIN rapporto_mobile_intervento_rif_tipo_intervento 
			ON rapporto_mobile.Tipo_intervento = rapporto_mobile_intervento_rif_tipo_intervento.Id_tipo_intervento
	WHERE inviato=0 AND Data IS NOT NULL AND rapporto_mobile.timestamp_invio < DATE_SUB(NOW(), INTERVAL 1 MINUTE); 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverReportMobileInterventionProductGetForPrint
DELIMITER //
CREATE PROCEDURE `sp_serverReportMobileInterventionProductGetForPrint`(
	id MEDIUMINT,
	`year` SMALLINT
)
BEGIN
	
    SELECT descrizione as "nome_materiale",
		CONCAT("", quantita,"") as "quantita" 
    FROM rapporto_mobile_materiale
    WHERE id_rapporto = id
		AND anno_rapporto = `year` 
    ORDER BY descrizione 
    LIMIT 7; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverReportMobileRecipientGet
DELIMITER //
CREATE PROCEDURE `sp_serverReportMobileRecipientGet`( 
)
BEGIN

	SELECT rapporto_mobile_destinatario.id,
		rapporto_mobile_destinatario.id_rapporto,
		rapporto_mobile_destinatario.anno, 
		rapporto_mobile_destinatario.email, 
		rapporto_mobile_destinatario.tipo_email
		
	FROM rapporto_mobile_destinatario;
	                        
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverReportMobileRecipientGetByReport
DELIMITER //
CREATE PROCEDURE `sp_serverReportMobileRecipientGetByReport`( 
	 IN report_id INT(11), 
	 IN report_year INT(11)
)
BEGIN

	SELECT rapporto_mobile_destinatario.id,
		rapporto_mobile_destinatario.id_rapporto,
		rapporto_mobile_destinatario.anno, 
		rapporto_mobile_destinatario.email, 
		rapporto_mobile_destinatario.tipo_email
		
	FROM rapporto_mobile_destinatario
	WHERE id_rapporto = report_id AND anno = report_year;
	                        
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverReportMobileTestGetForPrint
DELIMITER //
CREATE PROCEDURE `sp_serverReportMobileTestGetForPrint`()
BEGIN
	
	
	SELECT 
		rapporto_mobile_collaudo.`Id`,
		`Id_rapporto`,
		`Anno`,
		rapporto_mobile_collaudo.`Id_cliente`,
		IFNULL(rapporto_mobile_collaudo.Id_impianto, 0) Id_impianto,
		rapporto_mobile_collaudo.`Indirizzo`,
		IFNULL(`Telefono`, "") Telefono,
		IFNULL(`Fax`, "") Fax,
		IFNULL(`Partita_iva_cod_fisc`, "") Partita_iva_cod_fisc,
		IFNULL(`Richiedente_intervento`, "") Richiedente_intervento,
		IFNULL(`Email`, "") Email,
		IFNULL(`Email_responsabile`, "") Email_responsabile,
		`Data`,
		IFNULL(`Descrizione_veicolo`, "") Descrizione_veicolo,
		`Tipo_intervento`,
		IFNULL(rapporto_mobile_collaudo.`Tipo_impianto`, 0) Tipo_impianto,
		`Ragione_sociale`,
		IFNULL(`Tipo_modello_impianto`, "") Tipo_modello_impianto,
		IFNULL(rapporto_mobile_collaudo.`Stato_impianto`, "") Stato_impianto,
		IF(`Test_check_1`= 1, "X", "") Test_check_1,
		IF(`Test_check_2`= 1, "X", "") Test_check_2,
		IF(`Test_check_3`= 1, "X", "") Test_check_3,
		IF(`Test_check_4`= 1, "X", "") Test_check_4,
		IF(`Test_check_5`= 1, "X", "") Test_check_5,
		IF(`Test_check_6`= 1, "X", "") Test_check_6,
		IF(`Test_check_7`= 1, "X", "") Test_check_7,
		IF(`Test_check_8`= 1, "X", "") Test_check_8,
		IF(`Test_check_9`= 1, "X", "") Test_check_9,
		IF(`Test_check_10`= 1, "X", "") Test_check_10,
		IF(`Test_check_11`= 1, "X", "") Test_check_11,
		IF(`Test_check_12`= 1, "X", "") Test_check_12,
		IF(`Test_check_13`= 1, "X", "") Test_check_13,
		IF(`Test_check_14`= 1, "X", "") Test_check_14,
		IF(`Test_check_15`= 1, "X", "") Test_check_15,
		IF(`Test_check_16`= 1, "X", "") Test_check_16,
		IF(`Test_check_17`= 1, "X", "") Test_check_17,
		IF(`Test_check_18`= 1, "X", "") Test_check_18,
		IF(`Test_check_19`= 1, "X", "") Test_check_19,
		IF(`Test_check_20`= 1, "X", "") Test_check_20,
		IF(`Test_check_21`= 1, "X", "") Test_check_21,
		IF(`Test_check_22`= 1, "X", "") Test_check_22,
		IF(`Test_check_23`= 1, "X", "") Test_check_23,
		IF(`Test_check_24`= 1, "X", "") Test_check_24,
		IF(`Test_check_25`= 1, "X", "") Test_check_25,
		IF(`Test_check_26`= 1, "X", "") Test_check_26,
		IF(`Test_check_27`= 1, "X", "") Test_check_27,
		IF(`Test_check_28`= 1, "X", "") Test_check_28,
		IF(`Test_check_29`= 1, "X", "") Test_check_29,
		IF(`Test_check_30`= 1, "X", "") Test_check_30,
		IF(`Test_check_31`= 1, "X", "") Test_check_31,
		IF(`Test_check_32`= 1, "X", "") Test_check_32,
		IF(`Test_check_33`= 1, "X", "") Test_check_33,
		IF(`Test_check_34`= 1, "X", "") Test_check_34,
		IF(`Test_check_35`= 1, "X", "") Test_check_35,
		IF(`Test_check_36`= 1, "X", "") Test_check_36,
		IF(`Test_check_37`= 1, "X", "") Test_check_37,
		IF(`Test_check_38`= 1, "X", "") Test_check_38,
		IF(`Test_check_39`= 1, "X", "") Test_check_39,
		IF(`Test_check_40`= 1, "X", "") Test_check_40,
		IF(`Test_check_41`= 1, "X", "") Test_check_41,
		IF(`Test_check_42`= 1, "X", "") Test_check_42,
		IF(`Test_check_43`= 1, "X", "") Test_check_43,
		IF(`Test_check_44`= 1, "X", "") Test_check_44,
		IF(`Test_check_45`= 1, "X", "") Test_check_45,
		IF(`Test_check_46_1`= 1, "X", "") Test_check_46_1,
		IF(`Test_check_47_1`= 1, "X", "") Test_check_47_1,
		IF(`Test_check_48_1`= 1, "X", "") Test_check_48_1,
		IF(`Test_check_46_2`= 1, "X", "") Test_check_46_2,
		IF(`Test_check_47_2`= 1, "X", "") Test_check_47_2,
		IF(`Test_check_48_2`= 1, "X", "") Test_check_48_2,
		IF(`Test_check_46_3`= 1, "X", "") Test_check_46_3,
		IF(`Test_check_47_3`= 1, "X", "") Test_check_47_3,
		IF(`Test_check_48_3`= 1, "X", "") Test_check_48_3,
		IF(`Test_quantita_1` = 0, "", CONCAT(Test_quantita_1, "")) Test_quantita_1,
		IF(`Test_quantita_2` = 0, "", CONCAT(Test_quantita_2, "")) Test_quantita_2,
		IF(`Test_quantita_3` = 0, "", CONCAT(Test_quantita_3, "")) Test_quantita_3,
		IF(`Test_quantita_4` = 0, "", CONCAT(Test_quantita_4, "")) Test_quantita_4,
		IF(`Test_quantita_5` = 0, "", CONCAT(Test_quantita_5, "")) Test_quantita_5,
		IF(`Test_quantita_6` = 0, "", CONCAT(Test_quantita_6, "")) Test_quantita_6,
		IF(`Test_quantita_7` = 0, "", CONCAT(Test_quantita_7, "")) Test_quantita_7,
		IF(`Test_quantita_8` = 0, "", CONCAT(Test_quantita_8, "")) Test_quantita_8,
		IF(`Test_quantita_9` = 0, "", CONCAT(Test_quantita_9, "")) Test_quantita_9,
		IF(`Test_quantita_10` = 0, "", CONCAT(Test_quantita_10, "")) Test_quantita_10,
		IF(`Test_quantita_11` = 0, "", CONCAT(Test_quantita_11, "")) Test_quantita_11,
		IF(`Test_quantita_12` = 0, "", CONCAT(Test_quantita_12, "")) Test_quantita_12,
		IF(`Test_quantita_13` = 0, "", CONCAT(Test_quantita_13, "")) Test_quantita_13,
		IF(`Test_quantita_14` = 0, "", CONCAT(Test_quantita_14, "")) Test_quantita_14,
		IF(`Test_quantita_15` = 0, "", CONCAT(Test_quantita_15, "")) Test_quantita_15,
		IF(`Test_quantita_16` = 0, "", CONCAT(Test_quantita_16, "")) Test_quantita_16,
		IF(`Test_quantita_17` = 0, "", CONCAT(Test_quantita_17, "")) Test_quantita_17,
		IF(`Test_quantita_18` = 0, "", CONCAT(Test_quantita_18, "")) Test_quantita_18,
		IF(`Test_quantita_19` = 0, "", CONCAT(Test_quantita_19, "")) Test_quantita_19,
		IF(`Test_quantita_20` = 0, "", CONCAT(Test_quantita_20, "")) Test_quantita_20,
		IF(`Test_quantita_21` = 0, "", CONCAT(Test_quantita_21, "")) Test_quantita_21,
		IF(`Test_quantita_22` = 0, "", CONCAT(Test_quantita_22, "")) Test_quantita_22,
		IF(`Test_quantita_23` = 0, "", CONCAT(Test_quantita_23, "")) Test_quantita_23,
		IF(`Test_quantita_24` = 0, "", CONCAT(Test_quantita_24, "")) Test_quantita_24,
		IF(`Test_quantita_25` = 0, "", CONCAT(Test_quantita_25, "")) Test_quantita_25,
		IF(`Test_quantita_26` = 0, "", CONCAT(Test_quantita_26, "")) Test_quantita_26,
		IF(`Test_quantita_27` = 0, "", CONCAT(Test_quantita_27, "")) Test_quantita_27,
		IF(`Test_quantita_28` = 0, "", CONCAT(Test_quantita_28, "")) Test_quantita_28,
		IF(`Test_quantita_29` = 0, "", CONCAT(Test_quantita_29, "")) Test_quantita_29,
		IF(`Test_quantita_30` = 0, "", CONCAT(Test_quantita_30, "")) Test_quantita_30,
		IF(`Test_quantita_31` = 0, "", CONCAT(Test_quantita_31, "")) Test_quantita_31,
		IF(`Test_quantita_32` = 0, "", CONCAT(Test_quantita_32, "")) Test_quantita_32,
		IF(`Test_quantita_33` = 0, "", CONCAT(Test_quantita_33, "")) Test_quantita_33,
		IF(`Test_quantita_34` = 0, "", CONCAT(Test_quantita_34, "")) Test_quantita_34,
		IF(`Test_quantita_35` = 0, "", CONCAT(Test_quantita_35, "")) Test_quantita_35,
		IF(`Test_quantita_36` = 0, "", CONCAT(Test_quantita_36, "")) Test_quantita_36,
		IF(`Test_quantita_37` = 0, "", CONCAT(Test_quantita_37, "")) Test_quantita_37,
		IF(`Test_quantita_38` = 0, "", CONCAT(Test_quantita_38, "")) Test_quantita_38,
		IF(`Test_quantita_39` = 0, "", CONCAT(Test_quantita_39, "")) Test_quantita_39,
		IF(`Test_quantita_40` = 0, "", CONCAT(Test_quantita_40, "")) Test_quantita_40,
		IF(`Test_quantita_41` = 0, "", CONCAT(Test_quantita_41, "")) Test_quantita_41,
		IF(`Test_quantita_42` = 0, "", CONCAT(Test_quantita_42, "")) Test_quantita_42,
		IF(`Test_quantita_43` = 0, "", CONCAT(Test_quantita_43, "")) Test_quantita_43,
		IF(`Test_quantita_44` = 0, "", CONCAT(Test_quantita_44, "")) Test_quantita_44,
		IF(`Test_quantita_45` = 0, "", CONCAT(Test_quantita_45, "")) Test_quantita_45,
		IF(`Test_quantita_46_1` = 0, "", CONCAT(Test_quantita_46_1, "")) Test_quantita_46_1,
		IF(`Test_quantita_47_1` = 0, "", CONCAT(Test_quantita_47_1, "")) Test_quantita_47_1,
		IF(`Test_quantita_48_1` = 0, "", CONCAT(Test_quantita_48_1, "")) Test_quantita_48_1,
		IF(`Test_quantita_46_2` = 0, "", CONCAT(Test_quantita_46_2, "")) Test_quantita_46_2,
		IF(`Test_quantita_47_2` = 0, "", CONCAT(Test_quantita_47_2, "")) Test_quantita_47_2,
		IF(`Test_quantita_48_2` = 0, "", CONCAT(Test_quantita_48_2, "")) Test_quantita_48_2,
		IF(`Test_quantita_46_3` = 0, "", CONCAT(Test_quantita_46_3, "")) Test_quantita_46_3,
		IF(`Test_quantita_47_3` = 0, "", CONCAT(Test_quantita_47_3, "")) Test_quantita_47_3,
		IF(`Test_quantita_48_3` = 0, "", CONCAT(Test_quantita_48_3, "")) Test_quantita_48_3,
		IFNULL(rapporto_mobile_collaudo.`Note`, "") Note,
		IF(DATE_FORMAT(Data_intervento, "%Y-%m-%d") <> "1970-01-01", DATE_FORMAT(Data_intervento, "%d/%m/%Y"), "") `Data_intervento`,
		IF(DATE_FORMAT(Ora_inizio_intervento_1, "%H:%i") <> "00:00", DATE_FORMAT(Ora_inizio_intervento_1, "%H:%i"), "") `Ora_inizio_intervento_1`,
		IF(DATE_FORMAT(Ora_fine_intervento_1, "%H:%i") <> "00:00", DATE_FORMAT(Ora_fine_intervento_1, "%H:%i"), "") `Ora_fine_intervento_1`,
		IF(DATE_FORMAT(Ora_inizio_intervento_2, "%H:%i") <> "00:00", DATE_FORMAT(Ora_inizio_intervento_2, "%H:%i"), "") `Ora_inizio_intervento_2`,
		IF(DATE_FORMAT(Ora_fine_intervento_2, "%H:%i") <> "00:00", DATE_FORMAT(Ora_fine_intervento_2, "%H:%i"), "") `Ora_fine_intervento_2`,
		Ore_intervento, 
		IF(`Ore_Viaggio` = 0, "", CONCAT(Ore_viaggio, "")) Ore_viaggio, 
		IF(`Ore_totali` = 0, "", CONCAT(Ore_totali, "")) Ore_totali,
		IF(`Prezzo_ora` = 0, "", CONCAT(Prezzo_ora, "")) Prezzo_ora,
		IFNULL(`Note_viaggio` , "") Note_viaggio,
		IF(`Numero_viaggi` = 0, "", CONCAT(Numero_viaggi, "")) Numero_viaggi,
		IF(`Km_percorsi` = 0, "", CONCAT(Km_percorsi, "")) Km_percorsi,
		IF(`Km_complessivi` = 0, "", CONCAT(Km_complessivi, "")) Km_complessivi,
		IF(`Prezzo_km` = 0, "", CONCAT(Prezzo_km, "")) Prezzo_km,
		IF(`Totale_prezzo_viaggio` = 0, "", CONCAT(Totale_prezzo_viaggio, "")) Totale_prezzo_viaggio,
		IF(`Totale_prezzo_orario` = 0, "", CONCAT(Totale_prezzo_orario, "")) Totale_prezzo_orario,
		IF(`Totale_prezzo_materiale` = 0, "", CONCAT(Totale_prezzo_materiale, "")) Totale_prezzo_materiale,
		IF(`Imponibile` = 0, "", CONCAT(Imponibile, "")) Imponibile,
		IF(`Iva` = 0, "", CONCAT(Iva, "")) Iva,
		IF(`Totale_prezzo` = 0, "", CONCAT(Totale_prezzo, "")) Totale_prezzo,
		Utente_inserimento AS Id_utente,
		CONCAT(CONCAT(dc.indirizzo,' n.', IFNULL(dc.numero_civico, ''), ' ',IFNULL(dc.altro, '')),' - ',concat(IF(f.nome IS NOT NULL AND f.nome <> '', concat(f.nome,' di '), ''), c.nome,' (',c.provincia,')')) AS 'Indirizzo_impianto'
	FROM rapporto_mobile_collaudo 
	LEFT JOIN impianto ON impianto.id_impianto = rapporto_mobile_collaudo.id_impianto
		INNER JOIN destinazione_cliente AS dc ON dc.id_cliente = rapporto_mobile_collaudo.id_cliente
			AND impianto.destinazione = dc.Id_destinazione
		INNER JOIN comune AS c ON c.id_comune=dc.Comune
		LEFT JOIN frazione AS f ON f.id_frazione=dc.frazione
	WHERE Inviato = 0 AND rapporto_mobile_collaudo.timestamp_invio < DATE_SUB(NOW(), INTERVAL 1 MINUTE);   
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverReportMobileTestGetUnproccessed
DELIMITER //
CREATE PROCEDURE `sp_serverReportMobileTestGetUnproccessed`()
BEGIN
	SELECT 
		`Id_rapporto`,
		`Anno`
	FROM rapporto_mobile_collaudo 
	WHERE Processato = 0; 
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverReportMobileTestSentToIntervention
DELIMITER //
CREATE PROCEDURE `sp_serverReportMobileTestSentToIntervention`(
	IN ReportId SMALLINT, 
	IN ReportYear SMALLINT, 
	OUT Result BIT)
BEGIN
	DECLARE `_rollback` BOOL DEFAULT 0;

	DECLARE `SystemId` INTEGER DEFAULT 0;
	DECLARE `DestinationId` INTEGER DEFAULT 1;
	DECLARE `SubscriptionId` INTEGER DEFAULT NULL;
	DECLARE InterventionDate DATETIME; 
	DECLARE `SystemType` INTEGER DEFAULT 0;
	DECLARE `InterventionType` INTEGER DEFAULT 0;
	DECLARE WarrantySystemExpiration DATE DEFAULT NULL; 
	
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_rollback` = 1;
	
	START TRANSACTION;
	
	SELECT Id_impianto, 
			rapporto_mobile_collaudo.Data_intervento, 
			IFNULL(rapporto_mobile_collaudo_rif_tipo_intervento.Id_tipo_intervento, 1)
		INTO SystemId,
		InterventionDate,
		InterventionType
	FROM rapporto_mobile_collaudo 
		LEFT JOIN rapporto_mobile_collaudo_rif_tipo_intervento
			ON rapporto_mobile_collaudo_rif_tipo_intervento.Posizione = rapporto_mobile_collaudo.Tipo_intervento
	WHERE Id_rapporto = ReportId AND Anno = ReportYear;
	
	IF SystemId <> 0 THEN
	
		SELECT Destinazione, 
			impianto.Tipo_impianto,
			IFNULL(impianto.scadenza_garanzia, CAST("1970-01-01" AS DATE))
			INTO DestinationId,
			SystemType,
			WarrantySystemExpiration
		FROM Impianto 
		WHERE Id_impianto = SystemId; 
		
		SELECT impianto_abbonamenti.Id_abbonamenti 
			INTO SubscriptionId
		FROM impianto_abbonamenti 
		WHERE Anno = YEAR(InterventionDate) AND Id_impianto = SystemId; 
		
	END IF;  
	
	
	-- Delete eventualy duplicate
	DELETE FROM rapporto_mobile 
	WHERE Id_rapporto = ReportId AND anno = ReportYear; 


	-- INSERT INTO rapporto mobile
	INSERT INTO rapporto_mobile 
	(
		id_rapporto,
		anno , 
		id_impianto, 
		id_destinazione, 
		id_cliente, 
		Richiesto, 
		mansione, 
		responsabile,
		tipo_intervento, 
		Diritto_chiamata, 
		tipo_diritto_chiamata, 
		relazione, 
		terminato, 
		funzionante, 
		stato, 
		Note_generali,
		Fattura, 
		Data, 
		Commessa, 
		abbonamento, 
		Numero_ordine, 
		Totale, 
		Nr_rapporto, 
		Data_esecuzione, 
		costo, 
		scan, 
		anno_fattura, 
		controllo_periodico,
		prima, 
		numero,
		id_utente, 
		cost_lav, 
		prez_lav, 
		dest_cli, 
		email_invio,
		inviato, 
		visionato, 
		id_ticket, 
		tecnici, 
		appunti, 
		notturno, 
		festivo, 
		su_chiamata, 
		eff_giorn, 
		sost, 
		ripar, 
		`not`, 
		c_not, 
		abbon, 
		garanz,
		man_ordi, 
		fuoriabbon, 
		fuorigaranz,
		man_straord, 
		tipo_impianto,
		ragione_sociale, 
		indirizzo, 
		citta, 
		luogo_lavoro, 
		difetto, 
		id_riferimento,
		mail_responsabile, 
		invia_a_tecnico,
		da_reperibilita_telefonica,
		id_tecnico
	)
	SELECT
		rapporto_mobile_collaudo.id_rapporto, -- id_rapporto = id,
		rapporto_mobile_collaudo.anno, -- anno = year, 
		rapporto_mobile_collaudo.id_impianto, -- id_impianto = system_id, 
		IFNULL(DestinationId, 1), -- id_destinazione = destination_id, 
		rapporto_mobile_collaudo.Id_cliente, -- id_cliente = customer_id, 
		rapporto_mobile_collaudo.Richiedente_intervento, -- Richiesto = requesting_intervention, 
		"", -- mansione = responsible_job, 
		"", -- responsabile = responsible,
		InterventionType, -- tipo_intervento = intervention_type, 
		IF(SubscriptionId IS NULL, 0, 1), -- Diritto_chiamata = right_call, 
		0, -- tipo_diritto_chiamata = 0, 
		rapporto_mobile_collaudo.Note, -- relazione = technical_report, 
		0, -- terminato = is_work_finished, 
		0, -- funzionante = system_conditions, 
		1, -- stato = 1, 
		"", -- Note_generali = notes_highlights,
		NULL, -- Fattura = NULL, 
		rapporto_mobile_collaudo.Data, -- Data = CURDATE(), 
		NULL, -- Commessa = NULL, 
		SubscriptionId, -- abbonamento = NULL, 
		NULL, -- Numero_ordine = NULL, 
		0, -- Totale = 0, 
		rapporto_mobile_collaudo.id_rapporto, -- Nr_rapporto = report_number, 
		InterventionDate, -- Data_esecuzione = execution_date, 
		0, -- costo = 0, 
		0, -- scan = 0, 
		NULL, -- anno_fattura = NULL, 
		NULL, -- controllo_periodico = NULL,
		0, -- prima = 0, 
		rapporto_mobile_collaudo.id_rapporto, -- numero = report_number,
		rapporto_mobile_collaudo.Utente_inserimento, -- id_utente = user_id, 
		NULL, -- cost_lav = NULL, 
		NULL, -- prez_lav = NULL, 
		rapporto_mobile_collaudo.Id_cliente, -- dest_cli = customer_id, 
		rapporto_mobile_collaudo.Email, -- email_invio = email_company,
		1, -- inviato = 0, 
		0, -- visionato = 0, 
		NULL, -- id_ticket = NULL, 
		NULL, -- tecnici = NULL, 
		"", -- appunti = clipboard, 
		0, -- notturno = is_nocturnal, 
		0, -- festivo = is_public_holiday, 
		0, -- su_chiamata = is_on_call, 
		0, -- eff_giorn = is_carried_out_in_day, 
		0, -- sost = is_replaced, 
		0, -- ripar = is_repair, 
		0, -- `not` = intervention_detail_custom_text, 
		0, -- c_not = is_custom, 
		IF(SubscriptionId IS NULL, 0, 1), -- abbon = is_subscribed, 
		IF(WarrantySystemExpiration <= CURDATE(), 0, 1), -- garanz = is_under_warranty,
		1, -- man_ordi = ordinary_maintenance, 
		IF(SubscriptionId IS NULL, 1, 0), -- fuoriabbon = is_not_subscribed, 
		IF(WarrantySystemExpiration <= CURDATE(), 1, 0), -- fuorigaranz = is_not_under_warranty,
		0, -- man_straord = extra_ordinary_maintenance, 
		IFNULL(SystemType, 0), -- tipo_impianto = system_type,
		rapporto_mobile_collaudo.ragione_sociale, -- ragione_sociale = company_name, 
		rapporto_mobile_collaudo.Indirizzo, -- indirizzo = address, 
		"", -- citta = city, 
		"", -- luogo_lavoro = work_place, 
		"", -- difetto = problem_detected, 
		0, -- id_riferimento = responsible_id,
		"", -- mail_responsabile = email_responsible, 
		0, -- invia_a_tecnico = send_to_technician,
		0, -- da_reperibilita_telefonica = is_telephone_avaibility,
		rapporto_mobile_collaudo.Operaio_inserimento -- id_tecnico = technician_sender_id
	FROM rapporto_mobile_collaudo
	WHERE Id_rapporto = ReportId AND anno = ReportYear; 

	UPDATE rapporto_mobile_collaudo
	SET rapporto_mobile_collaudo.Processato = 1
	WHERE Id_rapporto = ReportId AND anno = ReportYear; 
	
	IF `_rollback` THEN
	  ROLLBACK;
	  SET Result = 0; 
	ELSE
	  COMMIT;
	  SET Result = 1; 
	END IF;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverSystemGet
DELIMITER //
CREATE PROCEDURE `sp_serverSystemGet`( )
BEGIN
        

	SELECT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, '') As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverSystemGetById
DELIMITER //
CREATE PROCEDURE `sp_serverSystemGetById`( 
  systemId INT
)
BEGIN
        

	SELECT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, '') As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
	WHERE (Id_impianto = systemId); 
		
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverSystemGetByIds
DELIMITER //
CREATE PROCEDURE `sp_serverSystemGetByIds`(
	IN idArray MEDIUMTEXT)
BEGIN

SELECT DISTINCT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,"1970-01-01") AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,"1970-01-01") AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,"1970-01-01") AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, "") As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,"1970-01-01") AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,"1970-01-01") AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
	  WHERE FIND_IN_SET(Id_impianto, idArray) > 0; 
  
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverSystemGetByTicketStatus
DELIMITER //
CREATE PROCEDURE `sp_serverSystemGetByTicketStatus`( 
	statusTicket INT(11)
)
BEGIN
        

	SELECT DISTINCT impianto.Id_impianto,
		impianto.id_cliente, 
		impianto.id_gestore, 
		impianto.id_occupante, 
		CAST(IFNULL(impianto.Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(impianto.Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(impianto.altro, "") AS altro, 
		IFNULL(impianto.Abbonamento, 0) abbonamento, 
		impianto.Tipo_impianto,  
		IFNULL(impianto.Stato, 0) AS Stato , 
		CAST(IFNULL(impianto.Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(impianto.Descrizione, '') As Descrizione, 
		IFNULL(impianto.Destinazione, 0) AS Destinazione , 
		IFNULL(impianto.Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(impianto.Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(impianto.Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(impianto.Persone, 0) AS Persone, 
		impianto.Data_modifica, 
		impianto.Contr, 
		IFNULL(impianto.sub, 0) AS sub, 
		IFNULL(impianto.orario_prog, 0) AS orario_prog, 
		IFNULL(impianto.id_utente, 0) AS id_utente, 
		IFNULL(impianto.auto, 0) AS Auto, 
		IFNULL(impianto.condizione, 0) AS condizione, 
		IFNULL(impianto.eta, 0) AS eta, 
		IFNULL(impianto.Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(impianto.Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(impianto.Checklist, 0) Checklist,
		IFNULL(impianto.Centrale, "") AS Centrale, 
		IFNULL(impianto.gsm, "") AS gsm, 
		IFNULL(impianto.combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(impianto.flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(impianto.flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
		INNER JOIN Ticket 
		ON Impianto.Id_impianto = Ticket.Id_impianto AND Ticket.Stato_ticket = statusTicket;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverSystemGetOrderByDescription
DELIMITER //
CREATE PROCEDURE `sp_serverSystemGetOrderByDescription`( )
BEGIN
        

	SELECT Id_impianto,
		id_cliente, 
		id_gestore, 
		id_occupante, 
		CAST(IFNULL(Data_funzione,'1970-01-01') AS DATE) AS Data_funzione,
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS Data_terminazione,
		IFNULL(altro, "") AS altro, 
		IFNULL(Abbonamento, 0) abbonamento, 
		Tipo_impianto,  
		IFNULL(Stato, 0) AS Stato , 
		CAST(IFNULL(Data_terminazione,'1970-01-01') AS DATE) AS scadenza_garanzia,
		IFNULL(Descrizione, '') As Descrizione, 
		IFNULL(Destinazione, 0) AS Destinazione , 
		IFNULL(Tempo_manutenzione, 0) AS Tempo_manutenzione, 
		IFNULL(Costo_Manutenzione, 0) AS Costo_Manutenzione, 
		CAST(IFNULL(Data_registrazione ,'1970-01-01') AS DATE) AS Data_registrazione,
		IFNULL(Persone, 0) AS Persone, 
		Data_modifica, 
		Contr, 
		IFNULL(sub, 0) AS sub, 
		IFNULL(orario_prog, 0) AS orario_prog, 
		IFNULL(id_utente, 0) AS id_utente, 
		IFNULL(auto, 0) AS Auto, 
		IFNULL(condizione, 0) AS condizione, 
		IFNULL(eta, 0) AS eta, 
		IFNULL(Stato_invio_doc, "") As stato_invio_doc, 
		CAST(IFNULL(Data_invio_doc,'1970-01-01') AS DATE) AS Data_invio_doc,
		IFNULL(Checklist, 0) Checklist,
		IFNULL(Centrale, "") AS Centrale, 
		IFNULL(gsm, "") AS gsm, 
		IFNULL(combinatore_telefonico, "") AS combinatore_telefonico, 
		IFNULL(flag_abbonamento, 0) As flag_abbonamento,
		IFNULL(flag_abbonamento_anno, 0) AS flag_abbonamento_anno
	FROM Impianto
	ORDER BY Descrizione ASC;
		
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverSystemTypeGetById
DELIMITER //
CREATE PROCEDURE `sp_serverSystemTypeGetById`(
type_id INT(11)
)
BEGIN

	SELECT Id_tipo, 
		Nome, 
		Descrizione,
		Utente_mod, 
		Data_mod
	FROM Tipo_impianto
	WHERE Id_tipo = type_id; 

				
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_serverTabletConfigurationGetLastInsert
DELIMITER //
CREATE PROCEDURE `sp_serverTabletConfigurationGetLastInsert`( 
)
BEGIN
      
SELECT
	Id_tablet, 
	IFNULL(mail, "") AS mail, 
	IFNULL(testo_mail, "") AS testo_mail, 
	IFNULL(Host, "") AS host, 
	IFNULL(Password, "") AS Password, 
	IFNULL(porta, 0) AS Porta, 
	IFNULL(Username, "") AS Username, 
	IFNULL(DIsplay_name, "") AS Display_name, 
	email_ufficio, 
	IFNULL(Data_ins, Data_Mod) AS Data_ins,
	Data_Mod
FROM tablet_configurazione ORDER BY id_tablet DESC LIMIT 1; 
			
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_splitArray
DELIMITER //
CREATE PROCEDURE `sp_splitArray`(serializedArray VARCHAR(1024))
BEGIN

	SET @stmt = CONCAT("INSERT INTO splitArrayData(array_values) VALUES", serializedArray, ";");
	
	DROP TEMPORARY TABLE IF EXISTS splitArrayData;
	CREATE TEMPORARY TABLE splitArrayData (
		array_index INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
		array_values VARCHAR(64) NOT NULL DEFAULT ""
	) ENGINE = innoDB;
	
	PREPARE sttmnt FROM @stmt;
	EXECUTE sttmnt;
	DEALLOCATE PREPARE sttmnt;
	
	SET @stmt = "";
	
	SELECT array_values FROM splitArrayData;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_tknGetIDToken
DELIMITER //
CREATE PROCEDURE `sp_tknGetIDToken`(IN `id_utente`                       INT, IN `deadline`                       DATETIME, OUT `id_token`                       INT)
BEGIN

  INSERT INTO TokenRefresh (id_utente,deadline) values (id_utente, deadline);
  SELECT LAST_INSERT_ID() INTO id_token;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_tknRefreshTokenExists
DELIMITER //
CREATE PROCEDURE `sp_tknRefreshTokenExists`(IN `id_token`                       INT, OUT `FlagFind`                       BIT)
BEGIN
  SET FlagFind = 0; 
	
  SELECT COUNT(id_token)
	INTO 
		FlagFind
  FROM TokenRefresh 
  WHERE TokenRefresh.id_token=id_token;
  
  IF FlagFind then
    DELETE FROM TokenRefresh Where TokenRefresh.id_token=id_token;
  end if;

END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_userHasModuleAccess
DELIMITER //
CREATE PROCEDURE `sp_userHasModuleAccess`(user_id INT(11), module_name VARCHAR(100), OUT result BIT(1))
BEGIN   

	DECLARE val BIT(1) DEFAULT 0;
   	DECLARE user_type_id INT(11) default 0;

	DECLARE `_has_exception` BOOL DEFAULT 0;
	DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET `_has_exception` = 1;

   	SELECT tipo_utente INTO user_type_id FROM utente WHERE id_utente = user_id;

	SET @query_stmt = CONCAT('SELECT ',module_name,' > 0 FROM tipo_utente WHERE id_tipo = ', user_type_id);
   
	PREPARE stmt FROM @query_stmt;
	EXECUTE stmt;
	
	
	DEALLOCATE PREPARE stmt;

	IF _has_exception THEN
		SET val = 0;
	END IF;

	SET result = val;
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_userInsert
DELIMITER //
CREATE PROCEDURE `sp_userInsert`(
	userName VARCHAR(60) , userPassword VARCHAR(60), description TEXT, email VARCHAR(100),
	emailSignature TEXT, calendar INT(11), smtp VARCHAR(45), port VARCHAR (45),
	emailUsername VARCHAR(45), emailPassword VARCHAR(45), userType TINYINT(4), 
	emailRequestConfirm BIT, emailUseSSL BIT, OUT userId INT)
BEGIN

	DECLARE allowInsert TINYINT DEFAULT 1; 

	DECLARE _salt CHAR(8) DEFAULT CAST(LEFT(SHA1(FLOOR(RAND() * POW(2, 32))), 8) AS CHAR(8) CHARACTER SET latin1);
	
	SET allowInsert = CONCAT(userName, userPassword) IS NOT NULL;
	SET userId = 0;
	
	SET emailRequestConfirm = IFNULL(emailRequestConfirm, 0);
	SET emailUseSSL = IFNULL(emailUseSSL, 0);
	
	IF allowInsert THEN
	
		SET userPassword = CAST(SHA1(CONCAT(userPassword, _salt)) AS CHAR(40) CHARACTER SET latin1);
	
		INSERT INTO utente SET 
			`nome` = userName, 
			`password`= userPassword, 
			`descrizione` = description, 
			`mail` = email,
			`firma` = emailSignature,
			`calendario` = calendar,
			`smtp` = smtp,
			`porta` = port,
			`nome_utente_mail` = emailUsername,
			`password_mail` = emailPassword,
			`tipo_utente` = userType,
			`mssl` = emailUseSSL,
			`conferma` = emailRequestConfirm,
			`salt` = _salt;
		
		SELECT LAST_INSERT_ID() INTO userId;
		
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_userUpdate
DELIMITER //
CREATE PROCEDURE `sp_userUpdate`(
	userId INT, userName VARCHAR(60) , userPassword VARCHAR(60), description TEXT, email VARCHAR(100),
	emailSignature TEXT, calendar INT(11), smtp VARCHAR(45), port VARCHAR (45),
	emailUsername VARCHAR(45), emailPassword VARCHAR(45), 
	emailRequestConfirm BIT, emailUseSSL BIT, userType TINYINT(4))
BEGIN

	DECLARE allowUpdate BIT DEFAULT 1; 
	
	SET allowUpdate = CONCAT(userId, userName, userPassword) IS NOT NULL;
	
	-- CONTROLLARE USERNAME PASSWORD E TIPO UTENTE

	IF allowUpdate THEN

		SELECT IFNULL(userName, `nome`), IFNULL(CAST(SHA1(CONCAT(userPassword, salt)) AS CHAR(40) CHARACTER SET latin1), `password`), 
			IFNULL(description, `descrizione`), IFNULL(email, `mail`), IFNULL(emailSignature, `firma`), IFNULL(calendar, `calendario`),
			IFNULL(smtp, `smtp`), IFNULL(port, `porta`), IFNULL(emailUsername, `nome_utente_mail`), IFNULL(emailPassword, `password_mail`), 
			IFNULL(userType, `tipo_utente`), IFNULL(emailUseSSL, `mssl`), IFNULL(emailRequestConfirm,`conferma`)
		INTO userName, userPassword, description, email, emailSignature, calendar, smtp,
			port, emailUsername, emailPassword, userType, emailUseSSL, emailRequestConfirm
		FROM utente
		WHERE id_utente = userId;
	
		UPDATE utente SET 
			`nome` = userName, 
			`password`= userPassword, 
			`descrizione` = description, 
			`mail` = email,
			`firma` = emailSignature,
			`calendario` = calendar,
			`smtp` = smtp,
			`porta` = port,
			`nome_utente_mail` = emailUsername,
			`password_mail` = emailPassword,
			`mssl` = emailUseSSL,
			`conferma` = emailRequestConfirm,
			`tipo_utente` = userType
		WHERE id_utente = userId;
		
	END IF;
	
END//
DELIMITER ;

-- Dump della struttura di procedura emmebi.sp_usrGetIDByUsername
DELIMITER //
CREATE PROCEDURE `sp_usrGetIDByUsername`(IN `username`                       VARCHAR(60), OUT `id_utente`                       INT)
BEGIN
SELECT utente.id_utente INTO id_utente
FROM utente
WHERE utente.Nome = username;
END//
DELIMITER ;

-- Dump della struttura di tabella emmebi.stampante
CREATE TABLE IF NOT EXISTS `stampante` (
  `Id_stampante` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(60) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`Id_stampante`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stampante_documento
CREATE TABLE IF NOT EXISTS `stampante_documento` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_documento` int(11) NOT NULL,
  `Stampante` varchar(100) NOT NULL,
  `copie` int(10) unsigned NOT NULL,
  `Id_utente` smallint(5) unsigned DEFAULT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_documento_Id_utente` (`Id_documento`,`Id_utente`)
) ENGINE=InnoDB AUTO_INCREMENT=38 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stampante_formati
CREATE TABLE IF NOT EXISTS `stampante_formati` (
  `Id` tinyint(4) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(20) NOT NULL,
  `Timestamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stampante_moduli
CREATE TABLE IF NOT EXISTS `stampante_moduli` (
  `id_documento` int(11) NOT NULL,
  `modulo` varchar(45) NOT NULL,
  `Id_modulo` int(11) NOT NULL,
  `mail` bit(1) NOT NULL DEFAULT b'1',
  `pdf` bit(1) NOT NULL DEFAULT b'1',
  `fax` bit(1) NOT NULL DEFAULT b'1',
  `stampa` bit(1) NOT NULL DEFAULT b'1',
  `anteprima` bit(1) NOT NULL DEFAULT b'1',
  `File_name` varchar(30) DEFAULT NULL,
  `Report_name` varchar(35) DEFAULT NULL,
  `Attivo` bit(1) NOT NULL DEFAULT b'1',
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_documento`,`Id_modulo`) USING BTREE,
  CONSTRAINT `Doc` FOREIGN KEY (`id_documento`) REFERENCES `tipo_documento` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stampante_moduli_formati
CREATE TABLE IF NOT EXISTS `stampante_moduli_formati` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_modulo` int(11) NOT NULL,
  `Id_documento` int(11) NOT NULL,
  `Id_formato` tinyint(4) NOT NULL,
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Id_modulo_Id_documento_Id_formato` (`Id_modulo`,`Id_documento`,`Id_formato`),
  KEY `Fk_stampante_moduli_formati_stampante_moduli1` (`Id_modulo`,`Id_documento`),
  KEY `Fk_stampante_moduli_formati_stampante_formati1` (`Id_formato`),
  KEY `Fk_stampante_moduli_formati_stampante_moduli` (`Id_documento`,`Id_modulo`),
  CONSTRAINT `Fk_stampante_moduli_formati_stampante_formati` FOREIGN KEY (`Id_formato`) REFERENCES `stampante_formati` (`Id`),
  CONSTRAINT `Fk_stampante_moduli_formati_stampante_moduli` FOREIGN KEY (`Id_documento`, `Id_modulo`) REFERENCES `stampante_moduli` (`id_documento`, `Id_modulo`)
) ENGINE=InnoDB AUTO_INCREMENT=101 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_automezzo
CREATE TABLE IF NOT EXISTS `stato_automezzo` (
  `id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(200) DEFAULT NULL,
  `colore` varchar(45) NOT NULL,
  `bloccato` tinyint(4) DEFAULT '0',
  PRIMARY KEY (`id_stato`),
  UNIQUE KEY `Index_2_colore` (`colore`),
  UNIQUE KEY `Index_3_nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_clienti
CREATE TABLE IF NOT EXISTS `stato_clienti` (
  `Id_stato` varchar(10) NOT NULL,
  `Nome` varchar(15) NOT NULL,
  `Descrizione` varchar(300) DEFAULT NULL,
  `bloccato` tinyint(1) DEFAULT '0',
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_commessa
CREATE TABLE IF NOT EXISTS `stato_commessa` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(30) NOT NULL,
  `Descrizione` varchar(100) NOT NULL,
  `colore` varchar(45) DEFAULT NULL,
  `Fine` int(11) NOT NULL,
  `bloccato` tinyint(4) DEFAULT '0',
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `nome` (`nome`),
  UNIQUE KEY `Index_3_colore` (`colore`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_com_lotto
CREATE TABLE IF NOT EXISTS `stato_com_lotto` (
  `id_stato` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `nome` varchar(60) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_stato`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_contratto
CREATE TABLE IF NOT EXISTS `stato_contratto` (
  `id_stato` int(10) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(200) NOT NULL,
  `colore` varchar(30) NOT NULL,
  PRIMARY KEY (`id_stato`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_ddt
CREATE TABLE IF NOT EXISTS `stato_ddt` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  `Colore` varchar(15) NOT NULL,
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_dpi
CREATE TABLE IF NOT EXISTS `stato_dpi` (
  `id_stato` tinyint(4) NOT NULL AUTO_INCREMENT,
  `descrizione` varchar(100) NOT NULL,
  `nome` varchar(30) NOT NULL,
  PRIMARY KEY (`id_stato`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_economico
CREATE TABLE IF NOT EXISTS `stato_economico` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(20) NOT NULL,
  `Descrizione` varchar(200) NOT NULL,
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_evento_gruppo
CREATE TABLE IF NOT EXISTS `stato_evento_gruppo` (
  `Id` tinyint(4) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(20) NOT NULL,
  `Colore` varchar(9) NOT NULL,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_fattura
CREATE TABLE IF NOT EXISTS `stato_fattura` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  `Colore` varchar(50) NOT NULL,
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_fornitore
CREATE TABLE IF NOT EXISTS `stato_fornitore` (
  `Id_stato` varchar(10) NOT NULL,
  `Nome` varchar(15) NOT NULL,
  `Descrizione` varchar(300) DEFAULT NULL,
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 COMMENT='aperto, chiuso,anche per fornitore';

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_impianto
CREATE TABLE IF NOT EXISTS `stato_impianto` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(25) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  `colore` varchar(45) DEFAULT NULL,
  `bloccato` tinyint(4) DEFAULT '0',
  `non_abbonato` bit(1) DEFAULT b'0',
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `Nome` (`Nome`),
  UNIQUE KEY `Index_3_color` (`colore`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_invio_abbonamento
CREATE TABLE IF NOT EXISTS `stato_invio_abbonamento` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(100) NOT NULL DEFAULT '',
  `colore` varchar(50) NOT NULL,
  `data_mod` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `colore` (`colore`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_notifica
CREATE TABLE IF NOT EXISTS `stato_notifica` (
  `id` smallint(6) NOT NULL AUTO_INCREMENT,
  `descrizione` varchar(50) NOT NULL,
  `abilitato` bit(1) NOT NULL,
  `rif_applicazioni` varchar(15) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_ordine
CREATE TABLE IF NOT EXISTS `stato_ordine` (
  `id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(200) DEFAULT NULL,
  `colore` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`id_stato`),
  UNIQUE KEY `Index_2_nome` (`nome`),
  UNIQUE KEY `Index_3_colore` (`colore`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_preventivo
CREATE TABLE IF NOT EXISTS `stato_preventivo` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` longtext,
  `colore` varchar(45) NOT NULL,
  `prior` int(11) NOT NULL DEFAULT '0',
  `bloccato` tinyint(4) DEFAULT '0',
  `reset_promemoria_invio` bit(1) DEFAULT b'0',
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `Index_2_colore` (`colore`),
  UNIQUE KEY `Index_3_nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_progetto
CREATE TABLE IF NOT EXISTS `stato_progetto` (
  `id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(45) NOT NULL,
  `Descrizione` varchar(100) NOT NULL,
  PRIMARY KEY (`id_stato`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_promemoria_cliente
CREATE TABLE IF NOT EXISTS `stato_promemoria_cliente` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(100) NOT NULL,
  `colore` varchar(25) NOT NULL,
  `rif_applicazioni` varchar(50) NOT NULL,
  `data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_rapporto
CREATE TABLE IF NOT EXISTS `stato_rapporto` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `colore` varchar(45) NOT NULL,
  `bloccato` tinyint(4) DEFAULT '0',
  `fatturato` bit(1) DEFAULT b'0',
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `Index_2_colore` (`colore`),
  UNIQUE KEY `Index_3_nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_resoconto
CREATE TABLE IF NOT EXISTS `stato_resoconto` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `colore` varchar(45) NOT NULL,
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_sottocommessa
CREATE TABLE IF NOT EXISTS `stato_sottocommessa` (
  `id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  PRIMARY KEY (`id_stato`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.stato_ticket
CREATE TABLE IF NOT EXISTS `stato_ticket` (
  `Id_stato` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  `fine` int(11) NOT NULL,
  `colore` varchar(45) NOT NULL,
  `aperto` bit(1) NOT NULL DEFAULT b'0',
  PRIMARY KEY (`Id_stato`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.storico_download_file
CREATE TABLE IF NOT EXISTS `storico_download_file` (
  `id_storico_download_file` int(11) NOT NULL AUTO_INCREMENT,
  `id_utente` int(11) NOT NULL,
  `id_operaio` int(11) DEFAULT NULL,
  `rif_applicazione` varchar(50) NOT NULL,
  `file_path` varchar(500) NOT NULL,
  `file_name` varchar(100) NOT NULL,
  `download_timestamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_storico_download_file`),
  KEY `FK__storico_download_file__utente` (`id_utente`),
  KEY `FK__storico_download_file__operaio` (`id_operaio`),
  CONSTRAINT `FK__storico_download_file__operaio` FOREIGN KEY (`id_operaio`) REFERENCES `operaio` (`Id_operaio`) ON UPDATE CASCADE,
  CONSTRAINT `FK__storico_download_file__utente` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di vista emmebi.subvw_depots_types_products
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `subvw_depots_types_products` (
	`Codice_articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Desc_brev` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Codice_fornitore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Marca` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Peso` DECIMAL(11,2) NOT NULL,
	`Altre_caratteristiche` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`scadenza` INT(11) NULL,
	`Fornitore_Priv` INT(11) NULL,
	`Tempo_installazione` INT(11) NOT NULL,
	`Categoria` INT(11) NULL,
	`Sottocategoria` INT(11) NULL,
	`sottocategoria2` INT(11) NULL,
	`Barcode` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`quantita_minima` INT(11) NOT NULL,
	`quantita_massima` INT(11) NOT NULL,
	`Numero_confezione` INT(11) NOT NULL,
	`unità_misura` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`ult_vendita` FLOAT(11,4) NULL,
	`Garanzia` INT(11) NULL,
	`Minuti_manutenzione` INT(11) NULL,
	`Stato_articolo` INT(11) NOT NULL,
	`Data_modifica` DATE NULL,
	`Data_inserimento` DATE NOT NULL,
	`umidità` INT(11) NULL,
	`min` INT(11) NULL,
	`max` INT(11) NULL,
	`l` INT(11) NULL,
	`h` INT(11) NULL,
	`p` INT(11) NULL,
	`modifica` TIMESTAMP NOT NULL,
	`kw` INT(11) NOT NULL,
	`litri` INT(11) NOT NULL,
	`kwp` INT(11) NOT NULL,
	`color` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`moltiplicatore` FLOAT(11,2) NOT NULL,
	`is_kit` TINYINT(1) NOT NULL,
	`scaffaliera_magazzino` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`ripiano_magazzino` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`descrizione_posizione_magazzino` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_tipo_costo_produzione` INT(11) NULL,
	`Id_tipo` INT(11) NOT NULL,
	`nome` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`prior` INT(11) NULL,
	`id_master` INT(11) NULL,
	`reso` TINYINT(4) NULL,
	`disabilitato` BIT(1) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.subvw_productsunionsearch
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `subvw_productsunionsearch` (
	`codice_articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`codice_fornitore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`barcode` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`codice` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`desc_brev` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`unità_misura` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`colore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Categoria` INT(11) NULL,
	`Sottocategoria` INT(11) NULL,
	`stato_articolo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`marca` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`tempo_installazione` INT(11) NOT NULL,
	`bloccato` TINYINT(4) UNSIGNED NOT NULL,
	`is_kit` TINYINT(4) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di tabella emmebi.tabella_errori_trigger
CREATE TABLE IF NOT EXISTS `tabella_errori_trigger` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `prezzovecchio` varchar(45) NOT NULL,
  `prezzonuovo` varchar(45) NOT NULL,
  `ora_data` datetime NOT NULL,
  `utente` varchar(45) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=3779 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tablet_configurazione
CREATE TABLE IF NOT EXISTS `tablet_configurazione` (
  `id_tablet` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `mail` varchar(100) NOT NULL,
  `testo_mail` text NOT NULL,
  `host` varchar(45) NOT NULL,
  `username` varchar(50) NOT NULL,
  `password` varchar(45) NOT NULL,
  `porta` int(10) unsigned NOT NULL,
  `display_name` varchar(30) DEFAULT NULL,
  `admin_password` varchar(20) NOT NULL DEFAULT 'admin',
  `messaggio_non_abbonato` text,
  `email_ufficio` varchar(100) DEFAULT NULL COMMENT 'Email dell''ufficio dove recapitare i rapporti mobile. Questa email sara usata in CCN',
  `data_ins` datetime DEFAULT NULL,
  `data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_tablet`)
) ENGINE=InnoDB AUTO_INCREMENT=40 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tab_stato
CREATE TABLE IF NOT EXISTS `tab_stato` (
  `id_stato` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  `tipo` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_stato`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tab_tipo
CREATE TABLE IF NOT EXISTS `tab_tipo` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(45) NOT NULL,
  `tipo_ins` int(11) NOT NULL,
  PRIMARY KEY (`id_tipo`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=52 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tag
CREATE TABLE IF NOT EXISTS `tag` (
  `id_tag` int(11) NOT NULL AUTO_INCREMENT,
  `tag` varchar(50) NOT NULL DEFAULT '',
  `tipo_documento` int(11) NOT NULL,
  `utente_ins` int(11) DEFAULT NULL,
  `utente_mod` int(11) DEFAULT NULL,
  `data_ins` datetime NOT NULL,
  `data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_tag`),
  UNIQUE KEY `tag_tipo_documento` (`tag`,`tipo_documento`),
  KEY `FK_tag_utente_mod` (`utente_mod`),
  KEY `FK_tag_utente_ins` (`utente_ins`),
  KEY `fk_tag_tipo_documento` (`tipo_documento`),
  CONSTRAINT `fk_tag_tipo_documento` FOREIGN KEY (`tipo_documento`) REFERENCES `tipo_documento` (`Id_tipo`),
  CONSTRAINT `FK_tag_utente_ins` FOREIGN KEY (`utente_ins`) REFERENCES `utente` (`Id_utente`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_tag_utente_mod` FOREIGN KEY (`utente_mod`) REFERENCES `utente` (`Id_utente`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tariffario
CREATE TABLE IF NOT EXISTS `tariffario` (
  `Id_tariffario` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `descrizione` varchar(200) DEFAULT NULL,
  `Costo_h` float(11,4) NOT NULL,
  `Prezzo` float(11,4) NOT NULL DEFAULT '0.0000',
  `Straordinario_p` float(11,2) NOT NULL,
  `Straordinario_c` float(11,2) NOT NULL,
  `costo_km` float(11,2) NOT NULL,
  `normale` tinyint(4) NOT NULL DEFAULT '0',
  PRIMARY KEY (`Id_tariffario`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.temp
CREATE TABLE IF NOT EXISTS `temp` (
  `tipo` text,
  `quantità` decimal(34,2) DEFAULT NULL,
  `prezzo` double DEFAULT NULL,
  `id` varchar(31) DEFAULT NULL,
  `unitario` double DEFAULT NULL,
  `UM` varchar(5) DEFAULT NULL,
  `costo` double DEFAULT NULL,
  `sconto` decimal(21,2) DEFAULT NULL,
  `codice_interno` varchar(11) DEFAULT NULL,
  `codice_fornitore` varchar(22) DEFAULT NULL,
  `marca` varchar(50) DEFAULT NULL,
  `ID_FIN` int(10) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`ID_FIN`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.temppreventivo
CREATE TABLE IF NOT EXISTS `temppreventivo` (
  `is_kit` bigint(20) NOT NULL DEFAULT '0',
  `cod_art_3` varchar(45) DEFAULT NULL,
  `codice_articolo2` varchar(11) DEFAULT NULL,
  `codice_articolo` varchar(11) DEFAULT NULL,
  `cod_forn2` varchar(22) DEFAULT NULL,
  `codice_fornitore` varchar(22) DEFAULT NULL,
  `descrizione3` varchar(50) DEFAULT NULL,
  `descrizione2` varchar(63) DEFAULT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `q2` varchar(58) DEFAULT NULL,
  `quantità` varchar(49) DEFAULT NULL,
  `id_lotto` int(11) NOT NULL DEFAULT '0',
  `lotto` varchar(250) NOT NULL DEFAULT '',
  `id_tab` int(11) NOT NULL DEFAULT '0',
  `ID_FIN` int(10) unsigned NOT NULL AUTO_INCREMENT,
  PRIMARY KEY (`ID_FIN`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ticket
CREATE TABLE IF NOT EXISTS `ticket` (
  `Id_ticket` int(11) NOT NULL,
  `Id_impianto` int(11) DEFAULT NULL,
  `data_ora` datetime DEFAULT NULL,
  `data_soluzione` date DEFAULT NULL,
  `Id_cliente` int(11) DEFAULT NULL,
  `Descrizione` text NOT NULL,
  `Causale` int(11) NOT NULL,
  `Urgenza` int(11) NOT NULL,
  `intervento` int(11) NOT NULL,
  `anno` int(11) NOT NULL,
  `Comunicazione` int(11) NOT NULL,
  `Id_destinazione` int(11) DEFAULT NULL,
  `sede_principale` int(11) DEFAULT NULL,
  `Stato_ticket` int(11) NOT NULL,
  `tempo` int(11) NOT NULL DEFAULT '0',
  `scadenza` date DEFAULT NULL,
  `id_evento_scadenza` int(10) unsigned DEFAULT NULL,
  `id_utente` int(11) DEFAULT NULL,
  `stampato` tinyint(4) NOT NULL DEFAULT '0',
  `data_ticket` date DEFAULT NULL,
  `num_tick` varchar(15) DEFAULT NULL,
  `inviato` int(10) unsigned DEFAULT '0',
  `data_promemoria` date DEFAULT NULL,
  `id_evento_promemoria` int(10) unsigned DEFAULT NULL,
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `data_ultimo_promemoria` datetime DEFAULT NULL,
  `id_stato_promemoria` int(11) NOT NULL DEFAULT '1',
  PRIMARY KEY (`Id_ticket`,`anno`),
  UNIQUE KEY `Id` (`Id`),
  KEY `Id_impianto` (`Id_impianto`),
  KEY `Id_cliente` (`Id_cliente`),
  KEY `intervento` (`intervento`),
  KEY `Causale` (`Causale`,`Urgenza`),
  KEY `Comunicazione` (`Comunicazione`),
  KEY `Stato_ticket` (`Stato_ticket`),
  KEY `dest_tick` (`Id_cliente`,`Id_destinazione`),
  KEY `Index_9` (`id_utente`),
  KEY `FK_ticket_evento_promemoria` (`id_evento_promemoria`),
  KEY `FK_ticket_evento_scadenza` (`id_evento_scadenza`),
  KEY `FK_ticket_stato_promemoria_cliente` (`id_stato_promemoria`),
  CONSTRAINT `dest_tick` FOREIGN KEY (`Id_cliente`, `Id_destinazione`) REFERENCES `destinazione_cliente` (`id_cliente`, `Id_destinazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ticket_8_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_ticket_evento_promemoria` FOREIGN KEY (`id_evento_promemoria`) REFERENCES `evento` (`Id`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_ticket_evento_scadenza` FOREIGN KEY (`id_evento_scadenza`) REFERENCES `evento` (`Id`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `FK_ticket_stato_promemoria_cliente` FOREIGN KEY (`id_stato_promemoria`) REFERENCES `stato_promemoria_cliente` (`id`),
  CONSTRAINT `ticket_ibfk_1` FOREIGN KEY (`Id_impianto`) REFERENCES `impianto` (`Id_impianto`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ticket_ibfk_2` FOREIGN KEY (`Id_cliente`) REFERENCES `clienti` (`Id_cliente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ticket_ibfk_3` FOREIGN KEY (`Causale`) REFERENCES `causale_ticket` (`Id_causale`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ticket_ibfk_4` FOREIGN KEY (`intervento`) REFERENCES `tipo_intervento` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ticket_ibfk_5` FOREIGN KEY (`Comunicazione`) REFERENCES `pervenuta_per` (`Id_modo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `ticket_ibfk_6` FOREIGN KEY (`Stato_ticket`) REFERENCES `stato_ticket` (`Id_stato`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=8214 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ticket_allegati
CREATE TABLE IF NOT EXISTS `ticket_allegati` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_ticket` int(11) NOT NULL,
  `anno_ticket` int(11) NOT NULL,
  `file_path` varchar(500) NOT NULL,
  `file_name` varchar(150) NOT NULL,
  `timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `utente_ins` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`) USING BTREE,
  UNIQUE KEY `file_path` (`file_path`) USING BTREE,
  KEY `FK_ticket_allegati_ticket` (`id_ticket`,`anno_ticket`),
  CONSTRAINT `FK_ticket_allegati_ticket` FOREIGN KEY (`id_ticket`, `anno_ticket`) REFERENCES `ticket` (`Id_ticket`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ticket_rapporto
CREATE TABLE IF NOT EXISTS `ticket_rapporto` (
  `Id_ticket` int(11) NOT NULL,
  `Id_rapporto` bigint(11) NOT NULL,
  `Anno_ticket` int(11) NOT NULL,
  `Anno_rapporto` int(11) NOT NULL,
  `tipo` tinyint(4) NOT NULL DEFAULT '1',
  PRIMARY KEY (`Id_ticket`,`Id_rapporto`,`Anno_ticket`,`Anno_rapporto`),
  KEY `Id_rapporto` (`Id_rapporto`),
  KEY `Anno_rapporto` (`Anno_rapporto`),
  KEY `ticket_rapporto_ibfk_2` (`Id_rapporto`,`Anno_rapporto`),
  KEY `ticket_rapporto_ibfk_1` (`Id_ticket`,`Anno_ticket`),
  CONSTRAINT `ticket_rapporto_ibfk_1` FOREIGN KEY (`Id_ticket`, `Anno_ticket`) REFERENCES `ticket` (`Id_ticket`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `ticket_rapporto_ibfk_2` FOREIGN KEY (`Id_rapporto`, `Anno_rapporto`) REFERENCES `rapporto` (`Id_rapporto`, `Anno`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ticket_stampa
CREATE TABLE IF NOT EXISTS `ticket_stampa` (
  `Id_ticket` int(11) DEFAULT NULL,
  `Id_rapporto` int(11) DEFAULT NULL,
  `Data` date DEFAULT NULL,
  `anno` int(11) DEFAULT NULL,
  `anno_ticket` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ticket_tag
CREATE TABLE IF NOT EXISTS `ticket_tag` (
  `id_ticket` int(11) NOT NULL,
  `anno_ticket` int(11) NOT NULL,
  `id_tag` int(11) NOT NULL,
  `utente_ins` int(11) DEFAULT NULL,
  `data_ins` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_ticket`,`anno_ticket`,`id_tag`),
  KEY `FK_ticket_tag_tag` (`id_tag`),
  KEY `FK_ticket_tag_ticket` (`id_ticket`,`anno_ticket`),
  KEY `FK_tag_utente_ins` (`utente_ins`),
  CONSTRAINT `FK_ticket_tag_tag` FOREIGN KEY (`id_tag`) REFERENCES `tag` (`id_tag`) ON UPDATE CASCADE,
  CONSTRAINT `FK_ticket_tag_ticket` FOREIGN KEY (`id_ticket`, `anno_ticket`) REFERENCES `ticket` (`Id_ticket`, `anno`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_ticket_tag_utente_ins` FOREIGN KEY (`utente_ins`) REFERENCES `utente` (`Id_utente`) ON DELETE SET NULL ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.ticket_tipo_evento
CREATE TABLE IF NOT EXISTS `ticket_tipo_evento` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipologia_tipo_evento
CREATE TABLE IF NOT EXISTS `tipologia_tipo_evento` (
  `Id` tinyint(4) NOT NULL AUTO_INCREMENT,
  `Descrizione` varchar(25) NOT NULL DEFAULT '0',
  `Rif_applicazione` varchar(20) NOT NULL DEFAULT '0',
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1 COMMENT='Tabella contenente le tipologie dei vari tipi evento. Per Esempio se per clinete, per impianto, per tecnico, nulla';

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_anomalia_rapporto
CREATE TABLE IF NOT EXISTS `tipo_anomalia_rapporto` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(100) NOT NULL,
  `descrizione` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_area
CREATE TABLE IF NOT EXISTS `tipo_area` (
  `id_tipo` int(10) unsigned NOT NULL,
  `comune` varchar(45) NOT NULL,
  `regione` varchar(45) NOT NULL,
  `provincia` varchar(45) NOT NULL,
  `NordOvest` varchar(45) NOT NULL,
  `NordEst` varchar(45) NOT NULL,
  `centro` varchar(45) NOT NULL,
  `sud` varchar(45) NOT NULL,
  `isole` varchar(45) NOT NULL,
  `estero` varchar(45) NOT NULL,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(45) NOT NULL,
  PRIMARY KEY (`id_tipo`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_attivita
CREATE TABLE IF NOT EXISTS `tipo_attivita` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(100) NOT NULL,
  `descrizione` varchar(150) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=22 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_autostrada
CREATE TABLE IF NOT EXISTS `tipo_autostrada` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `importo` double(11,2) DEFAULT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_tipo`),
  UNIQUE KEY `Index_2` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=40 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_azienda
CREATE TABLE IF NOT EXISTS `tipo_azienda` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_bkop
CREATE TABLE IF NOT EXISTS `tipo_bkop` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_campagna_aries
CREATE TABLE IF NOT EXISTS `tipo_campagna_aries` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `uuid` char(36) NOT NULL,
  `nome` varchar(50) NOT NULL DEFAULT '0',
  `rif_applicazione` varchar(50) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `rif_applicazione` (`rif_applicazione`),
  UNIQUE KEY `idx_tipo_campagna_aries_uuid` (`uuid`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_checklist_elemento
CREATE TABLE IF NOT EXISTS `tipo_checklist_elemento` (
  `Id` tinyint(4) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `RifApplicazioni` varchar(25) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_checklist_model_elemento_def_valore
CREATE TABLE IF NOT EXISTS `tipo_checklist_model_elemento_def_valore` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `Id_tipo` tinyint(4) NOT NULL,
  `Nome` varchar(100) NOT NULL,
  `Field` varchar(100) NOT NULL,
  `Field_type` varchar(50) NOT NULL,
  PRIMARY KEY (`Id`),
  KEY `id_tipo_checklist_model_valore` (`Id_tipo`),
  CONSTRAINT `id_tipo_checklist_model_valore` FOREIGN KEY (`Id_tipo`) REFERENCES `tipo_checklist_elemento` (`Id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=92 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_cliente
CREATE TABLE IF NOT EXISTS `tipo_cliente` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(20) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=1003 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_collegamento_impianto
CREATE TABLE IF NOT EXISTS `tipo_collegamento_impianto` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(55) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_commessa
CREATE TABLE IF NOT EXISTS `tipo_commessa` (
  `id_tipo` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `nome` varchar(60) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_com_fat
CREATE TABLE IF NOT EXISTS `tipo_com_fat` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(60) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_contratto
CREATE TABLE IF NOT EXISTS `tipo_contratto` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_contratto_stampa
CREATE TABLE IF NOT EXISTS `tipo_contratto_stampa` (
  `id_tipo_stampa` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  PRIMARY KEY (`id_tipo_stampa`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_corso
CREATE TABLE IF NOT EXISTS `tipo_corso` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  `durata` int(11) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_costo_produzione
CREATE TABLE IF NOT EXISTS `tipo_costo_produzione` (
  `id_tipo` int(11) NOT NULL,
  `nome` varchar(50) NOT NULL DEFAULT '',
  `descrizione` varchar(255) NOT NULL DEFAULT '',
  PRIMARY KEY (`id_tipo`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_documento
CREATE TABLE IF NOT EXISTS `tipo_documento` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=31 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_edificio
CREATE TABLE IF NOT EXISTS `tipo_edificio` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Descrizione` longtext,
  PRIMARY KEY (`Id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_evento
CREATE TABLE IF NOT EXISTS `tipo_evento` (
  `id_tipo` tinyint(3) unsigned NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `colore` varchar(45) NOT NULL,
  `Id_tipologia` tinyint(4) DEFAULT '1',
  `Timestamp` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_tipo`) USING BTREE,
  UNIQUE KEY `col` (`colore`),
  KEY `FK_Tipologia_tipo_evento` (`Id_tipologia`),
  CONSTRAINT `FK_Tipologia_tipo_evento` FOREIGN KEY (`Id_tipologia`) REFERENCES `tipologia_tipo_evento` (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=71 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_fattura
CREATE TABLE IF NOT EXISTS `tipo_fattura` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `tipo_PA` varchar(5) DEFAULT NULL COMMENT 'Tipo di fattura elettronica.',
  `movimenta_magazzino` bit(1) DEFAULT b'0',
  PRIMARY KEY (`id_tipo`),
  KEY `tipo_PA` (`tipo_PA`)
) ENGINE=InnoDB AUTO_INCREMENT=27 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_fornitore
CREATE TABLE IF NOT EXISTS `tipo_fornitore` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(30) NOT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_tipo`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_funzione
CREATE TABLE IF NOT EXISTS `tipo_funzione` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `ordi` int(11) DEFAULT NULL,
  `descrizione` text,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_impabbo
CREATE TABLE IF NOT EXISTS `tipo_impabbo` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_impianto
CREATE TABLE IF NOT EXISTS `tipo_impianto` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(30) NOT NULL,
  `descrizione` varchar(150) DEFAULT NULL,
  `Utente_mod` smallint(6) NOT NULL,
  `Data_mod` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=77 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_intervento
CREATE TABLE IF NOT EXISTS `tipo_intervento` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `studi_settore` bit(1) DEFAULT b'0',
  `prezzo_da_abbonamento` bit(1) DEFAULT b'0',
  PRIMARY KEY (`Id_tipo`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_intprev
CREATE TABLE IF NOT EXISTS `tipo_intprev` (
  `id_tipo` int(10) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_iva
CREATE TABLE IF NOT EXISTS `tipo_iva` (
  `Id_iva` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `aliquota` int(11) NOT NULL,
  `MESSAGGIO` varchar(110) DEFAULT NULL,
  `normale` tinyint(4) DEFAULT '0',
  `esigibilita` varchar(5) DEFAULT NULL,
  `in_uso` tinyint(4) NOT NULL DEFAULT '1',
  PRIMARY KEY (`Id_iva`)
) ENGINE=InnoDB AUTO_INCREMENT=33 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_jump
CREATE TABLE IF NOT EXISTS `tipo_jump` (
  `id_jump` int(11) NOT NULL,
  `nome` varchar(45) NOT NULL,
  PRIMARY KEY (`id_jump`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_magazzino
CREATE TABLE IF NOT EXISTS `tipo_magazzino` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  `prior` int(11) DEFAULT NULL,
  `id_master` int(11) DEFAULT NULL,
  `reso` tinyint(4) DEFAULT NULL,
  `disabilitato` bit(1) NOT NULL DEFAULT b'0',
  PRIMARY KEY (`Id_tipo`),
  UNIQUE KEY `nome` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=33 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_materiale
CREATE TABLE IF NOT EXISTS `tipo_materiale` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) DEFAULT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_natura_iva
CREATE TABLE IF NOT EXISTS `tipo_natura_iva` (
  `id_tipo_natura_iva` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(100) NOT NULL,
  `descrizione` varchar(350) NOT NULL,
  `tipo_PA` varchar(10) NOT NULL,
  `messaggio_fattura` text NOT NULL,
  `nota_fattura` text NOT NULL,
  `abilitato` bit(1) NOT NULL DEFAULT b'1',
  `data_mod` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_tipo_natura_iva`),
  UNIQUE KEY `tipo_pa` (`tipo_PA`)
) ENGINE=InnoDB AUTO_INCREMENT=25 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_normativa
CREATE TABLE IF NOT EXISTS `tipo_normativa` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_nota
CREATE TABLE IF NOT EXISTS `tipo_nota` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(70) NOT NULL,
  PRIMARY KEY (`id_tipo`),
  UNIQUE KEY `nom` (`nome`)
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_notifica
CREATE TABLE IF NOT EXISTS `tipo_notifica` (
  `id` smallint(6) NOT NULL AUTO_INCREMENT,
  `descrizione` varchar(50) NOT NULL,
  `abilitato` bit(1) NOT NULL,
  `id_traduzione` int(11) NOT NULL,
  `rif_applicazioni` varchar(15) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_operaio
CREATE TABLE IF NOT EXISTS `tipo_operaio` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_pagamento
CREATE TABLE IF NOT EXISTS `tipo_pagamento` (
  `id_Tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(75) DEFAULT NULL,
  PRIMARY KEY (`id_Tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_pagamento_data_posticipa
CREATE TABLE IF NOT EXISTS `tipo_pagamento_data_posticipa` (
  `data` date NOT NULL,
  `giorni` int(11) NOT NULL,
  PRIMARY KEY (`data`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_preventivo
CREATE TABLE IF NOT EXISTS `tipo_preventivo` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  `id_tipo_contratto` int(11) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id_tipo`),
  KEY `FK_tipo_preventivo_id_tipo_contratto` (`id_tipo_contratto`),
  CONSTRAINT `FK_tipo_preventivo_id_tipo_contratto` FOREIGN KEY (`id_tipo_contratto`) REFERENCES `tipo_contratto` (`id_tipo`) ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_progetti
CREATE TABLE IF NOT EXISTS `tipo_progetti` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_rapclie
CREATE TABLE IF NOT EXISTS `tipo_rapclie` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=20 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_rapforn
CREATE TABLE IF NOT EXISTS `tipo_rapforn` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_rapporto
CREATE TABLE IF NOT EXISTS `tipo_rapporto` (
  `id` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL DEFAULT '',
  `attivo` bit(1) DEFAULT b'1',
  `data_ins` timestamp NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_resoconto
CREATE TABLE IF NOT EXISTS `tipo_resoconto` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(150) DEFAULT NULL,
  `economia` bit(1) DEFAULT b'0',
  `ghost` bit(1) DEFAULT b'0',
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_ricarica
CREATE TABLE IF NOT EXISTS `tipo_ricarica` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(145) NOT NULL,
  `note` text,
  `importo` double(11,2) NOT NULL DEFAULT '0.00',
  `durata` int(11) NOT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=19 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_ricarica2
CREATE TABLE IF NOT EXISTS `tipo_ricarica2` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(145) NOT NULL,
  `importo` double(11,2) NOT NULL DEFAULT '0.00',
  `durata` int(11) NOT NULL DEFAULT '0',
  `Note` text,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_rischio
CREATE TABLE IF NOT EXISTS `tipo_rischio` (
  `id_rischio` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_rischio`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_serial_number
CREATE TABLE IF NOT EXISTS `tipo_serial_number` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_spesa
CREATE TABLE IF NOT EXISTS `tipo_spesa` (
  `Id_tipo` int(11) NOT NULL,
  `nome` varchar(45) NOT NULL,
  `Operazione` char(2) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  `trasf` int(10) unsigned DEFAULT '0',
  `appartenenza` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`),
  UNIQUE KEY `Descrizione` (`nome`,`Operazione`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_subappalto
CREATE TABLE IF NOT EXISTS `tipo_subappalto` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id_tipo`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_titolo
CREATE TABLE IF NOT EXISTS `tipo_titolo` (
  `id_titolo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(20) NOT NULL,
  `articolo` varchar(10) NOT NULL,
  PRIMARY KEY (`id_titolo`)
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_uscita
CREATE TABLE IF NOT EXISTS `tipo_uscita` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`),
  UNIQUE KEY `Nome` (`Nome`),
  UNIQUE KEY `Nome_2` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=17 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_utente
CREATE TABLE IF NOT EXISTS `tipo_utente` (
  `id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(45) NOT NULL,
  `descrizione` varchar(45) NOT NULL,
  `clienti` int(11) NOT NULL DEFAULT '0',
  `rapporto` int(11) NOT NULL DEFAULT '0',
  `impianto` int(11) NOT NULL DEFAULT '0',
  `ddt` int(11) NOT NULL DEFAULT '0',
  `ticket` int(11) NOT NULL DEFAULT '0',
  `resoconto` int(11) NOT NULL DEFAULT '0',
  `ddtr` int(11) NOT NULL DEFAULT '0',
  `fatturar` int(11) NOT NULL DEFAULT '0',
  `fornitore` int(11) NOT NULL DEFAULT '0',
  `normative` int(11) NOT NULL DEFAULT '0',
  `dico` int(11) NOT NULL DEFAULT '0',
  `pos` int(11) NOT NULL DEFAULT '0',
  `duvri` int(11) NOT NULL DEFAULT '0',
  `articolo` int(11) NOT NULL DEFAULT '0',
  `fattura` int(11) NOT NULL DEFAULT '0',
  `dipendente` int(11) NOT NULL DEFAULT '0',
  `lista` int(11) NOT NULL DEFAULT '0',
  `modifica_impostazioni` int(11) NOT NULL DEFAULT '0',
  `marca` int(11) NOT NULL DEFAULT '0',
  `preventivo` int(11) NOT NULL DEFAULT '0',
  `commessa` int(11) NOT NULL DEFAULT '0',
  `abbonamento` int(11) NOT NULL DEFAULT '0',
  `magazzino` int(11) NOT NULL DEFAULT '0',
  `calendario` int(11) NOT NULL DEFAULT '0',
  `visite` int(11) NOT NULL DEFAULT '0',
  `prima_nota` int(11) NOT NULL DEFAULT '0',
  `mail` int(11) NOT NULL DEFAULT '0',
  `ordine` int(11) NOT NULL DEFAULT '0',
  `ordine_fornitore` int(11) NOT NULL DEFAULT '0',
  `impianto_tecnico` int(11) NOT NULL DEFAULT '0',
  `DareAvere` int(11) NOT NULL DEFAULT '0',
  `Documenti_Desktop` int(11) NOT NULL DEFAULT '0',
  `Eventi` int(11) NOT NULL DEFAULT '0',
  `Mail_Invio` int(11) NOT NULL DEFAULT '0',
  `Firme_convalida_rapporto` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_tipo`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_utente_permessi
CREATE TABLE IF NOT EXISTS `tipo_utente_permessi` (
  `id_form` int(11) NOT NULL,
  `id_tutente` int(11) NOT NULL,
  `inserisci` tinyint(4) NOT NULL DEFAULT '0',
  `modifica` tinyint(4) NOT NULL DEFAULT '0',
  `elimina` tinyint(4) NOT NULL DEFAULT '0',
  `stampa` tinyint(4) NOT NULL DEFAULT '0',
  `documenti` tinyint(4) NOT NULL DEFAULT '0',
  `prezzi` tinyint(4) NOT NULL DEFAULT '0',
  `totali` tinyint(4) NOT NULL DEFAULT '0',
  `firme` tinyint(4) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id_form`,`id_tutente`) USING BTREE,
  KEY `Index_2_tute` (`id_tutente`),
  CONSTRAINT `FK_tipo_utente_permessi_1` FOREIGN KEY (`id_tutente`) REFERENCES `tipo_utente` (`id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_tipo_utente_permessi_2_jump` FOREIGN KEY (`id_form`) REFERENCES `tipo_jump` (`id_jump`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_utente_permessi_speciali
CREATE TABLE IF NOT EXISTS `tipo_utente_permessi_speciali` (
  `id_permesso` int(11) NOT NULL AUTO_INCREMENT,
  `id_form` int(11) NOT NULL,
  `nome` varchar(100) NOT NULL,
  PRIMARY KEY (`id_permesso`),
  UNIQUE KEY `Index_2_nome` (`id_form`,`nome`),
  CONSTRAINT `FK_tipo_utente_permessi_speciali_1_form` FOREIGN KEY (`id_form`) REFERENCES `tipo_jump` (`id_jump`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_utente_perspe_check
CREATE TABLE IF NOT EXISTS `tipo_utente_perspe_check` (
  `id_tutente` int(11) NOT NULL,
  `id_permesso` int(11) NOT NULL,
  PRIMARY KEY (`id_tutente`,`id_permesso`),
  KEY `FK_tipo_utente_perspe_check_2_perme` (`id_permesso`),
  CONSTRAINT `FK_tipo_utente_perspe_check_2_perme` FOREIGN KEY (`id_permesso`) REFERENCES `tipo_utente_permessi_speciali` (`id_permesso`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_tipo_utente_perspe_check_2_uten` FOREIGN KEY (`id_tutente`) REFERENCES `tipo_utente` (`id_tipo`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tipo_vigilante
CREATE TABLE IF NOT EXISTS `tipo_vigilante` (
  `Id_tipo` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(30) NOT NULL,
  `Descrizione` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`Id_tipo`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tmp_job_hours_worked
CREATE TABLE IF NOT EXISTS `tmp_job_hours_worked` (
  `svolte` decimal(11,2) DEFAULT NULL,
  `Id_sottocommessa` int(11) DEFAULT NULL,
  `Id_lotto` int(11) DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.tokenrefresh
CREATE TABLE IF NOT EXISTS `tokenrefresh` (
  `id_token` int(11) NOT NULL AUTO_INCREMENT,
  `id_utente` int(11) NOT NULL,
  `deadline` datetime NOT NULL,
  PRIMARY KEY (`id_token`),
  KEY `FK_TokenRefresh_id_utente` (`id_utente`)
) ENGINE=InnoDB AUTO_INCREMENT=53433 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.trasporto_cura
CREATE TABLE IF NOT EXISTS `trasporto_cura` (
  `Id_trasporto` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(40) NOT NULL,
  `Descrizione` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id_trasporto`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.unita_misura
CREATE TABLE IF NOT EXISTS `unita_misura` (
  `Id` smallint(6) NOT NULL AUTO_INCREMENT,
  `Descrizione` varchar(100) NOT NULL,
  `sigla` varchar(5) NOT NULL,
  `Nome` varchar(20) NOT NULL,
  PRIMARY KEY (`sigla`),
  UNIQUE KEY `Id` (`Id`)
) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.urgenza
CREATE TABLE IF NOT EXISTS `urgenza` (
  `Id_urgenza` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) NOT NULL DEFAULT '',
  `Descrizione` text,
  PRIMARY KEY (`Id_urgenza`) USING BTREE,
  UNIQUE KEY `Nome` (`Nome`) USING BTREE
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente
CREATE TABLE IF NOT EXISTS `utente` (
  `Id_utente` int(11) NOT NULL AUTO_INCREMENT,
  `Password` varchar(60) NOT NULL,
  `Nome` varchar(60) NOT NULL,
  `Descrizione` text,
  `mail` varchar(100) DEFAULT NULL,
  `Firma` text,
  `calendario` int(11) NOT NULL,
  `smtp` varchar(45) DEFAULT NULL,
  `porta` smallint(6) DEFAULT NULL,
  `mssl` bit(1) DEFAULT NULL,
  `nome_utente_mail` varchar(45) DEFAULT NULL,
  `password_mail` varchar(45) DEFAULT NULL,
  `tipo_utente` int(11) DEFAULT '1',
  `conferma` tinyint(4) DEFAULT '0',
  `salt` char(8) NOT NULL DEFAULT '',
  PRIMARY KEY (`Id_utente`),
  UNIQUE KEY `Nome` (`Nome`)
) ENGINE=InnoDB AUTO_INCREMENT=21 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente_chat
CREATE TABLE IF NOT EXISTS `utente_chat` (
  `id_chat` int(11) NOT NULL AUTO_INCREMENT,
  `data` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `descrizione` text NOT NULL,
  `mittente` int(11) NOT NULL,
  `destinatario` int(11) NOT NULL,
  `notifica` tinyint(4) NOT NULL DEFAULT '1',
  `letto` tinyint(4) NOT NULL DEFAULT '1',
  `id_discussione` int(11) NOT NULL,
  `id_impianto` int(11) unsigned DEFAULT NULL,
  PRIMARY KEY (`id_chat`,`id_discussione`,`destinatario`) USING BTREE,
  KEY `FK_utente_chat_3` (`id_discussione`),
  KEY `FK_utente_chat_2` (`mittente`),
  KEY `FK_utente_chat_1` (`destinatario`),
  CONSTRAINT `FK_utente_chat_1` FOREIGN KEY (`destinatario`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_utente_chat_2` FOREIGN KEY (`mittente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `FK_utente_chat_3` FOREIGN KEY (`id_discussione`) REFERENCES `utente_discussione` (`id_discussione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=49 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente_discussione
CREATE TABLE IF NOT EXISTS `utente_discussione` (
  `id_discussione` int(11) NOT NULL AUTO_INCREMENT,
  `id_utente` int(11) NOT NULL,
  `data` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `oggetto` varchar(245) NOT NULL,
  PRIMARY KEY (`id_discussione`),
  KEY `FK_utente_discussione_1` (`id_utente`),
  CONSTRAINT `FK_utente_discussione_1` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente_firma
CREATE TABLE IF NOT EXISTS `utente_firma` (
  `id_documento` int(10) NOT NULL AUTO_INCREMENT,
  `id_utente` int(10) NOT NULL,
  `stampa` tinyint(3) unsigned NOT NULL,
  `mail` tinyint(3) unsigned NOT NULL,
  PRIMARY KEY (`id_documento`,`id_utente`),
  KEY `FK_utente_firma_2_utenti` (`id_utente`),
  CONSTRAINT `FK_utente_firma_1_jump` FOREIGN KEY (`id_documento`) REFERENCES `tipo_jump` (`id_jump`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_utente_firma_2_utenti` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente_firma_documento
CREATE TABLE IF NOT EXISTS `utente_firma_documento` (
  `id_utente` int(10) unsigned NOT NULL,
  `data` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `nota` text NOT NULL,
  `anno` int(10) unsigned NOT NULL,
  `id_documento` int(10) unsigned NOT NULL,
  `id` int(10) unsigned NOT NULL,
  PRIMARY KEY (`id_utente`,`anno`,`id_documento`,`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente_mail
CREATE TABLE IF NOT EXISTS `utente_mail` (
  `id_utente` int(11) NOT NULL COMMENT 'Id tipo utente',
  `id_utente_mail` int(11) NOT NULL COMMENT 'id_utente',
  PRIMARY KEY (`id_utente`,`id_utente_mail`),
  KEY `FK_utente_mail_1` (`id_utente_mail`),
  CONSTRAINT `FK_utente_mail_1` FOREIGN KEY (`id_utente_mail`) REFERENCES `utente` (`Id_utente`),
  CONSTRAINT `FK_utente_mail_2` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente_roles
CREATE TABLE IF NOT EXISTS `utente_roles` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(50) NOT NULL,
  `descrizione` text NOT NULL,
  `app_name` varchar(50) NOT NULL,
  `max_utenti_assegnabili` int(10) NOT NULL DEFAULT '1',
  `min_utenti_assegnabili` int(10) NOT NULL DEFAULT '1',
  `timestamp` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente_servizio
CREATE TABLE IF NOT EXISTS `utente_servizio` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `nome` varchar(60) NOT NULL,
  `app_name` varchar(60) NOT NULL,
  `email` varchar(100) DEFAULT NULL,
  `firma` text,
  `smtp` varchar(45) DEFAULT NULL,
  `porta` smallint(6) DEFAULT NULL,
  `mssl` bit(1) DEFAULT NULL,
  `email_username` varchar(45) DEFAULT NULL,
  `email_password` varchar(45) DEFAULT NULL,
  `display_name` varchar(45) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `Nome` (`nome`),
  UNIQUE KEY `Colonna 3` (`app_name`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utente_utente_roles
CREATE TABLE IF NOT EXISTS `utente_utente_roles` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `id_utente` int(11) NOT NULL DEFAULT '0',
  `id_utente_roles` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_utente_id_utente_roles` (`id_utente`,`id_utente_roles`),
  KEY `FK_utente_utente_roles_id_ut_ro` (`id_utente_roles`),
  CONSTRAINT `FK_utente_utente_roles_id_ut` FOREIGN KEY (`id_utente`) REFERENCES `utente` (`Id_utente`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_utente_utente_roles_id_ut_ro` FOREIGN KEY (`id_utente_roles`) REFERENCES `utente_roles` (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.utenti_avviso_rapporto
CREATE TABLE IF NOT EXISTS `utenti_avviso_rapporto` (
  `id_utente` int(10) unsigned NOT NULL DEFAULT '0',
  `id_azienda` int(10) unsigned NOT NULL,
  PRIMARY KEY (`id_utente`,`id_azienda`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.vettore
CREATE TABLE IF NOT EXISTS `vettore` (
  `Id_vettore` int(11) NOT NULL AUTO_INCREMENT,
  `Nome` varchar(50) DEFAULT NULL,
  `Note` text,
  `Comune` int(11) DEFAULT NULL,
  `Frazione` int(11) DEFAULT NULL,
  `Indirizzo` varchar(200) DEFAULT NULL,
  `Telefono` varchar(13) DEFAULT NULL,
  `mail` varchar(100) DEFAULT NULL,
  `al_tel` varchar(13) DEFAULT NULL,
  `fax` varchar(13) DEFAULT NULL,
  `codice` varchar(45) DEFAULT NULL,
  `resp_nome` varchar(45) DEFAULT NULL,
  `resp_tel` varchar(13) DEFAULT NULL,
  `resp_mail` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`Id_vettore`),
  KEY `Provincia` (`Comune`,`Frazione`) USING BTREE,
  KEY `FK_vettore_2_fra` (`Frazione`),
  CONSTRAINT `FK_vettore_1_com` FOREIGN KEY (`Comune`) REFERENCES `comune` (`Id_comune`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `FK_vettore_2_fra` FOREIGN KEY (`Frazione`) REFERENCES `frazione` (`Id_frazione`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di tabella emmebi.vigilante
CREATE TABLE IF NOT EXISTS `vigilante` (
  `Id_vigilante` int(11) NOT NULL AUTO_INCREMENT,
  `tipo` int(11) DEFAULT NULL,
  `Descrizione` varchar(30) DEFAULT NULL,
  `Comune` int(11) DEFAULT NULL,
  `Frazione` int(11) DEFAULT NULL,
  `Indirizzo` varchar(30) DEFAULT NULL,
  `Telefono` varchar(15) DEFAULT NULL,
  `altro_telefono` varchar(15) DEFAULT NULL,
  `Analogico` varchar(15) DEFAULT NULL,
  `Digitale` varchar(15) DEFAULT NULL,
  `riferimento` varchar(45) DEFAULT NULL,
  `mail` varchar(145) DEFAULT NULL,
  `cellulare` varchar(15) DEFAULT NULL,
  `fax` varchar(15) DEFAULT NULL,
  `numero_verde` varchar(15) DEFAULT NULL,
  PRIMARY KEY (`Id_vigilante`),
  UNIQUE KEY `Descrizione` (`Descrizione`),
  KEY `tipo` (`tipo`),
  KEY `Comune` (`Comune`,`Frazione`),
  KEY `frazione` (`Frazione`),
  CONSTRAINT `frazione` FOREIGN KEY (`Frazione`) REFERENCES `frazione` (`Id_frazione`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `vigilante_ibfk_1` FOREIGN KEY (`tipo`) REFERENCES `tipo_vigilante` (`Id_tipo`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `vigilante_ibfk_3` FOREIGN KEY (`Comune`) REFERENCES `comune` (`Id_comune`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=13 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di vista emmebi.vw_contatsexport
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_contatsexport` (
	`ragione_sociale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`paese` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`cap` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`data_inserimento` DATE NULL,
	`nome` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`status` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`figura` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`abbreviazione_figura` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`altro_telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`fax` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`centralino` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`mail` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id` INT(11) NOT NULL,
	`record_type` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`id_pubblico` CHAR(36) NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_customerinsolvent
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_customerinsolvent` (
	`Id_Cliente` INT(11) NOT NULL,
	`Ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Citta` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`CAP` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Civico` INT(6) NOT NULL,
	`Telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Cellulare` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_customersexport
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_customersexport` (
	`id_cliente` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`paese` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`cap` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`data_inserimento` DATE NULL,
	`nome` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`status` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`id_tipo_cliente` INT(11) NOT NULL,
	`tipo_cliente` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`tipo_rapporto` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`tipo_attivita` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`figura` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`altro_telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`fax` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`centralino` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`mail` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`tempo_strada` SMALLINT(6) NULL,
	`km_sede` SMALLINT(6) NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_dashboardgridsystemperiodicmonitoring
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_dashboardgridsystemperiodicmonitoring` (
	`id` INT(11) NULL,
	`id_mese` INT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`id_impianto` INT(11) NULL,
	`descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`cliente` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`svolto` BIGINT(20) NOT NULL,
	`tipo` BIGINT(20) NOT NULL,
	`da_eseguire` DATE NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_dashboardgridsystemreminder
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_dashboardgridsystemreminder` (
	`id` INT(11) NOT NULL,
	`id_mese` INT(11) NOT NULL,
	`anno` INT(1) NOT NULL,
	`id_impianto` INT(11) NOT NULL,
	`descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`cliente` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`svolto` INT(1) NOT NULL,
	`tipo` INT(1) NOT NULL,
	`da_eseguire` BINARY(0) NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_depotsoperations
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_depotsoperations` (
	`ID` BIGINT(20) NOT NULL,
	`codice_articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`id_magazzino` INT(11) NOT NULL,
	`tipo_magazzino` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`data_ins` DATE NOT NULL,
	`data_operazione` DATE NULL,
	`quantità` FLOAT(11,2) NOT NULL,
	`nome_causale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Causale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`documento` VARCHAR(1) NULL COLLATE 'utf8mb4_general_ci',
	`ragione_sociale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_doc` BIGINT(20) NULL,
	`anno_doc` INT(11) NULL,
	`sorgente` INT(11) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_depotsoperationsnotordered
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_depotsoperationsnotordered` (
	`ID` BIGINT(20) NOT NULL,
	`codice_articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`id_magazzino` INT(11) NOT NULL,
	`tipo_magazzino` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`data_ins` DATE NOT NULL,
	`data_operazione` DATE NULL,
	`quantità` FLOAT(11,2) NOT NULL,
	`nome_causale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Causale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`documento` VARCHAR(1) NULL COLLATE 'utf8mb4_general_ci',
	`ragione_sociale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_doc` BIGINT(20) NULL,
	`anno_doc` INT(11) NULL,
	`sorgente` INT(11) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_depotsproducts
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_depotsproducts` (
	`codice_articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`id_stato_articolo` INT(11) NOT NULL,
	`stato_articolo_colore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`codice_fornitore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`giacenza` DECIMAL(11,2) NOT NULL,
	`marca` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`categoria` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`sottocategoria` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`prezzo` DECIMAL(10,2) NULL,
	`costo` DECIMAL(10,2) NULL,
	`tipo_magazzino` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`id_tipo_magazzino` INT(11) NOT NULL,
	`data_ultimo_movimento` DATETIME NOT NULL,
	`Data_mod` TIMESTAMP NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_depots_all_products
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_depots_all_products` (
	`Stato` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Cod. Articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Cod. Fornitore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Tipo Magazzino` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Visibile Magazzino` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`Giacenza` DECIMAL(11,2) NOT NULL,
	`Marca` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Categoria Merceologica` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Scaffale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Ripiano` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Barcode` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Prezzo` DECIMAL(11,4) NULL,
	`Costo` DECIMAL(11,4) NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_invoices_payments_details
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_invoices_payments_details` (
	`id_fattura` INT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`data_fattura` DATE NOT NULL,
	`id_pagamento` INT(11) NULL,
	`id_cliente` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`condizione_pagamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_tipo_pagamento` BIGINT(11) NULL,
	`tipo_pagamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`importo_fattura` FLOAT(11,2) NOT NULL,
	`importo_pagamento` DOUBLE(19,2) NULL,
	`totale_acconti` DECIMAL(33,2) NULL,
	`numero_rate` INT(10) UNSIGNED NOT NULL,
	`data_pagamento_prevista` DATE NULL,
	`data_pagamento_effettiva` DATE NULL,
	`pagato` INT(1) NOT NULL,
	`descrizione_pagamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`data_ultimo_promemoria` DATE NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_jobbody
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_jobbody` (
	`Id_commessa` INT(11) NOT NULL,
	`Anno` INT(11) NOT NULL,
	`id_sottocommessa` INT(11) NOT NULL,
	`Lotto` INT(11) NOT NULL,
	`Codice_articolo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Codice_fornitore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Descrizione` TEXT NULL COLLATE 'latin1_swedish_ci',
	`Qta_utilizzata` DECIMAL(11,2) NULL,
	`Qta_commessa` DECIMAL(11,2) NULL,
	`Qta_preventivati` DECIMAL(11,2) NULL,
	`UM` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Prezzo` DECIMAL(11,2) NULL,
	`Costo` DECIMAL(11,2) NULL,
	`Prezzo_ora` DECIMAL(11,2) NULL,
	`Costo_ora` DECIMAL(11,2) NULL,
	`Sconto` DECIMAL(11,2) NULL,
	`Tempo_Installazione` INT(11) NULL,
	`Qta_economia` DECIMAL(11,2) NULL,
	`Posizionamento` BIGINT(11) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_jobbodywwithkit
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_jobbodywwithkit` (
	`Id_commessa` INT(11) NOT NULL,
	`Anno` INT(11) NOT NULL,
	`id_sottocommessa` INT(11) NOT NULL,
	`Lotto` INT(11) NOT NULL,
	`Codice_articolo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Codice_fornitore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Descrizione` TEXT NULL COLLATE 'latin1_swedish_ci',
	`Qta_utilizzata` DECIMAL(11,2) NULL,
	`Qta_commessa` DECIMAL(11,2) NULL,
	`Qta_preventivati` DECIMAL(11,2) NULL,
	`UM` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Prezzo` DECIMAL(11,2) NULL,
	`Costo` DECIMAL(11,2) NULL,
	`Prezzo_ora` DECIMAL(11,2) NULL,
	`Costo_ora` DECIMAL(11,2) NULL,
	`Sconto` DECIMAL(11,2) NULL,
	`Tempo_Installazione` INT(11) NULL,
	`Qta_economia` DECIMAL(11,2) NULL,
	`Posizionamento` BIGINT(20) NOT NULL,
	`is_kit` BIGINT(20) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_jobtotaltravelinterventions
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_jobtotaltravelinterventions` (
	`id_commessa` INT(11) NOT NULL,
	`anno_commessa` INT(11) NOT NULL,
	`id_sottocommessa` INT(11) NOT NULL,
	`id_lotto` INT(11) NOT NULL,
	`Totale_spese_trasferta` DECIMAL(11,2) NULL,
	`Totale_autostrada` DECIMAL(11,2) NULL,
	`Totale_parcheggio` DECIMAL(11,2) NULL,
	`Totale_altro` DECIMAL(11,2) NULL,
	`Totale_KM` BIGINT(21) UNSIGNED NULL,
	`Totale_costo_KM` DECIMAL(11,2) NULL,
	`Totale_prezzo_KM` DECIMAL(11,2) NULL,
	`Totale_tempo_viaggio` DECIMAL(11,2) NULL,
	`Totale_costo_tempo_viaggio` DECIMAL(11,2) NULL,
	`Totale_prezzo_tempo_viaggio` DECIMAL(11,2) NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_jobtotalworkinterventions
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_jobtotalworkinterventions` (
	`id_commessa` INT(11) NOT NULL,
	`anno_commessa` INT(11) NOT NULL,
	`id_sottocommessa` INT(11) NOT NULL,
	`id_lotto` INT(11) NOT NULL,
	`Totale_prezzo_lavoro` DECIMAL(11,2) NOT NULL,
	`Totale_costo_lavoro` DECIMAL(11,2) NOT NULL,
	`Totale_ore_lavorate` DECIMAL(11,2) NULL,
	`Economia` INT(1) NOT NULL,
	`Straordinario` INT(1) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_mapsmarkersinformation
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_mapsmarkersinformation` (
	`Id_Impianto` INT(11) NULL,
	`Id_Cliente` INT(11) NULL,
	`Ragione_Sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Impianto_Descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Abbonato` INT(1) NOT NULL,
	`Stato_invio_richiesta_abbonamento` INT(1) NOT NULL,
	`Data_Ticket` DATE NULL,
	`Urgenza` INT(11) NULL,
	`Ticket_Descrizione` TEXT NOT NULL COLLATE 'latin1_swedish_ci',
	`Telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Cellulare` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Mail` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Latitudine` DECIMAL(21,16) NOT NULL,
	`Longitudine` DECIMAL(21,16) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_mobilesystems
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_mobilesystems` (
	`id_impianto` INT(11) NOT NULL,
	`id_cliente` INT(11) NOT NULL,
	`id_gestore` INT(11) NOT NULL,
	`id_occupante` INT(11) NOT NULL,
	`abbonamento` BIGINT(11) NOT NULL,
	`data_funzione` DATETIME NULL,
	`Scadenza_Garanzia` DATETIME NULL,
	`tipo_impianto` INT(11) NULL,
	`stato` INT(11) NULL,
	`descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`luogo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`indirizzo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`citta` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`mail` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`telefono` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`cellulare` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`tipo_impianto_nome` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`partita_iva` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`codice_fiscale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`centrale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`gsm` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`combinatore_telefonico` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`orario_prog` INT(11) NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_mobileticketsopened
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_mobileticketsopened` (
	`id_ticket` INT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`numero_civico` INT(6) NOT NULL,
	`altro` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`frazione` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`comune` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`telefono` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`cellulare` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`urgenza` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`id_impianto` INT(11) NULL,
	`impianto_descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_cliente` INT(11) NOT NULL,
	`ticket_descrizione` TEXT NOT NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_notessearch
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_notessearch` (
	`id_nota` INT(11) NOT NULL,
	`nome` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`descrizione` TEXT NOT NULL COLLATE 'latin1_swedish_ci',
	`prezzo` DECIMAL(10,2) NOT NULL,
	`costo` DECIMAL(10,2) NOT NULL,
	`tempo` INT(11) NULL,
	`id_stato_nota` TINYINT(4) NULL,
	`stato_nota` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`id_tipo_nota` INT(11) NULL,
	`tipo_nota` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_productssearch
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_productssearch` (
	`Codice_articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Codice_fornitore` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Barcode` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Categoria` INT(11) NULL,
	`Sottocategoria` INT(11) NULL,
	`UM` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Stato_articolo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Marca` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Costo` DECIMAL(11,4) NOT NULL,
	`Prezzo` DECIMAL(11,4) NOT NULL,
	`Tempo_installazione` INT(11) NOT NULL,
	`bloccato` TINYINT(4) UNSIGNED NOT NULL,
	`Is_kit` TINYINT(4) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_product_sub_categories
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_product_sub_categories` (
	`Id_categoria` INT(11) NOT NULL,
	`id_sottocategoria` INT(11) NOT NULL,
	`id_sottocategoria_padre` INT(11) NULL,
	`Nome` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Descrizione` LONGTEXT NULL COLLATE 'latin1_swedish_ci',
	`livello` BIGINT(20) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_quotes_details
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_quotes_details` (
	`ID Preventivo` INT(11) NOT NULL,
	`Anno` INT(11) NOT NULL,
	`ID Cliente` INT(11) NULL,
	`Cliente` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Tipo Preventivo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Tipo Intervento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Stato Preventivo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Note Preventivo` LONGTEXT NULL COLLATE 'latin1_swedish_ci',
	`Provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Nr° Revisione` INT(11) NULL,
	`Stampato` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`Inviato` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`Totale` DECIMAL(61,4) NULL,
	`Data Invio` DATE NULL,
	`Data invio 1° sollecito` DATE NULL,
	`Data invio 2° sollecito` DATE NULL,
	`Data Creazione` DATE NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_quote_body_details
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_quote_body_details` (
	`Id_preventivo` INT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`Id_revisione` INT(11) NOT NULL,
	`id_lotto` INT(11) NOT NULL,
	`id_tab` INT(11) NOT NULL,
	`lotto` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_articolo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`descrizione` TEXT NULL COLLATE 'latin1_swedish_ci',
	`codice_fornitore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`quantità` DECIMAL(10,2) NULL,
	`unità_misura` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`prezzo_maateriale` DECIMAL(10,2) NULL,
	`costo_materiale` DECIMAL(10,2) NULL,
	`sconto_materiale` DECIMAL(10,2) NULL,
	`prezzo_h` DECIMAL(10,2) NULL,
	`costo_h` DECIMAL(10,2) NULL,
	`montato` BIT(1) NULL,
	`tempo_installazione` MEDIUMINT(9) NULL,
	`sconto_lavoro` DECIMAL(10,2) NULL,
	`sconto_riga` DECIMAL(10,2) NULL,
	`prezzo_totale` DECIMAL(48,2) NULL,
	`costo_totale` DECIMAL(28,2) NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_reportgroupproducts
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_reportgroupproducts` (
	`id_resoconto` INT(11) NOT NULL,
	`anno_reso` INT(11) NOT NULL,
	`Id_rapporto` BIGINT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`Id_materiale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`descrizione` TEXT NOT NULL COLLATE 'latin1_swedish_ci',
	`quantità` DECIMAL(11,2) NULL,
	`Prezzo` DECIMAL(11,2) NULL,
	`Costo` DECIMAL(11,2) NULL,
	`Sconto` DECIMAL(11,2) NULL,
	`id_magazzino` INT(11) NULL,
	`id_tab` INT(11) NOT NULL,
	`tipo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`qeconomia` FLOAT(11,2) NULL,
	`unita_misura` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_report_daily_detailed
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_report_daily_detailed` (
	`id_rapporto_giornaliero` INT(11) NOT NULL,
	`id_operaio` INT(11) NOT NULL,
	`ragione_sociale_operaio` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`data_rapporto` DATE NOT NULL,
	`ora_inizio` TIME NOT NULL,
	`ora_fine` TIME NOT NULL,
	`minuti_differenza` DECIMAL(10,0) NULL,
	`time_differenza` TIME NULL,
	`tipo_attivita` INT(11) NOT NULL,
	`nome` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`note` TEXT NULL COLLATE 'latin1_swedish_ci',
	`id_rapporto` BIGINT(20) NULL,
	`anno_rapporto` INT(11) NULL,
	`Id_cliente` INT(11) NULL,
	`ragione_sociale_cliente` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_impianto` INT(11) NULL,
	`descrizione_impianto` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_tipo_intervento` INT(11) NULL,
	`tipo_intervento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`spesa_trasferta` DOUBLE(11,2) NOT NULL,
	`spesa_autostrada` DOUBLE(11,2) NOT NULL,
	`spesa_parcheggio` DOUBLE(11,2) NOT NULL,
	`spesa_altro` DOUBLE(11,2) NOT NULL,
	`spesa_altro_nota` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_supplier_invoices_details
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_supplier_invoices_details` (
	`rif_prot` INT(11) NOT NULL,
	`id_fattura` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`anno` INT(11) NOT NULL,
	`Id_fornitore` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`nome_condizione_pagamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_tipo_pagamento` INT(11) NOT NULL,
	`nome_tipo_pagamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`data_documento` DATE NOT NULL,
	`id_tipo_attivita` INT(11) NULL,
	`tipo_attivita` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`iva` INT(11) NULL,
	`totale_imponibile` DECIMAL(29,6) NULL,
	`totale_ivato` DECIMAL(29,6) NULL,
	`stato_fattura` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_supplier_invoices_payments_details
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_supplier_invoices_payments_details` (
	`id_fattura` INT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`id_fattura_fornitore` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`data_fattura` DATE NOT NULL,
	`id_fornitore` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`condizione_pagamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_tipo_pagamento` BIGINT(11) NULL,
	`tipo_pagamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`importo_pagamento` DECIMAL(33,10) NULL,
	`importo_fattura` DECIMAL(51,6) NULL,
	`data_pagamento_prevista` DATE NULL,
	`data_pagamento_effettiva` DATE NULL,
	`pagato` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`nota_pagamento_effettuato` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_systemperiodicmonitoringremindergridmain
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_systemperiodicmonitoringremindergridmain` (
	`Id` INT(11) NOT NULL,
	`id_mese` INT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`id_impianto` INT(11) NOT NULL,
	`descrizione_impianto` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Id_cliente` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`svolto` INT(1) NOT NULL,
	`da_eseguire` DATE NULL,
	`Tipo_impianto` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`tempo_manutenzione` DOUBLE(15,4) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_systemperiodicmonitoringremindergridmainelementtypeone
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_systemperiodicmonitoringremindergridmainelementtypeone` (
	`Id` BIGINT(15) UNSIGNED NULL,
	`id_mese` INT(11) NOT NULL,
	`anno` INT(4) NULL,
	`id_impianto` INT(11) NOT NULL,
	`descrizione_impianto` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Id_cliente` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`svolto` INT(1) NOT NULL,
	`da_eseguire` BINARY(0) NULL,
	`Tipo_impianto` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`tempo_manutenzione` INT(1) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_systemperiodicmonitoringremindergridmainelementtypezero
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_systemperiodicmonitoringremindergridmainelementtypezero` (
	`Id` INT(11) NOT NULL,
	`id_mese` INT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`id_impianto` INT(11) NOT NULL,
	`descrizione_impianto` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Id_cliente` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`svolto` INT(1) NOT NULL,
	`da_eseguire` DATE NULL,
	`Tipo_impianto` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`tempo_manutenzione` DOUBLE(15,4) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_systems_components
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_systems_components` (
	`id_articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`desc_brev` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`codice_fornitore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id_impianto` INT(11) NOT NULL,
	`quantità` DECIMAL(23,0) NULL,
	`quantita_in_scadenza` DECIMAL(23,0) NULL,
	`quantita_scaduti` DECIMAL(23,0) NULL,
	`quantita_non_scaduti` DECIMAL(23,0) NULL,
	`quantita_no_scadenza` DECIMAL(23,0) NULL,
	`colore` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_systems_components_detail
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_systems_components_detail` (
	`id_impianto` INT(11) NOT NULL,
	`id_articolo` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Posizionamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`fine_garanzia` DATE NULL,
	`ordine` INT(11) NOT NULL,
	`data_installazione` DATE NULL,
	`data_dismesso` DATE NULL,
	`data_scadenza` DATE NULL,
	`stato_scadenza` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`garanzia_fornitore` DATE NULL,
	`id_versione` INT(11) NULL,
	`versione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_systems_customers_details
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_systems_customers_details` (
	`id_cliente` INT(11) NOT NULL,
	`ragione_sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`tipo_cliente` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`tipo_rap` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`stato_cliente` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`mail` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`altro_telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`paese` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`cap` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`id` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`id_impianto` INT(11) NULL,
	`tipo_impianto` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`stato_impianto` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`data_funzione` DATE NULL,
	`scadenza_garanzia` DATE NULL,
	`tempo_manutenzione` DOUBLE(15,4) NULL,
	`costo2` FLOAT NULL,
	`manutenzione` FLOAT NULL,
	`abbonamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`persone` INT(11) NULL,
	`Controlli` VARCHAR(1) NULL COLLATE 'utf8_general_ci',
	`id_mese` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`Checklist` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`stato_invio_abbonamento` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_systems_expirations_summary
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_systems_expirations_summary` (
	`id_riferimento` INT(11) NOT NULL,
	`tipo_entita` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`tipo_scadenza` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`id_impianto` INT(11) NULL,
	`id_cliente` INT(11) NULL,
	`descrizione` TEXT NULL COLLATE 'latin1_swedish_ci',
	`data_scadenza` DATE NULL,
	`data_promemoria` DATETIME NULL,
	`data_ultimo_promemoria` DATETIME NULL,
	`quantita` BIGINT(20) NULL,
	`id_stato_promemoria` INT(11) NOT NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_systems_exports_to_contact
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_systems_exports_to_contact` (
	`ID Cliente` INT(11) NOT NULL,
	`Ragione Sociale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Tipo Cliente` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Tipo Rapporto` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Stato Cliente` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Email` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Cellulare` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Città` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`CAP` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`ID Impianto` INT(11) NOT NULL,
	`Tipo Impianto` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Stato Impianto` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Descrizione` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Data Funzione` DATE NULL,
	`Scadenza Garanzia` DATE NULL,
	`Tempo Manutenzione` DOUBLE(15,4) NULL,
	`Costo Manutenzione` FLOAT(11,2) NULL,
	`Costo Ipotetico Manutenzione` FLOAT(11,2) NULL,
	`Abbonamento` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`Persone Necessarie` INT(11) NULL,
	`Controlli` VARCHAR(1) NULL COLLATE 'utf8_general_ci',
	`Data Ultimo Rapporto` DATE NULL,
	`Data Ultimo Preventivo Aperto` DATE NULL,
	`Data Ultima Fattura` DATE NULL
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_ticket_details
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_ticket_details` (
	`Id_ticket` INT(11) NOT NULL,
	`anno` INT(11) NOT NULL,
	`Id_impianto` INT(11) NULL,
	`Id_cliente` INT(11) NULL,
	`cliente` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`impianto` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`tipo_impianto` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`descrizione` TEXT NOT NULL COLLATE 'latin1_swedish_ci',
	`id_stato_ticket` INT(11) NOT NULL,
	`stato_ticket` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`colore_stato_ticket` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`stato_ticket_aperto` BIT(1) NOT NULL,
	`Causale` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`Urgenza` VARCHAR(1) NOT NULL COLLATE 'utf8mb4_general_ci',
	`tipo_intervento` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`sorgente` VARCHAR(1) NOT NULL COLLATE 'latin1_swedish_ci',
	`tempo_minuti` INT(11) NOT NULL,
	`tempo_ore` DECIMAL(13,2) NULL,
	`data_ticket` DATE NULL,
	`scadenza` DATE NULL,
	`data_soluzione` DATE NULL,
	`telefono` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`cellulare` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`mail` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`paese` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`cap` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`provincia` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci',
	`indirizzo` VARCHAR(1) NULL COLLATE 'latin1_swedish_ci'
) ENGINE=MyISAM;

-- Dump della struttura di vista emmebi.vw_user
-- Creazione di una tabella temporanea per risolvere gli errori di dipendenza della vista
CREATE TABLE `vw_user` 
) ENGINE=MyISAM;

-- Dump della struttura di tabella emmebi.xml_caratteri_speciali_replacement
CREATE TABLE IF NOT EXISTS `xml_caratteri_speciali_replacement` (
  `Id` int(11) NOT NULL AUTO_INCREMENT,
  `search_string` varchar(50) NOT NULL,
  `replace_string` varchar(50) NOT NULL,
  `is_regexp` bit(1) NOT NULL,
  `enabled` bit(1) NOT NULL,
  PRIMARY KEY (`Id`),
  UNIQUE KEY `search_string` (`search_string`)
) ENGINE=InnoDB AUTO_INCREMENT=9 DEFAULT CHARSET=latin1;

-- L’esportazione dei dati non era selezionata.

-- Dump della struttura di trigger emmebi.com_comp
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `com_comp` AFTER INSERT ON `commessa_articolo_comp` FOR EACH ROW update commessa_Articoli inner join commessa_Articolo_comp on 

commessa_articoli.id_commessa=commessa_articolo_comp.id_commessa and 

commessa_articoli.anno=commessa_articolo_comp.anno and

commessa_articoli.id_lotto=commessa_Articolo_comp.lotto and

commessa_articoli.id_tab=commessa_articolo_comp.id_forfait

inner join commessa_Articoli as a on 

a.id_commessa=commessa_articolo_comp.id_commessa and 

a.anno=commessa_articolo_comp.anno and

a.id_lotto=commessa_Articolo_comp.lotto and

a.id_tab=commessa_articolo_comp.id_dettaglio

set commessa_Articoli.prezzo=commessa_Articoli.prezzo-((a.prezzo+a.tempo/60*a.prezzo_ora)-((a.prezzo+a.tempo/60*a.prezzo_ora)*(a.sconto/100))*

a.quantità)

where commessa_articolo_comp.id_commessa=new.id_commessa and

commessa_Articolo_comp.anno=new.anno and 

commessa_Articolo_comp.lotto=new.lotto and

commessa_Articolo_comp.id_Dettaglio=new.id_dettaglio//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.com_comp_bf_dl
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `com_comp_bf_dl` BEFORE DELETE ON `commessa_articolo_comp` FOR EACH ROW update commessa_Articoli inner join commessa_Articolo_comp on 

commessa_articoli.id_commessa=commessa_articolo_comp.id_commessa and 

commessa_articoli.anno=commessa_articolo_comp.anno and

commessa_articoli.id_lotto=commessa_Articolo_comp.lotto and

commessa_articoli.id_tab=commessa_articolo_comp.id_forfait

inner join commessa_Articoli as a on 

a.id_commessa=commessa_articolo_comp.id_commessa and 

a.anno=commessa_articolo_comp.anno and

a.id_lotto=commessa_Articolo_comp.lotto and

a.id_tab=commessa_articolo_comp.id_dettaglio

set commessa_Articoli.prezzo=commessa_Articoli.prezzo+((a.prezzo+a.tempo/60*a.prezzo_ora)-((a.prezzo+a.tempo/60*a.prezzo_ora)*(a.sconto/100))*

a.quantità)

where commessa_articolo_comp.id_commessa=old.id_commessa and

commessa_Articolo_comp.anno=old.anno and

commessa_Articolo_comp.lotto=old.lotto and

commessa_Articolo_comp.id_Dettaglio=old.id_dettaglio//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.del_art_lis
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `del_art_lis` AFTER DELETE ON `lista_articoli` FOR EACH ROW begin





delete from magazzino_operazione where id_operazione=(Select id_operazione_del from magazzino_liste where id_lista=old.id_lista and anno=old.anno and id_tab=old.numero_tab);

delete from magazzino_operazione where id_operazione=(Select id_operazione_ins from magazzino_liste where id_lista=old.id_lista and anno=old.anno and id_tab=old.numero_tab);



delete from magazzino_liste where id_lista=old.id_lista and anno=old.anno and id_tab=old.numero_tab;





end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.del_ddt
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `del_ddt` BEFORE DELETE ON `ddt` FOR EACH ROW begin

delete from articolI_ddt where id_ddt=old.id_ddt and anno=old.anno;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.del_ddt_ric
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `del_ddt_ric` BEFORE DELETE ON `ddt_ricevuti` FOR EACH ROW delete from articolI_ddt_ricevuti

where id_ddt=old.id_ddt and anno=old.anno//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.del_lis
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `del_lis` BEFORE DELETE ON `lista_prelievo` FOR EACH ROW begin

delete from lista_articoli where id_Lista=old.id_lista and anno=old.anno;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.del_rapp
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `del_rapp` BEFORE DELETE ON `rapporto` FOR EACH ROW delete from rapporto_materiale where id_rapporto=old.id_rapporto and anno=old.anno//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.furg_ins_mag
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `furg_ins_mag` BEFORE INSERT ON `automezzo` FOR EACH ROW begin

  insert into tipo_magazzino set nome = new.modello, descrizione = null, prior = 2, id_master = null, reso = null;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.furg_mod_mag
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `furg_mod_mag` BEFORE UPDATE ON `automezzo` FOR EACH ROW begin

  update tipo_magazzino set nome = new.modello where id_tipo = new.id_magazzino;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.insmarc
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `insmarc` AFTER INSERT ON `marca` FOR EACH ROW begin

    insert into listino(nome)values(new.nome);

    insert into marca_listino (id_listino,id_marca) select id_listino,new.id_marca from listino where nome =new.nome;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.ins_abbo_imp
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `ins_abbo_imp` AFTER INSERT ON `impianto_uscita` FOR EACH ROW begin

if (select max(anno) from impianto_uscita where id_impianto=new.id_impianto) <=new.anno  then

update impianto set costo_manutenzione=(Select new.manutenzione from impianto_uscita where anno=New.anno and impianto_uscita.id_impianto=new.id_impianto) where impianto.id_impianto=new.id_impianto;

end if;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.ins_art_lis
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `ins_art_lis` AFTER INSERT ON `lista_articoli` FOR EACH ROW if (new.id_Articolo is not null)and(new.causale_scarico is not null) then



insert into magazzino_operazione (data,articolo,quantità,id_magazzino,causale)values(

 (select data from lista_prelievo where id_lista=new.id_lista and anno=new.anno),new.id_articolo,concat('-',new.quantità),new.causale_scarico

 ,(select id_causale from causale_magazzino where operazione=2 and tipo_magazzino=new.causale_scarico));



insert into magazzino_operazione (data,articolo,quantità,id_magazzino,causale)values(

 (select data from lista_prelievo where id_lista=new.id_lista and anno=new.anno),new.id_articolo,new.quantità,(select tipo_magazzino from

causale_magazzino where id_causale=(select causale from lista_prelievo where id_lista=new.id_lista and new.anno=anno))

 ,(select causale from lista_prelievo where id_lista=new.id_lista and new.anno=anno));



insert into magazzino_liste(id_lista,id_operazione_del,id_operazione_ins,anno,id_tab)values(new.id_lista,(Select max(id_operazione)-1 from magazzino_operazione ),

(Select max(id_operazione) from magazzino_operazione ),new.anno,new.numero_tab);





end if//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.ins_contro
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `ins_contro` AFTER INSERT ON `impianto_abbonamenti_mesi` FOR EACH ROW begin

if (select max(anno) from impianto_abbonamenti where id_impianto=new.impianto limit 1 )<=new.anno  then

update impianto set costo_manutenzione=(Select if(new.prezzo is not null,new.prezzo,manutenzione) from impianto_uscita where anno=New.anno and impianto_uscita.id_impianto=new.impianto)

  where new.impianto=id_Impianto;

end if;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.marca_list_del
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `marca_list_del` BEFORE DELETE ON `marca` FOR EACH ROW begin



  delete from listino where listino.id_listino = (select id_listino from marca_listino where id_marca=old.id_marca);

  delete from marca_listino where marca_listino.id_marca = old.id_marca;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.modlist
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `modlist` BEFORE UPDATE ON `articolo_listino` FOR EACH ROW begin

if new.prezzo<>old.prezzo then

insert into articolo_listino_prezzo (id_Articolo,id_listino,prezzo,data_inizio,data_fine)values

(new.id_articolo,new.id_listino,old.prezzo,old.data_inizio,new.data_inizio);

end if;



end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.mod_abbo_imp
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `mod_abbo_imp` AFTER UPDATE ON `impianto_uscita` FOR EACH ROW begin

if (select max(anno) from impianto_uscita where id_impianto=new.id_impianto) <=new.anno  then

update impianto set costo_manutenzione=(Select new.manutenzione from impianto_uscita where anno=New.anno and impianto_uscita.id_impianto=new.id_impianto) where impianto.id_impianto=new.id_impianto;

end if;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.mod_contro
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `mod_contro` AFTER UPDATE ON `impianto_abbonamenti_mesi` FOR EACH ROW begin

if (select max(anno) from impianto_abbonamenti where id_impianto=new.impianto limit 1 )<=new.anno  then





    update impianto set costo_manutenzione=(Select if(new.prezzo is not null,new.prezzo,manutenzione) from impianto_uscita where anno=New.anno and impianto_uscita.id_impianto=new.impianto)





  where new.impianto=impianto.id_Impianto;







end if;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.pagaForn_insert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `pagaForn_insert` AFTER INSERT ON `fornfattura_pagamenti` FOR EACH ROW begin

update fornfattura inner join (select if( (select mesi from fornfattura as rata INNER  JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione

where rata.id_fattura=new.id_fattura and rata.anno=new.anno

)=(

select count(*) from fornfattura as rata INNER  JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione

INNER JOIN condizioni_giorno AS g ON g.id_condizione = a.id_condizione

   inner join fornfattura_pagamenti as pag on rata.id_fattura=pag.id_fattura and

  pag.anno=rata.anno and pag.id_pagamento= date_format(last_day(rata.DATA + INTERVAL g.mesi MONTH )+ interval g.giorni day,'%Y%m%d') and pag.data is not null

where rata.id_fattura=new.id_fattura and rata.anno=new.anno),"3","1") as "con" ) as conta set stato=con where fornfattura.id_fattura=new.id_fattura and fornfattura.anno=new.anno;

end//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.pagaForn_update
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `pagaForn_update` AFTER UPDATE ON `fornfattura_pagamenti` FOR EACH ROW update fornfattura inner join (select if( (select mesi from fornfattura as rata INNER  JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione

where rata.id_fattura=new.id_fattura and rata.anno=new.anno

)=(

select count(*) from fornfattura as rata INNER  JOIN condizione_pagamento AS a ON cond_pagamento = a.id_condizione

INNER JOIN condizioni_giorno AS g ON g.id_condizione = a.id_condizione

   inner join fornfattura_pagamenti as pag on rata.id_fattura=pag.id_fattura and

  pag.anno=rata.anno and pag.id_pagamento= date_format(last_day(rata.DATA + INTERVAL g.mesi MONTH )+ interval g.giorni day,'%Y%m%d') and pag.data is not null

where rata.id_fattura=new.id_fattura and rata.anno=new.anno),"3","1") as "con" ) as conta set stato=con where fornfattura.id_fattura=new.id_fattura and fornfattura.anno=new.anno//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.paga_insert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `paga_insert` AFTER INSERT ON `fattura_pagamenti` FOR EACH ROW 
BEGIN
	CALL sp_ariesInvoiceEvaluateStatus(new.Id_fattura, new.anno); 
	
	IF new.data IS NOT NULL THEN
		CALL sp_ariesCheckFutureInvoicesStatementReminder(new.Id_fattura, new.anno); 
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.paga_update
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `paga_update` AFTER UPDATE ON `fattura_pagamenti` FOR EACH ROW 
BEGIN
	CALL sp_ariesInvoiceEvaluateStatus(new.Id_fattura, new.anno); 
	
	IF old.data IS NULL AND new.data IS NOT NULL THEN
		CALL sp_ariesCheckFutureInvoicesStatementReminder(new.Id_fattura, new.anno);
	END IF; 
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterContractInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterContractInsert` AFTER INSERT ON `contratto` FOR EACH ROW 
BEGIN
	IF NEW.tipo_contratto = 2 THEN
		INSERT INTO contratto_impianto_mese(id_contratto, id_impianto, id_mese)
		SELECT NEW.id_contratto,
			id_impianto,
			numero
		FROM preventivo_articolo_abbonamento
        	INNER JOIN preventivo_lotto ON posizione=preventivo_articolo_abbonamento.id_lotto
				AND preventivo_articolo_abbonamento.anno=preventivo_lotto.anno
        		AND preventivo_articolo_abbonamento.id_Preventivo=preventivo_lotto.id_preventivo
				AND preventivo_articolo_abbonamento.revisione=preventivo_lotto.id_revisione
        WHERE preventivo_articolo_abbonamento.id_preventivo = NEW.id_preventivo
        	AND preventivo_articolo_abbonamento.anno = NEW.anno
    		AND preventivo_articolo_abbonamento.revisione = NEW.id_revisione
        	AND numero <= 12; 

			


		INSERT INTO contratto_paragrafo (id_contratto, id_tipo, id_paragrafo, nome, descrizione)
		SELECT NEW.id_contratto,
			2,
			id_paragrafo,
			nome,
			descrizione
		FROM contratto_modello_paragrafo
		WHERE id_tipo = 3;

	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterCustomerDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterCustomerDelete` AFTER DELETE ON clienti FOR EACH ROW 
BEGIN

		
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterCustomerInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterCustomerInsert` AFTER INSERT ON clienti FOR EACH ROW 
BEGIN

		
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterCustomerInvoicesStatementInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterCustomerInvoicesStatementInsert` AFTER INSERT ON `cliente_estratto_conto` FOR EACH ROW 
BEGIN
	DECLARE statement_event_id INT(11);
	
	DROP TEMPORARY TABLE IF EXISTS invoices_statement_tmp;
	CREATE TEMPORARY TABLE invoices_statement_tmp
	SELECT id_fattura,
		anno,
		CAST(DATE_FORMAT(data_pagamento_prevista, '%Y%m%d') AS UNSIGNED) AS id_pagamento,
		id_tipo_pagamento,
		(id_pagamento IS NOT NULL) AS pagamento_esistente
	FROM vw_invoices_payments_details
	WHERE pagato = 0 AND id_cliente = NEW.id_cliente AND anno <> 0;

	INSERT INTO fattura_pagamenti (id_fattura, anno, id_pagamento, tipo_pagamento, data, nota)
	SELECT id_fattura,
		anno,
		id_pagamento,
		id_tipo_pagamento,
		NULL,
		''
	FROM invoices_statement_tmp
	WHERE NOT pagamento_esistente;
	
	
	INSERT INTO fattura_pagamenti_comunicazione (id_fattura, anno, id_pagamento, id_comunicazione, tipo, mail, data, stato, nota)
	SELECT id_fattura,
		anno,
		id_pagamento,
		IFNULL(
			(
			SELECT
			MAX(id_comunicazione) + 1
			FROM fattura_pagamenti_comunicazione fpc
			WHERE fpc.id_fattura = payments.id_fattura AND fpc.anno = payments.anno AND fpc.id_pagamento = payments.id_pagamento
			), 1),
		2,
		new.id_email,
		CURRENT_DATE,
		1,
		'INVIO ESTRATTO CONTO'
	FROM invoices_statement_tmp payments;
	
	
	UPDATE fattura
    INNER JOIN invoices_statement_tmp payments
		ON payments.id_fattura = fattura.id_fattura AND payments.anno = fattura.anno
	SET fattura.data_invio_promemoria = NOW(),
		fattura.controllo_promemoria = 0;	 

	CALL sp_ariesCustomerInvoicesStatementCreateReminder(NEW.id, statement_event_id);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterCustomerUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterCustomerUpdate` AFTER UPDATE ON clienti FOR EACH ROW 
BEGIN

		
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterDdtProductInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterDdtProductInsert` AFTER INSERT ON `articoli_ddt` FOR EACH ROW BEGIN		

	DECLARE allow_depots_movement BIT; 
	DECLARE allow_system_movement BIT; 
	DECLARE system_id INT(11);
	
	
	SELECT  fnc_productAllowDepotsScale(NEW.id_articolo)
		INTO allow_depots_movement;


	IF (allow_depots_movement = 1) AND (NEW.causale_scarico IS NOT NULL) THEN
		CALL sp_ariesDepotsDdtProductInsert(NEW.id_Ddt, NEW.anno, NEW.numero_tab, NEW.quantità,
				NEW.id_articolo, NEW.causale_scarico);
	END IF; 

	SELECT fnc_productAllowSystemScale(NEW.id_articolo)
		INTO allow_system_movement;

	IF (allow_system_movement OR allow_system_movement IS NULL) THEN	
		
		SELECT ddt.impianto
			INTO 
			system_id
		FROM ddt 
		WHERE Id_ddt =  NEW.id_ddt AND anno = NEW.anno; 
		
		IF system_id IS NOT NULL AND system_id > 0 THEN
			CALL sp_ariesSystemsDdtProductInsert(NEW.id_Ddt,NEW.anno,NEW.id_articolo,NEW.quantità,NEW.numero_tab,NEW.serial_number);
		END IF;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterDdtProductUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterDdtProductUpdate` AFTER UPDATE ON `articoli_ddt` FOR EACH ROW 
BEGIN
	DECLARE allow_depots_movement BIT; 
	DECLARE allow_system_movement BIT; 
	DECLARE system_id INT(11);

	-- UNDO PREVIOUS STATE
	CALL sp_ariesDepotsDdtProductDelete(OLD.id_ddt, OLD.anno, OLD.numero_tab);
	CALL sp_ariesSystemsDdtProductDelete(OLD.id_ddt, OLD.anno,
	  OLD.id_Articolo, OLD.numero_tab);

	
	-- SCALE BASED ON NEW PRODUCT
	SELECT  fnc_productAllowDepotsScale(NEW.id_articolo)
		INTO allow_depots_movement;

	IF (allow_depots_movement = 1) AND (NEW.causale_scarico IS NOT NULL) THEN
		CALL sp_ariesDepotsDdtProductInsert(NEW.id_Ddt, NEW.anno, NEW.numero_tab, NEW.quantità,
				NEW.id_articolo, NEW.causale_scarico);
	END IF; 

	SELECT fnc_productAllowSystemScale(NEW.id_articolo)
		INTO allow_system_movement;

	IF (allow_system_movement OR allow_system_movement IS NULL) THEN	
		
		SELECT ddt.impianto
			INTO 
			system_id
		FROM ddt 
		WHERE Id_ddt =  NEW.id_ddt AND anno = NEW.anno; 
		
		IF system_id IS NOT NULL AND system_id > 0 THEN
			CALL sp_ariesSystemsDdtProductInsert(NEW.id_Ddt,NEW.anno,NEW.id_articolo,NEW.quantità,NEW.numero_tab,NEW.serial_number);
		END IF;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterDdtReportLinkDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterDdtReportLinkDelete` AFTER DELETE ON `ddt_rapporto` FOR EACH ROW 
BEGIN

	-- check for job scale
	DECLARE job_id INT(11);
	DECLARE job_year INT(11);
	DECLARE sub_job_id INT(11);
	DECLARE lot_id INT(11);

	SELECT id_commessa,
		anno_commessa,
		id_sottocommessa,
		id_lotto
	INTO job_id,
		job_year,
		sub_job_id,
		lot_id
	FROM commessa_rapporto
	WHERE id_rapporto = OLD.id_rapporto AND anno_rapporto = OLD.anno_rapporto;

	IF job_id IS NOT NULL THEN
		CALL sp_ariesJobScaleReport(job_id, job_year, sub_job_id, lot_id, OLD.id_rapporto, OLD.anno_rapporto);
	END IF;
	
	-- check for depots scale
	CALL sp_ariesDepotsScaleByReport(OLD.id_rapporto, OLD.anno_rapporto);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterDdtReportLinkInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterDdtReportLinkInsert` BEFORE INSERT ON `ddt_rapporto` FOR EACH ROW 
BEGIN
	-- check for job scale
	DECLARE job_id INT(11);
	DECLARE job_year INT(11);
	DECLARE sub_job_id INT(11);
	DECLARE lot_id INT(11);

	SELECT id_commessa,
		anno_commessa,
		id_sottocommessa,
		id_lotto
	INTO job_id,
		job_year,
		sub_job_id,
		lot_id
	FROM commessa_rapporto
	WHERE id_rapporto = NEW.id_rapporto AND anno_rapporto = NEW.anno_rapporto;

	IF job_id IS NOT NULL THEN
		CALL sp_ariesJobUndoScaleReport(job_id, job_year, sub_job_id, lot_id, NEW.id_rapporto, NEW.anno_rapporto);
	END IF;

	-- check for depots scale
	CALL sp_ariesDepotsUndoScaleByReport(NEW.id_rapporto, NEW.anno_rapporto);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterDepotOperationDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterDepotOperationDelete` AFTER DELETE ON `magazzino_operazione` FOR EACH ROW 
BEGIN
	DECLARE LastDepotBlockDate DATE; 
	
	SELECT magazzino_blocco.data 
		INTO LastDepotBlockDate
	FROM magazzino_blocco 
	ORDER BY id_blocco DESC 
	LIMIT 1; 
	
	IF (old.data >= LastDepotBlockDate OR LastDepotBlockDate IS NULL) THEN
		INSERT INTO magazzino 
		SET 
			giacenza = (0 - old.quantità),
			id_articolo = old.articolo,
			tipo_magazzino = old.id_magazzino,
			Data_ins = NOW(), 
			Data_ultimo_movimento = NOW(),
			Utente_ins = @USER_ID,
			Utente_mod = @USER_ID
		ON DUPLICATE KEY
		UPDATE
			giacenza=giacenza-old.quantità,
			Data_ultimo_movimento = NOW(),
			Utente_mod = @USER_ID;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterDepotOperationInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterDepotOperationInsert` AFTER INSERT ON `magazzino_operazione` FOR EACH ROW 
BEGIN
	DECLARE LastDepotBlockDate DATE; 
	
	SELECT magazzino_blocco.data 
		INTO LastDepotBlockDate
	FROM magazzino_blocco 
	ORDER BY id_blocco DESC 
	LIMIT 1;
	
	IF (new.data >= LastDepotBlockDate OR LastDepotBlockDate IS NULL) THEN
		INSERT INTO magazzino 
		SET 
			giacenza = (0 + new.quantità),
			id_articolo = new.articolo,
			tipo_magazzino = new.id_magazzino,
			Data_ultimo_movimento = NOW(),
			Data_ins = NOW(), 
			Utente_ins = @USER_ID,
			Utente_mod = @USER_ID
		ON DUPLICATE KEY
		UPDATE
			giacenza=giacenza+new.quantità,
			Data_ultimo_movimento = NOW(),
			Utente_mod = @USER_ID;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterDepotOperationUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterDepotOperationUpdate` AFTER UPDATE ON `magazzino_operazione` FOR EACH ROW 
BEGIN
	DECLARE LastDepotBlockDate DATE; 
	
	SELECT magazzino_blocco.data 
		INTO LastDepotBlockDate
	FROM magazzino_blocco 
	ORDER BY id_blocco DESC 
	LIMIT 1; 
	
	IF (new.data>=LastDepotBlockDate OR LastDepotBlockDate IS NULL) THEN
		INSERT INTO magazzino 
		SET 
			giacenza = new.quantità-old.quantità,
			id_articolo = new.articolo,
			tipo_magazzino = new.id_magazzino,
			Data_ultimo_movimento = NOW(),
			Data_ins = NOW(), 
			Utente_ins = @USER_ID,
			Utente_mod = @USER_ID
		ON DUPLICATE KEY
		UPDATE
			giacenza = giacenza+new.quantità-old.quantità,
			Data_ultimo_movimento = NOW(),
			Utente_mod = @USER_ID;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterDepotTypeInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterDepotTypeInsert` AFTER INSERT ON `tipo_magazzino` FOR EACH ROW 
BEGIN
	INSERT INTO causale_magazzino
	(
		nome,
		operazione,
		tipo_magazzino,
		reso
	)
	VALUES
	(
		CONCAT(new.nome," CARICO"),
		1,
		new.id_tipo,
		new.reso
	),(
		CONCAT(new.nome," SCARICO"),
		2,
		new.id_tipo,
		new.reso
	);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterInvoicePaymentDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterInvoicePaymentDelete` AFTER DELETE ON `fattura_pagamenti` FOR EACH ROW 
BEGIN
	CALL sp_ariesInvoiceEvaluateStatus(old.Id_fattura, old.anno);  
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterInvoiceProductInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterInvoiceProductInsert` AFTER INSERT ON `fattura_articoli` FOR EACH ROW
BEGIN
	DECLARE allow_insert BIT;
	DECLARE depot_type INT;
	
	SELECT fnc_invoiceProductAllowDepotsScale(NEW.id_fattura, NEW.anno, NEW.id_materiale) INTO allow_insert;

	-- make insert IF allow
	IF allow_insert = 1 THEN
		SET depot_type = 1; -- MAGAZZINO
		CALL sp_ariesDepotsInvoiceProductInsert(NEW.id_fattura, NEW.anno, NEW.n_tab, NEW.quantità,
				NEW.id_materiale, depot_type);
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterJobDdtLinkDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterJobDdtLinkDelete` AFTER DELETE ON `commessa_ddt` FOR EACH ROW 
BEGIN
	CALL sp_ariesJobUndoScaleDdt(OLD.id_commessa, OLD.anno_commessa, OLD.id_sottocommessa, OLD.id_lotto, OLD.id_ddt, OLD.anno_ddt);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterJobDdtLinkInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterJobDdtLinkInsert` AFTER INSERT ON `commessa_ddt` FOR EACH ROW 
BEGIN
	CALL sp_ariesJobScaleDdt(NEW.id_commessa, NEW.anno_commessa, NEW.id_sottocommessa, NEW.id_lotto, NEW.id_ddt, NEW.anno_ddt);
	
	UPDATE commessa
	SET stato_commessa=3 
		WHERE stato_commessa = 1 AND id_commessa = NEW.id_commessa
		AND anno = NEW.anno_commessa;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterJobInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterJobInsert` AFTER INSERT ON `commessa` FOR EACH ROW 
BEGIN
	CALL sp_ariesJobInitSettings(NEW.id_commessa, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterJobProductsUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterJobProductsUpdate` BEFORE UPDATE ON commessa_articoli FOR EACH ROW 
BEGIN
	IF (NEW.preventivati <> OLD.preventivati)
		OR (NEW.`quantità` <> OLD.`quantità`)
		OR (NEW.`costo_ora` <> OLD.`costo_ora`)
		OR (NEW.`prezzo_ora` <> OLD.`prezzo_ora`)
		OR (NEW.`costo` <> OLD.`costo`)
		OR (NEW.`prezzo` <> OLD.`prezzo`)
		OR (NEW.`tempo` <> OLD.`tempo`)
		OR (NEW.`sconto` <> OLD.`sconto`)
		OR (NEW.`portati` <> OLD.`portati`)
	THEN
		CALL sp_ariesJobProductHistoryCreate(NEW.id_commessa, NEW.anno, NEW.id_sottocommessa, NEW.id_lotto, NEW.id_tab);
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterJobReportLinkDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterJobReportLinkDelete` AFTER DELETE ON `commessa_rapporto` FOR EACH ROW 
BEGIN
	CALL sp_ariesJobUndoScaleReport(OLD.id_commessa, OLD.anno_commessa, OLD.id_sottocommessa, OLD.id_lotto, OLD.id_rapporto, OLD.anno_rapporto);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterJobReportLinkInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterJobReportLinkInsert` AFTER INSERT ON `commessa_rapporto` FOR EACH ROW 
BEGIN
	CALL sp_ariesJobScaleReport(NEW.id_commessa, NEW.anno_commessa, NEW.id_sottocommessa, NEW.id_lotto, NEW.id_rapporto, NEW.anno_rapporto);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterQuoteUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterQuoteUpdate` AFTER UPDATE ON `preventivo` FOR EACH ROW 
BEGIN
	if (old.Stato <> new.Stato) AND (new.Stato IN (1,6,7,8)) THEN
	
		CALL sp_ariesQuoteConvertTempProducts(new.Id_preventivo, new.anno); 
	
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReceivedDdtProductInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReceivedDdtProductInsert` AFTER INSERT ON `articoli_ddt_ricevuti` FOR EACH ROW BEGIN

	DECLARE allow_movement BIT(1); 
	
	SELECT  fnc_productAllowDepotsScale(NEW.id_articolo)
			INTO allow_movement;

	IF (allow_movement = 1) AND (NEW.causale_scarico IS NOT NULL) THEN
		CALL sp_ariesDepotsReceivedDdtProductInsert(NEW.id_Ddt, NEW.anno, NEW.numero_tab, NEW.quantità,
			NEW.id_articolo, NEW.causale_scarico);
	END IF; 
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportGroupInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportGroupInsert` AFTER INSERT ON `resoconto` FOR EACH ROW 
BEGIN	
	INSERT INTO  resoconto_totali (id_resoconto, anno, prezzo_manutenzione, costo_manutenzione, costo_diritto_chiamata, prezzo_diritto_chiamata, costo_lavoro, prezzo_lavoro,
		costo_viaggio, prezzo_viaggio, costo_materiale, prezzo_materiale, costo_totale, prezzo_totale, costo_extra, prezzo_extra)
	VALUES (NEW.id_resoconto, NEW.anno, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, NEW.prezzo_extra, NEW.costo_extra);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportGroupReportLinkDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportGroupReportLinkDelete` AFTER DELETE ON `resoconto_rapporto` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportGroupTotalsRefresh(OLD.id_resoconto, OLD.anno_reso);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportGroupReportLinkInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportGroupReportLinkInsert` AFTER INSERT ON `resoconto_rapporto` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportGroupTotalsRefresh(NEW.id_resoconto, NEW.anno_reso);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportGroupReportLinkUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportGroupReportLinkUpdate` AFTER UPDATE ON `resoconto_rapporto` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportGroupTotalsRefresh(NEW.id_resoconto, NEW.anno_reso);
	
	IF (OLD.id_resoconto <> NEW.id_resoconto OR OLD.anno_reso <> NEW.anno_reso) THEN
		CALL sp_ariesReportGroupTotalsRefresh(OLD.id_resoconto, OLD.anno_reso);
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportGroupUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `trg_afterReportGroupUpdate` AFTER UPDATE ON `resoconto` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportGroupTotalsRefresh(NEW.id_resoconto, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportInsert` AFTER INSERT ON `rapporto` FOR EACH ROW 
BEGIN	
	INSERT INTO  rapporto_totali (id_rapporto, anno, costo_manutenzione, costo_lavoro, prezzo_lavoro, costo_viaggio, prezzo_viaggio, costo_materiale, prezzo_materiale, costo_totale, prezzo_totale)
	VALUES (NEW.id_rapporto, NEW.anno, 0, 0, 0, 0, 0, 0, 0, 0, 0);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportProductDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportProductDelete` AFTER DELETE ON `rapporto_materiale` FOR EACH ROW
BEGIN
	CALL sp_ariesReportTotalsRefresh(OLD.id_rapporto, OLD.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportProductInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportProductInsert` AFTER INSERT ON `rapporto_materiale` FOR EACH ROW 
BEGIN
	DECLARE allow_insert BIT(1);
	DECLARE is_kit BIT(1);

	IF new.id_materiale IS NOT NULL THEN

		SELECT  fnc_productAllowDepotsScale(new.id_materiale)
			INTO allow_insert;

			
		-- CHECK IF IS PRODCUT AND HAI DEPOTS ID
		IF (allow_insert = 1) AND (new.id_magazzino IS NOT NULL) THEN
			CALL sp_ariesDepotsScaleByReportProduct(new.id_rapporto, new.anno, new.id_tab,
				new.quantità, new.id_materiale);
		END IF;
	END IF;

	CALL sp_ariesReportTotalsRefresh(NEW.id_rapporto, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportProductUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportProductUpdate` AFTER UPDATE ON `rapporto_materiale` FOR EACH ROW 
BEGIN
	DECLARE allow_insert BIT;
	
	CALL sp_ariesReportTotalsRefresh(NEW.id_rapporto, NEW.anno);
	
	IF new.id_materiale IS NOT NULL THEN

		SELECT  fnc_productAllowDepotsScale(new.id_materiale)
			INTO allow_insert;

			
		-- CHECK IF IS PRODCUT AND HAI DEPOTS ID
		IF (allow_insert = 1) AND (new.id_magazzino IS NOT NULL) THEN
			CALL sp_ariesDepotsScaleByReportProduct(new.id_rapporto, new.anno, new.id_tab,
				new.quantità, new.id_materiale);
		END IF;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportTechnicianDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportTechnicianDelete` AFTER DELETE ON `rapporto_tecnico` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportTotalsRefresh(OLD.id_rapporto, OLD.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportTechnicianInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportTechnicianInsert` AFTER INSERT ON `rapporto_tecnico` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportTotalsRefresh(NEW.id_rapporto, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportTechnicianUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportTechnicianUpdate` AFTER UPDATE ON `rapporto_tecnico` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportTotalsRefresh(NEW.id_rapporto, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportTotalsDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportTotalsDelete` AFTER DELETE ON `rapporto_totali` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportGroupTotalsRefreshByReport(OLD.id_rapporto, OLD.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportTotalsInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportTotalsInsert` AFTER INSERT ON `rapporto_totali` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportGroupTotalsRefreshByReport(NEW.id_rapporto, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportTotalsUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportTotalsUpdate` AFTER UPDATE ON `rapporto_totali` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportGroupTotalsRefreshByReport(NEW.id_rapporto, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportWorkDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportWorkDelete` AFTER DELETE ON `rapporto_tecnico_lavoro` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportTotalsRefresh(OLD.id_rapporto, OLD.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportWorkInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportWorkInsert` AFTER INSERT ON `rapporto_tecnico_lavoro` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportTotalsRefresh(NEW.id_rapporto, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterReportWorkUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterReportWorkUpdate` AFTER UPDATE ON `rapporto_tecnico_lavoro` FOR EACH ROW 
BEGIN	
	CALL sp_ariesReportTotalsRefresh(NEW.id_rapporto, NEW.anno);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSupplerPriceListDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSupplerPriceListDelete` AFTER DELETE ON `fornitore_listino` FOR EACH ROW 
BEGIN
	DELETE FROM listino WHERE id_listino IN (OLD.netto,OLD.ultimo,OLD.speciale);	
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSupplierInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSupplierInsert` AFTER INSERT ON `fornitore` FOR EACH ROW
BEGIN
	DECLARE price_name VARCHAR(150);
	DECLARE net_name VARCHAR(150);
	DECLARE last_name VARCHAR(150);
	DECLARE special_name VARCHAR(150);

	SET price_name = CONCAT(NEW.id_fornitore,substring(NEW.ragione_sociale,1,8),"Prezzo");
	SET net_name = CONCAT(NEW.id_fornitore,substring(NEW.ragione_sociale,1,8),"Netto");
	SET last_name = CONCAT(NEW.id_fornitore,substring(NEW.ragione_sociale,1,8),"Ultimo");
	SET special_name = CONCAT(NEW.id_fornitore,substring(NEW.ragione_sociale,1,8),"Speciale");

	INSERT INTO listino(nome) values (price_name), (net_name), (last_name), (special_name);

	INSERT into fornitore_listino (id_fornitore,acquisto,netto,ultimo,speciale,nome)
	select
		NEW.id_fornitore,
		(select id_listino from listino where nome = price_name),
		(select id_listino from listino where nome = net_name),
		(select id_listino from listino where nome = last_name),
		(select id_listino from listino where nome = special_name),
		NEW.ragione_sociale;

END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSupplierInvoiceProductInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSupplierInvoiceProductInsert` AFTER INSERT ON `fornfattura_articoli` FOR EACH ROW BEGIN
	DECLARE allow_insert BIT;
	DECLARE depot_type INT;
	
	SELECT fnc_supplierInvoiceProductAllowDepotsScale(NEW.id_fattura, NEW.anno, NEW.id_materiale) INTO allow_insert;
	
	-- make insert IF allow
	IF allow_insert = 1 THEN
		SET depot_type = 1; -- MAGAZZINO
		CALL sp_ariesDepotsSupplierInvoiceProductInsert(NEW.id_fattura, NEW.anno, NEW.n_tab, NEW.quantità,
			NEW.id_materiale, depot_type);
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSupplierUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSupplierUpdate` AFTER UPDATE ON `fornitore` FOR EACH ROW
BEGIN
	DECLARE price_name VARCHAR(150);
	DECLARE net_name VARCHAR(150);
	DECLARE last_name VARCHAR(150);
	DECLARE special_name VARCHAR(150);

	DECLARE old_price_name VARCHAR(150);
	DECLARE old_net_name VARCHAR(150);
	DECLARE old_last_name VARCHAR(150);
	DECLARE old_special_name VARCHAR(150);

	IF NEW.ragione_sociale <> OLD.ragione_sociale THEN
		SET price_name = CONCAT(NEW.id_fornitore,substring(NEW.ragione_sociale,1,8),"Prezzo");
		SET net_name = CONCAT(NEW.id_fornitore,substring(NEW.ragione_sociale,1,8),"Netto");
		SET last_name = CONCAT(NEW.id_fornitore,substring(NEW.ragione_sociale,1,8),"Ultimo");
		SET special_name = CONCAT(NEW.id_fornitore,substring(NEW.ragione_sociale,1,8),"Speciale");
		
		SET old_price_name = CONCAT(OLD.id_fornitore,substring(OLD.ragione_sociale,1,8),"Prezzo");
		SET old_net_name = CONCAT(OLD.id_fornitore,substring(OLD.ragione_sociale,1,8),"Netto");
		SET old_last_name = CONCAT(OLD.id_fornitore,substring(OLD.ragione_sociale,1,8),"Ultimo");
		SET old_special_name = CONCAT(OLD.id_fornitore,substring(OLD.ragione_sociale,1,8),"Speciale");

		UPDATE listino SET nome = price_name WHERE nome = old_price_name;
		UPDATE listino SET nome = net_name WHERE nome = old_net_name;
		UPDATE listino SET nome = last_name WHERE nome = old_last_name;
		UPDATE listino SET nome = special_name WHERE nome = old_special_name;

		UPDATE fornitore_listino
		SET nome =NEW.ragione_sociale
		WHERE id_fornitore = new.id_fornitore;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSystemComponentVersionDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSystemComponentVersionDelete` AFTER DELETE ON `impianto_componenti_versione` FOR EACH ROW 
BEGIN
	DECLARE version_id INT(11) DEFAULT NULL;

	SELECT MAX(id_versione)
		INTO version_id
	FROM impianto_componenti_versione
	WHERE id_impianto = old.id_impianto AND id_articolo = old.id_articolo AND codice = old.codice;

	
	UPDATE impianto_componenti
	SET id_versione = version_id
	WHERE id_impianto = old.id_impianto AND id_articolo = old.id_articolo AND id = old.codice;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSystemComponentVersionInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSystemComponentVersionInsert` AFTER INSERT ON `impianto_componenti_versione` FOR EACH ROW 
BEGIN
	UPDATE impianto_componenti
	SET id_versione = new.id_versione
	WHERE id_impianto = new.id_impianto AND id_articolo = new.id_articolo AND id = new.codice;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSystemSubscriptionDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSystemSubscriptionDelete` AFTER DELETE ON `impianto_abbonamenti` FOR EACH ROW 
BEGIN	
	CALL sp_ariesSystemCurrentSubscriptionRefresh(OLD.id_impianto);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSystemSubscriptionInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSystemSubscriptionInsert` AFTER INSERT ON `impianto_abbonamenti` FOR EACH ROW 
BEGIN	
	CALL sp_ariesSystemCurrentSubscriptionRefresh(NEW.id_impianto);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_afterSystemSubscriptionUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_afterSystemSubscriptionUpdate` AFTER UPDATE ON `impianto_abbonamenti` FOR EACH ROW 
BEGIN
	IF (OLD.id_impianto <> NEW.id_impianto) THEN
		CALL sp_ariesSystemCurrentSubscriptionRefresh(OLD.id_impianto);
		CALL sp_ariesSystemCurrentSubscriptionRefresh(NEW.id_impianto);
	ELSEIF (OLD.id_abbonamenti <> NEW.id_abbonamenti) THEN
		CALL sp_ariesSystemCurrentSubscriptionRefresh(OLD.id_impianto);
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeContactFigureInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeContactFigureInsert` BEFORE INSERT ON `riferimento_figura` FOR EACH ROW 
BEGIN
	IF NEW.Abbreviazione = '' OR NEW.Abbreviazione IS NULL THEN
		SET NEW.Abbreviazione = UPPER(TRIM(SUBSTRING(NEW.Figura, 1, 3)));
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeContactFigureUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeContactFigureUpdate` BEFORE UPDATE ON `riferimento_figura` FOR EACH ROW 
BEGIN
	IF OLD.Figura <> NEW.Figura AND OLD.Abbreviazione = NEW.Abbreviazione THEN
		SET NEW.Abbreviazione = UPPER(TRIM(SUBSTRING(NEW.Figura, 1, 3)));
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeContractInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeContractInsert` BEFORE INSERT ON `contratto` FOR EACH ROW 
BEGIN
	SET NEW.data_inserimento = NOW();
	SET NEW.data=NOW();

	IF NEW.tipo_stampa IS NULL THEN
		SET NEW.tipo_stampa = (SELECT CAST(var_value AS UNSIGNED) FROM environment_variables WHERE var_key = 'DEFAULT_CONTRACT_PRINT_TYPE');
	END IF;

	IF NEW.iban IS NULL THEN
		SET NEW.iban = (SELECT iban FROM azienda ORDER BY id_azienda DESC LIMIT 1);
	END IF;

	IF NEW.pagamento IS NULL THEN
		SET NEW.pagamento = (SELECT condizione_pagamento FROM clienti WHERE id_cliente=NEW.id_cliente);
	END IF;

	IF NEW.id_destinazione IS NULL THEN
		SET NEW.id_destinazione = (SELECT destinazione FROM revisione_preventivo WHERE id_preventivo = NEW.id_preventivo AND anno = NEW.anno AND id_revisione = NEW.id_revisione);
	END IF;
	
	IF NEW.signor IS NULL THEN
		SET NEW.signor = (SELECT cortese FROM revisione_preventivo WHERE id_preventivo = NEW.id_preventivo AND anno = NEW.anno AND id_revisione = NEW.id_revisione);
	END IF;

	IF (NEW.signor IS NOT NULL) AND (NEW.telefono IS NULL) THEN
		SET NEW.telefono = (SELECT IF(altro_telefono = '' OR altro_telefono IS NULL, telefono, altro_telefono) FROM riferimento_clienti rc WHERE rc.Nome = NEW.signor AND id_cliente = NEW.id_cliente);
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeCustomerContactInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `trg_beforeCustomerContactInsert` BEFORE INSERT ON `riferimento_clienti` FOR EACH ROW 
BEGIN
	IF NEW.id_pubblico IS NULL THEN
		SET NEW.id_pubblico = UUID();
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeDdtProductDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeDdtProductDelete` BEFORE DELETE ON `articoli_ddt` FOR EACH ROW 
BEGIN
	DECLARE has_job_link BIT(1);

	-- ## CHECK JOB STATE
	SELECT fnc_ddtHasJobLink(OLD.id_ddt, OLD.anno)
		INTO has_job_link;
	IF has_job_link = 1 THEN
		SIGNAL SQLSTATE '45000'
     	SET MESSAGE_TEXT = 'Cannot insert ddt product becacuse of the job link must be delete before.';
	END IF;

	-- ## RESET DEPOTS STATE
	CALL sp_ariesDepotsDdtProductDelete(OLD.id_ddt, OLD.anno, OLD.numero_tab);

	-- ## RESET SYSTEM PRODUCTS
	CALL sp_ariesSystemsDdtProductDelete(OLD.id_ddt, OLD.anno,
		OLD.id_Articolo, OLD.numero_tab);

END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeDdtProductInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeDdtProductInsert` BEFORE INSERT ON `articoli_ddt` FOR EACH ROW 
BEGIN
	DECLARE has_job_link BIT(1);

	SELECT fnc_ddtHasJobLink(NEW.id_ddt, NEW.anno)
		INTO has_job_link;
	IF has_job_link = 1 THEN
		SIGNAL SQLSTATE '45000'
     	SET MESSAGE_TEXT = 'Cannot update ddt product becacuse of the job link already exists.';
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeDdtProductUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeDdtProductUpdate` BEFORE UPDATE ON `articoli_ddt` FOR EACH ROW 
BEGIN
	DECLARE has_job_link BIT(1);

	SELECT fnc_ddtHasJobLink(NEW.id_ddt, NEW.anno)
		INTO has_job_link;
	IF has_job_link = 1 THEN
		SIGNAL SQLSTATE '45000'
     	SET MESSAGE_TEXT = 'Cannot update ddt product becacuse of the job link already exists.';
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeEmployeeDpiDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeEmployeeDpiDelete` BEFORE DELETE ON `operaio_dpi` FOR EACH ROW 
BEGIN	
	CALL sp_ariesEmployeeDpiDeleteReminderEvent(OLD.id_dpi);
	CALL sp_ariesEmployeeDpiDeleteExpirationEvent(OLD.id_dpi);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeEmployeeDpiInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeEmployeeDpiInsert` BEFORE INSERT ON `operaio_dpi` FOR EACH ROW 
BEGIN
	DECLARE reminder_event_id INT(11);
	DECLARE expiration_event_id INT(11);

	IF NEW.data_promemoria IS NOT NULL THEN
		CALL sp_ariesEmployeeDpiEnsureReminderEvent(
			NEW.id_dpi,
			NEW.Id_operaio,
			NEW.id_articolo,
			NEW.data_promemoria,
			NEW.id_evento_promemoria,
			NEW.data_scadenza,
			NEW.id_evento_scadenza,
			reminder_event_id
		);
		SET NEW.id_evento_promemoria = reminder_event_id;
	END IF;

	
	IF NEW.data_scadenza IS NOT NULL THEN
		CALL sp_ariesEmployeeDpiEnsureExpirationEvent(
			NEW.id_dpi,
			NEW.Id_operaio,
			NEW.id_articolo,
			NEW.data_promemoria,
			NEW.id_evento_promemoria,
			NEW.data_scadenza,
			NEW.id_evento_scadenza,
			expiration_event_id
		);
		SET NEW.id_evento_scadenza = expiration_event_id;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeEmployeeDpiUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeEmployeeDpiUpdate` BEFORE UPDATE ON `operaio_dpi` FOR EACH ROW 
BEGIN
	DECLARE reminder_event_id INT(11);
	DECLARE expiration_event_id INT(11);

	IF NEW.stato != OLD.stato AND NEW.stato IN (3, 4) THEN
		CALL sp_ariesEmployeeDpiDeleteReminderEvent(NEW.id_dpi);
		CALL sp_ariesEmployeeDpiDeleteExpirationEvent(NEW.id_dpi);

		SET NEW.id_evento_promemoria = NULL;
		SET NEW.id_evento_scadenza = NULL;
	ELSE
		IF NEW.data_promemoria IS NULL THEN
			CALL sp_ariesEmployeeDpiDeleteReminderEvent(NEW.id_dpi);
			SET NEW.id_evento_promemoria = NULL;
		ELSE
			CALL sp_ariesEmployeeDpiEnsureReminderEvent(
				NEW.id_dpi,
				NEW.Id_operaio,
				NEW.id_articolo,
				NEW.data_promemoria,
				NEW.id_evento_promemoria,
				NEW.data_scadenza,
				NEW.id_evento_scadenza,
				reminder_event_id
			);
			SET NEW.id_evento_promemoria = reminder_event_id;
		END IF;
		
		IF NEW.data_scadenza IS NULL THEN
			CALL sp_ariesEmployeeDpiDeleteExpirationEvent(NEW.id_dpi);
			SET NEW.id_evento_scadenza = NULL;
		ELSE
			CALL sp_ariesEmployeeDpiEnsureExpirationEvent(
				NEW.id_dpi,
				NEW.Id_operaio,
				NEW.id_articolo,
				NEW.data_promemoria,
				NEW.id_evento_promemoria,
				NEW.data_scadenza,
				NEW.id_evento_scadenza,
				expiration_event_id
			);
			SET NEW.id_evento_scadenza = expiration_event_id;
		END IF;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeEmployeeInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `trg_beforeEmployeeInsert` BEFORE INSERT ON `operaio` FOR EACH ROW 
BEGIN
	IF NEW.id_pubblico IS NULL THEN
		SET NEW.id_pubblico = UUID();
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeInvoiceInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeInvoiceInsert` BEFORE INSERT ON `fattura` FOR EACH ROW 
BEGIN
	DECLARE allow_insert INT(11);

	CALL sp_ariesInvoiceCheckAllowedIdAndDate(NEW.id_fattura, NEW.anno, NEW.data, allow_insert);

	IF not allow_insert THEN
		SIGNAL SQLSTATE '45000'
     	SET MESSAGE_TEXT = 'Cannot insert the invoice because the date is smaller than prev id date.';
	END IF;

END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeInvoiceProductDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeInvoiceProductDelete` BEFORE DELETE ON `fattura_articoli` FOR EACH ROW 
BEGIN
	CALL sp_ariesDepotsInvoiceProductDelete(OLD.id_fattura, OLD.anno, OLD.n_tab);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeInvoiceUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeInvoiceUpdate` BEFORE UPDATE ON `fattura` FOR EACH ROW 
BEGIN
	DECLARE allow_update INT(11);

	IF NEW.data != OLD.data OR NEW.anno != OLD.anno THEN
		CALL sp_ariesInvoiceCheckAllowedIdAndDate(NEW.id_fattura, NEW.anno, NEW.data, allow_update);

		IF not allow_update THEN
			SIGNAL SQLSTATE '45000'
			SET MESSAGE_TEXT = 'Cannot insert the invoice because the date is smaller than prev invoice date.';
		END IF;
	END IF;

END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeQuoteUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeQuoteUpdate` BEFORE UPDATE ON `preventivo` FOR EACH ROW 
BEGIN
	IF NEW.stato != OLD.stato THEN
		IF fnc_quoteStatusShouldClearReminders(NEW.stato) THEN
			SET NEW.primo_sollecito = NULL;
			SET NEW.secondo_sollecito = NULL;
		END IF;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeReceivedDdtProductDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeReceivedDdtProductDelete` BEFORE DELETE ON `articoli_ddt_ricevuti` FOR EACH ROW 
BEGIN
	CALL sp_ariesDepotsReceivedDdtProductDelete(OLD.id_ddt, OLD.anno, OLD.numero_tab);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeReportProductDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeReportProductDelete` BEFORE DELETE ON `rapporto_materiale` FOR EACH ROW
BEGIN
	DECLARE has_job_link BIT(1);

	SELECT fnc_reportHasJobLink(OLD.id_rapporto, OLD.anno)
		INTO has_job_link;
	IF has_job_link = 1 THEN
		SIGNAL SQLSTATE '45000'
     	SET MESSAGE_TEXT = 'Cannot insert report product becacuse of the job link must be delete before.';
	END IF;
	
	CALL sp_ariesDepotsReportProductDelete(old.id_rapporto, old.anno, old.id_tab);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeReportProductInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeReportProductInsert` BEFORE INSERT ON `rapporto_materiale` FOR EACH ROW 
BEGIN

	DECLARE report_exec_date DATE;
	DECLARE has_job_link BIT(1);

	SELECT fnc_reportHasJobLink(NEW.id_rapporto, NEW.anno)
		INTO has_job_link;
	IF has_job_link = 1 THEN
		SIGNAL SQLSTATE '45000'
     	SET MESSAGE_TEXT = 'Cannot insert report product becacuse of the job link already exists.';
	END IF;

END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeReportProductUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeReportProductUpdate` BEFORE UPDATE ON `rapporto_materiale` FOR EACH ROW 
BEGIN
	DECLARE has_job_link BIT(1);

	SELECT fnc_reportHasJobLink(NEW.id_rapporto, NEW.anno)
		INTO has_job_link;
	IF has_job_link = 1 THEN
		SIGNAL SQLSTATE '45000'
     	SET MESSAGE_TEXT = 'Cannot update report product becacuse of the job link already exists.';

	ELSE
		CALL sp_ariesDepotsReportProductDelete(old.id_rapporto, old.anno, old.id_tab);
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeSupplierContactInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO';
DELIMITER //
CREATE TRIGGER `trg_beforeSupplierContactInsert` BEFORE INSERT ON `riferimento_fornitore` FOR EACH ROW 
BEGIN
	IF NEW.id_pubblico IS NULL THEN
		SET NEW.id_pubblico = UUID();
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeSupplierInvoiceProductDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeSupplierInvoiceProductDelete` BEFORE DELETE ON `fornfattura_articoli` FOR EACH ROW 
BEGIN
	CALL sp_ariesDepotsSupplierInvoiceProductDelete(OLD.id_fattura, OLD.anno, OLD.n_tab);
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeTicketDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeTicketDelete` BEFORE DELETE ON `ticket` FOR EACH ROW 
BEGIN	
	CALL sp_ariesTicketDeleteReminderEvent(OLD.id_ticket, OLD.anno, IFNULL(@USER_ID, OLD.id_utente));
	CALL sp_ariesTicketDeleteExpirationEvent(OLD.id_ticket, OLD.anno, IFNULL(@USER_ID, OLD.id_utente));
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeTicketInsert
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeTicketInsert` BEFORE INSERT ON `ticket` FOR EACH ROW 
BEGIN
	DECLARE reminder_event_id INT(11);
	DECLARE expiration_event_id INT(11);

	SET NEW.id_utente = IFNULL(NEW.id_utente, @USER_ID);

	IF NEW.data_promemoria IS NOT NULL THEN
		CALL sp_ariesTicketEnsureReminderEvent(
			NEW.id_ticket,
			NEW.anno,
			NEW.id_impianto,
			NEW.id_cliente,
			NEW.urgenza,
			NEW.data_promemoria,
			NEW.id_evento_promemoria,
			NEW.scadenza,
			NEW.id_evento_scadenza,
			NEW.descrizione,
			NEW.id_utente,
			reminder_event_id
		);
		SET NEW.id_evento_promemoria = reminder_event_id;
	END IF;

	
	IF NEW.scadenza IS NOT NULL THEN
		CALL sp_ariesTicketEnsureExpirationEvent(
			NEW.id_ticket,
			NEW.anno,
			NEW.id_impianto,
			NEW.id_cliente,
			NEW.urgenza,
			NEW.data_promemoria,
			NEW.id_evento_promemoria,
			NEW.scadenza,
			NEW.id_evento_scadenza,
			NEW.descrizione,
			NEW.id_utente,
			expiration_event_id
		);
		SET NEW.id_evento_scadenza = expiration_event_id;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeTicketUpdate
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeTicketUpdate` BEFORE UPDATE ON `ticket` FOR EACH ROW 
BEGIN
	DECLARE reminder_event_id INT(11);
	DECLARE expiration_event_id INT(11);
	DECLARE user_id INT(11);

	

	SET user_id = IFNULL(@USER_ID, NEW.id_utente);


	IF NEW.stato_ticket != OLD.stato_ticket AND NEW.stato_ticket IN (3, 4) THEN
		CALL sp_ariesTicketDeleteReminderEvent(NEW.id_ticket, NEW.anno, user_id);
		CALL sp_ariesTicketDeleteExpirationEvent(NEW.id_ticket, NEW.anno, user_id);

		SET NEW.id_evento_promemoria = NULL;
		SET NEW.id_evento_scadenza = NULL;
	ELSE
		IF NEW.data_promemoria IS NULL THEN
			CALL sp_ariesTicketDeleteReminderEvent(NEW.id_ticket, NEW.anno, user_id);
			SET NEW.id_evento_promemoria = NULL;
		ELSE
			CALL sp_ariesTicketEnsureReminderEvent(
				NEW.id_ticket,
				NEW.anno,
				NEW.id_impianto,
				NEW.id_cliente,
				NEW.urgenza,
				NEW.data_promemoria,
				NEW.id_evento_promemoria,
				NEW.scadenza,
				NEW.id_evento_scadenza,
				NEW.descrizione,
				user_id,
				reminder_event_id
			);
			SET NEW.id_evento_promemoria = reminder_event_id;
		END IF;
		
		IF NEW.scadenza IS NULL THEN
			CALL sp_ariesTicketDeleteExpirationEvent(NEW.id_ticket, NEW.anno, user_id);
			SET NEW.id_evento_scadenza = NULL;
		ELSE
			CALL sp_ariesTicketEnsureExpirationEvent(
				NEW.id_ticket,
				NEW.anno,
				NEW.id_impianto,
				NEW.id_cliente,
				NEW.urgenza,
				NEW.data_promemoria,
				NEW.id_evento_promemoria,
				NEW.scadenza,
				NEW.id_evento_scadenza,
				NEW.descrizione,
				user_id,
				expiration_event_id
			);
			SET NEW.id_evento_scadenza = expiration_event_id;
		END IF;
	END IF;
END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Dump della struttura di trigger emmebi.trg_beforeTitleTypeDelete
SET @OLDTMP_SQL_MODE=@@SQL_MODE, SQL_MODE='STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';
DELIMITER //
CREATE TRIGGER `trg_beforeTitleTypeDelete` BEFORE DELETE ON `tipo_titolo` FOR EACH ROW 
BEGIN
	DECLARE rif_counter INT(11);

	SELECT COUNT(*)
		INTO rif_counter
	FROM riferimento_clienti
	WHERE titolo = OLD.nome;

	IF rif_counter > 0 THEN
		SIGNAL SQLSTATE '45000'
     	SET MESSAGE_TEXT = 'Cannot delete "tipo_titolo" becacuse it is in use on "riferimento_clienti"';
	END IF;

END//
DELIMITER ;
SET SQL_MODE=@OLDTMP_SQL_MODE;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `subvw_depots_types_products`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `subvw_depots_types_products` AS select `articolo`.`Codice_articolo` AS `Codice_articolo`,`articolo`.`Desc_brev` AS `Desc_brev`,`articolo`.`Codice_fornitore` AS `Codice_fornitore`,`articolo`.`Marca` AS `Marca`,`articolo`.`Peso` AS `Peso`,`articolo`.`Altre_caratteristiche` AS `Altre_caratteristiche`,`articolo`.`scadenza` AS `scadenza`,`articolo`.`Fornitore_Priv` AS `Fornitore_Priv`,`articolo`.`Tempo_installazione` AS `Tempo_installazione`,`articolo`.`Categoria` AS `Categoria`,`articolo`.`Sottocategoria` AS `Sottocategoria`,`articolo`.`sottocategoria2` AS `sottocategoria2`,`articolo`.`Barcode` AS `Barcode`,`articolo`.`quantita_minima` AS `quantita_minima`,`articolo`.`quantita_massima` AS `quantita_massima`,`articolo`.`Numero_confezione` AS `Numero_confezione`,`articolo`.`unità_misura` AS `unità_misura`,`articolo`.`ult_vendita` AS `ult_vendita`,`articolo`.`Garanzia` AS `Garanzia`,`articolo`.`Minuti_manutenzione` AS `Minuti_manutenzione`,`articolo`.`Stato_articolo` AS `Stato_articolo`,`articolo`.`Data_modifica` AS `Data_modifica`,`articolo`.`Data_inserimento` AS `Data_inserimento`,`articolo`.`umidità` AS `umidità`,`articolo`.`min` AS `min`,`articolo`.`max` AS `max`,`articolo`.`l` AS `l`,`articolo`.`h` AS `h`,`articolo`.`p` AS `p`,`articolo`.`modifica` AS `modifica`,`articolo`.`kw` AS `kw`,`articolo`.`litri` AS `litri`,`articolo`.`kwp` AS `kwp`,`articolo`.`color` AS `color`,`articolo`.`moltiplicatore` AS `moltiplicatore`,`articolo`.`is_kit` AS `is_kit`,`articolo`.`scaffaliera_magazzino` AS `scaffaliera_magazzino`,`articolo`.`ripiano_magazzino` AS `ripiano_magazzino`,`articolo`.`descrizione_posizione_magazzino` AS `descrizione_posizione_magazzino`,`articolo`.`id_tipo_costo_produzione` AS `id_tipo_costo_produzione`,`tipo_magazzino`.`Id_tipo` AS `Id_tipo`,`tipo_magazzino`.`nome` AS `nome`,`tipo_magazzino`.`Descrizione` AS `Descrizione`,`tipo_magazzino`.`prior` AS `prior`,`tipo_magazzino`.`id_master` AS `id_master`,`tipo_magazzino`.`reso` AS `reso`,`tipo_magazzino`.`disabilitato` AS `disabilitato` from (`articolo` join `tipo_magazzino`)
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `subvw_productsunionsearch`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `subvw_productsunionsearch` AS select `articolo`.`Codice_articolo` AS `codice_articolo`,`articolo`.`Codice_fornitore` AS `codice_fornitore`,`articolo`.`Barcode` AS `barcode`,'' AS `codice`,`articolo`.`Desc_brev` AS `desc_brev`,`articolo`.`unità_misura` AS `unità_misura`,`articolo_stato`.`colore` AS `colore`,`articolo`.`Desc_brev` AS `Descrizione`,`articolo`.`Categoria` AS `Categoria`,`articolo`.`Sottocategoria` AS `Sottocategoria`,`articolo_stato`.`colore` AS `stato_articolo`,`marca`.`Nome` AS `marca`,`articolo`.`Tempo_installazione` AS `tempo_installazione`,`articolo_stato`.`bloccato` AS `bloccato`,`articolo`.`is_kit` AS `is_kit` from ((`articolo` left join `marca` on((`marca`.`Id_marca` = `articolo`.`Marca`))) join `articolo_stato` on((`articolo_stato`.`Id_stato` = `articolo`.`Stato_articolo`))) union all select `articolo`.`Codice_articolo` AS `codice_articolo`,`articolo_codice`.`codice` AS `codice_fornitore`,`articolo`.`Barcode` AS `barcode`,`articolo_codice`.`codice` AS `codice`,`articolo`.`Desc_brev` AS `desc_brev`,`articolo`.`unità_misura` AS `unità_misura`,`articolo_stato`.`colore` AS `colore`,`articolo`.`Desc_brev` AS `Descrizione`,`articolo`.`Categoria` AS `Categoria`,`articolo`.`Sottocategoria` AS `Sottocategoria`,`articolo_stato`.`colore` AS `stato_articolo`,`marca`.`Nome` AS `marca`,`articolo`.`Tempo_installazione` AS `tempo_installazione`,`articolo_stato`.`bloccato` AS `bloccato`,`articolo`.`is_kit` AS `is_kit` from (((`articolo` join `articolo_codice` on((`articolo`.`Codice_articolo` = `articolo_codice`.`id_articolo`))) left join `marca` on((`marca`.`Id_marca` = `articolo`.`Marca`))) join `articolo_stato` on((`articolo_stato`.`Id_stato` = `articolo`.`Stato_articolo`)))
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_contatsexport`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_contatsexport` AS select trim(`cl`.`Ragione_Sociale`) AS `ragione_sociale`,if(isnull(`dc`.`Frazione`),`c`.`Nome`,concat(`c`.`Nome`,' - ',`f`.`Nome`)) AS `paese`,`c`.`cap` AS `cap`,`dc`.`Provincia` AS `provincia`,if((isnull(`dc`.`numero_civico`) or (`dc`.`Indirizzo` = '')),`dc`.`Indirizzo`,concat(`dc`.`Indirizzo`,', ',`dc`.`numero_civico`)) AS `indirizzo`,`cl`.`Data_inserimento` AS `data_inserimento`,`rc`.`Nome` AS `nome`,`sc`.`Nome` AS `status`,`rfg`.`Figura` AS `figura`,`rfg`.`Abbreviazione` AS `abbreviazione_figura`,`rc`.`Telefono` AS `telefono`,`rc`.`altro_telefono` AS `altro_telefono`,`rc`.`fax` AS `fax`,`rc`.`centralino` AS `centralino`,`rc`.`mail` AS `mail`,`cl`.`Id_cliente` AS `id`,if((`cl`.`Tipo_Cliente` = 6),'customer_private','customer_company') AS `record_type`,`rc`.`id_pubblico` AS `id_pubblico` from ((((((`clienti` `cl` join `riferimento_clienti` `rc` on((`cl`.`Id_cliente` = `rc`.`Id_cliente`))) left join `destinazione_cliente` `dc` on(((`dc`.`id_cliente` = `cl`.`Id_cliente`) and (`dc`.`Id_destinazione` = '1')))) left join `riferimento_figura` `rfg` on((`rfg`.`Id_figura` = `rc`.`figura`))) left join `comune` `c` on((`c`.`Id_comune` = `dc`.`Comune`))) left join `frazione` `f` on((`f`.`Id_frazione` = `dc`.`Frazione`))) left join `stato_clienti` `sc` on((`sc`.`Id_stato` = `cl`.`Stato_cliente`))) where ((`rc`.`Telefono` <> '') or (`rc`.`altro_telefono` <> '')) union all select trim(`fr`.`Ragione_Sociale`) AS `ragione_sociale`,if(isnull(`df`.`Frazione`),`c`.`Nome`,concat(`c`.`Nome`,' - ',`f`.`Nome`)) AS `paese`,`c`.`cap` AS `cap`,`df`.`Provincia` AS `provincia`,if((isnull(`df`.`numero_civico`) or (`df`.`Indirizzo` = '')),`df`.`Indirizzo`,concat(`df`.`Indirizzo`,', ',`df`.`numero_civico`)) AS `indirizzo`,`fr`.`Data_inserimento` AS `data_inserimento`,`rf`.`Nome` AS `nome`,`sf`.`Nome` AS `status`,`rfg`.`Figura` AS `figura`,`rfg`.`Abbreviazione` AS `abbreviazione_figura`,`rf`.`Telefono` AS `telefono`,`rf`.`altro_telefono` AS `altro_telefono`,`rf`.`fax` AS `fax`,`rf`.`centralino` AS `centralino`,`rf`.`mail` AS `mail`,`fr`.`Id_fornitore` AS `id`,'supplier' AS `record_type`,`rf`.`id_pubblico` AS `id_pubblico` from ((((((`fornitore` `fr` join `riferimento_fornitore` `rf` on((`rf`.`Id_fornitore` = `fr`.`Id_fornitore`))) left join `destinazione_fornitore` `df` on(((`df`.`id_fornitore` = `fr`.`Id_fornitore`) and (`df`.`Id_destinazione` = '1')))) left join `riferimento_figura` `rfg` on((`rfg`.`Id_figura` = `rf`.`figura`))) left join `comune` `c` on((`c`.`Id_comune` = `df`.`Comune`))) left join `frazione` `f` on((`f`.`Id_frazione` = `df`.`Frazione`))) left join `stato_fornitore` `sf` on((`sf`.`Id_stato` = `fr`.`Stato_Fornitore`))) where ((`rf`.`Telefono` <> '') or (`rf`.`altro_telefono` <> '')) union all select trim(`o`.`Ragione_sociale`) AS `ragione_sociale`,if(isnull(`o`.`Frazione`),`c`.`Nome`,concat(`c`.`Nome`,' - ',`f`.`Nome`)) AS `paese`,`c`.`cap` AS `cap`,`o`.`Provincia` AS `provincia`,`o`.`Indirizzo` AS `indirizzo`,`o`.`Data_assunzione` AS `Data_assunzione`,'ATTIVO' AS `ATTIVO`,'' AS `Name_exp_44`,'Dipendente' AS `Dipendente`,'DIP' AS `DIP`,`o`.`Telefono_abitazione` AS `Telefono_abitazione`,`o`.`altro_telefono` AS `altro_telefono`,'' AS `Name_exp_49`,'' AS `Name_exp_50`,`o`.`E_mail` AS `E_mail`,`o`.`Id_operaio` AS `id`,'employee' AS `record_type`,`o`.`id_pubblico` AS `id_pubblico` from ((`operaio` `o` left join `comune` `c` on((`c`.`Id_comune` = `o`.`Comune`))) left join `frazione` `f` on((`f`.`Id_frazione` = `o`.`Frazione`))) where (ifnull(`o`.`Data_licenziamento`,curdate()) >= curdate()) order by `ragione_sociale`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_customerinsolvent`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_customerinsolvent` AS select `clienti`.`Id_cliente` AS `Id_Cliente`,`clienti`.`Ragione_Sociale` AS `Ragione_sociale`,`province`.`Sigla` AS `Provincia`,if(isnull(`frazione`.`Nome`),`comune`.`Nome`,concat(`frazione`.`Nome`,' di ',`comune`.`Nome`)) AS `Citta`,`comune`.`cap` AS `CAP`,`destinazione_cliente`.`Indirizzo` AS `Indirizzo`,ifnull(`destinazione_cliente`.`numero_civico`,0) AS `Civico`,`riferimento_clienti`.`Telefono` AS `Telefono`,`riferimento_clienti`.`altro_telefono` AS `Cellulare` from (((((`clienti` join `destinazione_cliente` on(((`clienti`.`Id_cliente` = `destinazione_cliente`.`id_cliente`) and (`destinazione_cliente`.`Sede_principale` = 1)))) join `riferimento_clienti` on(((`clienti`.`Id_cliente` = `riferimento_clienti`.`Id_cliente`) and (`riferimento_clienti`.`Id_riferimento` = 1)))) left join `comune` on((`comune`.`Id_comune` = `destinazione_cliente`.`Comune`))) left join `province` on((`province`.`Sigla` = `destinazione_cliente`.`Provincia`))) left join `frazione` on((`frazione`.`Id_frazione` = `destinazione_cliente`.`Frazione`))) where (`clienti`.`Insolvente` = 1) group by `clienti`.`Id_cliente` order by `clienti`.`Ragione_Sociale`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_customersexport`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_customersexport` AS select `cl`.`Id_cliente` AS `id_cliente`,trim(`cl`.`Ragione_Sociale`) AS `ragione_sociale`,if(isnull(`dc`.`Frazione`),`c`.`Nome`,concat(`c`.`Nome`,' - ',`f`.`Nome`)) AS `paese`,`c`.`cap` AS `cap`,`dc`.`Provincia` AS `provincia`,if((isnull(`dc`.`numero_civico`) or (`dc`.`Indirizzo` = '')),`dc`.`Indirizzo`,concat(`dc`.`Indirizzo`,', ',`dc`.`numero_civico`)) AS `indirizzo`,`cl`.`Data_inserimento` AS `data_inserimento`,`rc`.`Nome` AS `nome`,`sc`.`Nome` AS `status`,`tc`.`Id_tipo` AS `id_tipo_cliente`,`tc`.`Nome` AS `tipo_cliente`,`tr`.`nome` AS `tipo_rapporto`,`ta`.`nome` AS `tipo_attivita`,`rfg`.`Figura` AS `figura`,`rc`.`Telefono` AS `telefono`,`rc`.`altro_telefono` AS `altro_telefono`,`rc`.`fax` AS `fax`,`rc`.`centralino` AS `centralino`,`rc`.`mail` AS `mail`,`dc`.`Tempo_strada` AS `tempo_strada`,`dc`.`Km_sede` AS `km_sede` from (((((((((`clienti` `cl` join `riferimento_clienti` `rc` on((`cl`.`Id_cliente` = `rc`.`Id_cliente`))) left join `destinazione_cliente` `dc` on(((`dc`.`id_cliente` = `cl`.`Id_cliente`) and (`dc`.`Id_destinazione` = '1')))) left join `riferimento_figura` `rfg` on((`rfg`.`Id_figura` = `rc`.`figura`))) left join `comune` `c` on((`c`.`Id_comune` = `dc`.`Comune`))) left join `frazione` `f` on((`f`.`Id_frazione` = `dc`.`Frazione`))) join `stato_clienti` `sc` on((`sc`.`Id_stato` = `cl`.`Stato_cliente`))) join `tipo_cliente` `tc` on((`tc`.`Id_tipo` = `cl`.`Tipo_Cliente`))) left join `tipo_rapclie` `tr` on((`tr`.`id_tipo` = `cl`.`tipo_rapporto`))) left join `tipo_attivita` `ta` on((`ta`.`id_tipo` = `cl`.`id_attività`))) where ((ifnull(`rc`.`Telefono`,'') <> '') or (ifnull(`rc`.`altro_telefono`,'') <> '') or (ifnull(`rc`.`mail`,'') <> '')) order by trim(`cl`.`Ragione_Sociale`)
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_dashboardgridsystemperiodicmonitoring`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_dashboardgridsystemperiodicmonitoring` AS select `impianto_abbonamenti_mesi`.`impianto` AS `id`,`impianto_abbonamenti_mesi`.`mese` AS `id_mese`,`impianto_abbonamenti_mesi`.`anno` AS `anno`,`impianto`.`Id_impianto` AS `id_impianto`,`impianto`.`Descrizione` AS `descrizione`,`clienti`.`Ragione_Sociale` AS `cliente`,if(isnull(`impianto_abbonamenti_mesi`.`Eseguito_il`),0,1) AS `svolto`,1 AS `tipo`,ifnull(`impianto_abbonamenti_mesi`.`Eseguito_il`,`impianto_abbonamenti_mesi`.`da_eseguire`) AS `da_eseguire` from ((`impianto_abbonamenti_mesi` join `impianto` on((`impianto_abbonamenti_mesi`.`impianto` = `impianto`.`Id_impianto`))) join `clienti` on((`impianto`.`Id_cliente` = `clienti`.`Id_cliente`))) where (`impianto_abbonamenti_mesi`.`da_eseguire` between (now() - interval 6 month) and (now() + interval 6 month)) union select distinct NULL AS `Id`,`mese`.`Id_mese` AS `Id_mese`,`impianto_abbonamenti_mesi`.`anno` AS `anno`,NULL AS `Id_impianto`,concat(`mese`.`Nome`,' ',`impianto_abbonamenti_mesi`.`anno`) AS `descrizione`,NULL AS `cliente`,0 AS `Svolto`,0 AS `Tipo`,NULL AS `da_eseguire` from (`impianto_abbonamenti_mesi` join `mese` on((`mese`.`Id_mese` = `impianto_abbonamenti_mesi`.`mese`))) where (`impianto_abbonamenti_mesi`.`da_eseguire` between (now() - interval 6 month) and (now() + interval 6 month)) order by `anno`,`id_mese`,`tipo`,`cliente`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_dashboardgridsystemreminder`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_dashboardgridsystemreminder` AS select `impianto_mesi`.`Id_impianto` AS `id`,`impianto_mesi`.`Id_mese` AS `id_mese`,0 AS `anno`,`impianto`.`Id_impianto` AS `id_impianto`,`impianto`.`Descrizione` AS `descrizione`,`clienti`.`Ragione_Sociale` AS `cliente`,0 AS `svolto`,1 AS `tipo`,NULL AS `da_eseguire` from ((`impianto_mesi` join `impianto` on((`impianto_mesi`.`Id_impianto` = `impianto`.`Id_impianto`))) join `clienti` on((`impianto`.`Id_cliente` = `clienti`.`Id_cliente`))) where ((`impianto`.`Stato` = 0) and (`impianto_mesi`.`Id_mese` = month(now()))) order by `impianto_mesi`.`Id_mese`,1,`clienti`.`Ragione_Sociale`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_depotsoperations`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_depotsoperations` AS select `vw_depotsoperationsnotordered`.`ID` AS `ID`,`vw_depotsoperationsnotordered`.`codice_articolo` AS `codice_articolo`,`vw_depotsoperationsnotordered`.`id_magazzino` AS `id_magazzino`,`vw_depotsoperationsnotordered`.`tipo_magazzino` AS `tipo_magazzino`,`vw_depotsoperationsnotordered`.`data_ins` AS `data_ins`,`vw_depotsoperationsnotordered`.`data_operazione` AS `data_operazione`,`vw_depotsoperationsnotordered`.`quantità` AS `quantità`,`vw_depotsoperationsnotordered`.`nome_causale` AS `nome_causale`,`vw_depotsoperationsnotordered`.`Causale` AS `Causale`,`vw_depotsoperationsnotordered`.`documento` AS `documento`,`vw_depotsoperationsnotordered`.`ragione_sociale` AS `ragione_sociale`,`vw_depotsoperationsnotordered`.`id_doc` AS `id_doc`,`vw_depotsoperationsnotordered`.`anno_doc` AS `anno_doc`,`vw_depotsoperationsnotordered`.`sorgente` AS `sorgente` from `vw_depotsoperationsnotordered` order by `vw_depotsoperationsnotordered`.`data_operazione` desc,`vw_depotsoperationsnotordered`.`ID` desc
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_depotsoperationsnotordered`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_depotsoperationsnotordered` AS select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`magazzino_operazione`.`Data` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat('Inserimento manuale effettuato il ',`magazzino_operazione`.`Data`) AS `Causale`,NULL AS `documento`,NULL AS `ragione_sociale`,NULL AS `id_doc`,NULL AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from ((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) where (`magazzino_operazione`.`sorgente` = 1) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`rapporto`.`Data_esecuzione` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat(`causale_magazzino`.`Nome`,' da ',' Rapporto ',`magazzino_rapporto_materiale`.`id_rapporto`,'/',`magazzino_rapporto_materiale`.`anno_rapporto`) AS `Causale`,'RAPPORTO' AS `documento`,if((`rapporto`.`Id_cliente` is not null),`clienti`.`Ragione_Sociale`,'') AS `ragione_sociale`,`magazzino_rapporto_materiale`.`id_rapporto` AS `id_doc`,`magazzino_rapporto_materiale`.`anno_rapporto` AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from (((((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) join `magazzino_rapporto_materiale` on((`magazzino_rapporto_materiale`.`id_operazione` = `magazzino_operazione`.`Id_operazione`))) join `rapporto` on(((`magazzino_rapporto_materiale`.`id_rapporto` = `rapporto`.`Id_rapporto`) and (`magazzino_rapporto_materiale`.`anno_rapporto` = `rapporto`.`Anno`)))) join `clienti` on((`rapporto`.`Id_cliente` = `clienti`.`Id_cliente`))) where (`magazzino_operazione`.`sorgente` = 2) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`ddt`.`data_documento` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat(`causale_magazzino`.`Nome`,' da Ddt emesso ',`magazzino_ddt_emessi`.`id_ddt`,'/',`magazzino_ddt_emessi`.`anno_ddt`) AS `Causale`,'DDT EMESSO' AS `documento`,ifnull(`clienti`.`Ragione_Sociale`,`fornitore`.`Ragione_Sociale`) AS `ragione_sociale`,`magazzino_ddt_emessi`.`id_ddt` AS `id_doc`,`magazzino_ddt_emessi`.`anno_ddt` AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from ((((((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) join `magazzino_ddt_emessi` on((`magazzino_ddt_emessi`.`id_operazione` = `magazzino_operazione`.`Id_operazione`))) join `ddt` on(((`magazzino_ddt_emessi`.`id_ddt` = `ddt`.`Id_ddt`) and (`magazzino_ddt_emessi`.`anno_ddt` = `ddt`.`anno`)))) left join `clienti` on((`ddt`.`id_cliente` = `clienti`.`Id_cliente`))) left join `fornitore` on((`ddt`.`id_fornitore` = `fornitore`.`Id_fornitore`))) where (`magazzino_operazione`.`sorgente` = 3) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`ddt`.`data_documento` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat(`causale_magazzino`.`Nome`,' da Ddt emesso ',`magazzino_ddt_emessi`.`id_ddt`,'/',`magazzino_ddt_emessi`.`anno_ddt`) AS `Causale`,'DDT EMESSO' AS `documento`,ifnull(`clienti`.`Ragione_Sociale`,`fornitore`.`Ragione_Sociale`) AS `ragione_sociale`,`magazzino_ddt_emessi`.`id_ddt` AS `id_doc`,`magazzino_ddt_emessi`.`anno_ddt` AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from ((((((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) join `magazzino_ddt_emessi` on(((`magazzino_ddt_emessi`.`id_reso` is not null) and (`magazzino_ddt_emessi`.`id_reso` = `magazzino_operazione`.`Id_operazione`)))) join `ddt` on(((`magazzino_ddt_emessi`.`id_ddt` = `ddt`.`Id_ddt`) and (`magazzino_ddt_emessi`.`anno_ddt` = `ddt`.`anno`)))) left join `clienti` on((`ddt`.`id_cliente` = `clienti`.`Id_cliente`))) left join `fornitore` on((`ddt`.`id_fornitore` = `fornitore`.`Id_fornitore`))) where (`magazzino_operazione`.`sorgente` = 3) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`magazzino_operazione`.`Data` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat('Trasferimento tra magazzini effettuato il ',`magazzino_operazione`.`Data`) AS `Causale`,NULL AS `documento`,NULL AS `ragione_sociale`,NULL AS `id_doc`,NULL AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from ((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) where (`magazzino_operazione`.`sorgente` = 4) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`magazzino_operazione`.`Data` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat('Inserimento mobile effettuato il ',`magazzino_operazione`.`Data`) AS `Causale`,NULL AS `documento`,NULL AS `ragione_sociale`,NULL AS `id_doc`,NULL AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from ((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) where (`magazzino_operazione`.`sorgente` = 5) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`fornfattura`.`data` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat(`causale_magazzino`.`Nome`,' da ',' Fattura Fornitore ',`fornfattura`.`fattura_fornitore`) AS `Causale`,'FATTURA FORNITORE' AS `documento`,`fornitore`.`Ragione_Sociale` AS `ragione_sociale`,`fornfattura`.`Id_fattura` AS `id_doc`,`fornfattura`.`anno` AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from (((((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) join `magazzino_fornfattura` on((`magazzino_fornfattura`.`id_operazione` = `magazzino_operazione`.`Id_operazione`))) join `fornfattura` on(((`magazzino_fornfattura`.`id_fattura` = `fornfattura`.`Id_fattura`) and (`magazzino_fornfattura`.`anno` = `fornfattura`.`anno`)))) join `fornitore` on((`fornfattura`.`id_fornitore` = `fornitore`.`Id_fornitore`))) where (`magazzino_operazione`.`sorgente` = 6) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`fattura`.`data` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat(`causale_magazzino`.`Nome`,' da ',' Fattura ',`fattura`.`Id_fattura`,'/',`fattura`.`anno`) AS `Causale`,'FATTURA' AS `documento`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,`fattura`.`Id_fattura` AS `id_doc`,`fattura`.`anno` AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from (((((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) join `magazzino_fattura` on((`magazzino_fattura`.`id_operazione` = `magazzino_operazione`.`Id_operazione`))) join `fattura` on(((`magazzino_fattura`.`id_fattura` = `fattura`.`Id_fattura`) and (`magazzino_fattura`.`anno` = `fattura`.`anno`)))) join `clienti` on((`fattura`.`id_cliente` = `clienti`.`Id_cliente`))) where (`magazzino_operazione`.`sorgente` = 7) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`ddt_ricevuti`.`data_documento` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat(`causale_magazzino`.`Nome`,' da ',' Ddt ricevuto ',`ddt_ricevuti`.`numero_ddt`,'/',`magazzino_ddt_ricevuti`.`id_anno`) AS `Causale`,'DDT RICEVUTO' AS `documento`,if((`ddt_ricevuti`.`id_fornitore` is not null),`fornitore`.`Ragione_Sociale`,`clienti`.`Ragione_Sociale`) AS `ragione_sociale`,`magazzino_ddt_ricevuti`.`id_ddt` AS `id_doc`,`magazzino_ddt_ricevuti`.`id_anno` AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from ((((((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) join `magazzino_ddt_ricevuti` on((`magazzino_ddt_ricevuti`.`id_operazione` = `magazzino_operazione`.`Id_operazione`))) join `ddt_ricevuti` on(((`magazzino_ddt_ricevuti`.`id_ddt` = `ddt_ricevuti`.`Id_ddt`) and (`magazzino_ddt_ricevuti`.`id_anno` = `ddt_ricevuti`.`anno`)))) left join `fornitore` on((`ddt_ricevuti`.`id_fornitore` = `fornitore`.`Id_fornitore`))) left join `clienti` on((`ddt_ricevuti`.`id_cliente` = `clienti`.`Id_cliente`))) where (`magazzino_operazione`.`sorgente` = 8) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`ddt_ricevuti`.`data_documento` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat(`causale_magazzino`.`Nome`,' da ',' Ddt ricevuto ',`ddt_ricevuti`.`numero_ddt`,'/',`magazzino_ddt_ricevuti`.`id_anno`) AS `Causale`,'DDT RICEVUTO' AS `documento`,if((`ddt_ricevuti`.`id_fornitore` is not null),`fornitore`.`Ragione_Sociale`,`clienti`.`Ragione_Sociale`) AS `ragione_sociale`,`magazzino_ddt_ricevuti`.`id_ddt` AS `id_doc`,`magazzino_ddt_ricevuti`.`id_anno` AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from ((((((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) join `magazzino_ddt_ricevuti` on(((`magazzino_ddt_ricevuti`.`id_reso` is not null) and (`magazzino_ddt_ricevuti`.`id_reso` = `magazzino_operazione`.`Id_operazione`)))) join `ddt_ricevuti` on(((`magazzino_ddt_ricevuti`.`id_ddt` = `ddt_ricevuti`.`Id_ddt`) and (`magazzino_ddt_ricevuti`.`id_anno` = `ddt_ricevuti`.`anno`)))) left join `fornitore` on((`ddt_ricevuti`.`id_fornitore` = `fornitore`.`Id_fornitore`))) left join `clienti` on((`ddt_ricevuti`.`id_cliente` = `clienti`.`Id_cliente`))) where (`magazzino_operazione`.`sorgente` = 8) union all select `magazzino_operazione`.`Id_operazione` AS `ID`,`magazzino_operazione`.`Articolo` AS `codice_articolo`,`tipo_magazzino`.`Id_tipo` AS `id_magazzino`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`magazzino_operazione`.`Data` AS `data_ins`,`lista_prelievo`.`Data` AS `data_operazione`,`magazzino_operazione`.`quantità` AS `quantità`,`causale_magazzino`.`Nome` AS `nome_causale`,concat(`causale_magazzino`.`Nome`,' da ',' Lista di prelievo ',`a`.`id_lista`,'/',`a`.`anno`) AS `Causale`,'PRELIEVO' AS `documento`,if((`lista_prelievo`.`cliente` is not null),`clienti`.`Ragione_Sociale`,'') AS `ragione_sociale`,`a`.`id_lista` AS `id_doc`,`a`.`anno` AS `anno_doc`,`magazzino_operazione`.`sorgente` AS `sorgente` from (((((`magazzino_operazione` join `causale_magazzino` on((`magazzino_operazione`.`causale` = `causale_magazzino`.`Id_causale`))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino_operazione`.`id_magazzino`))) join `magazzino_liste` `a` on((`magazzino_operazione`.`Id_operazione` in (`a`.`id_operazione_del`,`a`.`id_operazione_ins`)))) join `lista_prelievo` on(((`a`.`id_lista` = `lista_prelievo`.`Id_lista`) and (`a`.`anno` = `lista_prelievo`.`Anno`)))) left join `clienti` on((`lista_prelievo`.`cliente` = `clienti`.`Id_cliente`))) where (`magazzino_operazione`.`sorgente` = 9)
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_depotsproducts`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_depotsproducts` AS select `articolo`.`Codice_articolo` AS `codice_articolo`,`articolo`.`Stato_articolo` AS `id_stato_articolo`,`articolo_stato`.`colore` AS `stato_articolo_colore`,`articolo`.`Desc_brev` AS `descrizione`,`articolo`.`Codice_fornitore` AS `codice_fornitore`,`magazzino`.`giacenza` AS `giacenza`,`marca`.`Nome` AS `marca`,`categoria_merciologica`.`Nome` AS `categoria`,`sottocategoria`.`Nome` AS `sottocategoria`,round(`articolo_listino`.`Prezzo`,2) AS `prezzo`,round(`b`.`Prezzo`,2) AS `costo`,`tipo_magazzino`.`nome` AS `tipo_magazzino`,`tipo_magazzino`.`Id_tipo` AS `id_tipo_magazzino`,`magazzino`.`data_ultimo_movimento` AS `data_ultimo_movimento`,`magazzino`.`Data_mod` AS `Data_mod` from ((((((((`magazzino` join `articolo` on((`magazzino`.`Id_articolo` = `articolo`.`Codice_articolo`))) join `articolo_stato` on((`articolo`.`Stato_articolo` = `articolo_stato`.`Id_stato`))) left join `marca` on((`articolo`.`Marca` = `marca`.`Id_marca`))) left join `sottocategoria` on((`articolo`.`Sottocategoria` = `sottocategoria`.`id_sottocategoria`))) left join `categoria_merciologica` on((`categoria_merciologica`.`Id_categoria` = `articolo`.`Categoria`))) left join `articolo_listino` on(((`articolo_listino`.`Id_articolo` = `articolo`.`Codice_articolo`) and (`articolo_listino`.`Id_listino` = 2)))) left join `articolo_listino` `b` on(((`b`.`Id_articolo` = `articolo`.`Codice_articolo`) and (`b`.`Id_listino` = 1)))) join `tipo_magazzino` on((`tipo_magazzino`.`Id_tipo` = `magazzino`.`tipo_magazzino`))) order by `magazzino`.`data_ultimo_movimento` desc
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_depots_all_products`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_depots_all_products` AS select `articolo_stato`.`nome` AS `Stato`,`subvw_depots_types_products`.`Codice_articolo` AS `Cod. Articolo`,`subvw_depots_types_products`.`Desc_brev` AS `Descrizione`,`subvw_depots_types_products`.`Codice_fornitore` AS `Cod. Fornitore`,`subvw_depots_types_products`.`nome` AS `Tipo Magazzino`,if(isnull(`magazzino`.`Id`),'NO','SI') AS `Visibile Magazzino`,ifnull(`magazzino`.`giacenza`,0) AS `Giacenza`,`marca`.`Nome` AS `Marca`,`categoria_merciologica`.`Nome` AS `Categoria Merceologica`,`subvw_depots_types_products`.`scaffaliera_magazzino` AS `Scaffale`,`subvw_depots_types_products`.`ripiano_magazzino` AS `Ripiano`,`subvw_depots_types_products`.`Barcode` AS `Barcode`,`listino_prezzo`.`Prezzo` AS `Prezzo`,`listino_costo`.`Prezzo` AS `Costo` from ((((((`subvw_depots_types_products` left join `magazzino` on(((`magazzino`.`tipo_magazzino` = `subvw_depots_types_products`.`Id_tipo`) and (`magazzino`.`Id_articolo` = `subvw_depots_types_products`.`Codice_articolo`)))) join `articolo_stato` on((`subvw_depots_types_products`.`Stato_articolo` = `articolo_stato`.`Id_stato`))) left join `marca` on((`subvw_depots_types_products`.`Marca` = `marca`.`Id_marca`))) left join `categoria_merciologica` on((`categoria_merciologica`.`Id_categoria` = `subvw_depots_types_products`.`Categoria`))) left join `articolo_listino` `listino_prezzo` on(((`listino_prezzo`.`Id_articolo` = `subvw_depots_types_products`.`Codice_articolo`) and (`listino_prezzo`.`Id_listino` = 2)))) left join `articolo_listino` `listino_costo` on(((`listino_costo`.`Id_articolo` = `subvw_depots_types_products`.`Codice_articolo`) and (`listino_costo`.`Id_listino` = 1)))) order by `subvw_depots_types_products`.`Id_tipo`,`subvw_depots_types_products`.`Codice_articolo`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_invoices_payments_details`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_invoices_payments_details` AS select `fattura`.`Id_fattura` AS `id_fattura`,`fattura`.`anno` AS `anno`,`fattura`.`data` AS `data_fattura`,`fattura_pagamenti`.`id_pagamento` AS `id_pagamento`,`clienti`.`Id_cliente` AS `id_cliente`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,`a`.`Nome` AS `condizione_pagamento`,ifnull(`tipopag`.`id_Tipo`,`tipo_pagamento`.`id_Tipo`) AS `id_tipo_pagamento`,ifnull(`tipopag`.`nome`,`tipo_pagamento`.`nome`) AS `tipo_pagamento`,`fattura`.`importo_totale` AS `importo_fattura`,round((`fattura`.`importo_totale` / `a`.`mesi`),2) AS `importo_pagamento`,(select if(isnull(sum(`fattura_acconto`.`importo`)),0,sum(`fattura_acconto`.`importo`)) from `fattura_acconto` where ((`fattura_acconto`.`id_fattura` = `fattura`.`Id_fattura`) and (`fattura_acconto`.`anno` = `fattura`.`anno`) and (`fattura_acconto`.`id_pagamento` = date_format((last_day((`fattura`.`data` + interval `g`.`mesi` month)) + interval `g`.`giorni` day),'%Y%m%d')))) AS `totale_acconti`,`a`.`mesi` AS `numero_rate`,(last_day((`fattura`.`data` + interval `g`.`mesi` month)) + interval `g`.`giorni` day) AS `data_pagamento_prevista`,`fattura_pagamenti`.`data` AS `data_pagamento_effettiva`,if((`fattura_pagamenti`.`data` is not null),1,0) AS `pagato`,if((`fattura_pagamenti`.`data` is not null),concat('Pagato con ',`tipopag`.`nome`,' il ',convert(date_format(`fattura_pagamenti`.`data`,'%m/%d/%Y') using latin1)),'') AS `descrizione_pagamento`,`fattura`.`data_invio_promemoria` AS `data_ultimo_promemoria` from ((((((`fattura` join `condizione_pagamento` `a` on((`fattura`.`cond_pagamento` = `a`.`Id_condizione`))) left join `condizioni_giorno` `g` on((`g`.`id_condizione` = `a`.`Id_condizione`))) join `clienti` on((`fattura`.`id_cliente` = `clienti`.`Id_cliente`))) left join `tipo_pagamento` on((`a`.`tipo` = `tipo_pagamento`.`id_Tipo`))) left join `fattura_pagamenti` on(((`fattura`.`Id_fattura` = `fattura_pagamenti`.`id_fattura`) and (`fattura`.`anno` = `fattura_pagamenti`.`anno`) and (`fattura_pagamenti`.`id_pagamento` = date_format((last_day((`fattura`.`data` + interval `g`.`mesi` month)) + interval `g`.`giorni` day),'%Y%m%d'))))) left join `tipo_pagamento` `tipopag` on((`fattura_pagamenti`.`tipo_pagamento` = `tipopag`.`id_Tipo`))) group by `fattura`.`Id_fattura`,`fattura`.`anno`,(last_day((`fattura`.`data` + interval `g`.`mesi` month)) + interval `g`.`giorni` day)
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_jobbody`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_jobbody` AS select `ca`.`id_commessa` AS `Id_commessa`,`ca`.`anno` AS `Anno`,`ca`.`id_sottocommessa` AS `id_sottocommessa`,`ca`.`id_lotto` AS `Lotto`,`ca`.`codice_articolo` AS `Codice_articolo`,`ca`.`codice_fornitore` AS `Codice_fornitore`,`ca`.`descrizione` AS `Descrizione`,if(isnull(`ca`.`codice_articolo`),`ca`.`quantità`,`ca`.`portati`) AS `Qta_utilizzata`,cast(`ca`.`quantità` as decimal(11,2)) AS `Qta_commessa`,cast(`ca`.`preventivati` as decimal(11,2)) AS `Qta_preventivati`,`ca`.`UM` AS `UM`,cast(`ca`.`prezzo` as decimal(11,2)) AS `Prezzo`,cast(`ca`.`costo` as decimal(11,2)) AS `Costo`,cast(`ca`.`prezzo_ora` as decimal(11,2)) AS `Prezzo_ora`,cast(`ca`.`costo_ora` as decimal(11,2)) AS `Costo_ora`,cast(`ca`.`sconto` as decimal(11,2)) AS `Sconto`,`ca`.`tempo` AS `Tempo_Installazione`,`ca`.`economia` AS `Qta_economia`,cast(`ca`.`id_tab` as signed) AS `Posizionamento` from `commessa_articoli` `ca`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_jobbodywwithkit`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_jobbodywwithkit` AS select `ca`.`id_commessa` AS `Id_commessa`,`ca`.`anno` AS `Anno`,`ca`.`id_sottocommessa` AS `id_sottocommessa`,`ca`.`id_lotto` AS `Lotto`,`ca`.`codice_articolo` AS `Codice_articolo`,`ca`.`codice_fornitore` AS `Codice_fornitore`,`ca`.`descrizione` AS `Descrizione`,`ca`.`portati` AS `Qta_utilizzata`,cast(`ca`.`quantità` as decimal(11,2)) AS `Qta_commessa`,cast(`ca`.`preventivati` as decimal(11,2)) AS `Qta_preventivati`,`ca`.`UM` AS `UM`,cast(`ca`.`prezzo` as decimal(11,2)) AS `Prezzo`,cast(`ca`.`costo` as decimal(11,2)) AS `Costo`,cast(`ca`.`prezzo_ora` as decimal(11,2)) AS `Prezzo_ora`,cast(`ca`.`costo_ora` as decimal(11,2)) AS `Costo_ora`,cast(`ca`.`sconto` as decimal(11,2)) AS `Sconto`,`ca`.`tempo` AS `Tempo_Installazione`,`ca`.`economia` AS `Qta_economia`,cast(`ca`.`id_tab` as signed) AS `Posizionamento`,ifnull(`articolo`.`is_kit`,0) AS `is_kit` from (`commessa_articoli` `ca` left join `articolo` on((`articolo`.`Codice_articolo` = `ca`.`codice_articolo`))) union all select `ca`.`id_commessa` AS `Id_commessa`,`ca`.`anno` AS `Anno`,`ca`.`id_sottocommessa` AS `id_sottocommessa`,`ca`.`id_lotto` AS `Lotto`,`articolo`.`Codice_articolo` AS `Codice_articolo`,`articolo`.`Codice_fornitore` AS `Codice_fornitore`,`articolo`.`Desc_brev` AS `Descrizione`,cast((`ca`.`portati` * `rka`.`quantita`) as decimal(11,2)) AS `Qta_utilizzata`,cast((`ca`.`quantità` * `rka`.`quantita`) as decimal(11,2)) AS `Qta_commessa`,cast((`ca`.`preventivati` * `rka`.`quantita`) as decimal(11,2)) AS `Qta_preventivati`,`ca`.`UM` AS `UM`,cast(`ca`.`prezzo` as decimal(11,2)) AS `Prezzo`,cast(`ca`.`costo` as decimal(11,2)) AS `Costo`,cast(`ca`.`prezzo_ora` as decimal(11,2)) AS `Prezzo_ora`,cast(`ca`.`costo_ora` as decimal(11,2)) AS `Costo_ora`,cast(`ca`.`sconto` as decimal(11,2)) AS `Sconto`,`ca`.`tempo` AS `Tempo_Installazione`,cast((`ca`.`economia` * `rka`.`quantita`) as decimal(11,2)) AS `Qta_economia`,cast(`ca`.`id_tab` as signed) AS `Posizionamento`,2 AS `is_kit` from ((`commessa_articoli` `ca` join `riferimento_kit_articoli` `rka` on((`rka`.`id_kit` = `ca`.`codice_articolo`))) left join `articolo` on((`articolo`.`Codice_articolo` = `rka`.`id_articolo`)))
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_jobtotaltravelinterventions`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_jobtotaltravelinterventions` AS select `cr`.`id_commessa` AS `id_commessa`,`cr`.`anno_commessa` AS `anno_commessa`,`cr`.`id_sottocommessa` AS `id_sottocommessa`,`cr`.`id_lotto` AS `id_lotto`,cast(sum(`rt`.`Spesa_trasferta`) as decimal(11,2)) AS `Totale_spese_trasferta`,cast(sum(`rt`.`autostrada`) as decimal(11,2)) AS `Totale_autostrada`,cast(sum(`rt`.`parcheggio`) as decimal(11,2)) AS `Totale_parcheggio`,cast(sum(`rt`.`altro`) as decimal(11,2)) AS `Totale_altro`,cast(if(isnull(sum(`rt`.`Km`)),0,sum(`rt`.`Km`)) as unsigned) AS `Totale_KM`,cast(if(isnull(sum((`rt`.`Km` * `t`.`costo_km`))),0,sum((`rt`.`Km` * `t`.`costo_km`))) as decimal(11,2)) AS `Totale_costo_KM`,cast(if(isnull(sum((`rt`.`Km` * `a`.`Prezzo_strada`))),0,sum((`rt`.`Km` * `a`.`Prezzo_strada`))) as decimal(11,2)) AS `Totale_prezzo_KM`,cast(sum((`rt`.`Tempo_viaggio` / 60)) as decimal(11,2)) AS `Totale_tempo_viaggio`,cast(if(isnull(sum(((`rt`.`Tempo_viaggio` / 60) * `t`.`Costo_h`))),0,sum(((`rt`.`Tempo_viaggio` / 60) * `t`.`Costo_h`))) as decimal(11,2)) AS `Totale_costo_tempo_viaggio`,cast(if(isnull(sum(((`rt`.`Tempo_viaggio` / 60) * `a`.`Ora_normale`))),0,sum(((`rt`.`Tempo_viaggio` / 60) * `a`.`Ora_normale`))) as decimal(11,2)) AS `Totale_prezzo_tempo_viaggio` from (((((`rapporto_tecnico` `rt` join `commessa_rapporto` `cr` on(((`cr`.`id_rapporto` = `rt`.`Id_rapporto`) and (`rt`.`Anno` = `cr`.`anno_rapporto`)))) left join `operaio_contratto` `oc` on((`oc`.`id_operaio` = `rt`.`Tecnico`))) left join `tariffario` `t` on((`t`.`Id_tariffario` = `oc`.`id_tariffario`))) join `rapporto` `r` on(((`r`.`Id_rapporto` = `rt`.`Id_rapporto`) and (`r`.`Anno` = `rt`.`Anno`)))) left join `abbonamento` `a` on((`r`.`abbonamento` = `a`.`Id_abbonamento`))) group by `cr`.`id_commessa`,`cr`.`anno_commessa`,`cr`.`id_sottocommessa`,`cr`.`id_lotto`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_jobtotalworkinterventions`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_jobtotalworkinterventions` AS select `cr`.`id_commessa` AS `id_commessa`,`cr`.`anno_commessa` AS `anno_commessa`,`cr`.`id_sottocommessa` AS `id_sottocommessa`,`cr`.`id_lotto` AS `id_lotto`,cast(ifnull(sum(((`r`.`totale` / 60) * `r`.`ora_normale`)),0) as decimal(11,2)) AS `Totale_prezzo_lavoro`,cast(ifnull(sum(((`r`.`totale` / 60) * if(((`r`.`straordinario` = 1) or (`r`.`straordinario` = 4)),`t`.`Straordinario_c`,`t`.`Costo_h`))),0) as decimal(11,2)) AS `Totale_costo_lavoro`,cast(sum((`r`.`totale` / 60)) as decimal(11,2)) AS `Totale_ore_lavorate`,if(((`r`.`straordinario` = 3) or (`r`.`straordinario` = 4)),1,0) AS `Economia`,if(((`r`.`straordinario` = 1) or (`r`.`straordinario` = 4)),1,0) AS `Straordinario` from (((`rapporto_tecnico_lavoro` `r` join `commessa_rapporto` `cr` on(((`cr`.`id_rapporto` = `r`.`Id_rapporto`) and (`r`.`anno` = `cr`.`anno_rapporto`)))) left join `operaio_contratto` `oc` on((`oc`.`id_operaio` = `r`.`tecnico`))) left join `tariffario` `t` on((`t`.`Id_tariffario` = `oc`.`id_tariffario`))) group by `cr`.`id_commessa`,`cr`.`anno_commessa`,`cr`.`id_sottocommessa`,`cr`.`id_lotto`,`r`.`straordinario`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_mapsmarkersinformation`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_mapsmarkersinformation` AS select `impianto`.`Id_impianto` AS `Id_Impianto`,`ticket`.`Id_cliente` AS `Id_Cliente`,`clienti`.`Ragione_Sociale` AS `Ragione_Sociale`,concat(`destinazione_cliente`.`Indirizzo`,',',`destinazione_cliente`.`numero_civico`) AS `Indirizzo`,concat(`comune`.`cap`,' - ',`comune`.`Nome`,'(',`destinazione_cliente`.`Provincia`,')') AS `Provincia`,`impianto`.`Descrizione` AS `Impianto_Descrizione`,if((`impianto`.`Stato` = 1),1,0) AS `Abbonato`,if((`impianto`.`stato_invio_doc` = 'clblue'),0,if((`impianto`.`stato_invio_doc` = 'clYellow'),1,2)) AS `Stato_invio_richiesta_abbonamento`,max(`ticket`.`data_ticket`) AS `Data_Ticket`,max(`ticket`.`Urgenza`) AS `Urgenza`,`ticket`.`Descrizione` AS `Ticket_Descrizione`,`riferimento_clienti`.`Telefono` AS `Telefono`,`riferimento_clienti`.`altro_telefono` AS `Cellulare`,`riferimento_clienti`.`mail` AS `Mail`,cast(replace(`destinazione_cliente`.`latitudine`,',','.') as decimal(21,16)) AS `Latitudine`,cast(replace(`destinazione_cliente`.`longitudine`,',','.') as decimal(21,16)) AS `Longitudine` from (((((((`ticket` join `clienti` on((`clienti`.`Id_cliente` = `ticket`.`Id_cliente`))) left join `causale_ticket` on((`causale_ticket`.`Id_causale` = `ticket`.`Causale`))) left join `tipo_intervento` on((`tipo_intervento`.`Id_tipo` = `ticket`.`intervento`))) join `riferimento_clienti` on((`clienti`.`Id_cliente` = `riferimento_clienti`.`Id_cliente`))) left join `impianto` on((`impianto`.`Id_impianto` = `ticket`.`Id_impianto`))) join `destinazione_cliente` on(((`clienti`.`Id_cliente` = `destinazione_cliente`.`id_cliente`) and (`impianto`.`Destinazione` = `destinazione_cliente`.`Id_destinazione`)))) join `comune` on((`comune`.`Id_comune` = `destinazione_cliente`.`Comune`))) where ((`ticket`.`Stato_ticket` = 1) and (`destinazione_cliente`.`latitudine` <> '') and (`destinazione_cliente`.`longitudine` <> '') and (`destinazione_cliente`.`latitudine` is not null) and (`destinazione_cliente`.`longitudine` is not null)) group by `impianto`.`Id_impianto` order by `impianto`.`Id_impianto`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_mobilesystems`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_mobilesystems` AS select `impianto`.`Id_impianto` AS `id_impianto`,`impianto`.`Id_cliente` AS `id_cliente`,`impianto`.`Id_gestore` AS `id_gestore`,`impianto`.`Id_occupante` AS `id_occupante`,ifnull(`impianto`.`Abbonamento`,0) AS `abbonamento`,ifnull(`impianto`.`Data_Funzione`,cast('0000-00-00 00:00:00' as datetime)) AS `data_funzione`,ifnull(`impianto`.`scadenza_garanzia`,cast('0000-00-00 00:00:00' as datetime)) AS `Scadenza_Garanzia`,`impianto`.`Tipo_impianto` AS `tipo_impianto`,`impianto`.`Stato` AS `stato`,`impianto`.`Descrizione` AS `descrizione`,ifnull(if((`d1`.`Id_destinazione` <> `d2`.`Id_destinazione`),concat(concat(`d2`.`Indirizzo`,' n.',`d2`.`numero_civico`,`d2`.`Altro`),' - ',concat(if(((`f2`.`Nome` is not null) and (`f2`.`Nome` <> '')),concat(`f2`.`Nome`,' di '),''),`c2`.`Nome`,' (',`c2`.`provincia`,')'),' - ',`impianto`.`Descrizione`),''),'') AS `luogo`,ifnull(concat(`d1`.`Indirizzo`,' n.',`d1`.`numero_civico`,`d1`.`Altro`),'') AS `indirizzo`,concat(if(((`frazione`.`Nome` is not null) and (`frazione`.`Nome` <> '')),concat(`frazione`.`Nome`,' di '),''),`comune`.`Nome`,' (',`comune`.`provincia`,')') AS `citta`,ifnull(`r1`.`mail`,'') AS `mail`,ifnull(`r1`.`Telefono`,'') AS `telefono`,ifnull(`r1`.`altro_telefono`,'') AS `cellulare`,`tipo_impianto`.`nome` AS `tipo_impianto_nome`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,ifnull(`clienti`.`Partita_iva`,'') AS `partita_iva`,ifnull(`clienti`.`Codice_Fiscale`,'') AS `codice_fiscale`,ifnull(`impianto`.`centrale`,'') AS `centrale`,ifnull(`impianto`.`gsm`,'') AS `gsm`,ifnull(`impianto`.`combinatore_telefonico`,'') AS `combinatore_telefonico`,`impianto`.`orario_prog` AS `orario_prog` from (((((((((`impianto` join `clienti` on((`clienti`.`Id_cliente` = `impianto`.`Id_cliente`))) join `destinazione_cliente` `d1` on(((`d1`.`id_cliente` = `clienti`.`Id_cliente`) and (`d1`.`Id_destinazione` = 1)))) join `comune` on((`comune`.`Id_comune` = `d1`.`Comune`))) left join `frazione` on((`frazione`.`Id_frazione` = `d1`.`Frazione`))) left join `tipo_impianto` on((`tipo_impianto`.`id_tipo` = `impianto`.`Tipo_impianto`))) left join `destinazione_cliente` `d2` on(((`d2`.`id_cliente` = `clienti`.`Id_cliente`) and (`d2`.`Id_destinazione` = `impianto`.`Destinazione`)))) join `comune` `c2` on((`c2`.`Id_comune` = `d2`.`Comune`))) left join `frazione` `f2` on((`f2`.`Id_frazione` = `d2`.`Frazione`))) left join `riferimento_clienti` `r1` on(((`r1`.`Id_cliente` = `clienti`.`Id_cliente`) and (`r1`.`Id_riferimento` = '1')))) where ((`impianto`.`Stato` < 4) or (`impianto`.`Stato` > 7)) group by `impianto`.`Id_impianto`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_mobileticketsopened`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_mobileticketsopened` AS select `ticket`.`Id_ticket` AS `id_ticket`,`ticket`.`anno` AS `anno`,`destinazione_cliente`.`Indirizzo` AS `indirizzo`,ifnull(`destinazione_cliente`.`numero_civico`,0) AS `numero_civico`,ifnull(`destinazione_cliente`.`Altro`,'') AS `altro`,ifnull(`frazione`.`Nome`,'') AS `frazione`,`comune`.`Nome` AS `comune`,`comune`.`provincia` AS `provincia`,ifnull(`riferimento_clienti`.`Telefono`,'') AS `telefono`,ifnull(`riferimento_clienti`.`altro_telefono`,'') AS `cellulare`,`ticket`.`Urgenza` AS `urgenza`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,`impianto`.`Id_impianto` AS `id_impianto`,`impianto`.`Descrizione` AS `impianto_descrizione`,`clienti`.`Id_cliente` AS `id_cliente`,`ticket`.`Descrizione` AS `ticket_descrizione` from ((((((`ticket` join `clienti` on((`clienti`.`Id_cliente` = `ticket`.`Id_cliente`))) join `destinazione_cliente` on(((`destinazione_cliente`.`id_cliente` = `clienti`.`Id_cliente`) and (`destinazione_cliente`.`Id_destinazione` = `ticket`.`Id_destinazione`)))) left join `comune` on((`comune`.`Id_comune` = `destinazione_cliente`.`Comune`))) left join `frazione` on((`destinazione_cliente`.`Frazione` = `frazione`.`Id_frazione`))) left join `impianto` on((`impianto`.`Id_impianto` = `ticket`.`Id_impianto`))) left join `riferimento_clienti` on(((`riferimento_clienti`.`Id_cliente` = `clienti`.`Id_cliente`) and (`riferimento_clienti`.`Id_riferimento` = 1)))) where ((`ticket`.`Stato_ticket` = '1') and (`impianto`.`Id_impianto` is not null))
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_notessearch`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_notessearch` AS select `nota`.`id_nota` AS `id_nota`,`nota`.`Nome` AS `nome`,`nota`.`note` AS `descrizione`,ifnull(`nota`.`prezz`,0) AS `prezzo`,ifnull(`nota`.`cost`,0) AS `costo`,`nota`.`temp` AS `tempo`,`nota`.`nota_stato` AS `id_stato_nota`,if((`nota`.`nota_stato` = 1),'Attivo','Non Attivo') AS `stato_nota`,`tipo_nota`.`id_tipo` AS `id_tipo_nota`,`tipo_nota`.`nome` AS `tipo_nota` from ((`nota` left join `note_tipo` on((`nota`.`id_nota` = `note_tipo`.`id_nota`))) left join `tipo_nota` on((`tipo_nota`.`id_tipo` = `note_tipo`.`id_tipo`)))
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_productssearch`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_productssearch` AS select `subvw_productsunionsearch`.`codice_articolo` AS `Codice_articolo`,ifnull(`subvw_productsunionsearch`.`codice_fornitore`,'') AS `Codice_fornitore`,ifnull(`subvw_productsunionsearch`.`barcode`,'') AS `Barcode`,`subvw_productsunionsearch`.`desc_brev` AS `Descrizione`,`subvw_productsunionsearch`.`Categoria` AS `Categoria`,`subvw_productsunionsearch`.`Sottocategoria` AS `Sottocategoria`,`subvw_productsunionsearch`.`unità_misura` AS `UM`,`subvw_productsunionsearch`.`colore` AS `Stato_articolo`,ifnull(`subvw_productsunionsearch`.`marca`,'') AS `Marca`,ifnull(`costo`.`Prezzo`,0) AS `Costo`,ifnull(`prezzo`.`Prezzo`,0) AS `Prezzo`,`subvw_productsunionsearch`.`tempo_installazione` AS `Tempo_installazione`,`subvw_productsunionsearch`.`bloccato` AS `bloccato`,`subvw_productsunionsearch`.`is_kit` AS `Is_kit` from ((`subvw_productsunionsearch` left join `articolo_listino` `prezzo` on(((`prezzo`.`Id_articolo` = `subvw_productsunionsearch`.`codice_articolo`) and (`prezzo`.`Id_listino` = 2)))) left join `articolo_listino` `costo` on(((`costo`.`Id_listino` = 1) and (`costo`.`Id_articolo` = `subvw_productsunionsearch`.`codice_articolo`)))) group by `subvw_productsunionsearch`.`codice_articolo`,`subvw_productsunionsearch`.`codice_fornitore`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_product_sub_categories`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_product_sub_categories` AS select `sottocategoria`.`Id_categoria` AS `Id_categoria`,`sottocategoria`.`id_sottocategoria` AS `id_sottocategoria`,NULL AS `id_sottocategoria_padre`,`sottocategoria`.`Nome` AS `Nome`,`sottocategoria`.`Descrizione` AS `Descrizione`,1 AS `livello` from `sottocategoria` union all select `s1`.`Id_categoria` AS `Id_categoria`,`s2`.`Id_livello2` AS `id_sottocategoria`,`s2`.`Id_sottocategoria` AS `id_sottocategoria_padre`,`s2`.`Nome` AS `Nome`,`s2`.`descrizione` AS `Descrizione`,2 AS `livello` from (`sottocategoria2` `s2` join `sottocategoria` `s1` on((`s1`.`id_sottocategoria` = `s2`.`Id_sottocategoria`)))
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_quotes_details`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_quotes_details` AS select `preventivo`.`Id_preventivo` AS `ID Preventivo`,`preventivo`.`anno` AS `Anno`,`clienti`.`Id_cliente` AS `ID Cliente`,`clienti`.`Ragione_Sociale` AS `Cliente`,`tipo_preventivo`.`nome` AS `Tipo Preventivo`,`tipo_intprev`.`nome` AS `Tipo Intervento`,ucase(`stato_preventivo`.`Nome`) AS `Stato Preventivo`,`preventivo`.`Note` AS `Note Preventivo`,concat(if((`frazione`.`Nome` is not null),concat(`frazione`.`Nome`,' di '),''),if((`comune`.`Nome` is not null),concat(`comune`.`Nome`),''),if((`destinazione_cliente`.`Indirizzo` is not null),concat(' - ',`destinazione_cliente`.`Indirizzo`),''),convert(if((`destinazione_cliente`.`numero_civico` is not null),concat(',',`destinazione_cliente`.`numero_civico`),'') using latin1),if((`destinazione_cliente`.`Altro` is not null),concat('/',`destinazione_cliente`.`Altro`),''),if((`comune`.`cap` is not null),concat(' - ',`comune`.`cap`),''),' ',if((`destinazione_cliente`.`Provincia` is not null),concat(`destinazione_cliente`.`Provincia`),'')) AS `Provincia`,`preventivo`.`revisione` AS `Nr° Revisione`,if((`revisione_preventivo`.`Stampato` = 1),'SI','NO') AS `Stampato`,if((`revisione_preventivo`.`Inviato` = 1),'SI','NO') AS `Inviato`,sum(((round((`b`.`prezzo` - ((if((`preventivo_lotto`.`tipo_ricar` = 1),0,`b`.`sconto`) / 100) * `b`.`prezzo`)),2) + round(if((`b`.`montato` = '0'),0,(((`b`.`Tempo_installazione` / 60) * `b`.`Prezzo_h`) - ((((`b`.`Tempo_installazione` / 60) * `b`.`Prezzo_h`) * `b`.`scontolav`) / 100))),2)) * `b`.`quantità`)) AS `Totale`,`preventivo`.`data_invio` AS `Data Invio`,`preventivo`.`primo_sollecito` AS `Data invio 1° sollecito`,`preventivo`.`secondo_sollecito` AS `Data invio 2° sollecito`,`preventivo`.`data_creazione` AS `Data Creazione` from ((((((((((`preventivo` left join `revisione_preventivo` on(((`preventivo`.`revisione` = `revisione_preventivo`.`Id_revisione`) and (`preventivo`.`Id_preventivo` = `revisione_preventivo`.`Id_preventivo`) and (`revisione_preventivo`.`Anno` = `preventivo`.`anno`)))) left join `clienti` on((`clienti`.`Id_cliente` = `revisione_preventivo`.`id_cliente`))) left join `destinazione_cliente` on(((`destinazione_cliente`.`id_cliente` = `revisione_preventivo`.`id_cliente`) and (`destinazione_cliente`.`Id_destinazione` = `revisione_preventivo`.`destinazione`)))) left join `comune` on((`comune`.`Id_comune` = `destinazione_cliente`.`Comune`))) left join `frazione` on((`frazione`.`Id_frazione` = `destinazione_cliente`.`Frazione`))) left join `articolo_preventivo` `b` on(((`preventivo`.`Id_preventivo` = `b`.`Id_preventivo`) and (`preventivo`.`anno` = `b`.`anno`) and (`b`.`Id_revisione` = `preventivo`.`revisione`)))) left join `preventivo_lotto` on(((`preventivo_lotto`.`id_preventivo` = `revisione_preventivo`.`Id_preventivo`) and (`revisione_preventivo`.`Anno` = `preventivo_lotto`.`anno`) and (`revisione_preventivo`.`Id_revisione` = `preventivo_lotto`.`id_revisione`) and (`preventivo_lotto`.`posizione` = `b`.`Lotto`)))) join `stato_preventivo` on((`preventivo`.`Stato` = `stato_preventivo`.`Id_stato`))) left join `tipo_intprev` on((`tipo_intprev`.`id_tipo` = `preventivo`.`tipo_preventivo`))) join `tipo_preventivo` on((`preventivo`.`tipo` = `tipo_preventivo`.`id_tipo`))) group by `preventivo`.`anno`,`preventivo`.`Id_preventivo` order by `preventivo`.`anno` desc,`preventivo`.`Id_preventivo` desc
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_quote_body_details`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_quote_body_details` AS select `ap`.`Id_preventivo` AS `Id_preventivo`,`ap`.`anno` AS `anno`,`ap`.`Id_revisione` AS `Id_revisione`,`ap`.`Lotto` AS `id_lotto`,`ap`.`id_tab` AS `id_tab`,`l`.`Nome` AS `lotto`,`ap`.`Id_articolo` AS `id_articolo`,ifnull(`articolo`.`Desc_brev`,`ap`.`Desc_brev`) AS `descrizione`,`ap`.`codice_fornitore` AS `codice_fornitore`,round(`ap`.`quantità`,2) AS `quantità`,`ap`.`unità_misura` AS `unità_misura`,round(`ap`.`prezzo`,2) AS `prezzo_maateriale`,round(`ap`.`costo`,2) AS `costo_materiale`,`ap`.`sconto` AS `sconto_materiale`,`ap`.`Prezzo_h` AS `prezzo_h`,`ap`.`costo_h` AS `costo_h`,`ap`.`montato` AS `montato`,`ap`.`Tempo_installazione` AS `tempo_installazione`,`ap`.`scontolav` AS `sconto_lavoro`,`ap`.`scontoriga` AS `sconto_riga`,round(((((`ap`.`quantità` * ((`ap`.`prezzo` / 100) * (100 - `ap`.`sconto`))) + if((`ap`.`montato` = 0),0,(((`ap`.`Prezzo_h` * ((`ap`.`Tempo_installazione` * `ap`.`quantità`) / 60)) / 100) * ((0 - `ap`.`scontolav`) + 100)))) / 100) * ((0 - `ap`.`scontoriga`) + 100)),2) AS `prezzo_totale`,round(((`ap`.`quantità` * `ap`.`costo`) + if((`ap`.`montato` = 0),0,(`ap`.`costo_h` * ((`ap`.`Tempo_installazione` * `ap`.`quantità`) / 60)))),2) AS `costo_totale` from (((`articolo_preventivo` `ap` left join `articolo` on((`articolo`.`Codice_articolo` = `ap`.`Id_articolo`))) join `preventivo_lotto` `pl` on(((`ap`.`Id_preventivo` = `pl`.`id_preventivo`) and (`ap`.`anno` = `pl`.`anno`) and (`ap`.`Lotto` = `pl`.`posizione`) and (`ap`.`Id_revisione` = `pl`.`id_revisione`)))) left join `lotto` `l` on((`l`.`Id_lotto` = `pl`.`id_lotto`))) order by `ap`.`anno` desc,`ap`.`Id_preventivo` desc,`ap`.`Lotto`,`ap`.`id_tab`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_reportgroupproducts`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_reportgroupproducts` AS select `resoconto_rapporto`.`id_resoconto` AS `id_resoconto`,`resoconto_rapporto`.`anno_reso` AS `anno_reso`,`rapporto_materiale`.`Id_rapporto` AS `Id_rapporto`,`rapporto_materiale`.`anno` AS `anno`,`rapporto_materiale`.`Id_materiale` AS `Id_materiale`,`rapporto_materiale`.`descrizione` AS `descrizione`,`rapporto_materiale`.`quantità` AS `quantità`,`rapporto_materiale`.`Prezzo` AS `Prezzo`,`rapporto_materiale`.`costo` AS `Costo`,`rapporto_materiale`.`sconto` AS `Sconto`,`rapporto_materiale`.`id_magazzino` AS `id_magazzino`,`rapporto_materiale`.`id_tab` AS `id_tab`,`rapporto_materiale`.`tipo` AS `tipo`,`rapporto_materiale`.`qeconomia` AS `qeconomia`,ifnull(`articolo`.`unità_misura`,'--') AS `unita_misura` from (((`resoconto` join `resoconto_rapporto` on(((`resoconto`.`id_resoconto` = `resoconto_rapporto`.`id_resoconto`) and (`resoconto`.`anno` = `resoconto_rapporto`.`anno_reso`)))) join `rapporto_materiale` on(((`resoconto_rapporto`.`id_rapporto` = `rapporto_materiale`.`Id_rapporto`) and (`resoconto_rapporto`.`anno` = `rapporto_materiale`.`anno`)))) left join `articolo` on((`articolo`.`Codice_articolo` = `rapporto_materiale`.`Id_materiale`)))
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_report_daily_detailed`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_report_daily_detailed` AS select `rapporto_giornaliero`.`id` AS `id_rapporto_giornaliero`,`operaio`.`Id_operaio` AS `id_operaio`,`operaio`.`Ragione_sociale` AS `ragione_sociale_operaio`,`rapporto_giornaliero`.`data_rapporto` AS `data_rapporto`,`rapporto_giornaliero_attivita`.`ora_inizio` AS `ora_inizio`,`rapporto_giornaliero_attivita`.`ora_fine` AS `ora_fine`,round((time_to_sec(if((`rapporto_giornaliero_attivita`.`ora_fine` > `rapporto_giornaliero_attivita`.`ora_inizio`),timediff(`rapporto_giornaliero_attivita`.`ora_fine`,`rapporto_giornaliero_attivita`.`ora_inizio`),timediff('24:00:00',timediff(`rapporto_giornaliero_attivita`.`ora_inizio`,`rapporto_giornaliero_attivita`.`ora_fine`)))) / 60),0) AS `minuti_differenza`,if((`rapporto_giornaliero_attivita`.`ora_fine` > `rapporto_giornaliero_attivita`.`ora_inizio`),timediff(`rapporto_giornaliero_attivita`.`ora_fine`,`rapporto_giornaliero_attivita`.`ora_inizio`),timediff('24:00:00',timediff(`rapporto_giornaliero_attivita`.`ora_inizio`,`rapporto_giornaliero_attivita`.`ora_fine`))) AS `time_differenza`,`rapporto_giornaliero_attivita`.`tipo_lavoro` AS `tipo_attivita`,`rapporto_giornaliero_tipo_attivita`.`Nome` AS `nome`,`rapporto_giornaliero_attivita`.`note` AS `note`,`rapporto`.`Id_rapporto` AS `id_rapporto`,`rapporto`.`Anno` AS `anno_rapporto`,`clienti`.`Id_cliente` AS `Id_cliente`,`clienti`.`Ragione_Sociale` AS `ragione_sociale_cliente`,`impianto`.`Id_impianto` AS `id_impianto`,`impianto`.`Descrizione` AS `descrizione_impianto`,concat(`comune`.`Nome`,' (',`comune`.`provincia`,') - ',`comune`.`cap`,' - ',`destinazione_cliente`.`Indirizzo`,', ',`destinazione_cliente`.`numero_civico`) AS `indirizzo`,`tipo_intervento`.`Id_tipo` AS `id_tipo_intervento`,`tipo_intervento`.`Nome` AS `tipo_intervento`,ifnull(`rapporto_tecnico`.`Spesa_trasferta`,0) AS `spesa_trasferta`,ifnull(`rapporto_tecnico`.`autostrada`,0) AS `spesa_autostrada`,ifnull(`rapporto_tecnico`.`parcheggio`,0) AS `spesa_parcheggio`,ifnull(`rapporto_tecnico`.`altro`,0) AS `spesa_altro`,`rapporto_tecnico`.`altro_n` AS `spesa_altro_nota` from (((((((((((`rapporto_giornaliero` join `operaio` on((`operaio`.`Id_operaio` = `rapporto_giornaliero`.`id_operaio`))) join `rapporto_giornaliero_attivita` on((`rapporto_giornaliero`.`id` = `rapporto_giornaliero_attivita`.`Id_rapporto_giornaliero`))) join `rapporto_giornaliero_tipo_attivita` on((`rapporto_giornaliero_tipo_attivita`.`Id` = `rapporto_giornaliero_attivita`.`tipo_lavoro`))) left join `rapporto_giornaliero_attivita_rapporto` on((`rapporto_giornaliero_attivita_rapporto`.`Id_rapporto_giornaliero_attivita` = `rapporto_giornaliero_attivita`.`id`))) left join `rapporto` on(((`rapporto`.`Id_rapporto` = `rapporto_giornaliero_attivita_rapporto`.`Id_rapporto`) and (`rapporto`.`Anno` = `rapporto_giornaliero_attivita_rapporto`.`Anno_rapporto`)))) left join `rapporto_tecnico` on(((`rapporto_tecnico`.`Id_rapporto` = `rapporto`.`Id_rapporto`) and (`rapporto_tecnico`.`Anno` = `rapporto`.`Anno`) and (`rapporto_tecnico`.`Tecnico` = `rapporto_giornaliero`.`id_operaio`)))) left join `tipo_intervento` on((`tipo_intervento`.`Id_tipo` = `rapporto`.`Tipo_intervento`))) left join `clienti` on((`clienti`.`Id_cliente` = `rapporto`.`Id_cliente`))) left join `impianto` on((`impianto`.`Id_impianto` = `rapporto`.`Id_Impianto`))) left join `destinazione_cliente` on(((`destinazione_cliente`.`Id_destinazione` = `impianto`.`Destinazione`) and (`clienti`.`Id_cliente` = `destinazione_cliente`.`id_cliente`)))) left join `comune` on((`comune`.`Id_comune` = `destinazione_cliente`.`Comune`))) order by `rapporto_giornaliero`.`data_rapporto` desc,`rapporto_giornaliero_attivita`.`ora_inizio` desc
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_supplier_invoices_details`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_supplier_invoices_details` AS select `fornfattura`.`Id_fattura` AS `rif_prot`,`fornfattura`.`fattura_fornitore` AS `id_fattura`,`fornfattura`.`anno` AS `anno`,`fornitore`.`Id_fornitore` AS `Id_fornitore`,`fornitore`.`Ragione_Sociale` AS `ragione_sociale`,`a`.`Nome` AS `nome_condizione_pagamento`,`a`.`tipo` AS `id_tipo_pagamento`,`tipo_pagamento`.`nome` AS `nome_tipo_pagamento`,`fornfattura`.`data` AS `data_documento`,`tipo_attivita`.`id_tipo` AS `id_tipo_attivita`,`tipo_attivita`.`nome` AS `tipo_attivita`,`tipo_iva_bti`.`aliquota` AS `iva`,(`fornfattura`.`totale` + ((((`fornfattura`.`trasporto` / 100) * (100 + ifnull(`tipo_iva_bti`.`aliquota`,0))) + ((`fornfattura`.`bollo` / 100) * (100 + if((`fornfattura`.`iva_bollo` = 0),0,ifnull(`tipo_iva_bti`.`aliquota`,0))))) + ((`fornfattura`.`incasso` / 100) * (100 + if((`fornfattura`.`iva_incasso` = 0),0,ifnull(`tipo_iva_bti`.`aliquota`,0)))))) AS `totale_imponibile`,(`fornfattura`.`totiva` + ((((`fornfattura`.`trasporto` / 100) * (100 + ifnull(`tipo_iva_bti`.`aliquota`,0))) + ((`fornfattura`.`bollo` / 100) * (100 + if((`fornfattura`.`iva_bollo` = 0),0,ifnull(`tipo_iva_bti`.`aliquota`,0))))) + ((`fornfattura`.`incasso` / 100) * (100 + if((`fornfattura`.`iva_incasso` = 0),0,ifnull(`tipo_iva_bti`.`aliquota`,0)))))) AS `totale_ivato`,`stato_fattura`.`Nome` AS `stato_fattura` from (((((((`fornfattura` join `condizione_pagamento` `a` on((`fornfattura`.`cond_pagamento` = `a`.`Id_condizione`))) left join `condizioni_giorno` `g` on((`g`.`id_condizione` = `a`.`Id_condizione`))) join `fornitore` on((`fornfattura`.`id_fornitore` = `fornitore`.`Id_fornitore`))) left join `tipo_attivita` on((`fornfattura`.`id_attività` = `tipo_attivita`.`id_tipo`))) left join `tipo_pagamento` on((`a`.`tipo` = `tipo_pagamento`.`id_Tipo`))) left join `tipo_iva` `tipo_iva_bti` on((`tipo_iva_bti`.`Id_iva` = `fornfattura`.`aliquota_iva_BTI`))) join `stato_fattura` on((`stato_fattura`.`Id_stato` = `fornfattura`.`Stato`))) group by `fornfattura`.`Id_fattura`,`fornfattura`.`anno`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_supplier_invoices_payments_details`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_supplier_invoices_payments_details` AS select `fornfattura`.`Id_fattura` AS `id_fattura`,`fornfattura`.`anno` AS `anno`,`fornfattura`.`fattura_fornitore` AS `id_fattura_fornitore`,`fornfattura`.`data` AS `data_fattura`,`fornitore`.`Id_fornitore` AS `id_fornitore`,`fornitore`.`Ragione_Sociale` AS `ragione_sociale`,`a`.`Nome` AS `condizione_pagamento`,ifnull(`tipopag`.`id_Tipo`,`tipo_pagamento`.`id_Tipo`) AS `id_tipo_pagamento`,ifnull(`tipopag`.`nome`,`tipo_pagamento`.`nome`) AS `tipo_pagamento`,((`fornfattura`.`totiva` + ((((`fornfattura`.`trasporto` / 100) * (100 + (select `tipo_iva`.`aliquota` from `tipo_iva` where (`tipo_iva`.`Id_iva` = `fornfattura`.`aliquota_iva_BTI`)))) + ((`fornfattura`.`bollo` / 100) * (100 + if((`fornfattura`.`iva_bollo` = 0),0,(select `tipo_iva`.`aliquota` from `tipo_iva` where (`tipo_iva`.`Id_iva` = `fornfattura`.`aliquota_iva_BTI`)))))) + ((`fornfattura`.`incasso` / 100) * (100 + if((`fornfattura`.`iva_incasso` = 0),0,(select `tipo_iva`.`aliquota` from `tipo_iva` where (`tipo_iva`.`Id_iva` = `fornfattura`.`aliquota_iva_BTI`))))))) / `a`.`mesi`) AS `importo_pagamento`,sum((`fornfattura`.`totiva` + ((((`fornfattura`.`trasporto` / 100) * (100 + (select `tipo_iva`.`aliquota` from `tipo_iva` where (`tipo_iva`.`Id_iva` = `fornfattura`.`aliquota_iva_BTI`)))) + ((`fornfattura`.`bollo` / 100) * (100 + if((`fornfattura`.`iva_bollo` = 0),0,(select `tipo_iva`.`aliquota` from `tipo_iva` where (`tipo_iva`.`Id_iva` = `fornfattura`.`aliquota_iva_BTI`)))))) + ((`fornfattura`.`incasso` / 100) * (100 + if((`fornfattura`.`iva_incasso` = 0),0,(select `tipo_iva`.`aliquota` from `tipo_iva` where (`tipo_iva`.`Id_iva` = `fornfattura`.`aliquota_iva_BTI`)))))))) AS `importo_fattura`,(last_day((`fornfattura`.`data` + interval `g`.`mesi` month)) + interval `g`.`giorni` day) AS `data_pagamento_prevista`,`fornfattura_pagamenti`.`data` AS `data_pagamento_effettiva`,if((`fornfattura_pagamenti`.`id_pagamento` is not null),'1','0') AS `pagato`,if((`fornfattura_pagamenti`.`id_pagamento` is not null),concat('Pagato con ',`tipopag`.`nome`,' il ',convert(date_format(`fornfattura_pagamenti`.`data`,'%m/%d/%Y') using latin1)),'') AS `nota_pagamento_effettuato` from ((((((`fornfattura` join `condizione_pagamento` `a` on((`fornfattura`.`cond_pagamento` = `a`.`Id_condizione`))) left join `condizioni_giorno` `g` on((`g`.`id_condizione` = `a`.`Id_condizione`))) join `fornitore` on((`fornfattura`.`id_fornitore` = `fornitore`.`Id_fornitore`))) left join `tipo_pagamento` on((`a`.`tipo` = `tipo_pagamento`.`id_Tipo`))) left join `fornfattura_pagamenti` on(((`fornfattura`.`Id_fattura` = `fornfattura_pagamenti`.`id_fattura`) and (`fornfattura`.`anno` = `fornfattura_pagamenti`.`anno`) and (date_format((last_day((`fornfattura`.`data` + interval `g`.`mesi` month)) + interval `g`.`giorni` day),'%Y%m%d') = `fornfattura_pagamenti`.`id_pagamento`)))) left join `tipo_pagamento` `tipopag` on(((`fornfattura_pagamenti`.`tipo_pagamento` = `tipopag`.`id_Tipo`) and (`fornfattura_pagamenti`.`id_pagamento` = date_format((last_day((`fornfattura`.`data` + interval `g`.`mesi` month)) + interval `g`.`giorni` day),'%Y%m%d'))))) group by `fornfattura`.`fattura_fornitore`,(last_day((`fornfattura`.`data` + interval `g`.`mesi` month)) + interval `g`.`giorni` day)
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_systemperiodicmonitoringremindergridmain`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_systemperiodicmonitoringremindergridmain` AS select `impianto_abbonamenti_mesi`.`Id` AS `Id`,`impianto_abbonamenti_mesi`.`mese` AS `id_mese`,`impianto_abbonamenti_mesi`.`anno` AS `anno`,`impianto`.`Id_impianto` AS `id_impianto`,`impianto`.`Descrizione` AS `descrizione_impianto`,`clienti`.`Id_cliente` AS `Id_cliente`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,if(isnull(`impianto_abbonamenti_mesi`.`Eseguito_il`),0,1) AS `svolto`,ifnull(`impianto_abbonamenti_mesi`.`Eseguito_il`,`impianto_abbonamenti_mesi`.`da_eseguire`) AS `da_eseguire`,`tipo_impianto`.`nome` AS `Tipo_impianto`,ifnull((`impianto`.`Tempo_manutenzione` / 60),0) AS `tempo_manutenzione` from (((`impianto_abbonamenti_mesi` join `impianto` on((`impianto_abbonamenti_mesi`.`impianto` = `impianto`.`Id_impianto`))) join `clienti` on((`impianto`.`Id_cliente` = `clienti`.`Id_cliente`))) join `tipo_impianto` on((`impianto`.`Tipo_impianto` = `tipo_impianto`.`id_tipo`))) order by ifnull(`impianto_abbonamenti_mesi`.`Eseguito_il`,`impianto_abbonamenti_mesi`.`da_eseguire`)
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_systemperiodicmonitoringremindergridmainelementtypeone`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_systemperiodicmonitoringremindergridmainelementtypeone` AS select cast(concat(date_format(curdate(),'%y'),lpad(`impianto_mesi`.`Id_mese`,2,0),`impianto_mesi`.`Id_impianto`) as unsigned) AS `Id`,`impianto_mesi`.`Id_mese` AS `id_mese`,year(curdate()) AS `anno`,`impianto_mesi`.`Id_impianto` AS `id_impianto`,`impianto`.`Descrizione` AS `descrizione_impianto`,`clienti`.`Id_cliente` AS `Id_cliente`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,0 AS `svolto`,NULL AS `da_eseguire`,`tipo_impianto`.`nome` AS `Tipo_impianto`,0 AS `tempo_manutenzione` from (((`impianto_mesi` join `impianto` on((`impianto_mesi`.`Id_impianto` = `impianto`.`Id_impianto`))) join `clienti` on((`impianto`.`Id_cliente` = `clienti`.`Id_cliente`))) join `tipo_impianto` on((`impianto`.`Tipo_impianto` = `tipo_impianto`.`id_tipo`))) where (`impianto`.`Stato` = 0) order by `impianto_mesi`.`Id_mese`,`clienti`.`Ragione_Sociale`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_systemperiodicmonitoringremindergridmainelementtypezero`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_systemperiodicmonitoringremindergridmainelementtypezero` AS select `impianto_abbonamenti_mesi`.`Id` AS `Id`,`impianto_abbonamenti_mesi`.`mese` AS `id_mese`,`impianto_abbonamenti_mesi`.`anno` AS `anno`,`impianto`.`Id_impianto` AS `id_impianto`,`impianto`.`Descrizione` AS `descrizione_impianto`,`clienti`.`Id_cliente` AS `Id_cliente`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,if(isnull(`impianto_abbonamenti_mesi`.`Eseguito_il`),0,1) AS `svolto`,ifnull(`impianto_abbonamenti_mesi`.`Eseguito_il`,`impianto_abbonamenti_mesi`.`da_eseguire`) AS `da_eseguire`,`tipo_impianto`.`nome` AS `Tipo_impianto`,ifnull((`impianto`.`Tempo_manutenzione` / 60),0) AS `tempo_manutenzione` from (((`impianto_abbonamenti_mesi` join `impianto` on((`impianto_abbonamenti_mesi`.`impianto` = `impianto`.`Id_impianto`))) join `clienti` on((`impianto`.`Id_cliente` = `clienti`.`Id_cliente`))) join `tipo_impianto` on((`impianto`.`Tipo_impianto` = `tipo_impianto`.`id_tipo`))) order by ifnull(`impianto_abbonamenti_mesi`.`Eseguito_il`,`impianto_abbonamenti_mesi`.`da_eseguire`)
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_systems_components`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_systems_components` AS select distinct `vw_systems_components_detail`.`id_articolo` AS `id_articolo`,`articolo`.`Desc_brev` AS `desc_brev`,`articolo`.`Codice_fornitore` AS `codice_fornitore`,`vw_systems_components_detail`.`id_impianto` AS `id_impianto`,sum(if(isnull(`vw_systems_components_detail`.`data_dismesso`),1,0)) AS `quantità`,sum(if((isnull(`vw_systems_components_detail`.`data_dismesso`) and (`vw_systems_components_detail`.`stato_scadenza` = 'expiring')),1,0)) AS `quantita_in_scadenza`,sum(if((isnull(`vw_systems_components_detail`.`data_dismesso`) and (`vw_systems_components_detail`.`stato_scadenza` = 'expired')),1,0)) AS `quantita_scaduti`,sum(if((isnull(`vw_systems_components_detail`.`data_dismesso`) and (`vw_systems_components_detail`.`stato_scadenza` = 'not_expired')),1,0)) AS `quantita_non_scaduti`,sum(if((isnull(`vw_systems_components_detail`.`data_dismesso`) and (`vw_systems_components_detail`.`stato_scadenza` = 'none')),1,0)) AS `quantita_no_scadenza`,`articolo_stato`.`colore` AS `colore` from ((`vw_systems_components_detail` join `articolo` on((`vw_systems_components_detail`.`id_articolo` = `articolo`.`Codice_articolo`))) left join `articolo_stato` on((`articolo`.`Stato_articolo` = `articolo_stato`.`Id_stato`))) group by `vw_systems_components_detail`.`id_impianto`,`vw_systems_components_detail`.`id_articolo`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_systems_components_detail`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_systems_components_detail` AS select `impianto_componenti`.`Id_impianto` AS `id_impianto`,`impianto_componenti`.`Id_articolo` AS `id_articolo`,`impianto_box`.`Descrizione` AS `Posizionamento`,`impianto_componenti`.`fine_Garanzia` AS `fine_garanzia`,`impianto_componenti`.`id` AS `ordine`,`impianto_componenti`.`data_installazione` AS `data_installazione`,`impianto_componenti`.`data_dismesso` AS `data_dismesso`,`impianto_componenti`.`Data_scadenza` AS `data_scadenza`,if(isnull(`impianto_componenti`.`Data_scadenza`),'none',if((`impianto_componenti`.`Data_scadenza` between (now() + interval 30 day) and now()),'expiring',if((`impianto_componenti`.`Data_scadenza` < now()),'expired','not_expired'))) AS `stato_scadenza`,`impianto_componenti`.`garanzia_fornitore` AS `garanzia_fornitore`,`impianto_componenti`.`id_versione` AS `id_versione`,`impianto_componenti_versione`.`versione` AS `versione` from ((`impianto_componenti` left join `impianto_box` on(((`impianto_box`.`Id_impianto` = `impianto_componenti`.`Id_impianto`) and (`impianto_box`.`Id_box` = `impianto_componenti`.`BOX`)))) left join `impianto_componenti_versione` on((`impianto_componenti_versione`.`id_versione` = `impianto_componenti`.`id_versione`))) group by `impianto_componenti`.`Id_impianto`,`impianto_componenti`.`Id_articolo`,`impianto_componenti`.`id` order by isnull(`impianto_componenti`.`Data_scadenza`),`impianto_componenti`.`Data_scadenza`,isnull(`impianto_componenti`.`data_dismesso`),`impianto_componenti`.`data_dismesso`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_systems_customers_details`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_systems_customers_details` AS select `clienti`.`Id_cliente` AS `id_cliente`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,`tipo_cliente`.`Nome` AS `tipo_cliente`,`tipo_rapclie`.`nome` AS `tipo_rap`,`stato_clienti`.`Nome` AS `stato_cliente`,`riferimento_clienti`.`Telefono` AS `telefono`,`riferimento_clienti`.`mail` AS `mail`,`riferimento_clienti`.`altro_telefono` AS `altro_telefono`,if(isnull(`dc`.`Frazione`),`c`.`Nome`,concat(`c`.`Nome`,' - ',`f`.`Nome`)) AS `paese`,`c`.`cap` AS `cap`,`dc`.`Provincia` AS `provincia`,if((isnull(`dc`.`numero_civico`) or (`dc`.`Indirizzo` = '')),`dc`.`Indirizzo`,concat(`dc`.`Indirizzo`,', ',`dc`.`numero_civico`)) AS `indirizzo`,concat(`impianto`.`Id_impianto`,' ') AS `id`,`impianto`.`Id_impianto` AS `id_impianto`,`tipo_impianto`.`nome` AS `tipo_impianto`,`stato_impianto`.`Nome` AS `stato_impianto`,`impianto`.`Descrizione` AS `descrizione`,`impianto`.`Data_Funzione` AS `data_funzione`,`impianto`.`scadenza_garanzia` AS `scadenza_garanzia`,(`impianto`.`Tempo_manutenzione` / 60) AS `tempo_manutenzione`,max(`impianto_uscita`.`Manutenzione`) AS `costo2`,`impianto`.`Costo_Manutenzione` AS `manutenzione`,`abbonamento`.`Nome` AS `abbonamento`,`impianto`.`Persone` AS `persone`,cast(group_concat(distinct substr(`mese`.`Nome`,1,3) separator ', ') as char(150) charset utf8) AS `Controlli`,'NESSUNO' AS `id_mese`,if(`impianto`.`checklist`,'SI','NO') AS `Checklist`,`stato_invio_abbonamento`.`nome` AS `stato_invio_abbonamento` from (((((((((((((((`impianto` join `tipo_impianto` on((`impianto`.`Tipo_impianto` = `tipo_impianto`.`id_tipo`))) join `stato_impianto` on((`impianto`.`Stato` = `stato_impianto`.`Id_stato`))) join `clienti` on((`clienti`.`Id_cliente` = `impianto`.`Id_cliente`))) join `stato_clienti` on((`clienti`.`Stato_cliente` = `stato_clienti`.`Id_stato`))) join `tipo_cliente` on((`clienti`.`Tipo_Cliente` = `tipo_cliente`.`Id_tipo`))) join `tipo_rapclie` on((`clienti`.`tipo_rapporto` = `tipo_rapclie`.`id_tipo`))) left join `impianto_uscita` on(((`impianto_uscita`.`id_impianto` = `impianto`.`Id_impianto`) and `impianto_uscita`.`id_impianto`))) join `riferimento_clienti` on(((`clienti`.`Id_cliente` = `riferimento_clienti`.`Id_cliente`) and (`riferimento_clienti`.`Id_riferimento` = 1)))) left join `destinazione_cliente` `dc` on(((`dc`.`id_cliente` = `clienti`.`Id_cliente`) and (`dc`.`Id_destinazione` = `impianto`.`Destinazione`)))) left join `comune` `c` on((`c`.`Id_comune` = `dc`.`Comune`))) left join `frazione` `f` on((`f`.`Id_frazione` = `dc`.`Frazione`))) left join `abbonamento` on((`abbonamento`.`Id_abbonamento` = `impianto_uscita`.`id_abbonamento`))) left join `impianto_abbonamenti_mesi` on(((`impianto`.`Id_impianto` = `impianto_abbonamenti_mesi`.`impianto`) and (`impianto_abbonamenti_mesi`.`anno` = date_format(now(),'%Y'))))) left join `mese` on((`mese`.`Id_mese` = `impianto_abbonamenti_mesi`.`mese`))) join `stato_invio_abbonamento` on((`impianto`.`stato_invio_doc` = `stato_invio_abbonamento`.`colore`))) group by `impianto`.`Id_impianto` union all select `clienti`.`Id_cliente` AS `id_cliente`,`clienti`.`Ragione_Sociale` AS `ragione_sociale`,`tipo_cliente`.`Nome` AS `tipo_cliente`,`tipo_rapclie`.`nome` AS `tipo_rap`,`stato_clienti`.`Nome` AS `stato_cliente`,`riferimento_clienti`.`Telefono` AS `telefono`,`riferimento_clienti`.`mail` AS `mail`,`riferimento_clienti`.`altro_telefono` AS `altro_telefono`,if(isnull(`dc`.`Frazione`),`c`.`Nome`,concat(`c`.`Nome`,' - ',`f`.`Nome`)) AS `paese`,`c`.`cap` AS `cap`,`dc`.`Provincia` AS `provincia`,if((isnull(`dc`.`numero_civico`) or (`dc`.`Indirizzo` = '')),`dc`.`Indirizzo`,concat(`dc`.`Indirizzo`,', ',`dc`.`numero_civico`)) AS `indirizzo`,'' AS `id`,NULL AS `id_impianto`,'' AS `tipo_impianto`,'' AS `stato_impianto`,'' AS `descrizione`,NULL AS `data_funzione`,NULL AS `scadenza_garanzia`,NULL AS `tempo_manutenzione`,NULL AS `costo2`,NULL AS `manutenzione`,'' AS `abbonamento`,NULL AS `persone`,'' AS `Controlli`,'NESSUNO' AS `id_mese`,'' AS `Checklist`,'' AS `stato_invio_abbonamento` from (((((((`clienti` join `riferimento_clienti` on(((`clienti`.`Id_cliente` = `riferimento_clienti`.`Id_cliente`) and (`riferimento_clienti`.`Id_riferimento` = 1)))) left join `destinazione_cliente` `dc` on(((`dc`.`id_cliente` = `clienti`.`Id_cliente`) and (`dc`.`Sede_principale` = 1)))) left join `comune` `c` on((`c`.`Id_comune` = `dc`.`Comune`))) left join `frazione` `f` on((`f`.`Id_frazione` = `dc`.`Frazione`))) join `stato_clienti` on((`clienti`.`Stato_cliente` = `stato_clienti`.`Id_stato`))) join `tipo_cliente` on((`clienti`.`Tipo_Cliente` = `tipo_cliente`.`Id_tipo`))) join `tipo_rapclie` on((`clienti`.`tipo_rapporto` = `tipo_rapclie`.`id_tipo`)))
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_systems_expirations_summary`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_systems_expirations_summary` AS select `ticket`.`Id` AS `id_riferimento`,'ticket_expiration' AS `tipo_entita`,'Scadenza Ticket' AS `tipo_scadenza`,`ticket`.`Id_impianto` AS `id_impianto`,`ticket`.`Id_cliente` AS `id_cliente`,`ticket`.`Descrizione` AS `descrizione`,`ticket`.`scadenza` AS `data_scadenza`,`ticket`.`data_promemoria` AS `data_promemoria`,`ticket`.`data_ultimo_promemoria` AS `data_ultimo_promemoria`,NULL AS `quantita`,`ticket`.`id_stato_promemoria` AS `id_stato_promemoria` from `ticket` where ((`ticket`.`scadenza` is not null) and isnull(`ticket`.`data_soluzione`) and (`ticket`.`Stato_ticket` in (1,2))) union all select `impianto_componenti`.`id_impianto_componenti` AS `id_riferimento`,'systems_components' AS `tipo_entita`,'Componente Impianto' AS `tipo_scadenza`,`impianto_componenti`.`Id_impianto` AS `id_impianto`,`impianto`.`Id_cliente` AS `id_cliente`,`articolo`.`Desc_brev` AS `descrizione`,`impianto_componenti`.`Data_scadenza` AS `data_scadenza`,`impianto_componenti`.`data_promemoria` AS `data_promemoria`,`impianto_componenti`.`data_ultimo_promemoria` AS `data_ultimo_promemoria`,count(0) AS `quantità`,`impianto_componenti`.`id_stato_promemoria` AS `id_stato_promemoria` from (((`impianto_componenti` join `articolo` on((`impianto_componenti`.`Id_articolo` = `articolo`.`Codice_articolo`))) join `impianto` on((`impianto`.`Id_impianto` = `impianto_componenti`.`Id_impianto`))) join `stato_impianto` on((`stato_impianto`.`Id_stato` = `impianto`.`Stato`))) where ((`impianto_componenti`.`Data_scadenza` is not null) and isnull(`impianto_componenti`.`data_dismesso`) and (`stato_impianto`.`bloccato` = 0)) group by `impianto_componenti`.`Id_impianto`,`impianto_componenti`.`Id_articolo`,`impianto_componenti`.`Data_scadenza` union all select `impianto`.`Id_impianto` AS `id_riferimento`,'system_warranty' AS `tipo_entita`,'Garanzia Impianto' AS `tipo_scadenza`,`impianto`.`Id_impianto` AS `id_impianto`,`impianto`.`Id_cliente` AS `id_cliente`,`impianto`.`Descrizione` AS `descrizione`,`impianto`.`scadenza_garanzia` AS `data_scadenza`,`impianto`.`data_promemoria_garanzia` AS `data_promemoria_garanzia`,`impianto`.`data_ultimo_promemoria_garanzia` AS `data_ultimo_promemoria_garanzia`,NULL AS `quantità`,`impianto`.`id_stato_promemoria_garanzia` AS `id_stato_promemoria_garanzia` from `impianto` where ((`impianto`.`scadenza_garanzia` is not null) and (`impianto`.`scadenza_garanzia` >= (curdate() + interval -(6) month))) union all select `impianto_abbonamenti_mesi`.`Id` AS `id_riferimento`,'system_maintenance_month' AS `tipo_entita`,'Controllo Periodico' AS `tipo_scadenza`,`impianto_abbonamenti_mesi`.`impianto` AS `id_impianto`,`impianto`.`Id_cliente` AS `id_cliente`,concat('Controllo Periodico ',`impianto_abbonamenti_mesi`.`mese`,'/',`impianto_abbonamenti_mesi`.`anno`) AS `descrizione`,ifnull(`impianto_abbonamenti_mesi`.`da_eseguire`,(makedate(`impianto_abbonamenti_mesi`.`anno`,1) + interval (`impianto_abbonamenti_mesi`.`mese` - 1) month)) AS `data_scadenza`,`impianto_abbonamenti_mesi`.`data_promemoria` AS `data_promemoria`,`impianto_abbonamenti_mesi`.`data_ultimo_promemoria` AS `data_ultimo_promemoria`,NULL AS `quantità`,`impianto_abbonamenti_mesi`.`id_stato_promemoria` AS `id_stato_promemoria` from ((`impianto_abbonamenti_mesi` join `impianto` on((`impianto`.`Id_impianto` = `impianto_abbonamenti_mesi`.`impianto`))) join `stato_impianto` on((`stato_impianto`.`Id_stato` = `impianto`.`Stato`))) where (isnull(`impianto_abbonamenti_mesi`.`Eseguito_il`) and (`stato_impianto`.`bloccato` = 0)) union all select `impianto_ricarica_tipo`.`id` AS `id_riferimento`,'system_sim_renew' AS `tipo_entita`,'Rinnovo SIM' AS `tipo_scadenza`,`impianto_ricarica_tipo`.`id_impianto` AS `id_impianto`,`impianto`.`Id_cliente` AS `id_cliente`,concat('Rinnovo SIM ',`impianto_ricarica_tipo`.`numero`,' importo ',`impianto_ricarica_tipo`.`importo`) AS `descrizione`,`impianto_ricarica_tipo`.`data_rinnovo` AS `data_scadenza`,`impianto_ricarica_tipo`.`data_promemoria` AS `data_promemoria`,`impianto_ricarica_tipo`.`data_ultimo_promemoria` AS `data_ultimo_promemoria`,NULL AS `quantità`,`impianto_ricarica_tipo`.`id_stato_promemoria` AS `id_stato_promemoria` from ((`impianto_ricarica_tipo` join `impianto` on((`impianto`.`Id_impianto` = `impianto_ricarica_tipo`.`id_impianto`))) join `stato_impianto` on((`stato_impianto`.`Id_stato` = `impianto`.`Stato`))) where ((`impianto_ricarica_tipo`.`data_rinnovo` is not null) and (isnull(`impianto_ricarica_tipo`.`data_scadenza`) or (`impianto_ricarica_tipo`.`data_rinnovo` < `impianto_ricarica_tipo`.`data_scadenza`)) and (`stato_impianto`.`bloccato` = 0)) union all select `impianto_ricarica_tipo`.`id` AS `id_riferimento`,'system_sim_expiration' AS `tipo_entita`,'Scadenza SIM' AS `tipo_scadenza`,`impianto_ricarica_tipo`.`id_impianto` AS `id_impianto`,`impianto`.`Id_cliente` AS `id_cliente`,concat('Scadenza SIM ',`impianto_ricarica_tipo`.`numero`,' importo ',`impianto_ricarica_tipo`.`importo`) AS `descrizione`,`impianto_ricarica_tipo`.`data_scadenza` AS `data_scadenza`,`impianto_ricarica_tipo`.`data_promemoria` AS `data_promemoria`,`impianto_ricarica_tipo`.`data_ultimo_promemoria` AS `data_ultimo_promemoria`,NULL AS `quantità`,`impianto_ricarica_tipo`.`id_stato_promemoria` AS `id_stato_promemoria` from ((`impianto_ricarica_tipo` join `impianto` on((`impianto`.`Id_impianto` = `impianto_ricarica_tipo`.`id_impianto`))) join `stato_impianto` on((`stato_impianto`.`Id_stato` = `impianto`.`Stato`))) where ((`impianto_ricarica_tipo`.`data_scadenza` is not null) and (isnull(`impianto_ricarica_tipo`.`data_rinnovo`) or (`impianto_ricarica_tipo`.`data_scadenza` > `impianto_ricarica_tipo`.`data_rinnovo`)) and (`stato_impianto`.`bloccato` = 0))
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_systems_exports_to_contact`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_systems_exports_to_contact` AS select `clienti`.`Id_cliente` AS `ID Cliente`,`clienti`.`Ragione_Sociale` AS `Ragione Sociale`,`tipo_cliente`.`Nome` AS `Tipo Cliente`,`tipo_rapclie`.`nome` AS `Tipo Rapporto`,`stato_clienti`.`Nome` AS `Stato Cliente`,`riferimento_clienti`.`Telefono` AS `Telefono`,`riferimento_clienti`.`mail` AS `Email`,`riferimento_clienti`.`altro_telefono` AS `Cellulare`,if(isnull(`dc`.`Frazione`),`c`.`Nome`,concat(`c`.`Nome`,' - ',`f`.`Nome`)) AS `Città`,`c`.`cap` AS `CAP`,`dc`.`Provincia` AS `Provincia`,if((isnull(`dc`.`numero_civico`) or (`dc`.`Indirizzo` = '')),`dc`.`Indirizzo`,concat(`dc`.`Indirizzo`,', ',`dc`.`numero_civico`)) AS `Indirizzo`,`impianto`.`Id_impianto` AS `ID Impianto`,`tipo_impianto`.`nome` AS `Tipo Impianto`,`stato_impianto`.`Nome` AS `Stato Impianto`,`impianto`.`Descrizione` AS `Descrizione`,`impianto`.`Data_Funzione` AS `Data Funzione`,`impianto`.`scadenza_garanzia` AS `Scadenza Garanzia`,(`impianto`.`Tempo_manutenzione` / 60) AS `Tempo Manutenzione`,max(`impianto_uscita`.`Manutenzione`) AS `Costo Manutenzione`,`impianto`.`Costo_Manutenzione` AS `Costo Ipotetico Manutenzione`,`abbonamento`.`Nome` AS `Abbonamento`,`impianto`.`Persone` AS `Persone Necessarie`,cast(group_concat(distinct substr(`mese`.`Nome`,1,3) separator ', ') as char(150) charset utf8) AS `Controlli`,(select `rapporto`.`Data_esecuzione` from `rapporto` where (`rapporto`.`Id_Impianto` = `impianto`.`Id_impianto`) order by `rapporto`.`Data_esecuzione` desc limit 1) AS `Data Ultimo Rapporto`,(select `revisione_preventivo`.`data` from (`revisione_preventivo` join `preventivo` on(((`preventivo`.`Id_preventivo` = `revisione_preventivo`.`Id_preventivo`) and (`preventivo`.`anno` = `revisione_preventivo`.`Anno`) and (`preventivo`.`Stato` in (3,5,6,12,13,10,11))))) where (`revisione_preventivo`.`id_cliente` = `clienti`.`Id_cliente`) order by `revisione_preventivo`.`data` desc limit 1) AS `Data Ultimo Preventivo Aperto`,(select `fattura`.`data` from `fattura` where (`fattura`.`id_cliente` = `impianto`.`Id_cliente`) order by `fattura`.`data` desc limit 1) AS `Data Ultima Fattura` from ((((((((((((((`impianto` join `tipo_impianto` on((`impianto`.`Tipo_impianto` = `tipo_impianto`.`id_tipo`))) join `stato_impianto` on((`impianto`.`Stato` = `stato_impianto`.`Id_stato`))) join `clienti` on((`clienti`.`Id_cliente` = `impianto`.`Id_cliente`))) join `stato_clienti` on((`clienti`.`Stato_cliente` = `stato_clienti`.`Id_stato`))) join `tipo_cliente` on((`clienti`.`Tipo_Cliente` = `tipo_cliente`.`Id_tipo`))) join `tipo_rapclie` on((`clienti`.`tipo_rapporto` = `tipo_rapclie`.`id_tipo`))) left join `impianto_uscita` on(((`impianto_uscita`.`id_impianto` = `impianto`.`Id_impianto`) and `impianto_uscita`.`id_impianto`))) join `riferimento_clienti` on(((`clienti`.`Id_cliente` = `riferimento_clienti`.`Id_cliente`) and (`riferimento_clienti`.`Id_riferimento` = 1)))) left join `destinazione_cliente` `dc` on(((`dc`.`id_cliente` = `clienti`.`Id_cliente`) and (`dc`.`Id_destinazione` = `impianto`.`Destinazione`)))) left join `comune` `c` on((`c`.`Id_comune` = `dc`.`Comune`))) left join `frazione` `f` on((`f`.`Id_frazione` = `dc`.`Frazione`))) left join `abbonamento` on((`abbonamento`.`Id_abbonamento` = `impianto_uscita`.`id_abbonamento`))) left join `impianto_abbonamenti_mesi` on(((`impianto`.`Id_impianto` = `impianto_abbonamenti_mesi`.`impianto`) and (`impianto_abbonamenti_mesi`.`anno` = date_format(now(),'%Y'))))) left join `mese` on((`mese`.`Id_mese` = `impianto_abbonamenti_mesi`.`mese`))) group by `impianto`.`Id_impianto`
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_ticket_details`;
CREATE ALGORITHM=UNDEFINED SQL SECURITY DEFINER VIEW `vw_ticket_details` AS select `ticket`.`Id_ticket` AS `Id_ticket`,`ticket`.`anno` AS `anno`,`ticket`.`Id_impianto` AS `Id_impianto`,`ticket`.`Id_cliente` AS `Id_cliente`,`clienti`.`Ragione_Sociale` AS `cliente`,`impianto`.`Descrizione` AS `impianto`,`tipo_impianto`.`nome` AS `tipo_impianto`,`ticket`.`Descrizione` AS `descrizione`,`stato_ticket`.`Id_stato` AS `id_stato_ticket`,`stato_ticket`.`nome` AS `stato_ticket`,`stato_ticket`.`colore` AS `colore_stato_ticket`,`stato_ticket`.`aperto` AS `stato_ticket_aperto`,`causale_ticket`.`Nome` AS `Causale`,if((`ticket`.`Urgenza` = 0),'BASSA',if((`ticket`.`Urgenza` = 1),'NORMALE','ALTA')) AS `Urgenza`,`tipo_intervento`.`Nome` AS `tipo_intervento`,`pervenuta_per`.`nome` AS `sorgente`,`ticket`.`tempo` AS `tempo_minuti`,round((`ticket`.`tempo` / 60),2) AS `tempo_ore`,`ticket`.`data_ticket` AS `data_ticket`,`ticket`.`scadenza` AS `scadenza`,`ticket`.`data_soluzione` AS `data_soluzione`,`riferimento_clienti`.`Telefono` AS `telefono`,`riferimento_clienti`.`altro_telefono` AS `cellulare`,`riferimento_clienti`.`mail` AS `mail`,if(isnull(`dc`.`Frazione`),`c`.`Nome`,concat(`c`.`Nome`,' - ',`f`.`Nome`)) AS `paese`,`c`.`cap` AS `cap`,`dc`.`Provincia` AS `provincia`,if((isnull(`dc`.`numero_civico`) or (`dc`.`Indirizzo` = '')),`dc`.`Indirizzo`,concat(`dc`.`Indirizzo`,', ',`dc`.`numero_civico`)) AS `indirizzo` from (((((((((((`ticket` join `clienti` on((`clienti`.`Id_cliente` = `ticket`.`Id_cliente`))) left join `impianto` on((`impianto`.`Id_impianto` = `ticket`.`Id_impianto`))) left join `tipo_impianto` on((`impianto`.`Tipo_impianto` = `tipo_impianto`.`id_tipo`))) join `causale_ticket` on((`causale_ticket`.`Id_causale` = `ticket`.`Causale`))) join `tipo_intervento` on((`tipo_intervento`.`Id_tipo` = `ticket`.`intervento`))) join `stato_ticket` on((`stato_ticket`.`Id_stato` = `ticket`.`Stato_ticket`))) join `pervenuta_per` on((`pervenuta_per`.`Id_modo` = `ticket`.`Comunicazione`))) join `riferimento_clienti` on(((`clienti`.`Id_cliente` = `riferimento_clienti`.`Id_cliente`) and (`riferimento_clienti`.`Id_riferimento` = 1)))) left join `destinazione_cliente` `dc` on(((`dc`.`id_cliente` = `clienti`.`Id_cliente`) and (`dc`.`Id_destinazione` = `ticket`.`Id_destinazione`)))) left join `comune` `c` on((`c`.`Id_comune` = `dc`.`Comune`))) left join `frazione` `f` on((`f`.`Id_frazione` = `dc`.`Frazione`))) order by `ticket`.`data_ticket` desc
;

-- Rimozione temporanea di tabella e creazione della struttura finale della vista
DROP TABLE IF EXISTS `vw_user`;
CREATE VIEW `vw_user` AS select `emmebi`.`utente`.`Id_utente` AS `Id_utente`,`emmebi`.`utente`.`Password` AS `Password`,`emmebi`.`utente`.`Nome` AS `Nome`,`emmebi`.`utente`.`Descrizione` AS `Descrizione`,`emmebi`.`utente`.`mail` AS `mail`,`emmebi`.`utente`.`Firma` AS `Firma`,`emmebi`.`utente`.`calendario` AS `calendario`,`emmebi`.`utente`.`smtp` AS `smtp`,`emmebi`.`utente`.`porta` AS `porta`,`emmebi`.`utente`.`mssl` AS `mssl`,`emmebi`.`utente`.`nome_utente_mail` AS `nome_utente_mail`,`emmebi`.`utente`.`password_mail` AS `password_mail`,`emmebi`.`utente`.`tipo_utente` AS `tipo_utente`,`emmebi`.`utente`.`conferma` AS `conferma`,`emmebi`.`utente`.`salt` AS `salt`,`emmebi`.`utente`.`nascondi` AS `nascondi` from `emmebi`.`utente` where (`emmebi`.`utente`.`nascondi` = 0) 
;

/*!40103 SET TIME_ZONE=IFNULL(@OLD_TIME_ZONE, 'system') */;
/*!40101 SET SQL_MODE=IFNULL(@OLD_SQL_MODE, '') */;
/*!40014 SET FOREIGN_KEY_CHECKS=IFNULL(@OLD_FOREIGN_KEY_CHECKS, 1) */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40111 SET SQL_NOTES=IFNULL(@OLD_SQL_NOTES, 1) */;
